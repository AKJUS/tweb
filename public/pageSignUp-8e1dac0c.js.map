{"version":3,"mappings":"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","names":["authCode","onFirstMount","page","LoginPage","avatarPreview","Icon","addIco","PopupElement","PopupAvatar","_uploadAvatar","uploadAvatar","e","nameInputField","lastName","lastNameInputField","fullName","name","replaceContent","wrapEmojiText","i18n","sendAvatar","resolve","reject","inputFile","rootScope","InputField","btnSignUp","Button","btnI18n","I18n","handleInput","params","putPreloader","response","__vitePreload","m","preloader","err","blurActiveElement","Page","_authCode"],"sources":["../src/pages/pageSignUp.ts"],"sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {CancellablePromise} from '../helpers/cancellablePromise';\r\nimport type {InputFile} from '../layer';\r\nimport type {AuthState} from '../types';\r\nimport LoginPage from './loginPage';\r\nimport Page from './page';\r\nimport blurActiveElement from '../helpers/dom/blurActiveElement';\r\nimport rootScope from '../lib/rootScope';\r\nimport InputField from '../components/inputField';\r\nimport PopupElement from '../components/popups';\r\nimport PopupAvatar from '../components/popups/avatar';\r\nimport replaceContent from '../helpers/dom/replaceContent';\r\nimport I18n, {i18n} from '../lib/langPack';\r\nimport wrapEmojiText from '../lib/richTextProcessor/wrapEmojiText';\r\nimport Button from '../components/button';\r\nimport {putPreloader} from '../components/putPreloader';\r\nimport Icon from '../components/icon';\r\n\r\nlet authCode: AuthState.signUp['authCode'] = null;\r\n\r\nconst onFirstMount = async() => {\r\n  const page = new LoginPage({\r\n    className: 'page-signUp',\r\n    withInputWrapper: true,\r\n    titleLangKey: 'YourName',\r\n    subtitleLangKey: 'Login.Register.Subtitle'\r\n  });\r\n\r\n  page.imageDiv.classList.add('avatar-edit');\r\n\r\n  page.title.classList.add('fullName');\r\n\r\n  const avatarPreview = document.createElement('canvas');\r\n  avatarPreview.id = 'canvas-avatar';\r\n  avatarPreview.className = 'avatar-edit-canvas';\r\n\r\n  const addIco = Icon('cameraadd', 'avatar-edit-icon');\r\n  page.imageDiv.append(avatarPreview, addIco);\r\n\r\n  let uploadAvatar: () => CancellablePromise<InputFile>;\r\n  page.imageDiv.addEventListener('click', () => {\r\n    PopupElement.createPopup(PopupAvatar).open(avatarPreview, (_uploadAvatar) => {\r\n      uploadAvatar = _uploadAvatar;\r\n    });\r\n  });\r\n\r\n  const handleInput = (e: Event) => {\r\n    const name = nameInputField.value || '';\r\n    const lastName = lastNameInputField.value || '';\r\n\r\n    const fullName = name || lastName ?\r\n      (name + ' ' + lastName).trim() :\r\n      '';\r\n\r\n    if(fullName) replaceContent(page.title, wrapEmojiText(fullName));\r\n    else replaceContent(page.title, i18n('YourName'));\r\n  };\r\n\r\n  const sendAvatar = () => new Promise<void>((resolve, reject) => {\r\n    if(!uploadAvatar) {\r\n      // console.log('User has not selected avatar');\r\n      return resolve();\r\n    }\r\n\r\n    // console.log('invoking uploadFile...');\r\n    uploadAvatar().then((inputFile) => {\r\n      // console.log('uploaded smthn', inputFile);\r\n\r\n      rootScope.managers.appProfileManager.uploadProfilePhoto(inputFile).then(resolve, reject);\r\n    }, reject);\r\n  });\r\n\r\n  const nameInputField = new InputField({\r\n    label: 'FirstName',\r\n    maxLength: 70\r\n  });\r\n\r\n  const lastNameInputField = new InputField({\r\n    label: 'LastName',\r\n    maxLength: 64\r\n  });\r\n\r\n  const btnSignUp = Button('btn-primary btn-color-primary');\r\n  const btnI18n = new I18n.IntlElement({key: 'StartMessaging'});\r\n  btnSignUp.append(btnI18n.element);\r\n\r\n  page.inputWrapper.append(nameInputField.container, lastNameInputField.container, btnSignUp);\r\n\r\n  nameInputField.input.addEventListener('input', handleInput);\r\n  lastNameInputField.input.addEventListener('input', handleInput);\r\n\r\n  btnSignUp.addEventListener('click', function(this: typeof btnSignUp, e) {\r\n    if(nameInputField.input.classList.contains('error') || lastNameInputField.input.classList.contains('error')) {\r\n      return false;\r\n    }\r\n\r\n    if(!nameInputField.value.length) {\r\n      nameInputField.input.classList.add('error');\r\n      return false;\r\n    }\r\n\r\n    this.disabled = true;\r\n\r\n    const name = nameInputField.value.trim();\r\n    const lastName = lastNameInputField.value.trim();\r\n\r\n    const params = {\r\n      phone_number: authCode.phone_number,\r\n      phone_code_hash: authCode.phone_code_hash,\r\n      first_name: name,\r\n      last_name: lastName\r\n    };\r\n\r\n    // console.log('invoking auth.signUp with params:', params);\r\n\r\n    btnI18n.update({key: 'PleaseWait'});\r\n    const preloader = putPreloader(this);\r\n\r\n    rootScope.managers.apiManager.invokeApi('auth.signUp', params)\r\n    .then((response) => {\r\n      // console.log('auth.signUp response:', response);\r\n\r\n      switch(response._) {\r\n        case 'auth.authorization': // success\r\n          rootScope.managers.apiManager.setUser(response.user);\r\n\r\n          sendAvatar().finally(() => {\r\n            import('./pageIm').then((m) => {\r\n              m.default.mount();\r\n            });\r\n          });\r\n\r\n          break;\r\n        default:\r\n          btnI18n.update({key: response._ as any});\r\n          this.removeAttribute('disabled');\r\n          preloader.remove();\r\n          break;\r\n      }\r\n\r\n      /* (document.body.getElementsByClassName('page-sign')[0] as HTMLDivElement).style.display = 'none';\r\n      pageAuthCode(Object.assign(code, {phoneNumber})); */\r\n    }).catch((err) => {\r\n      this.removeAttribute('disabled');\r\n      preloader.remove();\r\n\r\n      switch(err.type) {\r\n        default:\r\n          btnI18n.update({key: err.type});\r\n          break;\r\n      }\r\n    });\r\n  });\r\n\r\n  blurActiveElement();\r\n  return new Promise((resolve) => {\r\n    window.requestAnimationFrame(resolve);\r\n  });\r\n};\r\n\r\nconst page = new Page('page-signUp', true, onFirstMount, (_authCode: typeof authCode) => {\r\n  authCode = _authCode;\r\n\r\n  rootScope.managers.appStateManager.pushToState('authState', {_: 'authStateSignUp', authCode: _authCode});\r\n});\r\n\r\nexport default page;\r\n"],"file":"pageSignUp-8e1dac0c.js"}