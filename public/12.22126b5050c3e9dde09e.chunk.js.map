{"version":3,"sources":["webpack:///./src/helpers/touchSupport.ts","webpack:///./src/lib/appManagers/appStateManager.ts","webpack:///./src/components/ripple.ts","webpack:///./src/pages/pageSignUp.ts","webpack:///./src/helpers/dom/clickEvent.ts","webpack:///./src/components/button.ts","webpack:///./src/components/misc.ts","webpack:///./src/helpers/mediaSizes.ts","webpack:///./src/helpers/date.ts","webpack:///./src/lib/storages/dialogs.ts","webpack:///./src/lib/storages/filters.ts","webpack:///./src/helpers/formatCallDuration.ts","webpack:///./src/helpers/formatDuration.ts","webpack:///./src/lib/appManagers/appMessagesManager.ts","webpack:///./src/lib/rlottie/rlottie.worker.ts","webpack:///./src/lib/lottieLoader.ts","webpack:///./src/lib/appManagers/appPhotosManager.ts","webpack:///./src/components/appNavigationController.ts","webpack:///./src/lib/appManagers/appDownloadManager.ts","webpack:///./src/hooks/useHeavyAnimationCheck.ts","webpack:///./src/helpers/dom/isInDOM.ts","webpack:///./src/components/peerTitle.ts","webpack:///./src/helpers/fastSmoothScroll.ts","webpack:///./src/components/animationIntersector.ts","webpack:///./src/helpers/number.ts","webpack:///./src/helpers/dom/whichChild.ts","webpack:///./src/pages/pagesManager.ts","webpack:///./src/pages/page.ts","webpack:///./src/helpers/array.ts","webpack:///./src/lib/appManagers/appDocsManager.ts","webpack:///./src/helpers/sequentialDom.ts","webpack:///./src/lib/mtproto/serverTimeManager.ts","webpack:///./src/lib/appManagers/appProfileManager.ts","webpack:///./src/components/popups/index.ts","webpack:///./src/helpers/dom/renderImageFromUrl.ts","webpack:///./src/countries.ts","webpack:///./src/components/visibilityIntersector.ts","webpack:///./src/components/lazyLoadQueue.ts","webpack:///./src/lib/appManagers/appNotificationsManager.ts","webpack:///./src/components/singleTransition.ts","webpack:///./src/helpers/calcImageInBox.ts","webpack:///./src/pages/loginPage.ts","webpack:///./src/lib/mtproto/referenceDatabase.ts","webpack:///./src/components/preloader.ts","webpack:///./src/helpers/fileName.ts","webpack:///./src/lib/filemanager.ts","webpack:///./src/lib/cacheStorage.ts","webpack:///./src/components/horizontalMenu.ts","webpack:///./src/components/transition.ts","webpack:///./src/helpers/files.ts","webpack:///./src/helpers/animation.ts","webpack:///./src/helpers/slicedArray.ts","webpack:///./src/helpers/dom/findUpAsChild.ts","webpack:///./src/lib/appManagers/appPollsManager.ts","webpack:///./src/helpers/heavyQueue.ts","webpack:///./src/helpers/blur.ts","webpack:///./src/lib/appManagers/appDraftsManager.ts","webpack:///./src/components/middleEllipsis.ts","webpack:///./src/lib/appManagers/appAvatarsManager.ts","webpack:///./src/lib/opusDecodeController.ts","webpack:///./src/lib/appManagers/appWebPagesManager.ts","webpack:///./src/helpers/dom/htmlToDocumentFragment.ts","webpack:///./src/lib/cropper.ts","webpack:///./src/components/popups/avatar.ts","webpack:///./src/vendor/leemon.ts","webpack:///./src/lib/mtproto/bin_utils.ts"],"names":["isTouchSupported","window","DocumentTouch","document","STATE_VERSION","version","STATE_INIT","allDialogsLoaded","pinnedOrders","contactsList","updates","filters","maxSeenMsgId","stateCreatedTime","Date","now","recentEmoji","topPeers","recentSearch","authState","_","hiddenPinnedMessages","settings","messagesTextSize","sendShortcut","animationsEnabled","autoDownload","contacts","private","groups","channels","autoPlay","gifs","videos","stickers","suggest","loop","emoji","big","themes","name","background","type","blur","slug","highlightningColor","color","theme","notifications","sound","keepSigned","chatContextMenuHintWasShown","ALL_KEYS","Object","keys","REFRESH_KEYS","AppStateManager","super","log","neededPeers","Map","singlePeerMap","storages","users","chats","dialogs","storagesResults","storage","this","loadSavedState","loaded","console","time","Promise","resolve","storagesKeys","storagesPromises","map","key","getAll","promises","get","concat","all","then","arr","state","i","length","value","undefined","pushToState","splice","auth","shift","shiftedWebKAuth","push","values","dcID","baseDcId","date","id","obj","forEach","idx","set","dispatchEvent","s","r","hasOwnProperty","nightTheme","find","t","missingKey","timeEnd","catch","first","split","direct","peerId","limit","has","Set","add","keepPeerSingle","existsPeerId","delete","size","appStateManager","rippleClickId","ripple","elem","callback","onEnd","prepend","querySelector","classList","createElement","handler","contains","drawRipple","clientX","clientY","startTime","clickId","duration","getComputedStyle","getPropertyValue","replace","elapsedTime","cb","mutate","remove","delay","Math","max","setTimeout","removeEventListener","touchStartFired","requestAnimationFrame","rect","getBoundingClientRect","clickX","left","clickY","top","sqrt","abs","height","width","x","y","style","append","isRippleUnneeded","e","target","includes","tagName","touchEnd","addEventListener","touches","once","cancelBubble","stopPropagation","passive","button","dataset","authCode","page","imported","className","withInputWrapper","titleLangKey","subtitleLangKey","imageDiv","title","avatarPreview","addIco","appProfileManager","default","uploadAvatar","open","_uploadAvatar","handleInput","nameInputField","lastName","lastNameInputField","fullName","trim","wrapEmojiText","label","maxLength","btnSignUp","btnI18n","IntlElement","element","inputWrapper","container","input","disabled","params","phone_number","phone_code_hash","first_name","last_name","update","preloader","invokeApi","response","setUserAuth","user","reject","inputFile","uploadProfilePhoto","finally","m","mount","removeAttribute","err","_authCode","CLICK_EVENT_NAME","attachClickEvent","options","listenerSetter","bind","removeManual","touchMouseDown","detachClickEvent","asDiv","icon","noRipple","rippleSquare","onlyMobile","setAttribute","text","putPreloader","returnDiv","html","div","innerHTML","appendChild","insertAdjacentHTML","lastElementChild","setButtonLoader","sortedCountries","formatPhoneNumber","str","phoneCode","slice","sort","a","b","country","c","indexOf","pattern","symbol","formatted","onMouseMove","openedMenu","diffX","right","diffY","bottom","closeBtnMenu","onClick","parentElement","menuOverlay","openedMenuOnClose","removeByType","openBtnMenu","menuElement","onClose","pushItem","onPop","canAnimate","insertBefore","positionMenu","pageX","pageY","side","scrollWidth","menuWidth","scrollHeight","menuHeight","body","windowWidth","windowHeight","isMobile","verticalSide","sides","intermediateX","intermediateY","possibleSides","attachContextMenuListener","timeout","capture","onCancel","clearTimeout","ScreenSize","MediaSize","boxSize","fitted","aspect","makeMediaSize","MediaSizes","screenSizes","mobile","medium","large","sizes","handhelds","regular","webpage","album","esgSticker","animatedSticker","staticSticker","emojiSticker","desktop","handleResize","innerWidth","activeScreen","wasScreen","active","rAF","cancelAnimationFrame","mediaSizes","months","days","ONE_DAY","getWeekNumber","d","UTC","getFullYear","getMonth","getDate","dayNum","getUTCDay","setUTCDate","getUTCDate","yearStart","getUTCFullYear","ceil","getTime","formatDateAccordingToToday","timestamp","timeStr","getHours","getMinutes","getDay","formatDateAccordingToTodayNew","today","hour","minute","year","day","month","weekday","IntlDateElement","formatTime","getFullDate","joiner","monthAsNumber","noSeconds","getSeconds","leadingZero","noTime","tsNow","seconds","floor","yearPattern","RegExp","monthYearOrDayPattern","yearOrDayAndMonthPattern","shortDate","longDate","numberOfDaysEachMonth","fillTipDates","query","dates","q","toLowerCase","setFullYear","setHours","minDate","maxDate","dayOfWeek","setDate","formatWeekLong","getDayOfWeek","distance","setTime","matches","exec","g1","g2","k","createForDayMonth","createForMonthYear","selectedYear","currentYear","g3","parseInt","validDateForMonth","formatterYearMax","k1","setMonth","formatterMonthYear","formatterDayMonth","appMessagesManager","appChatsManager","appPeersManager","appUsersManager","appDraftsManager","appNotificationsManager","apiUpdatesManager","serverTimeManager","onUpdateFolderPeers","folder_peers","folderPeer","folder_id","peer","getPeerId","dialog","dropDialog","pFlags","pinned","findAndSplice","p","generateIndexForDialog","pushDialog","scheduleHandleNewDialogs","onUpdateDialogPinned","folderId","getDialogOnly","onUpdatePinnedDialogs","handleOrder","order","reverse","newPinned","getFolder","dialogsResult","applyDialogs","clear","getSelf","peerText","getPeerSearchText","dialogsIndex","indexObject","addMultipleEventsListeners","updateFolderPeers","updateDialogPinned","updatePinnedDialogs","getState","top_message","getServerMessageId","topMessage","saveMessages","saveDialog","getMessageByPeer","deleted","reloadConversation","byFolders","dialogsOffsetDate","0","1","dialogsNum","cachedResults","count","filter","filtersStorage","testDialogForFilter","index","pinnedIndex","pinned_peers","generateDialogIndex","generateDialogPinnedDateByIndex","folders","folder","findIndex","serverTimeOffset","justReturn","message","channelId","isChannel","topDate","generateDialogPinnedDate","channel","getChat","draft","foundIndex","getOutputPeer","read_inbox_max_id","read_outbox_max_id","unread_count","unread_mentions_count","notify_settings","historyStorage","getHistoryStorage","history","incomingMessage","mid","is_outgoing","fromId","requestPeer","pts","newPts","getChannelState","offsetDate","pos","setDialogToState","foundDialog","getDialog","saveApiUsers","saveApiChats","messages","updatedDialogs","topPendingMessage","pendingTopMsgs","maxId","dropped","newUpdatesAfterReloadToHandle","saveUpdate","error","assign","chat","kicked","generateMessageId","generateTempMessageId","from_id","peer_id","out","isOutgoing","migrated_to","deactivated","migratedToPeer","migratedFromTo","migratedToFrom","wasDialogBefore","saveDraft","unread","isEnd","Bottom","insertSlice","setEnd","unshift","readMaxId","readOutboxMaxId","savePeerSettings","addChannelState","offsetIndex","realFolderId","curDialogStorage","results","search","d1","d2","offset","loadedAll","isDialogsLoaded","getTopMessages","messagesDialogs","rootScope","onUpdateDialogFilter","saveDialogFilter","onUpdateDialogFilterOrder","orderIndex","filterId","setOrderIndex","updateDialogFilter","updateDialogFilters","oldFilters","getDialogFilters","_filterId","updateDialogFilterOrder","exclude_peers","include_peers","exclude_archived","exclude_read","unread_mark","exclude_muted","isPeerLocalMuted","broadcasts","isBroadcast","isAnyGroup","isBot","bots","non_contacts","isContact","flags","getOutputDialogFilter","bool","getInputPeerById","overwrite","CALL_DURATION_LANG_KEYS","h","w","formatCallDuration","elements","showLast","o","modulus","formatDuration","fragment","pendingByRandomId","pendingByMessageId","pendingAfterMsgs","tempNum","tempFinalizeCallbacks","sendSmthLazyLoadQueue","needSingleMessages","fetchSingleMessagesPromise","maxSeenId","newMessagesHandleTimeout","newMessagesToHandle","newDialogsToHandle","notificationsHandlePromise","notificationsToHandle","reloadConversationsPeers","logger","Error","Debug","Log","Warn","groupedTempId","typings","handleNewMessages","handleNewDialogs","newMaxSeenId","dialogsStorage","incrementMaxSeenId","handleNotifications","_peerId","idle","isIDLE","notifyPeerToHandle","getNotifyPeerTypeSettings","getNotifySettings","getInputNotifyPeerById","peerTypeNotifySettings","notifyAboutMessage","fwdCount","onUpdateMessageId","randomId","random_id","pendingData","tempId","threadId","getMessageFromStorage","Boolean","finalizePendingMessageCallbacks","onUpdateNewMessage","getMessagePeer","getMessagesStorage","isLocalThreadUpdate","threadKey","getThreadKey","threadsStorage","good","isInChat","pendingMessage","checkPendingMessage","updateMessageRepliesIfNeeded","findSlice","firstSlice","mergeReplyKeyboard","forceUserOnline","handleNewMessage","inboxUnread","setDialogTopMessage","notifyPeer","fwd_from","onUpdateDialogUnreadMark","onUpdateEditMessage","oldMessage","newMessage","handleEditedMessage","isTopMessage","clear_history","grouped_id","onUpdateReadHistory","channel_id","max_id","read_max_id","top_msg_id","isOut","stillUnreadCount","still_unread_count","newUnreadCount","foundAffected","repliesKey","threadsToReplies","n","updateMessage","messageId","replyTo","reply_to","reply_to_top_id","reply_to_msg_id","cancel","getReadMaxIdIfUnread","threadKeyPart","onUpdateReadMessagesContents","mids","getMessageById","media_unread","setDialogToStateIfMessageIsTop","onUpdateChannelAvailableMessages","msgId","available_min_id","onUpdateDeleteMessages","clearCache","threadKeys","historyUpdated","handleDeletedMessages","threadsStorages","Array","from","splitted","msgs","onUpdateChannel","needDialog","username","historiesStorage","onUpdateChannelReload","onUpdateChannelMessageViews","views","onUpdateServiceNotification","inbox_date","media","entities","hasUser","verified","access_hash","phone","onUpdatePinnedMessages","missingMessages","wrapSingleMessage","werePinned","pinnedMessages","onUpdateNotifySettings","onUpdateNewScheduledMessage","scheduledMessagesStorage","isScheduled","onUpdateDeleteScheduledMessages","updateMessageID","updateNewDiscussionMessage","updateNewMessage","updateNewChannelMessage","updateDialogUnreadMark","updateEditMessage","updateEditChannelMessage","updateReadChannelDiscussionInbox","updateReadChannelDiscussionOutbox","updateReadHistoryInbox","updateReadHistoryOutbox","updateReadChannelInbox","updateReadChannelOutbox","updateChannelReadMessagesContents","updateReadMessagesContents","updateChannelAvailableMessages","updateDeleteMessages","updateDeleteChannelMessages","updateChannel","updateChannelReload","updateChannelMessageViews","updateServiceNotification","updatePinnedMessages","updatePinnedChannelMessages","updateNotifySettings","updateNewScheduledMessage","updateDeleteScheduledMessages","getConversationsAll","filterFunc","eventData","appWebPagesManager","getWebPage","messagesStorageByPeerId","groupedMessagesStorage","searchesStorage","threadsServiceMessagesIdsStorage","sendEntites","entity","user_id","getUserInput","callbackName","finalize","deferred","invokeAfterMessageIsSent","editMessage","parseMarkdown","schedule_date","scheduleDate","is_scheduled","newMedia","getInputEntities","no_webpage","noWebPage","processUpdateMessage","handled","replyToMsgId","webPage","sendText","getPeerMigratedTo","viaBotId","generateOutgoingMessage","toggleError","on","send","sentRequestOptions","apiPromise","afterMessageId","invokeApiAfter","query_id","queryId","resultId","clear_draft","clearDraft","silent","wrapMessageEntities","seq","pts_count","local","beforeMessageSending","file","attachType","apiFileName","fileType","mime_type","fileName","File","isDocument","Blob","caption","attributes","isPhoto","photo","actionName","isVoiceMessage","attribute","voice","waveform","isMedia","photoSize","location","cacheContext","appDownloadManager","getCacheContext","downloaded","url","objectURL","appPhotosManager","savePhoto","videoAttribute","round_message","isRoundMessage","file_name","thumbs","thumb","thumbURL","thumbBlob","thumbCacheContext","appDocsManager","saveDoc","attachMethod","tryAgainOnFail","isUpload","sentDeferred","attachPromise","uploaded","cancelPendingMessage","setTyping","uploadPromise","promise","file_reference","inputMedia","load","thumbUploadPromise","upload","notifyAll","done","total","blob","addNotifyListener","progress","percents","isGroupedItem","code","files","sendFile","sendFileDetails","groupId","details","syncDraft","notify","inputPeer","invoke","multiMedia","multi_media","messageMedia","getInput","doc","getMediaInput","inputSingleMedia","inputs","poll","appPollsManager","savePoll","total_voters","getPoll","getScheduledMessagesStorage","generateFromId","generateFlags","random","generateReplyHeader","via_bot_id","reply_markup","replies","generateReplies","pending","replyToTopId","header","channelFull","chatsFull","linked_chat_id","comments","replies_pts","getPeer","admin_rights","anonymous","post","originalMessage","myId","fwdHeader","from_name","post_author","channel_post","saved_from_msg_id","saved_from_peer","Number","MAX_SAFE_INTEGER","action","outDialogs","getConversations","getDialogs","chatHistoryStorage","getOffsetDate","invokeApiSingle","offset_date","offset_id","offset_peer","hash","noErrorBox","resetPinnedOrder","maxSeenIdIncremented","hasPrepend","noIdsDialogs","setDialogsLoaded","fromPeerId","newMessages","generateForwardHeader","group","from_peer","to_peer","with_my_score","withMyScore","createMessageStorage","reloadConversationsPromise","peers","getInputDialogPeerById","result","justClear","revoke","just_clear","affectedHistory","doFlushHistory","getHistory","historyResult","getChannelInput","getPinnedMessage","getSearch","inputFilter","unpin","oneSide","pm_oneside","unpinAll","unpinAllMessages","totalEntities","foundMessages","getMidsByAlbum","verify","temp","MESSAGE_ID_OFFSET","num","MESSAGE_ID_INCREMENT","l","used","increment","reply_to_mid","overwriting","savedFromPeerId","savedFromMid","savedFrom","fwdFromId","mediaContext","ttl_seconds","saveWebPage","migrateFrom","migrateTo","suffix","video_sizes","chat_id","reason","migrateChecks","apiEntities","fixEmoji","myEntities","parseEntities","mergeEntities","usingMids","plain","highlightWord","parts","addPart","langKey","part","format","el","usingFullAlbum","getMidsByMessage","getAlbumText","emoticon","htmlToDocumentFragment","question","rReply","prefix","game","stickerEmojiRaw","stickerEmoji","actionWrapped","wrapMessageActionTextNew","match","found","regExp","messageWrapped","wrapRichText","noLinebreaks","noLinks","noTextFormat","join","createDocumentFragment","peerTitle","senderTitle","getPeerTitle","wrapPlainText","langPackKey","args","getNameDivHTML","endsWith","peerIds","daysToStart","tomorrowDate","_args","htmlToSpan","userId","anchorHTML","domain","langPack","toggleDialogPin","getDialogPeer","read","hasChat","fromChat","kind","goodMedias","sticker","canMessageBeEdited","hasRights","messageReplyMarkup","lastReplyMarkup","selective","maxOutId","single_use","hidden","canCache","invokeApiCacheable","func","nextRate","backLimit","foundMsgs","filtering","neededContents","neededDocTypes","excludeDocTypes","goodEntities","matchUrl","next_rate","offset_id_offset","method","min_date","max_date","add_offset","min_id","offsetPeerId","offsetId","offsetMessage","offset_rate","searchResult","foundCount","getDiscussionMessage","maxMessageId","serviceStartMessage","is_single","msg_id","filterMessages","generateThreadServiceStartMessage","newDialogsHandlePromise","localMessageIds","creator","editor","megagroup","goodMsgIds","affectedMessages","force","triedToReadMaxId","readPromise","soundReset","getPeerString","readHistory","msgIds","threadMessage","broadcastEventName","finalizePendingMessage","mute","mute_until","canSendToUser","finalMessage","callbacks","getPhoto","newPhoto","newPhotoSize","oldCacheContext","downloadOptions","getPhotoDownloadOptions","fakeDownload","getDoc","newDoc","getInputFileName","polls","tempMessage","notification","peerString","notificationMessage","show_previews","wrapMessageForReply","onclick","tag","peerPhoto","getPeerPhoto","appAvatarsManager","loadAvatar","loadPromise","image","canWriteToPeer","isFetchIntervalNeeded","unsetEnd","haveSlice","sliceMe","fulfilled","Both","fillHistoryStorage","constructSlice","offsetIdOffset","requestHistory","topWasMeantToLoad","isTopEnd","isBottomEnd","Top","oldestMessage","foundSlice","_historyResult","getMessagesResult","fetchSingleMessages","typing","smth","referenceDatabase","deleteContext","deleteWebPageFromPending","groupedStorage","albums","peerMessagesToHandle","deletedMids","Worker_fn","Worker","convert","round","min","worker","reqId","paused","direction","speed","autoplay","frames","cachingDelta","skipRatio","_loop","_autoplay","skipDelta","pixelRatio","devicePixelRatio","needUpscale","noCache","Infinity","canvas","context","getContext","clamped","Uint8ClampedArray","imageData","ImageData","methodName","sendQuery","jsonString","setMainLoop","clearPendingRAF","rafId","renderFirstFrame","pause","curFrame","frameCount","requestFrame","stop","play","lottieLoader","onDestroy","frame","frameNo","data","putImageData","frInterval","delta","frThen","renderFrame2","renderFrame","fps","mainLoopForwards","mainLoopBackwards","currentMethod","frameListener","listenerResults","diff","defaultListener","onError","onerror","onmessage","event","queryMethodListener","queryMethodArguments","call","postMessage","terminate","queryMethod","transfer","arg","ArrayBuffer","buffer","isWebAssemblySupported","workersLimit","players","workers","curWorkerNum","onPlayerLoaded","rlPlayer","debug","onLoad","warn","onFrame","onPlayerError","animationIntersector","getAnimations","animation","checkAnimation","player","remain","object","toneIndex","replacements","COLORREPLACEMENTS","checkSmth","ty","foundReplacement","applyTo","iterateIt","it","layer","layers","shapes","shape","loadLottieWorkers","fetch","res","arrayBuffer","gzipUncompress","loadAnimationWorker","animationData","race","newAnimationData","JSON","parse","applyReplacements","stringify","initPlayer","addAnimation","loadFromData","AppPhotosManager","photos","windowW","windowH","visualViewport","innerHeight","oldPhoto","saveContext","boxWidth","boxHeight","useBytes","bestPhotoSize","inputUser","cacheSeconds","photosResult","photoIds","bytes","isSticker","mimeType","Uint8Array","jpegHeader","jpegTail","URL","createObjectURL","path","getPreviewURLFromBytes","useBlur","getPreviewURLFromThumb","Image","noZoom","choosePhotoSize","isFit","aspectCovered","ignoreCache","getImageFromStrippedThumb","queueId","onlyCache","thumb_size","dcId","dc_id","photoId","fullWidth","fullHeight","download","getDownload","fullPhotoSize","downloadToDisc","appNavigationController","navigations","manual","currentHash","isPossibleSwipe","onHashChange","replaceState","pushState","item","pop","handleItem","onEscape","back","detach","onTouchEnd","onTouchMove","moved","scrollRestoration","noBlurOnPop","ret","findItemByType","noHistory","origin","pathname","single","cacheStorage","downloads","progressCallbacks","uploadId","thumbsCache","cancelDownload","clearDownload","getNewDeferred","refreshReference","tryDownload","getFile","downloadFile","ext","uploadFile","onRemove","href","position","clickEvent","createEvent","initMouseEvent","click","discFileName","createDownloadAnchor","revokeObjectURL","thumbSize","cache","isAnimating","heavyAnimationPromise","promisesInQueue","dispatchHeavyAnimationEvent","perf","performance","_heavyAnimationPromise","isFulfilled","onHeavyAnimationEnd","interruptHeavyAnimation","getHeavyAnimationPromise","handleAnimationStart","handleAnimationEnd","isInDOM","isConnected","weakMap","WeakMap","peerTitleWeakMap","querySelectorAll","PeerTitle","plainText","onlyFirstName","getUser","FocusDirection","fastSmoothScroll","margin","maxDistance","forceDirection","forceDuration","axis","Static","scrollWithJs","elementRect","containerRect","offsetTop","scrollTop","Up","Down","rectStartKey","rectEndKey","sizeKey","scrollSizeKey","scrollPositionKey","elementPosition","elementSize","containerSize","scrollPosition","scrollSize","remainingPath","startAt","tick","currentPath","transition","visible","byGroups","lockedGroups","onlyOnePlayableGroup","intersectionLockedGroups","videosLocked","observer","IntersectionObserver","entries","entry","isIntersecting","checkAnimations","HTMLVideoElement","src","unobserve","observe","blurred","destroy","removeAnimation","animations","refreshGroup","numberThousandSplitter","toString","formatBytes","decimals","dm","parseFloat","pow","toFixed","formatNumber","clamp","v","whichChild","parentNode","previousElementSibling","pagesManager","pageId","pagesDiv","getElementById","scrollableDiv","selectTab","horizontalMenu","onShown","isAuthPage","display","pageEl","firstElementChild","onFirstMount","onMount","installed","setPage","accumulate","initialValue","reduce","acc","findAndSpliceAll","array","forEachReverse","insertInDescendSortedArray","property","sortProperty","len","docs","savingLottiePreview","onServiceWorkerFail","supportsStreaming","oldDoc","audioTitle","audioPerformer","performer","alt","stickerset","stickerSetInput","isWebpSupported","animated","isServiceWorkerOnline","getFileURL","docId","inputFileLocation","getFileDownloadOptions","preloadPhoto","tryNotToUseBytes","getThumbURL","originalPromise","isPlaySupported","reader","FileReader","onloadend","uint8","decode","readAsArrayBuffer","stickerCachedThumbs","toBlob","downloadDoc","sequentialDom","raf","scheduled","scheduleFlush","do","write","timestampNow","midnightNoOffset","midnightOffseted","midnightOffset","timeParams","to","AppProfileManager","usersFull","fullPromises","onUpdateUserTyping","typingsInPeer","cancelAction","getChatFull","updateChatParticipants","participants","chatId","chatFull","updateChatParticipantAdd","_participants","inviter_id","updateChatParticipantDelete","updateUserTyping","updateChatUserTyping","updateChannelUserTyping","fullChat","emptyPhoto","chat_photo","photo_id","invalidateChannelParticipants","megagroupOnlines","override","userFull","saveApiUser","profile_photo","about","rAbout","getProfile","getProfileByPeerId","profile","getChannelFull","full_chat","exported_invite","link","exportedInvite","broadcast","participant","channelParticipant","fullChannel","processUserIds","userIds","getUserSearchText","getChannelParticipants","cP","getParticipantPeerId","updateResult","previous","participants_count","isMegagroup","cached","onlines","getChannelInputPeer","status","PopupElement","buttons","hide","btnClose","overlayIsActive","removeItem","navigationItem","onCloseAfterTimeout","closable","overlayClosable","onOverlayClick","withConfirm","btnConfirm","buttonsDiv","buttonsElements","isDanger","langArgs","isCancel","offsetWidth","addCancelButton","loadedURLs","HTMLImageElement","SVGImageElement","setAttributeNS","backgroundImage","renderImageFromUrl","useCache","isImage","loader","Countries","PhoneCodesMain","VisibilityIntersector","onVisibilityChange","items","locked","changed","getVisible","disconnect","targets","unlock","refresh","parallelLimit","queue","inProcess","lockPromise","unlockResolve","processQueue","_processQueue","loadItem","getItem","processItem","addElement","lock","intersector","unlockAndRefresh","intersectorTimeout","wasSeen","setProcessQueueTimeout","_queue","spliced","notificationsShown","notificationIndex","notificationsCount","soundsPlayed","vibrateSupport","navigator","vibrate","peerSettings","notifyUsers","notifyChats","notifyBroadcasts","faviconEl","head","titleBackup","titleChanged","stopped","pushInited","updateLocalSettings","updSettings","nodesktop","volume","novibrate","nopreview","nopush","needPush","isAvailable","registeredDevice","subscribe","unsubscribe","setSettings","nosound","requestPermission","Notification","mozVibrate","webkitVibrate","notificationsUiSupport","topMessagesDeferred","notifySoundEl","start","newVal","toggleToggler","tokenData","unregisterDevice","registerDevice","notificationData","period","custom","enable","resetTitle","setFavicon","clearInterval","titleInterval","setInterval","ctx","beginPath","arc","PI","fillStyle","fill","fontSize","font","textBaseline","textAlign","fillText","toDataURL","getNotifyPeerTypePromise","inputKey","compare_sound","notifyContactsSignUp","prevFavicon","cloneNode","replaceChild","peerNotifySettings","isMuted","respectType","notifySettings","inputNotify","typeNotifySettings","getPeerLocalSettings","permission","testSound","setLocalNotificationsDisabled","close","focus","onclose","show","nextSoundAt","prevSoundVolume","filename","audio","hidePushNotifications","token_type","tokenType","token","tokenValue","other_uids","app_sandbox","secret","forwards","onTransitionEnd","afterTimeout","toggle","calcImageInBox","imageW","imageH","boxW","boxH","boxedImageW","boxedImageH","LoginPage","subtitle","contexts","links","addTaskListener","task","originalPayload","getReferenceByLink","newTask","payload","serviceWorker","controller","reference","getContexts","_context","next","ProgressivePreloader","detached","cancelable","streamable","loadFunc","bold","constructContainer","construct","downloadSvg","cancelSvg","circle","setProgress","TRANSITION_TIME","setManual","reset","totalLength","getTotalLength","strokeDasharray","getFileNameByLocation","short_name","thumb_version","volume_id","local_id","encodeURIComponent","blobSupported","fileWriter","fileReader","onload","saveFileCallback","blobParts","truncate","saveToStorage","dbName","useStorage","test","STORAGES","openDatabase","openDbPromise","caches","entryName","timeoutOperation","put","Response","headers","save","rejected","fakeWriter","getFakeFileWriter","saveFile","enabled","deleteAll","tabs","content","transitionTime","scrollableX","proxy","Proxy","apply","that","animate","children","selectTarget","tabContent","canChange","scrollIntoViewNew","prevId","prev","useStripe","indicator","currentIndicator","shiftLeft","offsetLeft","scaleFactor","clientWidth","transform","tab","slideNavigation","prevTabContent","toRight","slideTabs","scrollableContainer","overflowY","TransitionSlider","isHeavy","animationFunction","Transition","onTransitionEndCallbacks","animationDeferred","animationStarted","self","HTMLElement","_from","onTransitionEndCallback","createPosterFromVideo","video","onseeked","videoWidth","videoHeight","drawImage","currentTime","createPosterForVideo","onloadedmetadata","preloadVideo","onVideoLoad","readyState","HAVE_METADATA","getFilesFromEvent","onlyTypes","scanFiles","isDirectory","directoryReader","createReader","readEntries","itemFile","getAsFile","DataTransferItem","DragEvent","dataTransfer","clipboardData","originalEvent","webkitGetAsEntry","requestFile","accept","instances","cancelAnimationByKey","instance","getAnimationInstance","isCancelled","animateSingle","createAnimationInstance","SliceEnd","SlicedArray","sliceConstructor","getSliceConstructor","slices","slicedArray","end","None","last","deleteCount","flatten","lowerBound","upperBound","lowerIndex","upperIndex","foundSliceIndex","sliced","insertIndex","prevSlice","nextSlice","sliceOffset","findSliceOffset","sliceStart","sliceEnd","bottomWasMeantToLoad","topFulfilled","bottomFulfilled","findUpAsChild","parent","updateMessagePoll","poll_id","saveResults","rQuestion","chosenIndexes","answer","chosen","pollId","correctAnswers","solution","solutionEntities","correct_answers","solution_entities","optionIds","answers","option","sendVote","votesList","closed","newPoll","getInputMediaPoll","heavyQueue","processingQueue","addHeavyTask","processHeavyQueue","todo","f","possiblePromise","process","realResult","timedChunk","isFilterAvailable","requireBlurPromise","fastBlurFunc","processBlurNext","img","radius","iterations","alpha","blurPromises","dataUri","drafts","getAllDraftPromise","updateDraftMessage","peerID","getKey","getAllDrafts","updatesState","syncLoading","apiDraft","processApiDraft","draft1","draft2","rMessage","wrapDraftText","localDraft","saveOnServer","serverDraft","getDraft","draftsAreEqual","draftObj","isEmptyDraft","saveLocalDraft","testQueue","fontFamily","timeoutId","setTestQueue","testQueueElements","testElement","mapped","firstTime","textLength","multiplier","textWidth","elementWidth","textContent","fontWeight","getTextWidth","newElementWidth","widthChanged","smallerText","smallerWidth","smallerTextLength","half","half1","substr","half2","measureText","MiddleEllipsisElement","customElements","define","savedAvatarURLs","getAvatarPromise","saved","peerPhotoFileLocation","onlyThumb","renderThumbPromise","thumbImage","stripped_thumb","childElementCount","mutateElement","renderPromise","isDialog","avatarAvailable","avatarRendered","innerText","getPeerColorById","abbr","getAbbreviation","initials","putAvatar","opusDecodeController","sampleRate","tasks","keepAlive","isPlaySupportedResult","canPlayType","wavWorker","onTaskEnd","command","buffers","typedArray","loadWorker","loadWavWorker","terminateWorkers","executeNewTask","kill","decoderSampleRate","outputBufferSampleRate","wavBitDepth","wavSampleRate","pages","withWaveform","pushDecodeTask","dataBlob","webpages","pendingWebPages","updateWebPage","apiWebPage","siteName","site_name","shortTitle","author","rTitle","contextHashtag","shortDescriptionText","description","rDescription","contextSite","template","originalImage","cropComponent","cropImage","event_state","cropLeft","cropTop","cropWidth","cropHeight","scaledRatio","init","draggable","overlayColor","maxWidth","naturalWidth","CROPWIDTH","offsetHeight","CROPHEIGHT","updateCropSize","updateCropImage","updateContainer","startMoving","resizing","keyHandler","imgZoom","zoom","newWidth","newHeight","clientHeight","preventDefault","String","fromCharCode","charCode","deltaY","container_width","container_height","container_left","container_top","mouse_x","scrollX","mouse_y","scrollY","saveEventState","moving","endMoving","currentTouch","complete","crop","removeHandlers","cropper","h6","cropContainer","contents","readAsDataURL","btnSubmit","darkenCanvas","onCrop","postCanvas","fillRect","bpe","mask","int2bigInt","bits","minSize","buff","copyInt_","isObject"],"mappings":"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","file":"12.22126b5050c3e9dde09e.chunk.js","sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// @ts-ignore\r\nexport const isTouchSupported = ('ontouchstart' in window) || (window.DocumentTouch && document instanceof DocumentTouch)/*  || true */;","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { Dialog } from './appMessagesManager';\r\nimport type { UserAuth } from '../mtproto/mtproto_config';\r\nimport type { User } from './appUsersManager';\r\nimport type { AuthState } from '../../types';\r\nimport type FiltersStorage from '../storages/filters';\r\nimport type DialogsStorage from '../storages/dialogs';\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport rootScope from '../rootScope';\r\nimport stateStorage from '../stateStorage';\r\nimport { logger } from '../logger';\r\nimport { copy, setDeepProperty, validateInitObject } from '../../helpers/object';\r\nimport App from '../../config/app';\r\nimport DEBUG, { MOUNT_CLASS_TO } from '../../config/debug';\r\nimport AppStorage from '../storage';\r\nimport { Chat } from '../../layer';\r\nimport { isMobile } from '../../helpers/userAgent';\r\nimport DATABASE_STATE from '../../config/databases/state';\r\nimport sessionStorage from '../sessionStorage';\r\n\r\nconst REFRESH_EVERY = 24 * 60 * 60 * 1000; // 1 day\r\n//const REFRESH_EVERY_WEEK = 24 * 60 * 60 * 1000 * 7; // 7 days\r\nconst STATE_VERSION = App.version;\r\n\r\nexport type Background = {\r\n  type: 'color' | 'image' | 'default',\r\n  blur: boolean,\r\n  highlightningColor?: string,\r\n  color?: string,\r\n  slug?: string,\r\n};\r\n\r\nexport type Theme = {\r\n  name: 'day' | 'night' | 'system',\r\n  background: Background\r\n};\r\n\r\nexport type State = {\r\n  allDialogsLoaded: DialogsStorage['allDialogsLoaded'],\r\n  pinnedOrders: DialogsStorage['pinnedOrders'],\r\n  contactsList: number[],\r\n  updates: Partial<{\r\n    seq: number,\r\n    pts: number,\r\n    date: number\r\n  }>,\r\n  filters: FiltersStorage['filters'],\r\n  maxSeenMsgId: number,\r\n  stateCreatedTime: number,\r\n  recentEmoji: string[],\r\n  topPeers: number[],\r\n  recentSearch: number[],\r\n  version: typeof STATE_VERSION,\r\n  authState: AuthState,\r\n  hiddenPinnedMessages: {[peerId: string]: number},\r\n  settings: {\r\n    messagesTextSize: number,\r\n    sendShortcut: 'enter' | 'ctrlEnter',\r\n    animationsEnabled: boolean,\r\n    autoDownload: {\r\n      contacts: boolean\r\n      private: boolean\r\n      groups: boolean\r\n      channels: boolean\r\n    },\r\n    autoPlay: {\r\n      gifs: boolean,\r\n      videos: boolean\r\n    },\r\n    stickers: {\r\n      suggest: boolean,\r\n      loop: boolean\r\n    },\r\n    emoji: {\r\n      suggest: boolean,\r\n      big: boolean\r\n    },\r\n    background?: Background, // ! DEPRECATED\r\n    themes: Theme[],\r\n    theme: Theme['name'],\r\n    notifications: {\r\n      sound: boolean\r\n    },\r\n    nightTheme?: boolean, // ! DEPRECATED\r\n  },\r\n  keepSigned: boolean,\r\n  chatContextMenuHintWasShown: boolean\r\n};\r\n\r\nexport const STATE_INIT: State = {\r\n  allDialogsLoaded: {},\r\n  pinnedOrders: {},\r\n  contactsList: [],\r\n  updates: {},\r\n  filters: {},\r\n  maxSeenMsgId: 0,\r\n  stateCreatedTime: Date.now(),\r\n  recentEmoji: [],\r\n  topPeers: [],\r\n  recentSearch: [],\r\n  version: STATE_VERSION,\r\n  authState: {\r\n    _: isMobile ? 'authStateSignIn' : 'authStateSignQr'\r\n  },\r\n  hiddenPinnedMessages: {},\r\n  settings: {\r\n    messagesTextSize: 16,\r\n    sendShortcut: 'enter',\r\n    animationsEnabled: true,\r\n    autoDownload: {\r\n      contacts: true,\r\n      private: true,\r\n      groups: true,\r\n      channels: true\r\n    },\r\n    autoPlay: {\r\n      gifs: true,\r\n      videos: true\r\n    },\r\n    stickers: {\r\n      suggest: true,\r\n      loop: true\r\n    },\r\n    emoji: {\r\n      suggest: true,\r\n      big: true\r\n    },\r\n    themes: [{\r\n      name: 'day',\r\n      background: {\r\n        type: 'image',\r\n        blur: false,\r\n        slug: 'ByxGo2lrMFAIAAAAmkJxZabh8eM', // * new blurred camomile,\r\n        highlightningColor: 'hsla(85.5319, 36.9171%, 40.402%, 0.4)'\r\n      }\r\n    }, {\r\n      name: 'night',\r\n      background: {\r\n        type: 'color',\r\n        blur: false,\r\n        color: '#0f0f0f',\r\n        highlightningColor: 'hsla(0, 0%, 3.82353%, 0.4)'\r\n      }\r\n    }],\r\n    theme: 'system',\r\n    notifications: {\r\n      sound: false\r\n    }\r\n  },\r\n  keepSigned: true,\r\n  chatContextMenuHintWasShown: false\r\n};\r\n\r\nconst ALL_KEYS = Object.keys(STATE_INIT) as any as Array<keyof State>;\r\n\r\nconst REFRESH_KEYS = ['contactsList', 'stateCreatedTime',\r\n  'maxSeenMsgId', 'filters', 'topPeers'] as any as Array<keyof State>;\r\n\r\n//const REFRESH_KEYS_WEEK = ['dialogs', 'allDialogsLoaded', 'updates', 'pinnedOrders'] as any as Array<keyof State>;\r\n\r\nexport class AppStateManager extends EventListenerBase<{\r\n  save: (state: State) => Promise<void>,\r\n  peerNeeded: (peerId: number) => void,\r\n  peerUnneeded: (peerId: number) => void,\r\n}> {\r\n  public static STATE_INIT = STATE_INIT;\r\n  private loaded: Promise<State>;\r\n  private log = logger('STATE'/* , LogLevels.error */);\r\n\r\n  private state: State;\r\n\r\n  private neededPeers: Map<number, Set<string>> = new Map();\r\n  private singlePeerMap: Map<string, number> = new Map();\r\n\r\n  public storages = {\r\n    users: new AppStorage<Record<number, User>, typeof DATABASE_STATE>(DATABASE_STATE, 'users'),\r\n    chats: new AppStorage<Record<number, Chat>, typeof DATABASE_STATE>(DATABASE_STATE, 'chats'),\r\n    dialogs: new AppStorage<Record<number, Dialog>, typeof DATABASE_STATE>(DATABASE_STATE, 'dialogs')\r\n  };\r\n\r\n  public storagesResults: {[key in keyof AppStateManager['storages']]: any[]} = {} as any;\r\n\r\n  public storage = stateStorage;\r\n\r\n  constructor() {\r\n    super();\r\n    this.loadSavedState();\r\n  }\r\n\r\n  public loadSavedState(): Promise<State> {\r\n    if(this.loaded) return this.loaded;\r\n    console.time('load state');\r\n    this.loaded = new Promise((resolve) => {\r\n      const storagesKeys = Object.keys(this.storages) as Array<keyof AppStateManager['storages']>;\r\n      const storagesPromises: Promise<any>[] = storagesKeys.map(key => this.storages[key].getAll());\r\n\r\n      const promises: Promise<any>[] = ALL_KEYS.map(key => stateStorage.get(key))\r\n      .concat(sessionStorage.get('user_auth'))\r\n      .concat(stateStorage.get('user_auth' as any)) // support old webk format\r\n      .concat(storagesPromises);\r\n\r\n      Promise.all(promises).then(async(arr) => {\r\n        /* const self = this;\r\n        const skipHandleKeys = new Set(['isProxy', 'filters', 'drafts']);\r\n        const getHandler = (path?: string) => {\r\n          return {\r\n            get(target: any, key: any) {\r\n              if(key === 'isProxy') {\r\n                return true;\r\n              }\r\n\r\n              const prop = target[key];\r\n\r\n              if(prop !== undefined && !skipHandleKeys.has(key) && !prop.isProxy && typeof(prop) === 'object') {\r\n                target[key] = new Proxy(prop, getHandler(path || key));\r\n                return target[key];\r\n              }\r\n              \r\n              return prop;\r\n            },\r\n            set(target: any, key: any, value: any) {\r\n              console.log('Setting', target, `.${key} to equal`, value, path);\r\n          \r\n              target[key] = value;\r\n\r\n              // @ts-ignore\r\n              self.pushToState(path || key, path ? self.state[path] : value, false);\r\n\r\n              return true;\r\n            }\r\n          };\r\n        }; */\r\n\r\n        let state: State = this.state = {} as any;\r\n\r\n        // ! then can't store false values\r\n        for(let i = 0, length = ALL_KEYS.length; i < length; ++i) {\r\n          const key = ALL_KEYS[i];\r\n          const value = arr[i];\r\n          if(value !== undefined) {\r\n            // @ts-ignore\r\n            state[key] = value;\r\n          } else {\r\n            this.pushToState(key, copy(STATE_INIT[key]));\r\n          }\r\n        }\r\n\r\n        arr.splice(0, ALL_KEYS.length);\r\n\r\n        // * Read auth\r\n        let auth = arr.shift() as UserAuth | number;\r\n        let shiftedWebKAuth = arr.shift() as UserAuth | number;\r\n        if(!auth && shiftedWebKAuth) { // support old webk auth\r\n          auth = shiftedWebKAuth;\r\n          const keys: string[] = ['dc', 'server_time_offset', 'xt_instance'];\r\n          for(let i = 1; i <= 5; ++i) {\r\n            keys.push(`dc${i}_server_salt`);\r\n            keys.push(`dc${i}_auth_key`);\r\n          }\r\n\r\n          const values = await Promise.all(keys.map(key => stateStorage.get(key as any)));\r\n          keys.push('user_auth');\r\n          values.push(typeof(auth) === 'number' ? {dcID: values[0] || App.baseDcId, date: Date.now() / 1000 | 0, id: auth} as UserAuth : auth);\r\n\r\n          let obj: any = {};\r\n          keys.forEach((key, idx) => {\r\n            obj[key] = values[idx];\r\n          });\r\n\r\n          await sessionStorage.set(obj);\r\n        }\r\n        \r\n        /* if(!auth) { // try to read Webogram's session from localStorage\r\n          try {\r\n            const keys = Object.keys(localStorage);\r\n            for(let i = 0; i < keys.length; ++i) {\r\n              const key = keys[i];\r\n              let value: any;\r\n              try {\r\n                value = localStorage.getItem(key);\r\n                value = JSON.parse(value);\r\n              } catch(err) {\r\n                //console.error(err);\r\n              }\r\n\r\n              sessionStorage.set({\r\n                [key as any]: value\r\n              });\r\n            }\r\n\r\n            auth = sessionStorage.getFromCache('user_auth');\r\n          } catch(err) {\r\n            this.log.error('localStorage import error', err);\r\n          }\r\n        } */\r\n\r\n        if(auth) {\r\n          // ! Warning ! DON'T delete this\r\n          state.authState = {_: 'authStateSignedIn'};\r\n          rootScope.dispatchEvent('user_auth', typeof(auth) === 'number' ? {dcID: 0, date: Date.now() / 1000 | 0, id: auth} : auth); // * support old version\r\n        }\r\n\r\n        // * Read storages\r\n        for(let i = 0, length = storagesKeys.length; i < length; ++i) {\r\n          this.storagesResults[storagesKeys[i]] = arr[i] as any;\r\n        }\r\n\r\n        arr.splice(0, storagesKeys.length);\r\n\r\n        const time = Date.now();\r\n        if((state.stateCreatedTime + REFRESH_EVERY) < time) {\r\n          if(DEBUG) {\r\n            this.log('will refresh state', state.stateCreatedTime, time);\r\n          }\r\n\r\n          const r = (keys: typeof REFRESH_KEYS) => {\r\n            keys.forEach(key => {\r\n              this.pushToState(key, copy(STATE_INIT[key]));\r\n  \r\n              // @ts-ignore\r\n              const s = this.storagesResults[key];\r\n              if(s && s.length) {\r\n                s.length = 0;\r\n              }\r\n            });\r\n          };\r\n          \r\n          r(REFRESH_KEYS);\r\n\r\n          /* if((state.stateCreatedTime + REFRESH_EVERY_WEEK) < time) {\r\n            if(DEBUG) {\r\n              this.log('will refresh updates');\r\n            }\r\n\r\n            r(REFRESH_KEYS_WEEK);\r\n          } */\r\n        }\r\n        \r\n        //state = this.state = new Proxy(state, getHandler());\r\n\r\n        // * support old version\r\n        if(!state.settings.hasOwnProperty('theme') && state.settings.hasOwnProperty('nightTheme')) {\r\n          state.settings.theme = state.settings.nightTheme ? 'night' : 'day';\r\n          this.pushToState('settings', state.settings);\r\n        }\r\n\r\n        // * support old version\r\n        if(!state.settings.hasOwnProperty('themes') && state.settings.background) {\r\n          state.settings.themes = copy(STATE_INIT.settings.themes);\r\n          const theme = state.settings.themes.find(t => t.name === state.settings.theme);\r\n          if(theme) {\r\n            theme.background = state.settings.background;\r\n            this.pushToState('settings', state.settings);\r\n          }\r\n        }\r\n\r\n        validateInitObject(STATE_INIT, state, (missingKey) => {\r\n          // @ts-ignore\r\n          this.pushToState(missingKey, state[missingKey]);\r\n        });\r\n\r\n        if(state.version !== STATE_VERSION) {\r\n          this.pushToState('version', STATE_VERSION);\r\n        }\r\n\r\n        // ! probably there is better place for it\r\n        rootScope.settings = state.settings;\r\n\r\n        if(DEBUG) {\r\n          this.log('state res', state, copy(state));\r\n        }\r\n        \r\n        //return resolve();\r\n\r\n        console.timeEnd('load state');\r\n        resolve(state);\r\n      }).catch(resolve);\r\n    });\r\n\r\n    return this.loaded;\r\n  }\r\n\r\n  public getState() {\r\n    return this.state === undefined ? this.loadSavedState() : Promise.resolve(this.state);\r\n  }\r\n\r\n  public setByKey(key: string, value: any) {\r\n    setDeepProperty(this.state, key, value);\r\n    rootScope.dispatchEvent('settings_updated', {key, value});\r\n\r\n    const first = key.split('.')[0];\r\n    // @ts-ignore\r\n    this.pushToState(first, this.state[first]);\r\n  }\r\n\r\n  public pushToState<T extends keyof State>(key: T, value: State[T], direct = true) {\r\n    if(direct) {\r\n      this.state[key] = value;\r\n    }\r\n\r\n    this.storage.set({\r\n      [key]: value\r\n    });\r\n  }\r\n\r\n  public requestPeer(peerId: number, type: string, limit?: number) {\r\n    let set = this.neededPeers.get(peerId);\r\n    if(set && set.has(type)) {\r\n      return;\r\n    }\r\n\r\n    if(!set) {\r\n      set = new Set();\r\n      this.neededPeers.set(peerId, set);\r\n    }\r\n\r\n    set.add(type);\r\n    this.dispatchEvent('peerNeeded', peerId);\r\n\r\n    if(limit !== undefined) {\r\n      this.keepPeerSingle(peerId, type);\r\n    }\r\n  }\r\n\r\n  public isPeerNeeded(peerId: number) {\r\n    return this.neededPeers.has(peerId);\r\n  }\r\n\r\n  public keepPeerSingle(peerId: number, type: string) {\r\n    const existsPeerId = this.singlePeerMap.get(type);\r\n    if(existsPeerId && existsPeerId !== peerId && this.neededPeers.has(existsPeerId)) {\r\n      const set = this.neededPeers.get(existsPeerId);\r\n      set.delete(type);\r\n\r\n      if(!set.size) {\r\n        this.neededPeers.delete(existsPeerId);\r\n        this.dispatchEvent('peerUnneeded', existsPeerId);\r\n      }\r\n    }\r\n\r\n    if(peerId) {\r\n      this.singlePeerMap.set(type, peerId);\r\n    }\r\n  }\r\n\r\n  /* public resetState() {\r\n    for(let i in this.state) {\r\n      // @ts-ignore\r\n      this.state[i] = false;\r\n    }\r\n    sessionStorage.set(this.state).then(() => {\r\n      location.reload();\r\n    });\r\n  } */\r\n}\r\n\r\n//console.trace('appStateManager include');\r\n\r\nconst appStateManager = new AppStateManager();\r\nMOUNT_CLASS_TO.appStateManager = appStateManager;\r\nexport default appStateManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport sequentialDom from \"../helpers/sequentialDom\";\r\nimport {isTouchSupported} from \"../helpers/touchSupport\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nlet rippleClickId = 0;\r\nexport function ripple(elem: HTMLElement, callback: (id: number) => Promise<boolean | void> = () => Promise.resolve(), onEnd: (id: number) => void = null, prepend = false) {\r\n  //return;\r\n  if(elem.querySelector('.c-ripple')) return;\r\n  elem.classList.add('rp');\r\n  \r\n  let r = document.createElement('div');\r\n  r.classList.add('c-ripple');\r\n\r\n  const isSquare = elem.classList.contains('rp-square');\r\n  if(isSquare) {\r\n    r.classList.add('is-square');\r\n  }\r\n\r\n  elem[prepend ? 'prepend' : 'append'](r);\r\n\r\n  let handler: () => void;\r\n  //let animationEndPromise: Promise<number>;\r\n  const drawRipple = (clientX: number, clientY: number) => {\r\n    const startTime = Date.now();\r\n    const elem = document.createElement('div');\r\n\r\n    const clickId = rippleClickId++;\r\n    \r\n    //console.log('ripple drawRipple');\r\n    \r\n    const duration = +window.getComputedStyle(r).getPropertyValue('--ripple-duration').replace('s', '') * 1000;\r\n    //console.log('ripple duration', duration);\r\n\r\n    handler = () => {\r\n    //handler = () => animationEndPromise.then((duration) => {\r\n      //console.log('ripple animation was:', duration);\r\n\r\n      //const duration = isSquare || mediaSizes.isMobile ? 200 : 700;\r\n      //return;\r\n      let elapsedTime = Date.now() - startTime;\r\n      const cb = () => {\r\n        //console.log('ripple elapsedTime total pre-remove:', Date.now() - startTime);\r\n        sequentialDom.mutate(() => {\r\n          elem.remove();\r\n        });\r\n        \r\n        if(onEnd) onEnd(clickId);\r\n      };\r\n      if(elapsedTime < duration) {\r\n        let delay = Math.max(duration - elapsedTime, duration / 2);\r\n        setTimeout(() => elem.classList.add('hiding'), Math.max(delay - duration / 2, 0));\r\n\r\n        setTimeout(cb, delay);\r\n      } else {\r\n        elem.classList.add('hiding');\r\n        setTimeout(cb, duration / 2);\r\n      }\r\n\r\n      if(!isTouchSupported) {\r\n        window.removeEventListener('contextmenu', handler);\r\n      }\r\n\r\n      handler = null;\r\n      touchStartFired = false;\r\n    };\r\n    //});\r\n\r\n    callback && callback(clickId);\r\n\r\n    /* callback().then((bad) => {\r\n      if(bad) {\r\n        span.remove();\r\n        return;\r\n      } */\r\n      \r\n      //console.log('ripple after promise', Date.now() - startTime);\r\n      //console.log('ripple tooSlow:', tooSlow);\r\n      /* if(tooSlow) {\r\n        span.remove();\r\n        return;\r\n      } */\r\n\r\n      window.requestAnimationFrame(() => {\r\n        const rect = r.getBoundingClientRect();\r\n        elem.classList.add('c-ripple__circle');\r\n\r\n        const clickX = clientX - rect.left;\r\n        const clickY = clientY - rect.top;\r\n\r\n        const radius = Math.sqrt((Math.abs(clickY - rect.height / 2) + rect.height / 2) ** 2 + (Math.abs(clickX - rect.width / 2) + rect.width / 2) ** 2);\r\n        const size = radius;\r\n\r\n        // center of circle\r\n        const x = clickX - size / 2;\r\n        const y = clickY - size / 2;\r\n\r\n        //console.log('ripple click', offsetFromCenter, size, clickX, clickY);\r\n\r\n        elem.style.width = elem.style.height = size + 'px';\r\n        elem.style.left = x + 'px';\r\n        elem.style.top = y + 'px';\r\n\r\n        // нижний код выполняется с задержкой\r\n        /* animationEndPromise = new Promise((resolve) => {\r\n          span.addEventListener('animationend', () => {\r\n            // 713 -> 700\r\n            resolve(((Date.now() - startTime) / 100 | 0) * 100);\r\n          }, {once: true});\r\n        }); */\r\n        \r\n        // нижний код не всегда включает анимацию ПРИ КЛИКЕ НА ТАЧПАД БЕЗ ТАПТИК ЭНЖИНА\r\n        /* span.style.display = 'none';\r\n        r.append(span);\r\n        duration = +window.getComputedStyle(span).getPropertyValue('animation-duration').replace('s', '') * 1000;\r\n        span.style.display = ''; */\r\n\r\n        r.append(elem);\r\n\r\n        //r.classList.add('active');\r\n        //handler();\r\n      });\r\n    //});\r\n  };\r\n\r\n  const isRippleUnneeded = (e: Event) => e.target !== elem && (\r\n      ['BUTTON', 'A'].includes((e.target as HTMLElement).tagName) \r\n      || findUpClassName(e.target as HTMLElement, 'c-ripple') !== r\r\n    );\r\n\r\n  // TODO: rename this variable\r\n  let touchStartFired = false;\r\n  if(isTouchSupported) {\r\n    let touchEnd = () => {\r\n      handler && handler();\r\n    };\r\n  \r\n    elem.addEventListener('touchstart', (e) => {\r\n      if(!rootScope.settings.animationsEnabled) {\r\n        return;\r\n      }\r\n\r\n      //console.log('ripple touchstart', e);\r\n      if(e.touches.length > 1 || touchStartFired || isRippleUnneeded(e)) {\r\n        return;\r\n      }\r\n      \r\n      //console.log('touchstart', e);\r\n      touchStartFired = true;\r\n  \r\n      let {clientX, clientY} = e.touches[0];\r\n      drawRipple(clientX, clientY);\r\n      elem.addEventListener('touchend', touchEnd, {once: true});\r\n  \r\n      window.addEventListener('touchmove', (e) => {\r\n        e.cancelBubble = true;\r\n        e.stopPropagation();\r\n        touchEnd();\r\n        elem.removeEventListener('touchend', touchEnd);\r\n      }, {once: true});\r\n    }, {passive: true});\r\n  } else {\r\n    elem.addEventListener('mousedown', (e) => {\r\n      if(![0, 2].includes(e.button)) { // only left and right buttons\r\n        return;\r\n      }\r\n\r\n      if(!rootScope.settings.animationsEnabled) {\r\n        return;\r\n      }\r\n      //console.log('ripple mousedown', e, e.target, findUpClassName(e.target as HTMLElement, 'c-ripple') === r);\r\n\r\n      if(elem.dataset.ripple === '0' || isRippleUnneeded(e)) {\r\n        return;\r\n      } else if(touchStartFired) {\r\n        touchStartFired = false;\r\n        return;\r\n      }\r\n  \r\n      let {clientX, clientY} = e;\r\n      drawRipple(clientX, clientY);\r\n      window.addEventListener('mouseup', handler, {once: true, passive: true});\r\n      window.addEventListener('contextmenu', handler, {once: true, passive: true});\r\n    }, {passive: true});\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { CancellablePromise } from '../helpers/cancellablePromise';\r\nimport type { InputFile } from '../layer';\r\nimport type { AuthState } from '../types';\r\nimport Button from '../components/button';\r\nimport InputField from '../components/inputField';\r\nimport { putPreloader } from '../components/misc';\r\nimport PopupAvatar from '../components/popups/avatar';\r\nimport appStateManager from '../lib/appManagers/appStateManager';\r\nimport I18n, { i18n } from '../lib/langPack';\r\n//import apiManager from '../lib/mtproto/apiManager';\r\nimport apiManager from '../lib/mtproto/mtprotoworker';\r\nimport RichTextProcessor from '../lib/richtextprocessor';\r\nimport LoginPage from './loginPage';\r\nimport Page from './page';\r\nimport blurActiveElement from '../helpers/dom/blurActiveElement';\r\nimport replaceContent from '../helpers/dom/replaceContent';\r\n\r\nlet authCode: AuthState.signUp['authCode'] = null;\r\n\r\nconst onFirstMount = () => import('../lib/appManagers/appProfileManager').then(imported => {\r\n  const page = new LoginPage({\r\n    className: 'page-signUp',\r\n    withInputWrapper: true,\r\n    titleLangKey: 'YourName',\r\n    subtitleLangKey: 'Login.Register.Subtitle'\r\n  });\r\n\r\n  page.imageDiv.classList.add('avatar-edit');\r\n\r\n  page.title.classList.add('fullName');\r\n\r\n  const avatarPreview = document.createElement('canvas');\r\n  avatarPreview.id = 'canvas-avatar';\r\n  avatarPreview.className = 'avatar-edit-canvas';\r\n\r\n  const addIco = document.createElement('span');\r\n  addIco.className = 'tgico tgico-cameraadd';\r\n\r\n  page.imageDiv.append(avatarPreview, addIco);\r\n  \r\n  const appProfileManager = imported.default;\r\n\r\n  let uploadAvatar: () => CancellablePromise<InputFile>;\r\n  page.imageDiv.addEventListener('click', () => {\r\n    new PopupAvatar().open(avatarPreview, (_uploadAvatar) => {\r\n      uploadAvatar = _uploadAvatar;\r\n    });\r\n  });\r\n\r\n  const handleInput = (e: Event) => {\r\n    const name = nameInputField.value || '';\r\n    const lastName = lastNameInputField.value || '';\r\n\r\n    const fullName = name || lastName \r\n      ? (name + ' ' + lastName).trim() \r\n      : '';\r\n    \r\n    if(fullName) replaceContent(page.title, RichTextProcessor.wrapEmojiText(fullName));\r\n    else replaceContent(page.title, i18n('YourName'));\r\n  };\r\n\r\n  let sendAvatar = () => new Promise<void>((resolve, reject) => {\r\n    if(!uploadAvatar) {\r\n      //console.log('User has not selected avatar');\r\n      return resolve();\r\n    }\r\n\r\n    //console.log('invoking uploadFile...');\r\n    uploadAvatar().then((inputFile) => {\r\n      //console.log('uploaded smthn', inputFile);\r\n  \r\n      appProfileManager.uploadProfilePhoto(inputFile).then(resolve, reject);\r\n    }, reject);\r\n  });\r\n\r\n  const nameInputField = new InputField({\r\n    label: 'FirstName',\r\n    maxLength: 70\r\n  });\r\n\r\n  const lastNameInputField = new InputField({\r\n    label: 'LastName',\r\n    maxLength: 64\r\n  });\r\n\r\n  const btnSignUp = Button('btn-primary btn-color-primary');\r\n  const btnI18n = new I18n.IntlElement({key: 'StartMessaging'});\r\n  btnSignUp.append(btnI18n.element);\r\n\r\n  page.inputWrapper.append(nameInputField.container, lastNameInputField.container, btnSignUp);\r\n\r\n  nameInputField.input.addEventListener('input', handleInput);\r\n  lastNameInputField.input.addEventListener('input', handleInput);\r\n\r\n  btnSignUp.addEventListener('click', function(this: typeof btnSignUp, e) {\r\n    if(nameInputField.input.classList.contains('error') || lastNameInputField.input.classList.contains('error')) {\r\n      return false;\r\n    }\r\n\r\n    if(!nameInputField.value.length) {\r\n      nameInputField.input.classList.add('error');\r\n      return false;\r\n    }\r\n\r\n    this.disabled = true;\r\n\r\n    const name = nameInputField.value.trim();\r\n    const lastName = lastNameInputField.value.trim();\r\n\r\n    const params = {\r\n      phone_number: authCode.phone_number,\r\n      phone_code_hash: authCode.phone_code_hash,\r\n      first_name: name,\r\n      last_name: lastName\r\n    };\r\n\r\n    //console.log('invoking auth.signUp with params:', params);\r\n\r\n    btnI18n.update({key: 'PleaseWait'});\r\n    const preloader = putPreloader(this);\r\n\r\n    apiManager.invokeApi('auth.signUp', params)\r\n    .then((response) => {\r\n      //console.log('auth.signUp response:', response);\r\n      \r\n      switch(response._) {\r\n        case 'auth.authorization': // success\r\n          apiManager.setUserAuth(response.user.id);\r\n\r\n          sendAvatar().finally(() => {\r\n            import('./pageIm').then(m => {\r\n              m.default.mount();\r\n            });\r\n          });\r\n          \r\n          break;\r\n        default:\r\n          btnI18n.update({key: response._ as any});\r\n          this.removeAttribute('disabled');\r\n          preloader.remove();\r\n          break;\r\n      }\r\n\r\n      /* (document.body.getElementsByClassName('page-sign')[0] as HTMLDivElement).style.display = 'none';\r\n      pageAuthCode(Object.assign(code, {phoneNumber})); */\r\n    }).catch(err => {\r\n      this.removeAttribute('disabled');\r\n      preloader.remove();\r\n\r\n      switch(err.type) {\r\n        default:\r\n          btnI18n.update({key: err.type});\r\n          break;\r\n      }\r\n    });\r\n  });\r\n\r\n  blurActiveElement();\r\n  return new Promise((resolve) => {\r\n    window.requestAnimationFrame(resolve);\r\n  });\r\n});\r\n\r\nconst page = new Page('page-signUp', true, onFirstMount, (_authCode: typeof authCode) => {\r\n  authCode = _authCode;\r\n\r\n  appStateManager.pushToState('authState', {_: 'authStateSignUp', authCode: _authCode});\r\n});\r\n\r\nexport default page;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ListenerSetter from \"../listenerSetter\";\r\nimport { isTouchSupported } from \"../touchSupport\";\r\n\r\nexport const CLICK_EVENT_NAME: 'mousedown' | 'touchend' | 'click' = (isTouchSupported ? 'mousedown' : 'click') as any;\r\nexport type AttachClickOptions = AddEventListenerOptions & Partial<{listenerSetter: ListenerSetter, touchMouseDown: true}>;\r\nexport function attachClickEvent(elem: HTMLElement, callback: (e: TouchEvent | MouseEvent) => void, options: AttachClickOptions = {}) {\r\n  const add = options.listenerSetter ? options.listenerSetter.add.bind(options.listenerSetter, elem) : elem.addEventListener.bind(elem);\r\n  const remove = options.listenerSetter ? options.listenerSetter.removeManual.bind(options.listenerSetter, elem) : elem.removeEventListener.bind(elem);\r\n\r\n  options.touchMouseDown = true;\r\n  /* if(options.touchMouseDown && CLICK_EVENT_NAME === 'touchend') {\r\n    add('mousedown', callback, options);\r\n  } else if(CLICK_EVENT_NAME === 'touchend') {\r\n    const o = {...options, once: true};\r\n\r\n    const onTouchStart = (e: TouchEvent) => {\r\n      const onTouchMove = (e: TouchEvent) => {\r\n        remove('touchmove', onTouchMove, o);\r\n        remove('touchend', onTouchEnd, o);\r\n      };\r\n  \r\n      const onTouchEnd = (e: TouchEvent) => {\r\n        remove('touchmove', onTouchMove, o);\r\n        callback(e);\r\n        if(options.once) {\r\n          remove('touchstart', onTouchStart);\r\n        }\r\n      };\r\n  \r\n      add('touchend', onTouchEnd, o);\r\n      add('touchmove', onTouchMove, o);\r\n    };\r\n\r\n    add('touchstart', onTouchStart);\r\n  } else {\r\n    add(CLICK_EVENT_NAME, callback, options);\r\n  } */\r\n  add(CLICK_EVENT_NAME, callback, options);\r\n}\r\n\r\nexport function detachClickEvent(elem: HTMLElement, callback: (e: TouchEvent | MouseEvent) => void, options?: AddEventListenerOptions) {\r\n  if(CLICK_EVENT_NAME === 'touchend') {\r\n    elem.removeEventListener('touchstart', callback, options);\r\n  } else {\r\n    elem.removeEventListener(CLICK_EVENT_NAME, callback, options);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport { ripple } from \"./ripple\";\r\n\r\nconst Button = (className: string, options: Partial<{\r\n  noRipple: true, \r\n  onlyMobile: true, \r\n  icon: string, \r\n  rippleSquare: true, \r\n  text: LangPackKey, \r\n  disabled: boolean,\r\n  asDiv: boolean\r\n}> = {}) => {\r\n  const button: HTMLButtonElement = document.createElement(options.asDiv ? 'div' : 'button') as any;\r\n  button.className = className + (options.icon ? ' tgico-' + options.icon : '');\r\n\r\n  if(!options.noRipple) {\r\n    if(options.rippleSquare) {\r\n      button.classList.add('rp-square');\r\n    }\r\n\r\n    ripple(button);\r\n  }\r\n\r\n  if(options.onlyMobile) {\r\n    button.classList.add('only-handhelds');\r\n  }\r\n\r\n  if(options.disabled) {\r\n    button.setAttribute('disabled', 'true');\r\n  }\r\n\r\n  if(options.text) {\r\n    button.append(i18n(options.text));\r\n  }\r\n\r\n  return button;\r\n};\r\n\r\nexport default Button;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport Countries, { Country, PhoneCodesMain } from \"../countries\";\r\nimport { cancelEvent } from \"../helpers/dom/cancelEvent\";\r\nimport { CLICK_EVENT_NAME } from \"../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport { isTouchSupported } from \"../helpers/touchSupport\";\r\nimport { isApple, isMobileSafari, isSafari } from \"../helpers/userAgent\";\r\nimport appNavigationController from \"./appNavigationController\";\r\n\r\nexport function putPreloader(elem: Element, returnDiv = false): HTMLElement {\r\n  const html = `\r\n  <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-circular\" viewBox=\"25 25 50 50\">\r\n  <circle class=\"preloader-path\" cx=\"50\" cy=\"50\" r=\"20\" fill=\"none\" stroke-miterlimit=\"10\"/>\r\n  </svg>`;\r\n\r\n  if(returnDiv) {\r\n    const div = document.createElement('div');\r\n    div.classList.add('preloader');\r\n    div.innerHTML = html;\r\n\r\n    if(elem) {\r\n      elem.appendChild(div);\r\n    }\r\n\r\n    return div;\r\n  }\r\n  \r\n  elem.insertAdjacentHTML('beforeend', html);\r\n  return elem.lastElementChild as HTMLElement;\r\n}\r\n\r\nMOUNT_CLASS_TO.putPreloader = putPreloader;\r\n\r\nexport function setButtonLoader(elem: HTMLButtonElement, icon = 'check') {\r\n  elem.classList.remove('tgico-' + icon);\r\n  elem.disabled = true;\r\n  putPreloader(elem);\r\n\r\n  return () => {\r\n    elem.innerHTML = '';\r\n    elem.classList.add('tgico-' + icon);\r\n    elem.removeAttribute('disabled');\r\n  };\r\n}\r\n\r\nlet sortedCountries: Country[];\r\nexport function formatPhoneNumber(str: string) {\r\n  str = str.replace(/\\D/g, '');\r\n  let phoneCode = str.slice(0, 6);\r\n  \r\n  ////console.log('str', str, phoneCode);\r\n  if(!sortedCountries) {\r\n    sortedCountries = Countries.slice().sort((a, b) => b.phoneCode.length - a.phoneCode.length);\r\n  }\r\n  \r\n  let country = sortedCountries.find((c) => {\r\n    return c.phoneCode.split(' and ').find((c) => phoneCode.indexOf(c.replace(/\\D/g, '')) === 0);\r\n  });\r\n\r\n  if(!country) return {formatted: str, country};\r\n\r\n  country = PhoneCodesMain[country.phoneCode] || country;\r\n  \r\n  let pattern = country.pattern || country.phoneCode;\r\n  pattern.split('').forEach((symbol, idx) => {\r\n    if(symbol === ' ' && str[idx] !== ' ' && str.length > idx) {\r\n      str = str.slice(0, idx) + ' ' + str.slice(idx);\r\n    }\r\n  });\r\n  \r\n  /* if(country.pattern) {\r\n    str = str.slice(0, country.pattern.length);\r\n  } */\r\n  \r\n  return {formatted: str, country};\r\n}\r\n\r\n/* export function parseMenuButtonsTo(to: {[name: string]: HTMLElement}, elements: HTMLCollection | NodeListOf<HTMLElement>) {\r\n  Array.from(elements).forEach(el => {\r\n    const match = el.className.match(/(?:^|\\s)menu-(.+?)(?:$|\\s)/);\r\n    if(!match) return;\r\n    to[match[1]] = el as HTMLElement;\r\n  });\r\n} */\r\n\r\nlet onMouseMove = (e: MouseEvent) => {\r\n  let rect = openedMenu.getBoundingClientRect();\r\n  let {clientX, clientY} = e;\r\n  \r\n  let diffX = clientX >= rect.right ? clientX - rect.right : rect.left - clientX;\r\n  let diffY = clientY >= rect.bottom ? clientY - rect.bottom : rect.top - clientY;\r\n  \r\n  if(diffX >= 100 || diffY >= 100) {\r\n    closeBtnMenu();\r\n    //openedMenu.parentElement.click();\r\n  }\r\n  //console.log('mousemove', diffX, diffY);\r\n};\r\n\r\nconst onClick = (e: MouseEvent | TouchEvent) => {\r\n  //cancelEvent(e);\r\n  closeBtnMenu();\r\n};\r\n\r\n// ! no need in this due to the same handler in appNavigationController\r\n/* const onKeyDown = (e: KeyboardEvent) => {\r\n  if(e.key === 'Escape') {\r\n    closeBtnMenu();\r\n    cancelEvent(e);\r\n  }\r\n}; */\r\n\r\nexport const closeBtnMenu = () => {\r\n  if(openedMenu) {\r\n    openedMenu.classList.remove('active');\r\n    openedMenu.parentElement.classList.remove('menu-open');\r\n    //openedMenu.previousElementSibling.remove(); // remove overlay\r\n    if(menuOverlay) menuOverlay.remove();\r\n    openedMenu = null;\r\n  }\r\n  \r\n  if(openedMenuOnClose) {\r\n    openedMenuOnClose();\r\n    openedMenuOnClose = null;\r\n  }\r\n\r\n  if(!isTouchSupported) {\r\n    window.removeEventListener('mousemove', onMouseMove);\r\n    //window.removeEventListener('keydown', onKeyDown, {capture: true});\r\n    window.removeEventListener('contextmenu', onClick);\r\n  }\r\n\r\n  document.removeEventListener(CLICK_EVENT_NAME, onClick);\r\n\r\n  if(!isMobileSafari) {\r\n    appNavigationController.removeByType('menu');\r\n  }\r\n};\r\n\r\nwindow.addEventListener('resize', () => {\r\n  if(openedMenu) {\r\n    closeBtnMenu();\r\n  }\r\n  \r\n  /* if(openedMenu && (openedMenu.style.top || openedMenu.style.left)) {\r\n    const rect = openedMenu.getBoundingClientRect();\r\n    const {innerWidth, innerHeight} = window;\r\n\r\n    console.log(innerWidth, innerHeight, rect);\r\n  } */\r\n});\r\n\r\nlet openedMenu: HTMLElement = null, openedMenuOnClose: () => void = null, menuOverlay: HTMLElement = null;\r\nexport function openBtnMenu(menuElement: HTMLElement, onClose?: () => void) {\r\n  closeBtnMenu();\r\n\r\n  if(!isMobileSafari) {\r\n    appNavigationController.pushItem({\r\n      type: 'menu',\r\n      onPop: (canAnimate) => {\r\n        closeBtnMenu();\r\n      }\r\n    });\r\n  }\r\n  \r\n  openedMenu = menuElement;\r\n  openedMenu.classList.add('active');\r\n  openedMenu.parentElement.classList.add('menu-open');\r\n\r\n  if(!menuOverlay) {\r\n    menuOverlay = document.createElement('div');\r\n    menuOverlay.classList.add('btn-menu-overlay');\r\n\r\n    // ! because this event must be canceled, and can't cancel on menu click (below)\r\n    menuOverlay.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n      cancelEvent(e);\r\n      onClick(e);\r\n    });\r\n  }\r\n\r\n  openedMenu.parentElement.insertBefore(menuOverlay, openedMenu);\r\n\r\n  //document.body.classList.add('disable-hover');\r\n  \r\n  openedMenuOnClose = onClose;\r\n\r\n  if(!isTouchSupported) {\r\n    window.addEventListener('mousemove', onMouseMove);\r\n    //window.addEventListener('keydown', onKeyDown, {capture: true});\r\n    window.addEventListener('contextmenu', onClick, {once: true});\r\n  }\r\n\r\n  /* // ! because this event must be canceled, and can't cancel on menu click (below)\r\n  overlay.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n    cancelEvent(e);\r\n    onClick(e);\r\n  }); */\r\n  \r\n  // ! safari iOS doesn't handle window click event on overlay, idk why\r\n  document.addEventListener(CLICK_EVENT_NAME, onClick);\r\n}\r\n\r\nconst PADDING_TOP = 8;\r\nconst PADDING_LEFT = 8;\r\nexport function positionMenu({pageX, pageY}: MouseEvent | Touch, elem: HTMLElement, side?: 'left' | 'right' | 'center') {\r\n  //let {clientX, clientY} = e;\r\n\r\n  // * side mean the OPEN side\r\n\r\n  let {scrollWidth: menuWidth, scrollHeight: menuHeight} = elem;\r\n  //let {innerWidth: windowWidth, innerHeight: windowHeight} = window;\r\n  const rect = document.body.getBoundingClientRect();\r\n  const windowWidth = rect.width;\r\n  const windowHeight = rect.height;\r\n\r\n  side = mediaSizes.isMobile ? 'right' : 'left';\r\n  let verticalSide: 'top' /* | 'bottom' */ | 'center' = 'top';\r\n\r\n  const getSides = () => {\r\n    return {\r\n      x: {\r\n        left: pageX,\r\n        right: pageX - menuWidth\r\n      },\r\n      intermediateX: side === 'right' ? PADDING_LEFT : windowWidth - menuWidth - PADDING_LEFT,\r\n      //intermediateX: clientX < windowWidth / 2 ? PADDING_LEFT : windowWidth - menuWidth - PADDING_LEFT,\r\n      y: {\r\n        top: pageY,\r\n        bottom: pageY - menuHeight\r\n      },\r\n      //intermediateY: verticalSide === 'top' ? PADDING_TOP : windowHeight - menuHeight - PADDING_TOP,\r\n      intermediateY: pageY < windowHeight / 2 ? PADDING_TOP : windowHeight - menuHeight - PADDING_TOP,\r\n    };\r\n  };\r\n\r\n  const sides = getSides();\r\n\r\n  const possibleSides = {\r\n    x: {\r\n      left: sides.x.left + menuWidth + PADDING_LEFT <= windowWidth,\r\n      right: sides.x.right >= PADDING_LEFT\r\n    },\r\n    y: {\r\n      top: sides.y.top + menuHeight + PADDING_TOP <= windowHeight,\r\n      bottom: sides.y.bottom - PADDING_TOP >= PADDING_TOP\r\n    }\r\n  };\r\n\r\n  /* if(side === undefined) {\r\n    if((clientX + menuWidth + PADDING_LEFT) > windowWidth) {\r\n      side = 'right';\r\n    }\r\n  } */\r\n\r\n  {\r\n    /* const x = sides.x;\r\n\r\n    const s = Object.keys(x) as (keyof typeof possibleSides.x)[];\r\n    if(side) {\r\n      s.findAndSplice(s => s === side);\r\n      s.unshift(side);\r\n    }\r\n\r\n    const possibleSide = s.find(s => possibleSides.x[s]); */\r\n    let left: number;\r\n    /* if(possibleSide) {\r\n      left = x[possibleSide];\r\n      side = possibleSide;\r\n    } else {\r\n      left = sides.intermediateX;\r\n      side = undefined;\r\n    } */\r\n    left = possibleSides.x[side] ? sides.x[side] : (side = 'center', sides.intermediateX);\r\n  \r\n    elem.style.left = left + 'px';\r\n  }\r\n\r\n  /* if((clientY + menuHeight + PADDING_TOP) > windowHeight) {\r\n    elem.style.top = clamp(clientY - menuHeight, PADDING_TOP, windowHeight - menuHeight - PADDING_TOP) + 'px';\r\n    // elem.style.top = (innerHeight - scrollHeight - PADDING_TOP) + 'px';\r\n    verticalSide = 'bottom';\r\n  } else {\r\n    elem.style.top = Math.max(PADDING_TOP, clientY) + 'px';\r\n    verticalSide = 'top';\r\n  } */\r\n\r\n  {\r\n    let top: number;\r\n\r\n    top = possibleSides.y[verticalSide] ? sides.y[verticalSide] : (verticalSide = 'center', sides.intermediateY);\r\n  \r\n    elem.style.top = top + 'px';\r\n  }\r\n  \r\n  elem.className = elem.className.replace(/(top|center|bottom)-(left|center|right)/g, '');\r\n  elem.classList.add(\r\n    //(verticalSide === 'center' ? verticalSide : (verticalSide === 'bottom' ? 'top' : 'bottom')) +\r\n    (verticalSide === 'center' ? verticalSide : 'bottom') +\r\n    '-' +\r\n    (side === 'center' ? side : (side === 'left' ? 'right' : 'left')));\r\n}\r\n\r\nexport function attachContextMenuListener(element: HTMLElement, callback: (e: Touch | MouseEvent) => void, listenerSetter?: ListenerSetter) {\r\n  const add = listenerSetter ? listenerSetter.add.bind(listenerSetter, element) : element.addEventListener.bind(element);\r\n  const remove = listenerSetter ? listenerSetter.removeManual.bind(listenerSetter, element) : element.removeEventListener.bind(element);\r\n\r\n  if(isApple && isTouchSupported) {\r\n    let timeout: number;\r\n\r\n    const options: any = /* null */{capture: true};\r\n\r\n    const onCancel = () => {\r\n      clearTimeout(timeout);\r\n      remove('touchmove', onCancel, options);\r\n      remove('touchend', onCancel, options);\r\n      remove('touchcancel', onCancel, options);\r\n    };\r\n\r\n    add('touchstart', (e: TouchEvent) => {\r\n      if(e.touches.length > 1) {\r\n        onCancel();\r\n        return;\r\n      }\r\n  \r\n      add('touchmove', onCancel, options);\r\n      add('touchend', onCancel, options);\r\n      add('touchcancel', onCancel, options);\r\n\r\n      timeout = window.setTimeout(() => {\r\n        callback(e.touches[0]);\r\n        onCancel();\r\n\r\n        if(openedMenu) {\r\n          element.addEventListener('touchend', cancelEvent, {once: true}); // * fix instant closing\r\n        }\r\n      }, .4e3);\r\n    });\r\n\r\n    /* if(!isSafari) {\r\n      add('contextmenu', (e: any) => {\r\n        cancelEvent(e);\r\n      }, {passive: false, capture: true});\r\n    } */\r\n  } else {\r\n    add('contextmenu', isTouchSupported ? (e: any) => {\r\n      callback(e);\r\n\r\n      if(openedMenu) {\r\n        element.addEventListener('touchend', cancelEvent, {once: true}); // * fix instant closing\r\n      }\r\n    } : callback);\r\n  }\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport calcImageInBox from \"./calcImageInBox\";\r\nimport EventListenerBase from \"./eventListenerBase\";\r\n\r\nexport class MediaSize {\r\n  constructor(public width = 0, public height = width) {\r\n\r\n  }\r\n\r\n  public aspect(boxSize: MediaSize, fitted: boolean) {\r\n    return calcImageInBox(this.width, this.height, boxSize.width, boxSize.height, fitted);\r\n  }\r\n\r\n  public aspectFitted(boxSize: MediaSize) {\r\n    return this.aspect(boxSize, true);\r\n  }\r\n\r\n  public aspectCovered(boxSize: MediaSize) {\r\n    return this.aspect(boxSize, false);\r\n  }\r\n}\r\n\r\nexport function makeMediaSize(width?: number, height?: number): MediaSize {\r\n  return new MediaSize(width, height);\r\n}\r\n\r\ntype MediaTypeSizes = {\r\n  regular: MediaSize,\r\n  webpage: MediaSize,\r\n  album: MediaSize,\r\n  esgSticker: MediaSize,\r\n  animatedSticker: MediaSize,\r\n  staticSticker: MediaSize,\r\n  emojiSticker: MediaSize\r\n};\r\n\r\nexport enum ScreenSize {\r\n  mobile,\r\n  medium,\r\n  large\r\n}\r\n\r\nconst MOBILE_SIZE = 600;\r\nconst MEDIUM_SIZE = 1275;\r\nconst LARGE_SIZE = 1680;\r\n\r\nclass MediaSizes extends EventListenerBase<{\r\n  changeScreen: (from: ScreenSize, to: ScreenSize) => void\r\n}> {\r\n  private screenSizes: {key: ScreenSize, value: number}[] = [\r\n    {key: ScreenSize.mobile, value: MOBILE_SIZE},\r\n    {key: ScreenSize.medium, value: MEDIUM_SIZE},\r\n    {key: ScreenSize.large, value: LARGE_SIZE}\r\n  ];\r\n\r\n  private sizes: {[k in 'desktop' | 'handhelds']: MediaTypeSizes} = {\r\n    handhelds: {\r\n      regular: makeMediaSize(270, 270),\r\n      webpage: makeMediaSize(270, 200),\r\n      album: makeMediaSize(270, 0),\r\n      esgSticker: makeMediaSize(68, 68),\r\n      animatedSticker: makeMediaSize(180, 180),\r\n      staticSticker: makeMediaSize(180, 180),\r\n      emojiSticker: makeMediaSize(112, 112)\r\n    },\r\n    desktop: {\r\n      regular: makeMediaSize(400, 320),\r\n      webpage: makeMediaSize(400, 320),\r\n      album: makeMediaSize(420, 0),\r\n      esgSticker: makeMediaSize(80, 80),\r\n      animatedSticker: makeMediaSize(200, 200),\r\n      staticSticker: makeMediaSize(200, 200),\r\n      emojiSticker: makeMediaSize(112, 112)\r\n    }\r\n  };\r\n\r\n  public isMobile = false;\r\n  public active: MediaTypeSizes;\r\n  public activeScreen: ScreenSize;\r\n  public rAF: number;\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    window.addEventListener('resize', () => {\r\n      if(this.rAF) window.cancelAnimationFrame(this.rAF);\r\n      this.rAF = window.requestAnimationFrame(() => {\r\n        this.handleResize();\r\n        this.rAF = 0;\r\n      });\r\n    });\r\n    this.handleResize();\r\n  }\r\n\r\n  private handleResize = () => {\r\n    const innerWidth = window.innerWidth;\r\n    //this.isMobile = innerWidth <= 720;\r\n    \r\n    let activeScreen = this.screenSizes[0].key;\r\n    for(let i = this.screenSizes.length - 1; i >= 0; --i) {\r\n      if(this.screenSizes[i].value < innerWidth) {\r\n        activeScreen = (this.screenSizes[i + 1] || this.screenSizes[i]).key;\r\n        break;\r\n      }\r\n    }\r\n\r\n    const wasScreen = this.activeScreen;\r\n    this.activeScreen = activeScreen;\r\n    this.isMobile = this.activeScreen === ScreenSize.mobile;\r\n    this.active = this.isMobile ? this.sizes.handhelds : this.sizes.desktop;\r\n\r\n    //console.time('esg');\r\n    //const computedStyle = window.getComputedStyle(document.documentElement);\r\n    //this.active.esgSticker.width = parseFloat(computedStyle.getPropertyValue('--esg-sticker-size'));\r\n    //console.timeEnd('esg');\r\n\r\n    if(wasScreen !== activeScreen) {\r\n      //console.log('changeScreen', this.activeScreen, activeScreen);\r\n\r\n      if(wasScreen !== undefined) {\r\n        this.dispatchEvent('changeScreen', this.activeScreen, activeScreen);\r\n      }\r\n    }\r\n\r\n    /* if(this.isMobile) {\r\n      for(let i in this.active) {\r\n        // @ts-ignore\r\n        let size = this.active[i];\r\n        size.width = innerWidth \r\n      }\r\n    } */\r\n  };\r\n}\r\n\r\nconst mediaSizes = new MediaSizes();\r\nMOUNT_CLASS_TO.mediaSizes = mediaSizes;\r\nexport default mediaSizes;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport I18n from \"../lib/langPack\";\r\n\r\nexport const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];\r\nexport const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\n\r\nexport const ONE_DAY = 86400;\r\n\r\n// https://stackoverflow.com/a/6117889\r\nexport const getWeekNumber = (date: Date) => {\r\n  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\r\n  const dayNum = d.getUTCDay() || 7;\r\n  d.setUTCDate(d.getUTCDate() + 4 - dayNum);\r\n  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\r\n  return Math.ceil((((d.getTime() - yearStart.getTime()) / ONE_DAY) + 1) / 7);\r\n};\r\n\r\nexport const formatDateAccordingToToday = (time: Date) => {\r\n  const date = new Date();\r\n  const now = date.getTime() / 1000 | 0;\r\n  const timestamp = time.getTime() / 1000 | 0;\r\n\r\n  let timeStr: string;\r\n  if((now - timestamp) < ONE_DAY && date.getDate() === time.getDate()) { // if the same day\r\n    timeStr = ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2);\r\n  } else if(date.getFullYear() !== time.getFullYear()) { // different year\r\n    timeStr = time.getDate() + '.' + ('0' + (time.getMonth() + 1)).slice(-2) + '.' + ('' + time.getFullYear()).slice(-2);\r\n  } else if((now - timestamp) < (ONE_DAY * 7) && getWeekNumber(date) === getWeekNumber(time)) { // current week\r\n    timeStr = days[time.getDay()].slice(0, 3);\r\n  } else { // same year\r\n    timeStr = months[time.getMonth()].slice(0, 3) + ' ' + ('0' + time.getDate()).slice(-2);\r\n  }\r\n\r\n  return timeStr;\r\n};\r\n\r\nexport function formatDateAccordingToTodayNew(time: Date) {\r\n  const today = new Date();\r\n  const now = today.getTime() / 1000 | 0;\r\n  const timestamp = time.getTime() / 1000 | 0;\r\n\r\n  const options: Intl.DateTimeFormatOptions = {};\r\n  if((now - timestamp) < ONE_DAY && today.getDate() === time.getDate()) { // if the same day\r\n    options.hour = options.minute = '2-digit';\r\n  } else if(today.getFullYear() !== time.getFullYear()) { // different year\r\n    options.year = options.day = 'numeric';\r\n    options.month = '2-digit';\r\n  } else if((now - timestamp) < (ONE_DAY * 7) && getWeekNumber(today) === getWeekNumber(time)) { // current week\r\n    options.weekday = 'short';\r\n  } else { // same year\r\n    options.month = 'short';\r\n    options.day = 'numeric';\r\n  }\r\n\r\n  return new I18n.IntlDateElement({\r\n    date: time,\r\n    options\r\n  }).element;\r\n}\r\n\r\nexport function formatTime(date: Date) {\r\n  return new I18n.IntlDateElement({\r\n    date,\r\n    options: {\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    }\r\n  }).element;\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.formatDateAccordingToTodayNew = formatDateAccordingToTodayNew);\r\n\r\nexport const getFullDate = (date: Date, options: Partial<{\r\n  noTime: true, \r\n  noSeconds: true,\r\n  monthAsNumber: true,\r\n  leadingZero: true\r\n}> = {}) => {\r\n  const joiner = options.monthAsNumber ? '.' : ' ';\r\n  const time = ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + (options.noSeconds ? '' : ':' + ('0' + date.getSeconds()).slice(-2));\r\n\r\n  return (options.leadingZero ? ('0' + date.getDate()).slice(-2) : date.getDate()) + \r\n    joiner + (options.monthAsNumber ? ('0' + (date.getMonth() + 1)).slice(-2) : months[date.getMonth()]) + \r\n    joiner + date.getFullYear() + \r\n    (options.noTime ? '' : ', ' + time);\r\n};\r\n\r\nexport function tsNow(seconds?: true) {\r\n  const t = Date.now();\r\n  return seconds ? Math.floor(t / 1000) : t;\r\n}\r\n\r\n// https://github.com/DrKLO/Telegram/blob/d52b2c921abd3c1e8d6368858313ad0cb0468c07/TMessagesProj/src/main/java/org/telegram/ui/Adapters/FiltersView.java\r\nconst minYear = 2013;\r\nconst yearPattern = new RegExp(\"20[0-9]{1,2}\");\r\nconst monthYearOrDayPattern = new RegExp(\"(\\\\w{3,}) ([0-9]{0,4})\", 'i');\r\nconst yearOrDayAndMonthPattern = new RegExp(\"([0-9]{0,4}) (\\\\w{2,})\", 'i');\r\nconst shortDate = new RegExp(\"^([0-9]{1,4})(\\\\.| |/|\\\\-)([0-9]{1,4})$\", 'i');\r\nconst longDate = new RegExp(\"^([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,4})$\", 'i');\r\nconst numberOfDaysEachMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];\r\nexport type DateData = {\r\n  title: string,\r\n  minDate: number,\r\n  maxDate: number,\r\n};\r\nexport function fillTipDates(query: string, dates: DateData[]) {\r\n  const q = query.trim().toLowerCase();\r\n\r\n  if(q.length < 3) {\r\n    return;\r\n  }\r\n\r\n  if(\"today\".indexOf(q) === 0) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: 'Today',\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  if(\"yesterday\".indexOf(q) === 0) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime() - 86400000;\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 86400001;\r\n    dates.push({\r\n      title: 'Yesterday',\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  const dayOfWeek = getDayOfWeek(q);\r\n  if(dayOfWeek >= 0) {\r\n    const date = new Date();\r\n    const now = date.getTime();\r\n    const currentDay = date.getDay();\r\n    const distance = dayOfWeek - currentDay;\r\n    date.setDate(date.getDate() + distance);\r\n    if(date.getTime() > now) {\r\n      date.setTime(date.getTime() - 604800000);\r\n    }\r\n    const year = date.getFullYear()\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: formatWeekLong(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  let matches: any[];\r\n  if((matches = shortDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const k = parseInt(g1);\r\n    const k1 = parseInt(g2);\r\n    if(k > 0 && k <= 31) {\r\n      if(k1 >= minYear && k <= 12) {\r\n        const selectedYear = k1;\r\n        const month = k - 1;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      } else if (k1 <= 12) {\r\n        const day = k - 1;\r\n        const month = k1 - 1;\r\n        createForDayMonth(dates, day, month);\r\n      }\r\n    } else if (k >= minYear && k1 <= 12) {\r\n      const selectedYear = k;\r\n      const month = k1 - 1;\r\n      createForMonthYear(dates, month, selectedYear);\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = longDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const g3 = matches[5];\r\n    if(!matches[2] === matches[4]) {\r\n      return;\r\n    }\r\n\r\n    const day = parseInt(g1);\r\n    const month = parseInt(g2) - 1;\r\n    let year = parseInt(g3);\r\n    if(year >= 10 && year <= 99) {\r\n      year += 2000;\r\n    }\r\n\r\n    const currentYear = new Date().getFullYear();\r\n    if(validDateForMonth(day - 1, month) && year >= minYear && year <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(year, month, day);\r\n      date.setHours(0, 0, 0);\r\n      \r\n      const minDate = date.getTime();\r\n      date.setFullYear(year, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: formatterYearMax(minDate),\r\n        minDate,\r\n        maxDate\r\n      });\r\n      return;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = yearPattern.exec(q)) !== null) {\r\n    let selectedYear = +q;\r\n    const currentYear = new Date().getFullYear();\r\n    if(selectedYear < minYear) {\r\n      selectedYear = minYear;\r\n      for(let i = currentYear; i >= selectedYear; i--) {\r\n        const date = new Date();\r\n        date.setFullYear(i, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const minDate = date.getTime();\r\n        date.setFullYear(i + 1, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const maxDate = date.getTime() - 1;\r\n        dates.push({\r\n          title: '' + i,\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    } else if(selectedYear <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(selectedYear, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const minDate = date.getTime();\r\n      date.setFullYear(selectedYear + 1, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: '' + selectedYear,\r\n        minDate,\r\n        maxDate\r\n      });\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = monthYearOrDayPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g1);\r\n    if(month >= 0) {\r\n      const k = +g2;\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if(k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  if((matches = yearOrDayAndMonthPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g2);\r\n    if(month >= 0) {\r\n      const k = +g1;\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if (k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction createForMonthYear(dates: DateData[], month: number, selectedYear: number) {\r\n  const currentYear = new Date().getFullYear();\r\n  const today = Date.now();\r\n  if(selectedYear >= minYear && selectedYear <= currentYear) {\r\n    const date = new Date();\r\n    date.setFullYear(selectedYear, month, 1);\r\n    date.setHours(0, 0, 0);\r\n    const minDate = date.getTime();\r\n    if(minDate > today) {\r\n      return;\r\n    }\r\n    date.setMonth(date.getMonth() + 1);\r\n    const maxDate = date.getTime() - 1;\r\n\r\n    dates.push({\r\n      title: formatterMonthYear(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n  }\r\n}\r\n\r\nfunction createForDayMonth(dates: DateData[], day: number, month: number) {\r\n  if(validDateForMonth(day, month)) {\r\n    const currentYear = new Date().getFullYear();\r\n    const today = Date.now();\r\n    \r\n    for(let i = currentYear; i >= minYear; i--) {\r\n      if(month === 1 && day === 28 && !isLeapYear(i)) {\r\n        continue;\r\n      }\r\n\r\n      const date = new Date();\r\n      date.setFullYear(i, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n      \r\n      const minDate = date.getTime();\r\n      if(minDate > today) {\r\n        continue;\r\n      }\r\n\r\n      date.setFullYear(i, month, day + 2);\r\n      date.setHours(0, 0, 0);\r\n      const maxDate = date.getTime() - 1;\r\n      if(i === currentYear) {\r\n        dates.push({\r\n          title: formatterDayMonth(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      } else {\r\n        dates.push({\r\n          title: formatterYearMax(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction formatterMonthYear(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return months[date.getMonth()].slice(0, 3) + ' ' + date.getFullYear();\r\n}\r\n\r\nfunction formatterDayMonth(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return months[date.getMonth()].slice(0, 3) + ' ' + date.getDate();\r\n}\r\n\r\nfunction formatterYearMax(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return ('0' + date.getDate()).slice(-2) + '.' + ('0' + (date.getMonth() + 1)).slice(-2) + '.' + date.getFullYear();\r\n}\r\n\r\nfunction formatWeekLong(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return days[date.getDay()];\r\n}\r\n\r\nfunction validDateForMonth(day: number, month: number) {\r\n  if(month >= 0 && month < 12) {\r\n    if(day >= 0 && day < numberOfDaysEachMonth[month]) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction isLeapYear(year: number) {\r\n  return ((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0);\r\n}\r\n\r\nfunction getMonth(q: string) {\r\n  /* String[] months = new String[]{\r\n          LocaleController.getString(\"January\", R.string.January).toLowerCase(),\r\n          LocaleController.getString(\"February\", R.string.February).toLowerCase(),\r\n          LocaleController.getString(\"March\", R.string.March).toLowerCase(),\r\n          LocaleController.getString(\"April\", R.string.April).toLowerCase(),\r\n          LocaleController.getString(\"May\", R.string.May).toLowerCase(),\r\n          LocaleController.getString(\"June\", R.string.June).toLowerCase(),\r\n          LocaleController.getString(\"July\", R.string.July).toLowerCase(),\r\n          LocaleController.getString(\"August\", R.string.August).toLowerCase(),\r\n          LocaleController.getString(\"September\", R.string.September).toLowerCase(),\r\n          LocaleController.getString(\"October\", R.string.October).toLowerCase(),\r\n          LocaleController.getString(\"November\", R.string.November).toLowerCase(),\r\n          LocaleController.getString(\"December\", R.string.December).toLowerCase()\r\n  }; */\r\n\r\n  /* String[] monthsEng = new String[12];\r\n  Calendar c = Calendar.getInstance();\r\n  for (int i = 1; i <= 12; i++) {\r\n      c.set(0, 0, 0, 0, 0, 0);\r\n      c.set(Calendar.MONTH, i);\r\n      monthsEng[i - 1] = c.getDisplayName(Calendar.MONTH, Calendar.LONG, Locale.ENGLISH).toLowerCase();\r\n  } */\r\n\r\n  q = q.toLowerCase();\r\n  for(let i = 0; i < 12; i++) {\r\n    const month = months[i].toLowerCase();\r\n    if(month.indexOf(q) === 0) {\r\n      return i;\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nfunction getDayOfWeek(q: string) {\r\n  const c = new Date();\r\n  if(q.length <= 3) {\r\n    return -1;\r\n  }\r\n  \r\n  for(let i = 0; i < 7; i++) {\r\n    c.setDate(c.getDate() + 1);\r\n    \r\n    if(formatWeekLong(c.getTime()).toLowerCase().indexOf(q) === 0) {\r\n      return c.getDay();\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nMOUNT_CLASS_TO.fillTipDates = fillTipDates;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport type { Chat, DialogPeer, Message, MessagesPeerDialogs, Update } from \"../../layer\";\r\nimport type { AppChatsManager } from \"../appManagers/appChatsManager\";\r\nimport type { AppMessagesManager, Dialog, MyMessage } from \"../appManagers/appMessagesManager\";\r\nimport type { AppPeersManager } from \"../appManagers/appPeersManager\";\r\nimport type { AppUsersManager } from \"../appManagers/appUsersManager\";\r\nimport type { AppDraftsManager } from \"../appManagers/appDraftsManager\";\r\nimport type { AppNotificationsManager } from \"../appManagers/appNotificationsManager\";\r\nimport type { ApiUpdatesManager } from \"../appManagers/apiUpdatesManager\";\r\nimport type { ServerTimeManager } from \"../mtproto/serverTimeManager\";\r\nimport { tsNow } from \"../../helpers/date\";\r\nimport apiManager from \"../mtproto/mtprotoworker\";\r\nimport SearchIndex from \"../searchIndex\";\r\nimport { forEachReverse, insertInDescendSortedArray } from \"../../helpers/array\";\r\nimport rootScope from \"../rootScope\";\r\nimport { safeReplaceObject } from \"../../helpers/object\";\r\nimport { AppStateManager } from \"../appManagers/appStateManager\";\r\nimport { SliceEnd } from \"../../helpers/slicedArray\";\r\n\r\nexport default class DialogsStorage {\r\n  private storage: AppStateManager['storages']['dialogs'];\r\n  \r\n  private dialogs: {[peerId: string]: Dialog};\r\n  public byFolders: {[folderId: number]: Dialog[]};\r\n\r\n  private allDialogsLoaded: {[folder_id: number]: boolean};\r\n  private dialogsOffsetDate: {[folder_id: number]: number};\r\n  private pinnedOrders: {[folder_id: number]: number[]};\r\n  private dialogsNum: number;\r\n\r\n  private dialogsIndex: SearchIndex<number>;\r\n\r\n  private cachedResults: {\r\n    query: string,\r\n    count: number,\r\n    dialogs: Dialog[],\r\n    folderId: number\r\n  };\r\n\r\n  constructor(private appMessagesManager: AppMessagesManager, \r\n    private appChatsManager: AppChatsManager, \r\n    private appPeersManager: AppPeersManager, \r\n    private appUsersManager: AppUsersManager,\r\n    private appDraftsManager: AppDraftsManager,\r\n    private appNotificationsManager: AppNotificationsManager,\r\n    private appStateManager: AppStateManager,\r\n    private apiUpdatesManager: ApiUpdatesManager,\r\n    private serverTimeManager: ServerTimeManager\r\n  ) {\r\n    this.clear();\r\n    this.storage = this.appStateManager.storages.dialogs;\r\n\r\n    rootScope.addEventListener('language_change', (e) => {\r\n      const peerId = appUsersManager.getSelf().id;\r\n      const dialog = this.getDialogOnly(peerId);\r\n      if(dialog) {\r\n        const peerText = appPeersManager.getPeerSearchText(peerId);\r\n        this.dialogsIndex.indexObject(peerId, peerText);\r\n      }\r\n    });\r\n\r\n    rootScope.addMultipleEventsListeners({\r\n      updateFolderPeers: this.onUpdateFolderPeers,\r\n\r\n      updateDialogPinned: this.onUpdateDialogPinned,\r\n\r\n      updatePinnedDialogs: this.onUpdatePinnedDialogs,\r\n    });\r\n\r\n    appStateManager.getState().then((state) => {\r\n      this.pinnedOrders = state.pinnedOrders || {};\r\n      if(!this.pinnedOrders[0]) this.pinnedOrders[0] = [];\r\n      if(!this.pinnedOrders[1]) this.pinnedOrders[1] = [];\r\n      \r\n      const dialogs = appStateManager.storagesResults.dialogs;\r\n      if(dialogs.length) {\r\n        for(let i = 0, length = dialogs.length; i < length; ++i) {\r\n          const dialog = dialogs[i];\r\n          if(dialog) {\r\n            dialog.top_message = this.appMessagesManager.getServerMessageId(dialog.top_message); // * fix outgoing message to avoid copying dialog\r\n\r\n            if(dialog.topMessage) {\r\n              this.appMessagesManager.saveMessages([dialog.topMessage]);\r\n            }\r\n  \r\n            this.saveDialog(dialog);\r\n\r\n            // ! WARNING, убрать это когда нужно будет делать чтобы pending сообщения сохранялись\r\n            const message = this.appMessagesManager.getMessageByPeer(dialog.peerId, dialog.top_message);\r\n            if(message.deleted) {\r\n              this.appMessagesManager.reloadConversation(dialog.peerId);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      this.allDialogsLoaded = state.allDialogsLoaded || {};\r\n    });\r\n  }\r\n\r\n  public isDialogsLoaded(folderId: number) {\r\n    return !!this.allDialogsLoaded[folderId];\r\n  }\r\n\r\n  public setDialogsLoaded(folderId: number, loaded: boolean) {\r\n    this.allDialogsLoaded[folderId] = loaded;\r\n    this.appStateManager.pushToState('allDialogsLoaded', this.allDialogsLoaded);\r\n  }\r\n\r\n  public clear() {\r\n    this.dialogs = {};\r\n    this.byFolders = {};\r\n    this.allDialogsLoaded = {};\r\n    this.dialogsOffsetDate = {};\r\n    this.pinnedOrders = {\r\n      0: [],\r\n      1: []\r\n    };\r\n    this.dialogsNum = 0;\r\n    this.dialogsIndex = new SearchIndex<number>();\r\n    this.cachedResults = {\r\n      query: '',\r\n      count: 0,\r\n      dialogs: [],\r\n      folderId: 0\r\n    };\r\n  }\r\n\r\n  public resetPinnedOrder(folderId: number) {\r\n    this.pinnedOrders[folderId] = [];\r\n  }\r\n\r\n  public getOffsetDate(folderId: number) {\r\n    return this.dialogsOffsetDate[folderId] || 0;\r\n  }\r\n\r\n  public getFolder(id: number) {\r\n    if(id <= 1) {\r\n      return this.byFolders[id] ?? (this.byFolders[id] = []);\r\n    }\r\n\r\n    const dialogs: {dialog: Dialog, index: number}[] = [];\r\n    const filter = this.appMessagesManager.filtersStorage.filters[id];\r\n\r\n    for(const peerId in this.dialogs) {\r\n      const dialog = this.dialogs[peerId];\r\n      if(this.appMessagesManager.filtersStorage.testDialogForFilter(dialog, filter)) {\r\n        let index: number;\r\n\r\n        const pinnedIndex = filter.pinned_peers.indexOf(dialog.peerId);\r\n        if(pinnedIndex !== -1) {\r\n          index = this.generateDialogIndex(this.generateDialogPinnedDateByIndex(filter.pinned_peers.length - 1 - pinnedIndex));\r\n        } else if(dialog.pFlags?.pinned) {\r\n          index = this.generateIndexForDialog(dialog, true);\r\n        } else {\r\n          index = dialog.index;\r\n        }\r\n\r\n        dialogs.push({dialog, index});\r\n      }\r\n    }\r\n\r\n    dialogs.sort((a, b) => b.index - a.index);\r\n    return dialogs.map(d => d.dialog);\r\n  }\r\n\r\n  public getDialog(peerId: number, folderId?: number): [Dialog, number] | [] {\r\n    const folders: Dialog[][] = [];\r\n\r\n    if(folderId === undefined) {\r\n      const dialogs = this.byFolders;\r\n      for(const folderId in dialogs) {\r\n        folders.push(dialogs[folderId]);\r\n      }\r\n    } else {\r\n      folders.push(this.getFolder(folderId));\r\n    }\r\n\r\n    for(let folder of folders) {\r\n      const index = folder.findIndex(dialog => dialog.peerId === peerId);\r\n      if(index !== -1) {\r\n        return [folder[index], index];\r\n      }\r\n    }\r\n\r\n    return [];\r\n  }\r\n\r\n  public getDialogOnly(peerId: number) {\r\n    return this.dialogs[peerId];\r\n  }\r\n\r\n  /*\r\n  var date = Date.now() / 1000 | 0;\r\n  var m = date * 0x10000;\r\n\r\n  var k = (date + 1) * 0x10000;\r\n  k - m;\r\n  65536\r\n  */\r\n  public generateDialogIndex(date?: number) {\r\n    if(date === undefined) {\r\n      date = tsNow(true) + this.serverTimeManager.serverTimeOffset;\r\n    }\r\n\r\n    return (date * 0x10000) + ((++this.dialogsNum) & 0xFFFF);\r\n  }\r\n\r\n  public generateIndexForDialog(dialog: Dialog, justReturn = false, message?: MyMessage) {\r\n    const channelId = this.appPeersManager.isChannel(dialog.peerId) ? -dialog.peerId : 0;\r\n    \r\n    let topDate = 0;\r\n    if(dialog.pFlags.pinned && !justReturn) {\r\n      topDate = this.generateDialogPinnedDate(dialog);\r\n    } else {\r\n      if(!message) {\r\n        message = this.appMessagesManager.getMessageByPeer(dialog.peerId, dialog.top_message);\r\n      }\r\n\r\n      topDate = (message as Message.message).date || topDate;\r\n      if(channelId) {\r\n        const channel = this.appChatsManager.getChat(channelId);\r\n        if(!topDate || (channel.date && channel.date > topDate)) {\r\n          topDate = channel.date;\r\n        }\r\n      }\r\n  \r\n      if(dialog.draft?._ === 'draftMessage' && dialog.draft.date > topDate) {\r\n        topDate = dialog.draft.date;\r\n      }\r\n    }\r\n\r\n    if(!topDate) {\r\n      topDate = Date.now() / 1000;\r\n    }\r\n\r\n    const index = this.generateDialogIndex(topDate);\r\n    if(justReturn) return index;\r\n    dialog.index = index;\r\n  }\r\n\r\n  public generateDialogPinnedDateByIndex(pinnedIndex: number) {\r\n    return 0x7fff0000 + (pinnedIndex & 0xFFFF); // 0xFFFF - потому что в папках может быть бесконечное число пиннедов\r\n  }\r\n\r\n  public generateDialogPinnedDate(dialog: Dialog) {\r\n    const order = this.pinnedOrders[dialog.folder_id];\r\n\r\n    const foundIndex = order.indexOf(dialog.peerId);\r\n    let pinnedIndex = foundIndex;\r\n    if(foundIndex === -1) {\r\n      pinnedIndex = order.push(dialog.peerId) - 1;\r\n      this.appStateManager.pushToState('pinnedOrders', this.pinnedOrders);\r\n    }\r\n\r\n    return this.generateDialogPinnedDateByIndex(pinnedIndex);\r\n  }\r\n\r\n  public generateDialog(peerId: number) {\r\n    const dialog: Dialog = {\r\n      _: 'dialog',\r\n      pFlags: {},\r\n      peer: this.appPeersManager.getOutputPeer(peerId),\r\n      top_message: 0,\r\n      read_inbox_max_id: 0,\r\n      read_outbox_max_id: 0,\r\n      unread_count: 0,\r\n      unread_mentions_count: 0,\r\n      notify_settings: {\r\n        _: 'peerNotifySettings',\r\n      },\r\n    };\r\n\r\n    return dialog;\r\n  }\r\n\r\n  public setDialogToState(dialog: Dialog) {\r\n    const historyStorage = this.appMessagesManager.getHistoryStorage(dialog.peerId);\r\n    const history = [].concat(historyStorage.history.slice);\r\n    let incomingMessage: any;\r\n    for(let i = 0, length = history.length; i < length; ++i) {\r\n      const mid = history[i];\r\n      const message = this.appMessagesManager.getMessageByPeer(dialog.peerId, mid);\r\n      if(!message.pFlags.is_outgoing) {\r\n        incomingMessage = message;\r\n  \r\n        if(message.fromId !== dialog.peerId) {\r\n          this.appStateManager.requestPeer(message.fromId, 'topMessage_' + dialog.peerId, 1);\r\n        }\r\n\r\n        break;\r\n      }\r\n    }\r\n\r\n    dialog.topMessage = incomingMessage;\r\n\r\n    if(dialog.peerId < 0 && dialog.pts) {\r\n      const newPts = this.apiUpdatesManager.getChannelState(-dialog.peerId, dialog.pts).pts;\r\n      dialog.pts = newPts;\r\n    }\r\n\r\n    this.storage.set({\r\n      [dialog.peerId]: dialog\r\n    });\r\n\r\n    this.appStateManager.requestPeer(dialog.peerId, 'dialog_' + dialog.peerId, 1);\r\n  }\r\n\r\n  public pushDialog(dialog: Dialog, offsetDate?: number) {\r\n    const dialogs = this.getFolder(dialog.folder_id);\r\n    const pos = dialogs.findIndex(d => d.peerId === dialog.peerId);\r\n    if(pos !== -1) {\r\n      dialogs.splice(pos, 1);\r\n    }\r\n\r\n    //if(!this.dialogs[dialog.peerId]) {\r\n      this.dialogs[dialog.peerId] = dialog;\r\n\r\n      this.setDialogToState(dialog);\r\n    //}\r\n\r\n    if(offsetDate &&\r\n      !dialog.pFlags.pinned &&\r\n      (!this.dialogsOffsetDate[dialog.folder_id] || offsetDate < this.dialogsOffsetDate[dialog.folder_id])) {\r\n      if(pos !== -1) {\r\n        // So the dialog jumped to the last position\r\n        return false;\r\n      }\r\n      this.dialogsOffsetDate[dialog.folder_id] = offsetDate;\r\n    }\r\n\r\n    insertInDescendSortedArray(dialogs, dialog, 'index', pos);\r\n  }\r\n\r\n  public dropDialog(peerId: number): [Dialog, number] | [] {\r\n    const foundDialog = this.getDialog(peerId);\r\n    if(foundDialog[0]) {\r\n      this.byFolders[foundDialog[0].folder_id].splice(foundDialog[1], 1);\r\n      delete this.dialogs[peerId];\r\n      this.dialogsIndex.indexObject(peerId, '');\r\n\r\n      // clear from state\r\n      this.appStateManager.keepPeerSingle(0, 'topMessage_' + peerId);\r\n      this.appStateManager.keepPeerSingle(0, 'dialog_' + peerId);\r\n      this.storage.delete(peerId);\r\n    }\r\n\r\n    return foundDialog;\r\n  }\r\n\r\n  public applyDialogs(dialogsResult: MessagesPeerDialogs.messagesPeerDialogs) {\r\n    // * В эту функцию попадут только те диалоги, в которых есть read_inbox_max_id и read_outbox_max_id, в отличие от тех, что будут в getTopMessages\r\n\r\n    // ! fix 'dialogFolder', maybe there is better way to do it, this only can happen by 'messages.getPinnedDialogs' by folder_id: 0\r\n    forEachReverse(dialogsResult.dialogs, (dialog, idx) => {\r\n      if(dialog._ === 'dialogFolder') {\r\n        dialogsResult.dialogs.splice(idx, 1);\r\n      }\r\n    });\r\n\r\n    this.appUsersManager.saveApiUsers(dialogsResult.users);\r\n    this.appChatsManager.saveApiChats(dialogsResult.chats);\r\n    this.appMessagesManager.saveMessages(dialogsResult.messages);\r\n\r\n    this.appMessagesManager.log('applyConversation', dialogsResult);\r\n\r\n    const updatedDialogs: {[peerId: number]: Dialog} = {};\r\n    (dialogsResult.dialogs as Dialog[]).forEach((dialog) => {\r\n      const peerId = this.appPeersManager.getPeerId(dialog.peer);\r\n      let topMessage = dialog.top_message;\r\n\r\n      const topPendingMessage = this.appMessagesManager.pendingTopMsgs[peerId];\r\n      if(topPendingMessage) {\r\n        if(!topMessage \r\n          || (this.appMessagesManager.getMessageByPeer(peerId, topPendingMessage) as MyMessage).date > (this.appMessagesManager.getMessageByPeer(peerId, topMessage) as MyMessage).date) {\r\n          dialog.top_message = topMessage = topPendingMessage;\r\n          this.appMessagesManager.getHistoryStorage(peerId).maxId = topPendingMessage;\r\n        }\r\n      }\r\n\r\n      /* const d = Object.assign({}, dialog);\r\n      if(peerId === 239602833) {\r\n        this.log.error('applyConversation lun', dialog, d);\r\n      } */\r\n\r\n      if(topMessage || (dialog.draft && dialog.draft._ === 'draftMessage')) {\r\n        this.saveDialog(dialog);\r\n        updatedDialogs[peerId] = dialog;\r\n      } else {\r\n        const dropped = this.dropDialog(peerId);\r\n        if(dropped.length) {\r\n          rootScope.dispatchEvent('dialog_drop', {peerId, dialog: dropped[0]});\r\n        }\r\n      }\r\n\r\n      const updates = this.appMessagesManager.newUpdatesAfterReloadToHandle[peerId];\r\n      if(updates !== undefined) {\r\n        for(const update of updates) {\r\n          this.apiUpdatesManager.saveUpdate(update);\r\n        }\r\n\r\n        delete this.appMessagesManager.newUpdatesAfterReloadToHandle[peerId];\r\n      }\r\n    });\r\n\r\n    if(Object.keys(updatedDialogs).length) {\r\n      rootScope.dispatchEvent('dialogs_multiupdate', updatedDialogs);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Won't save migrated from peer, forbidden peers, left and kicked\r\n   */\r\n  public saveDialog(dialog: Dialog, folderId = 0) {\r\n    const peerId = this.appPeersManager.getPeerId(dialog.peer);\r\n    if(!peerId) {\r\n      console.error('saveConversation no peerId???', dialog, folderId);\r\n      return false;\r\n    }\r\n\r\n    if(dialog._ !== 'dialog'/*  || peerId === 239602833 */) {\r\n      console.error('saveConversation not regular dialog', dialog, Object.assign({}, dialog));\r\n    }\r\n    \r\n    const channelId = this.appPeersManager.isChannel(peerId) ? -peerId : 0;\r\n\r\n    if(peerId < 0) {\r\n      const chat: Chat = this.appChatsManager.getChat(-peerId);\r\n      if(chat._ === 'channelForbidden' || chat._ === 'chatForbidden' || (chat as Chat.chat).pFlags.left || (chat as Chat.chat).pFlags.kicked) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    const peerText = this.appPeersManager.getPeerSearchText(peerId);\r\n    this.dialogsIndex.indexObject(peerId, peerText);\r\n\r\n    let mid: number, message;\r\n    if(dialog.top_message) {\r\n      mid = this.appMessagesManager.generateMessageId(dialog.top_message);//dialog.top_message;\r\n      message = this.appMessagesManager.getMessageByPeer(peerId, mid);\r\n    } else {\r\n      mid = this.appMessagesManager.generateTempMessageId(peerId);\r\n      message = {\r\n        _: 'message',\r\n        id: mid,\r\n        mid,\r\n        from_id: this.appPeersManager.getOutputPeer(this.appUsersManager.getSelf().id),\r\n        peer_id: this.appPeersManager.getOutputPeer(peerId),\r\n        deleted: true,\r\n        pFlags: {out: true},\r\n        date: 0,\r\n        message: ''\r\n      };\r\n      this.appMessagesManager.saveMessages([message], {isOutgoing: true});\r\n    }\r\n\r\n    if(!message?.pFlags) {\r\n      this.appMessagesManager.log.error('saveConversation no message:', dialog, message);\r\n    }\r\n\r\n    if(!channelId && peerId < 0) {\r\n      const chat = this.appChatsManager.getChat(-peerId);\r\n      if(chat && chat.migrated_to && chat.pFlags.deactivated) {\r\n        const migratedToPeer = this.appPeersManager.getPeerId(chat.migrated_to);\r\n        this.appMessagesManager.migratedFromTo[peerId] = migratedToPeer;\r\n        this.appMessagesManager.migratedToFrom[migratedToPeer] = peerId;\r\n        return;\r\n      }\r\n    }\r\n\r\n    const wasDialogBefore = this.getDialogOnly(peerId);\r\n\r\n    dialog.top_message = mid;\r\n    dialog.read_inbox_max_id = this.appMessagesManager.generateMessageId(wasDialogBefore && !dialog.read_inbox_max_id ? wasDialogBefore.read_inbox_max_id : dialog.read_inbox_max_id);\r\n    dialog.read_outbox_max_id = this.appMessagesManager.generateMessageId(wasDialogBefore && !dialog.read_outbox_max_id ? wasDialogBefore.read_outbox_max_id : dialog.read_outbox_max_id);\r\n\r\n    if(!dialog.hasOwnProperty('folder_id')) {\r\n      if(dialog._ === 'dialog') {\r\n        // ! СЛОЖНО ! СМОТРИ В getTopMessages\r\n        dialog.folder_id = wasDialogBefore ? wasDialogBefore.folder_id : folderId;\r\n      }/*  else if(dialog._ === 'dialogFolder') {\r\n        dialog.folder_id = dialog.folder.id;\r\n      } */\r\n    }\r\n\r\n    dialog.draft = this.appDraftsManager.saveDraft(peerId, 0, dialog.draft);\r\n    dialog.peerId = peerId;\r\n\r\n    // Because we saved message without dialog present\r\n    if(message.pFlags.is_outgoing) {\r\n      if(mid > dialog[message.pFlags.out ? 'read_outbox_max_id' : 'read_inbox_max_id']) message.pFlags.unread = true;\r\n      else delete message.pFlags.unread;\r\n    }\r\n\r\n    const historyStorage = this.appMessagesManager.getHistoryStorage(peerId);\r\n    const slice = historyStorage.history.slice;\r\n    /* if(historyStorage === undefined) { // warning\r\n      historyStorage.history.push(mid);\r\n      if(this.mergeReplyKeyboard(historyStorage, message)) {\r\n        rootScope.broadcast('history_reply_markup', {peerId});\r\n      }\r\n    } else  */if(!slice.length) {\r\n      historyStorage.history.unshift(mid);\r\n    } else if(!slice.isEnd(SliceEnd.Bottom)) { // * this will probably never happen, however, if it does, then it will fix slice with top_message\r\n      const slice = historyStorage.history.insertSlice([mid]);\r\n      slice.setEnd(SliceEnd.Bottom);\r\n    }\r\n\r\n    historyStorage.maxId = mid;\r\n    historyStorage.readMaxId = dialog.read_inbox_max_id;\r\n    historyStorage.readOutboxMaxId = dialog.read_outbox_max_id;\r\n\r\n    this.appNotificationsManager.savePeerSettings(peerId, dialog.notify_settings);\r\n\r\n    if(channelId && dialog.pts) {\r\n      this.apiUpdatesManager.addChannelState(channelId, dialog.pts);\r\n    }\r\n\r\n    this.generateIndexForDialog(dialog);\r\n\r\n    if(wasDialogBefore) {\r\n      safeReplaceObject(wasDialogBefore, dialog);\r\n    }\r\n\r\n    this.pushDialog(dialog, message.date);\r\n  }\r\n\r\n  public getDialogs(query = '', offsetIndex?: number, limit = 20, folderId = 0) {\r\n    const realFolderId = folderId > 1 ? 0 : folderId;\r\n    let curDialogStorage = this.getFolder(folderId);\r\n\r\n    if(query) {\r\n      if(!limit || this.cachedResults.query !== query || this.cachedResults.folderId !== folderId) {\r\n        this.cachedResults.query = query;\r\n        this.cachedResults.folderId = folderId;\r\n\r\n        const results = this.dialogsIndex.search(query);\r\n\r\n        this.cachedResults.dialogs = [];\r\n\r\n        for(const peerId in this.dialogs) {\r\n          const dialog = this.dialogs[peerId];\r\n          if(results.has(dialog.peerId) && dialog.folder_id === folderId) {\r\n            this.cachedResults.dialogs.push(dialog);\r\n          }\r\n        }\r\n\r\n        this.cachedResults.dialogs.sort((d1, d2) => d2.index - d1.index);\r\n\r\n        this.cachedResults.count = this.cachedResults.dialogs.length;\r\n      }\r\n\r\n      curDialogStorage = this.cachedResults.dialogs;\r\n    } else {\r\n      this.cachedResults.query = '';\r\n    }\r\n\r\n    let offset = 0;\r\n    if(offsetIndex > 0) {\r\n      for(; offset < curDialogStorage.length; offset++) {\r\n        if(offsetIndex > curDialogStorage[offset].index) {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    const loadedAll = this.isDialogsLoaded(realFolderId);\r\n    if(query || loadedAll || curDialogStorage.length >= offset + limit) {\r\n      return Promise.resolve({\r\n        dialogs: curDialogStorage.slice(offset, offset + limit),\r\n        count: loadedAll ? curDialogStorage.length : null,\r\n        isEnd: loadedAll && (offset + limit) >= curDialogStorage.length\r\n      });\r\n    }\r\n\r\n    return this.appMessagesManager.getTopMessages(limit, realFolderId).then(messagesDialogs => {\r\n      //const curDialogStorage = this[folderId];\r\n\r\n      offset = 0;\r\n      if(offsetIndex > 0) {\r\n        for(; offset < curDialogStorage.length; offset++) {\r\n          if(offsetIndex > curDialogStorage[offset].index) {\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      //this.log.warn(offset, offset + limit, curDialogStorage.dialogs.length, this.dialogs.length);\r\n\r\n      return {\r\n        dialogs: curDialogStorage.slice(offset, offset + limit),\r\n        count: messagesDialogs._ === 'messages.dialogs' ? messagesDialogs.dialogs.length : messagesDialogs.count,\r\n        isEnd: this.isDialogsLoaded(realFolderId) && (offset + limit) >= curDialogStorage.length\r\n      };\r\n    });\r\n  }\r\n\r\n  // only 0 and 1 folders\r\n  private onUpdateFolderPeers = (update: Update.updateFolderPeers) => {\r\n    //this.log('updateFolderPeers', update);\r\n    const peers = update.folder_peers;\r\n\r\n    peers.forEach((folderPeer) => {\r\n      const {folder_id, peer} = folderPeer;\r\n\r\n      const peerId = this.appPeersManager.getPeerId(peer);\r\n      const dialog = this.dropDialog(peerId)[0];\r\n      if(dialog) {\r\n        if(dialog.pFlags?.pinned) {\r\n          delete dialog.pFlags.pinned;\r\n          this.pinnedOrders[folder_id].findAndSplice(p => p === dialog.peerId);\r\n          this.appStateManager.pushToState('pinnedOrders', this.pinnedOrders);\r\n        }\r\n\r\n        dialog.folder_id = folder_id;\r\n        this.generateIndexForDialog(dialog);\r\n        this.pushDialog(dialog); // need for simultaneously updatePinnedDialogs\r\n      }\r\n\r\n      this.appMessagesManager.scheduleHandleNewDialogs(peerId, dialog);\r\n    });\r\n  };\r\n\r\n  private onUpdateDialogPinned = (update: Update.updateDialogPinned) => {\r\n    const folderId = update.folder_id ?? 0;\r\n    //this.log('updateDialogPinned', update);\r\n    const peerId = this.appPeersManager.getPeerId((update.peer as DialogPeer.dialogPeer).peer);\r\n    const dialog = this.getDialogOnly(peerId);\r\n\r\n    // этот код внизу никогда не сработает, в папках за пиннед отвечает updateDialogFilter\r\n    /* if(update.folder_id > 1) {\r\n      const filter = this.filtersStorage.filters[update.folder_id];\r\n      if(update.pFlags.pinned) {\r\n        filter.pinned_peers.unshift(peerId);\r\n      } else {\r\n        filter.pinned_peers.findAndSplice(p => p === peerId);\r\n      }\r\n    } */\r\n\r\n    if(dialog) {\r\n      if(!update.pFlags.pinned) {\r\n        delete dialog.pFlags.pinned;\r\n        this.pinnedOrders[folderId].findAndSplice(p => p === dialog.peerId);\r\n        this.appStateManager.pushToState('pinnedOrders', this.pinnedOrders);\r\n      } else { // means set\r\n        dialog.pFlags.pinned = true;\r\n      }\r\n\r\n      this.generateIndexForDialog(dialog);\r\n    } \r\n\r\n    this.appMessagesManager.scheduleHandleNewDialogs(peerId, dialog);\r\n  };\r\n\r\n  private onUpdatePinnedDialogs = (update: Update.updatePinnedDialogs) => {\r\n    const folderId = update.folder_id ?? 0;\r\n        \r\n    const handleOrder = (order: number[]) => {\r\n      this.pinnedOrders[folderId].length = 0;\r\n      order.reverse(); // index must be higher\r\n      order.forEach((peerId) => {\r\n        newPinned[peerId] = true;\r\n  \r\n        const dialog = this.getDialogOnly(peerId);\r\n        this.appMessagesManager.scheduleHandleNewDialogs(peerId, dialog);\r\n        if(!dialog) {\r\n          return;\r\n        }\r\n  \r\n        dialog.pFlags.pinned = true;\r\n        this.generateIndexForDialog(dialog);\r\n      });\r\n      \r\n      this.getFolder(folderId).forEach(dialog => {\r\n        const peerId = dialog.peerId;\r\n        if(dialog.pFlags.pinned && !newPinned[peerId]) {\r\n          this.appMessagesManager.scheduleHandleNewDialogs(peerId);\r\n        }\r\n      });\r\n    };\r\n\r\n    //this.log('updatePinnedDialogs', update);\r\n    const newPinned: {[peerId: number]: true} = {};\r\n    if(!update.order) {\r\n      apiManager.invokeApi('messages.getPinnedDialogs', {\r\n        folder_id: folderId\r\n      }).then((dialogsResult) => {\r\n        // * for test reordering and rendering\r\n        // dialogsResult.dialogs.reverse();\r\n\r\n        this.applyDialogs(dialogsResult);\r\n\r\n        handleOrder(dialogsResult.dialogs.map(d => d.peerId));\r\n\r\n        /* dialogsResult.dialogs.forEach((dialog) => {\r\n          newPinned[dialog.peerId] = true;\r\n        });\r\n\r\n        this.dialogsStorage.getFolder(folderId).forEach((dialog) => {\r\n          const peerId = dialog.peerId;\r\n          if(dialog.pFlags.pinned && !newPinned[peerId]) {\r\n            this.newDialogsToHandle[peerId] = {reload: true};\r\n            this.scheduleHandleNewDialogs();\r\n          }\r\n        }); */\r\n      });\r\n\r\n      return;\r\n    }\r\n\r\n    //this.log('before order:', this.dialogsStorage[0].map(d => d.peerId));\r\n\r\n    handleOrder(update.order.map(peer => this.appPeersManager.getPeerId((peer as DialogPeer.dialogPeer).peer)));\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { copy } from \"../../helpers/object\";\r\nimport type { DialogFilter, Update } from \"../../layer\";\r\nimport type { Modify } from \"../../types\";\r\nimport type { AppPeersManager } from \"../appManagers/appPeersManager\";\r\nimport type { AppUsersManager } from \"../appManagers/appUsersManager\";\r\n//import type { ApiManagerProxy } from \"../mtproto/mtprotoworker\";\r\nimport type _rootScope from \"../rootScope\";\r\nimport type {AppMessagesManager, Dialog} from '../appManagers/appMessagesManager';\r\nimport type {AppNotificationsManager} from \"../appManagers/appNotificationsManager\";\r\nimport type { ApiUpdatesManager } from \"../appManagers/apiUpdatesManager\";\r\nimport apiManager from \"../mtproto/mtprotoworker\";\r\nimport { forEachReverse } from \"../../helpers/array\";\r\nimport { AppStateManager } from \"../appManagers/appStateManager\";\r\n\r\nexport type MyDialogFilter = Modify<DialogFilter, {\r\n  pinned_peers: number[],\r\n  include_peers: number[],\r\n  exclude_peers: number[],\r\n  orderIndex?: number\r\n}>;\r\n\r\n// ! because 0 index is 'All Chats'\r\nconst START_ORDER_INDEX = 1;\r\n\r\nexport default class FiltersStorage {\r\n  public filters: {[filterId: string]: MyDialogFilter};\r\n  private orderIndex: number;\r\n\r\n  constructor(private appMessagesManager: AppMessagesManager,\r\n    private appPeersManager: AppPeersManager, \r\n    private appUsersManager: AppUsersManager, \r\n    private appNotificationsManager: AppNotificationsManager, \r\n    private appStateManager: AppStateManager,\r\n    private apiUpdatesManager: ApiUpdatesManager, \r\n    /* private apiManager: ApiManagerProxy, */ \r\n    private rootScope: typeof _rootScope) {\r\n    this.clear();\r\n\r\n    this.appStateManager.getState().then((state) => {\r\n      this.filters = state.filters;\r\n\r\n      for(const filterId in this.filters) {\r\n        const filter = this.filters[filterId];\r\n        if(filter.hasOwnProperty('orderIndex') && filter.orderIndex >= this.orderIndex) {\r\n          this.orderIndex = filter.orderIndex + 1;\r\n        }\r\n      }\r\n    });\r\n\r\n    rootScope.addMultipleEventsListeners({\r\n      updateDialogFilter: this.onUpdateDialogFilter,\r\n\r\n      updateDialogFilters: (update) => {\r\n        //console.warn('updateDialogFilters', update);\r\n\r\n        const oldFilters = copy(this.filters);\r\n\r\n        this.getDialogFilters(true).then(filters => {\r\n          for(const _filterId in oldFilters) {\r\n            const filterId = +_filterId;\r\n            if(!filters.find(filter => filter.id === filterId)) { // * deleted\r\n              this.onUpdateDialogFilter({_: 'updateDialogFilter', id: filterId});\r\n            }\r\n          }\r\n\r\n          this.onUpdateDialogFilterOrder({_: 'updateDialogFilterOrder', order: filters.map(filter => filter.id)});\r\n        });\r\n      },\r\n\r\n      updateDialogFilterOrder: this.onUpdateDialogFilterOrder\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    this.filters = {};\r\n    this.orderIndex = START_ORDER_INDEX;\r\n  }\r\n\r\n  private onUpdateDialogFilter = (update: Update.updateDialogFilter) => {\r\n    if(update.filter) {\r\n      this.saveDialogFilter(update.filter as any);\r\n    } else if(this.filters[update.id]) { // Папка удалена\r\n      //this.getDialogFilters(true);\r\n      this.rootScope.dispatchEvent('filter_delete', this.filters[update.id]);\r\n      delete this.filters[update.id];\r\n    }\r\n\r\n    this.appStateManager.pushToState('filters', this.filters);\r\n  };\r\n\r\n  private onUpdateDialogFilterOrder = (update: Update.updateDialogFilterOrder) => {\r\n    //console.log('updateDialogFilterOrder', update);\r\n\r\n    this.orderIndex = START_ORDER_INDEX;\r\n    update.order.forEach((filterId, idx) => {\r\n      const filter = this.filters[filterId];\r\n      delete filter.orderIndex;\r\n      this.setOrderIndex(filter);\r\n    });\r\n\r\n    this.rootScope.dispatchEvent('filter_order', update.order);\r\n\r\n    this.appStateManager.pushToState('filters', this.filters);\r\n  };\r\n\r\n  public testDialogForFilter(dialog: Dialog, filter: MyDialogFilter) {\r\n    // exclude_peers\r\n    for(const peerId of filter.exclude_peers) {\r\n      if(peerId === dialog.peerId) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // include_peers\r\n    for(const peerId of filter.include_peers) {\r\n      if(peerId === dialog.peerId) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    const pFlags = filter.pFlags;\r\n\r\n    // exclude_archived\r\n    if(pFlags.exclude_archived && dialog.folder_id === 1) {\r\n      return false;\r\n    }\r\n\r\n    // exclude_read\r\n    if(pFlags.exclude_read && !dialog.unread_count && !dialog.pFlags.unread_mark) {\r\n      return false;\r\n    }\r\n\r\n    // exclude_muted\r\n    if(pFlags.exclude_muted) {\r\n      const isMuted = this.appNotificationsManager.isPeerLocalMuted(dialog.peerId);\r\n      if(isMuted) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    const peerId = dialog.peerId;\r\n    if(peerId < 0) {\r\n      // broadcasts\r\n      if(pFlags.broadcasts && this.appPeersManager.isBroadcast(peerId)) {\r\n        return true;\r\n      }\r\n\r\n      // groups\r\n      if(pFlags.groups && this.appPeersManager.isAnyGroup(peerId)) {\r\n        return true;\r\n      }\r\n    } else {\r\n      // bots\r\n      if(this.appPeersManager.isBot(peerId)) {\r\n        return !!pFlags.bots;\r\n      }\r\n      \r\n      // non_contacts\r\n      if(pFlags.non_contacts && !this.appUsersManager.isContact(peerId)) {\r\n        return true;\r\n      }\r\n\r\n      // contacts\r\n      if(pFlags.contacts && this.appUsersManager.isContact(peerId)) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public toggleDialogPin(peerId: number, filterId: number) {\r\n    const filter = this.filters[filterId];\r\n\r\n    const wasPinned = filter.pinned_peers.findAndSplice(p => p === peerId);\r\n    if(!wasPinned) {\r\n      filter.pinned_peers.unshift(peerId);\r\n    }\r\n    \r\n    return this.updateDialogFilter(filter);\r\n  }\r\n\r\n  public createDialogFilter(filter: MyDialogFilter) {\r\n    let maxId = Math.max(1, ...Object.keys(this.filters).map(i => +i));\r\n    filter = copy(filter);\r\n    filter.id = maxId + 1;\r\n    return this.updateDialogFilter(filter);\r\n  }\r\n\r\n  public updateDialogFilter(filter: MyDialogFilter, remove = false) {\r\n    const flags = remove ? 0 : 1;\r\n\r\n    return apiManager.invokeApi('messages.updateDialogFilter', {\r\n      flags,\r\n      id: filter.id,\r\n      filter: remove ? undefined : this.getOutputDialogFilter(filter)\r\n    }).then((bool: boolean) => { // возможно нужна проверка и откат, если результат не ТРУ\r\n      //console.log('updateDialogFilter bool:', bool);\r\n\r\n      if(bool) {\r\n        /* if(!this.filters[filter.id]) {\r\n          this.saveDialogFilter(filter);\r\n        }\r\n\r\n        rootScope.$broadcast('filter_update', filter); */\r\n\r\n        this.onUpdateDialogFilter({\r\n          _: 'updateDialogFilter',\r\n          id: filter.id,\r\n          filter: remove ? undefined : filter as any\r\n        });\r\n      }\r\n\r\n      return bool;\r\n    });\r\n  }\r\n\r\n  public getOutputDialogFilter(filter: MyDialogFilter) {\r\n    const c: MyDialogFilter = copy(filter);\r\n    ['pinned_peers', 'exclude_peers', 'include_peers'].forEach(key => {\r\n      // @ts-ignore\r\n      c[key] = c[key].map((peerId: number) => this.appPeersManager.getInputPeerById(peerId));\r\n    });\r\n\r\n    forEachReverse(c.include_peers, (peerId, idx) => {\r\n      if(c.pinned_peers.includes(peerId)) {\r\n        c.include_peers.splice(idx, 1);\r\n      }\r\n    });\r\n\r\n    return c as any as DialogFilter;\r\n  }\r\n\r\n  public async getDialogFilters(overwrite = false): Promise<MyDialogFilter[]> {\r\n    const keys = Object.keys(this.filters);\r\n    if(keys.length && !overwrite) {\r\n      return keys.map(filterId => this.filters[filterId]).sort((a, b) => a.orderIndex - b.orderIndex);\r\n    }\r\n\r\n    const filters: MyDialogFilter[] = await apiManager.invokeApi('messages.getDialogFilters') as any;\r\n    for(const filter of filters) {\r\n      this.saveDialogFilter(filter, overwrite);\r\n    }\r\n\r\n    //console.log(this.filters);\r\n    return filters;\r\n  }\r\n\r\n  public saveDialogFilter(filter: MyDialogFilter, update = true) {\r\n    ['pinned_peers', 'exclude_peers', 'include_peers'].forEach(key => {\r\n      // @ts-ignore\r\n      filter[key] = filter[key].map((peer: any) => this.appPeersManager.getPeerId(peer));\r\n    });\r\n\r\n    forEachReverse(filter.include_peers, (peerId, idx) => {\r\n      if(filter.pinned_peers.includes(peerId)) {\r\n        filter.include_peers.splice(idx, 1);\r\n      }\r\n    });\r\n    \r\n    filter.include_peers = filter.pinned_peers.concat(filter.include_peers);\r\n\r\n    if(this.filters[filter.id]) {\r\n      Object.assign(this.filters[filter.id], filter);\r\n    } else {\r\n      this.filters[filter.id] = filter;\r\n    }\r\n\r\n    this.setOrderIndex(filter);\r\n\r\n    if(update) {\r\n      this.rootScope.dispatchEvent('filter_update', filter);\r\n    }\r\n  }\r\n\r\n  public setOrderIndex(filter: MyDialogFilter) {\r\n    if(filter.hasOwnProperty('orderIndex')) {\r\n      if(filter.orderIndex >= this.orderIndex) {\r\n        this.orderIndex = filter.orderIndex + 1;\r\n      }\r\n    } else {\r\n      filter.orderIndex = this.orderIndex++;\r\n    }\r\n\r\n    this.appStateManager.pushToState('filters', this.filters);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { i18n, join, LangPackKey } from \"../lib/langPack\";\r\nimport formatDuration, { DurationType } from \"./formatDuration\";\r\n\r\nconst CALL_DURATION_LANG_KEYS: {[type in DurationType]: LangPackKey} = {\r\n  s: 'Seconds',\r\n  m: 'Minutes',\r\n  h: 'Hours',\r\n  d: 'Days',\r\n  w: 'Weeks'\r\n};\r\nexport default function formatCallDuration(duration: number) {\r\n  const a = formatDuration(duration, 2);\r\n  const elements = a.map(d => i18n(CALL_DURATION_LANG_KEYS[d.type], [d.duration]));\r\n\r\n  const fragment = document.createElement('span');\r\n  fragment.append(...join(elements, false));\r\n\r\n  return fragment;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport type DurationType = 's' | 'm' | 'h' | 'd' | 'w';\r\nexport default function formatDuration(duration: number, showLast = 2) {\r\n  if(!duration) {\r\n    duration = 1;\r\n  }\r\n\r\n  let d: {duration: number, type: DurationType}[] = [];\r\n  const p = [\r\n    {m: 1, t: 's'},\r\n    {m: 60, t: 'm'}, \r\n    {m: 60, t: 'h'}, \r\n    {m: 24, t: 'd'}, \r\n    {m: 7, t: 'w'}\r\n  ] as Array<{m?: number, t: DurationType}>\r\n  const s = 1;\r\n  let t = s;\r\n  p.forEach((o, idx) => {\r\n    t *= o.m;\r\n\r\n    if(duration < t) {\r\n      return;\r\n    }\r\n\r\n    const modulus = p[idx === (p.length - 1) ? idx : idx + 1].m;\r\n    d.push({\r\n      duration: (duration / t % modulus | 0),\r\n      type: o.t\r\n    });\r\n  });\r\n\r\n  const out = d.slice(-showLast).reverse();\r\n  for(let i = out.length - 1; i >= 0; --i) {\r\n    if(out[i].duration === 0) {\r\n      out.splice(i, 1);\r\n    }\r\n  }\r\n  \r\n  return out;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { LazyLoadQueueBase } from \"../../components/lazyLoadQueue\";\r\nimport ProgressivePreloader from \"../../components/preloader\";\r\nimport { CancellablePromise, deferredPromise } from \"../../helpers/cancellablePromise\";\r\nimport { formatTime, tsNow } from \"../../helpers/date\";\r\nimport { createPosterForVideo } from \"../../helpers/files\";\r\nimport { copy, getObjectKeysAndSort } from \"../../helpers/object\";\r\nimport { randomLong } from \"../../helpers/random\";\r\nimport { splitStringByLength, limitSymbols, escapeRegExp } from \"../../helpers/string\";\r\nimport { Chat, ChatFull, Dialog as MTDialog, DialogPeer, DocumentAttribute, InputMedia, InputMessage, InputPeerNotifySettings, InputSingleMedia, Message, MessageAction, MessageEntity, MessageFwdHeader, MessageMedia, MessageReplies, MessageReplyHeader, MessagesDialogs, MessagesFilter, MessagesMessages, MethodDeclMap, NotifyPeer, PeerNotifySettings, PhotoSize, SendMessageAction, Update, Photo, Updates } from \"../../layer\";\r\nimport { InvokeApiOptions } from \"../../types\";\r\nimport I18n, { i18n, join, langPack, LangPackKey, _i18n } from \"../langPack\";\r\nimport { logger, LogTypes } from \"../logger\";\r\nimport type { ApiFileManager } from '../mtproto/apiFileManager';\r\n//import apiManager from '../mtproto/apiManager';\r\nimport apiManager from '../mtproto/mtprotoworker';\r\nimport referenceDatabase, { ReferenceContext } from \"../mtproto/referenceDatabase\";\r\nimport serverTimeManager from \"../mtproto/serverTimeManager\";\r\nimport { RichTextProcessor } from \"../richtextprocessor\";\r\nimport rootScope from \"../rootScope\";\r\nimport DialogsStorage from \"../storages/dialogs\";\r\nimport FiltersStorage from \"../storages/filters\";\r\n//import { telegramMeWebService } from \"../mtproto/mtproto\";\r\nimport apiUpdatesManager from \"./apiUpdatesManager\";\r\nimport appChatsManager from \"./appChatsManager\";\r\nimport appDocsManager, { MyDocument } from \"./appDocsManager\";\r\nimport appDownloadManager from \"./appDownloadManager\";\r\nimport appPeersManager from \"./appPeersManager\";\r\nimport appPhotosManager, { MyPhoto } from \"./appPhotosManager\";\r\nimport appPollsManager from \"./appPollsManager\";\r\nimport appStateManager from \"./appStateManager\";\r\nimport appUsersManager from \"./appUsersManager\";\r\nimport appWebPagesManager from \"./appWebPagesManager\";\r\nimport appDraftsManager from \"./appDraftsManager\";\r\nimport { getFileNameByLocation } from \"../../helpers/fileName\";\r\nimport appProfileManager from \"./appProfileManager\";\r\nimport DEBUG, { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport SlicedArray, { Slice, SliceEnd } from \"../../helpers/slicedArray\";\r\nimport appNotificationsManager, { NotifyOptions } from \"./appNotificationsManager\";\r\nimport PeerTitle from \"../../components/peerTitle\";\r\nimport { forEachReverse } from \"../../helpers/array\";\r\nimport htmlToDocumentFragment from \"../../helpers/dom/htmlToDocumentFragment\";\r\nimport htmlToSpan from \"../../helpers/dom/htmlToSpan\";\r\nimport { REPLIES_PEER_ID } from \"../mtproto/mtproto_config\";\r\nimport formatCallDuration from \"../../helpers/formatCallDuration\";\r\nimport appAvatarsManager from \"./appAvatarsManager\";\r\n\r\n//console.trace('include');\r\n// TODO: если удалить сообщение в непрогруженном диалоге, то при обновлении, из-за стейта, последнего сообщения в чатлисте не будет\r\n// TODO: если удалить диалог находясь в папке, то он не удалится из папки и будет виден в настройках\r\n\r\nconst APITIMEOUT = 0;\r\n\r\nexport type HistoryStorage = {\r\n  count: number | null,\r\n  history: SlicedArray,\r\n\r\n  maxId?: number,\r\n  readPromise?: Promise<void>,\r\n  readMaxId?: number,\r\n  readOutboxMaxId?: number,\r\n  triedToReadMaxId?: number,\r\n\r\n  maxOutId?: number,\r\n  reply_markup?: any\r\n};\r\n\r\nexport type HistoryResult = {\r\n  count: number,\r\n  history: Slice,\r\n  offsetIdOffset?: number,\r\n};\r\n\r\nexport type Dialog = MTDialog.dialog;\r\n\r\nexport type MyMessage = Message.message | Message.messageService;\r\nexport type MyInputMessagesFilter = 'inputMessagesFilterEmpty' \r\n  | 'inputMessagesFilterPhotos' \r\n  | 'inputMessagesFilterPhotoVideo' \r\n  | 'inputMessagesFilterVideo' \r\n  | 'inputMessagesFilterDocument' \r\n  | 'inputMessagesFilterVoice' \r\n  | 'inputMessagesFilterRoundVoice' \r\n  | 'inputMessagesFilterRoundVideo' \r\n  | 'inputMessagesFilterMusic' \r\n  | 'inputMessagesFilterUrl' \r\n  | 'inputMessagesFilterMyMentions'\r\n  | 'inputMessagesFilterChatPhotos'\r\n  | 'inputMessagesFilterPinned';\r\n\r\nexport type PinnedStorage = Partial<{\r\n  promise: Promise<PinnedStorage>,\r\n  count: number,\r\n  maxId: number\r\n}>;\r\nexport type MessagesStorage = {\r\n  //generateIndex: (message: any) => void\r\n  [mid: string]: any\r\n};\r\n\r\nexport type MyMessageActionType = Message.messageService['action']['_'];\r\n\r\nexport class AppMessagesManager {\r\n  private static MESSAGE_ID_INCREMENT = 0x10000;\r\n  private static MESSAGE_ID_OFFSET = 0xFFFFFFFF;\r\n\r\n  private messagesStorageByPeerId: {[peerId: string]: MessagesStorage};\r\n  public groupedMessagesStorage: {[groupId: string]: MessagesStorage}; // will be used for albums\r\n  private scheduledMessagesStorage: {[peerId: string]: MessagesStorage};\r\n  private historiesStorage: {\r\n    [peerId: string]: HistoryStorage\r\n  };\r\n  private threadsStorage: {\r\n    [peerId: string]: {\r\n      [threadId: string]: HistoryStorage\r\n    }\r\n  };\r\n  private searchesStorage: {\r\n    [peerId: string]: Partial<{\r\n      [inputFilter in MyInputMessagesFilter]: {\r\n        count?: number,\r\n        history: number[]\r\n      }\r\n    }>\r\n  };\r\n  public pinnedMessages: {[peerId: string]: PinnedStorage};\r\n\r\n  public threadsServiceMessagesIdsStorage: {[peerId_threadId: string]: number};\r\n  private threadsToReplies: {\r\n    [peerId_threadId: string]: string;\r\n  };\r\n\r\n  private pendingByRandomId: {\r\n    [randomId: string]: {\r\n      peerId: number,\r\n      tempId: number,\r\n      threadId: number,\r\n      storage: MessagesStorage\r\n    }\r\n  } = {};\r\n  private pendingByMessageId: {[mid: string]: string} = {};\r\n  private pendingAfterMsgs: any = {};\r\n  public pendingTopMsgs: {[peerId: string]: number} = {};\r\n  private tempNum = 0;\r\n  private tempFinalizeCallbacks: {\r\n    [tempId: string]: {\r\n      [callbackName: string]: Partial<{\r\n        deferred: CancellablePromise<void>, \r\n        callback: (message: any) => Promise<any>\r\n      }>\r\n    }\r\n  } = {};\r\n  \r\n  private sendSmthLazyLoadQueue = new LazyLoadQueueBase(1);\r\n\r\n  private needSingleMessages: {[peerId: string]: number[]} = {};\r\n  private fetchSingleMessagesPromise: Promise<void> = null;\r\n\r\n  private maxSeenId = 0;\r\n\r\n  public migratedFromTo: {[peerId: number]: number} = {};\r\n  public migratedToFrom: {[peerId: number]: number} = {};\r\n\r\n  private newMessagesHandleTimeout = 0;\r\n  private newMessagesToHandle: {[peerId: string]: Set<number>} = {};\r\n  private newDialogsHandlePromise: Promise<any>;\r\n  private newDialogsToHandle: {[peerId: string]: Dialog} = {};\r\n  public newUpdatesAfterReloadToHandle: {[peerId: string]: Set<Update>} = {};\r\n\r\n  private notificationsHandlePromise = 0;\r\n  private notificationsToHandle: {[peerId: string]: {\r\n    fwdCount: number,\r\n    fromId: number,\r\n    topMessage?: MyMessage\r\n  }} = {};\r\n\r\n  private reloadConversationsPromise: Promise<void>;\r\n  private reloadConversationsPeers: Set<number> = new Set();\r\n\r\n  public log = logger('MESSAGES', LogTypes.Error | LogTypes.Debug | LogTypes.Log | LogTypes.Warn);\r\n\r\n  public dialogsStorage: DialogsStorage;\r\n  public filtersStorage: FiltersStorage;\r\n\r\n  private groupedTempId = 0;\r\n\r\n  private typings: {[peerId: string]: {type: SendMessageAction['_'], timeout?: number}} = {};\r\n\r\n  constructor() {\r\n    this.clear();\r\n\r\n    rootScope.addMultipleEventsListeners({\r\n      updateMessageID: this.onUpdateMessageId,\r\n\r\n      updateNewDiscussionMessage: this.onUpdateNewMessage,\r\n      updateNewMessage: this.onUpdateNewMessage,\r\n      updateNewChannelMessage: this.onUpdateNewMessage,\r\n\r\n      updateDialogUnreadMark: this.onUpdateDialogUnreadMark,\r\n\r\n      updateEditMessage: this.onUpdateEditMessage,\r\n      updateEditChannelMessage: this.onUpdateEditMessage,\r\n\r\n      updateReadChannelDiscussionInbox: this.onUpdateReadHistory,\r\n      updateReadChannelDiscussionOutbox: this.onUpdateReadHistory,\r\n      updateReadHistoryInbox: this.onUpdateReadHistory,\r\n      updateReadHistoryOutbox: this.onUpdateReadHistory,\r\n      updateReadChannelInbox: this.onUpdateReadHistory,\r\n      updateReadChannelOutbox: this.onUpdateReadHistory,\r\n\r\n      updateChannelReadMessagesContents: this.onUpdateReadMessagesContents,\r\n      updateReadMessagesContents: this.onUpdateReadMessagesContents,\r\n\r\n      updateChannelAvailableMessages: this.onUpdateChannelAvailableMessages,\r\n\r\n      updateDeleteMessages: this.onUpdateDeleteMessages,\r\n      updateDeleteChannelMessages: this.onUpdateDeleteMessages,\r\n\r\n      updateChannel: this.onUpdateChannel,\r\n\r\n      // @ts-ignore\r\n      updateChannelReload: this.onUpdateChannelReload,\r\n\r\n      updateChannelMessageViews: this.onUpdateChannelMessageViews,\r\n\r\n      updateServiceNotification: this.onUpdateServiceNotification,\r\n\r\n      updatePinnedMessages: this.onUpdatePinnedMessages,\r\n      updatePinnedChannelMessages: this.onUpdatePinnedMessages,\r\n\r\n      updateNotifySettings: this.onUpdateNotifySettings,\r\n\r\n      updateNewScheduledMessage: this.onUpdateNewScheduledMessage,\r\n\r\n      updateDeleteScheduledMessages: this.onUpdateDeleteScheduledMessages\r\n    });\r\n\r\n    // ! Invalidate notify settings, can optimize though\r\n    rootScope.addEventListener('notify_peer_type_settings', ({key, settings}) => {\r\n      this.getConversationsAll().then(dialogs => {\r\n        let filterFunc: (dialog: Dialog) => boolean;\r\n        if(key === 'notifyUsers') filterFunc = (dialog) => dialog.peerId > 0;\r\n        else if(key === 'notifyBroadcasts') filterFunc = (dialog) => appChatsManager.isBroadcast(-dialog.peerId);\r\n        else filterFunc = (dialog) => appPeersManager.isAnyGroup(dialog.peerId);\r\n\r\n        dialogs\r\n        .filter(filterFunc)\r\n        .forEach(dialog => {\r\n          rootScope.dispatchEvent('dialog_notify_settings', dialog);\r\n        });\r\n      });\r\n    });\r\n\r\n    rootScope.addEventListener('webpage_updated', (e) => {\r\n      const eventData = e;\r\n      eventData.msgs.forEach((mid) => {\r\n        const message = this.getMessageById(mid) as Message.message;\r\n        if(!message) return;\r\n        message.media = {\r\n          _: 'messageMediaWebPage', \r\n          webpage: appWebPagesManager.getWebPage(eventData.id)\r\n        };\r\n\r\n        const peerId = this.getMessagePeer(message);\r\n        const storage = this.getMessagesStorage(peerId);\r\n        rootScope.dispatchEvent('message_edit', {\r\n          storage,\r\n          peerId,\r\n          mid\r\n        });\r\n      });\r\n    });\r\n\r\n    rootScope.addEventListener('draft_updated', (e) => {\r\n      const {peerId, threadId, draft} = e;\r\n\r\n      if(threadId) return;\r\n\r\n      const dialog = this.getDialogOnly(peerId);\r\n      if(dialog && !threadId) {\r\n        dialog.draft = draft;\r\n        this.dialogsStorage.generateIndexForDialog(dialog);\r\n        this.dialogsStorage.pushDialog(dialog);\r\n\r\n        rootScope.dispatchEvent('dialog_draft', {\r\n          peerId,\r\n          draft,\r\n          index: dialog.index\r\n        });\r\n      } else {\r\n        this.reloadConversation(peerId);\r\n      }\r\n    });\r\n    \r\n    appStateManager.getState().then(state => {\r\n      if(state.maxSeenMsgId) {\r\n        this.maxSeenId = state.maxSeenMsgId;\r\n      }\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    this.messagesStorageByPeerId = {};\r\n    this.groupedMessagesStorage = {};\r\n    this.scheduledMessagesStorage = {};\r\n    this.historiesStorage = {};\r\n    this.threadsStorage = {};\r\n    this.searchesStorage = {};\r\n    this.pinnedMessages = {};\r\n    this.threadsServiceMessagesIdsStorage = {};\r\n    this.threadsToReplies = {};\r\n\r\n    this.dialogsStorage && this.dialogsStorage.clear();\r\n    this.filtersStorage && this.filtersStorage.clear();\r\n  }\r\n\r\n  public construct() {\r\n    this.filtersStorage = new FiltersStorage(this, appPeersManager, appUsersManager, appNotificationsManager, appStateManager, apiUpdatesManager, /* apiManager, */ rootScope);\r\n    this.dialogsStorage = new DialogsStorage(this, appChatsManager, appPeersManager, appUsersManager, appDraftsManager, appNotificationsManager, appStateManager, apiUpdatesManager, serverTimeManager);\r\n  }\r\n\r\n  public getInputEntities(entities: MessageEntity[]) {\r\n    const sendEntites = copy(entities);\r\n    sendEntites.forEach((entity) => {\r\n      if(entity._ === 'messageEntityMentionName') {\r\n        (entity as any as MessageEntity.inputMessageEntityMentionName)._ = 'inputMessageEntityMentionName';\r\n        (entity as any as MessageEntity.inputMessageEntityMentionName).user_id = appUsersManager.getUserInput(entity.user_id);\r\n      }\r\n    });\r\n    return sendEntites;\r\n  }\r\n\r\n  public invokeAfterMessageIsSent(tempId: number, callbackName: string, callback: (message: any) => Promise<any>) {\r\n    const finalize = this.tempFinalizeCallbacks[tempId] ?? (this.tempFinalizeCallbacks[tempId] = {});\r\n    const obj = finalize[callbackName] ?? (finalize[callbackName] = {deferred: deferredPromise<void>()});\r\n\r\n    obj.callback = callback;\r\n\r\n    return obj.deferred;\r\n  }\r\n\r\n  public editMessage(message: any, text: string, options: Partial<{\r\n    noWebPage: true,\r\n    newMedia: any,\r\n    scheduleDate: number,\r\n    entities: MessageEntity[]\r\n  }> = {}): Promise<void> {\r\n    /* if(!this.canEditMessage(messageId)) {\r\n      return Promise.reject({type: 'MESSAGE_EDIT_FORBIDDEN'});\r\n    } */\r\n\r\n    const {mid, peerId} = message;\r\n\r\n    if(message.pFlags.is_outgoing) {\r\n      return this.invokeAfterMessageIsSent(mid, 'edit', (message) => {\r\n        //this.log('invoke editMessage callback', message);\r\n        return this.editMessage(message, text, options);\r\n      });\r\n    }\r\n\r\n    let entities = options.entities || [];\r\n    if(text) {\r\n      text = RichTextProcessor.parseMarkdown(text, entities);\r\n    }\r\n\r\n    const schedule_date = options.scheduleDate || (message.pFlags.is_scheduled ? message.date : undefined);\r\n    return apiManager.invokeApi('messages.editMessage', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      id: message.id,\r\n      message: text,\r\n      media: options.newMedia,\r\n      entities: entities.length ? this.getInputEntities(entities) : undefined,\r\n      no_webpage: options.noWebPage,\r\n      schedule_date\r\n    }).then((updates) => {\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n    }, (error) => {\r\n      this.log.error('editMessage error:', error);\r\n      \r\n      if(error && error.type === 'MESSAGE_NOT_MODIFIED') {\r\n        error.handled = true;\r\n        return;\r\n      }\r\n      if(error && error.type === 'MESSAGE_EMPTY') {\r\n        error.handled = true;\r\n      }\r\n      return Promise.reject(error);\r\n    });\r\n  }\r\n\r\n  public sendText(peerId: number, text: string, options: Partial<{\r\n    entities: any[],\r\n    replyToMsgId: number,\r\n    threadId: number,\r\n    viaBotId: number,\r\n    queryId: string,\r\n    resultId: string,\r\n    noWebPage: true,\r\n    reply_markup: any,\r\n    clearDraft: true,\r\n    webPage: any,\r\n    scheduleDate: number,\r\n    silent: true\r\n  }> = {}) {\r\n    if(typeof(text) !== 'string' || !text.length) {\r\n      return;\r\n    }\r\n\r\n    //this.checkSendOptions(options);\r\n\r\n    if(options.threadId && !options.replyToMsgId) {\r\n      options.replyToMsgId = options.threadId;\r\n    }\r\n\r\n    const MAX_LENGTH = 4096;\r\n    if(text.length > MAX_LENGTH) {\r\n      const splitted = splitStringByLength(text, MAX_LENGTH);\r\n      text = splitted[0];\r\n\r\n      if(splitted.length > 1) {\r\n        delete options.webPage;\r\n      }\r\n\r\n      for(let i = 1; i < splitted.length; ++i) {\r\n        setTimeout(() => {\r\n          this.sendText(peerId, splitted[i], options);\r\n        }, i);\r\n      }\r\n    }\r\n\r\n    peerId = appPeersManager.getPeerMigratedTo(peerId) || peerId;\r\n\r\n    let entities = options.entities || [];\r\n    if(!options.viaBotId) {\r\n      text = RichTextProcessor.parseMarkdown(text, entities);\r\n      //entities = RichTextProcessor.mergeEntities(entities, RichTextProcessor.parseEntities(text));\r\n    }\r\n\r\n    let sendEntites = this.getInputEntities(entities);\r\n    if(!sendEntites.length) {\r\n      sendEntites = undefined;\r\n    }\r\n\r\n    const message = this.generateOutgoingMessage(peerId, options);\r\n    message.entities = entities;\r\n    message.message = text;\r\n\r\n    const replyToMsgId = options.replyToMsgId ? this.getServerMessageId(options.replyToMsgId) : undefined;\r\n    const isChannel = appPeersManager.isChannel(peerId);\r\n\r\n    if(options.webPage) {\r\n      message.media = {\r\n        _: 'messageMediaWebPage',\r\n        webpage: options.webPage\r\n      };\r\n    }\r\n\r\n    const toggleError = (on: any) => {\r\n      if(on) {\r\n        message.error = true;\r\n      } else {\r\n        delete message.error;\r\n      }\r\n      rootScope.dispatchEvent('messages_pending');\r\n    };\r\n\r\n    message.send = () => {\r\n      toggleError(false);\r\n      const sentRequestOptions: InvokeApiOptions = {};\r\n      if(this.pendingAfterMsgs[peerId]) {\r\n        sentRequestOptions.afterMessageId = this.pendingAfterMsgs[peerId].messageId;\r\n      }\r\n\r\n      let apiPromise: any;\r\n      if(options.viaBotId) {\r\n        apiPromise = apiManager.invokeApiAfter('messages.sendInlineBotResult', {\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          random_id: message.random_id,\r\n          reply_to_msg_id: replyToMsgId || undefined,\r\n          query_id: options.queryId,\r\n          id: options.resultId,\r\n          clear_draft: options.clearDraft\r\n        }, sentRequestOptions);\r\n      } else {\r\n        apiPromise = apiManager.invokeApiAfter('messages.sendMessage', {\r\n          no_webpage: options.noWebPage,\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          message: text,\r\n          random_id: message.random_id,\r\n          reply_to_msg_id: replyToMsgId || undefined,\r\n          entities: sendEntites,\r\n          clear_draft: options.clearDraft,\r\n          schedule_date: options.scheduleDate || undefined,\r\n          silent: options.silent\r\n        }, sentRequestOptions);\r\n      }\r\n\r\n      /* function is<T>(value: any, condition: boolean): value is T {\r\n        return condition;\r\n      } */\r\n\r\n      //this.log('sendText', message.mid);\r\n      apiPromise.then((updates: Updates) => {\r\n        //this.log('sendText sent', message.mid);\r\n        //if(is<Updates.updateShortSentMessage>(updates, updates._ === 'updateShortSentMessage')) {\r\n        if(updates._ === 'updateShortSentMessage') {\r\n          //assumeType<Updates.updateShortSentMessage>(updates);\r\n          message.date = updates.date;\r\n          message.id = updates.id;\r\n          message.media = updates.media;\r\n          message.entities = updates.entities;\r\n          this.wrapMessageEntities(message);\r\n          if(updates.pFlags.out) {\r\n            message.pFlags.out = true;\r\n          }\r\n\r\n          // * override with new updates\r\n          updates = {\r\n            _: 'updates',\r\n            users: [],\r\n            chats: [],\r\n            seq: 0,\r\n            updates: [{\r\n              _: 'updateMessageID',\r\n              random_id: message.random_id,\r\n              id: updates.id\r\n            }, {\r\n              _: options.scheduleDate ? 'updateNewScheduledMessage' : (isChannel ? 'updateNewChannelMessage' : 'updateNewMessage'),\r\n              message: message,\r\n              pts: updates.pts,\r\n              pts_count: updates.pts_count\r\n            }]\r\n          } as any;\r\n        } else if((updates as Updates.updates).updates) {\r\n          (updates as Updates.updates).updates.forEach((update) => {\r\n            if(update._ === 'updateDraftMessage') {\r\n              update.local = true;\r\n            }\r\n          });\r\n        }\r\n        // Testing bad situations\r\n        // var upd = angular.copy(updates)\r\n        // updates.updates.splice(0, 1)\r\n\r\n        apiUpdatesManager.processUpdateMessage(updates);\r\n\r\n        // $timeout(function () {\r\n        // ApiUpdatesManager.processUpdateMessage(upd)\r\n        // }, 5000)\r\n      }, (/* error: any */) => {\r\n        toggleError(true);\r\n      }).finally(() => {\r\n        if(this.pendingAfterMsgs[peerId] === sentRequestOptions) {\r\n          delete this.pendingAfterMsgs[peerId];\r\n        }\r\n      });\r\n\r\n      this.pendingAfterMsgs[peerId] = sentRequestOptions;\r\n    }\r\n\r\n    this.beforeMessageSending(message, {\r\n      isScheduled: !!options.scheduleDate || undefined, \r\n      threadId: options.threadId,\r\n      clearDraft: options.clearDraft\r\n    });\r\n  }\r\n\r\n  public sendFile(peerId: number, file: File | Blob | MyDocument, options: Partial<{\r\n    isRoundMessage: true,\r\n    isVoiceMessage: true,\r\n    isGroupedItem: true,\r\n    isMedia: true,\r\n\r\n    replyToMsgId: number,\r\n    threadId: number,\r\n    groupId: string,\r\n    caption: string,\r\n    entities: MessageEntity[],\r\n    width: number,\r\n    height: number,\r\n    objectURL: string,\r\n    thumbBlob: Blob,\r\n    thumbURL: string,\r\n    duration: number,\r\n    background: true,\r\n    silent: true,\r\n    clearDraft: true,\r\n    scheduleDate: number,\r\n\r\n    waveform: Uint8Array,\r\n  }> = {}) {\r\n    peerId = appPeersManager.getPeerMigratedTo(peerId) || peerId;\r\n\r\n    //this.checkSendOptions(options);\r\n\r\n    const message = this.generateOutgoingMessage(peerId, options);\r\n    const replyToMsgId = options.replyToMsgId ? this.getServerMessageId(options.replyToMsgId) : undefined;\r\n\r\n    let attachType: string, apiFileName: string;\r\n\r\n    const fileType = 'mime_type' in file ? file.mime_type : file.type;\r\n    const fileName = file instanceof File ? file.name : '';\r\n    const isDocument = !(file instanceof File) && !(file instanceof Blob);\r\n    let caption = options.caption || '';\r\n\r\n    this.log('sendFile', file, fileType);\r\n\r\n    const entities = options.entities || [];\r\n    if(caption) {\r\n      caption = RichTextProcessor.parseMarkdown(caption, entities);\r\n    }\r\n\r\n    const attributes: DocumentAttribute[] = [];\r\n\r\n    const isPhoto = ['image/jpeg', 'image/png', 'image/bmp'].indexOf(fileType) >= 0;\r\n\r\n    let photo: MyPhoto, document: MyDocument;\r\n\r\n    let actionName: SendMessageAction['_'];\r\n    if(isDocument) { // maybe it's a sticker or gif\r\n      attachType = 'document';\r\n      apiFileName = '';\r\n    } else if(fileType.indexOf('audio/') === 0 || ['video/ogg'].indexOf(fileType) >= 0) {\r\n      attachType = 'audio';\r\n      apiFileName = 'audio.' + (fileType.split('/')[1] === 'ogg' ? 'ogg' : 'mp3');\r\n      actionName = 'sendMessageUploadAudioAction';\r\n\r\n      if(options.isVoiceMessage) {\r\n        attachType = 'voice';\r\n        message.pFlags.media_unread = true;\r\n      }\r\n\r\n      let attribute: DocumentAttribute.documentAttributeAudio = {\r\n        _: 'documentAttributeAudio',\r\n        pFlags: {\r\n          voice: options.isVoiceMessage\r\n        },\r\n        waveform: options.waveform,\r\n        duration: options.duration || 0\r\n      };\r\n\r\n      attributes.push(attribute);\r\n    } else if(!options.isMedia) {\r\n      attachType = 'document';\r\n      apiFileName = 'document.' + fileType.split('/')[1];\r\n      actionName = 'sendMessageUploadDocumentAction';\r\n    } else if(isPhoto) {\r\n      attachType = 'photo';\r\n      apiFileName = 'photo.' + fileType.split('/')[1];\r\n      actionName = 'sendMessageUploadPhotoAction';\r\n\r\n      const photoSize = {\r\n        _: 'photoSize',\r\n        w: options.width,\r\n        h: options.height,\r\n        type: 'full',\r\n        location: null,\r\n        size: file.size\r\n      } as PhotoSize.photoSize;\r\n\r\n      photo = {\r\n        _: 'photo',\r\n        id: '' + message.id,\r\n        sizes: [photoSize],\r\n        w: options.width,\r\n        h: options.height\r\n      } as any;\r\n\r\n      const cacheContext = appDownloadManager.getCacheContext(photo, photoSize.type);\r\n      cacheContext.downloaded = file.size;\r\n      cacheContext.url = options.objectURL || '';\r\n      \r\n      photo = appPhotosManager.savePhoto(photo);\r\n    } else if(fileType.indexOf('video/') === 0) {\r\n      attachType = 'video';\r\n      apiFileName = 'video.mp4';\r\n      actionName = 'sendMessageUploadVideoAction';\r\n\r\n      let videoAttribute: DocumentAttribute.documentAttributeVideo = {\r\n        _: 'documentAttributeVideo',\r\n        pFlags: {\r\n          round_message: options.isRoundMessage\r\n        }, \r\n        duration: options.duration,\r\n        w: options.width,\r\n        h: options.height\r\n      };\r\n\r\n      attributes.push(videoAttribute);\r\n    } else {\r\n      attachType = 'document';\r\n      apiFileName = 'document.' + fileType.split('/')[1];\r\n      actionName = 'sendMessageUploadDocumentAction';\r\n    }\r\n\r\n    attributes.push({_: 'documentAttributeFilename', file_name: fileName || apiFileName});\r\n\r\n    if(['document', 'video', 'audio', 'voice'].indexOf(attachType) !== -1 && !isDocument) {\r\n      const thumbs: PhotoSize[] = [];\r\n      document = {\r\n        _: 'document',\r\n        id: '' + message.id,\r\n        duration: options.duration,\r\n        attributes,\r\n        w: options.width,\r\n        h: options.height,\r\n        thumbs,\r\n        mime_type: fileType,\r\n        size: file.size\r\n      } as any;\r\n\r\n      const cacheContext = appDownloadManager.getCacheContext(document);\r\n      cacheContext.downloaded = file.size;\r\n      cacheContext.url = options.objectURL || '';\r\n\r\n      let thumb: PhotoSize.photoSize;\r\n      if(isPhoto) {\r\n        attributes.push({\r\n          _: 'documentAttributeImageSize',\r\n          w: options.width,\r\n          h: options.height\r\n        });\r\n\r\n        thumb = {\r\n          _: 'photoSize',\r\n          w: options.width,\r\n          h: options.height,\r\n          type: 'full',\r\n          size: file.size\r\n        };\r\n      } else if(attachType === 'video') {\r\n        if(options.thumbURL) {\r\n          thumb = {\r\n            _: 'photoSize',\r\n            w: options.width,\r\n            h: options.height,\r\n            type: 'full',\r\n            size: options.thumbBlob.size\r\n          };\r\n\r\n          const thumbCacheContext = appDownloadManager.getCacheContext(document, thumb.type);\r\n          thumbCacheContext.downloaded = thumb.size;\r\n          thumbCacheContext.url = options.thumbURL;\r\n        }\r\n      }\r\n\r\n      if(thumb) {\r\n        thumbs.push(thumb);\r\n      }\r\n\r\n      /* if(thumbs.length) {\r\n        const thumb = thumbs[0] as PhotoSize.photoSize;\r\n        const docThumb = appPhotosManager.getDocumentCachedThumb(document.id);\r\n        docThumb.downloaded = thumb.size;\r\n        docThumb.url = thumb.url;\r\n      } */\r\n      \r\n      document = appDocsManager.saveDoc(document);\r\n    }\r\n\r\n    this.log('sendFile', attachType, apiFileName, file.type, options);\r\n\r\n    const preloader = isDocument ? undefined : new ProgressivePreloader({\r\n      attachMethod: 'prepend',\r\n      tryAgainOnFail: false,\r\n      isUpload: true\r\n    });\r\n\r\n    const sentDeferred = deferredPromise<InputMedia>();\r\n\r\n    if(preloader) {\r\n      preloader.attachPromise(sentDeferred);\r\n      sentDeferred.cancel = () => {\r\n        const error = new Error('Download canceled');\r\n        error.name = 'AbortError';\r\n        sentDeferred.reject(error);\r\n      };\r\n\r\n      sentDeferred.catch(err => {\r\n        if(err.name === 'AbortError' && !uploaded) {\r\n          this.log('cancelling upload', media);\r\n\r\n          sentDeferred.reject(err);\r\n          this.cancelPendingMessage(message.random_id);\r\n          this.setTyping(peerId, {_: 'sendMessageCancelAction'});\r\n\r\n          if(uploadPromise?.cancel) {\r\n            uploadPromise.cancel();\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    const media = isDocument ? undefined : {\r\n      _: photo ? 'messageMediaPhoto' : 'messageMediaDocument',\r\n      pFlags: {},\r\n      preloader,\r\n      photo,\r\n      document,\r\n      promise: sentDeferred\r\n    };\r\n\r\n    message.entities = entities;\r\n    message.message = caption;\r\n    message.media = isDocument ? {\r\n      _: 'messageMediaDocument',\r\n      pFlags: {},\r\n      document: file \r\n    } : media;\r\n\r\n    const toggleError = (on: boolean) => {\r\n      if(on) {\r\n        message.error = true;\r\n      } else {\r\n        delete message.error;\r\n      }\r\n\r\n      rootScope.dispatchEvent('messages_pending');\r\n    };\r\n\r\n    let uploaded = false,\r\n      uploadPromise: ReturnType<ApiFileManager['uploadFile']> = null;\r\n\r\n    message.send = () => {\r\n      if(isDocument) {\r\n        const {id, access_hash, file_reference} = file as MyDocument;\r\n\r\n        const inputMedia: InputMedia = {\r\n          _: 'inputMediaDocument',\r\n          id: {\r\n            _: 'inputDocument',\r\n            id,\r\n            access_hash,\r\n            file_reference\r\n          }\r\n        };\r\n        \r\n        sentDeferred.resolve(inputMedia);\r\n      } else if(file instanceof File || file instanceof Blob) {\r\n        const load = () => {\r\n          if(!uploaded || message.error) {\r\n            uploaded = false;\r\n            uploadPromise = appDownloadManager.upload(file);\r\n            sentDeferred.notifyAll({done: 0, total: file.size});\r\n          }\r\n\r\n          let thumbUploadPromise: typeof uploadPromise;\r\n          if(attachType === 'video' && options.objectURL) {\r\n            thumbUploadPromise = new Promise((resolve, reject) => {\r\n              const blobPromise = options.thumbBlob ? Promise.resolve(options.thumbBlob) : createPosterForVideo(options.objectURL);\r\n              blobPromise.then(blob => {\r\n                if(!blob) {\r\n                  resolve(null);\r\n                } else {\r\n                  appDownloadManager.upload(blob).then(resolve, reject);\r\n                }\r\n              }, reject);\r\n            });\r\n          }\r\n  \r\n          uploadPromise && uploadPromise.then(async(inputFile) => {\r\n            /* if(DEBUG) {\r\n              this.log('appMessagesManager: sendFile uploaded:', inputFile);\r\n            } */\r\n\r\n            delete message.media.preloader;\r\n\r\n            inputFile.name = apiFileName;\r\n            uploaded = true;\r\n            let inputMedia: InputMedia;\r\n            switch(attachType) {\r\n              case 'photo':\r\n                inputMedia = {\r\n                  _: 'inputMediaUploadedPhoto', \r\n                  file: inputFile\r\n                };\r\n                break;\r\n\r\n              default:\r\n                inputMedia = {\r\n                  _: 'inputMediaUploadedDocument', \r\n                  file: inputFile, \r\n                  mime_type: fileType, \r\n                  attributes\r\n                };\r\n            }\r\n\r\n            if(thumbUploadPromise) {\r\n              try {\r\n                const inputFile = await thumbUploadPromise;\r\n                (inputMedia as InputMedia.inputMediaUploadedDocument).thumb = inputFile;\r\n              } catch(err) {\r\n                this.log.error('sendFile thumb upload error:', err);\r\n              }\r\n            }\r\n            \r\n            sentDeferred.resolve(inputMedia);\r\n          }, (/* error */) => {\r\n            toggleError(true);\r\n          });\r\n  \r\n          uploadPromise.addNotifyListener((progress: {done: number, total: number}) => {\r\n            /* if(DEBUG) {\r\n              this.log('upload progress', progress);\r\n            } */\r\n\r\n            const percents = Math.max(1, Math.floor(100 * progress.done / progress.total));\r\n            if(actionName) {\r\n              this.setTyping(peerId, {_: actionName, progress: percents | 0});\r\n            }\r\n            sentDeferred.notifyAll(progress);\r\n          });\r\n\r\n          return sentDeferred;\r\n        };\r\n\r\n        if(options.isGroupedItem) {\r\n          load();\r\n        } else {\r\n          this.sendSmthLazyLoadQueue.push({\r\n            load\r\n          });\r\n        }\r\n      }\r\n\r\n      return sentDeferred;\r\n    };\r\n\r\n    this.beforeMessageSending(message, {\r\n      isGroupedItem: options.isGroupedItem, \r\n      isScheduled: !!options.scheduleDate || undefined, \r\n      threadId: options.threadId,\r\n      clearDraft: options.clearDraft\r\n    });\r\n\r\n    if(!options.isGroupedItem) {\r\n      sentDeferred.then(inputMedia => {\r\n        this.setTyping(peerId, {_: 'sendMessageCancelAction'});\r\n\r\n        return apiManager.invokeApi('messages.sendMedia', {\r\n          background: options.background,\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          media: inputMedia,\r\n          message: caption,\r\n          random_id: message.random_id,\r\n          reply_to_msg_id: replyToMsgId,\r\n          schedule_date: options.scheduleDate,\r\n          silent: options.silent,\r\n          entities,\r\n          clear_draft: options.clearDraft\r\n        }).then((updates) => {\r\n          apiUpdatesManager.processUpdateMessage(updates);\r\n        }, (error) => {\r\n          if(attachType === 'photo' &&\r\n            error.code === 400 &&\r\n            (error.type === 'PHOTO_INVALID_DIMENSIONS' ||\r\n            error.type === 'PHOTO_SAVE_FILE_INVALID')) {\r\n            error.handled = true;\r\n            attachType = 'document';\r\n            message.send();\r\n            return;\r\n          }\r\n\r\n          toggleError(true);\r\n        });\r\n      });\r\n    }\r\n\r\n    return {message, promise: sentDeferred};\r\n  }\r\n\r\n  public async sendAlbum(peerId: number, files: File[], options: Partial<{\r\n    isMedia: true,\r\n    entities: MessageEntity[],\r\n    replyToMsgId: number,\r\n    threadId: number,\r\n    caption: string,\r\n    sendFileDetails: Partial<{\r\n      duration: number,\r\n      width: number,\r\n      height: number,\r\n      objectURL: string,\r\n      thumbBlob: Blob,\r\n      thumbURL: string\r\n    }>[],\r\n    silent: true,\r\n    clearDraft: true,\r\n    scheduleDate: number\r\n  }> = {}) {\r\n    //this.checkSendOptions(options);\r\n\r\n    if(options.threadId && !options.replyToMsgId) {\r\n      options.replyToMsgId = options.threadId;\r\n    }\r\n\r\n    if(files.length === 1) {\r\n      return this.sendFile(peerId, files[0], {...options, ...options.sendFileDetails[0]});\r\n    }\r\n\r\n    peerId = appPeersManager.getPeerMigratedTo(peerId) || peerId;\r\n    const replyToMsgId = options.replyToMsgId ? this.getServerMessageId(options.replyToMsgId) : undefined;\r\n\r\n    let caption = options.caption || '';\r\n    let entities = options.entities || [];\r\n    if(caption) {\r\n      caption = RichTextProcessor.parseMarkdown(caption, entities);\r\n    }\r\n\r\n    this.log('sendAlbum', files, options);\r\n\r\n    const groupId = '' + ++this.groupedTempId;\r\n\r\n    const messages = files.map((file, idx) => {\r\n      const details = options.sendFileDetails[idx];\r\n      const o: any = {\r\n        isGroupedItem: true,\r\n        isMedia: options.isMedia,\r\n        scheduleDate: options.scheduleDate,\r\n        silent: options.silent,\r\n        replyToMsgId,\r\n        threadId: options.threadId,\r\n        groupId,\r\n        ...details\r\n      };\r\n\r\n      if(idx === 0) {\r\n        o.caption = caption;\r\n        o.entities = entities;\r\n        //o.replyToMsgId = replyToMsgId;\r\n      }\r\n\r\n      return this.sendFile(peerId, file, o).message;\r\n    });\r\n\r\n    if(options.threadId) {\r\n      appDraftsManager.syncDraft(peerId, options.threadId);\r\n    } else {\r\n      appDraftsManager.saveDraft(peerId, options.threadId, null, {notify: true});  \r\n    }\r\n    \r\n    // * test pending\r\n    //return;\r\n\r\n    const toggleError = (message: any, on: boolean) => {\r\n      if(on) {\r\n        message.error = true;\r\n      } else {\r\n        delete message.error;\r\n      }\r\n\r\n      rootScope.dispatchEvent('messages_pending');\r\n    };\r\n\r\n    const inputPeer = appPeersManager.getInputPeerById(peerId);\r\n    const invoke = (multiMedia: any[]) => {\r\n      this.setTyping(peerId, {_: 'sendMessageCancelAction'});\r\n\r\n      this.sendSmthLazyLoadQueue.push({\r\n        load: () => {\r\n          return apiManager.invokeApi('messages.sendMultiMedia', {\r\n            peer: inputPeer,\r\n            multi_media: multiMedia,\r\n            reply_to_msg_id: replyToMsgId,\r\n            schedule_date: options.scheduleDate,\r\n            silent: options.silent,\r\n            clear_draft: options.clearDraft\r\n          }).then((updates) => {\r\n            apiUpdatesManager.processUpdateMessage(updates);\r\n          }, (error) => {\r\n            messages.forEach(message => toggleError(message, true));\r\n          });\r\n        }\r\n      });\r\n    };\r\n\r\n    const promises: Promise<InputSingleMedia>[] = messages.map((message, idx) => {\r\n      return (message.send() as Promise<InputMedia>).then((inputMedia: InputMedia) => {\r\n        return apiManager.invokeApi('messages.uploadMedia', {\r\n          peer: inputPeer,\r\n          media: inputMedia\r\n        });\r\n      })\r\n      .then(messageMedia => {\r\n        let inputMedia: any;\r\n        if(messageMedia._ === 'messageMediaPhoto') {\r\n          const photo = appPhotosManager.savePhoto(messageMedia.photo);\r\n          inputMedia = appPhotosManager.getInput(photo);\r\n        } else if(messageMedia._ === 'messageMediaDocument') {\r\n          const doc = appDocsManager.saveDoc(messageMedia.document);\r\n          inputMedia = appDocsManager.getMediaInput(doc);\r\n        }\r\n\r\n        const inputSingleMedia: InputSingleMedia = {\r\n          _: 'inputSingleMedia',\r\n          media: inputMedia,\r\n          random_id: message.random_id,\r\n          message: caption,\r\n          entities\r\n        };\r\n\r\n        // * only 1 caption for all inputs\r\n        if(caption) {\r\n          caption = '';\r\n          entities = [];\r\n        }\r\n\r\n        return inputSingleMedia;\r\n      }).catch((err: any) => {\r\n        if(err.name === 'AbortError') {\r\n          return null;\r\n        }\r\n\r\n        this.log.error('sendAlbum upload item error:', err, message);\r\n        toggleError(message, true);\r\n        throw err;\r\n      });\r\n    });\r\n\r\n    Promise.all(promises).then(inputs => {\r\n      invoke(inputs.filter(Boolean));\r\n    });\r\n  }\r\n\r\n  public sendOther(peerId: number, inputMedia: any, options: Partial<{\r\n    replyToMsgId: number,\r\n    threadId: number,\r\n    viaBotId: number,\r\n    reply_markup: any,\r\n    clearDraft: true,\r\n    queryId: string\r\n    resultId: string,\r\n    scheduleDate: number,\r\n    silent: true\r\n  }> = {}) {\r\n    peerId = appPeersManager.getPeerMigratedTo(peerId) || peerId;\r\n\r\n    //this.checkSendOptions(options);\r\n    const message = this.generateOutgoingMessage(peerId, options);\r\n    const replyToMsgId = options.replyToMsgId ? this.getServerMessageId(options.replyToMsgId) : undefined;\r\n\r\n    let media;\r\n    switch(inputMedia._) {\r\n      case 'inputMediaPoll': {\r\n        inputMedia.poll.id = message.id;\r\n        appPollsManager.savePoll(inputMedia.poll, {\r\n          _: 'pollResults',\r\n          flags: 4,\r\n          total_voters: 0,\r\n          pFlags: {},\r\n        });\r\n\r\n        const {poll, results} = appPollsManager.getPoll('' + message.id);\r\n        media = {\r\n          _: 'messageMediaPoll',\r\n          poll,\r\n          results\r\n        };\r\n\r\n        break;\r\n      }\r\n      /* case 'inputMediaPhoto':\r\n        media = {\r\n          _: 'messageMediaPhoto',\r\n          photo: appPhotosManager.getPhoto(inputMedia.id.id),\r\n          caption: inputMedia.caption || ''\r\n        };\r\n        break;\r\n\r\n      case 'inputMediaDocument':\r\n        var doc = appDocsManager.getDoc(inputMedia.id.id);\r\n        if(doc.sticker && doc.stickerSetInput) {\r\n          appStickersManager.pushPopularSticker(doc.id);\r\n        }\r\n        media = {\r\n          _: 'messageMediaDocument',\r\n          'document': doc,\r\n          caption: inputMedia.caption || ''\r\n        };\r\n        break;\r\n\r\n      case 'inputMediaContact':\r\n        media = {\r\n          _: 'messageMediaContact',\r\n          phone_number: inputMedia.phone_number,\r\n          first_name: inputMedia.first_name,\r\n          last_name: inputMedia.last_name,\r\n          user_id: 0\r\n        };\r\n        break;\r\n\r\n      case 'inputMediaGeoPoint':\r\n        media = {\r\n          _: 'messageMediaGeo',\r\n          geo: {\r\n            _: 'geoPoint',\r\n            'lat': inputMedia.geo_point['lat'],\r\n            'long': inputMedia.geo_point['long']\r\n          }\r\n        };\r\n        break;\r\n\r\n      case 'inputMediaVenue':\r\n        media = {\r\n          _: 'messageMediaVenue',\r\n          geo: {\r\n            _: 'geoPoint',\r\n            'lat': inputMedia.geo_point['lat'],\r\n            'long': inputMedia.geo_point['long']\r\n          },\r\n          title: inputMedia.title,\r\n          address: inputMedia.address,\r\n          provider: inputMedia.provider,\r\n          venue_id: inputMedia.venue_id\r\n        };\r\n        break;\r\n\r\n      case 'messageMediaPending':\r\n        media = inputMedia;\r\n        break; */\r\n    }\r\n\r\n    message.media = media;\r\n\r\n    let toggleError = (on: boolean) => {\r\n      /* const historyMessage = this.messagesForHistory[messageId];\r\n      if (on) {\r\n        message.error = true\r\n        if (historyMessage) {\r\n          historyMessage.error = true\r\n        }\r\n      } else {\r\n        delete message.error\r\n        if (historyMessage) {\r\n          delete historyMessage.error\r\n        }\r\n      } */\r\n      rootScope.dispatchEvent('messages_pending');\r\n    };\r\n\r\n    message.send = () => {\r\n      const sentRequestOptions: any = {};\r\n      if(this.pendingAfterMsgs[peerId]) {\r\n        sentRequestOptions.afterMessageId = this.pendingAfterMsgs[peerId].messageId;\r\n      }\r\n\r\n      let apiPromise: Promise<any>;\r\n      if(options.viaBotId) {\r\n        apiPromise = apiManager.invokeApiAfter('messages.sendInlineBotResult', {\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          random_id: message.random_id,\r\n          reply_to_msg_id: replyToMsgId || undefined,\r\n          query_id: options.queryId,\r\n          id: options.resultId,\r\n          clear_draft: options.clearDraft\r\n        }, sentRequestOptions);\r\n      } else {\r\n        apiPromise = apiManager.invokeApiAfter('messages.sendMedia', {\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          media: inputMedia,\r\n          random_id: message.random_id,\r\n          reply_to_msg_id: replyToMsgId || undefined,\r\n          message: '',\r\n          clear_draft: options.clearDraft,\r\n          schedule_date: options.scheduleDate,\r\n          silent: options.silent\r\n        }, sentRequestOptions);\r\n      }\r\n\r\n      apiPromise.then((updates) => {\r\n        if(updates.updates) {\r\n          updates.updates.forEach((update: any) => {\r\n            if(update._ === 'updateDraftMessage') {\r\n              update.local = true\r\n            }\r\n          });\r\n        }\r\n\r\n        apiUpdatesManager.processUpdateMessage(updates);\r\n      }, (error) => {\r\n        toggleError(true);\r\n      }).finally(() => {\r\n        if(this.pendingAfterMsgs[peerId] === sentRequestOptions) {\r\n          delete this.pendingAfterMsgs[peerId];\r\n        }\r\n      });\r\n      this.pendingAfterMsgs[peerId] = sentRequestOptions;\r\n    }\r\n\r\n    this.beforeMessageSending(message, {\r\n      isScheduled: !!options.scheduleDate || undefined, \r\n      threadId: options.threadId,\r\n      clearDraft: options.clearDraft\r\n    });\r\n  }\r\n\r\n  /* private checkSendOptions(options: Partial<{\r\n    scheduleDate: number\r\n  }>) {\r\n    if(options.scheduleDate) {\r\n      const minTimestamp = (Date.now() / 1000 | 0) + 10;\r\n      if(options.scheduleDate <= minTimestamp) {\r\n        delete options.scheduleDate;\r\n      }\r\n    }\r\n  } */\r\n\r\n  private beforeMessageSending(message: any, options: Partial<{\r\n    isGroupedItem: true, \r\n    isScheduled: true, \r\n    threadId: number, \r\n    clearDraft: true\r\n  }> = {}) {\r\n    const messageId = message.id;\r\n    const peerId = this.getMessagePeer(message);\r\n    const storage = options.isScheduled ? this.getScheduledMessagesStorage(peerId) : this.getMessagesStorage(peerId);\r\n\r\n    if(options.isScheduled) {\r\n      //if(!options.isGroupedItem) {\r\n      this.saveMessages([message], {storage, isScheduled: true, isOutgoing: true});\r\n      setTimeout(() => {\r\n        rootScope.dispatchEvent('scheduled_new', {peerId, mid: messageId});\r\n      }, 0);\r\n    } else {\r\n      /* if(options.threadId && this.threadsStorage[peerId]) {\r\n        delete this.threadsStorage[peerId][options.threadId];\r\n      } */\r\n      const storages: HistoryStorage[] = [\r\n        this.getHistoryStorage(peerId),\r\n        options.threadId ? this.getHistoryStorage(peerId, options.threadId) : undefined\r\n      ];\r\n\r\n      for(const storage of storages) {\r\n        if(storage) {\r\n          storage.history.unshift(messageId);\r\n        }\r\n      }\r\n\r\n      //if(!options.isGroupedItem) {\r\n      this.saveMessages([message], {storage, isOutgoing: true});\r\n      setTimeout(() => {\r\n        this.setDialogTopMessage(message);\r\n        rootScope.dispatchEvent('history_append', {storage, peerId, mid: messageId});\r\n      }, 0);\r\n    }\r\n\r\n    if(!options.isGroupedItem && options.clearDraft) {\r\n      if(options.threadId) {\r\n        appDraftsManager.syncDraft(peerId, options.threadId);\r\n      } else {\r\n        appDraftsManager.saveDraft(peerId, options.threadId, null, {notify: true});  \r\n      }\r\n    }\r\n    \r\n    this.pendingByRandomId[message.random_id] = {\r\n      peerId, \r\n      tempId: messageId, \r\n      threadId: options.threadId, \r\n      storage\r\n    };\r\n\r\n    if(!options.isGroupedItem && message.send) {\r\n      setTimeout(message.send, 0);\r\n      //setTimeout(message.send, 4000);\r\n      //setTimeout(message.send, 7000);\r\n    }\r\n  }\r\n\r\n  private generateOutgoingMessage(peerId: number, options: Partial<{\r\n    scheduleDate: number,\r\n    replyToMsgId: number,\r\n    threadId: number,\r\n    viaBotId: number,\r\n    groupId: string,\r\n    reply_markup: any,\r\n  }>) {\r\n    if(options.threadId && !options.replyToMsgId) {\r\n      options.replyToMsgId = options.threadId;\r\n    }\r\n\r\n    const message: any = {\r\n      _: 'message',\r\n      id: this.generateTempMessageId(peerId),\r\n      from_id: this.generateFromId(peerId),\r\n      peer_id: appPeersManager.getOutputPeer(peerId),\r\n      pFlags: this.generateFlags(peerId),\r\n      date: options.scheduleDate || (tsNow(true) + serverTimeManager.serverTimeOffset),\r\n      message: '',\r\n      grouped_id: options.groupId,\r\n      random_id: randomLong(),\r\n      reply_to: this.generateReplyHeader(options.replyToMsgId, options.threadId),\r\n      via_bot_id: options.viaBotId,\r\n      reply_markup: options.reply_markup,\r\n      replies: this.generateReplies(peerId),\r\n      views: appPeersManager.isBroadcast(peerId) && 1,\r\n      pending: true,\r\n    };\r\n\r\n    return message;\r\n  }\r\n\r\n  private generateReplyHeader(replyToMsgId: number, replyToTopId?: number) {\r\n    const header = {\r\n      _: 'messageReplyHeader',\r\n      reply_to_msg_id: replyToMsgId || replyToTopId,\r\n    } as MessageReplyHeader;\r\n\r\n    if(replyToTopId && header.reply_to_msg_id !== replyToTopId) {\r\n      header.reply_to_top_id = replyToTopId;\r\n    }\r\n\r\n    return header;\r\n  }\r\n\r\n  private generateReplies(peerId: number) {\r\n    let replies: MessageReplies.messageReplies;\r\n    if(appPeersManager.isBroadcast(peerId)) {\r\n      const channelFull = appProfileManager.chatsFull[-peerId] as ChatFull.channelFull;\r\n      if(channelFull?.linked_chat_id) {\r\n        replies = {\r\n          _: 'messageReplies',\r\n          flags: 1,\r\n          pFlags: {\r\n            comments: true\r\n          },\r\n          channel_id: channelFull.linked_chat_id,\r\n          replies: 0,\r\n          replies_pts: 0\r\n        };\r\n      }\r\n    }\r\n\r\n    return replies;\r\n  }\r\n\r\n  /**\r\n   * Generate correct from_id according to anonymous or broadcast\r\n   */\r\n  private generateFromId(peerId: number) {\r\n    if(peerId < 0 && (appPeersManager.isBroadcast(peerId) || appPeersManager.getPeer(peerId).admin_rights?.pFlags?.anonymous)) {\r\n      return undefined;\r\n    } else {\r\n      return appPeersManager.getOutputPeer(appUsersManager.getSelf().id);\r\n    }\r\n  }\r\n\r\n  private generateFlags(peerId: number) {\r\n    const pFlags: any = {};\r\n    const fromId = appUsersManager.getSelf().id;\r\n    if(peerId !== fromId) {\r\n      pFlags.out = true;\r\n\r\n      if(!appPeersManager.isChannel(peerId) && !appUsersManager.isBot(peerId)) {\r\n        pFlags.unread = true;\r\n      }\r\n    }\r\n\r\n    if(appPeersManager.isBroadcast(peerId)) {\r\n      pFlags.post = true;\r\n    }\r\n\r\n    return pFlags;\r\n  }\r\n\r\n  private generateForwardHeader(peerId: number, originalMessage: Message.message) {\r\n    const myId = appUsersManager.getSelf().id;\r\n    if(originalMessage.fromId === myId && originalMessage.peerId === myId && !originalMessage.fwd_from) {\r\n      return;\r\n    }\r\n\r\n    const fwdHeader: MessageFwdHeader.messageFwdHeader = {\r\n      _: 'messageFwdHeader',\r\n      flags: 0,\r\n      date: originalMessage.date\r\n    };\r\n\r\n    if(originalMessage.fwd_from) {\r\n      fwdHeader.from_id = originalMessage.fwd_from.from_id;\r\n      fwdHeader.from_name = originalMessage.fwd_from.from_name;\r\n      fwdHeader.post_author = originalMessage.fwd_from.post_author;\r\n    } else {\r\n      fwdHeader.from_id = appPeersManager.getOutputPeer(originalMessage.fromId);\r\n      fwdHeader.post_author = originalMessage.post_author;\r\n    }\r\n\r\n    if(appPeersManager.isBroadcast(originalMessage.peerId)) {\r\n      if(originalMessage.post_author) {\r\n        fwdHeader.post_author = originalMessage.post_author;\r\n      }\r\n\r\n      fwdHeader.channel_post = originalMessage.id;\r\n    }\r\n    \r\n    // * there is no way to detect whether user profile is hidden\r\n    if(peerId === myId) {\r\n      fwdHeader.saved_from_msg_id = originalMessage.id;\r\n      fwdHeader.saved_from_peer = appPeersManager.getOutputPeer(originalMessage.peerId);\r\n    }\r\n\r\n    return fwdHeader;\r\n  }\r\n\r\n  public generateFakeAvatarMessage(peerId: number, photo: Photo) {\r\n    const maxId = Number.MAX_SAFE_INTEGER;\r\n    const message = {\r\n      _: 'messageService',\r\n      action: {\r\n        _: 'messageActionChannelEditPhoto',\r\n        photo\r\n      },\r\n      mid: maxId,\r\n      peerId,\r\n      date: (photo as Photo.photo).date,\r\n      fromId: peerId\r\n    } as Message.messageService;\r\n\r\n    this.getMessagesStorage(peerId)[maxId] = message;\r\n    return message;\r\n  }\r\n\r\n  public setDialogTopMessage(message: MyMessage, dialog: MTDialog.dialog = this.getDialogOnly(message.peerId)) {\r\n    if(dialog) {\r\n      dialog.top_message = message.mid;\r\n      \r\n      const historyStorage = this.getHistoryStorage(message.peerId);\r\n      historyStorage.maxId = message.mid;\r\n\r\n      this.dialogsStorage.generateIndexForDialog(dialog, false, message);\r\n\r\n      this.scheduleHandleNewDialogs(message.peerId, dialog);\r\n    }\r\n  }\r\n\r\n  public cancelPendingMessage(randomId: string) {\r\n    const pendingData = this.pendingByRandomId[randomId];\r\n\r\n    /* if(DEBUG) {\r\n      this.log('cancelPendingMessage', randomId, pendingData);\r\n    } */\r\n\r\n    if(pendingData) {\r\n      const {peerId, tempId, storage} = pendingData;\r\n      const historyStorage = this.getHistoryStorage(peerId);\r\n\r\n      apiUpdatesManager.processUpdateMessage({\r\n        _: 'updateShort',\r\n        update: {\r\n          _: 'updateDeleteMessages',\r\n          messages: [tempId]\r\n        }\r\n      });\r\n\r\n      historyStorage.history.delete(tempId);\r\n\r\n      delete this.pendingByRandomId[randomId];\r\n      delete storage[tempId];\r\n\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public async refreshConversations() {\r\n    const limit = 200, outDialogs: Dialog[] = [];\r\n    for(let folderId = 0; folderId < 2; ++folderId) {\r\n      let offsetDate = 0;\r\n      for(;;) {\r\n        const {dialogs} = await appMessagesManager.getTopMessages(limit, folderId, offsetDate);\r\n  \r\n        if(dialogs.length) {\r\n          outDialogs.push(...dialogs as Dialog[]);\r\n          const dialog = dialogs[dialogs.length - 1];\r\n\r\n          // * get peerId and mid manually, because dialog can be migrated peer and it won't be saved\r\n          const peerId = appPeersManager.getPeerId(dialog.peer);\r\n          const mid = this.generateMessageId(dialog.top_message);\r\n          offsetDate = this.getMessageByPeer(peerId, mid).date;\r\n\r\n          if(!offsetDate) {\r\n            console.error('refreshConversations: got no offsetDate', dialog);\r\n            break;\r\n          }\r\n        } else {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    let obj: {[peerId: string]: Dialog} = {};\r\n    outDialogs.forEach(dialog => {\r\n      obj[dialog.peerId] = dialog;\r\n    });\r\n    rootScope.dispatchEvent('dialogs_multiupdate', obj);\r\n\r\n    return outDialogs;\r\n  }\r\n\r\n  public async getConversationsAll(query = '', folderId = 0) {\r\n    const limit = 200, outDialogs: Dialog[] = [];\r\n    for(; folderId < 2; ++folderId) {\r\n      let offsetIndex = 0;\r\n      for(;;) {\r\n        const {dialogs} = await appMessagesManager.getConversations(query, offsetIndex, limit, folderId);\r\n  \r\n        if(dialogs.length) {\r\n          outDialogs.push(...dialogs);\r\n          offsetIndex = dialogs[dialogs.length - 1].index || 0;\r\n        } else {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    return outDialogs;\r\n  }\r\n\r\n  public getConversations(query = '', offsetIndex?: number, limit = 20, folderId = 0) {\r\n    return this.dialogsStorage.getDialogs(query, offsetIndex, limit, folderId);\r\n  }\r\n\r\n  public getReadMaxIdIfUnread(peerId: number, threadId?: number) {\r\n    const historyStorage = this.getHistoryStorage(peerId, threadId);\r\n    if(threadId) {\r\n      const chatHistoryStorage = this.getHistoryStorage(peerId);\r\n      const readMaxId = Math.max(chatHistoryStorage.readMaxId ?? 0, historyStorage.readMaxId);\r\n      const message = this.getMessageByPeer(peerId, historyStorage.maxId); // usually message is missing, so pFlags.out won't be there anyway\r\n      return !message.pFlags.out && readMaxId < historyStorage.maxId ? readMaxId : 0;\r\n    } else {\r\n      const message = this.getMessageByPeer(peerId, historyStorage.maxId);\r\n      const readMaxId = peerId > 0 ? Math.max(historyStorage.readMaxId, historyStorage.readOutboxMaxId) : historyStorage.readMaxId;\r\n      return !message.pFlags.out && readMaxId < historyStorage.maxId ? readMaxId : 0;\r\n    }\r\n  }\r\n\r\n  public getTopMessages(limit: number, folderId: number, offsetDate?: number) {\r\n    const dialogs = this.dialogsStorage.getFolder(folderId);\r\n    let offsetId = 0;\r\n    let offsetPeerId = 0;\r\n    let offsetIndex = 0;\r\n\r\n    if(offsetDate === undefined) {\r\n      offsetDate = this.dialogsStorage.getOffsetDate(folderId);\r\n    }\r\n\r\n    if(offsetDate) {\r\n      offsetIndex = offsetDate * 0x10000;\r\n      offsetDate += serverTimeManager.serverTimeOffset;\r\n    }\r\n\r\n    // ! ВНИМАНИЕ: ОЧЕНЬ СЛОЖНАЯ ЛОГИКА:\r\n    // ! если делать запрос сначала по папке 0, потом по папке 1, по индексу 0 в массиве будет один и тот же диалог, с dialog.pFlags.pinned, ЛОЛ???\r\n    // ! т.е., с запросом folder_id: 1, и exclude_pinned: 0, в результате будут ещё и закреплённые с папки 0\r\n    return apiManager.invokeApiSingle('messages.getDialogs', {\r\n      folder_id: folderId,\r\n      offset_date: offsetDate,\r\n      offset_id: offsetId,\r\n      offset_peer: appPeersManager.getInputPeerById(offsetPeerId),\r\n      limit,\r\n      hash: 0\r\n    }, {\r\n      //timeout: APITIMEOUT,\r\n      noErrorBox: true\r\n    }).then((dialogsResult) => {\r\n      if(dialogsResult._ === 'messages.dialogsNotModified') return null;\r\n\r\n      if(DEBUG) {\r\n        this.log('messages.getDialogs result:', dialogsResult.dialogs, {...dialogsResult.dialogs[0]});\r\n      }\r\n\r\n      /* if(!offsetDate) {\r\n        telegramMeWebService.setAuthorized(true);\r\n      } */\r\n\r\n      // can reset here pinned order\r\n      if(!offsetId && !offsetDate && !offsetPeerId) {\r\n        this.dialogsStorage.resetPinnedOrder(folderId);\r\n      }\r\n\r\n      appUsersManager.saveApiUsers(dialogsResult.users);\r\n      appChatsManager.saveApiChats(dialogsResult.chats);\r\n      this.saveMessages(dialogsResult.messages);\r\n\r\n      let maxSeenIdIncremented = offsetDate ? true : false;\r\n      let hasPrepend = false;\r\n      const noIdsDialogs: {[peerId: number]: Dialog} = {};\r\n      forEachReverse((dialogsResult.dialogs as Dialog[]), dialog => {\r\n        //const d = Object.assign({}, dialog);\r\n        // ! нужно передавать folderId, так как по папке !== 0 нет свойства folder_id\r\n        this.dialogsStorage.saveDialog(dialog, dialog.folder_id ?? folderId);\r\n\r\n        if(!maxSeenIdIncremented &&\r\n          !appPeersManager.isChannel(appPeersManager.getPeerId(dialog.peer))) {\r\n          this.incrementMaxSeenId(dialog.top_message);\r\n          maxSeenIdIncremented = true;\r\n        }\r\n\r\n        if(dialog.peerId === undefined) {\r\n          return;\r\n        }\r\n\r\n        /* if(dialog.peerId === -1213511294) {\r\n          this.log.error('lun bot', folderId, d);\r\n        } */\r\n\r\n        if(offsetIndex && dialog.index > offsetIndex) {\r\n          this.scheduleHandleNewDialogs(dialog.peerId, dialog);\r\n          hasPrepend = true;\r\n        }\r\n\r\n        // ! это может случиться, если запрос идёт не по папке 0, а по 1. почему-то read'ов нет\r\n        // ! в итоге, чтобы получить 1 диалог, делается первый запрос по папке 0, потом запрос для архивных по папке 1, и потом ещё перезагрузка архивного диалога\r\n        if(!this.getServerMessageId(dialog.read_inbox_max_id) && !this.getServerMessageId(dialog.read_outbox_max_id)) {\r\n          noIdsDialogs[dialog.peerId] = dialog;\r\n\r\n          this.log.error('noIdsDialogs', dialog);\r\n\r\n          /* if(dialog.peerId === -1213511294) {\r\n            this.log.error('lun bot', folderId);\r\n          } */\r\n        }\r\n      });\r\n\r\n      if(Object.keys(noIdsDialogs).length) {\r\n        //setTimeout(() => { // test bad situation\r\n          this.reloadConversation(Object.keys(noIdsDialogs).map(id => +id)).then(() => {\r\n            rootScope.dispatchEvent('dialogs_multiupdate', noIdsDialogs);\r\n  \r\n            for(let peerId in noIdsDialogs) {\r\n              rootScope.dispatchEvent('dialog_unread', {peerId: +peerId});\r\n            }\r\n          });\r\n        //}, 10e3);\r\n      }\r\n\r\n      const count = (dialogsResult as MessagesDialogs.messagesDialogsSlice).count;\r\n\r\n      if(limit > dialogsResult.dialogs.length || \r\n        !count || \r\n        dialogs.length >= count) {\r\n        this.dialogsStorage.setDialogsLoaded(folderId, true);\r\n      }\r\n\r\n      if(hasPrepend) {\r\n        this.scheduleHandleNewDialogs();\r\n      } else {\r\n        rootScope.dispatchEvent('dialogs_multiupdate', {});\r\n      }\r\n\r\n      return dialogsResult;\r\n    });\r\n  }\r\n\r\n  public forwardMessages(peerId: number, fromPeerId: number, mids: number[], options: Partial<{\r\n    withMyScore: true,\r\n    silent: true,\r\n    scheduleDate: number\r\n  }> = {}) {\r\n    peerId = appPeersManager.getPeerMigratedTo(peerId) || peerId;\r\n    mids = mids.slice().sort((a, b) => a - b);\r\n\r\n    const groups: {\r\n      [groupId: string]: {\r\n        tempId: string,\r\n        messages: any[]\r\n      }\r\n    } = {};\r\n\r\n    const newMessages = mids.map(mid => {\r\n      const originalMessage: Message.message = this.getMessageByPeer(fromPeerId, mid);\r\n      const message: Message.message = this.generateOutgoingMessage(peerId, options);\r\n      message.fwd_from = this.generateForwardHeader(peerId, originalMessage);\r\n\r\n      (['entities', 'forwards', 'message', 'media', 'reply_markup', 'views'] as any as Array<keyof MyMessage>).forEach(key => {\r\n        // @ts-ignore\r\n        message[key] = originalMessage[key];\r\n      });\r\n\r\n      const document = (message.media as MessageMedia.messageMediaDocument)?.document as MyDocument;\r\n      if(document) {\r\n        const types: MyDocument['type'][] = ['round', 'voice'];\r\n        if(types.includes(document.type)) {\r\n          (message as MyMessage).pFlags.media_unread = true;\r\n        }\r\n      }\r\n\r\n      if(originalMessage.grouped_id) {\r\n        const group = groups[originalMessage.grouped_id] ?? (groups[originalMessage.grouped_id] = {tempId: '' + ++this.groupedTempId, messages: []});\r\n        group.messages.push(message);\r\n      }\r\n\r\n      return message;\r\n    });\r\n\r\n    for(const groupId in groups) {\r\n      const group = groups[groupId];\r\n      if(group.messages.length > 1) {\r\n        group.messages.forEach(message => {\r\n          message.grouped_id = group.tempId;\r\n        });\r\n      }\r\n    }\r\n\r\n    newMessages.forEach(message => {\r\n      this.beforeMessageSending(message, {\r\n        isScheduled: !!options.scheduleDate || undefined\r\n      });\r\n    });\r\n\r\n    const sentRequestOptions: InvokeApiOptions = {};\r\n    if(this.pendingAfterMsgs[peerId]) {\r\n      sentRequestOptions.afterMessageId = this.pendingAfterMsgs[peerId].messageId;\r\n    }\r\n\r\n    const promise = /* true ? Promise.resolve() :  */apiManager.invokeApiAfter('messages.forwardMessages', {\r\n      from_peer: appPeersManager.getInputPeerById(fromPeerId),\r\n      id: mids.map(mid => this.getServerMessageId(mid)),\r\n      random_id: newMessages.map(message => message.random_id),\r\n      to_peer: appPeersManager.getInputPeerById(peerId),\r\n      with_my_score: options.withMyScore,\r\n      silent: options.silent,\r\n      schedule_date: options.scheduleDate\r\n    }, sentRequestOptions).then((updates) => {\r\n      this.log('forwardMessages updates:', updates);\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n    }).finally(() => {\r\n      if(this.pendingAfterMsgs[peerId] === sentRequestOptions) {\r\n        delete this.pendingAfterMsgs[peerId];\r\n      }\r\n    });\r\n\r\n    this.pendingAfterMsgs[peerId] = sentRequestOptions;\r\n    return promise;\r\n  }\r\n\r\n  public getMessageFromStorage(storage: MessagesStorage, messageId: number) {\r\n    return storage && storage[messageId] || {\r\n      _: 'messageEmpty',\r\n      id: messageId,\r\n      deleted: true,\r\n      pFlags: {}\r\n    };\r\n  }\r\n\r\n  private createMessageStorage() {\r\n    const storage: MessagesStorage = {} as any;\r\n    \r\n    /* let num = 0;\r\n    Object.defineProperty(storage, 'num', {\r\n      get: () => ++num,\r\n      set: (_num: number) => num = _num, \r\n      enumerable: false\r\n    });\r\n\r\n    Object.defineProperty(storage, 'generateIndex', {\r\n      value: (message: any) => {\r\n        if(message.index === undefined) {\r\n          message.index = (message.date * 0x10000) + (storage.num & 0xFFFF);\r\n        }\r\n      },\r\n      enumerable: false\r\n    }); */\r\n\r\n    return storage;\r\n  }\r\n\r\n  public getMessagesStorage(peerId: number) {\r\n    return this.messagesStorageByPeerId[peerId] ?? (this.messagesStorageByPeerId[peerId] = this.createMessageStorage());\r\n  }\r\n\r\n  public getMessageById(messageId: number) {\r\n    for(const peerId in this.messagesStorageByPeerId) {\r\n      if(appPeersManager.isChannel(+peerId)) {\r\n        continue;\r\n      }\r\n\r\n      const message = this.messagesStorageByPeerId[peerId][messageId];\r\n      if(message) {\r\n        return message;\r\n      }\r\n    }\r\n\r\n    return this.getMessageFromStorage(null, messageId);\r\n  }\r\n\r\n  public getMessageByPeer(peerId: number, messageId: number) {\r\n    if(!peerId) {\r\n      return this.getMessageById(messageId);\r\n    }\r\n\r\n    return this.getMessageFromStorage(this.getMessagesStorage(peerId), messageId);\r\n  }\r\n\r\n  public getMessagePeer(message: any): number {\r\n    const toId = message.peer_id && appPeersManager.getPeerId(message.peer_id) || 0;\r\n\r\n    return toId;\r\n  }\r\n\r\n  public getDialogByPeerId(peerId: number): [Dialog, number] | [] {\r\n    return this.dialogsStorage.getDialog(peerId);\r\n  }\r\n\r\n  public getDialogOnly(peerId: number) {\r\n    return this.dialogsStorage.getDialogOnly(peerId);\r\n  }\r\n\r\n  public reloadConversation(peerId: number | number[]) {\r\n    [].concat(peerId).forEach(peerId => {\r\n      if(!this.reloadConversationsPeers.has(peerId)) {\r\n        this.reloadConversationsPeers.add(peerId);\r\n        //this.log('will reloadConversation', peerId);\r\n      }\r\n    });\r\n\r\n    if(this.reloadConversationsPromise) return this.reloadConversationsPromise;\r\n    return this.reloadConversationsPromise = new Promise((resolve, reject) => {\r\n      setTimeout(() => {\r\n        const peers = Array.from(this.reloadConversationsPeers).map(peerId => appPeersManager.getInputDialogPeerById(peerId));\r\n        this.reloadConversationsPeers.clear();\r\n\r\n        apiManager.invokeApi('messages.getPeerDialogs', {peers}).then((result) => {\r\n          this.dialogsStorage.applyDialogs(result);\r\n          resolve();\r\n        }, reject).finally(() => {\r\n          this.reloadConversationsPromise = null;\r\n        });\r\n      }, 0);\r\n    });\r\n  }\r\n\r\n  private doFlushHistory(inputPeer: any, justClear?: boolean, revoke?: boolean): Promise<true> {\r\n    return apiManager.invokeApi('messages.deleteHistory', {\r\n      just_clear: justClear,\r\n      revoke: revoke,\r\n      peer: inputPeer,\r\n      max_id: 0\r\n    }).then((affectedHistory) => {\r\n      apiUpdatesManager.processUpdateMessage({\r\n        _: 'updateShort',\r\n        update: {\r\n          _: 'updatePts',\r\n          pts: affectedHistory.pts,\r\n          pts_count: affectedHistory.pts_count\r\n        }\r\n      });\r\n\r\n      if(!affectedHistory.offset) {\r\n        return true;\r\n      }\r\n\r\n      return this.doFlushHistory(inputPeer, justClear);\r\n    })\r\n  }\r\n\r\n  public async flushHistory(peerId: number, justClear?: boolean, revoke?: boolean) {\r\n    if(appPeersManager.isChannel(peerId)) {\r\n      const promise = this.getHistory(peerId, 0, 1);\r\n\r\n      const historyResult = promise instanceof Promise ? await promise : promise;\r\n\r\n      const channelId = -peerId;\r\n      const maxId = historyResult.history[0] || 0;\r\n      return apiManager.invokeApi('channels.deleteHistory', {\r\n        channel: appChatsManager.getChannelInput(channelId),\r\n        max_id: maxId\r\n      }).then(() => {\r\n        apiUpdatesManager.processUpdateMessage({\r\n          _: 'updateShort',\r\n          update: {\r\n            _: 'updateChannelAvailableMessages',\r\n            channel_id: channelId,\r\n            available_min_id: maxId\r\n          } as Update.updateChannelAvailableMessages\r\n        });\r\n\r\n        return true;\r\n      });\r\n    }\r\n\r\n    return this.doFlushHistory(appPeersManager.getInputPeerById(peerId), justClear, revoke).then(() => {\r\n      delete this.historiesStorage[peerId];\r\n      delete this.messagesStorageByPeerId[peerId];\r\n\r\n      if(justClear) {\r\n        rootScope.dispatchEvent('dialog_flush', {peerId});\r\n      } else {\r\n        this.dialogsStorage.dropDialog(peerId);\r\n\r\n        rootScope.dispatchEvent('dialog_drop', {peerId});\r\n      }\r\n    });\r\n  }\r\n\r\n  public hidePinnedMessages(peerId: number) {\r\n    return Promise.all([\r\n      appStateManager.getState(),\r\n      this.getPinnedMessage(peerId)\r\n    ])\r\n    .then(([state, pinned]) => {\r\n      state.hiddenPinnedMessages[peerId] = pinned.maxId;\r\n      rootScope.dispatchEvent('peer_pinned_hidden', {peerId, maxId: pinned.maxId});\r\n    });\r\n  }\r\n\r\n  public getPinnedMessage(peerId: number) {\r\n    const p = this.pinnedMessages[peerId] ?? (this.pinnedMessages[peerId] = {});\r\n    if(p.promise) return p.promise;\r\n    else if(p.maxId) return Promise.resolve(p);\r\n\r\n    return p.promise = this.getSearch({\r\n      peerId, \r\n      inputFilter: {_: 'inputMessagesFilterPinned'},\r\n      maxId: 0,\r\n      limit: 1\r\n    }).then(result => {\r\n      p.count = result.count;\r\n      p.maxId = result.history[0]?.mid;\r\n      return p;\r\n    }).finally(() => {\r\n      delete p.promise;\r\n    });\r\n  }\r\n\r\n  public updatePinnedMessage(peerId: number, mid: number, unpin?: true, silent?: true, oneSide?: true) {\r\n    return apiManager.invokeApi('messages.updatePinnedMessage', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      unpin,\r\n      silent,\r\n      pm_oneside: oneSide,\r\n      id: this.getServerMessageId(mid)\r\n    }).then(updates => {\r\n      //this.log('pinned updates:', updates);\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n    });\r\n  }\r\n\r\n  public unpinAllMessages(peerId: number): Promise<boolean> {\r\n    return apiManager.invokeApi('messages.unpinAllMessages', {\r\n      peer: appPeersManager.getInputPeerById(peerId)\r\n    }).then(affectedHistory => {\r\n      apiUpdatesManager.processUpdateMessage({\r\n        _: 'updateShort',\r\n        update: {\r\n          _: 'updatePts',\r\n          pts: affectedHistory.pts,\r\n          pts_count: affectedHistory.pts_count\r\n        }\r\n      });\r\n\r\n      if(!affectedHistory.offset) {\r\n        const storage = this.getMessagesStorage(peerId);\r\n        for(const mid in storage) {\r\n          const message = storage[mid];\r\n          if(message.pFlags.pinned) {\r\n            delete message.pFlags.pinned;\r\n          }\r\n        }\r\n\r\n        rootScope.dispatchEvent('peer_pinned_messages', {peerId, unpinAll: true});\r\n        delete this.pinnedMessages[peerId];\r\n\r\n        return true;\r\n      }\r\n\r\n      return this.unpinAllMessages(peerId);\r\n    });\r\n  }\r\n\r\n  public getAlbumText(grouped_id: string) {\r\n    const group = this.groupedMessagesStorage[grouped_id];\r\n    let foundMessages = 0, message: string, totalEntities: MessageEntity[], entities: MessageEntity[];\r\n    for(const i in group) {\r\n      const m = group[i];\r\n      if(m.message) {\r\n        if(++foundMessages > 1) break;\r\n        message = m.message;\r\n        totalEntities = m.totalEntities;\r\n        entities = m.entities;\r\n      }  \r\n    }\r\n\r\n    if(foundMessages > 1) {\r\n      message = undefined;\r\n      totalEntities = undefined;\r\n      entities = undefined;\r\n    }\r\n\r\n    return {message, entities, totalEntities};\r\n  }\r\n\r\n  public getMidsByAlbum(grouped_id: string) {\r\n    return getObjectKeysAndSort(this.groupedMessagesStorage[grouped_id], 'asc');\r\n    //return Object.keys(this.groupedMessagesStorage[grouped_id]).map(id => +id).sort((a, b) => a - b);\r\n  }\r\n\r\n  public getMidsByMessage(message: any) {\r\n    if(message?.grouped_id) return this.getMidsByAlbum(message.grouped_id);\r\n    else return [message.mid];\r\n  }\r\n\r\n  public filterMessages(message: any, verify: (message: MyMessage) => boolean) {\r\n    const out: MyMessage[] = [];\r\n    if(message.grouped_id) {\r\n      const storage = this.groupedMessagesStorage[message.grouped_id];\r\n      for(const mid in storage) {\r\n        const message = storage[mid];\r\n        if(verify(message)) {\r\n          out.push(message);\r\n        }\r\n      }\r\n    } else {\r\n      if(verify(message)) {\r\n        out.push(message);\r\n      }\r\n    }\r\n\r\n    return out;\r\n  }\r\n\r\n  public generateTempMessageId(peerId: number) {\r\n    const dialog = this.getDialogOnly(peerId);\r\n    return this.generateMessageId(dialog?.top_message || 0, true);\r\n  }\r\n\r\n  public generateMessageId(messageId: number, temp = false) {\r\n    const q = AppMessagesManager.MESSAGE_ID_OFFSET;\r\n    const num = temp ? ++this.tempNum : 0;\r\n    if(messageId >= q) {\r\n      if(temp) {\r\n        return messageId + (num & (AppMessagesManager.MESSAGE_ID_INCREMENT - 1));\r\n      }\r\n\r\n      return messageId;\r\n    }\r\n\r\n    return q + (messageId * AppMessagesManager.MESSAGE_ID_INCREMENT + (num & (AppMessagesManager.MESSAGE_ID_INCREMENT - 1)));\r\n  }\r\n\r\n  /**\r\n   * * will ignore outgoing offset\r\n   */\r\n  public getServerMessageId(messageId: number) {\r\n    const q = AppMessagesManager.MESSAGE_ID_OFFSET;\r\n    if(messageId < q) { // id 0 -> mid 0xFFFFFFFF, so 0xFFFFFFFF must convert to 0\r\n      return messageId;\r\n    }\r\n\r\n    const l = AppMessagesManager.MESSAGE_ID_INCREMENT - 1;\r\n    const used = messageId & l;\r\n    if(used !== l) {\r\n      messageId -= used + 1;\r\n    }\r\n\r\n    return (messageId - q) / AppMessagesManager.MESSAGE_ID_INCREMENT;\r\n  }\r\n\r\n  public incrementMessageId(messageId: number, increment: number) {\r\n    return this.generateMessageId(this.getServerMessageId(messageId) + increment);\r\n  }\r\n\r\n  public saveMessages(messages: any[], options: Partial<{\r\n    storage: MessagesStorage,\r\n    isScheduled: true,\r\n    isOutgoing: true,\r\n    //isNew: boolean, // * new - from update\r\n  }> = {}) {\r\n    //let groups: Set<string>;\r\n    messages.forEach((message) => {\r\n      if(message.pFlags === undefined) {\r\n        message.pFlags = {};\r\n      }\r\n\r\n      if(message._ === 'messageEmpty') {\r\n        return;\r\n      }\r\n\r\n      // * exclude from state\r\n      // defineNotNumerableProperties(message, ['rReply', 'mid', 'savedFrom', 'fwdFromId', 'fromId', 'peerId', 'reply_to_mid', 'viaBotId']);\r\n\r\n      const peerId = this.getMessagePeer(message);\r\n      const storage = options.storage || this.getMessagesStorage(peerId);\r\n      const isChannel = message.peer_id._ === 'peerChannel';\r\n      const channelId = isChannel ? -peerId : 0;\r\n      const isBroadcast = isChannel && appChatsManager.isBroadcast(channelId);\r\n\r\n      if(options.isScheduled) {\r\n        message.pFlags.is_scheduled = true;\r\n      }\r\n\r\n      if(options.isOutgoing) {\r\n        message.pFlags.is_outgoing = true;\r\n      }\r\n      \r\n      const mid = this.generateMessageId(message.id);\r\n      message.mid = mid;\r\n\r\n      if(message.grouped_id) {\r\n        const storage = this.groupedMessagesStorage[message.grouped_id] ?? (this.groupedMessagesStorage[message.grouped_id] = {});\r\n        storage[mid] = message;\r\n      }\r\n\r\n      const dialog = this.getDialogOnly(peerId);\r\n      if(dialog && mid) {\r\n        if(mid > dialog[message.pFlags.out\r\n          ? 'read_outbox_max_id'\r\n          : 'read_inbox_max_id']) {\r\n          message.pFlags.unread = true;\r\n        }\r\n      }\r\n      // this.log(dT(), 'msg unread', mid, apiMessage.pFlags.out, dialog && dialog[apiMessage.pFlags.out ? 'read_outbox_max_id' : 'read_inbox_max_id'])\r\n\r\n      if(message.reply_to) {\r\n        if(message.reply_to.reply_to_msg_id) {\r\n          message.reply_to.reply_to_msg_id = message.reply_to_mid = this.generateMessageId(message.reply_to.reply_to_msg_id);\r\n        } \r\n\r\n        if(message.reply_to.reply_to_top_id) message.reply_to.reply_to_top_id = this.generateMessageId(message.reply_to.reply_to_top_id);\r\n      }\r\n\r\n      if(message.replies) {\r\n        if(message.replies.max_id) message.replies.max_id = this.generateMessageId(message.replies.max_id);\r\n        if(message.replies.read_max_id) message.replies.read_max_id = this.generateMessageId(message.replies.read_max_id);\r\n      }\r\n\r\n      const overwriting = !!message.peerId;\r\n      if(!overwriting) {\r\n        message.date -= serverTimeManager.serverTimeOffset;\r\n      }\r\n      \r\n      //storage.generateIndex(message);\r\n      const myId = appUsersManager.getSelf().id;\r\n\r\n      message.peerId = peerId;\r\n      if(message.peerId === myId/*  && !message.from_id && !message.fwd_from */) {\r\n        message.fromId = message.fwd_from ? (message.fwd_from.from_id ? appPeersManager.getPeerId(message.fwd_from.from_id) : 0) : myId;\r\n      } else {\r\n        //message.fromId = message.pFlags.post || (!message.pFlags.out && !message.from_id) ? peerId : appPeersManager.getPeerId(message.from_id);\r\n        message.fromId = message.pFlags.post || !message.from_id ? peerId : appPeersManager.getPeerId(message.from_id);\r\n      }\r\n\r\n      const fwdHeader = message.fwd_from as MessageFwdHeader;\r\n      if(fwdHeader) {\r\n        //if(peerId === myID) {\r\n          if(fwdHeader.saved_from_msg_id) fwdHeader.saved_from_msg_id = this.generateMessageId(fwdHeader.saved_from_msg_id);\r\n          if(fwdHeader.channel_post) fwdHeader.channel_post = this.generateMessageId(fwdHeader.channel_post);\r\n\r\n          const peer = fwdHeader.saved_from_peer || fwdHeader.from_id;\r\n          const msgId = fwdHeader.saved_from_msg_id || fwdHeader.channel_post;\r\n          if(peer && msgId) {\r\n            const savedFromPeerId = appPeersManager.getPeerId(peer);\r\n            const savedFromMid = this.generateMessageId(msgId);\r\n            message.savedFrom = savedFromPeerId + '_' + savedFromMid;\r\n          }\r\n\r\n          /* if(peerId < 0 || peerId === myID) {\r\n            message.fromId = appPeersManager.getPeerID(!message.from_id || deepEqual(message.from_id, fwdHeader.from_id) ? fwdHeader.from_id : message.from_id);\r\n          } */\r\n        /* } else {\r\n          apiMessage.fwdPostID = fwdHeader.channel_post;\r\n        } */\r\n\r\n        message.fwdFromId = appPeersManager.getPeerId(fwdHeader.from_id);\r\n\r\n        if(!overwriting) {\r\n          fwdHeader.date -= serverTimeManager.serverTimeOffset;\r\n        }\r\n      }\r\n\r\n      if(message.via_bot_id > 0) {\r\n        message.viaBotId = message.via_bot_id;\r\n      }\r\n\r\n      const mediaContext: ReferenceContext = {\r\n        type: 'message',\r\n        peerId,\r\n        messageId: mid\r\n      };\r\n\r\n      if(message.media) {\r\n        switch(message.media._) {\r\n          case 'messageMediaEmpty':\r\n            delete message.media;\r\n            break;\r\n          case 'messageMediaPhoto':\r\n            if(message.media.ttl_seconds) {\r\n              message.media = {_: 'messageMediaUnsupportedWeb'};\r\n            } else {\r\n              message.media.photo = appPhotosManager.savePhoto(message.media.photo, mediaContext);\r\n            }\r\n\r\n            if(!message.media.photo) { // * found this bug on test DC\r\n              delete message.media;\r\n            }\r\n            \r\n            break;\r\n          case 'messageMediaPoll':\r\n            message.media.poll = appPollsManager.savePoll(message.media.poll, message.media.results);\r\n            break;\r\n          case 'messageMediaDocument':\r\n            if(message.media.ttl_seconds) {\r\n              message.media = {_: 'messageMediaUnsupportedWeb'};\r\n            } else {\r\n              message.media.document = appDocsManager.saveDoc(message.media.document, mediaContext); // 11.04.2020 warning\r\n            }\r\n\r\n            break;\r\n          case 'messageMediaWebPage':\r\n            message.media.webpage = appWebPagesManager.saveWebPage(message.media.webpage, message.mid, mediaContext);\r\n            break;\r\n          /*case 'messageMediaGame':\r\n            AppGamesManager.saveGame(apiMessage.media.game, apiMessage.mid, mediaContext);\r\n            apiMessage.media.handleMessage = true;\r\n            break; */\r\n          case 'messageMediaInvoice':\r\n            message.media = {_: 'messageMediaUnsupportedWeb'};\r\n            break;\r\n        }\r\n      }\r\n\r\n      if(message.action) {\r\n        const action = message.action;\r\n        let migrateFrom: number;\r\n        let migrateTo: number;\r\n        const suffix = message.fromId === appUsersManager.getSelf().id ? 'You' : '';\r\n        switch(action._) {\r\n          //case 'messageActionChannelEditPhoto':\r\n          case 'messageActionChatEditPhoto':\r\n            action.photo = appPhotosManager.savePhoto(action.photo, mediaContext);\r\n            if(action.photo.video_sizes) {\r\n              action._ = isBroadcast ? 'messageActionChannelEditVideo' : 'messageActionChatEditVideo';\r\n            } else {\r\n              if(isBroadcast) { // ! messageActionChannelEditPhoto не существует в принципе, это используется для перевода.\r\n                action._ = 'messageActionChannelEditPhoto';\r\n              }\r\n            }\r\n            break;\r\n          \r\n          case 'messageActionGroupCall': {\r\n            //assumeType<MessageAction.messageActionGroupCall>(action);\r\n\r\n            let type: string;\r\n            if(action.duration === undefined) {\r\n              type = 'started';\r\n              if(message.peerId !== message.fromId) {\r\n                type += '_by' + suffix;\r\n              }\r\n            } else {\r\n              type = 'ended_by' + suffix;\r\n            }\r\n\r\n            action.type = type;\r\n\r\n            break;\r\n          }\r\n\r\n          case 'messageActionChatEditTitle':\r\n            /* if(options.isNew) {\r\n              const chat = appChatsManager.getChat(-peerId);\r\n              chat.title = action.title;\r\n              appChatsManager.saveApiChat(chat, true);\r\n            } */\r\n            \r\n            if(isBroadcast) {\r\n              action._ = 'messageActionChannelEditTitle';\r\n            }\r\n            break;\r\n\r\n          case 'messageActionChatDeletePhoto':\r\n            if(isBroadcast) {\r\n              action._ = 'messageActionChannelDeletePhoto';\r\n            }\r\n            break;\r\n\r\n          case 'messageActionChatAddUser':\r\n            if(action.users.length === 1) {\r\n              action.user_id = action.users[0];\r\n              if(message.fromId === action.user_id) {\r\n                if(isChannel) {\r\n                  action._ = 'messageActionChatJoined' + suffix;\r\n                } else {\r\n                  action._ = 'messageActionChatReturn' + suffix;\r\n                }\r\n              }\r\n            } else if(action.users.length > 1) {\r\n              action._ = 'messageActionChatAddUsers';\r\n            }\r\n            break;\r\n\r\n          case 'messageActionChatDeleteUser':\r\n            if(message.fromId === action.user_id) {\r\n              action._ = 'messageActionChatLeave' + suffix;\r\n            }\r\n            break;\r\n\r\n          case 'messageActionChannelMigrateFrom':\r\n            migrateFrom = -action.chat_id;\r\n            migrateTo = -channelId;\r\n            break\r\n\r\n          case 'messageActionChatMigrateTo':\r\n            migrateFrom = -channelId;\r\n            migrateTo = -action.channel_id;\r\n            break;\r\n\r\n          case 'messageActionHistoryClear':\r\n            //apiMessage.deleted = true;\r\n            message.clear_history = true;\r\n            delete message.pFlags.out;\r\n            delete message.pFlags.unread;\r\n            break;\r\n\r\n          case 'messageActionPhoneCall':\r\n            action.type = \r\n              (message.pFlags.out ? 'out_' : 'in_') +\r\n              (\r\n                action.reason._ === 'phoneCallDiscardReasonMissed' ||\r\n                action.reason._ === 'phoneCallDiscardReasonBusy'\r\n                   ? 'missed'\r\n                   : 'ok'\r\n              );\r\n            break;\r\n        }\r\n        \r\n        if(migrateFrom &&\r\n            migrateTo &&\r\n            !this.migratedFromTo[migrateFrom] &&\r\n            !this.migratedToFrom[migrateTo]) {\r\n          this.migrateChecks(migrateFrom, migrateTo);\r\n        }\r\n      }\r\n\r\n      /* if(message.grouped_id) {\r\n        if(!groups) {\r\n          groups = new Set();\r\n        }\r\n\r\n        groups.add(message.grouped_id);\r\n      } else {\r\n        message.rReply = this.getRichReplyText(message);\r\n      } */\r\n\r\n      if(message.message && message.message.length && !message.totalEntities) {\r\n        this.wrapMessageEntities(message);  \r\n      }\r\n\r\n      storage[mid] = message;\r\n    });\r\n\r\n    /* if(groups) {\r\n      for(const groupId of groups) {\r\n        const mids = this.groupedMessagesStorage[groupId];\r\n        for(const mid in mids) {\r\n          const message = this.groupedMessagesStorage[groupId][mid];\r\n          message.rReply = this.getRichReplyText(message);\r\n        }\r\n      }\r\n    } */\r\n  }\r\n\r\n  private wrapMessageEntities(message: any) {\r\n    const apiEntities = message.entities ? message.entities.slice() : [];\r\n    message.message = RichTextProcessor.fixEmoji(message.message, apiEntities);\r\n\r\n    const myEntities = RichTextProcessor.parseEntities(message.message);\r\n    message.totalEntities = RichTextProcessor.mergeEntities(apiEntities, myEntities); // ! only in this order, otherwise bold and emoji formatting won't work\r\n  }\r\n\r\n  public wrapMessageForReply(message: any, text: string, usingMids: number[], plain: true, highlightWord?: string): string;\r\n  public wrapMessageForReply(message: any, text?: string, usingMids?: number[], plain?: false, highlightWord?: string): DocumentFragment;\r\n  public wrapMessageForReply(message: any, text: string = message.message, usingMids?: number[], plain?: boolean, highlightWord?: string): DocumentFragment | string {\r\n    const parts: (HTMLElement | string)[] = [];\r\n\r\n    const addPart = (langKey: LangPackKey, part?: string | HTMLElement, text?: string) => {\r\n      if(langKey) {\r\n        part = plain ? I18n.format(langKey, true) : i18n(langKey);\r\n      }\r\n      \r\n      if(plain) {\r\n        parts.push(part);\r\n      } else {\r\n        const el = document.createElement('i');\r\n        if(typeof(part) === 'string') el.innerHTML = part;\r\n        else el.append(part);\r\n        parts.push(el);\r\n      }\r\n\r\n      if(text) {\r\n        parts.push(', ');\r\n      }\r\n    };\r\n\r\n    if(message.media) {\r\n      let usingFullAlbum = true;\r\n      if(message.grouped_id) {\r\n        if(usingMids) {\r\n          const mids = this.getMidsByMessage(message);\r\n          if(usingMids.length === mids.length) {\r\n            for(const mid of mids) {\r\n              if(!usingMids.includes(mid)) {\r\n                usingFullAlbum = false;\r\n                break;\r\n              }\r\n            }\r\n          } else {\r\n            usingFullAlbum = false;\r\n          }\r\n        }\r\n\r\n        if(usingFullAlbum) {\r\n          text = this.getAlbumText(message.grouped_id).message;\r\n          addPart('AttachAlbum', undefined, text);\r\n        }\r\n      } else {\r\n        usingFullAlbum = false;\r\n      }\r\n\r\n      if(!usingFullAlbum) {\r\n        const media = message.media;\r\n        switch(media._) {\r\n          case 'messageMediaPhoto':\r\n            addPart('AttachPhoto', undefined, message.message);\r\n            break;\r\n          case 'messageMediaDice':\r\n            addPart(undefined, plain ? media.emoticon : RichTextProcessor.wrapEmojiText(media.emoticon));\r\n            break;\r\n          case 'messageMediaVenue': {\r\n            const text = plain ? media.title : RichTextProcessor.wrapEmojiText(media.title);\r\n            addPart('AttachLocation', undefined, text);\r\n            parts.push(htmlToDocumentFragment(text) as any);\r\n            break;\r\n          }\r\n          case 'messageMediaGeo':\r\n            addPart('AttachLocation');\r\n            break;\r\n          case 'messageMediaGeoLive':\r\n            addPart('AttachLiveLocation');\r\n            break;\r\n          case 'messageMediaPoll':\r\n            addPart(undefined, plain ? '📊' + ' ' + (media.poll.question || 'poll') : media.poll.rReply);\r\n            break;\r\n          case 'messageMediaContact':\r\n            addPart('AttachContact');\r\n            break;\r\n          case 'messageMediaGame': {\r\n            const prefix = '🎮' + ' ';\r\n            addPart(undefined, plain ? prefix + media.game.title : RichTextProcessor.wrapEmojiText(prefix + media.game.title));\r\n            break;\r\n          }\r\n          case 'messageMediaDocument':\r\n            let document = media.document;\r\n  \r\n            if(document.type === 'video') {\r\n              addPart('AttachVideo', undefined, message.message);\r\n            } else if(document.type === 'voice') {\r\n              addPart('AttachAudio', undefined, message.message);\r\n            } else if(document.type === 'gif') {\r\n              addPart('AttachGif', undefined, message.message);\r\n            } else if(document.type === 'round') {\r\n              addPart('AttachRound', undefined, message.message);\r\n            } else if(document.type === 'sticker') {\r\n              addPart(undefined, ((plain ? document.stickerEmojiRaw : document.stickerEmoji) || '') + 'Sticker');\r\n              text = '';\r\n            } else {\r\n              addPart(document.file_name, undefined, message.message);\r\n            }\r\n  \r\n            break;\r\n  \r\n          default:\r\n            //messageText += media._;\r\n            ///////this.log.warn('Got unknown media type!', message);\r\n            break;\r\n        }\r\n      } \r\n    }\r\n\r\n    if(message.action) {\r\n      const actionWrapped = this.wrapMessageActionTextNew(message, plain);\r\n      if(actionWrapped) {\r\n        addPart(undefined, actionWrapped);\r\n      }\r\n    }\r\n\r\n    if(text) {\r\n      text = limitSymbols(text, 100);\r\n\r\n      if(plain) {\r\n        parts.push(text);\r\n      } else {\r\n        let entities = RichTextProcessor.parseEntities(text.replace(/\\n/g, ' '));\r\n\r\n        if(highlightWord) {\r\n          highlightWord = highlightWord.trim();\r\n          if(!entities) entities = [];\r\n          let found = false;\r\n          let match: any;\r\n          let regExp = new RegExp(escapeRegExp(highlightWord), 'gi');\r\n          while((match = regExp.exec(text)) !== null) {\r\n            entities.push({_: 'messageEntityHighlight', length: highlightWord.length, offset: match.index});\r\n            found = true;\r\n          }\r\n      \r\n          if(found) {\r\n            entities.sort((a, b) => a.offset - b.offset);\r\n          }\r\n        }\r\n\r\n        const messageWrapped = RichTextProcessor.wrapRichText(text, {\r\n          noLinebreaks: true, \r\n          entities, \r\n          noLinks: true,\r\n          noTextFormat: true\r\n        });\r\n  \r\n        parts.push(htmlToDocumentFragment(messageWrapped) as any);\r\n      }\r\n    }\r\n\r\n    if(plain) {\r\n      return parts.join('');\r\n    } else {\r\n      const fragment = document.createDocumentFragment();\r\n      fragment.append(...parts);\r\n      return fragment;\r\n    }\r\n  }\r\n\r\n  public getSenderToPeerText(message: MyMessage) {\r\n    let senderTitle = '', peerTitle: string;\r\n    \r\n    senderTitle = message.pFlags.out ? 'You' : appPeersManager.getPeerTitle(message.fromId, false, false);\r\n    peerTitle = appPeersManager.isAnyGroup(message.peerId) || (message.pFlags.out && message.peerId !== rootScope.myId) ? \r\n      appPeersManager.getPeerTitle(message.peerId, false, false) : \r\n      '';\r\n\r\n    if(peerTitle) {\r\n      senderTitle += ' ➝ ' + peerTitle;\r\n    }\r\n\r\n    return senderTitle;\r\n  }\r\n\r\n  public wrapMessageActionTextNew(message: any, plain: true): string;\r\n  public wrapMessageActionTextNew(message: any, plain?: false): HTMLElement;\r\n  public wrapMessageActionTextNew(message: any, plain: boolean): HTMLElement | string;\r\n  public wrapMessageActionTextNew(message: any, plain?: boolean): HTMLElement | string {\r\n    const element: HTMLElement = plain ? undefined : document.createElement('span');\r\n    const action = message.action as MessageAction;\r\n\r\n    // this.log('message action:', action);\r\n\r\n    if((action as MessageAction.messageActionCustomAction).message) {\r\n      if(plain) {\r\n        return RichTextProcessor.wrapPlainText(message.message);\r\n      } else {\r\n        element.innerHTML = RichTextProcessor.wrapRichText((action as MessageAction.messageActionCustomAction).message, {noLinebreaks: true});\r\n        return element;\r\n      }\r\n    } else {\r\n      let _ = action._;\r\n      //let suffix = '';\r\n      let langPackKey: LangPackKey;\r\n      let args: any[];\r\n\r\n      const getNameDivHTML = (peerId: number, plain: boolean) => {\r\n        return plain ? appPeersManager.getPeerTitle(peerId, plain) + ' ' : (new PeerTitle({peerId})).element;\r\n      };\r\n\r\n      switch(action._) {\r\n        case 'messageActionPhoneCall': {\r\n          _ += '.' + (action as any).type;\r\n\r\n          args = [formatCallDuration(action.duration)];\r\n          break;\r\n        }\r\n\r\n        case 'messageActionGroupCall': {\r\n          _ += '.' + (action as any).type;\r\n\r\n          args = [];\r\n          if(!_.endsWith('You')) {\r\n            args.push(getNameDivHTML(message.fromId, plain));\r\n          }\r\n\r\n          args.push(formatCallDuration(action.duration));\r\n          break;\r\n        }\r\n\r\n        case 'messageActionInviteToGroupCall': {\r\n          const peerIds = [message.fromId, action.users[0]];\r\n          let a = 'ActionGroupCall';\r\n          const myId = appUsersManager.getSelf().id;\r\n          if(peerIds[0] === myId) a += 'You';\r\n          a += 'Invited';\r\n          if(peerIds[1] === myId) a += 'You';\r\n          peerIds.findAndSplice(peerId => peerId === myId);\r\n\r\n          langPackKey = a as LangPackKey;\r\n          args = peerIds.map(peerId => getNameDivHTML(peerId, plain));\r\n          break;\r\n        }\r\n\r\n        case 'messageActionGroupCallScheduled': {\r\n          const today = new Date();\r\n          const date = new Date(action.schedule_date * 1000);\r\n          const daysToStart = (date.getTime() - today.getTime()) / 86400e3;\r\n          const tomorrowDate = new Date(today);\r\n          tomorrowDate.setDate(tomorrowDate.getDate() + 1);\r\n\r\n          langPackKey = 'ChatList.Service.VoiceChatScheduled';\r\n          const myId = appUsersManager.getSelf().id;\r\n          if(message.fromId === myId) {\r\n            langPackKey += 'You';\r\n          }\r\n\r\n          let k: LangPackKey, _args: any[] = [];\r\n          if(daysToStart < 1 && date.getDate() === today.getDate()) {\r\n            k = 'TodayAtFormattedWithToday';\r\n          } else if(daysToStart < 2 && date.getDate() === tomorrowDate.getDate()) {\r\n            k = 'Time.TomorrowAt';\r\n          } else {\r\n            k = 'formatDateAtTime';\r\n            _args.push(new I18n.IntlDateElement({\r\n              date, \r\n              options: {\r\n                day: '2-digit',\r\n                month: '2-digit',\r\n                year: '2-digit'\r\n              }\r\n            }).element);\r\n          }\r\n\r\n          _args.push(formatTime(date));\r\n          const t = i18n(k, _args);\r\n          args = [t];\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageActionPinMessage':\r\n        case 'messageActionContactSignUp':\r\n        case 'messageActionChatReturn':\r\n        case 'messageActionChatLeave':\r\n        case 'messageActionChatJoined':\r\n        case 'messageActionChatCreate':\r\n        case 'messageActionChatEditPhoto':\r\n        case 'messageActionChatDeletePhoto':\r\n        case 'messageActionChatEditVideo':\r\n        case 'messageActionChatJoinedByLink':\r\n        case 'messageActionChannelEditVideo':\r\n        case 'messageActionChannelDeletePhoto': {\r\n          args = [getNameDivHTML(message.fromId, plain)];\r\n          break;\r\n        }\r\n\r\n        case 'messageActionChannelEditTitle':\r\n        case 'messageActionChatEditTitle': {\r\n          args = [];\r\n          if(action._ === 'messageActionChatEditTitle') {\r\n            args.push(getNameDivHTML(message.fromId, plain));\r\n          }\r\n\r\n          args.push(plain ? action.title : htmlToSpan(RichTextProcessor.wrapEmojiText(action.title)));\r\n          break;\r\n        }\r\n\r\n        case 'messageActionChatDeleteUser':\r\n        case 'messageActionChatAddUsers':\r\n        case 'messageActionChatAddUser': {\r\n          const users: number[] = (action as MessageAction.messageActionChatAddUser).users \r\n            || [(action as MessageAction.messageActionChatDeleteUser).user_id];\r\n\r\n          args = [getNameDivHTML(message.fromId, plain)];\r\n\r\n          if(users.length > 1) {\r\n            if(plain) {\r\n              args.push(...users.map((userId: number) => (getNameDivHTML(userId, true) as string).trim()).join(', '));\r\n            } else {\r\n              const fragment = document.createElement('span');\r\n              fragment.append(\r\n                ...join(\r\n                  users.map((userId: number) => getNameDivHTML(userId, false)) as HTMLElement[],\r\n                  false\r\n                )\r\n              );\r\n              args.push(fragment);\r\n            }\r\n          } else {\r\n            args.push(getNameDivHTML(users[0], plain));\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageActionBotAllowed': {\r\n          const anchorHTML = RichTextProcessor.wrapRichText(action.domain, {\r\n            entities: [{\r\n              _: 'messageEntityUrl',\r\n              length: action.domain.length,\r\n              offset: 0\r\n            }]\r\n          });\r\n\r\n          const node = htmlToSpan(anchorHTML);\r\n\r\n          args = [node];\r\n          break;\r\n        }\r\n\r\n        default:\r\n          langPackKey = (langPack[_] || `[${action._}]`) as any;\r\n          break;\r\n      }\r\n\r\n      if(!langPackKey) {\r\n        langPackKey = langPack[_];\r\n        if(langPackKey === undefined) {\r\n          langPackKey = '[' + _ + ']' as any;\r\n        }\r\n      }\r\n\r\n      if(plain) {\r\n        return I18n.format(langPackKey, true, args);\r\n      } else {\r\n        return _i18n(element, langPackKey, args);\r\n      }\r\n\r\n      //str = !langPackKey || langPackKey[0].toUpperCase() === langPackKey[0] ? langPackKey : getNameDivHTML(message.fromId) + langPackKey + (suffix ? ' ' : '');\r\n    }\r\n  }\r\n\r\n  public editPeerFolders(peerIds: number[], folderId: number) {\r\n    apiManager.invokeApi('folders.editPeerFolders', {\r\n      folder_peers: peerIds.map(peerId => {\r\n        return {\r\n          _: 'inputFolderPeer',\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          folder_id: folderId\r\n        };\r\n      })\r\n    }).then(updates => {\r\n      //this.log('editPeerFolders updates:', updates);\r\n      apiUpdatesManager.processUpdateMessage(updates); // WARNING! возможно тут нужно добавлять channelId, и вызывать апдейт для каждого канала отдельно\r\n    });\r\n  }\r\n\r\n  public toggleDialogPin(peerId: number, filterId?: number) {\r\n    if(filterId > 1) {\r\n      return this.filtersStorage.toggleDialogPin(peerId, filterId);\r\n    }\r\n\r\n    const dialog = this.getDialogOnly(peerId);\r\n    if(!dialog) return Promise.reject();\r\n\r\n    const pinned = dialog.pFlags?.pinned ? undefined : true;\r\n    return apiManager.invokeApi('messages.toggleDialogPin', {\r\n      peer: appPeersManager.getInputDialogPeerById(peerId),\r\n      pinned\r\n    }).then(bool => {\r\n      if(bool) {\r\n        const pFlags: Update.updateDialogPinned['pFlags'] = pinned ? {pinned} : {};\r\n        apiUpdatesManager.saveUpdate({\r\n          _: 'updateDialogPinned',\r\n          peer: appPeersManager.getDialogPeer(peerId),\r\n          folder_id: filterId,\r\n          pFlags\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  public markDialogUnread(peerId: number, read?: true) {\r\n    const dialog = this.getDialogOnly(peerId);\r\n    if(!dialog) return Promise.reject();\r\n\r\n    const unread = read || dialog.pFlags?.unread_mark ? undefined : true;\r\n    return apiManager.invokeApi('messages.markDialogUnread', {\r\n      peer: appPeersManager.getInputDialogPeerById(peerId),\r\n      unread\r\n    }).then(bool => {\r\n      if(bool) {\r\n        const pFlags: Update.updateDialogUnreadMark['pFlags'] = unread ? {unread} : {};\r\n        this.onUpdateDialogUnreadMark({\r\n          _: 'updateDialogUnreadMark',\r\n          peer: appPeersManager.getDialogPeer(peerId),\r\n          pFlags\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  public migrateChecks(migrateFrom: number, migrateTo: number) {\r\n    if(!this.migratedFromTo[migrateFrom] &&\r\n      !this.migratedToFrom[migrateTo] &&\r\n      appChatsManager.hasChat(-migrateTo)) {\r\n      const fromChat = appChatsManager.getChat(-migrateFrom);\r\n      if(fromChat &&\r\n        fromChat.migrated_to &&\r\n        fromChat.migrated_to.channel_id === -migrateTo) {\r\n          this.migratedFromTo[migrateFrom] = migrateTo;\r\n          this.migratedToFrom[migrateTo] = migrateFrom;\r\n\r\n        //setTimeout(() => {\r\n          rootScope.dispatchEvent('dialog_migrate', {migrateFrom, migrateTo});\r\n\r\n          const dropped = this.dialogsStorage.dropDialog(migrateFrom);\r\n          if(dropped.length) {\r\n            rootScope.dispatchEvent('dialog_drop', {peerId: migrateFrom, dialog: dropped[0]});\r\n          }\r\n        //}, 100);\r\n      }\r\n    }\r\n  }\r\n\r\n  private canMessageBeEdited(message: any, kind: 'text' | 'poll') {\r\n    if(message.pFlags.is_outgoing) {\r\n      return false;\r\n    }\r\n\r\n    const goodMedias = [\r\n      'messageMediaPhoto',\r\n      'messageMediaDocument',\r\n      'messageMediaWebPage'\r\n    ];\r\n\r\n    if(kind === 'poll') {\r\n      goodMedias.push('messageMediaPoll');\r\n    }\r\n\r\n    if(message._ !== 'message' ||\r\n        message.deleted ||\r\n        message.fwd_from ||\r\n        message.via_bot_id ||\r\n        message.media && goodMedias.indexOf(message.media._) === -1 ||\r\n        message.fromId && appUsersManager.isBot(message.fromId)) {\r\n      return false;\r\n    }\r\n    \r\n    if(message.media &&\r\n        message.media._ === 'messageMediaDocument' &&\r\n        (message.media.document.sticker || message.media.document.type === 'round')) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public canEditMessage(message: any, kind: 'text' | 'poll' = 'text') {\r\n    if(!message || !this.canMessageBeEdited(message, kind)) {\r\n      return false;\r\n    }\r\n\r\n    // * second rule for saved messages, because there is no 'out' flag\r\n    if(message.pFlags.out || this.getMessagePeer(message) === appUsersManager.getSelf().id) {\r\n      return true;\r\n    }\r\n\r\n    if((message.date < (tsNow(true) - (2 * 86400)) && message.media?._ !== 'messageMediaPoll') || !message.pFlags.out) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public canDeleteMessage(message: any) {\r\n    return message && (\r\n      message.peerId > 0 \r\n      || message.fromId === rootScope.myId \r\n      || appChatsManager.getChat(message.peerId)._ === 'chat' \r\n      || appChatsManager.hasRights(message.peerId, 'delete_messages')\r\n    ) && !message.pFlags.is_outgoing;\r\n  }\r\n\r\n  public mergeReplyKeyboard(historyStorage: HistoryStorage, message: any) {\r\n    // this.log('merge', message.mid, message.reply_markup, historyStorage.reply_markup)\r\n    if(!message.reply_markup &&\r\n      !message.pFlags?.out &&\r\n      !message.action) {\r\n      return false;\r\n    }\r\n    if(message.reply_markup &&\r\n      message.reply_markup._ === 'replyInlineMarkup') {\r\n      return false;\r\n    }\r\n    var messageReplyMarkup = message.reply_markup;\r\n    var lastReplyMarkup = historyStorage.reply_markup;\r\n    if(messageReplyMarkup) {\r\n      if(lastReplyMarkup && lastReplyMarkup.mid >= message.mid) {\r\n        return false;\r\n      }\r\n\r\n      if(messageReplyMarkup.pFlags.selective) {\r\n        return false;\r\n      }\r\n\r\n      if(historyStorage.maxOutId &&\r\n        message.mid < historyStorage.maxOutId &&\r\n        messageReplyMarkup.pFlags.single_use) {\r\n        messageReplyMarkup.pFlags.hidden = true;\r\n      }\r\n      messageReplyMarkup = Object.assign({\r\n        mid: message.mid\r\n      }, messageReplyMarkup);\r\n      if(messageReplyMarkup._ !== 'replyKeyboardHide') {\r\n        messageReplyMarkup.fromId = appPeersManager.getPeerId(message.from_id);\r\n      }\r\n      historyStorage.reply_markup = messageReplyMarkup;\r\n      // this.log('set', historyStorage.reply_markup)\r\n      return true;\r\n    }\r\n\r\n    if(message.pFlags.out) {\r\n      if(lastReplyMarkup) {\r\n        if(lastReplyMarkup.pFlags.single_use &&\r\n          !lastReplyMarkup.pFlags.hidden &&\r\n          (message.mid > lastReplyMarkup.mid || message.pFlags.is_outgoing) &&\r\n          message.message) {\r\n          lastReplyMarkup.pFlags.hidden = true;\r\n          // this.log('set', historyStorage.reply_markup)\r\n          return true;\r\n        }\r\n      } else if(!historyStorage.maxOutId ||\r\n        message.mid > historyStorage.maxOutId) {\r\n        historyStorage.maxOutId = message.mid;\r\n      }\r\n    }\r\n\r\n    if(message.action &&\r\n      message.action._ === 'messageActionChatDeleteUser' &&\r\n      (lastReplyMarkup\r\n        ? message.action.user_id === lastReplyMarkup.fromId\r\n        : appUsersManager.isBot(message.action.user_id)\r\n      )\r\n    ) {\r\n      historyStorage.reply_markup = {\r\n        _: 'replyKeyboardHide',\r\n        mid: message.mid,\r\n        pFlags: {}\r\n      };\r\n      // this.log('set', historyStorage.reply_markup)\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public getSearchStorage(peerId: number, inputFilter: MyInputMessagesFilter) {\r\n    if(!this.searchesStorage[peerId]) this.searchesStorage[peerId] = {};\r\n    if(!this.searchesStorage[peerId][inputFilter]) this.searchesStorage[peerId][inputFilter] = {history: []};\r\n    return this.searchesStorage[peerId][inputFilter];\r\n  }\r\n\r\n  public getSearchCounters(peerId: number, filters: MessagesFilter[], canCache = true) {\r\n    const func = (canCache ? apiManager.invokeApiCacheable : apiManager.invokeApi).bind(apiManager);\r\n    return func('messages.getSearchCounters', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      filters\r\n    });\r\n  }\r\n\r\n  public getSearch({peerId, query, inputFilter, maxId, limit, nextRate, backLimit, threadId, folderId, minDate, maxDate}: {\r\n    peerId?: number,\r\n    maxId?: number,\r\n    limit?: number,\r\n    nextRate?: number,\r\n    backLimit?: number,\r\n    threadId?: number,\r\n    folderId?: number,\r\n    query?: string,\r\n    inputFilter?: {\r\n      _: MyInputMessagesFilter\r\n    },\r\n    minDate?: number,\r\n    maxDate?: number\r\n  }): Promise<{\r\n    count: number,\r\n    next_rate: number,\r\n    offset_id_offset: number,\r\n    history: MyMessage[]\r\n  }> {\r\n    if(!peerId) peerId = 0;\r\n    if(!query) query = '';\r\n    if(!inputFilter) inputFilter = {_: 'inputMessagesFilterEmpty'};\r\n    if(limit === undefined) limit = 20;\r\n    if(!nextRate) nextRate = 0;\r\n    if(!backLimit) backLimit = 0;\r\n\r\n    minDate = minDate ? minDate / 1000 | 0 : 0;\r\n    maxDate = maxDate ? maxDate / 1000 | 0 : 0;\r\n\r\n    const foundMsgs: Message.message[] = [];\r\n\r\n    //this.log('search', maxId);\r\n\r\n    if(backLimit) {\r\n      limit += backLimit;\r\n    }\r\n\r\n    //const beta = inputFilter._ === 'inputMessagesFilterPinned' && !backLimit;\r\n    const beta = false;\r\n\r\n    let storage: {\r\n      count?: number;\r\n      history: SlicedArray;\r\n    };\r\n\r\n    // * костыль для limit 1, если нужно и получить сообщение, и узнать количество сообщений\r\n    if(peerId && !backLimit && !maxId && !query && limit !== 1 && !threadId/*  && inputFilter._ !== 'inputMessagesFilterPinned' */) {\r\n      storage = beta ? \r\n        this.getSearchStorage(peerId, inputFilter._) as any : \r\n        this.getHistoryStorage(peerId);\r\n      let filtering = true;\r\n\r\n      const history = /* maxId ? storage.history.slice(storage.history.indexOf(maxId) + 1) :  */storage.history;\r\n\r\n      if(storage !== undefined && history.length) {\r\n        const neededContents: {\r\n          [messageMediaType: string]: boolean\r\n        } = {},\r\n          neededDocTypes: string[] = [], \r\n          excludeDocTypes: string[] = []/* ,\r\n          neededFlags: string[] = [] */;\r\n\r\n        switch(inputFilter._) {\r\n          case 'inputMessagesFilterPhotos':\r\n            neededContents['messageMediaPhoto'] = true;\r\n            break;\r\n\r\n          case 'inputMessagesFilterPhotoVideo':\r\n            neededContents['messageMediaPhoto'] = true;\r\n            neededContents['messageMediaDocument'] = true;\r\n            neededDocTypes.push('video');\r\n            break;\r\n\r\n          case 'inputMessagesFilterVideo':\r\n            neededContents['messageMediaDocument'] = true;\r\n            neededDocTypes.push('video');\r\n            break;\r\n\r\n          case 'inputMessagesFilterDocument':\r\n            neededContents['messageMediaDocument'] = true;\r\n            excludeDocTypes.push('video');\r\n            break;\r\n\r\n          case 'inputMessagesFilterVoice':\r\n            neededContents['messageMediaDocument'] = true;\r\n            neededDocTypes.push('voice');\r\n            break;\r\n\r\n          case 'inputMessagesFilterRoundVoice':\r\n            neededContents['messageMediaDocument'] = true;\r\n            neededDocTypes.push('round', 'voice');\r\n            break;\r\n\r\n          case 'inputMessagesFilterRoundVideo':\r\n            neededContents['messageMediaDocument'] = true;\r\n            neededDocTypes.push('round');\r\n            break;\r\n\r\n          case 'inputMessagesFilterMusic':\r\n            neededContents['messageMediaDocument'] = true;\r\n            neededDocTypes.push('audio');\r\n            break;\r\n\r\n          case 'inputMessagesFilterUrl':\r\n            neededContents['url'] = true;\r\n            break;\r\n\r\n          case 'inputMessagesFilterChatPhotos':\r\n            neededContents['avatar'] = true;\r\n            break;\r\n\r\n          /* case 'inputMessagesFilterPinned':\r\n            neededFlags.push('pinned');\r\n            break; */\r\n\r\n          /* case 'inputMessagesFilterMyMentions':\r\n            neededContents['mentioned'] = true;\r\n            break; */\r\n\r\n          default:\r\n            filtering = false;\r\n            break;\r\n            /* return Promise.resolve({\r\n              count: 0,\r\n              next_rate: 0,\r\n              history: [] as number[]\r\n            }); */\r\n        }\r\n\r\n        if(filtering) {\r\n          const storage = this.getMessagesStorage(peerId);\r\n          for(let i = 0, length = history.length; i < length; i++) {\r\n            const message = storage[history.slice[i]];\r\n\r\n            if(!message) continue;\r\n  \r\n            //|| (neededContents['mentioned'] && message.totalEntities.find((e: any) => e._ === 'messageEntityMention'));\r\n  \r\n            let found = false;\r\n            if(message.media && neededContents[message.media._] && !message.fwd_from) {\r\n              if(message.media._ === 'messageMediaDocument') {\r\n                if((neededDocTypes.length && !neededDocTypes.includes(message.media.document.type)) \r\n                  || excludeDocTypes.includes(message.media.document.type)) {\r\n                  continue;\r\n                }\r\n              }\r\n  \r\n              found = true;\r\n            } else if(neededContents['url'] && message.message) {\r\n              const goodEntities = ['messageEntityTextUrl', 'messageEntityUrl'];\r\n              if((message.totalEntities as MessageEntity[]).find(e => goodEntities.includes(e._)) || RichTextProcessor.matchUrl(message.message)) {\r\n                found = true;\r\n              }\r\n            } else if(neededContents['avatar'] && message.action && ['messageActionChannelEditPhoto', 'messageActionChatEditPhoto', 'messageActionChannelEditVideo', 'messageActionChatEditVideo'].includes(message.action._)) {\r\n              found = true;\r\n            }/*  else if(neededFlags.find(flag => message.pFlags[flag])) {\r\n              found = true;\r\n            } */\r\n  \r\n            if(found) {\r\n              foundMsgs.push(message);\r\n              if(foundMsgs.length >= limit) {\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if(foundMsgs.length) {\r\n      if(foundMsgs.length < limit && (beta ? storage.count !== storage.history.length : true)) {\r\n        maxId = foundMsgs[foundMsgs.length - 1].mid;\r\n        limit = limit - foundMsgs.length;\r\n      } else {\r\n        return Promise.resolve({\r\n          count: beta ? storage.count : 0,\r\n          next_rate: 0,\r\n          offset_id_offset: 0,\r\n          history: foundMsgs\r\n        });\r\n      }\r\n    } else if(beta && storage?.count) {\r\n      return Promise.resolve({\r\n        count: storage.count,\r\n        next_rate: 0,\r\n        offset_id_offset: 0,\r\n        history: []\r\n      });\r\n    }\r\n\r\n    const canCache = false && (['inputMessagesFilterChatPhotos', 'inputMessagesFilterPinned'] as MyInputMessagesFilter[]).includes(inputFilter._);\r\n    const method = (canCache ? apiManager.invokeApiCacheable : apiManager.invokeApi).bind(apiManager);\r\n\r\n    let apiPromise: Promise<any>;\r\n    if(peerId && !nextRate && folderId === undefined/*  || !query */) {\r\n      apiPromise = method('messages.search', {\r\n        peer: appPeersManager.getInputPeerById(peerId),\r\n        q: query || '',\r\n        filter: inputFilter as any as MessagesFilter,\r\n        min_date: minDate,\r\n        max_date: maxDate,\r\n        limit,\r\n        offset_id: this.getServerMessageId(maxId) || 0,\r\n        add_offset: backLimit ? -backLimit : 0,\r\n        max_id: 0,\r\n        min_id: 0,\r\n        hash: 0,\r\n        top_msg_id: this.getServerMessageId(threadId) || 0\r\n      }, {\r\n        //timeout: APITIMEOUT,\r\n        noErrorBox: true\r\n      });\r\n    } else {\r\n      //var offsetDate = 0;\r\n      let offsetPeerId = 0;\r\n      let offsetId = 0;\r\n      let offsetMessage = maxId && this.getMessageByPeer(peerId, maxId);\r\n\r\n      if(offsetMessage && offsetMessage.date) {\r\n        //offsetDate = offsetMessage.date + serverTimeManager.serverTimeOffset;\r\n        offsetId = offsetMessage.id;\r\n        offsetPeerId = this.getMessagePeer(offsetMessage);\r\n      }\r\n\r\n      apiPromise = method('messages.searchGlobal', {\r\n        q: query,\r\n        filter: inputFilter as any as MessagesFilter,\r\n        min_date: minDate,\r\n        max_date: maxDate,\r\n        offset_rate: nextRate,\r\n        offset_peer: appPeersManager.getInputPeerById(offsetPeerId),\r\n        offset_id: offsetId,\r\n        limit,\r\n        folder_id: folderId\r\n      }, {\r\n        //timeout: APITIMEOUT,\r\n        noErrorBox: true\r\n      });\r\n    }\r\n\r\n    return apiPromise.then((searchResult: any) => {\r\n      appUsersManager.saveApiUsers(searchResult.users);\r\n      appChatsManager.saveApiChats(searchResult.chats);\r\n      this.saveMessages(searchResult.messages);\r\n\r\n      /* if(beta && storage && (!maxId || storage.history[storage.history.length - 1] === maxId)) {\r\n        const storage = this.getSearchStorage(peerId, inputFilter._);\r\n        const add = (searchResult.messages.map((m: any) => m.mid) as number[]).filter(mid => storage.history.indexOf(mid) === -1);\r\n        storage.history.push(...add);\r\n        storage.history.sort((a, b) => b - a);\r\n        storage.count = searchResult.count;\r\n      } */\r\n\r\n      if(DEBUG) {\r\n        this.log('getSearch result:', inputFilter, searchResult);\r\n      }\r\n\r\n      const foundCount: number = searchResult.count || (foundMsgs.length + searchResult.messages.length);\r\n\r\n      searchResult.messages.forEach((message: any) => {\r\n        const peerId = this.getMessagePeer(message);\r\n        if(peerId < 0) {\r\n          const chat = appChatsManager.getChat(-peerId);\r\n          if(chat.migrated_to) {\r\n            this.migrateChecks(peerId, -chat.migrated_to.channel_id);\r\n          }\r\n        }\r\n\r\n        foundMsgs.push(message);\r\n      });\r\n\r\n      return {\r\n        count: foundCount,\r\n        offset_id_offset: searchResult.offset_id_offset || 0,\r\n        next_rate: searchResult.next_rate,\r\n        history: foundMsgs\r\n      };\r\n    });\r\n  }\r\n\r\n  public subscribeRepliesThread(peerId: number, mid: number) {\r\n    const repliesKey = peerId + '_' + mid;\r\n    for(const threadKey in this.threadsToReplies) {\r\n      if(this.threadsToReplies[threadKey] === repliesKey) return;\r\n    }\r\n\r\n    this.getDiscussionMessage(peerId, mid);\r\n  }\r\n\r\n  public generateThreadServiceStartMessage(message: Message.message) {\r\n    const threadKey = message.peerId + '_' + message.mid;\r\n    if(this.threadsServiceMessagesIdsStorage[threadKey]) return;\r\n\r\n    const maxMessageId = this.getServerMessageId(Math.max(...this.getMidsByMessage(message)));\r\n    const serviceStartMessage: Message.messageService = {\r\n      _: 'messageService',\r\n      pFlags: {\r\n        is_single: true\r\n      } as any,\r\n      id: this.generateMessageId(maxMessageId, true),\r\n      date: message.date,\r\n      from_id: {_: 'peerUser', user_id: 0}/* message.from_id */,\r\n      peer_id: message.peer_id,\r\n      action: {\r\n        _: 'messageActionCustomAction',\r\n        message: 'Discussion started'\r\n      },\r\n      reply_to: this.generateReplyHeader(message.id)\r\n    };\r\n\r\n    this.saveMessages([serviceStartMessage], {isOutgoing: true});\r\n    this.threadsServiceMessagesIdsStorage[threadKey] = serviceStartMessage.mid;\r\n  } \r\n\r\n  public getDiscussionMessage(peerId: number, mid: number) {\r\n    return apiManager.invokeApiSingle('messages.getDiscussionMessage', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      msg_id: this.getServerMessageId(mid)\r\n    }).then(result => {\r\n      appChatsManager.saveApiChats(result.chats);\r\n      appUsersManager.saveApiUsers(result.users);\r\n      this.saveMessages(result.messages);\r\n\r\n      const message = this.filterMessages(result.messages[0], message => !!(message as Message.message).replies)[0] as Message.message;\r\n      const threadKey = message.peerId + '_' + message.mid;\r\n\r\n      this.generateThreadServiceStartMessage(message);\r\n      \r\n      const historyStorage = this.getHistoryStorage(message.peerId, message.mid);\r\n      result.max_id = historyStorage.maxId = this.generateMessageId(result.max_id) || 0;\r\n      result.read_inbox_max_id = historyStorage.readMaxId = this.generateMessageId(result.read_inbox_max_id ?? message.mid);\r\n      result.read_outbox_max_id = historyStorage.readOutboxMaxId = this.generateMessageId(result.read_outbox_max_id) || 0;\r\n\r\n      this.threadsToReplies[threadKey] = peerId + '_' + mid;\r\n\r\n      return message;\r\n    });\r\n  }\r\n\r\n  private handleNewMessage(peerId: number, mid: number) {\r\n    if(this.newMessagesToHandle[peerId] === undefined) {\r\n      this.newMessagesToHandle[peerId] = new Set();\r\n    }\r\n\r\n    this.newMessagesToHandle[peerId].add(mid);\r\n    if(!this.newMessagesHandleTimeout) {\r\n      this.newMessagesHandleTimeout = window.setTimeout(this.handleNewMessages, 0);\r\n    }\r\n  }\r\n\r\n  handleNewMessages = () => {\r\n    clearTimeout(this.newMessagesHandleTimeout);\r\n    this.newMessagesHandleTimeout = 0;\r\n\r\n    rootScope.dispatchEvent('history_multiappend', this.newMessagesToHandle);\r\n    this.newMessagesToHandle = {};\r\n  };\r\n\r\n  handleNewDialogs = () => {\r\n    let newMaxSeenId = 0;\r\n    const obj = this.newDialogsToHandle;\r\n    for(const peerId in obj) {\r\n      const dialog = obj[peerId];\r\n      if(!dialog) {\r\n        this.reloadConversation(+peerId);\r\n        delete obj[peerId];\r\n      } else {\r\n        this.dialogsStorage.pushDialog(dialog);\r\n        if(!appPeersManager.isChannel(+peerId)) {\r\n          newMaxSeenId = Math.max(newMaxSeenId, dialog.top_message || 0);\r\n        }\r\n      }\r\n    }\r\n\r\n    //this.log('after order:', this.dialogsStorage[0].map(d => d.peerId));\r\n\r\n    if(newMaxSeenId !== 0) {\r\n      this.incrementMaxSeenId(newMaxSeenId);\r\n    }\r\n\r\n    rootScope.dispatchEvent('dialogs_multiupdate', obj);\r\n    this.newDialogsToHandle = {};\r\n  };\r\n\r\n  public scheduleHandleNewDialogs(peerId?: number, dialog?: Dialog) {\r\n    if(peerId !== undefined) {\r\n      this.newDialogsToHandle[peerId] = dialog;\r\n    }\r\n\r\n    if(this.newDialogsHandlePromise) return this.newDialogsHandlePromise;\r\n    return this.newDialogsHandlePromise = new Promise((resolve) => {\r\n      setTimeout(() => {\r\n        this.newDialogsHandlePromise = undefined;\r\n        this.handleNewDialogs();\r\n      }, 0);\r\n    });\r\n  }\r\n\r\n  public deleteMessages(peerId: number, mids: number[], revoke?: true) {\r\n    let promise: Promise<any>;\r\n\r\n    const localMessageIds = mids.map(mid => this.getServerMessageId(mid));\r\n\r\n    if(peerId < 0 && appPeersManager.isChannel(peerId)) {\r\n      const channelId = -peerId;\r\n      const channel = appChatsManager.getChat(channelId);\r\n      if(!channel.pFlags.creator && !(channel.pFlags.editor && channel.pFlags.megagroup)) {\r\n        const goodMsgIds: number[] = [];\r\n        if(channel.pFlags.editor || channel.pFlags.megagroup) {\r\n          mids.forEach((msgId, i) => {\r\n            const message = this.getMessageByPeer(peerId, mids[i]);\r\n            if(message.pFlags.out) {\r\n              goodMsgIds.push(msgId);\r\n            }\r\n          });\r\n        }\r\n\r\n        if(!goodMsgIds.length) {\r\n          return;\r\n        }\r\n\r\n        mids = goodMsgIds;\r\n      }\r\n\r\n      promise = apiManager.invokeApi('channels.deleteMessages', {\r\n        channel: appChatsManager.getChannelInput(channelId),\r\n        id: localMessageIds\r\n      }).then((affectedMessages) => {\r\n        apiUpdatesManager.processUpdateMessage({\r\n          _: 'updateShort',\r\n          update: {\r\n            _: 'updateDeleteChannelMessages',\r\n            channel_id: channelId,\r\n            messages: mids,\r\n            pts: affectedMessages.pts,\r\n            pts_count: affectedMessages.pts_count\r\n          }\r\n        });\r\n      });\r\n    } else {\r\n      promise = apiManager.invokeApi('messages.deleteMessages', {\r\n        revoke,\r\n        id: localMessageIds\r\n      }).then((affectedMessages) => {\r\n        apiUpdatesManager.processUpdateMessage({\r\n          _: 'updateShort',\r\n          update: {\r\n            _: 'updateDeleteMessages',\r\n            messages: mids,\r\n            pts: affectedMessages.pts,\r\n            pts_count: affectedMessages.pts_count\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  // TODO: cancel notification by peer when this function is being called\r\n  public readHistory(peerId: number, maxId = 0, threadId?: number, force = false) {\r\n    // return Promise.resolve();\r\n    // console.trace('start read')\r\n    this.log('readHistory:', peerId, maxId, threadId);\r\n    if(!this.getReadMaxIdIfUnread(peerId, threadId) && !force) {\r\n      this.log('readHistory: isn\\'t unread');\r\n      return Promise.resolve();\r\n    }\r\n\r\n    const historyStorage = this.getHistoryStorage(peerId, threadId);\r\n\r\n    if(historyStorage.triedToReadMaxId >= maxId) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    let apiPromise: Promise<any>;\r\n    if(threadId) {\r\n      if(!historyStorage.readPromise) {\r\n        apiPromise = apiManager.invokeApi('messages.readDiscussion', {\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          msg_id: this.getServerMessageId(threadId),\r\n          read_max_id: this.getServerMessageId(maxId)\r\n        });\r\n      }\r\n\r\n      apiUpdatesManager.processUpdateMessage({\r\n        _: 'updateShort',\r\n        update: {\r\n          _: 'updateReadChannelDiscussionInbox',\r\n          channel_id: -peerId,\r\n          top_msg_id: threadId,\r\n          read_max_id: maxId\r\n        } as Update.updateReadChannelDiscussionInbox\r\n      });\r\n    } else if(appPeersManager.isChannel(peerId)) {\r\n      if(!historyStorage.readPromise) {\r\n        apiPromise = apiManager.invokeApi('channels.readHistory', {\r\n          channel: appChatsManager.getChannelInput(-peerId),\r\n          max_id: this.getServerMessageId(maxId)\r\n        });\r\n      }\r\n\r\n      apiUpdatesManager.processUpdateMessage({\r\n        _: 'updateShort',\r\n        update: {\r\n          _: 'updateReadChannelInbox',\r\n          max_id: maxId,\r\n          channel_id: -peerId\r\n        } as Update.updateReadChannelInbox\r\n      });\r\n    } else {\r\n      if(!historyStorage.readPromise) {\r\n        apiPromise = apiManager.invokeApi('messages.readHistory', {\r\n          peer: appPeersManager.getInputPeerById(peerId),\r\n          max_id: this.getServerMessageId(maxId)\r\n        }).then((affectedMessages) => {\r\n          apiUpdatesManager.processUpdateMessage({\r\n            _: 'updateShort',\r\n            update: {\r\n              _: 'updatePts',\r\n              pts: affectedMessages.pts,\r\n              pts_count: affectedMessages.pts_count\r\n            }\r\n          });\r\n        });\r\n      }\r\n\r\n      apiUpdatesManager.processUpdateMessage({\r\n        _: 'updateShort',\r\n        update: {\r\n          _: 'updateReadHistoryInbox',\r\n          max_id: maxId,\r\n          peer: appPeersManager.getOutputPeer(peerId)\r\n        } as Update.updateReadHistoryInbox\r\n      });\r\n    }\r\n\r\n    appNotificationsManager.soundReset(appPeersManager.getPeerString(peerId));\r\n\r\n    if(historyStorage.readPromise) {\r\n      return historyStorage.readPromise;\r\n    }\r\n\r\n    historyStorage.triedToReadMaxId = maxId;\r\n\r\n    apiPromise.finally(() => {\r\n      delete historyStorage.readPromise;\r\n\r\n      this.log('readHistory: promise finally', maxId, historyStorage.readMaxId);\r\n\r\n      if(historyStorage.readMaxId > maxId) {\r\n        this.readHistory(peerId, historyStorage.readMaxId, threadId, true);\r\n      }\r\n    });\r\n\r\n    return historyStorage.readPromise = apiPromise;\r\n  }\r\n\r\n  public readAllHistory(peerId: number, threadId?: number, force = false) {\r\n    const historyStorage = this.getHistoryStorage(peerId, threadId);\r\n    if(historyStorage.maxId) {\r\n      this.readHistory(peerId, historyStorage.maxId, threadId, force); // lol\r\n    }\r\n  }\r\n\r\n  public readMessages(peerId: number, msgIds: number[]) {\r\n    msgIds = msgIds.map(mid => this.getServerMessageId(mid));\r\n    if(peerId < 0 && appPeersManager.isChannel(peerId)) {\r\n      const channelId = -peerId;\r\n      apiManager.invokeApi('channels.readMessageContents', {\r\n        channel: appChatsManager.getChannelInput(channelId),\r\n        id: msgIds\r\n      }).then(() => {\r\n        apiUpdatesManager.processUpdateMessage({\r\n          _: 'updateShort',\r\n          update: {\r\n            _: 'updateChannelReadMessagesContents',\r\n            channel_id: channelId,\r\n            messages: msgIds\r\n          } as Update.updateChannelReadMessagesContents\r\n        });\r\n      });\r\n    } else {\r\n      apiManager.invokeApi('messages.readMessageContents', {\r\n        id: msgIds\r\n      }).then((affectedMessages) => {\r\n        apiUpdatesManager.processUpdateMessage({\r\n          _: 'updateShort',\r\n          update: {\r\n            _: 'updateReadMessagesContents',\r\n            messages: msgIds,\r\n            pts: affectedMessages.pts,\r\n            pts_count: affectedMessages.pts_count\r\n          } as Update.updateReadMessagesContents\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  public getHistoryStorage(peerId: number, threadId?: number) {\r\n    if(threadId) {\r\n      //threadId = this.getLocalMessageId(threadId);\r\n      if(!this.threadsStorage[peerId]) this.threadsStorage[peerId] = {};\r\n      return this.threadsStorage[peerId][threadId] ?? (this.threadsStorage[peerId][threadId] = {count: null, history: new SlicedArray()});\r\n    }\r\n\r\n    return this.historiesStorage[peerId] ?? (this.historiesStorage[peerId] = {count: null, history: new SlicedArray()});\r\n  }\r\n\r\n  private handleNotifications = () => {\r\n    window.clearTimeout(this.notificationsHandlePromise);\r\n    this.notificationsHandlePromise = 0;\r\n\r\n    //var timeout = $rootScope.idle.isIDLE && StatusManager.isOtherDeviceActive() ? 30000 : 1000;\r\n    //const timeout = 1000;\r\n\r\n    for(const _peerId in this.notificationsToHandle) {\r\n      const peerId = +_peerId;\r\n\r\n      if(rootScope.peerId === peerId && !rootScope.idle.isIDLE) {\r\n        continue;\r\n      }\r\n\r\n      const notifyPeerToHandle = this.notificationsToHandle[peerId];\r\n\r\n      Promise.all([\r\n        appNotificationsManager.getNotifyPeerTypeSettings(),\r\n        appNotificationsManager.getNotifySettings(appPeersManager.getInputNotifyPeerById(peerId, true))\r\n      ]).then(([_, peerTypeNotifySettings]) => {\r\n        const topMessage = notifyPeerToHandle.topMessage;\r\n        if(appNotificationsManager.isPeerLocalMuted(peerId, true) || !topMessage.pFlags.unread) {\r\n          return;\r\n        }\r\n\r\n        //setTimeout(() => {\r\n          if(topMessage.pFlags.unread) {\r\n            this.notifyAboutMessage(topMessage, {\r\n              fwdCount: notifyPeerToHandle.fwdCount,\r\n              peerTypeNotifySettings\r\n            });\r\n          }\r\n        //}, timeout);\r\n      });\r\n    }\r\n\r\n    this.notificationsToHandle = {};\r\n  };\r\n\r\n  private onUpdateMessageId = (update: Update.updateMessageID) => {\r\n    const randomId = update.random_id;\r\n    const pendingData = this.pendingByRandomId[randomId];\r\n    //this.log('AMM updateMessageID:', update, pendingData);\r\n    if(pendingData) {\r\n      const {peerId, tempId, threadId, storage} = pendingData;\r\n      //const mid = update.id;\r\n      const mid = this.generateMessageId(update.id);\r\n      const message = this.getMessageFromStorage(storage, mid);\r\n      if(!message.deleted) {\r\n        [this.getHistoryStorage(peerId), threadId ? this.getHistoryStorage(peerId, threadId) : undefined]\r\n        .filter(Boolean)\r\n        .forEach(storage => {\r\n          storage.history.delete(tempId);\r\n        });\r\n\r\n        this.finalizePendingMessageCallbacks(storage, tempId, mid);\r\n      } else {\r\n        this.pendingByMessageId[mid] = randomId;\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateNewMessage = (update: Update.updateNewDiscussionMessage | Update.updateNewMessage | Update.updateNewChannelMessage) => {\r\n    const message = update.message as MyMessage;\r\n    const peerId = this.getMessagePeer(message);\r\n    const storage = this.getMessagesStorage(peerId);\r\n    const dialog = this.getDialogOnly(peerId);\r\n\r\n    // * local update\r\n    const isLocalThreadUpdate = update._ === 'updateNewDiscussionMessage';\r\n\r\n    // * temporary save the message for info (peerId, reply mids...)\r\n    this.saveMessages([message], {storage: {}});\r\n\r\n    const threadKey = this.getThreadKey(message);\r\n    const threadId = threadKey ? +threadKey.split('_')[1] : undefined;\r\n    if(threadId && !isLocalThreadUpdate && this.threadsStorage[peerId] && this.threadsStorage[peerId][threadId]) {\r\n      const update = {\r\n        _: 'updateNewDiscussionMessage',\r\n        message\r\n      } as Update.updateNewDiscussionMessage;\r\n\r\n      this.onUpdateNewMessage(update);\r\n    }\r\n\r\n    if(!dialog && !isLocalThreadUpdate) {\r\n      let good = true;\r\n      if(peerId < 0) {\r\n        good = appChatsManager.isInChat(-peerId);\r\n      }\r\n\r\n      if(good) {\r\n        const set = this.newUpdatesAfterReloadToHandle[peerId] ?? (this.newUpdatesAfterReloadToHandle[peerId] = new Set());\r\n        if(set.has(update)) {\r\n          this.log.error('here we go again', peerId);\r\n          return;\r\n        }\r\n\r\n        this.scheduleHandleNewDialogs(peerId);\r\n        set.add(update);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    /* if(update._ === 'updateNewChannelMessage') {\r\n      const chat = appChatsManager.getChat(-peerId);\r\n      if(chat.pFlags && (chat.pFlags.left || chat.pFlags.kicked)) {\r\n        return;\r\n      }\r\n    } */\r\n\r\n    this.saveMessages([message], {storage});\r\n    // this.log.warn(dT(), 'message unread', message.mid, message.pFlags.unread)\r\n\r\n    /* if((message as Message.message).grouped_id) {\r\n      this.log('updateNewMessage', message);\r\n    } */\r\n\r\n    const pendingMessage = this.checkPendingMessage(message);\r\n    const historyStorage = this.getHistoryStorage(peerId, isLocalThreadUpdate ? threadId : undefined);\r\n\r\n    if(!isLocalThreadUpdate) {\r\n      this.updateMessageRepliesIfNeeded(message);\r\n    }\r\n\r\n    if(historyStorage.history.findSlice(message.mid)) {\r\n      return false;\r\n    }\r\n\r\n    // * catch situation with disconnect. if message's id is lower than we already have (in bottom end slice), will sort it\r\n    const firstSlice = historyStorage.history.first;\r\n    if(firstSlice.isEnd(SliceEnd.Bottom)) {\r\n      let i = 0;\r\n      for(const length = firstSlice.length; i < length; ++i) {\r\n        if(message.mid > firstSlice[i]) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      firstSlice.splice(i, 0, message.mid);\r\n    } else {\r\n      historyStorage.history.unshift(message.mid);\r\n    }\r\n\r\n    if(historyStorage.count !== null) {\r\n      historyStorage.count++;\r\n    }\r\n\r\n    if(this.mergeReplyKeyboard(historyStorage, message)) {\r\n      rootScope.dispatchEvent('history_reply_markup', {peerId});\r\n    }\r\n\r\n    if(message.fromId > 0 && !message.pFlags.out && message.from_id) {\r\n      appUsersManager.forceUserOnline(message.fromId, message.date);\r\n    }\r\n\r\n    if(!pendingMessage) {\r\n      this.handleNewMessage(peerId, message.mid);\r\n    }\r\n\r\n    if(isLocalThreadUpdate) {\r\n      return;\r\n    }\r\n    \r\n    const inboxUnread = !message.pFlags.out && message.pFlags.unread;\r\n    if(dialog) {\r\n      this.setDialogTopMessage(message, dialog);\r\n      if(inboxUnread) {\r\n        dialog.unread_count++;\r\n      }\r\n    }\r\n\r\n    if(inboxUnread/*  && ($rootScope.selectedPeerID != peerID || $rootScope.idle.isIDLE) */) {\r\n      const notifyPeer = message.peerId;\r\n      let notifyPeerToHandle = this.notificationsToHandle[notifyPeer];\r\n      if(notifyPeerToHandle === undefined) {\r\n        notifyPeerToHandle = this.notificationsToHandle[notifyPeer] = {\r\n          fwdCount: 0,\r\n          fromId: 0\r\n        };\r\n      }\r\n\r\n      if(notifyPeerToHandle.fromId !== message.fromId) {\r\n        notifyPeerToHandle.fromId = message.fromId;\r\n        notifyPeerToHandle.fwdCount = 0;\r\n      }\r\n\r\n      if((message as Message.message).fwd_from) {\r\n        notifyPeerToHandle.fwdCount++;\r\n      }\r\n\r\n      notifyPeerToHandle.topMessage = message;\r\n\r\n      if(!this.notificationsHandlePromise) {\r\n        this.notificationsHandlePromise = window.setTimeout(this.handleNotifications, 0);\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateDialogUnreadMark = (update: Update.updateDialogUnreadMark) => {\r\n    //this.log('updateDialogUnreadMark', update);\r\n    const peerId = appPeersManager.getPeerId((update.peer as DialogPeer.dialogPeer).peer);\r\n    const dialog = this.getDialogOnly(peerId);\r\n\r\n    if(!dialog) {\r\n      this.scheduleHandleNewDialogs(peerId);\r\n    } else {\r\n      if(!update.pFlags.unread) {\r\n        delete dialog.pFlags.unread_mark;\r\n      } else {\r\n        dialog.pFlags.unread_mark = true;\r\n      }\r\n\r\n      rootScope.dispatchEvent('dialogs_multiupdate', {[peerId]: dialog});\r\n      this.dialogsStorage.setDialogToState(dialog);\r\n    }\r\n  };\r\n\r\n  private onUpdateEditMessage = (update: Update.updateEditMessage | Update.updateEditChannelMessage) => {\r\n    const message = update.message as MyMessage;\r\n    const peerId = this.getMessagePeer(message);\r\n    const mid = this.generateMessageId(message.id);\r\n    const storage = this.getMessagesStorage(peerId);\r\n    if(storage[mid] === undefined) {\r\n      return;\r\n    }\r\n\r\n    // console.trace(dT(), 'edit message', message)\r\n    \r\n    const oldMessage = this.getMessageFromStorage(storage, mid);\r\n    this.saveMessages([message], {storage});\r\n    const newMessage = this.getMessageFromStorage(storage, mid);\r\n\r\n    this.handleEditedMessage(oldMessage, newMessage);\r\n\r\n    const dialog = this.getDialogOnly(peerId);\r\n    const isTopMessage = dialog && dialog.top_message === mid;\r\n    // @ts-ignore\r\n    if(message.clear_history) { // that's will never happen\r\n      if(isTopMessage) {\r\n        rootScope.dispatchEvent('dialog_flush', {peerId});\r\n      }\r\n    } else {\r\n      rootScope.dispatchEvent('message_edit', {\r\n        storage,\r\n        peerId,\r\n        mid\r\n      });\r\n\r\n      if(isTopMessage || (message as Message.message).grouped_id) {\r\n        const updatedDialogs: {[peerId: number]: Dialog} = {};\r\n        updatedDialogs[peerId] = dialog;\r\n        rootScope.dispatchEvent('dialogs_multiupdate', updatedDialogs);\r\n        this.dialogsStorage.setDialogToState(dialog);\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateReadHistory = (update: Update.updateReadChannelDiscussionInbox | Update.updateReadChannelDiscussionOutbox \r\n    | Update.updateReadHistoryInbox | Update.updateReadHistoryOutbox \r\n    | Update.updateReadChannelInbox | Update.updateReadChannelOutbox) => {\r\n    const channelId = (update as Update.updateReadChannelInbox).channel_id;\r\n    const maxId = this.generateMessageId((update as Update.updateReadChannelInbox).max_id || (update as Update.updateReadChannelDiscussionInbox).read_max_id);\r\n    const threadId = this.generateMessageId((update as Update.updateReadChannelDiscussionInbox).top_msg_id);\r\n    const peerId = channelId ? -channelId : appPeersManager.getPeerId((update as Update.updateReadHistoryInbox).peer);\r\n\r\n    const isOut = update._ === 'updateReadHistoryOutbox' || update._ === 'updateReadChannelOutbox' || update._ === 'updateReadChannelDiscussionOutbox' ? true : undefined;\r\n\r\n    const storage = this.getMessagesStorage(peerId);\r\n    const history = getObjectKeysAndSort(storage, 'desc');\r\n    const foundDialog = this.getDialogOnly(peerId);\r\n    const stillUnreadCount = (update as Update.updateReadChannelInbox).still_unread_count;\r\n    let newUnreadCount = 0;\r\n    let foundAffected = false;\r\n\r\n    //this.log.warn(dT(), 'read', peerId, isOut ? 'out' : 'in', maxId)\r\n\r\n    const historyStorage = this.getHistoryStorage(peerId, threadId);\r\n\r\n    if(peerId > 0 && isOut) {\r\n      appUsersManager.forceUserOnline(peerId);\r\n    }\r\n\r\n    if(threadId) {\r\n      const repliesKey = this.threadsToReplies[peerId + '_' + threadId];\r\n      if(repliesKey) {\r\n        const [peerId, mid] = repliesKey.split('_').map(n => +n);\r\n        this.updateMessage(peerId, mid, 'replies_updated');\r\n      }\r\n    }\r\n\r\n    for(let i = 0, length = history.length; i < length; i++) {\r\n      const messageId = history[i];\r\n      if(messageId > maxId) {\r\n        continue;\r\n      }\r\n      \r\n      const message = storage[messageId];\r\n\r\n      if(message.pFlags.out !== isOut) {\r\n        continue;\r\n      }\r\n\r\n      if(!message.pFlags.unread) {\r\n        break;\r\n      }\r\n\r\n      if(threadId) {\r\n        const replyTo = message.reply_to as MessageReplyHeader;\r\n        if(!replyTo || (replyTo.reply_to_top_id || replyTo.reply_to_msg_id) !== threadId) {\r\n          continue;\r\n        }\r\n      }\r\n      \r\n      // this.log.warn('read', messageId, message.pFlags.unread, message)\r\n      if(message.pFlags.unread) {\r\n        delete message.pFlags.unread;\r\n        if(!foundAffected) {\r\n          foundAffected = true;\r\n        }\r\n\r\n        if(!message.pFlags.out && !threadId && foundDialog && stillUnreadCount === undefined) {\r\n          newUnreadCount = --foundDialog.unread_count;\r\n        }\r\n        \r\n        appNotificationsManager.cancel('msg' + messageId);\r\n      }\r\n    }\r\n\r\n    if(isOut) historyStorage.readOutboxMaxId = maxId;\r\n    else historyStorage.readMaxId = maxId;\r\n\r\n    if(!threadId && foundDialog) {\r\n      if(isOut) foundDialog.read_outbox_max_id = maxId;\r\n      else foundDialog.read_inbox_max_id = maxId;\r\n\r\n      if(!isOut) {\r\n        if(newUnreadCount < 0 || !this.getReadMaxIdIfUnread(peerId)) {\r\n          foundDialog.unread_count = 0;\r\n        } else if(newUnreadCount && foundDialog.top_message > maxId) {\r\n          foundDialog.unread_count = newUnreadCount;\r\n        }\r\n      }\r\n      \r\n      rootScope.dispatchEvent('dialog_unread', {peerId});\r\n      this.dialogsStorage.setDialogToState(foundDialog);\r\n    }\r\n\r\n    if(foundAffected) {\r\n      rootScope.dispatchEvent('messages_read');\r\n    }\r\n\r\n    if(!threadId && channelId) {\r\n      const threadKeyPart = peerId + '_';\r\n      for(const threadKey in this.threadsToReplies) {\r\n        if(threadKey.indexOf(threadKeyPart) === 0) {\r\n          const [peerId, mid] = this.threadsToReplies[threadKey].split('_').map(n => +n);\r\n          rootScope.dispatchEvent('replies_updated', this.getMessageByPeer(peerId, mid));\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateReadMessagesContents = (update: Update.updateChannelReadMessagesContents | Update.updateReadMessagesContents) => {\r\n    const channelId = (update as Update.updateChannelReadMessagesContents).channel_id;\r\n    const mids = (update as Update.updateReadMessagesContents).messages.map(id => this.generateMessageId(id));\r\n    const peerId = channelId ? -channelId : this.getMessageById(mids[0]).peerId;\r\n    for(const mid of mids) {\r\n      const message = this.getMessageByPeer(peerId, mid);\r\n      if(!message.deleted) {\r\n        delete message.pFlags.media_unread;\r\n        this.setDialogToStateIfMessageIsTop(message);\r\n      }\r\n    }\r\n\r\n    rootScope.dispatchEvent('messages_media_read', {peerId, mids});\r\n  };\r\n\r\n  private onUpdateChannelAvailableMessages = (update: Update.updateChannelAvailableMessages) => {\r\n    const channelId: number = update.channel_id;\r\n    const messages: number[] = [];\r\n    const peerId: number = -channelId;\r\n    const history = this.getHistoryStorage(peerId).history.slice;\r\n    if(history.length) {\r\n      history.forEach((msgId: number) => {\r\n        if(!update.available_min_id || msgId <= update.available_min_id) {\r\n          messages.push(msgId);\r\n        }\r\n      });\r\n    }\r\n\r\n    (update as any as Update.updateDeleteChannelMessages).messages = messages;\r\n    this.onUpdateDeleteMessages(update as any as Update.updateDeleteChannelMessages);\r\n  };\r\n\r\n  private onUpdateDeleteMessages = (update: Update.updateDeleteMessages | Update.updateDeleteChannelMessages) => {\r\n    const channelId: number = (update as Update.updateDeleteChannelMessages).channel_id;\r\n    //const messages = (update as any as Update.updateDeleteChannelMessages).messages;\r\n    const messages = (update as any as Update.updateDeleteChannelMessages).messages.map(id => this.generateMessageId(id));\r\n    const peerId: number = channelId ? -channelId : this.getMessageById(messages[0]).peerId;\r\n    \r\n    if(!peerId) {\r\n      return;\r\n    }\r\n\r\n    apiManager.clearCache('messages.getSearchCounters', (params) => {\r\n      return appPeersManager.getPeerId(params.peer) === peerId;\r\n    });\r\n\r\n    const threadKeys: Set<string> = new Set();\r\n    for(const mid of messages) {\r\n      const message = this.getMessageByPeer(peerId, mid);\r\n      const threadKey = this.getThreadKey(message);\r\n      if(threadKey && this.threadsStorage[peerId] && this.threadsStorage[peerId][+threadKey.split('_')[1]]) {\r\n        threadKeys.add(threadKey);\r\n      }\r\n    }\r\n    \r\n    const historyUpdated = this.handleDeletedMessages(peerId, this.getMessagesStorage(peerId), messages);\r\n\r\n    const threadsStorages = Array.from(threadKeys).map(threadKey => {\r\n      const splitted = threadKey.split('_');\r\n      return this.getHistoryStorage(+splitted[0], +splitted[1]);\r\n    });\r\n\r\n    [this.getHistoryStorage(peerId)].concat(threadsStorages).forEach(historyStorage => {\r\n      for(const mid in historyUpdated.msgs) {\r\n        historyStorage.history.delete(+mid);\r\n      }\r\n      if(historyUpdated.count &&\r\n        historyStorage.count !== null &&\r\n        historyStorage.count > 0) {\r\n        historyStorage.count -= historyUpdated.count;\r\n        if(historyStorage.count < 0) {\r\n          historyStorage.count = 0;\r\n        }\r\n      }\r\n    });\r\n\r\n    rootScope.dispatchEvent('history_delete', {peerId, msgs: historyUpdated.msgs});\r\n\r\n    const foundDialog = this.getDialogOnly(peerId);\r\n    if(foundDialog) {\r\n      if(historyUpdated.unread) {\r\n        foundDialog.unread_count -= historyUpdated.unread;\r\n\r\n        rootScope.dispatchEvent('dialog_unread', {peerId});\r\n      }\r\n\r\n      if(historyUpdated.msgs[foundDialog.top_message]) {\r\n        this.reloadConversation(peerId);\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateChannel = (update: Update.updateChannel) => {\r\n    const channelId: number = update.channel_id;\r\n    const peerId = -channelId;\r\n    const channel: Chat.channel = appChatsManager.getChat(channelId);\r\n\r\n    const needDialog = appChatsManager.isInChat(channelId);\r\n    \r\n    const canViewHistory = !!channel.username || !channel.pFlags.left;\r\n    const hasHistory = this.historiesStorage[peerId] !== undefined;\r\n    \r\n    if(canViewHistory !== hasHistory) {\r\n      delete this.historiesStorage[peerId];\r\n      rootScope.dispatchEvent('history_forbidden', peerId);\r\n    }\r\n    \r\n    const dialog = this.getDialogOnly(peerId);\r\n    if(!!dialog !== needDialog) {\r\n      if(needDialog) {\r\n        this.reloadConversation(-channelId);\r\n      } else {\r\n        if(dialog) {\r\n          this.dialogsStorage.dropDialog(peerId);\r\n          rootScope.dispatchEvent('dialog_drop', {peerId, dialog});\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateChannelReload = (update: any) => {\r\n    // @ts-ignore\r\n    const channelId: number = update.channel_id;\r\n    const peerId = -channelId;\r\n\r\n    this.dialogsStorage.dropDialog(peerId);\r\n\r\n    delete this.historiesStorage[peerId];\r\n    this.reloadConversation(-channelId).then(() => {\r\n      rootScope.dispatchEvent('history_reload', peerId);\r\n    });\r\n  };\r\n  \r\n  private onUpdateChannelMessageViews = (update: Update.updateChannelMessageViews) => {\r\n    const views = update.views;\r\n    //const mid = update.id;\r\n    const mid = this.generateMessageId(update.id);\r\n    const message = this.getMessageByPeer(-update.channel_id, mid);\r\n    if(!message.deleted && message.views && message.views < views) {\r\n      message.views = views;\r\n      rootScope.dispatchEvent('message_views', {mid, views});\r\n    }\r\n  };\r\n\r\n  private onUpdateServiceNotification = (update: Update.updateServiceNotification) => {\r\n    //this.log('updateServiceNotification', update);\r\n    const fromId = 777000;\r\n    const peerId = fromId;\r\n    const messageId = this.generateTempMessageId(peerId);\r\n    const message: any = {\r\n      _: 'message',\r\n      id: messageId,\r\n      from_id: appPeersManager.getOutputPeer(fromId),\r\n      peer_id: appPeersManager.getOutputPeer(peerId),\r\n      pFlags: {unread: true},\r\n      date: (update.inbox_date || tsNow(true)) + serverTimeManager.serverTimeOffset,\r\n      message: update.message,\r\n      media: update.media,\r\n      entities: update.entities\r\n    };\r\n    if(!appUsersManager.hasUser(fromId)) {\r\n      appUsersManager.saveApiUsers([{\r\n        _: 'user',\r\n        id: fromId,\r\n        pFlags: {verified: true},\r\n        access_hash: 0,\r\n        first_name: 'Telegram',\r\n        phone: '42777'\r\n      }]);\r\n    }\r\n    this.saveMessages([message], {isOutgoing: true});\r\n\r\n    if(update.inbox_date) {\r\n      this.pendingTopMsgs[peerId] = messageId;\r\n      this.onUpdateNewMessage({\r\n        _: 'updateNewMessage',\r\n        message\r\n      } as any);\r\n    }\r\n  };\r\n\r\n  private onUpdatePinnedMessages = (update: Update.updatePinnedMessages | Update.updatePinnedChannelMessages) => {\r\n    const channelId = update._ === 'updatePinnedChannelMessages' ? update.channel_id : undefined;\r\n    const peerId = channelId ? -channelId : appPeersManager.getPeerId((update as Update.updatePinnedMessages).peer);\r\n\r\n    /* const storage = this.getSearchStorage(peerId, 'inputMessagesFilterPinned');\r\n    if(storage.count !== storage.history.length) {\r\n      if(storage.count !== undefined) {\r\n        delete this.searchesStorage[peerId]['inputMessagesFilterPinned'];  \r\n      }\r\n\r\n      rootScope.broadcast('peer_pinned_messages', peerId);\r\n      break;\r\n    } */\r\n\r\n    const messages = update.messages.map(id => this.generateMessageId(id)); \r\n\r\n    const storage = this.getMessagesStorage(peerId);\r\n    const missingMessages = messages.filter(mid => !storage[mid]);\r\n    const getMissingPromise = missingMessages.length ? Promise.all(missingMessages.map(mid => this.wrapSingleMessage(peerId, mid))) : Promise.resolve();\r\n    getMissingPromise.finally(() => {\r\n      const werePinned = update.pFlags?.pinned;\r\n      if(werePinned) {\r\n        for(const mid of messages) {\r\n          //storage.history.push(mid);\r\n          const message = storage[mid];\r\n          message.pFlags.pinned = true;\r\n        }\r\n\r\n        /* if(this.pinnedMessages[peerId]?.maxId) {\r\n          const maxMid = Math.max(...messages);\r\n          this.pinnedMessages\r\n        } */\r\n\r\n        //storage.history.sort((a, b) => b - a);\r\n      } else {\r\n        for(const mid of messages) {\r\n          //storage.history.findAndSplice(_mid => _mid === mid);\r\n          const message = storage[mid];\r\n          delete message.pFlags.pinned;\r\n        }\r\n      }\r\n\r\n      /* const info = this.pinnedMessages[peerId];\r\n      if(info) {\r\n        info.count += messages.length * (werePinned ? 1 : -1);\r\n      } */\r\n  \r\n      delete this.pinnedMessages[peerId];\r\n      appStateManager.getState().then(state => {\r\n        delete state.hiddenPinnedMessages[peerId];\r\n        rootScope.dispatchEvent('peer_pinned_messages', {peerId, mids: messages, pinned: werePinned});\r\n      });\r\n    });\r\n  };\r\n\r\n  private onUpdateNotifySettings = (update: Update.updateNotifySettings) => {\r\n    const {peer, notify_settings} = update;\r\n    if(peer._ === 'notifyPeer') {\r\n      const peerId = appPeersManager.getPeerId((peer as NotifyPeer.notifyPeer).peer);\r\n    \r\n      const dialog = this.getDialogOnly(peerId);\r\n      if(dialog) {\r\n        dialog.notify_settings = notify_settings;\r\n        rootScope.dispatchEvent('dialog_notify_settings', dialog);\r\n        this.dialogsStorage.setDialogToState(dialog);\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateNewScheduledMessage = (update: Update.updateNewScheduledMessage) => {\r\n    const message = update.message as MyMessage;\r\n    const peerId = this.getMessagePeer(message);\r\n\r\n    const storage = this.scheduledMessagesStorage[peerId];\r\n    if(storage) {\r\n      const mid = this.generateMessageId(message.id);\r\n\r\n      const oldMessage = this.getMessageFromStorage(storage, mid);\r\n      this.saveMessages([message], {storage, isScheduled: true});\r\n      const newMessage = this.getMessageFromStorage(storage, mid);\r\n\r\n      if(!oldMessage.deleted) {\r\n        this.handleEditedMessage(oldMessage, newMessage);\r\n        rootScope.dispatchEvent('message_edit', {storage, peerId, mid: message.mid});\r\n      } else {\r\n        const pendingMessage = this.checkPendingMessage(message);\r\n        if(!pendingMessage) {\r\n          rootScope.dispatchEvent('scheduled_new', {peerId, mid: message.mid});\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private onUpdateDeleteScheduledMessages = (update: Update.updateDeleteScheduledMessages) => {\r\n    const peerId = appPeersManager.getPeerId(update.peer);\r\n\r\n    const storage = this.scheduledMessagesStorage[peerId];\r\n    if(storage) {\r\n      const mids = update.messages.map(id => this.generateMessageId(id));\r\n      this.handleDeletedMessages(peerId, storage, mids);\r\n\r\n      rootScope.dispatchEvent('scheduled_delete', {peerId, mids});\r\n    }\r\n  };\r\n\r\n  public setDialogToStateIfMessageIsTop(message: any) {\r\n    const dialog = this.getDialogOnly(message.peerId);\r\n    if(dialog && dialog.top_message === message.mid) {\r\n      this.dialogsStorage.setDialogToState(dialog);\r\n    }\r\n  }\r\n\r\n  private updateMessageRepliesIfNeeded(threadMessage: MyMessage) {\r\n    try { // * на всякий случай, скорее всего это не понадобится\r\n      const threadKey = this.getThreadKey(threadMessage);\r\n      if(threadKey) {\r\n        const repliesKey = this.threadsToReplies[threadKey];\r\n        if(repliesKey) {\r\n          const [peerId, mid] = repliesKey.split('_').map(n => +n);\r\n\r\n          this.updateMessage(peerId, mid, 'replies_updated');\r\n        }\r\n      }\r\n    } catch(err) {\r\n      this.log.error('incrementMessageReplies err', err, threadMessage);\r\n    }\r\n  }\r\n\r\n  private getThreadKey(threadMessage: MyMessage) {\r\n    let threadKey = '';\r\n    if(threadMessage.peerId < 0 && threadMessage.reply_to) {\r\n      const threadId = threadMessage.reply_to.reply_to_top_id || threadMessage.reply_to.reply_to_msg_id;\r\n      threadKey = threadMessage.peerId + '_' + threadId;\r\n    }\r\n\r\n    return threadKey;\r\n  }\r\n\r\n  public updateMessage(peerId: number, mid: number, broadcastEventName?: 'replies_updated'): Promise<Message.message> {\r\n    const promise: Promise<Message.message> = this.wrapSingleMessage(peerId, mid, true).then(() => {\r\n      const message = this.getMessageByPeer(peerId, mid);\r\n\r\n      if(broadcastEventName) {\r\n        rootScope.dispatchEvent(broadcastEventName, message);\r\n      }\r\n\r\n      return message;\r\n    });\r\n    \r\n    return promise;\r\n  }\r\n\r\n  private checkPendingMessage(message: any) {\r\n    const randomId = this.pendingByMessageId[message.mid];\r\n    let pendingMessage: any;\r\n    if(randomId) {\r\n      const pendingData = this.pendingByRandomId[randomId];\r\n      if(pendingMessage = this.finalizePendingMessage(randomId, message)) {\r\n        rootScope.dispatchEvent('history_update', {storage: pendingData.storage, peerId: message.peerId, mid: message.mid});\r\n      }\r\n\r\n      delete this.pendingByMessageId[message.mid];\r\n    }\r\n\r\n    return pendingMessage;\r\n  }\r\n\r\n  public mutePeer(peerId: number, mute?: boolean) {\r\n    const settings: InputPeerNotifySettings = {\r\n      _: 'inputPeerNotifySettings'\r\n    };\r\n\r\n    if(mute === undefined) {\r\n      mute = !appNotificationsManager.isPeerLocalMuted(peerId, false);\r\n    }\r\n    \r\n    settings.mute_until = mute ? 0x7FFFFFFF : 0;\r\n\r\n    return appNotificationsManager.updateNotifySettings({\r\n      _: 'inputNotifyPeer',\r\n      peer: appPeersManager.getInputPeerById(peerId)\r\n    }, settings);\r\n  }\r\n\r\n  public canWriteToPeer(peerId: number, threadId?: number) {\r\n    if(peerId < 0) {\r\n      const isChannel = appPeersManager.isChannel(peerId);\r\n      const hasRights = isChannel && appChatsManager.hasRights(-peerId, 'send_messages', undefined, !!threadId); \r\n      return !isChannel || hasRights;\r\n    } else {\r\n      return appUsersManager.canSendToUser(peerId);\r\n    }\r\n  }\r\n\r\n  public finalizePendingMessage(randomId: string, finalMessage: any) {\r\n    const pendingData = this.pendingByRandomId[randomId];\r\n    // this.log('pdata', randomID, pendingData)\r\n\r\n    if(pendingData) {\r\n      const {peerId, tempId, threadId, storage} = pendingData;\r\n\r\n      [this.getHistoryStorage(peerId), threadId ? this.getHistoryStorage(peerId, threadId) : undefined]\r\n      .filter(Boolean)\r\n      .forEach(storage => {\r\n        storage.history.delete(tempId);\r\n      });\r\n\r\n      // this.log('pending', randomID, historyStorage.pending)\r\n\r\n      const message = this.getMessageFromStorage(storage, tempId);\r\n      if(!message.deleted) {\r\n        delete message.pFlags.is_outgoing;\r\n        delete message.pending;\r\n        delete message.error;\r\n        delete message.random_id;\r\n        delete message.send;\r\n\r\n        rootScope.dispatchEvent('messages_pending');\r\n      }\r\n      \r\n      delete this.pendingByRandomId[randomId];\r\n\r\n      this.finalizePendingMessageCallbacks(storage, tempId, finalMessage.mid);\r\n\r\n      return message;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public finalizePendingMessageCallbacks(storage: MessagesStorage, tempId: number, mid: number) {\r\n    const message = this.getMessageFromStorage(storage, mid);\r\n    const callbacks = this.tempFinalizeCallbacks[tempId];\r\n    //this.log.warn(callbacks, tempId);\r\n    if(callbacks !== undefined) {\r\n      for(const name in callbacks) {\r\n        const {deferred, callback} = callbacks[name];\r\n        //this.log(`finalizePendingMessageCallbacks: will invoke ${name} callback`);\r\n        callback(message).then(deferred.resolve, deferred.reject);\r\n      }\r\n\r\n      delete this.tempFinalizeCallbacks[tempId];\r\n    }\r\n\r\n    // set cached url to media\r\n    if(message.media) {\r\n      if(message.media.photo) {\r\n        const photo = appPhotosManager.getPhoto('' + tempId);\r\n        if(/* photo._ !== 'photoEmpty' */photo) {\r\n          const newPhoto = message.media.photo as MyPhoto;\r\n          const newPhotoSize = newPhoto.sizes[newPhoto.sizes.length - 1];\r\n          const cacheContext = appDownloadManager.getCacheContext(newPhoto, newPhotoSize.type);\r\n          const oldCacheContext = appDownloadManager.getCacheContext(photo, 'full');\r\n          Object.assign(cacheContext, oldCacheContext);\r\n\r\n          const photoSize = newPhoto.sizes[newPhoto.sizes.length - 1] as PhotoSize.photoSize;\r\n\r\n          const downloadOptions = appPhotosManager.getPhotoDownloadOptions(newPhoto, photoSize);\r\n          const fileName = getFileNameByLocation(downloadOptions.location);\r\n          appDownloadManager.fakeDownload(fileName, oldCacheContext.url);\r\n        }\r\n      } else if(message.media.document) {\r\n        const doc = appDocsManager.getDoc('' + tempId);\r\n        if(doc) {\r\n          if(/* doc._ !== 'documentEmpty' &&  */doc.type && doc.type !== 'sticker') {\r\n            const newDoc = message.media.document;\r\n            const cacheContext = appDownloadManager.getCacheContext(newDoc);\r\n            const oldCacheContext = appDownloadManager.getCacheContext(doc);\r\n            Object.assign(cacheContext, oldCacheContext);\r\n\r\n            const fileName = appDocsManager.getInputFileName(newDoc);\r\n            appDownloadManager.fakeDownload(fileName, oldCacheContext.url);\r\n          }\r\n        }\r\n      } else if(message.media.poll) {\r\n        delete appPollsManager.polls[tempId];\r\n        delete appPollsManager.results[tempId];\r\n      }\r\n    }\r\n\r\n    const tempMessage = this.getMessageFromStorage(storage, tempId);\r\n    delete storage[tempId];\r\n\r\n    rootScope.dispatchEvent('message_sent', {storage, tempId, tempMessage, mid});\r\n  }\r\n\r\n  public incrementMaxSeenId(maxId: number) {\r\n    if(!maxId || !(!this.maxSeenId || maxId > this.maxSeenId)) {\r\n      return false;\r\n    }\r\n\r\n    this.maxSeenId = maxId;\r\n    appStateManager.pushToState('maxSeenMsgId', maxId);\r\n\r\n    apiManager.invokeApi('messages.receivedMessages', {\r\n      max_id: this.getServerMessageId(maxId)\r\n    });\r\n  }\r\n\r\n  private notifyAboutMessage(message: MyMessage, options: Partial<{\r\n    fwdCount: number,\r\n    peerTypeNotifySettings: PeerNotifySettings\r\n  }> = {}) {\r\n    const peerId = this.getMessagePeer(message);\r\n    const notification: NotifyOptions = {};\r\n    const peerString = appPeersManager.getPeerString(peerId);\r\n    let notificationMessage: string;\r\n\r\n    if(options.peerTypeNotifySettings.show_previews) {\r\n      if(message._ === 'message' && message.fwd_from && options.fwdCount) {\r\n        notificationMessage = I18n.format('Notifications.Forwarded', true, [options.fwdCount]);\r\n      } else {\r\n        notificationMessage = this.wrapMessageForReply(message, undefined, undefined, true);\r\n      }\r\n    } else {\r\n      notificationMessage = I18n.format('Notifications.New', true);\r\n    }\r\n\r\n    notification.title = appPeersManager.getPeerTitle(peerId, true);\r\n    if(peerId < 0 && message.fromId !== message.peerId) {\r\n      notification.title = appPeersManager.getPeerTitle(message.fromId, true) +\r\n        ' @ ' +\r\n        notification.title;\r\n    }\r\n\r\n    notification.title = RichTextProcessor.wrapPlainText(notification.title);\r\n\r\n    notification.onclick = () => {\r\n      rootScope.dispatchEvent('history_focus', {peerId, mid: message.mid});\r\n    };\r\n\r\n    notification.message = notificationMessage;\r\n    notification.key = 'msg' + message.mid;\r\n    notification.tag = peerString;\r\n    notification.silent = true;//message.pFlags.silent || false;\r\n\r\n    const peerPhoto = appPeersManager.getPeerPhoto(peerId);\r\n    if(peerPhoto) {\r\n      appAvatarsManager.loadAvatar(peerId, peerPhoto, 'photo_small').loadPromise.then(url => {\r\n        if(message.pFlags.unread) {\r\n          notification.image = url;\r\n          appNotificationsManager.notify(notification);\r\n        }\r\n      });\r\n    } else {\r\n      appNotificationsManager.notify(notification);\r\n    }\r\n  }\r\n\r\n  public getScheduledMessagesStorage(peerId: number) {\r\n    return this.scheduledMessagesStorage[peerId] ?? (this.scheduledMessagesStorage[peerId] = this.createMessageStorage());\r\n  }\r\n\r\n  public getScheduledMessages(peerId: number): Promise<number[]> {\r\n    if(!this.canWriteToPeer(peerId)) return Promise.resolve([]);\r\n\r\n    const storage = this.getScheduledMessagesStorage(peerId);\r\n    if(Object.keys(storage).length) {\r\n      return Promise.resolve(Object.keys(storage).map(id => +id));\r\n    }\r\n\r\n    return apiManager.invokeApiSingle('messages.getScheduledHistory', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      hash: 0\r\n    }).then(historyResult => {\r\n      if(historyResult._ !== 'messages.messagesNotModified') {\r\n        appUsersManager.saveApiUsers(historyResult.users);\r\n        appChatsManager.saveApiChats(historyResult.chats);\r\n        \r\n        const storage = this.getScheduledMessagesStorage(peerId);\r\n        this.saveMessages(historyResult.messages, {storage, isScheduled: true});\r\n        return Object.keys(storage).map(id => +id);\r\n      }\r\n      \r\n      return [];\r\n    });\r\n  }\r\n\r\n  public sendScheduledMessages(peerId: number, mids: number[]) {\r\n    return apiManager.invokeApi('messages.sendScheduledMessages', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      id: mids.map(mid => this.getServerMessageId(mid))\r\n    }).then(updates => {\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n    });\r\n  }\r\n\r\n  public deleteScheduledMessages(peerId: number, mids: number[]) {\r\n    return apiManager.invokeApi('messages.deleteScheduledMessages', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      id: mids.map(mid => this.getServerMessageId(mid))\r\n    }).then(updates => {\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n    });\r\n  }\r\n\r\n  public getMessageWithReplies(message: Message.message) {\r\n    if(message.peerId !== REPLIES_PEER_ID) {\r\n      message = this.filterMessages(message, message => !!(message as Message.message).replies)[0] as any;\r\n      if(!(message && message.replies && message.replies.pFlags.comments && message.replies.channel_id !== 777)) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    return message;\r\n  }\r\n\r\n  public isFetchIntervalNeeded(peerId: number) {\r\n    return peerId < 0 && !appChatsManager.isInChat(peerId);\r\n  }\r\n\r\n  public async getNewHistory(peerId: number, threadId?: number) {\r\n    if(!this.isFetchIntervalNeeded(peerId)) {\r\n      return;\r\n    }\r\n\r\n    const historyStorage = this.getHistoryStorage(peerId, threadId);\r\n    const slice = historyStorage.history.slice;\r\n    if(!slice.isEnd(SliceEnd.Bottom)) {\r\n      return;\r\n    }\r\n\r\n    delete historyStorage.maxId;\r\n    slice.unsetEnd(SliceEnd.Bottom);\r\n\r\n    // if there is no id - then request by first id because cannot request by id 0 with backLimit\r\n    let historyResult = this.getHistory(peerId, slice[0] ?? 1, 0, 50, threadId);\r\n    if(historyResult instanceof Promise) {\r\n      historyResult = await historyResult;\r\n    }\r\n\r\n    for(let i = 0, length = historyResult.history.length; i < length; ++i) {\r\n      this.handleNewMessage(peerId, historyResult.history[i]);\r\n    }\r\n\r\n    return historyStorage;\r\n  }\r\n\r\n  /**\r\n   * * https://core.telegram.org/api/offsets, offset_id is inclusive\r\n   */\r\n  public getHistory(peerId: number, maxId = 0, limit: number, backLimit?: number, threadId?: number): Promise<HistoryResult> | HistoryResult {\r\n    const historyStorage = this.getHistoryStorage(peerId, threadId);\r\n\r\n    let offset = 0;\r\n    /* \r\n    let offsetFound = true;\r\n\r\n    if(maxId) {\r\n      offsetFound = false;\r\n      for(; offset < historyStorage.history.length; offset++) {\r\n        if(maxId > historyStorage.history.slice[offset]) {\r\n          offsetFound = true;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    if(offsetFound && (\r\n      historyStorage.count !== null && historyStorage.history.length === historyStorage.count ||\r\n      historyStorage.history.length >= offset + limit\r\n      )) {\r\n      if(backLimit) {\r\n        backLimit = Math.min(offset, backLimit);\r\n        offset = Math.max(0, offset - backLimit);\r\n        limit += backLimit;\r\n      } else {\r\n        limit = limit;\r\n      }\r\n\r\n      const history = historyStorage.history.slice.slice(offset, offset + limit);\r\n      return {\r\n        count: historyStorage.count,\r\n        history: history,\r\n        offsetIdOffset: offset\r\n      };\r\n    }\r\n\r\n    if(offsetFound) {\r\n      offset = 0;\r\n    } */\r\n\r\n    if(backLimit) {\r\n      offset = -backLimit;\r\n      limit += backLimit;\r\n\r\n      /* return this.requestHistory(reqPeerId, maxId, limit, offset, undefined, threadId).then((historyResult) => {\r\n        historyStorage.count = (historyResult as MessagesMessages.messagesMessagesSlice).count || historyResult.messages.length;\r\n\r\n        const history = (historyResult.messages as MyMessage[]).map(message => message.mid);\r\n        return {\r\n          count: historyStorage.count,\r\n          history,\r\n          offsetIdOffset: (historyResult as MessagesMessages.messagesMessagesSlice).offset_id_offset || 0\r\n        };\r\n      }); */\r\n    }\r\n\r\n    const haveSlice = historyStorage.history.sliceMe(maxId, offset, limit);\r\n    if(haveSlice && (haveSlice.slice.length === limit || (haveSlice.fulfilled & SliceEnd.Both) === SliceEnd.Both)) {\r\n      return {\r\n        count: historyStorage.count,\r\n        history: haveSlice.slice,\r\n        offsetIdOffset: haveSlice.offsetIdOffset\r\n      }; \r\n    }\r\n\r\n    return this.fillHistoryStorage(peerId, maxId, limit, offset, historyStorage, threadId).then(() => {\r\n      const slice = historyStorage.history.sliceMe(maxId, offset, limit);\r\n      return {\r\n        count: historyStorage.count,\r\n        history: slice?.slice || historyStorage.history.constructSlice(),\r\n        offsetIdOffset: slice?.offsetIdOffset || historyStorage.count\r\n      };\r\n    });\r\n  }\r\n\r\n  public fillHistoryStorage(peerId: number, offset_id: number, limit: number, add_offset: number, historyStorage: HistoryStorage, threadId?: number): Promise<void> {\r\n    return this.requestHistory(peerId, offset_id, limit, add_offset, undefined, threadId).then((historyResult) => {\r\n      const {offset_id_offset, count, messages} = historyResult as MessagesMessages.messagesMessagesSlice;\r\n\r\n      historyStorage.count = count || messages.length;\r\n      const offsetIdOffset = offset_id_offset || 0;\r\n\r\n      const topWasMeantToLoad = add_offset < 0 ? limit + add_offset : limit;\r\n\r\n      const isTopEnd = offsetIdOffset >= (historyStorage.count - topWasMeantToLoad) || historyStorage.count < topWasMeantToLoad;\r\n      const isBottomEnd = !offsetIdOffset || (add_offset < 0 && (offsetIdOffset + add_offset) <= 0);\r\n\r\n      /* if(!maxId && historyResult.messages.length) {\r\n        maxId = this.incrementMessageId((historyResult.messages[0] as MyMessage).mid, 1);\r\n      }\r\n\r\n      const wasTotalCount = historyStorage.history.length; */\r\n\r\n      const mids = messages.map((message) => {\r\n        if(this.mergeReplyKeyboard(historyStorage, message)) {\r\n          rootScope.dispatchEvent('history_reply_markup', {peerId});\r\n        }\r\n\r\n        return (message as MyMessage).mid;\r\n      });\r\n\r\n      // * add bound manually. \r\n      // * offset_id will be inclusive only if there is 'add_offset' <= -1 (-1 - will only include the 'offset_id')\r\n      if(offset_id && !mids.includes(offset_id) && offsetIdOffset < historyStorage.count) {\r\n        let i = 0;\r\n        for(const length = mids.length; i < length; ++i) {\r\n          if(offset_id > mids[i]) {\r\n            break;\r\n          }\r\n        }\r\n\r\n        mids.splice(i, 0, offset_id);\r\n      }\r\n      \r\n      const slice = historyStorage.history.insertSlice(mids) || historyStorage.history.slice;\r\n      if(isTopEnd) {\r\n        slice.setEnd(SliceEnd.Top);\r\n      }\r\n  \r\n      if(isBottomEnd) {\r\n        slice.setEnd(SliceEnd.Bottom);\r\n        historyStorage.maxId = slice[0]; // ! WARNING\r\n      }\r\n      \r\n      /* const isBackLimit = offset < 0 && -offset !== fullLimit;\r\n      if(isBackLimit) {\r\n        return;\r\n      }\r\n\r\n      const totalCount = historyStorage.history.length;\r\n      fullLimit -= (totalCount - wasTotalCount);\r\n\r\n      const migratedNextPeer = this.migratedFromTo[peerId];\r\n      const migratedPrevPeer = this.migratedToFrom[peerId]\r\n      const isMigrated = migratedNextPeer !== undefined || migratedPrevPeer !== undefined;\r\n\r\n      if(isMigrated) {\r\n        historyStorage.count = Math.max(historyStorage.count, totalCount) + 1;\r\n      }\r\n\r\n      if(fullLimit > 0) {\r\n        maxId = historyStorage.history.slice[totalCount - 1];\r\n        if(isMigrated) {\r\n          if(!historyResult.messages.length) {\r\n            if(migratedPrevPeer) {\r\n              maxId = 0;\r\n              peerId = migratedPrevPeer;\r\n            } else {\r\n              historyStorage.count = totalCount;\r\n              return true;\r\n            }\r\n          }\r\n\r\n          return this.fillHistoryStorage(peerId, maxId, fullLimit, historyStorage, threadId);\r\n        } else if(totalCount < historyStorage.count) {\r\n          return this.fillHistoryStorage(peerId, maxId, fullLimit, offset, historyStorage, threadId);\r\n        }\r\n      } */\r\n    });\r\n  }\r\n\r\n  public requestHistory(peerId: number, maxId: number, limit = 0, offset = 0, offsetDate = 0, threadId = 0): Promise<Exclude<MessagesMessages, MessagesMessages.messagesMessagesNotModified>> {\r\n    //console.trace('requestHistory', peerId, maxId, limit, offset);\r\n\r\n    //rootScope.broadcast('history_request');\r\n\r\n    const options: any = {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      offset_id: this.getServerMessageId(maxId) || 0,\r\n      offset_date: offsetDate,\r\n      add_offset: offset,\r\n      limit,\r\n      max_id: 0,\r\n      min_id: 0,\r\n      hash: 0\r\n    };\r\n\r\n    if(threadId) {\r\n      options.msg_id = this.getServerMessageId(threadId) || 0;\r\n    }\r\n\r\n    const promise: ReturnType<AppMessagesManager['requestHistory']> = apiManager.invokeApiSingle(threadId ? 'messages.getReplies' : 'messages.getHistory', options, {\r\n      //timeout: APITIMEOUT,\r\n      noErrorBox: true\r\n    }) as any;\r\n\r\n    return promise.then((historyResult) => {\r\n      if(DEBUG) {\r\n        this.log('requestHistory result:', peerId, historyResult, maxId, limit, offset);\r\n      }\r\n\r\n      appUsersManager.saveApiUsers(historyResult.users);\r\n      appChatsManager.saveApiChats(historyResult.chats);\r\n      this.saveMessages(historyResult.messages);\r\n\r\n      if(appPeersManager.isChannel(peerId)) {\r\n        apiUpdatesManager.addChannelState(-peerId, (historyResult as MessagesMessages.messagesChannelMessages).pts);\r\n      }\r\n\r\n      let length = historyResult.messages.length, count = (historyResult as MessagesMessages.messagesMessagesSlice).count;\r\n      if(length && historyResult.messages[length - 1].deleted) {\r\n        historyResult.messages.splice(length - 1, 1);\r\n        length--;\r\n        count--;\r\n      }\r\n\r\n      // will load more history if last message is album grouped (because it can be not last item)\r\n      // historyResult.messages: desc sorted\r\n      const historyStorage = this.getHistoryStorage(peerId, threadId);\r\n      const oldestMessage: Message.message = historyResult.messages[length - 1] as any;\r\n      if(length && oldestMessage.grouped_id) {\r\n        const foundSlice = historyStorage.history.findSlice(oldestMessage.mid);\r\n        if(foundSlice && (foundSlice.slice.length + historyResult.messages.length) < count) {\r\n          return this.requestHistory(peerId, oldestMessage.mid, 10, 0, offsetDate, threadId).then((_historyResult) => {\r\n            return historyResult;\r\n          });\r\n        }\r\n      }\r\n\r\n      return historyResult;\r\n    }, (error) => {\r\n      switch (error.type) {\r\n        case 'CHANNEL_PRIVATE':\r\n          let channel = appChatsManager.getChat(-peerId);\r\n          channel = {_: 'channelForbidden', access_hash: channel.access_hash, title: channel.title};\r\n          apiUpdatesManager.processUpdateMessage({\r\n            _: 'updates',\r\n            updates: [{\r\n              _: 'updateChannel',\r\n              channel_id: -peerId\r\n            }],\r\n            chats: [channel],\r\n            users: []\r\n          });\r\n          break;\r\n      }\r\n\r\n      throw error;\r\n    });\r\n  }\r\n\r\n  public fetchSingleMessages() {\r\n    if(this.fetchSingleMessagesPromise) {\r\n      return this.fetchSingleMessagesPromise;\r\n    }\r\n\r\n    return this.fetchSingleMessagesPromise = new Promise((resolve) => {\r\n      setTimeout(() => {\r\n        let promises: Promise<void>[] = [];\r\n        \r\n        for(const peerId in this.needSingleMessages) {\r\n          const mids = this.needSingleMessages[peerId];\r\n          delete this.needSingleMessages[peerId];\r\n    \r\n          const msgIds: InputMessage[] = mids.map((msgId: number) => {\r\n            return {\r\n              _: 'inputMessageID',\r\n              id: this.getServerMessageId(msgId)\r\n            };\r\n          });\r\n    \r\n          let promise: Promise<MethodDeclMap['channels.getMessages']['res'] | MethodDeclMap['messages.getMessages']['res']>;\r\n          if(+peerId < 0 && appPeersManager.isChannel(+peerId)) {\r\n            promise = apiManager.invokeApiSingle('channels.getMessages', {\r\n              channel: appChatsManager.getChannelInput(-+peerId),\r\n              id: msgIds\r\n            });\r\n          } else {\r\n            promise = apiManager.invokeApiSingle('messages.getMessages', {\r\n              id: msgIds\r\n            });\r\n          }\r\n    \r\n          promises.push(promise.then(getMessagesResult => {\r\n            if(getMessagesResult._ !== 'messages.messagesNotModified') {\r\n              appUsersManager.saveApiUsers(getMessagesResult.users);\r\n              appChatsManager.saveApiChats(getMessagesResult.chats);\r\n              this.saveMessages(getMessagesResult.messages);\r\n            }\r\n    \r\n            rootScope.dispatchEvent('messages_downloaded', {peerId: +peerId, mids});\r\n          }));\r\n        }\r\n\r\n        Promise.all(promises).finally(() => {\r\n          this.fetchSingleMessagesPromise = null;\r\n          if(Object.keys(this.needSingleMessages).length) this.fetchSingleMessages();\r\n          resolve();\r\n        });\r\n      }, 0);\r\n    });\r\n  }\r\n\r\n  public wrapSingleMessage(peerId: number, msgId: number, overwrite = false): Promise<void> {\r\n    if(!this.getMessageByPeer(peerId, msgId).deleted && !overwrite) {\r\n      rootScope.dispatchEvent('messages_downloaded', {peerId, mids: [msgId]});\r\n      return Promise.resolve();\r\n    } else if(!this.needSingleMessages[peerId] || this.needSingleMessages[peerId].indexOf(msgId) === -1) {\r\n      (this.needSingleMessages[peerId] ?? (this.needSingleMessages[peerId] = [])).push(msgId);\r\n      return this.fetchSingleMessages();\r\n    } else if(this.fetchSingleMessagesPromise) {\r\n      return this.fetchSingleMessagesPromise;\r\n    }\r\n  }\r\n\r\n  public setTyping(peerId: number, action: SendMessageAction): Promise<boolean> {\r\n    let typing = this.typings[peerId];\r\n    if(!rootScope.myId || \r\n      !peerId || \r\n      !this.canWriteToPeer(peerId) || \r\n      peerId === rootScope.myId ||\r\n      typing?.type === action._\r\n    ) {\r\n      return Promise.resolve(false);\r\n    }\r\n\r\n    if(typing?.timeout) {\r\n      clearTimeout(typing.timeout);\r\n    }\r\n\r\n    typing = this.typings[peerId] = {\r\n      type: action._\r\n    };\r\n\r\n    return apiManager.invokeApi('messages.setTyping', {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      action\r\n    }).finally(() => {\r\n      if(typing === this.typings[peerId]) {\r\n        typing.timeout = window.setTimeout(() => {\r\n          delete this.typings[peerId];\r\n        }, 6000);\r\n      }\r\n    });\r\n  }\r\n\r\n  private handleDeletedMessages(peerId: number, storage: MessagesStorage, messages: number[]) {\r\n    const history: {\r\n      count: number, \r\n      unread: number, \r\n      msgs: {[mid: number]: true},\r\n      albums?: {[groupId: string]: Set<number>},\r\n    } = {count: 0, unread: 0, msgs: {}} as any;\r\n\r\n    for(const mid of messages) {\r\n      const message: MyMessage = this.getMessageFromStorage(storage, mid);\r\n      if(message.deleted) continue;\r\n\r\n      if((message as Message.message).media) {\r\n        // @ts-ignore\r\n        const c = message.media.webpage || message.media;\r\n        const smth = c.photo || c.document;\r\n\r\n        if(smth?.file_reference) {\r\n          referenceDatabase.deleteContext(smth.file_reference, {type: 'message', peerId, messageId: mid});\r\n        }\r\n\r\n        // @ts-ignore\r\n        if(message.media.webpage) {\r\n          // @ts-ignore\r\n          appWebPagesManager.deleteWebPageFromPending(message.media.webpage, mid);\r\n        }\r\n      }\r\n\r\n      this.updateMessageRepliesIfNeeded(message);\r\n\r\n      if(!message.pFlags.out && !message.pFlags.is_outgoing && message.pFlags.unread) {\r\n        history.unread++;\r\n        appNotificationsManager.cancel('msg' + mid);\r\n      }\r\n      history.count++;\r\n      history.msgs[mid] = true;\r\n\r\n      message.deleted = true;\r\n\r\n      if(message._ !== 'messageService' && message.grouped_id) {\r\n        const groupedStorage = this.groupedMessagesStorage[message.grouped_id];\r\n        if(groupedStorage) {\r\n          delete groupedStorage[mid];\r\n\r\n          if(!history.albums) history.albums = {};\r\n          (history.albums[message.grouped_id] || (history.albums[message.grouped_id] = new Set())).add(mid);\r\n\r\n          if(!Object.keys(groupedStorage).length) {\r\n            delete history.albums;\r\n            delete this.groupedMessagesStorage[message.grouped_id];\r\n          }\r\n        }\r\n      }\r\n\r\n      delete storage[mid];\r\n\r\n      const peerMessagesToHandle = this.newMessagesToHandle[peerId];\r\n      if(peerMessagesToHandle && peerMessagesToHandle.has(mid)) {\r\n        peerMessagesToHandle.delete(mid);\r\n      }\r\n    }\r\n\r\n    if(history.albums) {\r\n      for(const groupId in history.albums) {\r\n        rootScope.dispatchEvent('album_edit', {peerId, groupId, deletedMids: [...history.albums[groupId]]});\r\n        /* const mids = this.getMidsByAlbum(groupId);\r\n        if(mids.length) {\r\n          const mid = Math.max(...mids);\r\n          rootScope.$broadcast('message_edit', {peerId, mid, justMedia: false});\r\n        } */\r\n      }\r\n    }\r\n\r\n    return history;\r\n  }\r\n  \r\n  private handleEditedMessage(oldMessage: any, newMessage: any) {\r\n    if(oldMessage.media?.webpage) {\r\n      appWebPagesManager.deleteWebPageFromPending(oldMessage.media.webpage, oldMessage.mid);\r\n    }\r\n  }\r\n}\r\n\r\nconst appMessagesManager = new AppMessagesManager();\r\nMOUNT_CLASS_TO.appMessagesManager = appMessagesManager;\r\nexport default appMessagesManager;\r\n","export default function Worker_fn() {\n  return new Worker(__webpack_public_path__ + \"rlottie.worker.86bed2789739b353d39d.bundle.worker.js\");\n}\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport RLottieWorker from 'worker-loader!./rlottie/rlottie.worker';\r\nimport animationIntersector from \"../components/animationIntersector\";\r\nimport { MOUNT_CLASS_TO } from '../config/debug';\r\nimport EventListenerBase from \"../helpers/eventListenerBase\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport { clamp } from '../helpers/number';\r\nimport { pause } from '../helpers/schedulers';\r\nimport { isAndroid, isApple, isAppleMobile, isSafari } from \"../helpers/userAgent\";\r\nimport { logger, LogTypes } from \"./logger\";\r\nimport apiManager from \"./mtproto/mtprotoworker\";\r\n\r\nlet convert = (value: number) => {\r\n\treturn Math.round(Math.min(Math.max(value, 0), 1) * 255);\r\n};\r\n\r\ntype RLottiePlayerListeners = 'enterFrame' | 'ready' | 'firstFrame' | 'cached';\r\ntype RLottieOptions = {\r\n  container: HTMLElement, \r\n  autoplay?: boolean, \r\n  animationData: string, \r\n  loop?: boolean, \r\n  width?: number,\r\n  height?: number,\r\n  group?: string,\r\n  noCache?: true,\r\n  needUpscale?: true,\r\n  skipRatio?: number\r\n};\r\n\r\nexport class RLottiePlayer extends EventListenerBase<{\r\n  enterFrame: (frameNo: number) => void,\r\n  ready: () => void,\r\n  firstFrame: () => void,\r\n  cached: () => void\r\n}> {\r\n  public static reqId = 0;\r\n\r\n  public reqId = 0;\r\n  public curFrame: number;\r\n  public frameCount: number;\r\n  public fps: number;\r\n  public skipDelta: number;\r\n\r\n  public worker: QueryableWorker;\r\n  \r\n  public width = 0;\r\n  public height = 0;\r\n\r\n  public el: HTMLElement;\r\n  public canvas: HTMLCanvasElement;\r\n  public context: CanvasRenderingContext2D;\r\n\r\n  public paused = true;\r\n  //public paused = false;\r\n  public direction = 1;\r\n  public speed = 1;\r\n  public autoplay = true;\r\n  public _autoplay: boolean; // ! will be used to store original value for settings.stickers.loop\r\n  public loop = true;\r\n  public _loop: boolean; // ! will be used to store original value for settings.stickers.loop\r\n  public group = '';\r\n\r\n  private frInterval: number;\r\n  private frThen: number;\r\n  private rafId: number;\r\n\r\n  //private caching = false;\r\n  //private removed = false;\r\n\r\n  private frames: {[frameNo: string]: Uint8ClampedArray} = {};\r\n  public imageData: ImageData;\r\n  public clamped: Uint8ClampedArray;\r\n  public cachingDelta = 0;\r\n\r\n  //private playedTimes = 0;\r\n\r\n  private currentMethod: RLottiePlayer['mainLoopForwards'] | RLottiePlayer['mainLoopBackwards'];\r\n  private frameListener: () => void;\r\n\r\n  constructor({el, worker, options}: {\r\n    el: HTMLElement,\r\n    worker: QueryableWorker,\r\n    options: RLottieOptions\r\n  }) {\r\n    super(true);\r\n\r\n    this.reqId = ++RLottiePlayer['reqId'];\r\n    this.el = el;\r\n    this.worker = worker;\r\n\r\n    for(let i in options) {\r\n      if(this.hasOwnProperty(i)) {\r\n        // @ts-ignore\r\n        this[i] = options[i];\r\n      }\r\n    }\r\n\r\n    this._loop = this.loop;\r\n    this._autoplay = this.autoplay;\r\n\r\n    // * Skip ratio (30fps)\r\n    let skipRatio: number;\r\n    if(options.skipRatio !== undefined) skipRatio = options.skipRatio;\r\n    else if((isAndroid || isAppleMobile || (isApple && !isSafari)) && this.width < 100 && this.height < 100) {\r\n      skipRatio = 0.5;\r\n    }\r\n\r\n    this.skipDelta = skipRatio !== undefined ? 1 / skipRatio | 0 : 1;\r\n\r\n    //options.needUpscale = true;\r\n\r\n    // * Pixel ratio\r\n    //const pixelRatio = window.devicePixelRatio;\r\n    const pixelRatio = clamp(window.devicePixelRatio, 1, 2);\r\n    if(pixelRatio > 1) {\r\n      //this.cachingEnabled = true;//this.width < 100 && this.height < 100;\r\n      if(options.needUpscale) {\r\n        this.width = Math.round(this.width * pixelRatio);\r\n        this.height = Math.round(this.height * pixelRatio);\r\n      } else if(pixelRatio > 1) {\r\n        if(this.width > 100 && this.height > 100) {\r\n          if(isApple || !mediaSizes.isMobile) {\r\n            /* this.width = Math.round(this.width * (pixelRatio - 1));\r\n            this.height = Math.round(this.height * (pixelRatio - 1)); */\r\n            this.width = Math.round(this.width * pixelRatio);\r\n            this.height = Math.round(this.height * pixelRatio);\r\n          } else if(pixelRatio > 2.5) {\r\n            this.width = Math.round(this.width * (pixelRatio - 1.5));\r\n            this.height = Math.round(this.height * (pixelRatio - 1.5));\r\n          }\r\n        } else {\r\n          this.width = Math.round(this.width * Math.max(1.5, pixelRatio - 1.5));\r\n          this.height = Math.round(this.height * Math.max(1.5, pixelRatio - 1.5));\r\n        }\r\n      }\r\n    }\r\n\r\n    //options.noCache = true;\r\n    \r\n    // * Cache frames params\r\n    if(!options.noCache/*  && false */) {\r\n      // проверка на размер уже после скейлинга, сделано для попапа и сайдбара, где стикеры 80х80 и 68х68, туда нужно 75%\r\n      if(isApple && this.width > 100 && this.height > 100) {\r\n        this.cachingDelta = 2; //2 // 50%\r\n      } else if(this.width < 100 && this.height < 100) {\r\n        this.cachingDelta = Infinity; // 100%\r\n      } else {\r\n        this.cachingDelta = 4; // 75%\r\n      }\r\n    }\r\n    \r\n    // this.cachingDelta = Infinity;\r\n    // if(isApple) {\r\n    //   this.cachingDelta = 0; //2 // 50%\r\n    // }\r\n\r\n    /* this.width *= 0.8;\r\n    this.height *= 0.8; */\r\n    \r\n    //console.log(\"RLottiePlayer width:\", this.width, this.height, options);\r\n    this.canvas = document.createElement('canvas');\r\n    this.canvas.classList.add('rlottie');\r\n    this.canvas.width = this.width;\r\n    this.canvas.height = this.height;\r\n    this.context = this.canvas.getContext('2d');\r\n\r\n    this.clamped = new Uint8ClampedArray(this.width * this.height * 4);\r\n    this.imageData = new ImageData(this.width, this.height);\r\n  }\r\n\r\n  public clearCache() {\r\n    this.frames = {};\r\n  }\r\n\r\n  public sendQuery(methodName: string, ...args: any[]) {\r\n    //console.trace('RLottie sendQuery:', methodName);\r\n    this.worker.sendQuery(methodName, this.reqId, ...args);\r\n  }\r\n\r\n  public loadFromData(jsonString: string) {\r\n    this.sendQuery('loadFromData', jsonString, this.width, this.height/* , this.canvas.transferControlToOffscreen() */);\r\n  }\r\n\r\n  public play() {\r\n    if(!this.paused) return;\r\n\r\n    //return;\r\n\r\n    //console.log('RLOTTIE PLAY' + this.reqId);\r\n\r\n    this.paused = false;\r\n    this.setMainLoop();\r\n  }\r\n\r\n  public pause(clearPendingRAF = true) {\r\n    if(this.paused) return;\r\n\r\n    this.paused = true;\r\n    if(clearPendingRAF) {\r\n      clearTimeout(this.rafId);\r\n    }\r\n    //window.cancelAnimationFrame(this.rafId);\r\n  }\r\n\r\n  public stop(renderFirstFrame = true) {\r\n    this.pause();\r\n\r\n    this.curFrame = this.direction === 1 ? 0 : this.frameCount;\r\n    if(renderFirstFrame) {\r\n      this.requestFrame(this.curFrame);\r\n      //this.sendQuery('renderFrame', this.curFrame);\r\n    }\r\n  }\r\n\r\n  public restart() {\r\n    this.stop(false);\r\n    this.play();\r\n  }\r\n\r\n  public setSpeed(speed: number) {\r\n    this.speed = speed;\r\n\r\n    if(!this.paused) {\r\n      this.setMainLoop();\r\n    }\r\n  }\r\n\r\n  public setDirection(direction: number) {\r\n    this.direction = direction;\r\n    \r\n    if(!this.paused) {\r\n      this.setMainLoop();\r\n    }\r\n  }\r\n\r\n  public remove() {\r\n    //alert('remove');\r\n    lottieLoader.onDestroy(this.reqId);\r\n    this.pause();\r\n    this.sendQuery('destroy');\r\n    //this.removed = true;\r\n  }\r\n\r\n  public renderFrame2(frame: Uint8ClampedArray, frameNo: number) {\r\n    /* this.setListenerResult('enterFrame', frameNo);\r\n    return; */\r\n\r\n    try {\r\n      this.imageData.data.set(frame);\r\n      \r\n      //this.context.putImageData(new ImageData(frame, this.width, this.height), 0, 0);\r\n      //let perf = performance.now();\r\n      this.context.putImageData(this.imageData, 0, 0);\r\n      //console.log('renderFrame2 perf:', performance.now() - perf);\r\n    } catch(err) {\r\n      console.error('RLottiePlayer renderFrame error:', err/* , frame */, this.width, this.height);\r\n      this.autoplay = false;\r\n      this.pause();\r\n      return;\r\n    }\r\n    \r\n    //console.log('set result enterFrame', frameNo);\r\n    this.dispatchEvent('enterFrame', frameNo);\r\n  }\r\n\r\n  public renderFrame(frame: Uint8ClampedArray, frameNo: number) {\r\n    //console.log('renderFrame', frameNo, this);\r\n    if(this.cachingDelta && (frameNo % this.cachingDelta || !frameNo) && !this.frames[frameNo]) {\r\n      this.frames[frameNo] = new Uint8ClampedArray(frame);//frame;\r\n    }\r\n\r\n    /* if(!this.listenerResults.hasOwnProperty('cached')) {\r\n      this.setListenerResult('enterFrame', frameNo);\r\n      if(frameNo === (this.frameCount - 1)) {\r\n        this.setListenerResult('cached');\r\n      }\r\n\r\n      return;\r\n    } */\r\n\r\n    if(this.frInterval) {\r\n      const now = Date.now(), delta = now - this.frThen;\r\n      //console.log(`renderFrame delta${this.reqId}:`, this, delta, this.frInterval);\r\n\r\n      if(delta < 0) {\r\n        if(this.rafId) clearTimeout(this.rafId);\r\n        return this.rafId = window.setTimeout(() => {\r\n          this.renderFrame2(frame, frameNo);\r\n        }, this.frInterval > -delta ? -delta % this.frInterval : this.frInterval);\r\n        //await new Promise((resolve) => setTimeout(resolve, -delta % this.frInterval));\r\n      }\r\n    }\r\n\r\n    this.renderFrame2(frame, frameNo);\r\n  }\r\n\r\n  public requestFrame(frameNo: number) {\r\n    if(this.frames[frameNo]) {\r\n      this.renderFrame(this.frames[frameNo], frameNo);\r\n    } else if(isSafari) {\r\n      this.sendQuery('renderFrame', frameNo);\r\n    } else {\r\n      if(!this.clamped.length) { // fix detached\r\n        this.clamped = new Uint8ClampedArray(this.width * this.height * 4);\r\n      }\r\n      \r\n      this.sendQuery('renderFrame', frameNo, this.clamped);\r\n    }\r\n  }\r\n\r\n  private mainLoopForwards() {\r\n    const frame = (this.curFrame + this.skipDelta) >= this.frameCount ? this.curFrame = 0 : this.curFrame += this.skipDelta;\r\n    //console.log('mainLoopForwards', this.curFrame, this.skipDelta, frame);\r\n\r\n    this.requestFrame(frame);\r\n    if((frame + this.skipDelta) >= this.frameCount) {\r\n      //this.playedTimes++;\r\n\r\n      if(!this.loop) {\r\n        this.pause(false);\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n  \r\n  private mainLoopBackwards() {\r\n    const frame = (this.curFrame - this.skipDelta) < 0 ? this.curFrame = this.frameCount - 1 : this.curFrame -= this.skipDelta;\r\n    //console.log('mainLoopBackwards', this.curFrame, this.skipDelta, frame);\r\n\r\n    this.requestFrame(frame);\r\n    if((frame - this.skipDelta) < 0) {\r\n      //this.playedTimes++;\r\n\r\n      if(!this.loop) {\r\n        this.pause(false);\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public setMainLoop() {\r\n    //window.cancelAnimationFrame(this.rafId);\r\n    clearTimeout(this.rafId);\r\n\r\n    this.frInterval = 1000 / this.fps / this.speed * this.skipDelta;\r\n    this.frThen = Date.now() - this.frInterval;\r\n\r\n    //console.trace('setMainLoop', this.frInterval, this.direction, this, JSON.stringify(this.listenerResults), this.listenerResults);\r\n\r\n    const method = (this.direction === 1 ? this.mainLoopForwards : this.mainLoopBackwards).bind(this);\r\n    this.currentMethod = method;\r\n    //this.frameListener && this.removeListener('enterFrame', this.frameListener);\r\n\r\n    //setTimeout(() => {\r\n      //this.addListener('enterFrame', this.frameListener);\r\n    //}, 0);\r\n\r\n    if(this.frameListener && this.listenerResults.hasOwnProperty('enterFrame')) {\r\n      this.frameListener();\r\n    }\r\n  \r\n    //this.mainLoop(method);\r\n    //this.r(method);\r\n    //method();\r\n  }\r\n\r\n  public async onLoad(frameCount: number, fps: number) {\r\n    this.curFrame = this.direction === 1 ? 0 : frameCount - 1;\r\n    this.frameCount = frameCount;\r\n    this.fps = fps;\r\n\r\n    // * Handle 30fps stickers if 30fps set\r\n    if(this.fps < 60 && this.skipDelta !== 1) {\r\n      const diff = 60 / fps;\r\n      this.skipDelta = this.skipDelta / diff | 0;\r\n    }\r\n\r\n    this.frInterval = 1000 / this.fps / this.speed * this.skipDelta;\r\n    this.frThen = Date.now() - this.frInterval;\r\n    //this.sendQuery('renderFrame', 0);\r\n    \r\n    // Кешировать сразу не получится, рендер стикера (тайгер) занимает 519мс, \r\n    // если рендерить 75% с получением каждого кадра из воркера, будет 475мс, т.е. при 100% было бы 593мс, потеря на передаче 84мс. \r\n\r\n    /* console.time('cache' + this.reqId);\r\n    for(let i = 0; i < frameCount; ++i) {\r\n      //if(this.removed) return;\r\n      \r\n      if(i % 4) {\r\n        await new Promise((resolve) => {\r\n          delete this.listenerResults.enterFrame;\r\n          this.addListener('enterFrame', resolve, true);\r\n          this.requestFrame(i);\r\n        });  \r\n      }\r\n    }\r\n    \r\n    console.timeEnd('cache' + this.reqId); */\r\n    //console.log('cached');\r\n    /* this.el.innerHTML = '';\r\n    this.el.append(this.canvas);\r\n    return; */\r\n\r\n    this.requestFrame(0);\r\n    this.dispatchEvent('ready');\r\n    this.addEventListener('enterFrame', () => {\r\n      this.dispatchEvent('firstFrame');\r\n\r\n      this.el.appendChild(this.canvas);\r\n\r\n      //console.log('enterFrame firstFrame');\r\n \r\n      //let lastTime = this.frThen;\r\n      this.frameListener = () => {\r\n        if(this.paused) {\r\n          return;\r\n        }\r\n\r\n        const time = Date.now();\r\n        //console.log(`enterFrame handle${this.reqId}`, time, (time - lastTime), this.frInterval);\r\n        /* if(Math.round(time - lastTime + this.frInterval * 0.25) < Math.round(this.frInterval)) {\r\n          return;\r\n        } */\r\n\r\n        //lastTime = time;\r\n\r\n        this.frThen = time + this.frInterval;\r\n        const canContinue = this.currentMethod();\r\n        if(!canContinue && !this.loop && this.autoplay) {\r\n          this.autoplay = false;\r\n        }\r\n      };\r\n\r\n      this.addEventListener('enterFrame', this.frameListener);\r\n    }, true);\r\n  }\r\n}\r\n\r\nclass QueryableWorker extends EventListenerBase<any> {\r\n  constructor(private worker: Worker, private defaultListener: (data: any) => void = () => {}, onError?: (error: any) => void) {\r\n    super();\r\n\r\n    if(onError) {\r\n      this.worker.onerror = onError;\r\n    }\r\n\r\n    this.worker.onmessage = (event) => {\r\n      //return;\r\n      //console.log('worker onmessage', event.data);\r\n      if(event.data instanceof Object &&\r\n        event.data.hasOwnProperty('queryMethodListener') &&\r\n        event.data.hasOwnProperty('queryMethodArguments')) {\r\n        /* if(event.data.queryMethodListener === 'frame') {\r\n          return;\r\n        } */\r\n\r\n        this.dispatchEvent(event.data.queryMethodListener, ...event.data.queryMethodArguments);\r\n      } else {\r\n        this.defaultListener.call(this, event.data);\r\n      }\r\n    };\r\n  }\r\n\r\n  public postMessage(message: any) {\r\n    this.worker.postMessage(message);\r\n  }\r\n\r\n  public terminate() {\r\n    this.worker.terminate();\r\n  }\r\n\r\n  public sendQuery(queryMethod: string, ...args: any[]) {\r\n    if(isSafari) {\r\n      this.worker.postMessage({\r\n        'queryMethod': queryMethod,\r\n        'queryMethodArguments': args\r\n      });\r\n    } else {\r\n      //const transfer: (ArrayBuffer | OffscreenCanvas)[] = [];\r\n      const transfer: ArrayBuffer[] = [];\r\n      args.forEach(arg => {\r\n        if(arg instanceof ArrayBuffer) {\r\n          transfer.push(arg);\r\n        }\r\n  \r\n        if(arg.buffer && arg.buffer instanceof ArrayBuffer) {\r\n          transfer.push(arg.buffer);\r\n        }\r\n      });\r\n  \r\n      //console.log('transfer', transfer);\r\n      this.worker.postMessage({\r\n        'queryMethod': queryMethod,\r\n        'queryMethodArguments': args\r\n      }, transfer as PostMessageOptions);\r\n    }\r\n  }\r\n}\r\n\r\ntype LottieShape = {\r\n  c: {\r\n    k: number[]\r\n  },\r\n  ty: 'st' | 'fl',\r\n  it?: LottieShape[]\r\n};\r\nclass LottieLoader {\r\n  public isWebAssemblySupported = typeof(WebAssembly) !== 'undefined';\r\n  public loadPromise: Promise<void> = !this.isWebAssemblySupported ? Promise.reject() : undefined;\r\n  public loaded = false;\r\n\r\n  // https://github.com/telegramdesktop/tdesktop/blob/97d8ee75d51874fcb74a9bfadc79f835c82be54a/Telegram/SourceFiles/chat_helpers/stickers_emoji_pack.cpp#L46\r\n  private static COLORREPLACEMENTS = [\r\n    [\r\n      [0xf77e41, 0xcb7b55],\r\n\t\t\t[0xffb139, 0xf6b689],\r\n\t\t\t[0xffd140, 0xffcda7],\r\n\t\t\t[0xffdf79, 0xffdfc5],\r\n    ],\r\n\r\n    [\r\n      [0xf77e41, 0xa45a38],\r\n\t\t\t[0xffb139, 0xdf986b],\r\n\t\t\t[0xffd140, 0xedb183],\r\n\t\t\t[0xffdf79, 0xf4c3a0],\r\n    ],\r\n\r\n    [\r\n      [0xf77e41, 0x703a17],\r\n\t\t\t[0xffb139, 0xab673d],\r\n\t\t\t[0xffd140, 0xc37f4e],\r\n\t\t\t[0xffdf79, 0xd89667],\r\n    ],\r\n\r\n    [\r\n      [0xf77e41, 0x4a2409],\r\n\t\t\t[0xffb139, 0x7d3e0e],\r\n\t\t\t[0xffd140, 0x965529],\r\n\t\t\t[0xffdf79, 0xa96337],\r\n    ],\r\n\r\n    [\r\n\t\t\t[0xf77e41, 0x200f0a],\r\n\t\t\t[0xffb139, 0x412924],\r\n\t\t\t[0xffd140, 0x593d37],\r\n\t\t\t[0xffdf79, 0x63453f],\r\n    ]\r\n  ];\r\n\r\n  private workersLimit = 4;\r\n  private players: {[reqId: number]: RLottiePlayer} = {};\r\n\r\n  private workers: QueryableWorker[] = [];\r\n  private curWorkerNum = 0;\r\n\r\n  private log = logger('LOTTIE', LogTypes.Error);\r\n\r\n  public getAnimation(element: HTMLElement) {\r\n    for(const i in this.players) {\r\n      if(this.players[i].el === element) {\r\n        return this.players[i];\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  public setLoop(loop: boolean) {\r\n    for(const i in this.players) {\r\n      const player = this.players[i];\r\n      player.loop = loop;\r\n      player.autoplay = player._autoplay;\r\n    }\r\n  }\r\n\r\n  public loadLottieWorkers() {\r\n    if(this.loadPromise) {\r\n      return this.loadPromise;\r\n    }\r\n\r\n    return this.loadPromise = new Promise((resolve, reject) => {\r\n      let remain = this.workersLimit;\r\n      for(let i = 0; i < this.workersLimit; ++i) {\r\n        const worker = this.workers[i] = new QueryableWorker(new RLottieWorker());\r\n\r\n        worker.addEventListener('ready', () => {\r\n          this.log('worker #' + i + ' ready');\r\n\r\n          worker.addEventListener('frame', this.onFrame);\r\n          worker.addEventListener('loaded', this.onPlayerLoaded);\r\n          worker.addEventListener('error', this.onPlayerError);\r\n\r\n          --remain;\r\n          if(!remain) {\r\n            this.log('workers ready');\r\n            resolve();\r\n            this.loaded = true;\r\n          }\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  private applyReplacements(object: {\r\n    layers: Array<{shapes: LottieShape[]}>\r\n  }, toneIndex: number) {\r\n    const replacements = LottieLoader.COLORREPLACEMENTS[Math.max(toneIndex - 1, 0)];\r\n\r\n    const applyTo = (smth: LottieShape) => {\r\n      const k = smth.c.k;\r\n      const color = convert(k[2]) | (convert(k[1]) << 8) | (convert(k[0]) << 16);\r\n\r\n      const foundReplacement = replacements.find(p => p[0] === color);\r\n      if(foundReplacement) {\r\n        k[0] = ((foundReplacement[1] >> 16) & 255) / 255;\r\n        k[1] = ((foundReplacement[1] >> 8) & 255) / 255;\r\n        k[2] = (foundReplacement[1] & 255) / 255;\r\n      }\r\n\r\n      //console.log('foundReplacement!', foundReplacement, color.toString(16), k);\r\n    };\r\n\r\n    const checkSmth = (smth: LottieShape) => {\r\n      switch(smth.ty) {\r\n        case 'st':\r\n        case 'fl':\r\n          applyTo(smth);\r\n          break;\r\n      }\r\n\r\n      if(smth.hasOwnProperty('it')) {\r\n        iterateIt(smth.it);\r\n      }\r\n    };\r\n\r\n    const iterateIt = (it: LottieShape['it']) => {\r\n      for(const smth of it) {\r\n        checkSmth(smth);\r\n      }\r\n    };\r\n\r\n    try {\r\n      for(const layer of object.layers) {\r\n        if(!layer.shapes) continue;\r\n  \r\n        for(const shape of layer.shapes) {\r\n          if(!shape.it) {\r\n            checkSmth(shape);\r\n            continue;\r\n          }\r\n\r\n          iterateIt(shape.it);\r\n        }\r\n      }\r\n    } catch(err) {\r\n      this.log.warn('cant apply replacements', err, object, toneIndex);\r\n    }\r\n  }\r\n\r\n  public loadAnimationFromURL(params: Omit<RLottieOptions, 'animationData'>, url: string): Promise<RLottiePlayer> {\r\n    if(!this.isWebAssemblySupported) {\r\n      return this.loadPromise as any;\r\n    }\r\n    \r\n    if(!this.loaded) {\r\n      this.loadLottieWorkers();\r\n    }\r\n    \r\n    return fetch(url)\r\n    .then(res => res.arrayBuffer())\r\n    .then(data => apiManager.gzipUncompress<string>(data, true))\r\n    /* .then(str => {\r\n      return new Promise<string>((resolve) => setTimeout(() => resolve(str), 2e3));\r\n    }) */\r\n    .then(str => {\r\n      return this.loadAnimationWorker(Object.assign(params, {animationData: str/* JSON.parse(str) */, needUpscale: true}));\r\n    });\r\n  }\r\n\r\n  public waitForFirstFrame(player: RLottiePlayer): Promise<void> {\r\n    return Promise.race([\r\n      /* new Promise<void>((resolve) => {\r\n        player.addEventListener('firstFrame', () => {\r\n          setTimeout(() => resolve(), 1500);\r\n        }, true);\r\n      }) */\r\n      new Promise<void>((resolve) => {\r\n        player.addEventListener('firstFrame', resolve, true);\r\n      }),\r\n      pause(2500)\r\n    ]);\r\n  }\r\n\r\n  public async loadAnimationWorker(params: RLottieOptions, group = '', toneIndex = -1): Promise<RLottiePlayer> {\r\n    if(!this.isWebAssemblySupported) {\r\n      return this.loadPromise as any;\r\n    }\r\n    //params.autoplay = true;\r\n\r\n    if(toneIndex >= 1 && toneIndex <= 5) {\r\n      /* params.animationData = copy(params.animationData);\r\n      this.applyReplacements(params.animationData, toneIndex); */\r\n\r\n      const newAnimationData = JSON.parse(params.animationData);\r\n      this.applyReplacements(newAnimationData, toneIndex);\r\n      params.animationData = JSON.stringify(newAnimationData);\r\n    }\r\n\r\n    if(!this.loaded) {\r\n      await this.loadLottieWorkers();\r\n    }\r\n\r\n    if(!params.width || !params.height) {\r\n      params.width = parseInt(params.container.style.width);\r\n      params.height = parseInt(params.container.style.height);\r\n    }\r\n\r\n    if(!params.width || !params.height) {\r\n      throw new Error('No size for sticker!');\r\n    }\r\n\r\n    params.group = group;\r\n\r\n    const player = this.initPlayer(params.container, params);\r\n    animationIntersector.addAnimation(player, group);\r\n\r\n    return player;\r\n  }\r\n\r\n  private onPlayerLoaded = (reqId: number, frameCount: number, fps: number) => {\r\n    const rlPlayer = this.players[reqId];\r\n    if(!rlPlayer) {\r\n      this.log.warn('onPlayerLoaded on destroyed player:', reqId, frameCount);\r\n      return;\r\n    }\r\n\r\n    this.log.debug('onPlayerLoaded');\r\n    rlPlayer.onLoad(frameCount, fps);\r\n    //rlPlayer.addListener('firstFrame', () => {\r\n      //animationIntersector.addAnimation(player, group);\r\n    //}, true);\r\n  };\r\n\r\n  private onFrame = (reqId: number, frameNo: number, frame: Uint8ClampedArray) => {\r\n    const rlPlayer = this.players[reqId];\r\n    if(!rlPlayer) {\r\n      this.log.warn('onFrame on destroyed player:', reqId, frameNo);\r\n      return;\r\n    }\r\n\r\n    rlPlayer.clamped = frame;\r\n    rlPlayer.renderFrame(frame, frameNo);\r\n  };\r\n\r\n  private onPlayerError = (reqId: number, error: Error) => {\r\n    const rlPlayer = this.players[reqId];\r\n    if(rlPlayer) {\r\n      // ! will need refactoring later, this is not the best way to remove the animation\r\n      const animations = animationIntersector.getAnimations(rlPlayer.el);\r\n      animations.forEach(animation => {\r\n        animationIntersector.checkAnimation(animation, true, true);\r\n      });\r\n    }\r\n  };\r\n\r\n  public onDestroy(reqId: number) {\r\n    delete this.players[reqId];\r\n  }\r\n\r\n  public destroyWorkers() {\r\n    this.workers.forEach((worker, idx) => {\r\n      worker.terminate();\r\n      this.log('worker #' + idx + ' terminated');\r\n    });\r\n\r\n    this.log('workers destroyed');\r\n    this.workers.length = 0;\r\n  }\r\n\r\n  private initPlayer(el: HTMLElement, options: RLottieOptions) {\r\n    const rlPlayer = new RLottiePlayer({\r\n      el, \r\n      worker: this.workers[this.curWorkerNum++],\r\n      options\r\n    });\r\n\r\n    this.players[rlPlayer.reqId] = rlPlayer;\r\n    if(this.curWorkerNum >= this.workers.length) {\r\n      this.curWorkerNum = 0;\r\n    }\r\n\r\n    rlPlayer.loadFromData(options.animationData);\r\n\r\n    return rlPlayer;\r\n  }\r\n}\r\n\r\nconst lottieLoader = new LottieLoader();\r\nMOUNT_CLASS_TO.lottieLoader = lottieLoader;\r\nexport default lottieLoader;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport type { DownloadOptions } from \"../mtproto/apiFileManager\";\r\nimport { bytesFromHex } from \"../../helpers/bytes\";\r\nimport { CancellablePromise } from \"../../helpers/cancellablePromise\";\r\nimport { getFileNameByLocation } from \"../../helpers/fileName\";\r\nimport { safeReplaceArrayInObject, isObject } from \"../../helpers/object\";\r\nimport { isSafari } from \"../../helpers/userAgent\";\r\nimport { InputFileLocation, InputMedia, Photo, PhotoSize, PhotosPhotos } from \"../../layer\";\r\nimport apiManager from \"../mtproto/mtprotoworker\";\r\nimport referenceDatabase, { ReferenceContext } from \"../mtproto/referenceDatabase\";\r\nimport { MyDocument } from \"./appDocsManager\";\r\nimport appDownloadManager, { ThumbCache } from \"./appDownloadManager\";\r\nimport appUsersManager from \"./appUsersManager\";\r\nimport blur from \"../../helpers/blur\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport calcImageInBox from \"../../helpers/calcImageInBox\";\r\nimport { makeMediaSize, MediaSize } from \"../../helpers/mediaSizes\";\r\n\r\nexport type MyPhoto = Photo.photo;\r\n\r\n// TIMES = 2 DUE TO SIDEBAR AND CHAT\r\n//let TEST_FILE_REFERENCE = \"5440692274120994569\", TEST_FILE_REFERENCE_TIMES = 2;\r\n\r\nexport class AppPhotosManager {\r\n  private photos: {\r\n    [id: string]: MyPhoto\r\n  } = {};\r\n\r\n  public windowW = 0;\r\n  public windowH = 0;\r\n  \r\n  private static jpegHeader = bytesFromHex('ffd8ffe000104a46494600010100000100010000ffdb004300281c1e231e19282321232d2b28303c64413c37373c7b585d4964918099968f808c8aa0b4e6c3a0aadaad8a8cc8ffcbdaeef5ffffff9bc1fffffffaffe6fdfff8ffdb0043012b2d2d3c353c76414176f8a58ca5f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8ffc00011080000000003012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00');\r\n  private static jpegTail = bytesFromHex('ffd9');\r\n  \r\n  constructor() {\r\n    // @ts-ignore\r\n    const w: any = 'visualViewport' in window ? window.visualViewport : window;\r\n    const set = () => {\r\n      this.windowW = w.width || w.innerWidth;\r\n      this.windowH = w.height || w.innerHeight;\r\n    };\r\n    w.addEventListener('resize', set);\r\n    set();\r\n  }\r\n  \r\n  public savePhoto(photo: Photo, context?: ReferenceContext) {\r\n    if(photo._ === 'photoEmpty') return undefined;\r\n\r\n    /* if(photo.id === TEST_FILE_REFERENCE) {\r\n      console.warn('Testing FILE_REFERENCE_EXPIRED');\r\n      const bytes = [2, 67, 175, 43, 190, 0, 0, 20, 62, 95, 111, 33, 45, 99, 220, 116, 218, 11, 167, 127, 213, 18, 127, 32, 243, 202, 117, 80, 30];\r\n      //photo.file_reference = new Uint8Array(bytes);\r\n      photo.file_reference = bytes;\r\n      if(!--TEST_FILE_REFERENCE_TIMES) {\r\n        TEST_FILE_REFERENCE = '';\r\n      }\r\n    } */\r\n\r\n    const oldPhoto = this.photos[photo.id];\r\n    if(photo.file_reference) { // * because we can have a new object w/o the file_reference while sending\r\n      safeReplaceArrayInObject('file_reference', oldPhoto, photo);\r\n      referenceDatabase.saveContext(photo.file_reference, context);\r\n    }\r\n\r\n    if(photo.sizes?.length) {\r\n      const size = photo.sizes[photo.sizes.length - 1];\r\n      if(size._ === 'photoSizeProgressive') {\r\n        size.size = size.sizes[size.sizes.length - 1];\r\n      }\r\n    }\r\n\r\n    if(oldPhoto) {\r\n      return Object.assign(oldPhoto, photo);\r\n    }\r\n\r\n    return this.photos[photo.id] = photo;\r\n  }\r\n  \r\n  public choosePhotoSize(photo: MyPhoto | MyDocument, boxWidth = 0, boxHeight = 0, useBytes = false) {\r\n    if(window.devicePixelRatio > 1) {\r\n      boxWidth *= 2;\r\n      boxHeight *= 2;\r\n    }\r\n    \r\n    /*\r\n    s\tbox\t100x100\r\n    m\tbox\t320x320\r\n    x\tbox\t800x800\r\n    y\tbox\t1280x1280\r\n    w\tbox\t2560x2560\r\n    a\tcrop\t160x160\r\n    b\tcrop\t320x320\r\n    c\tcrop\t640x640\r\n    d\tcrop\t1280x1280 */\r\n\r\n    let bestPhotoSize: PhotoSize = {_: 'photoSizeEmpty', type: ''};\r\n    const sizes = ((photo as MyPhoto).sizes || (photo as MyDocument).thumbs) as PhotoSize[];\r\n    if(sizes?.length) {\r\n      for(let i = 0, length = sizes.length; i < length; ++i) {\r\n        const photoSize = sizes[i];\r\n        if(!('w' in photoSize) && !('h' in photoSize)) continue;\r\n  \r\n        bestPhotoSize = photoSize;\r\n  \r\n        const size = calcImageInBox(photoSize.w, photoSize.h, boxWidth, boxHeight);\r\n        if(size.width >= boxWidth || size.height >= boxHeight) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if(useBytes && bestPhotoSize._ === 'photoSizeEmpty' && sizes[0]._ === 'photoStrippedSize') {\r\n        bestPhotoSize = sizes[0];\r\n      }\r\n    }\r\n    \r\n    return bestPhotoSize;\r\n  }\r\n  \r\n  public getUserPhotos(userId: number, maxId: string = '0', limit: number = 20) {\r\n    const inputUser = appUsersManager.getUserInput(userId);\r\n    return apiManager.invokeApiCacheable('photos.getUserPhotos', {\r\n      user_id: inputUser,\r\n      offset: 0,\r\n      limit,\r\n      max_id: maxId\r\n    }, {cacheSeconds: 60}).then((photosResult) => {\r\n      appUsersManager.saveApiUsers(photosResult.users);\r\n      const photoIds: string[] = photosResult.photos.map((photo, idx) => {\r\n        photosResult.photos[idx] = this.savePhoto(photo, {type: 'profilePhoto', peerId: userId});\r\n        return photo.id;\r\n      });\r\n      \r\n      return {\r\n        count: (photosResult as PhotosPhotos.photosPhotosSlice).count || photosResult.photos.length,\r\n        photos: photoIds\r\n      };\r\n    });\r\n  }\r\n\r\n  public getPreviewURLFromBytes(bytes: Uint8Array | number[], isSticker = false) {\r\n    let arr: Uint8Array;\r\n    if(!isSticker) {\r\n      arr = new Uint8Array(AppPhotosManager.jpegHeader.concat(Array.from(bytes.slice(3)), AppPhotosManager.jpegTail));\r\n      arr[164] = bytes[1];\r\n      arr[166] = bytes[2];\r\n    } else {\r\n      arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes);\r\n    }\r\n\r\n    let mimeType: string;\r\n    if(isSticker) {\r\n      mimeType = isSafari ? 'image/png' : 'image/webp';\r\n    } else {\r\n      mimeType = 'image/jpeg';\r\n    }\r\n\r\n    const blob = new Blob([arr], {type: mimeType});\r\n    return URL.createObjectURL(blob);\r\n  }\r\n\r\n  /**\r\n   * https://core.telegram.org/api/files#vector-thumbnails\r\n   */\r\n  public getPathFromPhotoPathSize(size: PhotoSize.photoPathSize) {\r\n    const bytes = size.bytes;\r\n    const lookup = \"AACAAAAHAAALMAAAQASTAVAAAZaacaaaahaaalmaaaqastava.az0123456789-,\";\r\n\r\n    let path = 'M';\r\n    for(let i = 0, length = bytes.length; i < length; ++i) {\r\n      const num = bytes[i];\r\n\r\n      if(num >= (128 + 64)) {\r\n        path += lookup[num - 128 - 64];\r\n      } else {\r\n        if(num >= 128) {\r\n          path += ',';\r\n        } else if(num >= 64) {\r\n          path += '-'; \r\n        }\r\n        path += '' + (num & 63);\r\n      }\r\n    }\r\n    path += 'z';\r\n\r\n    return path;\r\n  }\r\n\r\n  public getPreviewURLFromThumb(photo: MyPhoto | MyDocument, thumb: PhotoSize.photoCachedSize | PhotoSize.photoStrippedSize, isSticker = false) {\r\n    const cacheContext = appDownloadManager.getCacheContext(photo, thumb.type);\r\n    return cacheContext.url || (cacheContext.url = this.getPreviewURLFromBytes(thumb.bytes, isSticker));\r\n  }\r\n  \r\n  public getImageFromStrippedThumb(photo: MyPhoto | MyDocument, thumb: PhotoSize.photoCachedSize | PhotoSize.photoStrippedSize, useBlur: boolean) {\r\n    const url = this.getPreviewURLFromThumb(photo, thumb, false);\r\n\r\n    const image = new Image();\r\n    image.classList.add('thumbnail');\r\n\r\n    const loadPromise = (useBlur ? blur(url) : Promise.resolve(url)).then(url => {\r\n      return new Promise<any>((resolve) => {\r\n        renderImageFromUrl(image, url, resolve);\r\n      });\r\n    });\r\n    \r\n    return {image, loadPromise};\r\n  }\r\n  \r\n  public setAttachmentSize(photo: MyPhoto | MyDocument, element: HTMLElement | SVGForeignObjectElement, boxWidth: number, boxHeight: number, noZoom = true, message?: any) {\r\n    const photoSize = this.choosePhotoSize(photo, boxWidth, boxHeight);\r\n    //console.log('setAttachmentSize', photo, photo.sizes[0].bytes, div);\r\n    \r\n    let size: MediaSize;\r\n    if(photo._ === 'document') {\r\n      size = makeMediaSize(photo.w || 512, photo.h || 512);\r\n    } else {\r\n      size = makeMediaSize('w' in photoSize ? photoSize.w : 100, 'h' in photoSize ? photoSize.h : 100);\r\n    }\r\n\r\n    let boxSize = makeMediaSize(boxWidth, boxHeight);\r\n\r\n    boxSize = size = size.aspect(boxSize, noZoom);\r\n\r\n    let isFit = true;\r\n\r\n    if(photo._ === 'photo' || ['video', 'gif'].includes(photo.type)) {\r\n      if(boxSize.width < 200 && boxSize.height < 200) { // make at least one side this big\r\n        boxSize = size = size.aspectCovered(makeMediaSize(200, 200));\r\n      }\r\n  \r\n      if(message && \r\n        (message.message || \r\n          message.reply_to_mid || \r\n          message.media.webpage || \r\n          (message.replies && message.replies.pFlags.comments && message.replies.channel_id !== 777)\r\n        )\r\n      ) { // make sure that bubble block is human-readable\r\n        if(boxSize.width < 320) {\r\n          boxSize = makeMediaSize(320, boxSize.height);\r\n          isFit = false;\r\n        }\r\n      }\r\n  \r\n      if(isFit && boxSize.width < 120) { // if image is too narrow\r\n        boxSize = makeMediaSize(120, boxSize.height);\r\n        isFit = false;\r\n      }\r\n    }\r\n\r\n    // if(element instanceof SVGForeignObjectElement) {\r\n    //   element.setAttributeNS(null, 'width', '' + w);\r\n    //   element.setAttributeNS(null, 'height', '' + h);\r\n\r\n    //   //console.log('set dimensions to svg element:', element, w, h);\r\n    // } else {\r\n      element.style.width = boxSize.width + 'px';\r\n      element.style.height = boxSize.height + 'px';\r\n    // }\r\n    \r\n    return {photoSize, size, isFit};\r\n  }\r\n\r\n  public getStrippedThumbIfNeeded(photo: MyPhoto | MyDocument, cacheContext: ThumbCache, useBlur: boolean, ignoreCache = false): ReturnType<AppPhotosManager['getImageFromStrippedThumb']> {\r\n    if(!cacheContext.downloaded || (['video', 'gif'] as MyDocument['type'][]).includes((photo as MyDocument).type) || ignoreCache) {\r\n      if(photo._ === 'document' && cacheContext.downloaded && !ignoreCache) {\r\n        return null;\r\n      }\r\n\r\n      const sizes = (photo as MyPhoto).sizes || (photo as MyDocument).thumbs;\r\n      const thumb = sizes?.length ? sizes.find(size => size._ === 'photoStrippedSize') : null;\r\n      if(thumb && ('bytes' in thumb)) {\r\n        return this.getImageFromStrippedThumb(photo, thumb as any, useBlur);\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n  \r\n  public getPhotoDownloadOptions(photo: MyPhoto | MyDocument, photoSize: PhotoSize, queueId?: number, onlyCache?: boolean): DownloadOptions {\r\n    const isDocument = photo._ === 'document';\r\n\r\n    if(!photoSize || photoSize._ === 'photoSizeEmpty') {\r\n      //console.error('no photoSize by photo:', photo);\r\n      throw new Error('photoSizeEmpty!');\r\n    }\r\n    \r\n    // maybe it's a thumb\r\n    const isPhoto = (photoSize._ === 'photoSize' || photoSize._ === 'photoSizeProgressive') && photo.access_hash && photo.file_reference;\r\n    const location: InputFileLocation.inputPhotoFileLocation | InputFileLocation.inputDocumentFileLocation = {\r\n      _: isDocument ? 'inputDocumentFileLocation' : 'inputPhotoFileLocation',\r\n      id: photo.id,\r\n      access_hash: photo.access_hash,\r\n      file_reference: photo.file_reference,\r\n      thumb_size: photoSize.type\r\n    };\r\n\r\n    return {\r\n      dcId: photo.dc_id, \r\n      location, \r\n      size: isPhoto ? (photoSize as PhotoSize.photoSize).size : undefined, \r\n      queueId, \r\n      onlyCache\r\n    };\r\n  }\r\n\r\n  /* public getPhotoURL(photo: MTPhoto | MTMyDocument, photoSize: MTPhotoSize) {\r\n    const downloadOptions = this.getPhotoDownloadOptions(photo, photoSize);\r\n\r\n    return {url: getFileURL('photo', downloadOptions), location: downloadOptions.location};\r\n  } */\r\n\r\n  /* public isDownloaded(media: any) {\r\n    const isPhoto = media._ === 'photo';\r\n    const photo = isPhoto ? this.getPhoto(media.id) : null;\r\n    let isDownloaded: boolean;\r\n    if(photo) {\r\n      isDownloaded = photo.downloaded > 0;\r\n    } else {\r\n      const cachedThumb = this.getDocumentCachedThumb(media.id);\r\n      isDownloaded = cachedThumb?.downloaded > 0;\r\n    }\r\n\r\n    return isDownloaded;\r\n  } */\r\n  \r\n  public preloadPhoto(photoId: MyPhoto | MyDocument | string, photoSize?: PhotoSize, queueId?: number, onlyCache?: boolean): CancellablePromise<Blob> {\r\n    const photo = this.getPhoto(photoId);\r\n\r\n    // @ts-ignore\r\n    if(!photo || photo._ === 'photoEmpty') {\r\n      throw new Error('preloadPhoto photoEmpty!');\r\n    }\r\n\r\n    if(!photoSize) {\r\n      const fullWidth = this.windowW;\r\n      const fullHeight = this.windowH;\r\n      \r\n      photoSize = this.choosePhotoSize(photo, fullWidth, fullHeight);\r\n    }\r\n\r\n    const cacheContext = appDownloadManager.getCacheContext(photo, photoSize.type);\r\n    if(cacheContext.downloaded >= ('size' in photoSize ? photoSize.size : 0) && cacheContext.url) {\r\n      return Promise.resolve() as any;\r\n    }\r\n    \r\n    const downloadOptions = this.getPhotoDownloadOptions(photo, photoSize, queueId, onlyCache);\r\n    const fileName = getFileNameByLocation(downloadOptions.location);\r\n\r\n    let download = appDownloadManager.getDownload(fileName);\r\n    if(download) {\r\n      return download;\r\n    }\r\n\r\n    download = appDownloadManager.download(downloadOptions);\r\n    download.then(blob => {\r\n      if(!cacheContext.downloaded || cacheContext.downloaded < blob.size) {\r\n        const url = URL.createObjectURL(blob);\r\n        cacheContext.downloaded = blob.size;\r\n        cacheContext.url = url;\r\n\r\n        //console.log('wrote photo:', photo, photoSize, cacheContext, blob);\r\n      }\r\n\r\n      return blob;\r\n    }).catch(() => {});\r\n\r\n    return download;\r\n  }\r\n  \r\n  public getPhoto(photoId: any/* MyPhoto | string */): MyPhoto {\r\n    return isObject(photoId) ? photoId as MyPhoto : this.photos[photoId as any as string];\r\n  }\r\n\r\n  public getInput(photo: MyPhoto): InputMedia.inputMediaPhoto {\r\n    return {\r\n      _: 'inputMediaPhoto',\r\n      id: {\r\n        _: 'inputPhoto',\r\n        id: photo.id,\r\n        access_hash: photo.access_hash,\r\n        file_reference: photo.file_reference\r\n      },\r\n      ttl_seconds: 0\r\n    };\r\n  }\r\n\r\n  public savePhotoFile(photo: MyPhoto | MyDocument, queueId?: number) {\r\n    const fullPhotoSize = this.choosePhotoSize(photo, 0xFFFF, 0xFFFF);\r\n    if(!(fullPhotoSize._ === 'photoSize' || fullPhotoSize._ === 'photoSizeProgressive')) {\r\n      return;\r\n    }\r\n\r\n    const downloadOptions = this.getPhotoDownloadOptions(photo, fullPhotoSize, queueId);\r\n    downloadOptions.fileName = 'photo' + photo.id + '.jpg';\r\n    appDownloadManager.downloadToDisc(downloadOptions, downloadOptions.fileName);\r\n  }\r\n}\r\n\r\nconst appPhotosManager = new AppPhotosManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.appPhotosManager = appPhotosManager);\r\nexport default appPhotosManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport { isMobileSafari } from \"../helpers/userAgent\";\r\nimport { logger } from \"../lib/logger\";\r\nimport { doubleRaf } from \"../helpers/schedulers\";\r\nimport blurActiveElement from \"../helpers/dom/blurActiveElement\";\r\nimport { cancelEvent } from \"../helpers/dom/cancelEvent\";\r\n\r\nexport type NavigationItem = {\r\n  type: 'left' | 'right' | 'im' | 'chat' | 'popup' | 'media' | 'menu' | \r\n    'esg' | 'multiselect' | 'input-helper' | 'autocomplete-helper' | 'markup' | 'global-search',\r\n  onPop: (canAnimate: boolean) => boolean | void,\r\n  onEscape?: () => boolean,\r\n  noHistory?: boolean,\r\n  noBlurOnPop?: boolean,\r\n};\r\n\r\nexport class AppNavigationController {\r\n  private navigations: Array<NavigationItem> = [];\r\n  private id = Date.now();\r\n  private manual = false;\r\n  private log = logger('NC');\r\n  private debug = true;\r\n  private currentHash = window.location.hash;\r\n  public onHashChange: () => void;\r\n\r\n  constructor() {\r\n    let isPossibleSwipe = false;\r\n    window.addEventListener('popstate', (e) => {\r\n      this.debug && this.log('popstate', e, isPossibleSwipe);\r\n\r\n      if(window.location.hash !== this.currentHash) {\r\n        this.onHashChange && this.onHashChange();\r\n        this.replaceState();\r\n        return;\r\n      }\r\n      this.currentHash = window.location.hash;\r\n\r\n      const id: number = e.state;\r\n      if(id !== this.id/*  && !this.navigations.length */) {\r\n        this.pushState();\r\n        return;\r\n      }\r\n\r\n      const item = this.navigations.pop();\r\n      if(!item) {\r\n        this.pushState();\r\n        return;\r\n      }\r\n\r\n      this.manual = !isPossibleSwipe;\r\n      this.handleItem(item);\r\n      //this.pushState(); // * prevent adding forward arrow\r\n    });\r\n\r\n    window.addEventListener('keydown', (e) => {\r\n      const item = this.navigations[this.navigations.length - 1];\r\n      if(!item) return;\r\n      if(e.key === 'Escape' && (item.onEscape ? item.onEscape() : true)) {\r\n        cancelEvent(e);\r\n        this.back(item.type);\r\n      }\r\n    }, {capture: true, passive: false});\r\n\r\n    if(isMobileSafari) {\r\n      const options = {passive: true};\r\n      window.addEventListener('touchstart', (e) => {\r\n        if(e.touches.length > 1) return;\r\n        this.debug && this.log('touchstart');\r\n\r\n        const detach = () => {\r\n          window.removeEventListener('touchend', onTouchEnd);\r\n          window.removeEventListener('touchmove', onTouchMove);\r\n        };\r\n\r\n        let moved = false;\r\n        const onTouchMove = (e: TouchEvent) => {\r\n          this.debug && this.log('touchmove');\r\n          if(e.touches.length > 1) {\r\n            detach();\r\n            return;\r\n          }\r\n\r\n          moved = true;\r\n        };\r\n\r\n        const onTouchEnd = (e: TouchEvent) => {\r\n          this.debug && this.log('touchend');\r\n          if(e.touches.length > 1 || !moved) {\r\n            detach();\r\n            return;\r\n          }\r\n\r\n          isPossibleSwipe = true;\r\n          doubleRaf().then(() => {\r\n            isPossibleSwipe = false;\r\n          });\r\n\r\n          detach();\r\n        };\r\n\r\n        window.addEventListener('touchend', onTouchEnd, options);\r\n        window.addEventListener('touchmove', onTouchMove, options);\r\n      }, options);\r\n    }\r\n\r\n    history.scrollRestoration = 'manual';\r\n\r\n    this.pushState(); // * push init state\r\n  }\r\n\r\n  private handleItem(item: NavigationItem) {\r\n    const good = item.onPop(!this.manual ? false : undefined);\r\n    this.debug && this.log('popstate, navigation:', item, this.navigations);\r\n    if(good === false) {\r\n      this.pushItem(item);\r\n    } else if(!item.noBlurOnPop) {\r\n      blurActiveElement(); // no better place for it\r\n    }\r\n\r\n    this.manual = false;\r\n  }\r\n\r\n  public findItemByType(type: NavigationItem['type']) {\r\n    for(let i = this.navigations.length - 1; i >= 0; --i) {\r\n      const item = this.navigations[i];\r\n      if(item.type === type) {\r\n        return {item, index: i};\r\n      }\r\n    }\r\n  }\r\n\r\n  public back(type?: NavigationItem['type']) {\r\n    if(type) {\r\n      const ret = this.findItemByType(type);\r\n      if(ret) {\r\n        this.manual = true;\r\n        // ! commented because 'popstate' event will be fired with delay\r\n        //if(ret.index !== (this.navigations.length - 1)) {\r\n          this.navigations.splice(ret.index, 1);\r\n          this.handleItem(ret.item);\r\n          return;\r\n        //}\r\n      }\r\n    }\r\n\r\n    history.back();\r\n  }\r\n\r\n  public pushItem(item: NavigationItem) {\r\n    this.navigations.push(item);\r\n    this.debug && this.log('pushstate', item, this.navigations);\r\n\r\n    if(!item.noHistory) {\r\n      this.pushState();\r\n    }\r\n  }\r\n\r\n  private pushState() {\r\n    this.manual = false;\r\n    history.pushState(this.id, '');\r\n  }\r\n\r\n  public replaceState() {\r\n    history.replaceState(this.id, '', location.origin + location.pathname);\r\n  }\r\n\r\n  public removeItem(item: NavigationItem) {\r\n    this.navigations.findAndSplice(i => i === item);\r\n  }\r\n\r\n  public removeByType(type: NavigationItem['type'], single = false) {\r\n    for(let i = this.navigations.length - 1; i >= 0; --i) {\r\n      const item = this.navigations[i];\r\n      if(item.type === type) {\r\n        this.navigations.splice(i, 1);\r\n\r\n        if(single) {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nconst appNavigationController = new AppNavigationController();\r\nMOUNT_CLASS_TO.appNavigationController = appNavigationController;\r\nexport default appNavigationController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { DownloadOptions } from \"../mtproto/apiFileManager\";\r\nimport type { ApiError } from \"../mtproto/apiManager\";\r\nimport type { MyDocument } from \"./appDocsManager\";\r\nimport type { MyPhoto } from \"./appPhotosManager\";\r\nimport rootScope from \"../rootScope\";\r\nimport apiManager from \"../mtproto/mtprotoworker\";\r\nimport { deferredPromise, CancellablePromise } from \"../../helpers/cancellablePromise\";\r\nimport { InputFile } from \"../../layer\";\r\nimport referenceDatabase, {ReferenceBytes} from \"../mtproto/referenceDatabase\";\r\nimport { getFileNameByLocation } from \"../../helpers/fileName\";\r\nimport CacheStorageController from \"../cacheStorage\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\n\r\nexport type ResponseMethodBlob = 'blob';\r\nexport type ResponseMethodJson = 'json';\r\nexport type ResponseMethod = ResponseMethodBlob | ResponseMethodJson;\r\n\r\n/* export type DownloadBlob = {promise: Promise<Blob>, controller: AbortController};\r\nexport type DownloadJson = {promise: Promise<any>, controller: AbortController}; */\r\nexport type DownloadBlob = CancellablePromise<Blob>;\r\nexport type DownloadJson = CancellablePromise<any>;\r\n//export type Download = DownloadBlob/*  | DownloadJson */;\r\nexport type Download = DownloadBlob/*  | DownloadJson */;\r\n\r\nexport type Progress = {done: number, fileName: string, total: number, offset: number};\r\nexport type ProgressCallback = (details: Progress) => void;\r\n\r\nexport type ThumbCache = {\r\n  downloaded: number, \r\n  url: string\r\n};\r\n\r\nexport type ThumbsCache = {\r\n  [id: string]: {\r\n    [size: string]: ThumbCache\r\n  }\r\n};\r\n\r\nexport class AppDownloadManager {\r\n  public cacheStorage = new CacheStorageController('cachedFiles');\r\n  private downloads: {[fileName: string]: Download} = {};\r\n  private progress: {[fileName: string]: Progress} = {};\r\n  private progressCallbacks: {[fileName: string]: Array<ProgressCallback>} = {};\r\n\r\n  private uploadId = 0;\r\n\r\n  private thumbsCache: {\r\n    photo: ThumbsCache,\r\n    document: ThumbsCache\r\n  } = {\r\n    photo: {},\r\n    document: {}\r\n  };\r\n\r\n  constructor() {\r\n    rootScope.addEventListener('download_progress', (e) => {\r\n      const details = e as {done: number, fileName: string, total: number, offset: number};\r\n      this.progress[details.fileName] = details;\r\n\r\n      const callbacks = this.progressCallbacks[details.fileName];\r\n      if(callbacks) {\r\n        callbacks.forEach(callback => callback(details));\r\n      }\r\n\r\n      const download = this.downloads[details.fileName];\r\n      if(download) {\r\n        download.notifyAll(details);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getNewDeferred(fileName: string) {\r\n    const deferred = deferredPromise<Blob>();\r\n\r\n    deferred.cancel = () => {\r\n      //try {\r\n        const error = new Error('Download canceled');\r\n        error.name = 'AbortError';\r\n        \r\n        apiManager.cancelDownload(fileName);\r\n        \r\n        deferred.reject(error);\r\n        deferred.cancel = () => {};\r\n      /* } catch(err) {\r\n\r\n      } */\r\n    };\r\n\r\n    deferred.finally(() => {\r\n      delete this.progress[fileName];\r\n      delete this.progressCallbacks[fileName];\r\n    });\r\n\r\n    deferred.catch(() => {\r\n      this.clearDownload(fileName);\r\n    });\r\n\r\n    return this.downloads[fileName] = deferred;\r\n  }\r\n\r\n  private clearDownload(fileName: string) {\r\n    delete this.downloads[fileName];\r\n  }\r\n\r\n  public fakeDownload(fileName: string, value: Blob | string) {\r\n    const deferred = this.getNewDeferred(fileName);\r\n    if(typeof(value) === 'string') {\r\n      fetch(value)\r\n      .then(response => response.blob())\r\n      .then(blob => deferred.resolve(blob));\r\n    } else {\r\n      deferred.resolve(value);\r\n    }\r\n\r\n    return deferred;\r\n  }\r\n\r\n  public download(options: DownloadOptions): DownloadBlob {\r\n    const fileName = getFileNameByLocation(options.location, {fileName: options.fileName});\r\n    if(this.downloads.hasOwnProperty(fileName)) return this.downloads[fileName];\r\n\r\n    const deferred = this.getNewDeferred(fileName);\r\n\r\n    const onError = (err: ApiError) => {\r\n      switch(err.type) {\r\n        case 'FILE_REFERENCE_EXPIRED': {\r\n          // @ts-ignore\r\n          const bytes: ReferenceBytes = options?.location?.file_reference;\r\n          if(bytes) {\r\n            referenceDatabase.refreshReference(bytes).then(tryDownload);\r\n            /* referenceDatabase.refreshReference(bytes).then(() => {\r\n              console.log('FILE_REFERENCE_EXPIRED: refreshed reference', bytes);\r\n            }); */\r\n            break;\r\n          } else {\r\n            console.warn('FILE_REFERENCE_EXPIRED: no context for bytes:', bytes);\r\n          }\r\n        }\r\n\r\n        default:\r\n          deferred.reject(err);\r\n          break;\r\n      }\r\n    };\r\n\r\n    const tryDownload = (): Promise<unknown> => {\r\n      //return Promise.resolve();\r\n\r\n      if(!apiManager.worker || options.onlyCache) {\r\n        const promise = this.cacheStorage.getFile(fileName).then((blob) => {\r\n          if(blob.size < options.size) throw 'wrong size';\r\n          else deferred.resolve(blob);\r\n        });\r\n        \r\n        if(options.onlyCache) return promise.catch(onError);\r\n        return promise.catch(() => {\r\n          return apiManager.downloadFile(options).then(deferred.resolve, onError);\r\n        });\r\n      } else {\r\n        /* return apiManager.downloadFile(options).then(res => {\r\n          setTimeout(() => deferred.resolve(res), 5e3);\r\n        }, onError); */\r\n\r\n        return apiManager.downloadFile(options).then(deferred.resolve, onError);\r\n      }\r\n    };\r\n\r\n    tryDownload();\r\n\r\n    //console.log('Will download file:', fileName, url);\r\n    return deferred;\r\n  }\r\n\r\n  public upload(file: File | Blob, fileName?: string) {\r\n    if(!fileName) {\r\n      const mimeType = file?.type;\r\n      if(mimeType) { // the same like apiFileName in appMessagesManager for upload!\r\n        const ext = this.uploadId++ + '.' + mimeType.split('/')[1];\r\n  \r\n        if(['image/jpeg', 'image/png', 'image/bmp'].indexOf(mimeType) >= 0) {\r\n          fileName = 'photo' + ext;\r\n        } else if(mimeType.indexOf('audio/') === 0 || ['video/ogg'].indexOf(mimeType) >= 0) {\r\n          fileName = 'audio' + ext;\r\n        } else if(mimeType.indexOf('video/') === 0) {\r\n          fileName = 'video' + ext;\r\n        } else {\r\n          fileName = 'document' + ext;\r\n        }\r\n        \r\n      } else {\r\n        fileName = 'upload-' + this.uploadId++;\r\n      }\r\n    }\r\n\r\n    const deferred = this.getNewDeferred(fileName);\r\n    apiManager.uploadFile({file, fileName}).then(deferred.resolve, deferred.reject);\r\n\r\n    deferred.finally(() => {\r\n      this.clearDownload(fileName);\r\n    });\r\n\r\n    return deferred as any as CancellablePromise<InputFile>;\r\n  }\r\n\r\n  public getDownload(fileName: string) {\r\n    return this.downloads[fileName];\r\n  }\r\n\r\n  public addProgressCallback(fileName: string, callback: ProgressCallback) {\r\n    const progress = this.progress[fileName];\r\n    (this.progressCallbacks[fileName] ?? (this.progressCallbacks[fileName] = [])).push(callback);\r\n\r\n    if(progress) {\r\n      callback(progress);\r\n    }\r\n  }\r\n\r\n  public createDownloadAnchor(url: string, fileName: string, onRemove?: () => void) {\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = fileName;\r\n    a.target = '_blank';\r\n    \r\n    a.style.position = 'absolute';\r\n    a.style.top = '1px';\r\n    a.style.left = '1px';\r\n    \r\n    document.body.append(a);\r\n  \r\n    try {\r\n      var clickEvent = document.createEvent('MouseEvents');\r\n      clickEvent.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);\r\n      a.dispatchEvent(clickEvent);\r\n    } catch (e) {\r\n      console.error('Download click error', e);\r\n      try {\r\n        a.click();\r\n      } catch (e) {\r\n        window.open(url as string, '_blank');\r\n      }\r\n    }\r\n    \r\n    setTimeout(() => {\r\n      a.remove();\r\n      onRemove && onRemove();\r\n    }, 100);\r\n  }\r\n\r\n  /* public downloadToDisc(fileName: string, url: string) {\r\n    this.createDownloadAnchor(url);\r\n  \r\n    return this.download(fileName, url);\r\n  } */\r\n\r\n  public downloadToDisc(options: DownloadOptions, discFileName: string) {\r\n    const download = this.download(options);\r\n    download/* .promise */.then(blob => {\r\n      const objectURL = URL.createObjectURL(blob);\r\n      this.createDownloadAnchor(objectURL, discFileName, () => {\r\n        URL.revokeObjectURL(objectURL);\r\n      });\r\n    });\r\n  \r\n    return download;\r\n  }\r\n\r\n  public getCacheContext(media: MyPhoto | MyDocument, thumbSize: string = 'full'): ThumbCache {\r\n    /* if(media._ === 'photo' && thumbSize !== 'i') {\r\n      thumbSize = 'full';\r\n    } */\r\n\r\n    const cache = this.thumbsCache[media._][media.id] ?? (this.thumbsCache[media._][media.id] = {});\r\n    return cache[thumbSize] ?? (cache[thumbSize] = {downloaded: 0, url: ''});\r\n  }\r\n}\r\n\r\nconst appDownloadManager = new AppDownloadManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.appDownloadManager = appDownloadManager);\r\nexport default appDownloadManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// * Jolly Cobra's useHeavyAnimationCheck.ts, patched\r\n\r\nimport { AnyToVoidFunction } from '../types';\r\nimport ListenerSetter from '../helpers/listenerSetter';\r\nimport { CancellablePromise, deferredPromise } from '../helpers/cancellablePromise';\r\nimport { pause } from '../helpers/schedulers';\r\nimport rootScope from '../lib/rootScope';\r\nimport DEBUG from '../config/debug';\r\n\r\nconst ANIMATION_START_EVENT = 'event-heavy-animation-start';\r\nconst ANIMATION_END_EVENT = 'event-heavy-animation-end';\r\n\r\nlet isAnimating = false;\r\nlet heavyAnimationPromise: CancellablePromise<void> = deferredPromise<void>();\r\nlet promisesInQueue = 0;\r\n\r\nheavyAnimationPromise.resolve();\r\n\r\nconst log = console.log.bind(console.log, '[HEAVY-ANIMATION]:');\r\n\r\nexport function dispatchHeavyAnimationEvent(promise: Promise<any>, timeout?: number) {\r\n  if(!isAnimating) {\r\n    heavyAnimationPromise = deferredPromise<void>();\r\n    rootScope.dispatchEvent(ANIMATION_START_EVENT);\r\n    isAnimating = true;\r\n    DEBUG && log('start');\r\n  }\r\n  \r\n  ++promisesInQueue;\r\n  DEBUG && log('attach promise, length:', promisesInQueue, timeout);\r\n\r\n  const promises = [\r\n    timeout !== undefined ? pause(timeout) : undefined,\r\n    promise.finally(() => {})\r\n  ].filter(Boolean);\r\n\r\n  const perf = performance.now();\r\n  const _heavyAnimationPromise = heavyAnimationPromise;\r\n  Promise.race(promises).then(() => {\r\n    if(heavyAnimationPromise !== _heavyAnimationPromise || heavyAnimationPromise.isFulfilled) { // interrupted\r\n      return;\r\n    }\r\n\r\n    --promisesInQueue;\r\n    DEBUG && log('promise end, length:', promisesInQueue, performance.now() - perf);\r\n    if(promisesInQueue <= 0) {\r\n      onHeavyAnimationEnd();\r\n    }\r\n  });\r\n\r\n  return heavyAnimationPromise;\r\n}\r\n\r\nfunction onHeavyAnimationEnd() {\r\n  if(heavyAnimationPromise.isFulfilled) {\r\n    return;\r\n  }\r\n\r\n  isAnimating = false;\r\n  promisesInQueue = 0;\r\n  rootScope.dispatchEvent(ANIMATION_END_EVENT);\r\n  heavyAnimationPromise.resolve();\r\n\r\n  DEBUG && log('end');\r\n}\r\n\r\nexport function interruptHeavyAnimation() {\r\n  onHeavyAnimationEnd();\r\n}\r\n\r\nexport function getHeavyAnimationPromise() {\r\n  return heavyAnimationPromise;\r\n}\r\n\r\nexport default function(\r\n  handleAnimationStart: AnyToVoidFunction,\r\n  handleAnimationEnd: AnyToVoidFunction,\r\n  listenerSetter?: ListenerSetter\r\n) {\r\n  //useEffect(() => {\r\n    if(isAnimating) {\r\n      handleAnimationStart();\r\n    }\r\n\r\n    const add = listenerSetter ? listenerSetter.add.bind(listenerSetter, rootScope) : rootScope.addEventListener.bind(rootScope);\r\n    const remove = listenerSetter ? listenerSetter.removeManual.bind(listenerSetter, rootScope) : rootScope.removeEventListener.bind(rootScope);\r\n    add(ANIMATION_START_EVENT, handleAnimationStart);\r\n    add(ANIMATION_END_EVENT, handleAnimationEnd);\r\n\r\n    return () => {\r\n      remove(ANIMATION_END_EVENT, handleAnimationEnd);\r\n      remove(ANIMATION_START_EVENT, handleAnimationStart);\r\n    };\r\n  //}, [handleAnimationEnd, handleAnimationStart]);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\n/* export function isInDOM(element: Element, parentNode?: HTMLElement): boolean {\r\n  if(!element) {\r\n    return false;\r\n  }\r\n\r\n  parentNode = parentNode || document.body;\r\n  if(element === parentNode) {\r\n    return true;\r\n  }\r\n  return isInDOM(element.parentNode as HTMLElement, parentNode);\r\n} */\r\nexport default function isInDOM(element: Element): boolean {\r\n  return element?.isConnected;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport appPeersManager from \"../lib/appManagers/appPeersManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { i18n } from \"../lib/langPack\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport appUsersManager from \"../lib/appManagers/appUsersManager\";\r\n\r\nexport type PeerTitleOptions = {\r\n  peerId: number,\r\n  plainText?: boolean,\r\n  onlyFirstName?: boolean,\r\n  dialog?: boolean\r\n};\r\n\r\nconst weakMap: WeakMap<HTMLElement, PeerTitle> = new WeakMap();\r\n\r\nMOUNT_CLASS_TO.peerTitleWeakMap = weakMap;\r\n\r\nrootScope.addEventListener('peer_title_edit', (peerId) => {\r\n  const elements = Array.from(document.querySelectorAll(`.peer-title[data-peer-id=\"${peerId}\"]`)) as HTMLElement[];\r\n  elements.forEach(element => {\r\n    const peerTitle = weakMap.get(element);\r\n    //console.log('in the summer silence i was doing nothing', peerTitle, peerId);\r\n\r\n    if(peerTitle) {\r\n      peerTitle.update();\r\n    }\r\n  });\r\n});\r\n\r\nexport default class PeerTitle {\r\n  public element: HTMLElement;\r\n  public peerId: number;\r\n  public plainText = false;\r\n  public onlyFirstName = false;\r\n  public dialog = false;\r\n\r\n  constructor(options: PeerTitleOptions) {\r\n    this.element = document.createElement('span');\r\n    this.element.classList.add('peer-title');\r\n    this.element.setAttribute('dir', 'auto');\r\n    \r\n    this.update(options);\r\n    weakMap.set(this.element, this);\r\n  }\r\n\r\n  public update(options?: PeerTitleOptions) {\r\n    if(options) {\r\n      for(let i in options) {\r\n        // @ts-ignore\r\n        this.element.dataset[i] = options[i] ? '' + (typeof(options[i]) === 'boolean' ? +options[i] : options[i]) : '0';\r\n        // @ts-ignore\r\n        this[i] = options[i];\r\n      }\r\n    }\r\n\r\n    if(this.peerId !== rootScope.myId || !this.dialog) {\r\n      if(this.peerId > 0 && appUsersManager.getUser(this.peerId).pFlags.deleted) {\r\n        replaceContent(this.element, i18n(this.onlyFirstName ? 'Deleted' : 'HiddenName'));\r\n      } else {\r\n        this.element.innerHTML = appPeersManager.getPeerTitle(this.peerId, this.plainText, this.onlyFirstName);\r\n      }\r\n    } else {\r\n      replaceContent(this.element, i18n(this.onlyFirstName ? 'Saved' : 'SavedMessages'));\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// * Jolly Cobra's fastSmoothScroll slightly patched\r\n\r\nimport { dispatchHeavyAnimationEvent } from '../hooks/useHeavyAnimationCheck';\r\nimport { fastRaf } from './schedulers';\r\nimport { animateSingle, cancelAnimationByKey } from './animation';\r\nimport rootScope from '../lib/rootScope';\r\nimport isInDOM from './dom/isInDOM';\r\n\r\nconst MAX_DISTANCE = 1500;\r\nconst MIN_JS_DURATION = 250;\r\nconst MAX_JS_DURATION = 600;\r\n\r\nexport enum FocusDirection {\r\n  Up,\r\n  Down,\r\n  Static,\r\n};\r\n\r\nexport default function fastSmoothScroll(\r\n  container: HTMLElement,\r\n  element: HTMLElement,\r\n  position: ScrollLogicalPosition,\r\n  margin = 0,\r\n  maxDistance = MAX_DISTANCE,\r\n  forceDirection?: FocusDirection,\r\n  forceDuration?: number,\r\n  axis: 'x' | 'y' = 'y'\r\n) {\r\n  //return;\r\n\r\n  if(!rootScope.settings.animationsEnabled) {\r\n    forceDirection = FocusDirection.Static;\r\n  }\r\n\r\n  if(forceDirection === FocusDirection.Static) {\r\n    forceDuration = 0;\r\n    return scrollWithJs(container, element, position, margin, forceDuration, axis);\r\n    /* return Promise.resolve();\r\n\r\n    element.scrollIntoView({ block: position });\r\n\r\n    cancelAnimationByKey(container);\r\n    return Promise.resolve(); */\r\n  }\r\n\r\n  if(axis === 'y' && element !== container && isInDOM(element) && container.getBoundingClientRect) {\r\n    const elementRect = element.getBoundingClientRect();\r\n    const containerRect = container.getBoundingClientRect();\r\n  \r\n    const offsetTop = elementRect.top - containerRect.top;\r\n    if(forceDirection === undefined) {\r\n      if(offsetTop < -maxDistance) {\r\n        container.scrollTop += (offsetTop + maxDistance);\r\n      } else if(offsetTop > maxDistance) {\r\n        container.scrollTop += (offsetTop - maxDistance);\r\n      }\r\n    } else if(forceDirection === FocusDirection.Up) { // * not tested yet\r\n      container.scrollTop = offsetTop + container.scrollTop + maxDistance;\r\n    } else if(forceDirection === FocusDirection.Down) { // * not tested yet\r\n      container.scrollTop = Math.max(0, offsetTop + container.scrollTop - maxDistance);\r\n    }\r\n    /* const { offsetTop } = element;\r\n\r\n    if(forceDirection === undefined) {\r\n      const offset = offsetTop - container.scrollTop;\r\n\r\n      if(offset < -maxDistance) {\r\n        container.scrollTop += (offset + maxDistance);\r\n      } else if(offset > maxDistance) {\r\n        container.scrollTop += (offset - maxDistance);\r\n      }\r\n    } else if(forceDirection === FocusDirection.Up) {\r\n      container.scrollTop = offsetTop + maxDistance;\r\n    } else if(forceDirection === FocusDirection.Down) {\r\n      container.scrollTop = Math.max(0, offsetTop - maxDistance);\r\n    } */\r\n  }\r\n\r\n  const promise = new Promise((resolve) => {\r\n    fastRaf(() => {\r\n      scrollWithJs(container, element, position, margin, forceDuration, axis)\r\n      .then(resolve);\r\n    });\r\n  });\r\n\r\n  return axis === 'y' ? dispatchHeavyAnimationEvent(promise) : promise;\r\n}\r\n\r\nfunction scrollWithJs(\r\n  container: HTMLElement, element: HTMLElement, position: ScrollLogicalPosition, margin = 0, forceDuration?: number, axis: 'x' | 'y' = 'y'\r\n) {\r\n  if(!isInDOM(element)) {\r\n    cancelAnimationByKey(container);\r\n    return Promise.resolve();\r\n  }\r\n  \r\n  const rectStartKey = axis === 'y' ? 'top' : 'left';\r\n  const rectEndKey = axis === 'y' ? 'bottom' : 'right';\r\n  const sizeKey = axis === 'y' ? 'height' : 'width';\r\n  const scrollSizeKey = axis === 'y' ? 'scrollHeight' : 'scrollWidth';\r\n  const scrollPositionKey = axis === 'y' ? 'scrollTop' : 'scrollLeft';\r\n\r\n  //const { offsetTop: elementTop, offsetHeight: elementHeight } = element;\r\n  const elementRect = element.getBoundingClientRect();\r\n  const containerRect = container.getBoundingClientRect ? container.getBoundingClientRect() : document.body.getBoundingClientRect();\r\n\r\n  //const transformable = container.firstElementChild as HTMLElement;\r\n\r\n  const elementPosition = elementRect[rectStartKey] - containerRect[rectStartKey];\r\n  const elementSize = element[scrollSizeKey]; // margin is exclusive in DOMRect\r\n\r\n  const containerSize = containerRect[sizeKey];\r\n\r\n  const scrollPosition = container[scrollPositionKey];\r\n  const scrollSize = container[scrollSizeKey];\r\n  /* const elementPosition = element.offsetTop;\r\n  const elementSize = element.offsetHeight;\r\n\r\n  const scrollPosition = container[scrollPositionKey];\r\n  const scrollSize = container[scrollSizeKey];\r\n  const containerSize = container.offsetHeight; */\r\n\r\n  let path!: number;\r\n\r\n  switch(position) {\r\n    case 'start':\r\n      path = elementPosition - margin;\r\n      break;\r\n    case 'end':\r\n      path = elementRect[rectEndKey] + (elementSize - elementRect[sizeKey]) - containerRect[rectEndKey];\r\n      break;\r\n    // 'nearest' is not supported yet\r\n    case 'nearest':\r\n    case 'center':\r\n      path = elementSize < containerSize\r\n        ? (elementPosition + elementSize / 2) - (containerSize / 2)\r\n        : elementPosition - margin;\r\n      break;\r\n  }\r\n  /* switch (position) {\r\n    case 'start':\r\n      path = (elementPosition - margin) - scrollPosition;\r\n      break;\r\n    case 'end':\r\n      path = (elementPosition + elementSize + margin) - (scrollPosition + containerSize);\r\n      break;\r\n    // 'nearest' is not supported yet\r\n    case 'nearest':\r\n    case 'center':\r\n      path = elementSize < containerSize\r\n        ? (elementPosition + elementSize / 2) - (scrollPosition + containerSize / 2)\r\n        : (elementPosition - margin) - scrollPosition;\r\n      break;\r\n  } */\r\n\r\n  // console.log('scrollWithJs: will scroll path:', path, element);\r\n\r\n  /* let existsTransform = 0;\r\n  const currentTransform = transformable.style.transform;\r\n  if(currentTransform) {\r\n    existsTransform = parseInt(currentTransform.match(/\\((.+?), (.+?), .+\\)/)[2]);\r\n    //path += existsTransform;\r\n  } */\r\n\r\n  if(path < 0) {\r\n    const remainingPath = -scrollPosition;\r\n    path = Math.max(path, remainingPath);\r\n  } else if(path > 0) {\r\n    const remainingPath = scrollSize - (scrollPosition + containerSize);\r\n    path = Math.min(path, remainingPath);\r\n  }\r\n\r\n  const target = container[scrollPositionKey] + path;\r\n  const duration = forceDuration ?? (\r\n    MIN_JS_DURATION + (Math.abs(path) / MAX_DISTANCE) * (MAX_JS_DURATION - MIN_JS_DURATION)\r\n  );\r\n  const startAt = Date.now();\r\n\r\n  /* transformable.classList.add('no-transition');\r\n\r\n  const tickTransform = () => {\r\n    const t = duration ? Math.min((Date.now() - startAt) / duration, 1) : 1;\r\n    const currentPath = path * transition(t);\r\n\r\n    transformable.style.transform = `translate3d(0, ${-currentPath}px, 0)`;\r\n    container.dataset.translate = '' + -currentPath;\r\n\r\n    const willContinue = t < 1;\r\n    if(!willContinue) {\r\n      fastRaf(() => {\r\n        delete container.dataset.transform;\r\n        container.dataset.transform = '';\r\n        transformable.style.transform = '';\r\n        void transformable.offsetLeft; // reflow\r\n        transformable.classList.remove('no-transition');\r\n        void transformable.offsetLeft; // reflow\r\n        container[scrollPositionKey] = Math.round(target);\r\n      });\r\n    }\r\n\r\n    return willContinue;\r\n  };\r\n  \r\n  return animateSingle(tickTransform, container); */\r\n\r\n  /* return new Promise((resolve) => {\r\n    fastRaf(() => {\r\n      transformable.style.transform = '';\r\n      transformable.style.transition = '';\r\n\r\n      setTimeout(resolve, duration);\r\n    });\r\n  });\r\n\r\n  const transformableHeight = transformable.scrollHeight;\r\n  //transformable.style.minHeight = `${transformableHeight}px`;\r\n  */\r\n\r\n  const tick = () => {\r\n    const t = duration ? Math.min((Date.now() - startAt) / duration, 1) : 1;\r\n\r\n    const currentPath = path * (1 - transition(t));\r\n    container[scrollPositionKey] = Math.round(target - currentPath);\r\n    \r\n    return t < 1;\r\n  };\r\n\r\n  if(!duration || !path) {\r\n    cancelAnimationByKey(container);\r\n    tick();\r\n    return Promise.resolve();\r\n  }\r\n\r\n  /* return new Promise((resolve) => {\r\n    setTimeout(resolve, duration);\r\n  }).then(() => {\r\n    transformable.classList.add('no-transition');\r\n    void transformable.offsetLeft; // reflow\r\n    transformable.style.transform = '';\r\n    transformable.style.transition = '';\r\n    void transformable.offsetLeft; // reflow\r\n    transformable.classList.remove('no-transition');\r\n    void transformable.offsetLeft; // reflow\r\n    fastRaf(() => {\r\n      \r\n      container[scrollPositionKey] = Math.round(target);\r\n      //transformable.style.minHeight = ``;\r\n    });\r\n    \r\n  }); */\r\n\r\n  return animateSingle(tick, container);\r\n}\r\n\r\nfunction transition(t: number) {\r\n  return 1 - ((1 - t) ** 3.5);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { RLottiePlayer } from \"../lib/lottieLoader\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { isSafari } from \"../helpers/userAgent\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport isInDOM from \"../helpers/dom/isInDOM\";\r\n\r\nexport interface AnimationItem {\r\n  el: HTMLElement,\r\n  group: string,\r\n  animation: RLottiePlayer | HTMLVideoElement\r\n};\r\n\r\nexport class AnimationIntersector {\r\n  public observer: IntersectionObserver;\r\n  private visible: Set<AnimationItem> = new Set();\r\n\r\n  private byGroups: {[group: string]: AnimationItem[]} = {};\r\n  private lockedGroups: {[group: string]: true} = {};\r\n  private onlyOnePlayableGroup: string = '';\r\n  \r\n  private intersectionLockedGroups: {[group: string]: true} = {};\r\n  private videosLocked = false;\r\n\r\n  constructor() {\r\n    this.observer = new IntersectionObserver((entries) => {\r\n      if(rootScope.idle.isIDLE) return;\r\n\r\n      for(const entry of entries) {\r\n        const target = entry.target;\r\n\r\n        for(const group in this.byGroups) {\r\n          if(this.intersectionLockedGroups[group]) {\r\n            continue;\r\n          }\r\n\r\n          const player = this.byGroups[group].find(p => p.el === target);\r\n          if(player) {\r\n            if(entry.isIntersecting) {\r\n              this.visible.add(player);\r\n              this.checkAnimation(player, false);\r\n            } else {\r\n              this.visible.delete(player);\r\n              this.checkAnimation(player, true);\r\n\r\n              if(player.animation instanceof RLottiePlayer/*  && player.animation.cachingDelta === 2 */) {\r\n                //console.warn('will clear cache', player);\r\n                player.animation.clearCache();\r\n              }\r\n            }\r\n\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('audio_play', ({doc}) => {\r\n      if(doc.type === 'round') {\r\n        this.videosLocked = true;\r\n        this.checkAnimations();\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('audio_pause', () => {\r\n      if(this.videosLocked) {\r\n        this.videosLocked = false;\r\n        this.checkAnimations();\r\n      }\r\n    });\r\n  }\r\n\r\n  public getAnimations(element: HTMLElement) {\r\n    const found: AnimationItem[] = [];\r\n    for(const group in this.byGroups) {\r\n      for(const player of this.byGroups[group]) {\r\n        if(player.el === element) {\r\n          found.push(player);\r\n        }\r\n      }\r\n    }\r\n\r\n    return found;\r\n  }\r\n\r\n  public removeAnimation(player: AnimationItem) {\r\n    //console.log('destroy animation');\r\n    const {el, animation} = player;\r\n    animation.remove();\r\n\r\n    if(animation instanceof HTMLVideoElement && isSafari) {\r\n      setTimeout(() => { // TODO: очистка по очереди, а не все вместе с этим таймаутом\r\n        animation.src = '';\r\n        animation.load();\r\n      }, 1e3);\r\n    }\r\n\r\n    for(const group in this.byGroups) {\r\n      this.byGroups[group].findAndSplice(p => p === player);\r\n    }\r\n  \r\n    this.observer.unobserve(el);\r\n    this.visible.delete(player);\r\n  }\r\n\r\n  public addAnimation(animation: RLottiePlayer | HTMLVideoElement, group = '') {\r\n    const player = {\r\n      el: animation instanceof RLottiePlayer ? animation.el : animation, \r\n      animation: animation, \r\n      group\r\n    };\r\n\r\n    if(animation instanceof RLottiePlayer) {\r\n      if(!rootScope.settings.stickers.loop && animation.loop) {\r\n        animation.loop = rootScope.settings.stickers.loop;\r\n      }\r\n    }\r\n\r\n    (this.byGroups[group] ?? (this.byGroups[group] = [])).push(player);\r\n    this.observer.observe(player.el);\r\n  }\r\n\r\n  public checkAnimations(blurred?: boolean, group?: string, destroy = false) {\r\n    if(rootScope.idle.isIDLE) return;\r\n    \r\n    const groups = group /* && false */ ? [group] : Object.keys(this.byGroups);\r\n\r\n    if(group && !this.byGroups[group]) {\r\n      //console.warn('no animation group:', group);\r\n      this.byGroups[group] = [];\r\n      return;\r\n    }\r\n\r\n    for(const group of groups) {\r\n      const animations = this.byGroups[group];\r\n\r\n      animations.forEach(player => {\r\n        this.checkAnimation(player, blurred, destroy);\r\n      });\r\n    }\r\n  }\r\n\r\n  public checkAnimation(player: AnimationItem, blurred = false, destroy = false) {\r\n    const {el, animation, group} = player;\r\n    //return;\r\n    if((destroy || (!isInDOM(el) && !this.lockedGroups[group]))/*  && false */) {\r\n      this.removeAnimation(player);\r\n      return;\r\n    }\r\n\r\n    if(blurred || (this.onlyOnePlayableGroup && this.onlyOnePlayableGroup !== group) || (animation instanceof HTMLVideoElement && this.videosLocked)) {\r\n      if(!animation.paused) {\r\n        //console.warn('pause animation:', animation);\r\n        animation.pause();\r\n      }\r\n    } else if(animation.paused && \r\n      this.visible.has(player) && \r\n      animation.autoplay && \r\n      (!this.onlyOnePlayableGroup || this.onlyOnePlayableGroup === group)\r\n    ) {\r\n      //console.warn('play animation:', animation);\r\n      animation.play();\r\n    }\r\n  }\r\n\r\n  public setOnlyOnePlayableGroup(group: string) {\r\n    this.onlyOnePlayableGroup = group;\r\n  }\r\n\r\n  public lockGroup(group: string) {\r\n    this.lockedGroups[group] = true;\r\n  }\r\n\r\n  public unlockGroup(group: string) {\r\n    delete this.lockedGroups[group];\r\n    this.checkAnimations(undefined, group);\r\n  }\r\n\r\n  public refreshGroup(group: string) {\r\n    const animations = this.byGroups[group];\r\n    if(animations && animations.length) {\r\n      animations.forEach(animation => {\r\n        this.observer.unobserve(animation.el);\r\n      });\r\n\r\n      window.requestAnimationFrame(() => {\r\n        animations.forEach(animation => {\r\n          this.observer.observe(animation.el);\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  public lockIntersectionGroup(group: string) {\r\n    this.intersectionLockedGroups[group] = true;\r\n  }\r\n\r\n  public unlockIntersectionGroup(group: string) {\r\n    delete this.intersectionLockedGroups[group];\r\n    this.refreshGroup(group);\r\n  }\r\n}\r\n\r\nconst animationIntersector = new AnimationIntersector();\r\nif(MOUNT_CLASS_TO) {\r\n  MOUNT_CLASS_TO.animationIntersector = animationIntersector;\r\n}\r\nexport default animationIntersector;","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport function numberThousandSplitter(x: number, joiner = ' ') {\r\n  const parts = x.toString().split(\".\");\r\n  parts[0] = parts[0].replace(/\\B(?=(\\d{3})+(?!\\d))/g, joiner);\r\n  return parts.join(\".\");\r\n}\r\n\r\nexport function formatBytes(bytes: number, decimals = 2) {\r\n  if(bytes === 0) return '0 Bytes';\r\n\r\n  const k = 1024;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\r\n\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];\r\n}\r\n\r\nexport function formatNumber(bytes: number, decimals = 2) {\r\n  if(bytes === 0) return '0';\r\n\r\n  const k = 1000;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes = ['', 'K', 'M', 'B', 'T'];\r\n\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + sizes[i];\r\n}\r\n\r\nexport function clamp(v: number, min: number, max: number): number {\r\n  return v < min ? min : ((v > max) ? max : v);\r\n}\r\n\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function whichChild(elem: Node) {\r\n  if(!elem.parentNode) {\r\n    return -1;\r\n  }\r\n  \r\n  let i = 0;\r\n  // @ts-ignore\r\n  while((elem = elem.previousElementSibling) !== null) ++i;\r\n  return i;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Page from \"./page\";\r\nimport lottieLoader from \"../lib/lottieLoader\";\r\nimport { horizontalMenu } from \"../components/horizontalMenu\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport fastSmoothScroll from \"../helpers/fastSmoothScroll\";\r\nimport whichChild from \"../helpers/dom/whichChild\";\r\n\r\nclass PagesManager {\r\n  private pageId = -1;\r\n  private page: Page;\r\n\r\n  private selectTab: ReturnType<typeof horizontalMenu>;\r\n  public pagesDiv: HTMLDivElement;\r\n  public scrollableDiv: HTMLElement;\r\n\r\n  constructor() {\r\n    this.pagesDiv = document.getElementById('auth-pages') as HTMLDivElement;\r\n    this.scrollableDiv = this.pagesDiv.querySelector('.scrollable') as HTMLElement;\r\n    this.selectTab = horizontalMenu(null, this.scrollableDiv.querySelector('.tabs-container') as HTMLDivElement, null, () => {\r\n      if(this.page?.onShown) {\r\n        this.page.onShown();\r\n      }\r\n    });\r\n  }\r\n\r\n  public setPage(page: Page) {\r\n    if(page.isAuthPage) {\r\n      this.pagesDiv.style.display = '';\r\n\r\n      let id = whichChild(page.pageEl);\r\n      if(this.pageId === id) return;\r\n\r\n      this.selectTab(id);\r\n\r\n      if(this.pageId !== -1 && id > 1) {\r\n        lottieLoader.loadLottieWorkers();\r\n      }\r\n\r\n\r\n\r\n      this.pageId = id;\r\n\r\n      if(this.scrollableDiv) {\r\n        fastSmoothScroll(this.scrollableDiv, this.scrollableDiv.firstElementChild as HTMLElement, 'start');\r\n      }\r\n    } else {\r\n      this.pagesDiv.style.display = 'none';\r\n      page.pageEl.style.display = '';\r\n\r\n      this.pageId = -1;\r\n    }\r\n\r\n    this.page = page;\r\n  }\r\n}\r\n\r\nconst pagesManager = new PagesManager();\r\nMOUNT_CLASS_TO.pagesManager = pagesManager;\r\nexport default pagesManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport pagesManager from \"./pagesManager\";\r\n\r\nexport default class Page {\r\n  public pageEl: HTMLDivElement;\r\n  private installed = false;\r\n\r\n  constructor(className: string, public isAuthPage: boolean, private onFirstMount?: (...args: any[]) => Promise<any> | void, private onMount?: (...args: any[]) => void, public onShown?: () => void) {\r\n    this.pageEl = document.body.querySelector('.' + className) as HTMLDivElement;\r\n  }\r\n\r\n  public async mount(...args: any[]) {\r\n    //this.pageEl.style.display = '';\r\n\r\n    if(this.onMount) {\r\n      this.onMount(...args);\r\n    }\r\n\r\n    if(!this.installed) {\r\n      if(this.onFirstMount) {\r\n        try {\r\n          const res = this.onFirstMount(...args);\r\n          if(res instanceof Promise) {\r\n            await res;\r\n          }\r\n        } catch(err) {\r\n          console.error('PAGE MOUNT ERROR:', err);\r\n        }\r\n      }\r\n      \r\n      this.installed = true;\r\n    }\r\n\r\n    pagesManager.setPage(this);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n/* import { copy } from \"./object\";\r\n\r\nexport function listMergeSorted(list1: any[] = [], list2: any[] = []) {\r\n  const result = copy(list1);\r\n\r\n  const minId = list1.length ? list1[list1.length - 1] : 0xFFFFFFFF;\r\n  for(let i = 0; i < list2.length; i++) {\r\n    if(list2[i] < minId) {\r\n      result.push(list2[i]);\r\n    }\r\n  }\r\n\r\n  return result;\r\n} */\r\n\r\nexport const accumulate = (arr: number[], initialValue: number) => arr.reduce((acc, value) => acc + value, initialValue);\r\n\r\nexport function findAndSpliceAll<T>(array: Array<T>, verify: (value: T, index: number, arr: typeof array) => boolean) {\r\n  const out: typeof array = [];\r\n  let idx = -1;\r\n  while((idx = array.findIndex(verify)) !== -1) {\r\n    out.push(array.splice(idx, 1)[0]);\r\n  }\r\n\r\n  return out;\r\n}\r\n\r\nexport function forEachReverse<T>(array: Array<T>, callback: (value: T, index?: number, array?: Array<T>) => void) {\r\n  for(let length = array.length, i = length - 1; i >= 0; --i) {\r\n    callback(array[i], i, array);\r\n  }\r\n};\r\n\r\nexport function insertInDescendSortedArray<T extends {[smth in K]?: number}, K extends keyof T>(array: Array<T>, element: T, property: K, pos?: number) {\r\n  if(pos === undefined) {\r\n    pos = array.indexOf(element);\r\n    if(pos !== -1) {\r\n      array.splice(pos, 1);\r\n    }\r\n  }\r\n\r\n  const sortProperty: number = element[property];\r\n  const len = array.length;\r\n  if(!len || sortProperty <= array[len - 1][property]) {\r\n    return array.push(element) - 1;\r\n  } else if(sortProperty >= array[0][property]) {\r\n    array.unshift(element);\r\n    return 0;\r\n  } else {\r\n    for(let i = 0; i < len; i++) {\r\n      if(sortProperty > array[i][property]) {\r\n        array.splice(i, 0, element);\r\n        return i;\r\n      }\r\n    }\r\n  }\r\n\r\n  console.error('wtf', array, element);\r\n  return array.indexOf(element);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { FileURLType, getFileNameByLocation, getFileURL } from '../../helpers/fileName';\r\nimport { safeReplaceArrayInObject, defineNotNumerableProperties, isObject } from '../../helpers/object';\r\nimport { Document, InputFileLocation, PhotoSize } from '../../layer';\r\nimport referenceDatabase, { ReferenceContext } from '../mtproto/referenceDatabase';\r\nimport opusDecodeController from '../opusDecodeController';\r\nimport { RichTextProcessor } from '../richtextprocessor';\r\nimport webpWorkerController from '../webp/webpWorkerController';\r\nimport appDownloadManager, { DownloadBlob } from './appDownloadManager';\r\nimport appPhotosManager from './appPhotosManager';\r\nimport blur from '../../helpers/blur';\r\nimport apiManager from '../mtproto/mtprotoworker';\r\nimport { MOUNT_CLASS_TO } from '../../config/debug';\r\nimport { getFullDate } from '../../helpers/date';\r\n\r\nexport type MyDocument = Document.document;\r\n\r\n// TODO: если залить картинку файлом, а потом перезайти в диалог - превьюшка заново скачается\r\n\r\nexport class AppDocsManager {\r\n  private docs: {[docId: string]: MyDocument} = {};\r\n  private savingLottiePreview: {[docId: string]: true} = {};\r\n\r\n  constructor() {\r\n    apiManager.onServiceWorkerFail = this.onServiceWorkerFail;\r\n  }\r\n\r\n  public onServiceWorkerFail = () => {\r\n    for(const id in this.docs) {\r\n      const doc = this.docs[id];\r\n\r\n      if(doc.supportsStreaming) {\r\n        delete doc.supportsStreaming;\r\n        const cacheContext = appDownloadManager.getCacheContext(doc);\r\n        delete cacheContext.url;\r\n      }\r\n    }\r\n  };\r\n\r\n  public saveDoc(doc: Document, context?: ReferenceContext): MyDocument {\r\n    if(doc._ === 'documentEmpty') {\r\n      return undefined;\r\n    }\r\n\r\n    const oldDoc = this.docs[doc.id];\r\n\r\n    if(doc.file_reference) { // * because we can have a new object w/o the file_reference while sending\r\n      safeReplaceArrayInObject('file_reference', oldDoc, doc);\r\n      referenceDatabase.saveContext(doc.file_reference, context);\r\n    }\r\n    \r\n    //console.log('saveDoc', apiDoc, this.docs[apiDoc.id]);\r\n    if(oldDoc) {\r\n      //if(doc._ !== 'documentEmpty' && doc._ === d._) {\r\n        if(doc.thumbs) {\r\n          if(!oldDoc.thumbs) oldDoc.thumbs = doc.thumbs;\r\n          /* else if(apiDoc.thumbs[0].bytes && !d.thumbs[0].bytes) {\r\n            d.thumbs.unshift(apiDoc.thumbs[0]);\r\n          } else if(d.thumbs[0].url) { // fix for converted thumb in safari\r\n            apiDoc.thumbs[0] = d.thumbs[0];\r\n          } */\r\n        }\r\n\r\n      //}\r\n\r\n      return oldDoc;\r\n\r\n      //return Object.assign(d, apiDoc, context);\r\n      //return context ? Object.assign(d, context) : d;\r\n    }\r\n\r\n    this.docs[doc.id] = doc;\r\n\r\n    // * exclude from state\r\n    // defineNotNumerableProperties(doc, [/* 'thumbs',  */'type', 'h', 'w', 'file_name', \r\n    // 'file', 'duration', 'downloaded', 'url', 'audioTitle', \r\n    // 'audioPerformer', 'sticker', 'stickerEmoji', 'stickerEmojiRaw', \r\n    // 'stickerSetInput', 'stickerThumbConverted', 'animated', 'supportsStreaming']);\r\n\r\n    doc.attributes.forEach(attribute => {\r\n      switch(attribute._) {\r\n        case 'documentAttributeFilename':\r\n          doc.file_name = RichTextProcessor.wrapPlainText(attribute.file_name);\r\n          break;\r\n\r\n        case 'documentAttributeAudio':\r\n          doc.duration = attribute.duration;\r\n          doc.audioTitle = attribute.title;\r\n          doc.audioPerformer = attribute.performer;\r\n          doc.type = attribute.pFlags.voice && doc.mime_type === 'audio/ogg' ? 'voice' : 'audio';\r\n          /* if(apiDoc.type === 'audio') {\r\n            apiDoc.supportsStreaming = true;\r\n          } */\r\n          break;\r\n\r\n        case 'documentAttributeVideo':\r\n          doc.duration = attribute.duration;\r\n          doc.w = attribute.w;\r\n          doc.h = attribute.h;\r\n          //apiDoc.supportsStreaming = attribute.pFlags?.supports_streaming/*  && apiDoc.size > 524288 */;\r\n          if(/* apiDoc.thumbs &&  */attribute.pFlags.round_message) {\r\n            doc.type = 'round';\r\n          } else /* if(apiDoc.thumbs) */ {\r\n            doc.type = 'video';\r\n          }\r\n          break;\r\n\r\n        case 'documentAttributeSticker':\r\n          if(attribute.alt !== undefined) {\r\n            doc.stickerEmojiRaw = attribute.alt;\r\n            doc.stickerEmoji = RichTextProcessor.wrapRichText(doc.stickerEmojiRaw, {noLinks: true, noLinebreaks: true});\r\n          }\r\n\r\n          if(attribute.stickerset) {\r\n            if(attribute.stickerset._ === 'inputStickerSetEmpty') {\r\n              delete attribute.stickerset;\r\n            } else if(attribute.stickerset._ === 'inputStickerSetID') {\r\n              doc.stickerSetInput = attribute.stickerset;\r\n            }\r\n          }\r\n\r\n          // * there can be no thumbs, then it is a document\r\n          if(/* apiDoc.thumbs &&  */doc.mime_type === 'image/webp' && (doc.thumbs || webpWorkerController.isWebpSupported())) {\r\n            doc.type = 'sticker';\r\n            doc.sticker = 1;\r\n          }\r\n          break;\r\n\r\n        case 'documentAttributeImageSize':\r\n          doc.type = 'photo';\r\n          doc.w = attribute.w;\r\n          doc.h = attribute.h;\r\n          break;\r\n\r\n        case 'documentAttributeAnimated':\r\n          if((doc.mime_type === 'image/gif' || doc.mime_type === 'video/mp4')/*  && apiDoc.thumbs */) {\r\n            doc.type = 'gif';\r\n          }\r\n\r\n          doc.animated = true;\r\n          break;\r\n      }\r\n    });\r\n    \r\n    if(!doc.mime_type) {\r\n      switch(doc.type) {\r\n        case 'gif':\r\n        case 'video':\r\n        case 'round':\r\n          doc.mime_type = 'video/mp4';\r\n          break;\r\n        case 'sticker':\r\n          doc.mime_type = 'image/webp';\r\n          break;\r\n        case 'audio':\r\n          doc.mime_type = 'audio/mpeg';\r\n          break;\r\n        case 'voice':\r\n          doc.mime_type = 'audio/ogg';\r\n          break;\r\n        default:\r\n          doc.mime_type = 'application/octet-stream';\r\n          break;\r\n      }\r\n    }\r\n\r\n    if(doc.mime_type === 'application/pdf') {\r\n      doc.type = 'pdf';\r\n    }\r\n\r\n    if(doc.type === 'voice' || doc.type === 'round') {\r\n      // browser will identify extension\r\n      doc.file_name = doc.type + '_' + getFullDate(new Date(doc.date * 1000), {monthAsNumber: true, leadingZero: true}).replace(/[:\\.]/g, '-').replace(', ', '_');\r\n    }\r\n\r\n    if(apiManager.isServiceWorkerOnline()) {\r\n      if((doc.type === 'gif' && doc.size > 8e6) || doc.type === 'audio' || doc.type === 'video') {\r\n        doc.supportsStreaming = true;\r\n        \r\n        const cacheContext = appDownloadManager.getCacheContext(doc);\r\n        if(!cacheContext.url) {\r\n          cacheContext.url = this.getFileURL(doc);\r\n        }\r\n      }\r\n    }\r\n\r\n    // for testing purposes\r\n    // doc.supportsStreaming = false;\r\n    // doc.url = ''; // * this will break upload urls\r\n    \r\n    if(!doc.file_name) {\r\n      doc.file_name = '';\r\n    }\r\n\r\n    if(doc.mime_type === 'application/x-tgsticker' && doc.file_name === 'AnimatedSticker.tgs') {\r\n      doc.type = 'sticker';\r\n      doc.animated = true;\r\n      doc.sticker = 2;\r\n    }\r\n\r\n    /* if(!doc.url) {\r\n      doc.url = this.getFileURL(doc);\r\n    } */\r\n\r\n    return doc;\r\n  }\r\n  \r\n  public getDoc(docId: string | MyDocument): MyDocument {\r\n    return isObject(docId) && typeof(docId) !== 'string' ? docId as any : this.docs[docId as string] as any;\r\n  }\r\n\r\n  public getMediaInput(doc: MyDocument) {\r\n    return {\r\n      _: 'inputMediaDocument',\r\n      id: {\r\n        _: 'inputDocument',\r\n        id: doc.id,\r\n        access_hash: doc.access_hash,\r\n        file_reference: doc.file_reference\r\n      },\r\n      ttl_seconds: 0\r\n    };\r\n  }\r\n\r\n  public getInput(doc: MyDocument, thumbSize?: string): InputFileLocation.inputDocumentFileLocation {\r\n    return {\r\n      _: 'inputDocumentFileLocation',\r\n      id: doc.id,\r\n      access_hash: doc.access_hash,\r\n      file_reference: doc.file_reference,\r\n      thumb_size: thumbSize\r\n    };\r\n  }\r\n\r\n  public getFileDownloadOptions(doc: MyDocument, thumb?: PhotoSize.photoSize, queueId?: number, onlyCache?: boolean) {\r\n    const inputFileLocation = this.getInput(doc, thumb?.type);\r\n\r\n    let mimeType: string;\r\n    if(thumb) {\r\n      mimeType = doc.sticker ? 'image/webp' : 'image/jpeg'/* doc.mime_type */;\r\n    } else {\r\n      mimeType = doc.mime_type || 'application/octet-stream';\r\n    }\r\n\r\n    return {\r\n      dcId: doc.dc_id, \r\n      location: inputFileLocation, \r\n      size: thumb ? thumb.size : doc.size, \r\n      mimeType,\r\n      fileName: doc.file_name,\r\n      queueId,\r\n      onlyCache\r\n    };\r\n  }\r\n\r\n  public getFileURL(doc: MyDocument, download = false, thumb?: PhotoSize.photoSize) {\r\n    let type: FileURLType;\r\n    if(download) {\r\n      type = 'download';\r\n    } else if(thumb) {\r\n      type = 'thumb';\r\n    } else if(doc.supportsStreaming) {\r\n      type = 'stream';\r\n    } else {\r\n      type = 'document';\r\n    }\r\n\r\n    return getFileURL(type, this.getFileDownloadOptions(doc, thumb));\r\n  }\r\n\r\n  public getThumbURL(doc: MyDocument, thumb: PhotoSize.photoSize | PhotoSize.photoCachedSize | PhotoSize.photoStrippedSize) {\r\n    let promise: Promise<any> = Promise.resolve();\r\n\r\n    const cacheContext = appDownloadManager.getCacheContext(doc, thumb.type);\r\n    if(!cacheContext.url) {\r\n      if('bytes' in thumb) {\r\n        promise = blur(appPhotosManager.getPreviewURLFromBytes(thumb.bytes, !!doc.sticker)).then(url => {\r\n          cacheContext.url = url;\r\n        }) as any;\r\n      } else {\r\n        //return this.getFileURL(doc, false, thumb);\r\n        promise = appPhotosManager.preloadPhoto(doc, thumb) as any;\r\n      }\r\n    }\r\n\r\n    return {thumb, cacheContext, promise};\r\n  }\r\n\r\n  public getThumb(doc: MyDocument, tryNotToUseBytes = true) {\r\n    const thumb = appPhotosManager.choosePhotoSize(doc, 0, 0, !tryNotToUseBytes);\r\n    if(thumb._ === 'photoSizeEmpty') return null;\r\n    return this.getThumbURL(doc, thumb as any);\r\n  }\r\n\r\n  public getInputFileName(doc: MyDocument, thumbSize?: string) {\r\n    return getFileNameByLocation(this.getInput(doc, thumbSize), {fileName: doc.file_name});\r\n  }\r\n\r\n  public downloadDoc(doc: MyDocument, queueId?: number, onlyCache?: boolean): DownloadBlob {\r\n    const fileName = this.getInputFileName(doc);\r\n\r\n    let download: DownloadBlob = appDownloadManager.getDownload(fileName);\r\n    if(download) {\r\n      return download;\r\n    }\r\n\r\n    const downloadOptions = this.getFileDownloadOptions(doc, undefined, queueId, onlyCache);\r\n    download = appDownloadManager.download(downloadOptions);\r\n\r\n    const cacheContext = appDownloadManager.getCacheContext(doc);\r\n    const originalPromise = download;\r\n    originalPromise.then((blob) => {\r\n      cacheContext.url = URL.createObjectURL(blob);\r\n      cacheContext.downloaded = blob.size;\r\n    }, () => {});\r\n    \r\n    if(doc.type === 'voice' && !opusDecodeController.isPlaySupported()) {\r\n      download = originalPromise.then(async(blob) => {\r\n        const reader = new FileReader();\r\n  \r\n        await new Promise<void>((resolve, reject) => {\r\n          reader.onloadend = (e) => {\r\n            const uint8 = new Uint8Array(e.target.result as ArrayBuffer);\r\n            //console.log('sending uint8 to decoder:', uint8);\r\n            opusDecodeController.decode(uint8).then(result => {\r\n              cacheContext.url = result.url;\r\n              resolve();\r\n            }, (err) => {\r\n              delete cacheContext.downloaded;\r\n              reject(err);\r\n            });\r\n          };\r\n    \r\n          reader.readAsArrayBuffer(blob);\r\n        });\r\n  \r\n        return blob;\r\n      });\r\n    }\r\n\r\n    return download;\r\n  }\r\n\r\n  public saveLottiePreview(doc: MyDocument, canvas: HTMLCanvasElement, toneIndex: number) {\r\n    const key = doc.id + '-' + toneIndex;\r\n    if(this.savingLottiePreview[key]/*  || true */) return;\r\n\r\n    if(!doc.stickerCachedThumbs) {\r\n      defineNotNumerableProperties(doc, ['stickerCachedThumbs']);\r\n      doc.stickerCachedThumbs = {};\r\n    }\r\n\r\n    const thumb = doc.stickerCachedThumbs[toneIndex];\r\n    if(thumb && thumb.w >= canvas.width && thumb.h >= canvas.height) {\r\n      return;\r\n    }\r\n\r\n    /* if(doc.thumbs.find(t => t._ === 'photoStrippedSize') \r\n      || (doc.stickerCachedThumb || (doc.stickerSavedThumbWidth >= canvas.width && doc.stickerSavedThumbHeight >= canvas.height))) {\r\n      return;\r\n    } */\r\n\r\n    this.savingLottiePreview[key] = true;\r\n    canvas.toBlob((blob) => {\r\n      //console.log('got lottie preview', doc, blob, URL.createObjectURL(blob));\r\n\r\n      const thumb = {\r\n        url: URL.createObjectURL(blob),\r\n        w: canvas.width,\r\n        h: canvas.height\r\n      };\r\n\r\n      doc.stickerCachedThumbs[toneIndex] = thumb;\r\n\r\n      delete this.savingLottiePreview[key];\r\n      \r\n      /* const reader = new FileReader();\r\n      reader.onloadend = (e) => {\r\n        const uint8 = new Uint8Array(e.target.result as ArrayBuffer);\r\n        const thumb: PhotoSize.photoStrippedSize = {\r\n          _: 'photoStrippedSize',\r\n          bytes: uint8,\r\n          type: 'i'\r\n        };\r\n\r\n        doc.stickerSavedThumbWidth = canvas.width;\r\n        doc.stickerSavedThumbHeight = canvas.width;\r\n\r\n        defineNotNumerableProperties(thumb, ['url']);\r\n        thumb.url = URL.createObjectURL(blob);\r\n        doc.thumbs.findAndSplice(t => t._ === thumb._);\r\n        doc.thumbs.unshift(thumb);\r\n\r\n        if(!webpWorkerController.isWebpSupported()) {\r\n          doc.pFlags.stickerThumbConverted = true;\r\n        }\r\n\r\n        delete this.savingLottiePreview[doc.id];\r\n      };\r\n      reader.readAsArrayBuffer(blob); */\r\n    });\r\n  }\r\n\r\n  public saveDocFile(doc: MyDocument, queueId?: number) {\r\n    /* const options = this.getFileDownloadOptions(doc, undefined, queueId);\r\n    return appDownloadManager.downloadToDisc(options, doc.file_name); */\r\n    const promise = this.downloadDoc(doc, queueId);\r\n    promise.then(() => {\r\n      const cacheContext = appDownloadManager.getCacheContext(doc);\r\n      appDownloadManager.createDownloadAnchor(cacheContext.url, doc.file_name);\r\n    });\r\n    return promise;\r\n  }\r\n}\r\n\r\nconst appDocsManager = new AppDocsManager();\r\nMOUNT_CLASS_TO.appDocsManager = appDocsManager;\r\nexport default appDocsManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { fastRaf } from \"./schedulers\";\r\nimport { CancellablePromise, deferredPromise } from \"./cancellablePromise\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport isInDOM from \"./dom/isInDOM\";\r\n\r\nclass SequentialDom {\r\n  private promises: Partial<{\r\n    read: CancellablePromise<void>,\r\n    write: CancellablePromise<void>\r\n  }> = {};\r\n  private raf = fastRaf.bind(null);\r\n  private scheduled = false;\r\n\r\n  private do(kind: keyof SequentialDom['promises'], callback?: VoidFunction) {\r\n    let promise = this.promises[kind];\r\n    if(!promise) {\r\n      this.scheduleFlush();\r\n      promise = this.promises[kind] = deferredPromise<void>();\r\n    }\r\n\r\n    if(callback !== undefined) {\r\n      promise.then(() => callback());\r\n    }\r\n    \r\n    return promise;\r\n  }\r\n\r\n  public measure(callback?: VoidFunction) {\r\n    return this.do('read', callback);\r\n  }\r\n\r\n  public mutate(callback?: VoidFunction) {\r\n    return this.do('write', callback);\r\n  }\r\n\r\n  /**\r\n   * Will fire instantly if element is not connected\r\n   * @param element \r\n   * @param callback \r\n   */\r\n  public mutateElement(element: HTMLElement, callback?: VoidFunction) {\r\n    const promise = isInDOM(element) ? this.mutate() : Promise.resolve();\r\n\r\n    if(callback !== undefined) {\r\n      promise.then(() => callback());\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private scheduleFlush() {\r\n    if(!this.scheduled) {\r\n      this.scheduled = true;\r\n\r\n      this.raf(() => {\r\n        this.promises.read && this.promises.read.resolve();\r\n        this.promises.write && this.promises.write.resolve();\r\n\r\n        this.scheduled = false;\r\n        this.promises = {};\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nconst sequentialDom = new SequentialDom();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.sequentialDom = sequentialDom);\r\nexport default sequentialDom;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from '../../config/debug';\r\nimport { tsNow } from '../../helpers/date';\r\nimport sessionStorage from '../sessionStorage';\r\n\r\nexport class ServerTimeManager {\r\n  public timestampNow = tsNow(true);\r\n  public midnightNoOffset = this.timestampNow - (this.timestampNow % 86400);\r\n  public midnightOffseted = new Date();\r\n\r\n  public midnightOffset = this.midnightNoOffset - (Math.floor(+this.midnightOffseted / 1000));\r\n\r\n  public serverTimeOffset = 0; // in seconds\r\n  public timeParams = {\r\n    midnightOffset: this.midnightOffset,\r\n    serverTimeOffset: this.serverTimeOffset\r\n  };\r\n\r\n  constructor() {\r\n    this.midnightOffseted.setHours(0, 0, 0, 0);\r\n\r\n    sessionStorage.get('server_time_offset').then((to) => {\r\n      if(to) {\r\n        this.serverTimeOffset = to;\r\n        this.timeParams.serverTimeOffset = to;\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nconst serverTimeManager = new ServerTimeManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.serverTimeManager = serverTimeManager);\r\nexport default serverTimeManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { tsNow } from \"../../helpers/date\";\r\nimport { numberThousandSplitter } from \"../../helpers/number\";\r\nimport { ChannelParticipantsFilter, ChannelsChannelParticipants, Chat, ChatFull, ChatParticipants, ChatPhoto, ExportedChatInvite, InputChannel, InputFile, InputFileLocation, PhotoSize, SendMessageAction, Update, UserFull, UserProfilePhoto } from \"../../layer\";\r\nimport { LangPackKey, i18n } from \"../langPack\";\r\n//import apiManager from '../mtproto/apiManager';\r\nimport apiManager from '../mtproto/mtprotoworker';\r\nimport { RichTextProcessor } from \"../richtextprocessor\";\r\nimport rootScope from \"../rootScope\";\r\nimport SearchIndex from \"../searchIndex\";\r\nimport apiUpdatesManager from \"./apiUpdatesManager\";\r\nimport appChatsManager from \"./appChatsManager\";\r\nimport appNotificationsManager from \"./appNotificationsManager\";\r\nimport appPeersManager from \"./appPeersManager\";\r\nimport appPhotosManager from \"./appPhotosManager\";\r\nimport appUsersManager, { User } from \"./appUsersManager\";\r\n\r\nexport type UserTyping = Partial<{userId: number, action: SendMessageAction, timeout: number}>;\r\n\r\nexport class AppProfileManager {\r\n  //private botInfos: any = {};\r\n  private usersFull: {[id: string]: UserFull.userFull} = {};\r\n  public chatsFull: {[id: string]: ChatFull} = {};\r\n  private fullPromises: {[peerId: string]: Promise<ChatFull.chatFull | ChatFull.channelFull | UserFull>} = {};\r\n\r\n  private megagroupOnlines: {[id: number]: {timestamp: number, onlines: number}};\r\n\r\n  private typingsInPeer: {[peerId: number]: UserTyping[]};\r\n\r\n  constructor() {\r\n    rootScope.addMultipleEventsListeners({\r\n      updateChatParticipants: (update) => {\r\n        const participants = update.participants;\r\n        if(participants._ === 'chatParticipants') {\r\n          const chatId = participants.chat_id;\r\n          const chatFull = this.chatsFull[chatId] as ChatFull.chatFull;\r\n          if(chatFull !== undefined) {\r\n            chatFull.participants = participants;\r\n            rootScope.dispatchEvent('chat_full_update', chatId);\r\n          }\r\n        }\r\n      },\r\n\r\n      updateChatParticipantAdd: (update) => {\r\n        const chatFull = this.chatsFull[update.chat_id] as ChatFull.chatFull;\r\n        if(chatFull !== undefined) {\r\n          const _participants = chatFull.participants as ChatParticipants.chatParticipants;\r\n          const participants = _participants.participants || [];\r\n          for(let i = 0, length = participants.length; i < length; i++) {\r\n            if(participants[i].user_id === update.user_id) {\r\n              return;\r\n            }\r\n          }\r\n\r\n          participants.push({\r\n            _: 'chatParticipant',\r\n            user_id: update.user_id,\r\n            inviter_id: update.inviter_id,\r\n            date: tsNow(true)\r\n          });\r\n\r\n          _participants.version = update.version;\r\n          rootScope.dispatchEvent('chat_full_update', update.chat_id);\r\n        }\r\n      },\r\n\r\n      updateChatParticipantDelete: (update) => {\r\n        const chatFull = this.chatsFull[update.chat_id] as ChatFull.chatFull;\r\n        if(chatFull !== undefined) {\r\n          const _participants = chatFull.participants as ChatParticipants.chatParticipants;\r\n          const participants = _participants.participants || [];\r\n          for(let i = 0, length = participants.length; i < length; i++) {\r\n            if(participants[i].user_id === update.user_id) {\r\n              participants.splice(i, 1);\r\n              _participants.version = update.version;\r\n              rootScope.dispatchEvent('chat_full_update', update.chat_id);\r\n              return;\r\n            }\r\n          }\r\n        }\r\n      },\r\n\r\n      updateUserTyping: this.onUpdateUserTyping,\r\n      updateChatUserTyping: this.onUpdateUserTyping,\r\n      updateChannelUserTyping: this.onUpdateUserTyping\r\n    });\r\n\r\n    rootScope.addEventListener('chat_update', (chatId) => {\r\n      const fullChat = this.chatsFull[chatId];\r\n      const chat: Chat.chat = appChatsManager.getChat(chatId);\r\n      if(!chat.photo || !fullChat) {\r\n        return;\r\n      }\r\n\r\n      const emptyPhoto = chat.photo._ === 'chatPhotoEmpty';\r\n      //////console.log('chat_update:', fullChat);\r\n      if(fullChat.chat_photo && emptyPhoto !== (fullChat.chat_photo._ === 'photoEmpty')) {\r\n        delete this.chatsFull[chatId];\r\n        rootScope.dispatchEvent('chat_full_update', chatId);\r\n        return;\r\n      }\r\n      if(emptyPhoto) {\r\n        return;\r\n      }\r\n\r\n      const photoId = (chat.photo as ChatPhoto.chatPhoto).photo_id;\r\n      const chatFullPhotoId = fullChat.chat_photo?.id;\r\n      if(chatFullPhotoId !== photoId) {\r\n        delete this.chatsFull[chatId];\r\n        rootScope.dispatchEvent('chat_full_update', chatId);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('invalidate_participants', chatId => {\r\n      this.invalidateChannelParticipants(chatId);\r\n    });\r\n\r\n    this.megagroupOnlines = {};\r\n    this.typingsInPeer = {};\r\n  }\r\n\r\n  /* public saveBotInfo(botInfo: any) {\r\n    const botId = botInfo && botInfo.user_id;\r\n    if(!botId) {\r\n      return null;\r\n    }\r\n\r\n    const commands: any = {};\r\n    botInfo.commands.forEach((botCommand: any) => {\r\n      commands[botCommand.command] = botCommand.description;\r\n    });\r\n\r\n    return this.botInfos[botId] = {\r\n      id: botId,\r\n      version: botInfo.version,\r\n      shareText: botInfo.share_text,\r\n      description: botInfo.description,\r\n      commands: commands\r\n    };\r\n  } */\r\n\r\n  public getProfile(id: number, override?: true): Promise<UserFull> {\r\n    if(this.usersFull[id] && !override) {\r\n      return Promise.resolve(this.usersFull[id]);\r\n    }\r\n\r\n    if(this.fullPromises[id]) {\r\n      return this.fullPromises[id] as any;\r\n    }\r\n\r\n    return this.fullPromises[id] = apiManager.invokeApi('users.getFullUser', {\r\n      id: appUsersManager.getUserInput(id)\r\n    }).then((userFull) => {\r\n      const user = userFull.user as User;\r\n      appUsersManager.saveApiUser(user, true);\r\n\r\n      if(userFull.profile_photo) {\r\n        userFull.profile_photo = appPhotosManager.savePhoto(userFull.profile_photo, {type: 'profilePhoto', peerId: id});\r\n      }\r\n\r\n      if(userFull.about !== undefined) {\r\n        userFull.rAbout = RichTextProcessor.wrapRichText(userFull.about, {noLinebreaks: true});\r\n      }\r\n\r\n      appNotificationsManager.savePeerSettings(id, userFull.notify_settings);\r\n\r\n      /* if(userFull.bot_info) {\r\n        userFull.bot_info = this.saveBotInfo(userFull.bot_info) as any;\r\n      } */\r\n\r\n      //appMessagesManager.savePinnedMessage(id, userFull.pinned_msg_id);\r\n\r\n      delete this.fullPromises[id];\r\n\r\n      return this.usersFull[id] = userFull;\r\n    }) as any;\r\n  }\r\n\r\n  public getProfileByPeerId(peerId: number, override?: true): Promise<ChatFull.chatFull | ChatFull.channelFull | UserFull.userFull> {\r\n    if(peerId < 0) return this.getChatFull(-peerId, override);\r\n    else return this.getProfile(peerId, override);\r\n  }\r\n\r\n  public getFullPhoto(peerId: number) {\r\n    return this.getProfileByPeerId(peerId).then(profile => {\r\n      switch(profile._) {\r\n        case 'userFull':\r\n          return profile.profile_photo;\r\n        case 'channelFull':\r\n        case 'chatFull':\r\n          return profile.chat_photo;\r\n      }\r\n    });\r\n  }\r\n\r\n  /* public getPeerBots(peerId: number) {\r\n    var peerBots: any[] = [];\r\n    if(peerId >= 0 && !appUsersManager.isBot(peerId) ||\r\n      (appPeersManager.isChannel(peerId) && !appPeersManager.isMegagroup(peerId))) {\r\n      return Promise.resolve(peerBots);\r\n    }\r\n    if(peerId >= 0) {\r\n      return this.getProfile(peerId).then((userFull: any) => {\r\n        var botInfo = userFull.bot_info;\r\n        if(botInfo && botInfo._ !== 'botInfoEmpty') {\r\n          peerBots.push(botInfo);\r\n        }\r\n        return peerBots;\r\n      });\r\n    }\r\n\r\n    return this.getChatFull(-peerId).then((chatFull: any) => {\r\n      chatFull.bot_info.forEach((botInfo: any) => {\r\n        peerBots.push(this.saveBotInfo(botInfo))\r\n      });\r\n      return peerBots;\r\n    });\r\n  } */\r\n\r\n  public getChatFull(id: number, override?: true): Promise<ChatFull.chatFull | ChatFull.channelFull> {\r\n    if(appChatsManager.isChannel(id)) {\r\n      return this.getChannelFull(id, override);\r\n    }\r\n\r\n    const fullChat = this.chatsFull[id] as ChatFull.chatFull;\r\n    if(fullChat && !override) {\r\n      const chat = appChatsManager.getChat(id);\r\n      if(chat.version === (fullChat.participants as ChatParticipants.chatParticipants).version ||\r\n        chat.pFlags.left) {\r\n        return Promise.resolve(fullChat);\r\n      }\r\n    }\r\n\r\n    const peerId = -id;\r\n    if(this.fullPromises[peerId] !== undefined) {\r\n      return this.fullPromises[peerId] as any;\r\n    }\r\n\r\n    // console.trace(dT(), 'Get chat full', id, appChatsManager.getChat(id))\r\n    return this.fullPromises[peerId] = apiManager.invokeApi('messages.getFullChat', {\r\n      chat_id: id\r\n    }).then((result) => {\r\n      appChatsManager.saveApiChats(result.chats, true);\r\n      appUsersManager.saveApiUsers(result.users);\r\n      const fullChat = result.full_chat as ChatFull.chatFull;\r\n      if(fullChat && fullChat.chat_photo && fullChat.chat_photo.id) {\r\n        fullChat.chat_photo = appPhotosManager.savePhoto(fullChat.chat_photo, {type: 'profilePhoto', peerId: peerId});\r\n      }\r\n\r\n      //appMessagesManager.savePinnedMessage(peerId, fullChat.pinned_msg_id);\r\n      appNotificationsManager.savePeerSettings(peerId, fullChat.notify_settings);\r\n      delete this.fullPromises[peerId];\r\n      this.chatsFull[id] = fullChat;\r\n      rootScope.dispatchEvent('chat_full_update', id);\r\n\r\n      return fullChat;\r\n    }) as any;\r\n  }\r\n\r\n  public getChatInviteLink(id: number, force?: boolean) {\r\n    return this.getChatFull(id).then((chatFull) => {\r\n      if(!force &&\r\n        chatFull.exported_invite &&\r\n        chatFull.exported_invite._ == 'chatInviteExported') {\r\n        return chatFull.exported_invite.link;\r\n      }\r\n      \r\n      return apiManager.invokeApi('messages.exportChatInvite', {\r\n        peer: appPeersManager.getInputPeerById(-id)\r\n      }).then((exportedInvite) => {\r\n        if(this.chatsFull[id] !== undefined) {\r\n          this.chatsFull[id].exported_invite = exportedInvite;\r\n        }\r\n\r\n        return (exportedInvite as ExportedChatInvite.chatInviteExported).link;\r\n      });\r\n    });\r\n  }\r\n\r\n  public getChannelParticipants(id: number, filter: ChannelParticipantsFilter = {_: 'channelParticipantsRecent'}, limit = 200, offset = 0) {\r\n    if(filter._ === 'channelParticipantsRecent') {\r\n      const chat = appChatsManager.getChat(id);\r\n      if(chat &&\r\n          chat.pFlags && (\r\n            chat.pFlags.kicked ||\r\n            chat.pFlags.broadcast && !chat.pFlags.creator && !chat.admin_rights\r\n          )) {\r\n        return Promise.reject();\r\n      }\r\n    }\r\n\r\n    return apiManager.invokeApiCacheable('channels.getParticipants', {\r\n      channel: appChatsManager.getChannelInput(id),\r\n      filter,\r\n      offset,\r\n      limit,\r\n      hash: 0\r\n    }, {cacheSeconds: 60}).then(result => {\r\n      appUsersManager.saveApiUsers((result as ChannelsChannelParticipants.channelsChannelParticipants).users);\r\n      return result as ChannelsChannelParticipants.channelsChannelParticipants;\r\n    });\r\n    /* let maybeAddSelf = (participants: any[]) => {\r\n      let chat = appChatsManager.getChat(id);\r\n      let selfMustBeFirst = filter._ === 'channelParticipantsRecent' &&\r\n                            !offset &&\r\n                            !chat.pFlags.kicked &&\r\n                            !chat.pFlags.left;\r\n\r\n      if(selfMustBeFirst) {\r\n        participants = copy(participants);\r\n        let myID = appUsersManager.getSelf().id;\r\n        let myIndex = participants.findIndex(p => p.user_id === myID);\r\n        let myParticipant;\r\n\r\n        if(myIndex !== -1) {\r\n          myParticipant = participants[myIndex];\r\n          participants.splice(myIndex, 1);\r\n        } else {\r\n          myParticipant = {_: 'channelParticipantSelf', user_id: myID};\r\n        }\r\n\r\n        participants.unshift(myParticipant);\r\n      }\r\n\r\n      return participants;\r\n    } */\r\n  }\r\n\r\n  public getChannelParticipant(id: number, peerId: number) {\r\n    return apiManager.invokeApiSingle('channels.getParticipant', {\r\n      channel: appChatsManager.getChannelInput(id),\r\n      participant: appPeersManager.getInputPeerById(peerId),\r\n    }).then(channelParticipant => {\r\n      appUsersManager.saveApiUsers(channelParticipant.users);\r\n      return channelParticipant.participant;\r\n    });\r\n  }\r\n\r\n  public getChannelFull(id: number, override?: true): Promise<ChatFull.channelFull> {\r\n    if(this.chatsFull[id] !== undefined && !override) {\r\n      return Promise.resolve(this.chatsFull[id] as ChatFull.channelFull);\r\n    }\r\n\r\n    const peerId = -id;\r\n    if(this.fullPromises[peerId] !== undefined) {\r\n      return this.fullPromises[peerId] as any;\r\n    }\r\n\r\n    return this.fullPromises[peerId] = apiManager.invokeApi('channels.getFullChannel', {\r\n      channel: appChatsManager.getChannelInput(id)\r\n    }).then((result) => {\r\n      appChatsManager.saveApiChats(result.chats, true);\r\n      appUsersManager.saveApiUsers(result.users);\r\n      const fullChannel = result.full_chat as ChatFull.channelFull;\r\n      if(fullChannel && fullChannel.chat_photo.id) {\r\n        fullChannel.chat_photo = appPhotosManager.savePhoto(fullChannel.chat_photo, {type: 'profilePhoto', peerId});\r\n        //appPhotosManager.savePhoto(fullChannel.chat_photo);\r\n      }\r\n      appNotificationsManager.savePeerSettings(peerId, fullChannel.notify_settings);\r\n\r\n      delete this.fullPromises[peerId];\r\n      this.chatsFull[id] = fullChannel;\r\n      rootScope.dispatchEvent('chat_full_update', id);\r\n\r\n      return fullChannel;\r\n    }, (error) => {\r\n      switch (error.type) {\r\n        case 'CHANNEL_PRIVATE':\r\n          let channel = appChatsManager.getChat(id);\r\n          channel = {_: 'channelForbidden', access_hash: channel.access_hash, title: channel.title};\r\n          apiUpdatesManager.processUpdateMessage({\r\n            _: 'updates',\r\n            updates: [{\r\n              _: 'updateChannel',\r\n              channel_id: id\r\n            } as Update.updateChannel],\r\n            chats: [channel],\r\n            users: []\r\n          });\r\n          break;\r\n      }\r\n\r\n      return Promise.reject(error);\r\n    }) as any;\r\n  }\r\n\r\n  public getMentions(chatId: number, query: string, threadId?: number): Promise<number[]> {\r\n    const processUserIds = (userIds: number[]) => {\r\n      const index = new SearchIndex<number>(true, true);\r\n      userIds.forEach(userId => {\r\n        index.indexObject(userId, appUsersManager.getUserSearchText(userId));\r\n      });\r\n\r\n      return Array.from(index.search(query));\r\n    };\r\n\r\n    if(appChatsManager.isChannel(chatId)) {\r\n      return this.getChannelParticipants(chatId, {\r\n        _: 'channelParticipantsMentions',\r\n        q: query,\r\n        top_msg_id: threadId\r\n      }, 50, 0).then(cP => {\r\n        return processUserIds(cP.participants.map(p => appChatsManager.getParticipantPeerId(p)));\r\n      });\r\n    } else {\r\n      return (this.getChatFull(chatId) as Promise<ChatFull.chatFull>).then(chatFull => {\r\n        return processUserIds((chatFull.participants as ChatParticipants.chatParticipants).participants.map(p => p.user_id));\r\n      });\r\n    }\r\n  }\r\n\r\n  public invalidateChannelParticipants(id: number) {\r\n    delete this.chatsFull[id];\r\n    delete this.fullPromises[-id];\r\n    apiManager.clearCache('channels.getParticipants', (params) => (params.channel as InputChannel.inputChannel).channel_id === id);\r\n    rootScope.dispatchEvent('chat_full_update', id);\r\n  }\r\n\r\n  public updateProfile(first_name: string, last_name: string, about: string) {\r\n    return apiManager.invokeApi('account.updateProfile', {\r\n      first_name,\r\n      last_name,\r\n      about\r\n    }).then(user => {\r\n      appUsersManager.saveApiUser(user);\r\n      \r\n      return this.getProfile(rootScope.myId, true);\r\n    });\r\n  }\r\n\r\n  public uploadProfilePhoto(inputFile: InputFile) {\r\n    return apiManager.invokeApi('photos.uploadProfilePhoto', {\r\n      file: inputFile\r\n    }).then((updateResult) => {\r\n      appUsersManager.saveApiUsers(updateResult.users);\r\n\r\n      const myId = rootScope.myId;\r\n      appPhotosManager.savePhoto(updateResult.photo, {\r\n        type: 'profilePhoto',\r\n        peerId: myId\r\n      });\r\n\r\n      apiUpdatesManager.processUpdateMessage({\r\n        _: 'updateShort',\r\n        update: {\r\n          _: 'updateUserPhoto',\r\n          user_id: myId,\r\n          date: tsNow(true),\r\n          photo: appUsersManager.getUser(myId).photo,\r\n          previous: true\r\n        } as Update.updateUserPhoto\r\n      });\r\n    });\r\n  }\r\n\r\n  public getChatMembersString(id: number) {\r\n    const chat = appChatsManager.getChat(id);\r\n    const chatFull = this.chatsFull[id];\r\n    let count: number;\r\n    if(chatFull) {\r\n      if(chatFull._ === 'channelFull') {\r\n        count = chatFull.participants_count;\r\n      } else {\r\n        count = (chatFull.participants as ChatParticipants.chatParticipants).participants?.length;\r\n      }\r\n    } else {\r\n      count = chat.participants_count || chat.participants?.participants.length;\r\n    }\r\n\r\n    const isChannel = appChatsManager.isBroadcast(id);\r\n    count = count || 1;\r\n\r\n    let key: LangPackKey = isChannel ? 'Peer.Status.Subscribers' : 'Peer.Status.Member';\r\n    return i18n(key, [numberThousandSplitter(count)]);\r\n  }\r\n\r\n  public async getOnlines(id: number): Promise<number> {\r\n    if(appChatsManager.isMegagroup(id)) {\r\n      const timestamp = Date.now() / 1000 | 0;\r\n      const cached = this.megagroupOnlines[id] ?? (this.megagroupOnlines[id] = {timestamp: 0, onlines: 1});\r\n      if((timestamp - cached.timestamp) < 60) {\r\n        return cached.onlines;\r\n      }\r\n\r\n      const res = await apiManager.invokeApi('messages.getOnlines', {\r\n        peer: appChatsManager.getChannelInputPeer(id)\r\n      });\r\n\r\n      const onlines = res.onlines ?? 1;\r\n      cached.timestamp = timestamp;\r\n      cached.onlines = onlines;\r\n\r\n      return onlines;\r\n    } else if(appChatsManager.isBroadcast(id)) {\r\n      return 1;\r\n    }\r\n\r\n    const chatInfo = await this.getChatFull(id);\r\n    const _participants = (chatInfo as ChatFull.chatFull).participants as ChatParticipants.chatParticipants;\r\n    if(_participants && _participants.participants) {\r\n      const participants = _participants.participants;\r\n\r\n      return participants.reduce((acc: number, participant) => {\r\n        const user = appUsersManager.getUser(participant.user_id);\r\n        if(user && user.status && user.status._ === 'userStatusOnline') {\r\n          return acc + 1;\r\n        }\r\n\r\n        return acc;\r\n      }, 0);\r\n    } else {\r\n      return 1;\r\n    }\r\n  }\r\n\r\n  private onUpdateUserTyping = (update: Update.updateUserTyping | Update.updateChatUserTyping | Update.updateChannelUserTyping) => {\r\n    const fromId = (update as Update.updateUserTyping).user_id || appPeersManager.getPeerId((update as Update.updateChatUserTyping).from_id);\r\n    if(rootScope.myId === fromId || update.action._ === 'speakingInGroupCallAction') {\r\n      return;\r\n    }\r\n    \r\n    const peerId = update._ === 'updateUserTyping' ? \r\n      fromId : \r\n      -((update as Update.updateChatUserTyping).chat_id || (update as Update.updateChannelUserTyping).channel_id);\r\n    const typings = this.typingsInPeer[peerId] ?? (this.typingsInPeer[peerId] = []);\r\n    let typing = typings.find(t => t.userId === fromId);\r\n\r\n    const cancelAction = () => {\r\n      delete typing.timeout;\r\n      //typings.findAndSplice(t => t === typing);\r\n      const idx = typings.indexOf(typing);\r\n      if(idx !== -1) {\r\n        typings.splice(idx, 1);\r\n      }\r\n\r\n      rootScope.dispatchEvent('peer_typings', {peerId, typings});\r\n\r\n      if(!typings.length) {\r\n        delete this.typingsInPeer[peerId];\r\n      }\r\n    };\r\n\r\n    if(typing && typing.timeout !== undefined) {\r\n      clearTimeout(typing.timeout);\r\n    }\r\n\r\n    if(update.action._ === 'sendMessageCancelAction') {\r\n      if(!typing) {\r\n        return;\r\n      }\r\n\r\n      cancelAction();\r\n      return;\r\n    }\r\n\r\n    if(!typing) {\r\n      typing = {\r\n        userId: fromId\r\n      };\r\n\r\n      typings.push(typing);\r\n    }\r\n\r\n    //console.log('updateChatUserTyping', update, typings);\r\n    \r\n    typing.action = update.action;\r\n    \r\n    const hasUser = appUsersManager.hasUser(fromId);\r\n    if(!hasUser) {\r\n      // let's load user here\r\n      if(update._ === 'updateChatUserTyping') {\r\n        if(update.chat_id && appChatsManager.hasChat(update.chat_id) && !appChatsManager.isChannel(update.chat_id)) {\r\n          appProfileManager.getChatFull(update.chat_id).then(() => {\r\n            if(typing.timeout !== undefined && appUsersManager.hasUser(fromId)) {\r\n              rootScope.dispatchEvent('peer_typings', {peerId, typings});\r\n            }\r\n          });\r\n        }\r\n      }\r\n      \r\n      //return;\r\n    } else {\r\n      appUsersManager.forceUserOnline(fromId);\r\n    }\r\n\r\n    typing.timeout = window.setTimeout(cancelAction, 6000);\r\n    if(hasUser) {\r\n      rootScope.dispatchEvent('peer_typings', {peerId, typings});\r\n    }\r\n  };\r\n\r\n  public getPeerTypings(peerId: number) {\r\n    return this.typingsInPeer[peerId];\r\n  }\r\n}\r\n\r\nconst appProfileManager = new AppProfileManager();\r\nMOUNT_CLASS_TO.appProfileManager = appProfileManager;\r\nexport default appProfileManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { ripple } from \"../ripple\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport blurActiveElement from \"../../helpers/dom/blurActiveElement\";\r\n\r\nexport type PopupButton = {\r\n  text?: string,\r\n  callback?: () => void,\r\n  langKey?: LangPackKey,\r\n  langArgs?: any[],\r\n  isDanger?: true,\r\n  isCancel?: true\r\n};\r\n\r\nexport type PopupOptions = Partial<{\r\n  closable: true, \r\n  overlayClosable: true, \r\n  withConfirm: LangPackKey | true, \r\n  body: true\r\n}>;\r\n\r\nexport default class PopupElement {\r\n  protected element = document.createElement('div');\r\n  protected container = document.createElement('div');\r\n  protected header = document.createElement('div');\r\n  protected title = document.createElement('div');\r\n  protected btnClose: HTMLElement;\r\n  protected btnConfirm: HTMLElement;\r\n  protected body: HTMLElement;\r\n\r\n  protected onClose: () => void;\r\n  protected onCloseAfterTimeout: () => void;\r\n  protected onEscape: () => boolean = () => true;\r\n\r\n  protected navigationItem: NavigationItem;\r\n\r\n  constructor(className: string, buttons?: Array<PopupButton>, options: PopupOptions = {}) {\r\n    this.element.classList.add('popup');\r\n    this.element.className = 'popup' + (className ? ' ' + className : '');\r\n    this.container.classList.add('popup-container', 'z-depth-1');\r\n\r\n    this.header.classList.add('popup-header');\r\n    this.title.classList.add('popup-title');\r\n\r\n    this.header.append(this.title);\r\n\r\n    if(options.closable) {\r\n      this.btnClose = document.createElement('span');\r\n      this.btnClose.classList.add('btn-icon', 'popup-close', 'tgico-close');\r\n      //ripple(this.closeBtn);\r\n      this.header.prepend(this.btnClose);\r\n\r\n      this.btnClose.addEventListener('click', this.hide, {once: true});\r\n    }\r\n\r\n    if(options.overlayClosable) {\r\n      const onOverlayClick = (e: MouseEvent) => {\r\n        if(!findUpClassName(e.target, 'popup-container')) {\r\n          this.hide();\r\n          this.element.removeEventListener('click', onOverlayClick);\r\n        }\r\n      };\r\n  \r\n      this.element.addEventListener('click', onOverlayClick);\r\n    }\r\n\r\n    if(options.withConfirm) {\r\n      this.btnConfirm = document.createElement('button');\r\n      this.btnConfirm.classList.add('btn-primary', 'btn-color-primary');\r\n      if(options.withConfirm !== true) {\r\n        this.btnConfirm.append(i18n(options.withConfirm));\r\n      }\r\n      this.header.append(this.btnConfirm);\r\n      ripple(this.btnConfirm);\r\n    }\r\n\r\n    this.container.append(this.header);\r\n    if(options.body) {\r\n      this.body = document.createElement('div');\r\n      this.body.classList.add('popup-body');\r\n      this.container.append(this.body);\r\n    }\r\n\r\n    if(buttons && buttons.length) {\r\n      const buttonsDiv = document.createElement('div');\r\n      buttonsDiv.classList.add('popup-buttons');\r\n\r\n      if(buttons.length === 2) {\r\n        buttonsDiv.classList.add('popup-buttons-row');\r\n      }\r\n  \r\n      const buttonsElements = buttons.map(b => {\r\n        const button = document.createElement('button');\r\n        button.className = 'btn' + (b.isDanger ? ' danger' : ' primary');\r\n\r\n        ripple(button);\r\n        \r\n        if(b.text) {\r\n          button.innerHTML =  b.text;\r\n        } else {\r\n          button.append(i18n(b.langKey, b.langArgs));\r\n        }\r\n  \r\n        if(b.callback) {\r\n          button.addEventListener('click', () => {\r\n            b.callback();\r\n            this.destroy();\r\n          }, {once: true});\r\n        } else if(b.isCancel) {\r\n          button.addEventListener('click', () => {\r\n            this.destroy();\r\n          }, {once: true});\r\n        }\r\n  \r\n        return button;\r\n      });\r\n  \r\n      buttonsDiv.append(...buttonsElements);\r\n      this.container.append(buttonsDiv);\r\n    }\r\n\r\n    this.element.append(this.container);\r\n  }\r\n\r\n  public show() {\r\n    this.navigationItem = {\r\n      type: 'popup',\r\n      onPop: this.destroy,\r\n      onEscape: this.onEscape\r\n    };\r\n\r\n    appNavigationController.pushItem(this.navigationItem);\r\n\r\n    blurActiveElement(); // * hide mobile keyboard\r\n    document.body.append(this.element);\r\n    void this.element.offsetWidth; // reflow\r\n    this.element.classList.add('active');\r\n    rootScope.overlayIsActive = true;\r\n    animationIntersector.checkAnimations(true);\r\n  }\r\n\r\n  public hide = () => {\r\n    appNavigationController.back('popup');\r\n  };\r\n\r\n  private destroy = () => {\r\n    this.onClose && this.onClose();\r\n    this.element.classList.add('hiding');\r\n    this.element.classList.remove('active');\r\n\r\n    if(this.btnClose) this.btnClose.removeEventListener('click', this.hide);\r\n    rootScope.overlayIsActive = false;\r\n\r\n    appNavigationController.removeItem(this.navigationItem);\r\n    this.navigationItem = undefined;\r\n\r\n    setTimeout(() => {\r\n      this.element.remove();\r\n      this.onCloseAfterTimeout && this.onCloseAfterTimeout();\r\n      animationIntersector.checkAnimations(false);\r\n    }, 150);\r\n  };\r\n}\r\n\r\nexport const addCancelButton = (buttons: PopupButton[]) => {\r\n  const button = buttons.find(b => b.isCancel);\r\n  if(!button) {\r\n    buttons.push({\r\n      langKey: 'Cancel',\r\n      isCancel: true\r\n    });\r\n  }\r\n\r\n  return buttons;\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport const loadedURLs: {[url: string]: boolean} = {};\r\nconst set = (elem: HTMLElement | HTMLImageElement | SVGImageElement | HTMLVideoElement, url: string) => {\r\n  if(elem instanceof HTMLImageElement || elem instanceof HTMLVideoElement) elem.src = url;\r\n  else if(elem instanceof SVGImageElement) elem.setAttributeNS(null, 'href', url);\r\n  else elem.style.backgroundImage = 'url(' + url + ')';\r\n};\r\n\r\n// проблема функции в том, что она не подходит для ссылок, пригодна только для blob'ов, потому что обычным ссылкам нужен 'load' каждый раз.\r\nexport default async function renderImageFromUrl(elem: HTMLElement | HTMLImageElement | SVGImageElement | HTMLVideoElement, url: string, callback?: (err?: Event) => void, useCache = true) {\r\n  if(!url) {\r\n    console.error('renderImageFromUrl: no url?', elem, url);\r\n    callback && callback();\r\n    return;\r\n  }\r\n\r\n  if(((loadedURLs[url]/*  && false */) && useCache) || elem instanceof HTMLVideoElement) {\r\n    if(elem) {\r\n      set(elem, url);\r\n    }\r\n    \r\n    callback && callback();\r\n  } else {\r\n    const isImage = elem instanceof HTMLImageElement;\r\n    const loader = isImage ? elem as HTMLImageElement : new Image();\r\n    //const loader = new Image();\r\n    loader.src = url;\r\n    //let perf = performance.now();\r\n    loader.addEventListener('load', () => {\r\n      if(!isImage && elem) {\r\n        set(elem, url);\r\n      }\r\n\r\n      loadedURLs[url] = true;\r\n      //console.log('onload:', url, performance.now() - perf);\r\n      if(callback) {\r\n        // TODO: переделать прогрузки аватаров до начала анимации, иначе с этим ожиданием они неприятно появляются\r\n        /* getHeavyAnimationPromise().then(() => {\r\n          callback();\r\n        }); */\r\n        callback();\r\n      }\r\n\r\n      //callback && callback();\r\n    });\r\n\r\n    if(callback) {\r\n      loader.addEventListener('error', callback);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"./config/debug\";\r\n\r\nexport type Country = {\r\n  phoneCode: string,\r\n  code: string,\r\n  name: string,\r\n  pattern: string,\r\n  emoji: string\r\n};\r\n\r\nconst Countries: Country[] = [{\"phoneCode\":\"7 840\",\"code\":\"AB\",\"name\":\"Abkhazia\",\"pattern\":\"\",\"emoji\":\"\"},{\"phoneCode\":\"93\",\"code\":\"AF\",\"name\":\"Afghanistan\",\"pattern\":\"93 XXX XXX XXX\",\"emoji\":\"🇦🇫\"},{\"phoneCode\":\"358 18\",\"code\":\"AX\",\"name\":\"Aland Islands\",\"pattern\":\"\",\"emoji\":\"🇦🇽\"},{\"phoneCode\":\"355\",\"code\":\"AL\",\"name\":\"Albania\",\"pattern\":\"355 XX XXX XXXX\",\"emoji\":\"🇦🇱\"},{\"phoneCode\":\"213\",\"code\":\"DZ\",\"name\":\"Algeria\",\"pattern\":\"213 XXX XX XX XX\",\"emoji\":\"🇩🇿\"},{\"phoneCode\":\"1 684\",\"code\":\"AS\",\"name\":\"American Samoa\",\"pattern\":\"1684 XXX XXXX\",\"emoji\":\"🇦🇸\"},{\"phoneCode\":\"376\",\"code\":\"AD\",\"name\":\"Andorra\",\"pattern\":\"376 XX XX XX\",\"emoji\":\"🇦🇩\"},{\"phoneCode\":\"244\",\"code\":\"AO\",\"name\":\"Angola\",\"pattern\":\"244 XXX XXX XXX\",\"emoji\":\"🇦🇴\"},{\"phoneCode\":\"1 264\",\"code\":\"AI\",\"name\":\"Anguilla\",\"pattern\":\"1264 XXX XXXX\",\"emoji\":\"🇦🇮\"},{\"phoneCode\":\"1 268\",\"code\":\"AG\",\"name\":\"Antigua & Barbuda\",\"pattern\":\"1268 XXX XXXX\",\"emoji\":\"🇦🇬\"},{\"phoneCode\":\"54\",\"code\":\"AR\",\"name\":\"Argentina\",\"pattern\":\"\",\"emoji\":\"🇦🇷\"},{\"phoneCode\":\"374\",\"code\":\"AM\",\"name\":\"Armenia\",\"pattern\":\"374 XX XXX XXX\",\"emoji\":\"🇦🇲\"},{\"phoneCode\":\"297\",\"code\":\"AW\",\"name\":\"Aruba\",\"pattern\":\"297 XXX XXXX\",\"emoji\":\"🇦🇼\"},{\"phoneCode\":\"247\",\"code\":\"SH\",\"name\":\"Ascension\",\"pattern\":\"290 XX XXX\",\"emoji\":\"🇸🇭\"},{\"phoneCode\":\"61\",\"code\":\"AU\",\"name\":\"Australia\",\"pattern\":\"61 XXX XXX XXX\",\"emoji\":\"🇦🇺\"},{\"phoneCode\":\"672\",\"code\":\"AU\",\"name\":\"Australian External Territories\",\"pattern\":\"61 XXX XXX XXX\",\"emoji\":\"🇦🇺\"},{\"phoneCode\":\"43\",\"code\":\"AT\",\"name\":\"Austria\",\"pattern\":\"\",\"emoji\":\"🇦🇹\"},{\"phoneCode\":\"994\",\"code\":\"AZ\",\"name\":\"Azerbaijan\",\"pattern\":\"994 XX XXX XX XX\",\"emoji\":\"🇦🇿\"},{\"phoneCode\":\"1 242\",\"code\":\"BS\",\"name\":\"Bahamas\",\"pattern\":\"1242 XXX XXXX\",\"emoji\":\"🇧🇸\"},{\"phoneCode\":\"973\",\"code\":\"BH\",\"name\":\"Bahrain\",\"pattern\":\"973 XXXX XXXX\",\"emoji\":\"🇧🇭\"},{\"phoneCode\":\"880\",\"code\":\"BD\",\"name\":\"Bangladesh\",\"pattern\":\"\",\"emoji\":\"🇧🇩\"},{\"phoneCode\":\"1 246\",\"code\":\"BB\",\"name\":\"Barbados\",\"pattern\":\"1246 XXX XXXX\",\"emoji\":\"🇧🇧\"},{\"phoneCode\":\"1 268\",\"code\":\"AG\",\"name\":\"Barbuda\",\"pattern\":\"1268 XXX XXXX\",\"emoji\":\"🇦🇬\"},{\"phoneCode\":\"375\",\"code\":\"BY\",\"name\":\"Belarus\",\"pattern\":\"375 XX XXX XXXX\",\"emoji\":\"🇧🇾\"},{\"phoneCode\":\"32\",\"code\":\"BE\",\"name\":\"Belgium\",\"pattern\":\"32 XXX XX XX XX\",\"emoji\":\"🇧🇪\"},{\"phoneCode\":\"501\",\"code\":\"BZ\",\"name\":\"Belize\",\"pattern\":\"\",\"emoji\":\"🇧🇿\"},{\"phoneCode\":\"229\",\"code\":\"BJ\",\"name\":\"Benin\",\"pattern\":\"229 XX XXX XXX\",\"emoji\":\"🇧🇯\"},{\"phoneCode\":\"1 441\",\"code\":\"BM\",\"name\":\"Bermuda\",\"pattern\":\"1441 XXX XXXX\",\"emoji\":\"🇧🇲\"},{\"phoneCode\":\"975\",\"code\":\"BT\",\"name\":\"Bhutan\",\"pattern\":\"\",\"emoji\":\"🇧🇹\"},{\"phoneCode\":\"591\",\"code\":\"BO\",\"name\":\"Bolivia\",\"pattern\":\"591 X XXX XXXX\",\"emoji\":\"🇧🇴\"},{\"phoneCode\":\"599 7\",\"code\":\"BQ\",\"name\":\"Caribbean Netherlands\",\"pattern\":\"\",\"emoji\":\"🇧🇶\"},{\"phoneCode\":\"387\",\"code\":\"BA\",\"name\":\"Bosnia & Herzegovina\",\"pattern\":\"\",\"emoji\":\"🇧🇦\"},{\"phoneCode\":\"267\",\"code\":\"BW\",\"name\":\"Botswana\",\"pattern\":\"267 XX XXX XXX\",\"emoji\":\"🇧🇼\"},{\"phoneCode\":\"55\",\"code\":\"BR\",\"name\":\"Brazil\",\"pattern\":\"55 XX XXXXX XXXX\",\"emoji\":\"🇧🇷\"},{\"phoneCode\":\"246\",\"code\":\"IO\",\"name\":\"British Indian Ocean Territory\",\"pattern\":\"246 XXX XXXX\",\"emoji\":\"🇮🇴\"},{\"phoneCode\":\"1 284\",\"code\":\"VG\",\"name\":\"British Virgin Islands\",\"pattern\":\"1284 XXX XXXX\",\"emoji\":\"🇻🇬\"},{\"phoneCode\":\"673\",\"code\":\"BN\",\"name\":\"Brunei\",\"pattern\":\"673 XXX XXXX\",\"emoji\":\"🇧🇳\"},{\"phoneCode\":\"359\",\"code\":\"BG\",\"name\":\"Bulgaria\",\"pattern\":\"\",\"emoji\":\"🇧🇬\"},{\"phoneCode\":\"226\",\"code\":\"BF\",\"name\":\"Burkina Faso\",\"pattern\":\"226 XX XX XX XX\",\"emoji\":\"🇧🇫\"},{\"phoneCode\":\"95\",\"code\":\"MM\",\"name\":\"Myanmar (Burma)\",\"pattern\":\"\",\"emoji\":\"🇲🇲\"},{\"phoneCode\":\"257\",\"code\":\"BI\",\"name\":\"Burundi\",\"pattern\":\"257 XX XX XXXX\",\"emoji\":\"🇧🇮\"},{\"phoneCode\":\"855\",\"code\":\"KH\",\"name\":\"Cambodia\",\"pattern\":\"\",\"emoji\":\"🇰🇭\"},{\"phoneCode\":\"237\",\"code\":\"CM\",\"name\":\"Cameroon\",\"pattern\":\"237 XXXX XXXX\",\"emoji\":\"🇨🇲\"},{\"phoneCode\":\"1\",\"code\":\"CA\",\"name\":\"Canada\",\"pattern\":\"1 XXX XXX XXXX\",\"emoji\":\"🇨🇦\"},{\"phoneCode\":\"238\",\"code\":\"CV\",\"name\":\"Cape Verde\",\"pattern\":\"238 XXX XXXX\",\"emoji\":\"🇨🇻\"},{\"phoneCode\":\"1 345\",\"code\":\"KY\",\"name\":\"Cayman Islands\",\"pattern\":\"1345 XXX XXXX\",\"emoji\":\"🇰🇾\"},{\"phoneCode\":\"236\",\"code\":\"CF\",\"name\":\"Central African Republic\",\"pattern\":\"236 XX XX XX XX\",\"emoji\":\"🇨🇫\"},{\"phoneCode\":\"235\",\"code\":\"TD\",\"name\":\"Chad\",\"pattern\":\"235 XX XX XX XX\",\"emoji\":\"🇹🇩\"},{\"phoneCode\":\"56\",\"code\":\"CL\",\"name\":\"Chile\",\"pattern\":\"56 X XXXX XXXX\",\"emoji\":\"🇨🇱\"},{\"phoneCode\":\"86\",\"code\":\"CN\",\"name\":\"China\",\"pattern\":\"86 XXX XXXX XXXX\",\"emoji\":\"🇨🇳\"},{\"phoneCode\":\"61\",\"code\":\"CX\",\"name\":\"Christmas Island\",\"pattern\":\"\",\"emoji\":\"🇨🇽\"},{\"phoneCode\":\"61\",\"code\":\"CC\",\"name\":\"Cocos (Keeling) Islands\",\"pattern\":\"\",\"emoji\":\"🇨🇨\"},{\"phoneCode\":\"57\",\"code\":\"CO\",\"name\":\"Colombia\",\"pattern\":\"57 XXX XXX XXXX\",\"emoji\":\"🇨🇴\"},{\"phoneCode\":\"269\",\"code\":\"KM\",\"name\":\"Comoros\",\"pattern\":\"269 XXX XXXX\",\"emoji\":\"🇰🇲\"},{\"phoneCode\":\"242\",\"code\":\"CG\",\"name\":\"Congo - Brazzaville\",\"pattern\":\"242 XX XXX XXXX\",\"emoji\":\"🇨🇬\"},{\"phoneCode\":\"243\",\"code\":\"CD\",\"name\":\"Congo - Kinshasa\",\"pattern\":\"243 XX XXX XXXX\",\"emoji\":\"🇨🇩\"},{\"phoneCode\":\"682\",\"code\":\"CK\",\"name\":\"Cook Islands\",\"pattern\":\"\",\"emoji\":\"🇨🇰\"},{\"phoneCode\":\"506\",\"code\":\"CR\",\"name\":\"Costa Rica\",\"pattern\":\"\",\"emoji\":\"🇨🇷\"},{\"phoneCode\":\"225\",\"code\":\"CI\",\"name\":\"Cote d’Ivoire\",\"pattern\":\"225 XX XXX XXX\",\"emoji\":\"🇨🇮\"},{\"phoneCode\":\"385\",\"code\":\"HR\",\"name\":\"Croatia\",\"pattern\":\"\",\"emoji\":\"🇭🇷\"},{\"phoneCode\":\"53\",\"code\":\"CU\",\"name\":\"Cuba\",\"pattern\":\"53 XXXX XXXX\",\"emoji\":\"🇨🇺\"},{\"phoneCode\":\"599 9\",\"code\":\"CW\",\"name\":\"Curacao\",\"pattern\":\"\",\"emoji\":\"🇨🇼\"},{\"phoneCode\":\"357\",\"code\":\"CY\",\"name\":\"Cyprus\",\"pattern\":\"357 XXXX XXXX\",\"emoji\":\"🇨🇾\"},{\"phoneCode\":\"420\",\"code\":\"CZ\",\"name\":\"Czech Republic\",\"pattern\":\"\",\"emoji\":\"🇨🇿\"},{\"phoneCode\":\"45\",\"code\":\"DK\",\"name\":\"Denmark\",\"pattern\":\"45 XXXX XXXX\",\"emoji\":\"🇩🇰\"},{\"phoneCode\":\"246\",\"code\":\"DG\",\"name\":\"Diego Garcia\",\"pattern\":\"\",\"emoji\":\"🇩🇬\"},{\"phoneCode\":\"253\",\"code\":\"DJ\",\"name\":\"Djibouti\",\"pattern\":\"253 XX XX XX XX\",\"emoji\":\"🇩🇯\"},{\"phoneCode\":\"1 767\",\"code\":\"DM\",\"name\":\"Dominica\",\"pattern\":\"1767 XXX XXXX\",\"emoji\":\"🇩🇲\"},{\"phoneCode\":\"1 809 and 1 829\",\"code\":\"DO\",\"name\":\"Dominican Republic\",\"pattern\":\"1 XXX XXX XXXX\",\"emoji\":\"🇩🇴\"},{\"phoneCode\":\"670\",\"code\":\"TL\",\"name\":\"Timor-Leste\",\"pattern\":\"\",\"emoji\":\"🇹🇱\"},{\"phoneCode\":\"593\",\"code\":\"EC\",\"name\":\"Ecuador\",\"pattern\":\"\",\"emoji\":\"🇪🇨\"},{\"phoneCode\":\"20\",\"code\":\"EG\",\"name\":\"Egypt\",\"pattern\":\"20 XX XXX XXXX\",\"emoji\":\"🇪🇬\"},{\"phoneCode\":\"503\",\"code\":\"SV\",\"name\":\"El Salvador\",\"pattern\":\"503 XXXX XXXX\",\"emoji\":\"🇸🇻\"},{\"phoneCode\":\"240\",\"code\":\"GQ\",\"name\":\"Equatorial Guinea\",\"pattern\":\"240 XXX XXX XXX\",\"emoji\":\"🇬🇶\"},{\"phoneCode\":\"291\",\"code\":\"ER\",\"name\":\"Eritrea\",\"pattern\":\"291 X XXX XXX\",\"emoji\":\"🇪🇷\"},{\"phoneCode\":\"372\",\"code\":\"EE\",\"name\":\"Estonia\",\"pattern\":\"\",\"emoji\":\"🇪🇪\"},{\"phoneCode\":\"251\",\"code\":\"ET\",\"name\":\"Ethiopia\",\"pattern\":\"251 XX XXX XXXX\",\"emoji\":\"🇪🇹\"},{\"phoneCode\":\"500\",\"code\":\"FK\",\"name\":\"Falkland Islands\",\"pattern\":\"\",\"emoji\":\"🇫🇰\"},{\"phoneCode\":\"298\",\"code\":\"FO\",\"name\":\"Faroe Islands\",\"pattern\":\"298 XXX XXX\",\"emoji\":\"🇫🇴\"},{\"phoneCode\":\"679\",\"code\":\"FJ\",\"name\":\"Fiji\",\"pattern\":\"\",\"emoji\":\"🇫🇯\"},{\"phoneCode\":\"358\",\"code\":\"FI\",\"name\":\"Finland\",\"pattern\":\"\",\"emoji\":\"🇫🇮\"},{\"phoneCode\":\"33\",\"code\":\"FR\",\"name\":\"France\",\"pattern\":\"33 X XX XX XX XX\",\"emoji\":\"🇫🇷\"},{\"phoneCode\":\"594\",\"code\":\"GF\",\"name\":\"French Guiana\",\"pattern\":\"\",\"emoji\":\"🇬🇫\"},{\"phoneCode\":\"689\",\"code\":\"PF\",\"name\":\"French Polynesia\",\"pattern\":\"\",\"emoji\":\"🇵🇫\"},{\"phoneCode\":\"241\",\"code\":\"GA\",\"name\":\"Gabon\",\"pattern\":\"241 X XX XX XX\",\"emoji\":\"🇬🇦\"},{\"phoneCode\":\"220\",\"code\":\"GM\",\"name\":\"Gambia\",\"pattern\":\"220 XXX XXXX\",\"emoji\":\"🇬🇲\"},{\"phoneCode\":\"995\",\"code\":\"GE\",\"name\":\"Georgia\",\"pattern\":\"\",\"emoji\":\"🇬🇪\"},{\"phoneCode\":\"49\",\"code\":\"DE\",\"name\":\"Germany\",\"pattern\":\"49 XXX XXXXXXXX\",\"emoji\":\"🇩🇪\"},{\"phoneCode\":\"233\",\"code\":\"GH\",\"name\":\"Ghana\",\"pattern\":\"\",\"emoji\":\"🇬🇭\"},{\"phoneCode\":\"350\",\"code\":\"GI\",\"name\":\"Gibraltar\",\"pattern\":\"350 XXXX XXXX\",\"emoji\":\"🇬🇮\"},{\"phoneCode\":\"30\",\"code\":\"GR\",\"name\":\"Greece\",\"pattern\":\"30 XX XXXX XXXX\",\"emoji\":\"🇬🇷\"},{\"phoneCode\":\"299\",\"code\":\"GL\",\"name\":\"Greenland\",\"pattern\":\"299 XXX XXX\",\"emoji\":\"🇬🇱\"},{\"phoneCode\":\"1 473\",\"code\":\"GD\",\"name\":\"Grenada\",\"pattern\":\"1473 XXX XXXX\",\"emoji\":\"🇬🇩\"},{\"phoneCode\":\"590\",\"code\":\"GP\",\"name\":\"Guadeloupe\",\"pattern\":\"\",\"emoji\":\"🇬🇵\"},{\"phoneCode\":\"1 671\",\"code\":\"GU\",\"name\":\"Guam\",\"pattern\":\"1671 XXX XXXX\",\"emoji\":\"🇬🇺\"},{\"phoneCode\":\"502\",\"code\":\"GT\",\"name\":\"Guatemala\",\"pattern\":\"502 X XXX XXXX\",\"emoji\":\"🇬🇹\"},{\"phoneCode\":\"44\",\"code\":\"GG\",\"name\":\"Guernsey\",\"pattern\":\"\",\"emoji\":\"🇬🇬\"},{\"phoneCode\":\"224\",\"code\":\"GN\",\"name\":\"Guinea\",\"pattern\":\"224 XXX XXX XXX\",\"emoji\":\"🇬🇳\"},{\"phoneCode\":\"245\",\"code\":\"GW\",\"name\":\"Guinea-Bissau\",\"pattern\":\"245 XXX XXXX\",\"emoji\":\"🇬🇼\"},{\"phoneCode\":\"592\",\"code\":\"GY\",\"name\":\"Guyana\",\"pattern\":\"\",\"emoji\":\"🇬🇾\"},{\"phoneCode\":\"509\",\"code\":\"HT\",\"name\":\"Haiti\",\"pattern\":\"\",\"emoji\":\"🇭🇹\"},{\"phoneCode\":\"504\",\"code\":\"HN\",\"name\":\"Honduras\",\"pattern\":\"504 XXXX XXXX\",\"emoji\":\"🇭🇳\"},{\"phoneCode\":\"852\",\"code\":\"HK\",\"name\":\"Hong Kong SAR China\",\"pattern\":\"\",\"emoji\":\"🇭🇰\"},{\"phoneCode\":\"36\",\"code\":\"HU\",\"name\":\"Hungary\",\"pattern\":\"36 XX XXX XXXX\",\"emoji\":\"🇭🇺\"},{\"phoneCode\":\"354\",\"code\":\"IS\",\"name\":\"Iceland\",\"pattern\":\"354 XXX XXXX\",\"emoji\":\"🇮🇸\"},{\"phoneCode\":\"91\",\"code\":\"IN\",\"name\":\"India\",\"pattern\":\"91 XXXXX XXXXX\",\"emoji\":\"🇮🇳\"},{\"phoneCode\":\"62\",\"code\":\"ID\",\"name\":\"Indonesia\",\"pattern\":\"\",\"emoji\":\"🇮🇩\"},{\"phoneCode\":\"98\",\"code\":\"IR\",\"name\":\"Iran\",\"pattern\":\"98 XXX XXX XXXX\",\"emoji\":\"🇮🇷\"},{\"phoneCode\":\"964\",\"code\":\"IQ\",\"name\":\"Iraq\",\"pattern\":\"964 XXX XXX XXXX\",\"emoji\":\"🇮🇶\"},{\"phoneCode\":\"353\",\"code\":\"IE\",\"name\":\"Ireland\",\"pattern\":\"353 XX XXX XXXX\",\"emoji\":\"🇮🇪\"},{\"phoneCode\":\"972\",\"code\":\"IL\",\"name\":\"Israel\",\"pattern\":\"972 XX XXX XXXX\",\"emoji\":\"🇮🇱\"},{\"phoneCode\":\"39\",\"code\":\"IT\",\"name\":\"Italy\",\"pattern\":\"39 XXX XXX XXXX\",\"emoji\":\"🇮🇹\"},{\"phoneCode\":\"1 876\",\"code\":\"JM\",\"name\":\"Jamaica\",\"pattern\":\"1876 XXX XXXX\",\"emoji\":\"🇯🇲\"},{\"phoneCode\":\"47 79\",\"code\":\"SJ\",\"name\":\"Svalbard & Jan Mayen\",\"pattern\":\"\",\"emoji\":\"🇸🇯\"},{\"phoneCode\":\"81\",\"code\":\"JP\",\"name\":\"Japan\",\"pattern\":\"81 XX XXXX XXXX\",\"emoji\":\"🇯🇵\"},{\"phoneCode\":\"44\",\"code\":\"JE\",\"name\":\"Jersey\",\"pattern\":\"\",\"emoji\":\"🇯🇪\"},{\"phoneCode\":\"962\",\"code\":\"JO\",\"name\":\"Jordan\",\"pattern\":\"962 X XXXX XXXX\",\"emoji\":\"🇯🇴\"},{\"phoneCode\":\"7 7\",\"code\":\"KZ\",\"name\":\"Kazakhstan\",\"pattern\":\"7 XXX XXX XX XX\",\"emoji\":\"🇰🇿\"},{\"phoneCode\":\"254\",\"code\":\"KE\",\"name\":\"Kenya\",\"pattern\":\"254 XXX XXX XXX\",\"emoji\":\"🇰🇪\"},{\"phoneCode\":\"686\",\"code\":\"KI\",\"name\":\"Kiribati\",\"pattern\":\"\",\"emoji\":\"🇰🇮\"},{\"phoneCode\":\"850\",\"code\":\"KP\",\"name\":\"North Korea\",\"pattern\":\"\",\"emoji\":\"🇰🇵\"},{\"phoneCode\":\"82\",\"code\":\"KR\",\"name\":\"South Korea\",\"pattern\":\"\",\"emoji\":\"🇰🇷\"},{\"phoneCode\":\"965\",\"code\":\"KW\",\"name\":\"Kuwait\",\"pattern\":\"965 XXXX XXXX\",\"emoji\":\"🇰🇼\"},{\"phoneCode\":\"996\",\"code\":\"KG\",\"name\":\"Kyrgyzstan\",\"pattern\":\"\",\"emoji\":\"🇰🇬\"},{\"phoneCode\":\"856\",\"code\":\"LA\",\"name\":\"Laos\",\"pattern\":\"\",\"emoji\":\"🇱🇦\"},{\"phoneCode\":\"371\",\"code\":\"LV\",\"name\":\"Latvia\",\"pattern\":\"371 XXX XXXXX\",\"emoji\":\"🇱🇻\"},{\"phoneCode\":\"961\",\"code\":\"LB\",\"name\":\"Lebanon\",\"pattern\":\"\",\"emoji\":\"🇱🇧\"},{\"phoneCode\":\"266\",\"code\":\"LS\",\"name\":\"Lesotho\",\"pattern\":\"266 XX XXX XXX\",\"emoji\":\"🇱🇸\"},{\"phoneCode\":\"231\",\"code\":\"LR\",\"name\":\"Liberia\",\"pattern\":\"\",\"emoji\":\"🇱🇷\"},{\"phoneCode\":\"218\",\"code\":\"LY\",\"name\":\"Libya\",\"pattern\":\"218 XX XXX XXXX\",\"emoji\":\"🇱🇾\"},{\"phoneCode\":\"423\",\"code\":\"LI\",\"name\":\"Liechtenstein\",\"pattern\":\"\",\"emoji\":\"🇱🇮\"},{\"phoneCode\":\"370\",\"code\":\"LT\",\"name\":\"Lithuania\",\"pattern\":\"370 XXX XXXXX\",\"emoji\":\"🇱🇹\"},{\"phoneCode\":\"352\",\"code\":\"LU\",\"name\":\"Luxembourg\",\"pattern\":\"\",\"emoji\":\"🇱🇺\"},{\"phoneCode\":\"853\",\"code\":\"MO\",\"name\":\"Macau SAR China\",\"pattern\":\"\",\"emoji\":\"🇲🇴\"},{\"phoneCode\":\"389\",\"code\":\"MK\",\"name\":\"Macedonia\",\"pattern\":\"\",\"emoji\":\"🇲🇰\"},{\"phoneCode\":\"261\",\"code\":\"MG\",\"name\":\"Madagascar\",\"pattern\":\"261 XX XX XXX XX\",\"emoji\":\"🇲🇬\"},{\"phoneCode\":\"265\",\"code\":\"MW\",\"name\":\"Malawi\",\"pattern\":\"\",\"emoji\":\"🇲🇼\"},{\"phoneCode\":\"60\",\"code\":\"MY\",\"name\":\"Malaysia\",\"pattern\":\"\",\"emoji\":\"🇲🇾\"},{\"phoneCode\":\"960\",\"code\":\"MV\",\"name\":\"Maldives\",\"pattern\":\"\",\"emoji\":\"🇲🇻\"},{\"phoneCode\":\"223\",\"code\":\"ML\",\"name\":\"Mali\",\"pattern\":\"223 XXXX XXXX\",\"emoji\":\"🇲🇱\"},{\"phoneCode\":\"356\",\"code\":\"MT\",\"name\":\"Malta\",\"pattern\":\"356 XX XX XX XX\",\"emoji\":\"🇲🇹\"},{\"phoneCode\":\"692\",\"code\":\"MH\",\"name\":\"Marshall Islands\",\"pattern\":\"\",\"emoji\":\"🇲🇭\"},{\"phoneCode\":\"596\",\"code\":\"MQ\",\"name\":\"Martinique\",\"pattern\":\"\",\"emoji\":\"🇲🇶\"},{\"phoneCode\":\"222\",\"code\":\"MR\",\"name\":\"Mauritania\",\"pattern\":\"222 XXXX XXXX\",\"emoji\":\"🇲🇷\"},{\"phoneCode\":\"230\",\"code\":\"MU\",\"name\":\"Mauritius\",\"pattern\":\"\",\"emoji\":\"🇲🇺\"},{\"phoneCode\":\"262\",\"code\":\"YT\",\"name\":\"Mayotte\",\"pattern\":\"\",\"emoji\":\"🇾🇹\"},{\"phoneCode\":\"52\",\"code\":\"MX\",\"name\":\"Mexico\",\"pattern\":\"\",\"emoji\":\"🇲🇽\"},{\"phoneCode\":\"691\",\"code\":\"FM\",\"name\":\"Micronesia\",\"pattern\":\"\",\"emoji\":\"🇫🇲\"},{\"phoneCode\":\"373\",\"code\":\"MD\",\"name\":\"Moldova\",\"pattern\":\"373 XX XXX XXX\",\"emoji\":\"🇲🇩\"},{\"phoneCode\":\"377\",\"code\":\"MC\",\"name\":\"Monaco\",\"pattern\":\"377 XXXX XXXX\",\"emoji\":\"🇲🇨\"},{\"phoneCode\":\"976\",\"code\":\"MN\",\"name\":\"Mongolia\",\"pattern\":\"\",\"emoji\":\"🇲🇳\"},{\"phoneCode\":\"382\",\"code\":\"ME\",\"name\":\"Montenegro\",\"pattern\":\"\",\"emoji\":\"🇲🇪\"},{\"phoneCode\":\"1 664\",\"code\":\"MS\",\"name\":\"Montserrat\",\"pattern\":\"1664 XXX XXXX\",\"emoji\":\"🇲🇸\"},{\"phoneCode\":\"212\",\"code\":\"MA\",\"name\":\"Morocco\",\"pattern\":\"212 XX XXX XXXX\",\"emoji\":\"🇲🇦\"},{\"phoneCode\":\"258\",\"code\":\"MZ\",\"name\":\"Mozambique\",\"pattern\":\"258 XX XXX XXXX\",\"emoji\":\"🇲🇿\"},{\"phoneCode\":\"264\",\"code\":\"NA\",\"name\":\"Namibia\",\"pattern\":\"264 XX XXX XXXX\",\"emoji\":\"🇳🇦\"},{\"phoneCode\":\"674\",\"code\":\"NR\",\"name\":\"Nauru\",\"pattern\":\"\",\"emoji\":\"🇳🇷\"},{\"phoneCode\":\"977\",\"code\":\"NP\",\"name\":\"Nepal\",\"pattern\":\"\",\"emoji\":\"🇳🇵\"},{\"phoneCode\":\"31\",\"code\":\"NL\",\"name\":\"Netherlands\",\"pattern\":\"31 X XX XX XX XX\",\"emoji\":\"🇳🇱\"},{\"phoneCode\":\"687\",\"code\":\"NC\",\"name\":\"New Caledonia\",\"pattern\":\"\",\"emoji\":\"🇳🇨\"},{\"phoneCode\":\"64\",\"code\":\"NZ\",\"name\":\"New Zealand\",\"pattern\":\"\",\"emoji\":\"🇳🇿\"},{\"phoneCode\":\"505\",\"code\":\"NI\",\"name\":\"Nicaragua\",\"pattern\":\"505 XXXX XXXX\",\"emoji\":\"🇳🇮\"},{\"phoneCode\":\"227\",\"code\":\"NE\",\"name\":\"Niger\",\"pattern\":\"227 XX XX XX XX\",\"emoji\":\"🇳🇪\"},{\"phoneCode\":\"234\",\"code\":\"NG\",\"name\":\"Nigeria\",\"pattern\":\"\",\"emoji\":\"🇳🇬\"},{\"phoneCode\":\"683\",\"code\":\"NU\",\"name\":\"Niue\",\"pattern\":\"\",\"emoji\":\"🇳🇺\"},{\"phoneCode\":\"672\",\"code\":\"NF\",\"name\":\"Norfolk Island\",\"pattern\":\"\",\"emoji\":\"🇳🇫\"},{\"phoneCode\":\"1 670\",\"code\":\"MP\",\"name\":\"Northern Mariana Islands\",\"pattern\":\"1670 XXX XXXX\",\"emoji\":\"🇲🇵\"},{\"phoneCode\":\"47\",\"code\":\"NO\",\"name\":\"Norway\",\"pattern\":\"47 XXXX XXXX\",\"emoji\":\"🇳🇴\"},{\"phoneCode\":\"968\",\"code\":\"OM\",\"name\":\"Oman\",\"pattern\":\"968 XXXX XXXX\",\"emoji\":\"🇴🇲\"},{\"phoneCode\":\"92\",\"code\":\"PK\",\"name\":\"Pakistan\",\"pattern\":\"92 XXX XXX XXXX\",\"emoji\":\"🇵🇰\"},{\"phoneCode\":\"680\",\"code\":\"PW\",\"name\":\"Palau\",\"pattern\":\"\",\"emoji\":\"🇵🇼\"},{\"phoneCode\":\"970\",\"code\":\"PS\",\"name\":\"Palestinian Territories\",\"pattern\":\"970 XXX XX XXXX\",\"emoji\":\"🇵🇸\"},{\"phoneCode\":\"507\",\"code\":\"PA\",\"name\":\"Panama\",\"pattern\":\"507 XXXX XXXX\",\"emoji\":\"🇵🇦\"},{\"phoneCode\":\"675\",\"code\":\"PG\",\"name\":\"Papua New Guinea\",\"pattern\":\"\",\"emoji\":\"🇵🇬\"},{\"phoneCode\":\"595\",\"code\":\"PY\",\"name\":\"Paraguay\",\"pattern\":\"595 XXX XXX XXX\",\"emoji\":\"🇵🇾\"},{\"phoneCode\":\"51\",\"code\":\"PE\",\"name\":\"Peru\",\"pattern\":\"51 XXX XXX XXX\",\"emoji\":\"🇵🇪\"},{\"phoneCode\":\"63\",\"code\":\"PH\",\"name\":\"Philippines\",\"pattern\":\"63 XXX XXX XXXX\",\"emoji\":\"🇵🇭\"},{\"phoneCode\":\"64\",\"code\":\"PN\",\"name\":\"Pitcairn Islands\",\"pattern\":\"\",\"emoji\":\"🇵🇳\"},{\"phoneCode\":\"48\",\"code\":\"PL\",\"name\":\"Poland\",\"pattern\":\"48 XXX XXX XXX\",\"emoji\":\"🇵🇱\"},{\"phoneCode\":\"351\",\"code\":\"PT\",\"name\":\"Portugal\",\"pattern\":\"351 X XXXX XXXX\",\"emoji\":\"🇵🇹\"},{\"phoneCode\":\"1 787 and 1 939\",\"code\":\"PR\",\"name\":\"Puerto Rico\",\"pattern\":\"1 XXX XXX XXXX\",\"emoji\":\"🇵🇷\"},{\"phoneCode\":\"974\",\"code\":\"QA\",\"name\":\"Qatar\",\"pattern\":\"\",\"emoji\":\"🇶🇦\"},{\"phoneCode\":\"262\",\"code\":\"RE\",\"name\":\"Reunion\",\"pattern\":\"262 XXX XXX XXX\",\"emoji\":\"🇷🇪\"},{\"phoneCode\":\"40\",\"code\":\"RO\",\"name\":\"Romania\",\"pattern\":\"40 XXX XXX XXX\",\"emoji\":\"🇷🇴\"},{\"phoneCode\":\"7\",\"code\":\"RU\",\"name\":\"Russia\",\"pattern\":\"7 XXX XXX XX XX\",\"emoji\":\"🇷🇺\"},{\"phoneCode\":\"250\",\"code\":\"RW\",\"name\":\"Rwanda\",\"pattern\":\"250 XXX XXX XXX\",\"emoji\":\"🇷🇼\"},{\"phoneCode\":\"590\",\"code\":\"BL\",\"name\":\"St. Barthelemy\",\"pattern\":\"\",\"emoji\":\"🇧🇱\"},{\"phoneCode\":\"290\",\"code\":\"SH\",\"name\":\"St. Helena\",\"pattern\":\"290 XX XXX\",\"emoji\":\"🇸🇭\"},{\"phoneCode\":\"1 869\",\"code\":\"KN\",\"name\":\"St. Kitts & Nevis\",\"pattern\":\"1869 XXX XXXX\",\"emoji\":\"🇰🇳\"},{\"phoneCode\":\"1 758\",\"code\":\"LC\",\"name\":\"St. Lucia\",\"pattern\":\"1758 XXX XXXX\",\"emoji\":\"🇱🇨\"},{\"phoneCode\":\"590\",\"code\":\"MF\",\"name\":\"St. Martin (France)\",\"pattern\":\"\",\"emoji\":\"🇲🇫\"},{\"phoneCode\":\"508\",\"code\":\"PM\",\"name\":\"St. Pierre and Miquelon\",\"pattern\":\"\",\"emoji\":\"🇵🇲\"},{\"phoneCode\":\"1 784\",\"code\":\"VC\",\"name\":\"St. Vincent and the Grenadines\",\"pattern\":\"1784 XXX XXXX\",\"emoji\":\"🇻🇨\"},{\"phoneCode\":\"685\",\"code\":\"WS\",\"name\":\"Samoa\",\"pattern\":\"\",\"emoji\":\"🇼🇸\"},{\"phoneCode\":\"378\",\"code\":\"SM\",\"name\":\"San Marino\",\"pattern\":\"378 XXX XXX XXXX\",\"emoji\":\"🇸🇲\"},{\"phoneCode\":\"239\",\"code\":\"ST\",\"name\":\"São Tome & Principe\",\"pattern\":\"239 XX XXXXX\",\"emoji\":\"🇸🇹\"},{\"phoneCode\":\"966\",\"code\":\"SA\",\"name\":\"Saudi Arabia\",\"pattern\":\"\",\"emoji\":\"🇸🇦\"},{\"phoneCode\":\"221\",\"code\":\"SN\",\"name\":\"Senegal\",\"pattern\":\"221 XX XXX XXXX\",\"emoji\":\"🇸🇳\"},{\"phoneCode\":\"381\",\"code\":\"RS\",\"name\":\"Serbia\",\"pattern\":\"381 XX XXX XXXX\",\"emoji\":\"🇷🇸\"},{\"phoneCode\":\"248\",\"code\":\"SC\",\"name\":\"Seychelles\",\"pattern\":\"248 X XX XX XX\",\"emoji\":\"🇸🇨\"},{\"phoneCode\":\"232\",\"code\":\"SL\",\"name\":\"Sierra Leone\",\"pattern\":\"232 XX XXX XXX\",\"emoji\":\"🇸🇱\"},{\"phoneCode\":\"65\",\"code\":\"SG\",\"name\":\"Singapore\",\"pattern\":\"65 XXXX XXXX\",\"emoji\":\"🇸🇬\"},{\"phoneCode\":\"599 3\",\"code\":\"BQ\",\"name\":\"Sint Eustatius\",\"pattern\":\"\",\"emoji\":\"🇧🇶\"},{\"phoneCode\":\"1 721\",\"code\":\"SX\",\"name\":\"Sint Maarten\",\"pattern\":\"1721 XXX XXXX\",\"emoji\":\"🇸🇽\"},{\"phoneCode\":\"421\",\"code\":\"SK\",\"name\":\"Slovakia\",\"pattern\":\"\",\"emoji\":\"🇸🇰\"},{\"phoneCode\":\"386\",\"code\":\"SI\",\"name\":\"Slovenia\",\"pattern\":\"\",\"emoji\":\"🇸🇮\"},{\"phoneCode\":\"677\",\"code\":\"SB\",\"name\":\"Solomon Islands\",\"pattern\":\"\",\"emoji\":\"🇸🇧\"},{\"phoneCode\":\"252\",\"code\":\"SO\",\"name\":\"Somalia\",\"pattern\":\"252 XX XXX XXX\",\"emoji\":\"🇸🇴\"},{\"phoneCode\":\"27\",\"code\":\"ZA\",\"name\":\"South Africa\",\"pattern\":\"27 XX XXX XXXX\",\"emoji\":\"🇿🇦\"},{\"phoneCode\":\"500\",\"code\":\"GS\",\"name\":\"South Georgia & South Sandwich Islands\",\"pattern\":\"\",\"emoji\":\"🇬🇸\"},{\"phoneCode\":\"995 34\",\"code\":\"\",\"name\":\"South Ossetia\",\"pattern\":\"\",\"emoji\":\"\"},{\"phoneCode\":\"211\",\"code\":\"SS\",\"name\":\"South Sudan\",\"pattern\":\"211 XX XXX XXXX\",\"emoji\":\"🇸🇸\"},{\"phoneCode\":\"34\",\"code\":\"ES\",\"name\":\"Spain\",\"pattern\":\"34 XXX XXX XXX\",\"emoji\":\"🇪🇸\"},{\"phoneCode\":\"94\",\"code\":\"LK\",\"name\":\"Sri Lanka\",\"pattern\":\"94 XX XXX XXXX\",\"emoji\":\"🇱🇰\"},{\"phoneCode\":\"249\",\"code\":\"SD\",\"name\":\"Sudan\",\"pattern\":\"249 XX XXX XXXX\",\"emoji\":\"🇸🇩\"},{\"phoneCode\":\"597\",\"code\":\"SR\",\"name\":\"Suriname\",\"pattern\":\"597 XXX XXXX\",\"emoji\":\"🇸🇷\"},{\"phoneCode\":\"47 79\",\"code\":\"SJ\",\"name\":\"Svalbard\",\"pattern\":\"\",\"emoji\":\"🇸🇯\"},{\"phoneCode\":\"268\",\"code\":\"SZ\",\"name\":\"Swaziland\",\"pattern\":\"268 XXXX XXXX\",\"emoji\":\"🇸🇿\"},{\"phoneCode\":\"46\",\"code\":\"SE\",\"name\":\"Sweden\",\"pattern\":\"46 XX XXX XXXX\",\"emoji\":\"🇸🇪\"},{\"phoneCode\":\"41\",\"code\":\"CH\",\"name\":\"Switzerland\",\"pattern\":\"41 XX XXX XXXX\",\"emoji\":\"🇨🇭\"},{\"phoneCode\":\"963\",\"code\":\"SY\",\"name\":\"Syria\",\"pattern\":\"\",\"emoji\":\"🇸🇾\"},{\"phoneCode\":\"886\",\"code\":\"TW\",\"name\":\"Taiwan\",\"pattern\":\"\",\"emoji\":\"🇹🇼\"},{\"phoneCode\":\"992\",\"code\":\"TJ\",\"name\":\"Tajikistan\",\"pattern\":\"\",\"emoji\":\"🇹🇯\"},{\"phoneCode\":\"255\",\"code\":\"TZ\",\"name\":\"Tanzania\",\"pattern\":\"255 XX XXX XXXX\",\"emoji\":\"🇹🇿\"},{\"phoneCode\":\"66\",\"code\":\"TH\",\"name\":\"Thailand\",\"pattern\":\"66 X XXXX XXXX\",\"emoji\":\"🇹🇭\"},{\"phoneCode\":\"228\",\"code\":\"TG\",\"name\":\"Togo\",\"pattern\":\"228 XX XXX XXX\",\"emoji\":\"🇹🇬\"},{\"phoneCode\":\"690\",\"code\":\"TK\",\"name\":\"Tokelau\",\"pattern\":\"\",\"emoji\":\"🇹🇰\"},{\"phoneCode\":\"676\",\"code\":\"TO\",\"name\":\"Tonga\",\"pattern\":\"\",\"emoji\":\"🇹🇴\"},{\"phoneCode\":\"1 868\",\"code\":\"TT\",\"name\":\"Trinidad & Tobago\",\"pattern\":\"1868 XXX XXXX\",\"emoji\":\"🇹🇹\"},{\"phoneCode\":\"216\",\"code\":\"TN\",\"name\":\"Tunisia\",\"pattern\":\"216 XX XXX XXX\",\"emoji\":\"🇹🇳\"},{\"phoneCode\":\"90\",\"code\":\"TR\",\"name\":\"Turkey\",\"pattern\":\"90 XXX XXX XXXX\",\"emoji\":\"🇹🇷\"},{\"phoneCode\":\"993\",\"code\":\"TM\",\"name\":\"Turkmenistan\",\"pattern\":\"993 XX XXXXXX\",\"emoji\":\"🇹🇲\"},{\"phoneCode\":\"1 649\",\"code\":\"TC\",\"name\":\"Turks & Caicos Islands\",\"pattern\":\"1649 XXX XXXX\",\"emoji\":\"🇹🇨\"},{\"phoneCode\":\"688\",\"code\":\"TV\",\"name\":\"Tuvalu\",\"pattern\":\"\",\"emoji\":\"🇹🇻\"},{\"phoneCode\":\"256\",\"code\":\"UG\",\"name\":\"Uganda\",\"pattern\":\"256 XX XXX XXXX\",\"emoji\":\"🇺🇬\"},{\"phoneCode\":\"380\",\"code\":\"UA\",\"name\":\"Ukraine\",\"pattern\":\"380 XX XXX XX XX\",\"emoji\":\"🇺🇦\"},{\"phoneCode\":\"971\",\"code\":\"AE\",\"name\":\"United Arab Emirates\",\"pattern\":\"971 XX XXX XXXX\",\"emoji\":\"🇦🇪\"},{\"phoneCode\":\"44\",\"code\":\"GB\",\"name\":\"United Kingdom\",\"pattern\":\"44 XXXX XXXXXX\",\"emoji\":\"🇬🇧\"},{\"phoneCode\":\"1\",\"code\":\"US\",\"name\":\"United States\",\"pattern\":\"1 XXX XXX XXXX\",\"emoji\":\"🇺🇸\"},{\"phoneCode\":\"598\",\"code\":\"UY\",\"name\":\"Uruguay\",\"pattern\":\"598 XXXX XXXX\",\"emoji\":\"🇺🇾\"},{\"phoneCode\":\"1 340\",\"code\":\"VI\",\"name\":\"U.S. Virgin Islands\",\"pattern\":\"1340 XXX XXXX\",\"emoji\":\"🇻🇮\"},{\"phoneCode\":\"998\",\"code\":\"UZ\",\"name\":\"Uzbekistan\",\"pattern\":\"998 XX XXXXXXX\",\"emoji\":\"🇺🇿\"},{\"phoneCode\":\"678\",\"code\":\"VU\",\"name\":\"Vanuatu\",\"pattern\":\"\",\"emoji\":\"🇻🇺\"},{\"phoneCode\":\"58\",\"code\":\"VE\",\"name\":\"Venezuela\",\"pattern\":\"58 XXX XXX XXXX\",\"emoji\":\"🇻🇪\"},{\"phoneCode\":\"39 06 698\",\"code\":\"VA\",\"name\":\"Vatican City\",\"pattern\":\"\",\"emoji\":\"🇻🇦\"},{\"phoneCode\":\"84\",\"code\":\"VN\",\"name\":\"Vietnam\",\"pattern\":\"\",\"emoji\":\"🇻🇳\"},{\"phoneCode\":\"681\",\"code\":\"WF\",\"name\":\"Wallis & Futuna\",\"pattern\":\"\",\"emoji\":\"🇼🇫\"},{\"phoneCode\":\"967\",\"code\":\"YE\",\"name\":\"Yemen\",\"pattern\":\"967 XXX XXX XXX\",\"emoji\":\"🇾🇪\"},{\"phoneCode\":\"260\",\"code\":\"ZM\",\"name\":\"Zambia\",\"pattern\":\"260 XX XXX XXXX\",\"emoji\":\"🇿🇲\"},{\"phoneCode\":\"255\",\"code\":\"\",\"name\":\"Zanzibar\",\"pattern\":\"\",\"emoji\":\"\"},{\"phoneCode\":\"263\",\"code\":\"ZW\",\"name\":\"Zimbabwe\",\"pattern\":\"263 XX XXX XXXX\",\"emoji\":\"🇿🇼\"}];\r\nconst PhoneCodesMain: {[phoneCode: string]: Country} = {\r\n  '1': Countries.find(c => c.name === 'United States'),\r\n  '44': Countries.find(c => c.name === 'United Kingdom'),\r\n  '61': Countries.find(c => c.name === 'Australia'),\r\n  '64': Countries.find(c => c.name === 'New Zealand'),\r\n  '246': Countries.find(c => c.name === 'Diego Garcia'),\r\n  '255': Countries.find(c => c.name === 'Tanzania'),\r\n  '262': Countries.find(c => c.name === 'Reunion'),\r\n  '500': Countries.find(c => c.name === 'Falkland Islands'),\r\n  '590': Countries.find(c => c.name === 'Guadeloupe'),\r\n  '672': Countries.find(c => c.name === 'Norfolk Island'),\r\n  '1 268': Countries.find(c => c.name === 'Antigua & Barbuda'),\r\n};\r\n\r\n/* \r\nconst toInt = (str) => {\r\n  return parseInt(str.replace(/ /g, ''));\r\n};\r\nvar arr = window.Countries.sort((a, b) => toInt(a.phoneCode) - toInt(b.phoneCode));\r\narr.forEach((el, idx) => {\r\n  if(idx === (arr.length - 1)) {\r\n    return;\r\n  }\r\n\r\n  if(toInt(arr[idx + 1].phoneCode) === toInt(el.phoneCode)) {\r\n    console.log('duplicate', el, arr[idx + 1]);\r\n  }\r\n});\r\n*/\r\n\r\nMOUNT_CLASS_TO.Countries = Countries;\r\n\r\nexport default Countries;\r\nexport {PhoneCodesMain};","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\ntype TargetType = HTMLElement;\r\nexport type OnVisibilityChange = (target: TargetType, visible: boolean) => void;\r\n\r\nexport default class VisibilityIntersector {\r\n  private observer: IntersectionObserver;\r\n  private items: Map<TargetType, boolean> = new Map();\r\n  private locked = false;\r\n\r\n  constructor(onVisibilityChange: OnVisibilityChange) {\r\n    this.observer = new IntersectionObserver((entries) => {\r\n      if(this.locked) {\r\n        return;\r\n      }\r\n\r\n      const changed: {target: TargetType, visible: boolean}[] = [];\r\n\r\n      entries.forEach(entry => {\r\n        const target = entry.target as TargetType;\r\n\r\n        if(this.items.get(target) === entry.isIntersecting) {\r\n          return;\r\n        } else {\r\n          this.items.set(target, entry.isIntersecting);\r\n        }\r\n\r\n        /* if(entry.isIntersecting) {\r\n          console.log('ooo', entry);\r\n        } */\r\n\r\n        /* if(this.locked) {\r\n          return;\r\n        } */\r\n\r\n        changed[entry.isIntersecting ? 'unshift' : 'push']({target, visible: entry.isIntersecting});\r\n\r\n        //onVisibilityChange(target, entry.isIntersecting);\r\n      });\r\n\r\n      changed.forEach(smth => {\r\n        onVisibilityChange(smth.target, smth.visible);\r\n      });\r\n    });\r\n  }\r\n\r\n  public getVisible() {\r\n    const items: TargetType[] = [];\r\n    this.items.forEach((value, key) => {\r\n      if(value) {\r\n        items.push(key);\r\n      }\r\n    });\r\n\r\n    return items;\r\n  }\r\n\r\n  public clearVisible() {\r\n    const visible = this.getVisible();\r\n    for(const target of visible) {\r\n      this.items.set(target, false);\r\n    }\r\n  }\r\n\r\n  public isVisible(target: TargetType) {\r\n    return this.items.get(target);\r\n  }\r\n\r\n  public disconnect() {\r\n    this.observer.disconnect();\r\n    this.items.clear();\r\n  }\r\n\r\n  public refresh() {\r\n    this.observer.disconnect();\r\n\r\n    //window.requestAnimationFrame(() => {\r\n      const targets = [...this.items.keys()];\r\n      for(const target of targets) {\r\n        //this.items.set(target, false);\r\n        this.observer.observe(target);\r\n      }\r\n    //});\r\n  }\r\n\r\n  public refreshVisible() {\r\n    const visible = this.getVisible();\r\n    for(const target of visible) {\r\n      this.observer.unobserve(target);\r\n    }\r\n\r\n    for(const target of visible) {\r\n      this.observer.observe(target);\r\n    }\r\n  }\r\n\r\n  public observe(target: TargetType) {\r\n    this.items.set(target, false);\r\n    this.observer.observe(target);\r\n  }\r\n\r\n  public unobserve(target: TargetType) {\r\n    this.observer.unobserve(target);\r\n    this.items.delete(target);\r\n  }\r\n\r\n  public unlock() {\r\n    this.locked = false;\r\n  }\r\n\r\n  public unlockAndRefresh() {\r\n    this.unlock();\r\n    this.refresh();\r\n  }\r\n\r\n  public lock() {\r\n    this.locked = true;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { throttle } from \"../helpers/schedulers\";\r\nimport { logger, LogTypes } from \"../lib/logger\";\r\nimport VisibilityIntersector, { OnVisibilityChange } from \"./visibilityIntersector\";\r\nimport { findAndSpliceAll } from \"../helpers/array\";\r\n\r\ntype LazyLoadElementBase = {\r\n  load: () => Promise<any>\r\n};\r\n\r\ntype LazyLoadElement = Omit<LazyLoadElementBase, 'load'> & {\r\n  load: (target?: HTMLElement) => Promise<any>,\r\n  div: HTMLElement\r\n  wasSeen?: boolean,\r\n};\r\n\r\nconst PARALLEL_LIMIT = 8;\r\n\r\nexport class LazyLoadQueueBase {\r\n  public queueId = 0;\r\n  protected queue: Array<LazyLoadElementBase> = [];\r\n  protected inProcess: Set<LazyLoadElementBase> = new Set();\r\n\r\n  protected lockPromise: Promise<void> = null;\r\n  protected unlockResolve: () => void = null;\r\n\r\n  protected log = logger('LL', LogTypes.Error);\r\n  protected processQueue: () => void;\r\n\r\n  constructor(protected parallelLimit = PARALLEL_LIMIT) {\r\n    this.processQueue = throttle(() => this._processQueue(), 20, false);\r\n  }\r\n\r\n  public clear() {\r\n    this.inProcess.clear(); // ацтеки забьются, будет плохо\r\n\r\n    this.queue.length = 0;\r\n    // unreachable code\r\n    /* for(let item of this.inProcess) { \r\n      this.lazyLoadMedia.push(item);\r\n    } */\r\n  }\r\n\r\n  public lock() {\r\n    if(this.lockPromise) return;\r\n\r\n    //const perf = performance.now();\r\n    this.lockPromise = new Promise((resolve, reject) => {\r\n      this.unlockResolve = resolve;\r\n    });\r\n\r\n    /* if(DEBUG) {\r\n      this.lockPromise.then(() => {\r\n        this.log('was locked for:', performance.now() - perf);\r\n      });\r\n    } */\r\n  }\r\n\r\n  public unlock() {\r\n    if(!this.unlockResolve) return;\r\n\r\n    this.unlockResolve();\r\n    this.unlockResolve = this.lockPromise = null;\r\n\r\n    this.processQueue();\r\n  }\r\n\r\n  protected async processItem(item: LazyLoadElementBase) {\r\n    if(this.lockPromise) {\r\n      return;\r\n    }\r\n\r\n    this.inProcess.add(item);\r\n\r\n    /* if(DEBUG) {\r\n      this.log('will load media', this.lockPromise, item);\r\n    } */\r\n\r\n    try {\r\n      //await new Promise((resolve) => setTimeout(resolve, 2e3));\r\n      //await new Promise((resolve, reject) => window.requestAnimationFrame(() => window.requestAnimationFrame(resolve)));\r\n      //await item.load(item.div);\r\n      await this.loadItem(item);\r\n    } catch(err) {\r\n      if(!['NO_ENTRY_FOUND', 'STORAGE_OFFLINE'].includes(err)) {\r\n        this.log.error('loadMediaQueue error:', err/* , item */);\r\n      }\r\n    }\r\n\r\n    this.inProcess.delete(item);\r\n\r\n    /* if(DEBUG) {\r\n      this.log('loaded media', item);\r\n    } */\r\n\r\n    this.processQueue();\r\n  }\r\n\r\n  protected loadItem(item: LazyLoadElementBase) {\r\n    return item.load();\r\n  }\r\n\r\n  protected getItem() {\r\n    return this.queue.shift();\r\n  }\r\n\r\n  protected addElement(method: 'push' | 'unshift', el: LazyLoadElementBase) {\r\n    this.queue[method](el);\r\n    this.processQueue();\r\n  }\r\n\r\n  protected _processQueue(item?: LazyLoadElementBase) {\r\n    if(!this.queue.length || this.lockPromise || (this.parallelLimit > 0 && this.inProcess.size >= this.parallelLimit)) return;\r\n\r\n    //console.log('_processQueue start');\r\n    let added = 0;\r\n    do {\r\n      if(item) {\r\n        this.queue.findAndSplice(i => i === item);\r\n      } else {\r\n        item = this.getItem();\r\n      }\r\n  \r\n      if(item) {\r\n        this.processItem(item);\r\n      } else {\r\n        break;\r\n      }\r\n\r\n      item = null;\r\n      ++added;\r\n    } while(this.inProcess.size < this.parallelLimit && this.queue.length);\r\n    //console.log('_processQueue end, added', added, this.queue.length);\r\n  }\r\n\r\n  public push(el: LazyLoadElementBase) {\r\n    this.addElement('push', el);\r\n  }\r\n\r\n  public unshift(el: LazyLoadElementBase) {\r\n    this.addElement('unshift', el);\r\n  }\r\n}\r\n\r\nexport class LazyLoadQueueIntersector extends LazyLoadQueueBase {\r\n  protected queue: Array<LazyLoadElement> = [];\r\n  protected inProcess: Set<LazyLoadElement> = new Set();\r\n\r\n  public intersector: VisibilityIntersector;\r\n  protected intersectorTimeout: number;\r\n\r\n  constructor(protected parallelLimit = PARALLEL_LIMIT) {\r\n    super(parallelLimit);\r\n  }\r\n\r\n  public lock() {\r\n    super.lock();\r\n    this.intersector.lock();\r\n  }\r\n\r\n  public unlock() {\r\n    super.unlock();\r\n    this.intersector.unlock();\r\n  }\r\n\r\n  public unlockAndRefresh() {\r\n    super.unlock();\r\n    this.intersector.unlockAndRefresh();\r\n  }\r\n\r\n  public clear() {\r\n    super.clear();\r\n    this.intersector.disconnect();\r\n  }\r\n\r\n  public refresh() {\r\n    this.intersector.refresh();\r\n  }\r\n\r\n  protected loadItem(item: LazyLoadElement) {\r\n    return item.load(item.div);\r\n  }\r\n\r\n  protected addElement(method: 'push' | 'unshift', el: LazyLoadElement) {\r\n    const item = this.queue.find(i => i.div === el.div && i.load === el.load);\r\n    if(item) {\r\n      return false;\r\n    } else {\r\n      for(const item of this.inProcess) {\r\n        if(item.div === el.div && item.load === el.load) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n\r\n    this.queue[method](el);\r\n    return true;\r\n  }\r\n\r\n  protected setProcessQueueTimeout() {\r\n    if(!this.intersectorTimeout) {\r\n      this.intersectorTimeout = window.setTimeout(() => {\r\n        this.intersectorTimeout = 0;\r\n        this.processQueue();\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  public push(el: LazyLoadElement) {\r\n    super.push(el);\r\n  }\r\n\r\n  public unshift(el: LazyLoadElement) {\r\n    super.unshift(el);\r\n  }\r\n\r\n  public unobserve(el: HTMLElement) {\r\n    findAndSpliceAll(this.queue, (i) => i.div === el);\r\n\r\n    this.intersector.unobserve(el);\r\n  }\r\n}\r\n\r\nexport default class LazyLoadQueue extends LazyLoadQueueIntersector {\r\n  constructor(protected parallelLimit = PARALLEL_LIMIT) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector(this.onVisibilityChange);\r\n  }\r\n\r\n  private onVisibilityChange = (target: HTMLElement, visible: boolean) => {\r\n    if(visible) {\r\n      /* if(DEBUG) {\r\n        this.log('isIntersecting', target);\r\n      } */\r\n\r\n      // need for set element first if scrolled\r\n      findAndSpliceAll(this.queue, (i) => i.div === target).forEach(item => {\r\n        item.wasSeen = true;\r\n        this.queue.unshift(item);\r\n        //this.processQueue(item);\r\n      });\r\n\r\n      this.setProcessQueueTimeout();\r\n    }\r\n  };\r\n\r\n  protected getItem() {\r\n    return this.queue.findAndSplice(item => item.wasSeen);\r\n  }\r\n\r\n  public async processItem(item: LazyLoadElement) {\r\n    await super.processItem(item);\r\n    this.intersector.unobserve(item.div);\r\n  }\r\n\r\n  protected addElement(method: 'push' | 'unshift', el: LazyLoadElement) {\r\n    const inserted = super.addElement(method, el);\r\n\r\n    if(!inserted) return false;\r\n\r\n    this.intersector.observe(el.div);\r\n    /* if(el.wasSeen) {\r\n      this.processQueue(el);\r\n    } else  */if(!el.hasOwnProperty('wasSeen')) {\r\n      el.wasSeen = false;\r\n    }\r\n    \r\n    return true;\r\n  }\r\n}\r\n\r\nexport class LazyLoadQueueRepeat extends LazyLoadQueueIntersector {\r\n  private _queue: Map<HTMLElement, LazyLoadElement> = new Map();\r\n\r\n  constructor(protected parallelLimit = PARALLEL_LIMIT, protected onVisibilityChange?: OnVisibilityChange) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector((target, visible) => {\r\n      const spliced = findAndSpliceAll(this.queue, (i) => i.div === target);\r\n      if(visible) {\r\n        const items = spliced.length ? spliced : [this._queue.get(target)];\r\n        items.forEach(item => {\r\n          this.queue.unshift(item || this._queue.get(target));\r\n        });\r\n      }\r\n  \r\n      this.onVisibilityChange && this.onVisibilityChange(target, visible);\r\n      this.setProcessQueueTimeout();\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    super.clear();\r\n    this._queue.clear();\r\n  }\r\n\r\n  /* public async processItem(item: LazyLoadElement) {\r\n    //await super.processItem(item);\r\n    await LazyLoadQueueBase.prototype.processItem.call(this, item);\r\n\r\n    if(this.lazyLoadMedia.length) {\r\n      this.processQueue();\r\n    }\r\n  } */\r\n\r\n  public observe(el: LazyLoadElement) {\r\n    this._queue.set(el.div, el);\r\n    this.intersector.observe(el.div);\r\n  }\r\n}\r\n\r\nexport class LazyLoadQueueRepeat2 extends LazyLoadQueueIntersector {\r\n  constructor(protected parallelLimit = PARALLEL_LIMIT, protected onVisibilityChange?: OnVisibilityChange) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector((target, visible) => {\r\n      const spliced = findAndSpliceAll(this.queue, (i) => i.div === target);\r\n      if(visible && spliced.length) {\r\n        spliced.forEach(item => {\r\n          this.queue.unshift(item);\r\n        });\r\n      }\r\n  \r\n      this.onVisibilityChange && this.onVisibilityChange(target, visible);\r\n      this.setProcessQueueTimeout();\r\n    });\r\n  }\r\n\r\n  public observe(el: HTMLElement) {\r\n    this.intersector.observe(el);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { fontFamily } from \"../../components/middleEllipsis\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { CancellablePromise, deferredPromise } from \"../../helpers/cancellablePromise\";\r\nimport { tsNow } from \"../../helpers/date\";\r\nimport { deepEqual } from \"../../helpers/object\";\r\nimport { convertInputKeyToKey } from \"../../helpers/string\";\r\nimport { isMobile } from \"../../helpers/userAgent\";\r\nimport { InputNotifyPeer, InputPeerNotifySettings, NotifyPeer, PeerNotifySettings, Update } from \"../../layer\";\r\nimport I18n from \"../langPack\";\r\nimport apiManager from \"../mtproto/mtprotoworker\";\r\nimport webPushApiManager, { PushSubscriptionNotify } from \"../mtproto/webPushApiManager\";\r\nimport rootScope from \"../rootScope\";\r\nimport stateStorage from \"../stateStorage\";\r\nimport apiUpdatesManager from \"./apiUpdatesManager\";\r\nimport appChatsManager from \"./appChatsManager\";\r\nimport appPeersManager from \"./appPeersManager\";\r\nimport appRuntimeManager from \"./appRuntimeManager\";\r\nimport appStateManager from \"./appStateManager\";\r\nimport appUsersManager from \"./appUsersManager\";\r\n\r\ntype MyNotification = Notification & {\r\n  hidden?: boolean,\r\n  show?: () => void,\r\n};\r\n\r\nexport type NotifyOptions = Partial<{\r\n  tag: string;\r\n  image: string;\r\n  key: string;\r\n  title: string;\r\n  message: string;\r\n  silent: boolean;\r\n  onclick: () => void;\r\n}>;\r\n\r\nexport type NotificationSettings = {\r\n  nodesktop: boolean,\r\n  volume: number,\r\n  novibrate: boolean,\r\n  nopreview: boolean,\r\n  nopush: boolean,\r\n  nosound: boolean\r\n};\r\n\r\ntype ImSadAboutIt = Promise<PeerNotifySettings> | PeerNotifySettings;\r\nexport class AppNotificationsManager {\r\n  private notificationsUiSupport: boolean;\r\n  private notificationsShown: {[key: string]: MyNotification} = {};\r\n  private notificationIndex = 0;\r\n  private notificationsCount = 0;\r\n  private soundsPlayed: {[tag: string]: number} = {};\r\n  private vibrateSupport = !!navigator.vibrate;\r\n  private nextSoundAt: number;\r\n  private prevSoundVolume: number;\r\n  private peerSettings = {\r\n    notifyPeer: {} as {[peerId: number]: ImSadAboutIt},\r\n    notifyUsers: null as ImSadAboutIt,\r\n    notifyChats: null as ImSadAboutIt,\r\n    notifyBroadcasts: null as ImSadAboutIt\r\n  };\r\n  //private exceptions: {[peerId: string]: PeerNotifySettings} = {};\r\n  private notifyContactsSignUp: Promise<boolean>;\r\n  private faviconEl: HTMLLinkElement = document.head.querySelector('link[rel=\"icon\"]');\r\n\r\n  private titleBackup = document.title;\r\n  private titleChanged = false;\r\n  private titleInterval: number;\r\n  private prevFavicon: string;\r\n  private stopped = false;\r\n\r\n  private settings: NotificationSettings = {} as any;\r\n\r\n  private registeredDevice: any;\r\n  private pushInited = false;\r\n\r\n  private topMessagesDeferred: CancellablePromise<void>;\r\n\r\n  private notifySoundEl: HTMLElement;\r\n\r\n  private getNotifyPeerTypePromise: Promise<any>;\r\n\r\n  constructor() {\r\n    // @ts-ignore\r\n    navigator.vibrate = navigator.vibrate || navigator.mozVibrate || navigator.webkitVibrate;\r\n\r\n    this.notificationsUiSupport = ('Notification' in window) || ('mozNotification' in navigator);\r\n\r\n    this.topMessagesDeferred = deferredPromise<void>();\r\n\r\n    this.notifySoundEl = document.createElement('div');\r\n    this.notifySoundEl.id = 'notify-sound';\r\n    document.body.append(this.notifySoundEl);\r\n\r\n    rootScope.addEventListener('instance_deactivated', () => {\r\n      this.stop();\r\n    });\r\n\r\n    rootScope.addEventListener('instance_activated', () => {\r\n      if(this.stopped) {\r\n        this.start();\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('idle', (newVal) => {\r\n      if(this.stopped) {\r\n        return;\r\n      }\r\n\r\n      if(!newVal) {\r\n        this.clear();\r\n      }\r\n\r\n      this.toggleToggler();\r\n    });\r\n\r\n    rootScope.addMultipleEventsListeners({\r\n      updateNotifySettings: (update) => {\r\n        this.savePeerSettings(update.peer._ === 'notifyPeer' ? appPeersManager.getPeerId(update.peer.peer) : update.peer._, update.notify_settings);\r\n        rootScope.dispatchEvent('notify_settings', update);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('push_init', (tokenData) => {\r\n      this.pushInited = true;\r\n      if(!this.settings.nodesktop && !this.settings.nopush) {\r\n        if(tokenData) {\r\n          this.registerDevice(tokenData);\r\n        } else {\r\n          webPushApiManager.subscribe();\r\n        }\r\n      } else {\r\n        this.unregisterDevice(tokenData);\r\n      }\r\n    });\r\n    rootScope.addEventListener('push_subscribe', (tokenData) => {\r\n      this.registerDevice(tokenData);\r\n    });\r\n    rootScope.addEventListener('push_unsubscribe', (tokenData) => {\r\n      this.unregisterDevice(tokenData);\r\n    });\r\n\r\n    rootScope.addEventListener('dialogs_multiupdate', () => {\r\n      //unregisterTopMsgs()\r\n      this.topMessagesDeferred.resolve();\r\n    }, true);\r\n\r\n    rootScope.addEventListener('push_notification_click', (notificationData) => {\r\n      if(notificationData.action === 'push_settings') {\r\n        /* this.topMessagesDeferred.then(() => {\r\n          $modal.open({\r\n            templateUrl: templateUrl('settings_modal'),\r\n            controller: 'SettingsModalController',\r\n            windowClass: 'settings_modal_window mobile_modal',\r\n            backdrop: 'single'\r\n          })\r\n        }); */\r\n        return;\r\n      }\r\n\r\n      if(notificationData.action === 'mute1d') {\r\n        apiManager.invokeApi('account.updateDeviceLocked', {\r\n          period: 86400\r\n        }).then(() => {\r\n          // var toastData = toaster.pop({\r\n          //   type: 'info',\r\n          //   body: _('push_action_mute1d_success'),\r\n          //   bodyOutputType: 'trustedHtml',\r\n          //   clickHandler: () => {\r\n          //     toaster.clear(toastData)\r\n          //   },\r\n          //   showCloseButton: false\r\n          // })\r\n        });\r\n\r\n        return;\r\n      }\r\n\r\n      const peerId = notificationData.custom && +notificationData.custom.peerId;\r\n      console.log('click', notificationData, peerId);\r\n      if(peerId) {\r\n        this.topMessagesDeferred.then(() => {\r\n          if(notificationData.custom.channel_id &&\r\n              !appChatsManager.hasChat(+notificationData.custom.channel_id)) {\r\n            return;\r\n          }\r\n\r\n          if(peerId > 0 && !appUsersManager.hasUser(peerId)) {\r\n            return;\r\n          }\r\n\r\n          rootScope.dispatchEvent('history_focus', {\r\n            peerId,\r\n            mid: +notificationData.custom.msg_id\r\n          });\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  private toggleToggler(enable = rootScope.idle.isIDLE) {\r\n    if(isMobile) return;\r\n\r\n    const resetTitle = () => {\r\n      this.titleChanged = false;\r\n      document.title = this.titleBackup;\r\n      this.setFavicon();\r\n    };\r\n\r\n    window.clearInterval(this.titleInterval);\r\n    this.titleInterval = 0;\r\n\r\n    if(!enable) {\r\n      resetTitle();\r\n    } else {\r\n      this.titleInterval = window.setInterval(() => {\r\n        if(!this.notificationsCount) {\r\n          this.toggleToggler(false);\r\n        } else if(this.titleChanged) {\r\n          resetTitle();\r\n        } else {\r\n          this.titleChanged = true;\r\n          document.title = I18n.format('Notifications.Count', true, [this.notificationsCount]);\r\n          //this.setFavicon('assets/img/favicon_unread.ico');\r\n\r\n          // fetch('assets/img/favicon.ico')\r\n          // .then(res => res.blob())\r\n          // .then(blob => {\r\n            // const img = document.createElement('img');\r\n            // img.src = URL.createObjectURL(blob);\r\n\r\n            const canvas = document.createElement('canvas');\r\n            canvas.width = 32 * window.devicePixelRatio;\r\n            canvas.height = canvas.width;\r\n  \r\n            const ctx = canvas.getContext('2d');\r\n            ctx.beginPath();\r\n            ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2, 0, 2 * Math.PI, false);\r\n            ctx.fillStyle = '#3390ec';\r\n            ctx.fill();\r\n\r\n            let fontSize = 24;\r\n            let str = '' + this.notificationsCount;\r\n            if(this.notificationsCount < 10) {\r\n              fontSize = 22;\r\n            } else if(this.notificationsCount < 100) {\r\n              fontSize = 20;\r\n            } else {\r\n              str = '99+';\r\n              fontSize = 16;\r\n            }\r\n\r\n            fontSize *= window.devicePixelRatio;\r\n            \r\n            ctx.font = `700 ${fontSize}px ${fontFamily}`;\r\n            ctx.textBaseline = 'middle';\r\n            ctx.textAlign = 'center';\r\n            ctx.fillStyle = 'white';\r\n            ctx.fillText(str, canvas.width / 2, canvas.height * .5625);\r\n\r\n            /* const ctx = canvas.getContext('2d');\r\n            ctx.drawImage(img, 0, 0, canvas.width, canvas.height); */\r\n  \r\n            this.setFavicon(canvas.toDataURL());\r\n          // });\r\n        }\r\n      }, 1000);\r\n    }\r\n  }\r\n\r\n  public updateLocalSettings = () => {\r\n    Promise.all(['notify_nodesktop', 'notify_volume', 'notify_novibrate', 'notify_nopreview', 'notify_nopush'].map(k => stateStorage.get(k as any)))\r\n    .then((updSettings) => {\r\n      this.settings.nodesktop = updSettings[0];\r\n      this.settings.volume = updSettings[1] === undefined ? 0.5 : updSettings[1];\r\n      this.settings.novibrate = updSettings[2];\r\n      this.settings.nopreview = updSettings[3];\r\n      this.settings.nopush = updSettings[4];\r\n\r\n      if(this.pushInited) {\r\n        const needPush = !this.settings.nopush && !this.settings.nodesktop && webPushApiManager.isAvailable || false;\r\n        const hasPush = this.registeredDevice !== false;\r\n        if(needPush !== hasPush) {\r\n          if(needPush) {\r\n            webPushApiManager.subscribe();\r\n          } else {\r\n            webPushApiManager.unsubscribe();\r\n          }\r\n        }\r\n      }\r\n\r\n      webPushApiManager.setSettings(this.settings);\r\n    });\r\n\r\n    appStateManager.getState().then(state => {\r\n      this.settings.nosound = !state.settings.notifications.sound;\r\n    });\r\n  }\r\n\r\n  public getLocalSettings() {\r\n    return this.settings;\r\n  }\r\n\r\n  public getNotifySettings(peer: InputNotifyPeer): ImSadAboutIt {\r\n    let key: any = convertInputKeyToKey(peer._);\r\n    let obj: any = this.peerSettings[key as NotifyPeer['_']];\r\n\r\n    if(peer._ === 'inputNotifyPeer') {\r\n      key = appPeersManager.getPeerId(peer.peer);\r\n      obj = obj[key];\r\n    }\r\n\r\n    if(obj) {\r\n      return obj;\r\n    }\r\n\r\n    return (obj || this.peerSettings)[key] = apiManager.invokeApi('account.getNotifySettings', {peer})\r\n    .then(settings => {\r\n      this.savePeerSettings(key, settings);\r\n      return settings;\r\n    });\r\n  }\r\n\r\n  public getNotifyPeerTypeSettings() {\r\n    if(this.getNotifyPeerTypePromise) return this.getNotifyPeerTypePromise;\r\n\r\n    const promises = (['inputNotifyBroadcasts', 'inputNotifyUsers', 'inputNotifyChats'] as Exclude<InputNotifyPeer['_'], 'inputNotifyPeer'>[])\r\n    .map((inputKey) => {\r\n      return this.getNotifySettings({_: inputKey});\r\n    });\r\n\r\n    return this.getNotifyPeerTypePromise = Promise.all(promises);\r\n  }\r\n\r\n  public updateNotifySettings(peer: InputNotifyPeer, settings: InputPeerNotifySettings) {\r\n    //this.savePeerSettings(peerId, settings);\r\n\r\n    /* const inputSettings: InputPeerNotifySettings = copy(settings) as any;\r\n    inputSettings._ = 'inputPeerNotifySettings'; */\r\n\r\n    return apiManager.invokeApi('account.updateNotifySettings', {\r\n      peer,\r\n      settings\r\n    }).then(value => {\r\n      if(value) {\r\n        apiUpdatesManager.processUpdateMessage({\r\n          _: 'updateShort',\r\n          update: {\r\n            _: 'updateNotifySettings', \r\n            peer: {\r\n              ...peer,\r\n              _: convertInputKeyToKey(peer._)\r\n            }, \r\n            notify_settings: { // ! WOW, IT WORKS !\r\n              ...settings,\r\n              _: 'peerNotifySettings',\r\n            }\r\n          } as Update.updateNotifySettings\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  public getNotifyExceptions() {\r\n    apiManager.invokeApi('account.getNotifyExceptions', {compare_sound: true})\r\n    .then((updates) => {\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n    });\r\n  }\r\n\r\n  public getContactSignUpNotification() {\r\n    if(this.notifyContactsSignUp) return this.notifyContactsSignUp;\r\n    return this.notifyContactsSignUp = apiManager.invokeApi('account.getContactSignUpNotification');\r\n  }\r\n\r\n  public setContactSignUpNotification(silent: boolean) {\r\n    apiManager.invokeApi('account.setContactSignUpNotification', {silent})\r\n    .then(value => {\r\n      this.notifyContactsSignUp = Promise.resolve(!silent);\r\n    });\r\n  }\r\n\r\n  private setFavicon(href: string = 'assets/img/favicon.ico') {\r\n    if(this.prevFavicon === href) {\r\n      return;\r\n    }\r\n\r\n    const link = this.faviconEl.cloneNode() as HTMLLinkElement;\r\n    link.href = href;\r\n    this.faviconEl.parentNode.replaceChild(link, this.faviconEl);\r\n    this.faviconEl = link;\r\n\r\n    this.prevFavicon = href;\r\n  }\r\n\r\n  public savePeerSettings(key: number | Exclude<NotifyPeer['_'], 'notifyPeer'>, settings: PeerNotifySettings) {\r\n    let obj: any;\r\n    if(typeof(key) === 'number') {\r\n      obj = this.peerSettings['notifyPeer'];\r\n    }\r\n    \r\n    (obj || this.peerSettings)[key] = settings;\r\n\r\n    if(typeof(key) !== 'number') {\r\n      rootScope.dispatchEvent('notify_peer_type_settings', {key, settings});\r\n    }\r\n\r\n    //rootScope.broadcast('notify_settings', {peerId: peerId});\r\n  }\r\n\r\n  public isMuted(peerNotifySettings: PeerNotifySettings) {\r\n    return peerNotifySettings._ === 'peerNotifySettings' &&\r\n      ((peerNotifySettings.mute_until * 1000) > tsNow() || peerNotifySettings.silent);\r\n  }\r\n\r\n  public getPeerMuted(peerId: number) {\r\n    const ret = this.getNotifySettings({_: 'inputNotifyPeer', peer: appPeersManager.getInputPeerById(peerId)});\r\n    return (ret instanceof Promise ? ret : Promise.resolve(ret))\r\n    .then((peerNotifySettings) => this.isMuted(peerNotifySettings));\r\n  }\r\n\r\n  public getPeerLocalSettings(peerId: number, respectType = true): PeerNotifySettings {\r\n    const n: PeerNotifySettings = {\r\n      _: 'peerNotifySettings'\r\n    };\r\n\r\n    const notifySettings = this.peerSettings['notifyPeer'][peerId];\r\n    //if(!notifySettings || (notifySettings instanceof Promise)) return false;\r\n    if(notifySettings && !(notifySettings instanceof Promise)) {\r\n      Object.assign(n, notifySettings);\r\n    }\r\n\r\n    if(respectType) {\r\n      const inputNotify = appPeersManager.getInputNotifyPeerById(peerId, true);\r\n      const key = convertInputKeyToKey(inputNotify._);\r\n      const typeNotifySettings = this.peerSettings[key as NotifyPeer['_']];\r\n      if(typeNotifySettings && !(typeNotifySettings instanceof Promise)) {\r\n        for(let i in typeNotifySettings) {\r\n          // @ts-ignore\r\n          if(n[i] === undefined) {\r\n            // @ts-ignore\r\n            n[i] = typeNotifySettings[i];\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return n;\r\n  }\r\n\r\n  public isPeerLocalMuted(peerId: number, respectType = true) {\r\n    if(peerId === rootScope.myId) return false;\r\n\r\n    const notifySettings = this.getPeerLocalSettings(peerId, respectType);\r\n    return this.isMuted(notifySettings);\r\n  }\r\n\r\n  public start() {\r\n    this.updateLocalSettings();\r\n    rootScope.addEventListener('settings_updated', this.updateLocalSettings);\r\n    webPushApiManager.start();\r\n\r\n    if(!this.notificationsUiSupport) {\r\n      return false;\r\n    }\r\n\r\n    if('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {\r\n      window.addEventListener('click', this.requestPermission);\r\n    }\r\n\r\n    try {\r\n      if('onbeforeunload' in window) {\r\n        window.addEventListener('beforeunload', this.clear);\r\n      }\r\n    } catch (e) {}\r\n  }\r\n\r\n  private stop() {\r\n    this.clear();\r\n    window.clearInterval(this.titleInterval);\r\n    this.titleInterval = 0;\r\n    this.setFavicon();\r\n    this.stopped = true;\r\n  }\r\n\r\n  private requestPermission = () => {\r\n    Notification.requestPermission();\r\n    window.removeEventListener('click', this.requestPermission);\r\n  };\r\n\r\n  public notify(data: NotifyOptions) {\r\n    //console.log('notify', data, rootScope.idle.isIDLE, this.notificationsUiSupport, this.stopped);\r\n    \r\n    if(this.stopped) {\r\n      return;\r\n    }\r\n\r\n    // FFOS Notification blob src bug workaround\r\n    /* if(Config.Navigator.ffos && !Config.Navigator.ffos2p) {\r\n      data.image = 'https://telegram.org/img/t_logo.png'\r\n    }\r\n    else if (data.image && !angular.isString(data.image)) {\r\n      if (Config.Navigator.ffos2p) {\r\n        FileManager.getDataUrl(data.image, 'image/jpeg').then(function (url) {\r\n          data.image = url\r\n          notify(data)\r\n        })\r\n        return false\r\n      } else {\r\n        data.image = FileManager.getUrl(data.image, 'image/jpeg')\r\n      }\r\n    }\r\n    else */ if(!data.image) {\r\n      data.image = 'assets/img/logo_filled_rounded.png';\r\n    }\r\n    // console.log('notify image', data.image)\r\n\r\n    this.notificationsCount++;\r\n    if(!this.titleInterval) {\r\n      this.toggleToggler();\r\n    }\r\n\r\n    const now = tsNow();\r\n    if(this.settings.volume > 0 && !this.settings.nosound/* &&\r\n      (\r\n        !data.tag ||\r\n        !this.soundsPlayed[data.tag] ||\r\n        now > this.soundsPlayed[data.tag] + 60000\r\n      ) */\r\n    ) {\r\n      this.testSound(this.settings.volume);\r\n      this.soundsPlayed[data.tag] = now;\r\n    }\r\n\r\n    if(!this.notificationsUiSupport ||\r\n      'Notification' in window && Notification.permission !== 'granted') {\r\n      return false;\r\n    }\r\n\r\n    if(this.settings.nodesktop) {\r\n      if(this.vibrateSupport && !this.settings.novibrate) {\r\n        navigator.vibrate([200, 100, 200]);\r\n        return;\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const idx = ++this.notificationIndex;\r\n    const key = data.key || 'k' + idx;\r\n    let notification: MyNotification;\r\n\r\n    if('Notification' in window) {\r\n      try {\r\n        if(data.tag) {\r\n          for(let i in this.notificationsShown) {\r\n            const notification = this.notificationsShown[i];\r\n            if(notification &&\r\n                notification.tag === data.tag) {\r\n              notification.hidden = true;\r\n            }\r\n          }\r\n        }\r\n\r\n        notification = new Notification(data.title, {\r\n          icon: data.image || '',\r\n          body: data.message || '',\r\n          tag: data.tag || '',\r\n          silent: data.silent || false\r\n        });\r\n\r\n        //console.log('notify constructed notification');\r\n      } catch(e) {\r\n        this.notificationsUiSupport = false;\r\n        webPushApiManager.setLocalNotificationsDisabled();\r\n        return;\r\n      }\r\n    } /* else if('mozNotification' in navigator) {\r\n      notification = navigator.mozNotification.createNotification(data.title, data.message || '', data.image || '')\r\n    } else if(notificationsMsSiteMode) {\r\n      window.external.msSiteModeClearIconOverlay()\r\n      window.external.msSiteModeSetIconOverlay('img/icons/icon16.png', data.title)\r\n      window.external.msSiteModeActivate()\r\n      notification = {\r\n        index: idx\r\n      }\r\n    } */ else {\r\n      return;\r\n    }\r\n\r\n    notification.onclick = () => {\r\n      notification.close();\r\n      appRuntimeManager.focus();\r\n      this.clear();\r\n      if(data.onclick) {\r\n        data.onclick();\r\n      }\r\n    };\r\n\r\n    notification.onclose = () => {\r\n      if(!notification.hidden) {\r\n        delete this.notificationsShown[key];\r\n        this.clear();\r\n      }\r\n    };\r\n\r\n    if(notification.show) {\r\n      notification.show();\r\n    }\r\n    this.notificationsShown[key] = notification;\r\n\r\n    if(!isMobile) {\r\n      setTimeout(() => {\r\n        this.hide(key);\r\n      }, 8000);\r\n    }\r\n  }\r\n\r\n  public testSound(volume: number) {\r\n    const now = tsNow();\r\n    if(this.nextSoundAt && now < this.nextSoundAt && this.prevSoundVolume === volume) {\r\n      return;\r\n    }\r\n\r\n    this.nextSoundAt = now + 1000;\r\n    this.prevSoundVolume = volume;\r\n    const filename = 'assets/audio/notification.mp3';\r\n    const audio = document.createElement('audio');\r\n    audio.autoplay = true;\r\n    audio.setAttribute('mozaudiochannel', 'notification');\r\n    audio.volume = volume;\r\n    audio.innerHTML = `\r\n      <source src=\"${filename}\" type=\"audio/mpeg\" />\r\n      <embed hidden=\"true\" autostart=\"true\" loop=\"false\" volume=\"${volume * 100}\" src=\"${filename}\" />\r\n    `;\r\n    this.notifySoundEl.append(audio);\r\n\r\n    audio.addEventListener('ended', () => {\r\n      audio.remove();\r\n    }, {once: true});\r\n  }\r\n\r\n  public cancel(key: string) {\r\n    const notification = this.notificationsShown[key];\r\n    if(notification) {\r\n      if(this.notificationsCount > 0) {\r\n        this.notificationsCount--;\r\n      }\r\n\r\n      try {\r\n        if(notification.close) {\r\n          notification.hidden = true;\r\n          notification.close();\r\n        }/*  else if(notificationsMsSiteMode &&\r\n          notification.index === notificationIndex) {\r\n          window.external.msSiteModeClearIconOverlay()\r\n        } */\r\n      } catch (e) {}\r\n\r\n      delete this.notificationsShown[key];\r\n    }\r\n  }\r\n\r\n  private hide(key: string) {\r\n    const notification = this.notificationsShown[key];\r\n    if(notification) {\r\n      try {\r\n        if(notification.close) {\r\n          notification.hidden = true;\r\n          notification.close();\r\n        }\r\n      } catch (e) {}\r\n    }\r\n  }\r\n\r\n  public soundReset(tag: string) {\r\n    delete this.soundsPlayed[tag];\r\n  }\r\n\r\n  public clear() {\r\n    /* if(notificationsMsSiteMode) {\r\n      window.external.msSiteModeClearIconOverlay()\r\n    } else { */\r\n      for(let i in this.notificationsShown) {\r\n        const notification = this.notificationsShown[i];\r\n        try {\r\n          if(notification.close) {\r\n            notification.close();\r\n          }\r\n        } catch (e) {}\r\n      }\r\n    /* } */\r\n    this.notificationsShown = {};\r\n    this.notificationsCount = 0;\r\n\r\n    webPushApiManager.hidePushNotifications();\r\n  }\r\n\r\n  private registerDevice(tokenData: PushSubscriptionNotify) {\r\n    if(this.registeredDevice && deepEqual(this.registeredDevice, tokenData)) {\r\n      return false;\r\n    }\r\n\r\n    apiManager.invokeApi('account.registerDevice', {\r\n      token_type: tokenData.tokenType,\r\n      token: tokenData.tokenValue,\r\n      other_uids: [],\r\n      app_sandbox: false,\r\n      secret: new Uint8Array()\r\n    }).then(() => {\r\n      this.registeredDevice = tokenData;\r\n    }, (error) => {\r\n      error.handled = true;\r\n    });\r\n  }\r\n\r\n  private unregisterDevice(tokenData: PushSubscriptionNotify) {\r\n    if(!this.registeredDevice) {\r\n      return false;\r\n    }\r\n\r\n    apiManager.invokeApi('account.unregisterDevice', {\r\n      token_type: tokenData.tokenType,\r\n      token: tokenData.tokenValue,\r\n      other_uids: []\r\n    }).then(() => {\r\n      this.registeredDevice = false;\r\n    }, (error) => {\r\n      error.handled = true;\r\n    });\r\n  }\r\n\r\n  public getVibrateSupport() {\r\n    return this.vibrateSupport\r\n  }\r\n}\r\n\r\nconst appNotificationsManager = new AppNotificationsManager();\r\nMOUNT_CLASS_TO.appNotificationsManager = appNotificationsManager;\r\nexport default appNotificationsManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nconst SetTransition = (element: HTMLElement, className: string, forwards: boolean, duration: number, onTransitionEnd?: () => void) => {\r\n  const timeout = element.dataset.timeout;\r\n  if(timeout !== undefined) {\r\n    clearTimeout(+timeout);\r\n  }\r\n\r\n  if(forwards && className) {\r\n    element.classList.add(className);\r\n  }\r\n\r\n  const afterTimeout = () => {\r\n    delete element.dataset.timeout;\r\n    if(!forwards && className) {\r\n      element.classList.remove('backwards', className);\r\n    }\r\n\r\n    element.classList.remove('animating');\r\n    \r\n    onTransitionEnd && onTransitionEnd();\r\n  };\r\n\r\n  if(!rootScope.settings.animationsEnabled) {\r\n    element.classList.remove('animating', 'backwards');\r\n    afterTimeout();\r\n    return;\r\n  }\r\n\r\n  element.classList.add('animating');\r\n\r\n  element.classList.toggle('backwards', !forwards);\r\n  element.dataset.timeout = '' + setTimeout(afterTimeout, duration);\r\n};\r\n\r\nexport default SetTransition;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { makeMediaSize } from \"./mediaSizes\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\n\r\nexport default function calcImageInBox(imageW: number, imageH: number, boxW: number, boxH: number, noZoom = true) {\r\n  if(imageW < boxW && imageH < boxH && noZoom) {\r\n    return makeMediaSize(imageW, imageH);\r\n  }\r\n\r\n  let boxedImageW = boxW;\r\n  let boxedImageH = boxH;\r\n\r\n  if((imageW / imageH) > (boxW / boxH)) {\r\n    boxedImageH = (imageH * boxW / imageW) | 0;\r\n  } else {\r\n    boxedImageW = (imageW * boxH / imageH) | 0;\r\n    if(boxedImageW > boxW) {\r\n      boxedImageH = (boxedImageH * boxW / boxedImageW) | 0;\r\n      boxedImageW = boxW;\r\n    }\r\n  }\r\n\r\n  // if (Config.Navigator.retina) {\r\n  //   imageW = Math.floor(imageW / 2)\r\n  //   imageH = Math.floor(imageH / 2)\r\n  // }\r\n\r\n  if(noZoom && boxedImageW >= imageW && boxedImageH >= imageH) {\r\n    boxedImageW = imageW;\r\n    boxedImageH = imageH;\r\n  }\r\n\r\n  return makeMediaSize(boxedImageW, boxedImageH);\r\n}\r\n\r\nMOUNT_CLASS_TO.calcImageInBox = calcImageInBox;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { LangPackKey, i18n } from \"../lib/langPack\";\r\n\r\nexport default class LoginPage {\r\n  public element: HTMLElement;\r\n  public container: HTMLElement;\r\n  public imageDiv: HTMLElement;\r\n  public inputWrapper: HTMLElement;\r\n  public title: HTMLElement;\r\n  public subtitle: HTMLParagraphElement;\r\n\r\n  constructor(options: {\r\n    className: string,\r\n    withInputWrapper?: boolean,\r\n    titleLangKey?: LangPackKey,\r\n    subtitleLangKey?: LangPackKey,\r\n  }) {\r\n    this.element = document.body.querySelector('.' + options.className) as HTMLDivElement;\r\n    //this.element = document.createElement('div');\r\n    //this.element.className = 'page-' + options.className;\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.className = 'container center-align';\r\n\r\n    this.imageDiv = document.createElement('div');\r\n    this.imageDiv.className = 'auth-image';\r\n\r\n    this.title = document.createElement('h4');\r\n    if(options.titleLangKey) {\r\n      this.title.append(i18n(options.titleLangKey));\r\n    }\r\n\r\n    this.subtitle = document.createElement('p');\r\n    this.subtitle.className = 'subtitle';\r\n    if(options.subtitleLangKey) {\r\n      this.subtitle.append(i18n(options.subtitleLangKey));\r\n    }\r\n    \r\n    this.container.append(this.imageDiv, this.title, this.subtitle);\r\n\r\n    if(options.withInputWrapper) {\r\n      this.inputWrapper = document.createElement('div');\r\n      this.inputWrapper.className = 'input-wrapper';\r\n      this.container.append(this.inputWrapper);\r\n    }\r\n\r\n    this.element.append(this.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { RequestFilePartTask, RequestFilePartTaskResponse } from \"../serviceWorker/index.service\";\r\nimport type { ApiError } from \"./apiManager\";\r\nimport appMessagesManager from \"../appManagers/appMessagesManager\";\r\nimport { Photo } from \"../../layer\";\r\nimport { bytesToHex } from \"../../helpers/bytes\";\r\nimport { deepEqual } from \"../../helpers/object\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport apiManager from \"./mtprotoworker\";\r\n\r\nexport type ReferenceContext = ReferenceContext.referenceContextProfilePhoto | ReferenceContext.referenceContextMessage;\r\nexport namespace ReferenceContext {\r\n  export type referenceContextProfilePhoto = {\r\n    type: 'profilePhoto',\r\n    peerId: number\r\n  };\r\n\r\n  export type referenceContextMessage = {\r\n    type: 'message',\r\n    peerId: number,\r\n    messageId: number\r\n  };\r\n}\r\n\r\nexport type ReferenceBytes = Photo.photo['file_reference'];\r\nexport type ReferenceContexts = Set<ReferenceContext>;\r\n\r\n//type ReferenceBytes = Uint8Array;\r\n\r\nclass ReferenceDatabase {\r\n  private contexts: Map<ReferenceBytes, ReferenceContexts> = new Map();\r\n  //private references: Map<ReferenceBytes, number[]> = new Map();\r\n  private links: {[hex: string]: ReferenceBytes} = {};\r\n\r\n  constructor() {\r\n    apiManager.addTaskListener('requestFilePart', (task: RequestFilePartTaskResponse) => {\r\n      if(task.error) {\r\n        const onError = (error: ApiError) => {\r\n          if(error?.type === 'FILE_REFERENCE_EXPIRED') {\r\n            // @ts-ignore\r\n            const bytes = task.originalPayload[1].file_reference;\r\n            referenceDatabase.refreshReference(bytes).then(() => {\r\n              // @ts-ignore\r\n              task.originalPayload[1].file_reference = referenceDatabase.getReferenceByLink(bytes);\r\n              const newTask: RequestFilePartTask = {\r\n                type: task.type,\r\n                id: task.id,\r\n                payload: task.originalPayload\r\n              };\r\n\r\n              apiManager.postMessage(newTask);\r\n            }).catch(onError);\r\n          } else {\r\n            navigator.serviceWorker.controller.postMessage(task);\r\n          }\r\n        };\r\n\r\n        onError(task.error);\r\n      } else {\r\n        navigator.serviceWorker.controller.postMessage(task);\r\n      }\r\n    });\r\n  }\r\n\r\n  public saveContext(reference: ReferenceBytes, context: ReferenceContext, contexts?: ReferenceContexts) {\r\n    [contexts, reference] = this.getContexts(reference);\r\n    if(!contexts) {\r\n      contexts = new Set();\r\n      this.contexts.set(reference, contexts);\r\n      this.links[bytesToHex(reference)] = reference;\r\n    }\r\n\r\n    for(const _context of contexts) {\r\n      if(deepEqual(_context, context)) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    contexts.add(context);\r\n  }\r\n\r\n  public getReferenceByLink(reference: ReferenceBytes) {\r\n    return this.links[bytesToHex(reference)];\r\n  }\r\n\r\n  public getContexts(reference: ReferenceBytes): [ReferenceContexts, ReferenceBytes] {\r\n    const contexts = this.contexts.get(reference) || (reference = this.getReferenceByLink(reference) || reference, this.contexts.get(reference));\r\n    return [contexts, reference];\r\n  }\r\n\r\n  public getContext(reference: ReferenceBytes): [ReferenceContext, ReferenceBytes] {\r\n    const contexts = this.getContexts(reference);\r\n    return contexts ? [contexts[0].values().next().value, contexts[1]] : undefined;\r\n  }\r\n\r\n  public deleteContext(reference: ReferenceBytes, context: ReferenceContext, contexts?: ReferenceContexts) {\r\n    [contexts, reference] = this.getContexts(reference);\r\n    if(contexts) {\r\n      for(const _context of contexts) {\r\n        if(deepEqual(_context, context)) {\r\n          contexts.delete(_context);\r\n          if(!contexts.size) {\r\n            this.contexts.delete(reference);\r\n            delete this.links[bytesToHex(reference)];\r\n          }\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public refreshReference(reference: ReferenceBytes, context?: ReferenceContext): Promise<void> {\r\n    [context, reference] = this.getContext(reference);\r\n    switch(context?.type) {\r\n      case 'message': {\r\n        return appMessagesManager.wrapSingleMessage(context.peerId, context.messageId, true);\r\n        // .then(() => {\r\n        //   console.log('FILE_REFERENCE_EXPIRED: got message', context, appMessagesManager.getMessage((context as ReferenceContext.referenceContextMessage).messageId).media, reference);\r\n        // });\r\n      }\r\n\r\n      default: {\r\n        console.warn('FILE_REFERENCE_EXPIRED: not implemented context', context);\r\n        return Promise.reject();\r\n      }\r\n    }\r\n  }\r\n\r\n  /* handleReferenceError = (reference: ReferenceBytes, error: ApiError) => {\r\n    switch(error.type) {\r\n      case 'FILE_REFERENCE_EXPIRED': {\r\n        return this.refreshReference(reference);\r\n      }\r\n\r\n      default:\r\n        return Promise.reject(error);\r\n    }\r\n  }; */\r\n\r\n  /* public replaceReference(oldReference: ReferenceBytes, newReference: ReferenceBytes) {\r\n    const contexts = this.contexts.get(oldReference);\r\n    if(contexts) {\r\n      this.contexts.delete(oldReference);\r\n      this.contexts.set(newReference, contexts);\r\n    }\r\n  } */\r\n}\r\n\r\nconst referenceDatabase = new ReferenceDatabase();\r\nMOUNT_CLASS_TO.referenceDatabase = referenceDatabase;\r\nexport default referenceDatabase;","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport { safeAssign } from \"../helpers/object\";\r\nimport { cancelEvent } from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport isInDOM from \"../helpers/dom/isInDOM\";\r\n\r\nconst TRANSITION_TIME = 200;\r\n\r\nexport default class ProgressivePreloader {\r\n  public preloader: HTMLDivElement;\r\n  private circle: SVGCircleElement;\r\n  private cancelSvg: SVGSVGElement;\r\n  private downloadSvg: HTMLElement;\r\n  \r\n  private tempId = 0;\r\n  private detached = true;\r\n\r\n  public promise: CancellablePromise<any> = null;\r\n\r\n  public isUpload = false;\r\n  private cancelable = true;\r\n  private streamable = false;\r\n  private tryAgainOnFail = true;\r\n  private attachMethod: 'append' | 'prepend' = 'append';\r\n\r\n  public loadFunc: () => {download: CancellablePromise<any>};\r\n\r\n  private totalLength: number;\r\n\r\n  constructor(options?: Partial<{\r\n    isUpload: ProgressivePreloader['isUpload'],\r\n    cancelable: ProgressivePreloader['cancelable'], \r\n    streamable: ProgressivePreloader['streamable'], \r\n    tryAgainOnFail: ProgressivePreloader['tryAgainOnFail'],\r\n    attachMethod: ProgressivePreloader['attachMethod']\r\n  }>) {\r\n    if(options) {\r\n      safeAssign(this, options);\r\n    }\r\n  }\r\n\r\n  public constructContainer(options: Partial<{\r\n    color: 'transparent',\r\n    bold: boolean\r\n  }> = {}) {\r\n    if(!this.preloader) {\r\n      this.preloader = document.createElement('div');\r\n      this.preloader.classList.add('preloader-container');\r\n\r\n      if(options.color) {\r\n        this.preloader.classList.add('preloader-' + options.color);\r\n      }\r\n\r\n      if(options.bold) {\r\n        this.preloader.classList.add('preloader-bold');\r\n      }\r\n  \r\n      if(this.streamable) {\r\n        this.preloader.classList.add('preloader-streamable');\r\n      }\r\n    }\r\n  }\r\n\r\n  public constructDownloadIcon() {\r\n    this.constructContainer();\r\n  }\r\n\r\n  public construct() {\r\n    this.construct = null;\r\n\r\n    this.constructContainer();\r\n    \r\n    this.preloader.innerHTML = `\r\n    <div class=\"you-spin-me-round\">\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-circular\" viewBox=\"${this.streamable ? '25 25 50 50' : '27 27 54 54'}\">\r\n    <circle class=\"preloader-path-new\" cx=\"${this.streamable ? '50' : '54'}\" cy=\"${this.streamable ? '50' : '54'}\" r=\"${this.streamable ? 19 : 24}\" fill=\"none\" stroke-miterlimit=\"10\"/>\r\n    </svg>\r\n    </div>`;\r\n\r\n    if(this.cancelable) {\r\n      this.preloader.innerHTML += `\r\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-close\" viewBox=\"0 0 24 24\">\r\n        <g fill=\"none\" fill-rule=\"evenodd\">\r\n          <polygon points=\"0 0 24 0 24 24 0 24\"/>\r\n          <path fill=\"#000\" fill-rule=\"nonzero\" d=\"M5.20970461,5.38710056 L5.29289322,5.29289322 C5.65337718,4.93240926 6.22060824,4.90467972 6.61289944,5.20970461 L6.70710678,5.29289322 L12,10.585 L17.2928932,5.29289322 C17.6834175,4.90236893 18.3165825,4.90236893 18.7071068,5.29289322 C19.0976311,5.68341751 19.0976311,6.31658249 18.7071068,6.70710678 L13.415,12 L18.7071068,17.2928932 C19.0675907,17.6533772 19.0953203,18.2206082 18.7902954,18.6128994 L18.7071068,18.7071068 C18.3466228,19.0675907 17.7793918,19.0953203 17.3871006,18.7902954 L17.2928932,18.7071068 L12,13.415 L6.70710678,18.7071068 C6.31658249,19.0976311 5.68341751,19.0976311 5.29289322,18.7071068 C4.90236893,18.3165825 4.90236893,17.6834175 5.29289322,17.2928932 L10.585,12 L5.29289322,6.70710678 C4.93240926,6.34662282 4.90467972,5.77939176 5.20970461,5.38710056 L5.29289322,5.29289322 L5.20970461,5.38710056 Z\"/>\r\n        </g>\r\n      </svg>\r\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-download\" viewBox=\"0 0 24 24\">\r\n        <g fill=\"none\" fill-rule=\"evenodd\">\r\n          <polygon points=\"0 0 24 0 24 24 0 24\"/>\r\n          <path fill=\"#000\" fill-rule=\"nonzero\" d=\"M5,19 L19,19 C19.5522847,19 20,19.4477153 20,20 C20,20.5128358 19.6139598,20.9355072 19.1166211,20.9932723 L19,21 L5,21 C4.44771525,21 4,20.5522847 4,20 C4,19.4871642 4.38604019,19.0644928 4.88337887,19.0067277 L5,19 L19,19 L5,19 Z M11.8833789,3.00672773 L12,3 C12.5128358,3 12.9355072,3.38604019 12.9932723,3.88337887 L13,4 L13,13.585 L16.2928932,10.2928932 C16.6533772,9.93240926 17.2206082,9.90467972 17.6128994,10.2097046 L17.7071068,10.2928932 C18.0675907,10.6533772 18.0953203,11.2206082 17.7902954,11.6128994 L17.7071068,11.7071068 L12.7071068,16.7071068 C12.3466228,17.0675907 11.7793918,17.0953203 11.3871006,16.7902954 L11.2928932,16.7071068 L6.29289322,11.7071068 C5.90236893,11.3165825 5.90236893,10.6834175 6.29289322,10.2928932 C6.65337718,9.93240926 7.22060824,9.90467972 7.61289944,10.2097046 L7.70710678,10.2928932 L11,13.585 L11,4 C11,3.48716416 11.3860402,3.06449284 11.8833789,3.00672773 L12,3 L11.8833789,3.00672773 Z\"/>\r\n        </g>\r\n      </svg>`;\r\n\r\n      this.downloadSvg = this.preloader.lastElementChild as HTMLElement;\r\n      this.cancelSvg = this.downloadSvg.previousElementSibling as any;\r\n    } else {\r\n      this.preloader.classList.add('preloader-swing');\r\n    }\r\n    \r\n    this.circle = this.preloader.firstElementChild.firstElementChild.firstElementChild as SVGCircleElement;\r\n\r\n    if(this.cancelable) {\r\n      attachClickEvent(this.preloader, this.onClick);\r\n    }\r\n  }\r\n\r\n  public onClick = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(this.preloader.classList.contains('manual')) {\r\n      if(this.loadFunc) {\r\n        this.loadFunc();\r\n      }\r\n    } else {\r\n      if(this.promise && this.promise.cancel) {\r\n        this.promise.cancel();\r\n      }\r\n    }\r\n  };\r\n\r\n  public setDownloadFunction(func: ProgressivePreloader['loadFunc']) {\r\n    this.loadFunc = func;\r\n  }\r\n\r\n  public setManual() {\r\n    this.preloader.classList.add('manual');\r\n    this.setProgress(0);\r\n  }\r\n\r\n  public attachPromise(promise: CancellablePromise<any>) {\r\n    if(this.isUpload && this.promise) return;\r\n\r\n    this.promise = promise;\r\n\r\n    const tempId = --this.tempId;\r\n    const startTime = Date.now();\r\n\r\n    const onEnd = (err: Error) => {\r\n      promise.notify = null;\r\n\r\n      if(tempId !== this.tempId) {\r\n        return;\r\n      }\r\n\r\n      const elapsedTime = Date.now() - startTime;\r\n\r\n      //console.log('[PP]: end', this.detached, performance.now());\r\n\r\n      if(!err && this.cancelable) {\r\n        this.setProgress(100);\r\n\r\n        const delay = TRANSITION_TIME * 0.75;\r\n\r\n        if(elapsedTime < delay) {\r\n          this.detach();\r\n        } else {\r\n          setTimeout(() => { // * wait for transition complete\r\n            if(tempId === this.tempId) {\r\n              this.detach();\r\n            }\r\n          }, delay);\r\n        }\r\n      } else {\r\n        if(this.tryAgainOnFail) {\r\n          SetTransition(this.preloader, '', true, TRANSITION_TIME);\r\n          fastRaf(() => {\r\n            this.setManual();\r\n          });\r\n        } else {\r\n          this.detach();\r\n        }\r\n      }\r\n      \r\n      this.promise = promise = null;\r\n    };\r\n    \r\n    promise\r\n    .then(() => onEnd(null))\r\n    .catch((err) => onEnd(err));\r\n\r\n    if(promise.addNotifyListener) {\r\n      promise.addNotifyListener((details: {done: number, total: number}) => {\r\n        /* if(details.done >= details.total) {\r\n          onEnd();\r\n        } */\r\n\r\n        if(tempId !== this.tempId) return;\r\n\r\n        //console.log('preloader download', promise, details);\r\n        const percents = details.done / details.total * 100;\r\n        this.setProgress(percents);\r\n      });\r\n    }\r\n  }\r\n\r\n  public attach(elem: Element, reset = false, promise?: CancellablePromise<any>) {\r\n    if(promise/*  && false */) {\r\n      this.attachPromise(promise);\r\n    }\r\n\r\n    //return;\r\n\r\n    this.detached = false;\r\n    /* fastRaf(() => {\r\n      if(this.detached) return;\r\n      this.detached = false; */\r\n\r\n      if(this.construct) {\r\n        this.construct();\r\n      }\r\n\r\n      if(this.preloader.parentElement) {\r\n        this.preloader.classList.remove('manual');\r\n      }\r\n\r\n      if(this.preloader.parentElement !== elem) {\r\n        elem[this.attachMethod](this.preloader);\r\n      }\r\n\r\n      fastRaf(() => {\r\n        //console.log('[PP]: attach after rAF', this.detached, performance.now());\r\n\r\n        if(this.detached) {\r\n          return;\r\n        }\r\n\r\n        SetTransition(this.preloader, 'is-visible', true, TRANSITION_TIME);\r\n      });\r\n\r\n      if(this.cancelable && reset) {\r\n        this.setProgress(0);\r\n      }\r\n    //});\r\n  }\r\n  \r\n  public detach() {\r\n    //return;\r\n\r\n    this.detached = true;\r\n\r\n    //return;\r\n    \r\n    if(this.preloader && this.preloader.parentElement) {\r\n      /* setTimeout(() =>  *///fastRaf(() => {\r\n        /* if(!this.detached) return;\r\n        this.detached = true; */\r\n\r\n        fastRaf(() => {\r\n          //console.log('[PP]: detach after rAF', this.detached, performance.now());\r\n\r\n          if(!this.detached || !this.preloader.parentElement) {\r\n            return;\r\n          }\r\n\r\n          SetTransition(this.preloader, 'is-visible', false, TRANSITION_TIME, () => {\r\n            this.preloader.remove();\r\n          });\r\n        });\r\n      //})/* , 5e3) */;\r\n    }\r\n  }\r\n  \r\n  public setProgress(percents: number) {\r\n    if(!isInDOM(this.circle)) {\r\n      return;\r\n    }\r\n    \r\n    if(percents === 0) {\r\n      this.circle.style.strokeDasharray = '';\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      if(!this.totalLength) {\r\n        this.totalLength = this.circle.getTotalLength();\r\n      }\r\n\r\n      //console.log('setProgress', (percents / 100 * totalLength));\r\n      this.circle.style.strokeDasharray = '' + Math.max(5, percents / 100 * this.totalLength) + ', ' + this.totalLength;\r\n    } catch(err) {}\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { InputFileLocation, InputStickerSet } from \"../layer\";\r\nimport type { DownloadOptions } from \"../lib/mtproto/apiFileManager\";\r\n\r\nconst FILENAME_JOINER = '_';\r\n\r\nexport function getFileNameByLocation(location: InputFileLocation, options?: Partial<{\r\n  fileName: string\r\n}>) {\r\n  const fileName = '';//(options?.fileName || '').split('.');\r\n  const ext = fileName[fileName.length - 1] || '';\r\n\r\n  let str: string;\r\n  switch(location._) {\r\n    case 'inputPhotoFileLocation': {\r\n      str = ['photo', fileName[0], location.id, location.thumb_size].filter(Boolean).join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputDocumentFileLocation': {\r\n      str = ['document', fileName[0], location.id, location.thumb_size].filter(Boolean).join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputPeerPhotoFileLocation':\r\n      str = ['peerPhoto', location.photo_id, location.pFlags.big ? 'big' : 'small'].join(FILENAME_JOINER);\r\n      break;\r\n    \r\n    case 'inputStickerSetThumb': {\r\n      const id = (location.stickerset as InputStickerSet.inputStickerSetID).id || \r\n        (location.stickerset as InputStickerSet.inputStickerSetShortName).short_name || \r\n        (location.stickerset as InputStickerSet.inputStickerSetDice).emoticon || \r\n        location.stickerset._;\r\n      str = ['stickerSetThumb', id, location.thumb_version].join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputFileLocation': {\r\n      str = location.volume_id + '_' + location.local_id;\r\n      break;\r\n    }\r\n\r\n    default: {\r\n      console.error('Unrecognized location:', location);\r\n      str = '';\r\n      break;\r\n    }\r\n  }\r\n\r\n  return str + (ext ? '.' + ext : ext);\r\n}\r\n\r\nexport type FileURLType = 'photo' | 'thumb' | 'document' | 'stream' | 'download';\r\nexport function getFileURL(type: FileURLType, options: DownloadOptions) {\r\n  //console.log('getFileURL', location);\r\n  //const perf = performance.now();\r\n  const encoded = encodeURIComponent(JSON.stringify(options));\r\n  //console.log('getFileURL encode:', performance.now() - perf, encoded);\r\n\r\n  return '/' + type + '/' + encoded;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { blobConstruct } from \"../helpers/blob\";\r\n\r\nexport class FileManager {\r\n  public blobSupported = true;\r\n  \r\n  constructor() {\r\n    try {\r\n      blobConstruct([], '');\r\n    } catch(e) {\r\n      this.blobSupported = false;\r\n    }\r\n  }\r\n  \r\n  public isAvailable() {\r\n    return this.blobSupported;\r\n  }\r\n  \r\n  public write(fileWriter: ReturnType<FileManager['getFakeFileWriter']>, bytes: Uint8Array | Blob | string): Promise<void> {\r\n    if(bytes instanceof Blob) { // is file bytes\r\n      return new Promise((resolve, reject) => {\r\n        let fileReader = new FileReader();\r\n        fileReader.onload = function(event) {\r\n          let arrayBuffer = event.target.result as ArrayBuffer;\r\n          \r\n          let arr = new Uint8Array(arrayBuffer);\r\n          \r\n          fileWriter.write(arr).then(resolve, reject);\r\n        };\r\n        \r\n        fileReader.readAsArrayBuffer(bytes);\r\n      });\r\n    } else {\r\n      return fileWriter.write(bytes);\r\n    }\r\n  }\r\n\r\n  public getFakeFileWriter(mimeType: string, saveFileCallback?: (blob: Blob) => Promise<Blob>) {\r\n    const blobParts: Array<Uint8Array | string> = [];\r\n    const fakeFileWriter = {\r\n      write: async(part: Uint8Array | string) => {\r\n        if(!this.blobSupported) {\r\n          throw false;\r\n        }\r\n        \r\n        blobParts.push(part);\r\n      },\r\n      truncate: () => {\r\n        blobParts.length = 0;\r\n      },\r\n      finalize: (saveToStorage = true) => {\r\n        const blob = blobConstruct(blobParts, mimeType);\r\n\r\n        if(saveToStorage && saveFileCallback) {\r\n          saveFileCallback(blob);\r\n        }\r\n        \r\n        return blob;\r\n      }\r\n    };\r\n    \r\n    return fakeFileWriter;\r\n  }\r\n}\r\n\r\nexport default new FileManager();\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Modes from '../config/modes';\r\nimport { blobConstruct } from '../helpers/blob';\r\nimport FileManager from './filemanager';\r\n//import { MOUNT_CLASS_TO } from './mtproto/mtproto_config';\r\n//import { logger } from './polyfill';\r\n\r\nexport default class CacheStorageController {\r\n  private static STORAGES: CacheStorageController[] = [];\r\n  //public dbName = 'cachedFiles';\r\n  private openDbPromise: Promise<Cache>;\r\n\r\n  private useStorage = true;\r\n\r\n  //private log: ReturnType<typeof logger> = logger('CS');\r\n\r\n  constructor(private dbName: string) {\r\n    if(Modes.test) {\r\n      this.dbName += '_test';\r\n    }\r\n\r\n    if(CacheStorageController.STORAGES.length) {\r\n      this.useStorage = CacheStorageController.STORAGES[0].useStorage;\r\n    }\r\n    \r\n    this.openDatabase();\r\n    CacheStorageController.STORAGES.push(this);\r\n  }\r\n\r\n  private openDatabase(): Promise<Cache> {\r\n    if(this.openDbPromise) {\r\n      return this.openDbPromise;\r\n    }\r\n\r\n    return this.openDbPromise = caches.open(this.dbName);\r\n  }\r\n\r\n  public delete(entryName: string) {\r\n    return this.timeoutOperation((cache) => {\r\n      return cache.delete('/' + entryName);\r\n    });\r\n  }\r\n\r\n  public deleteAll() {\r\n    return caches.delete(this.dbName);\r\n  }\r\n\r\n  public save(entryName: string, response: Response) {\r\n    if(!this.useStorage) return Promise.reject('STORAGE_OFFLINE');\r\n\r\n    return this.timeoutOperation((cache) => {\r\n      return cache.put('/' + entryName, response);\r\n    });\r\n  }\r\n\r\n  public saveFile(fileName: string, blob: Blob | Uint8Array) {\r\n    if(!this.useStorage) return Promise.reject('STORAGE_OFFLINE');\r\n\r\n    //return Promise.resolve(blobConstruct([blob]));\r\n    if(!(blob instanceof Blob)) {\r\n      blob = blobConstruct(blob) as Blob;\r\n    }\r\n\r\n    const response = new Response(blob, {\r\n      headers: {\r\n        'Content-Length': '' + blob.size\r\n      }\r\n    });\r\n    \r\n    return this.save(fileName, response).then(() => {\r\n      return blob as Blob;\r\n    });\r\n  }\r\n\r\n  /* public getBlobSize(blob: any) {\r\n    return blob.size || blob.byteLength || blob.length;\r\n  } */\r\n\r\n  public getFile(fileName: string, method: 'blob' | 'json' | 'text' = 'blob'): Promise<any> {\r\n    if(!this.useStorage) return Promise.reject('STORAGE_OFFLINE');\r\n\r\n    /* if(method === 'blob') {\r\n      return Promise.reject();\r\n    } */\r\n\r\n    // const str = `get fileName: ${fileName}`;\r\n    // console.time(str);\r\n    return this.timeoutOperation(async(cache) => {\r\n      const response = await cache.match('/' + fileName);\r\n\r\n      if(!response || !cache) {\r\n        //console.warn('getFile:', response, fileName);\r\n        throw 'NO_ENTRY_FOUND';\r\n      }\r\n   \r\n      const promise = response[method]();\r\n      // promise.then(() => {\r\n      //   console.timeEnd(str);\r\n      // });\r\n      return promise;\r\n    });\r\n  }\r\n\r\n  private timeoutOperation<T>(callback: (cache: Cache) => Promise<T>) {\r\n    return new Promise<T>(async(resolve, reject) => {\r\n      let rejected = false;\r\n      const timeout = setTimeout(() => {\r\n        reject();\r\n        //console.warn('CACHESTORAGE TIMEOUT');\r\n        rejected = true;\r\n      }, 15e3);\r\n\r\n      try {\r\n        const cache = await this.openDatabase();\r\n        if(!cache) {\r\n          throw 'no cache?';\r\n        }\r\n\r\n        const res = await callback(cache);\r\n\r\n        if(rejected) return;\r\n        resolve(res);\r\n      } catch(err) {\r\n        reject(err);\r\n      }\r\n\r\n      clearTimeout(timeout);\r\n    });\r\n  }\r\n\r\n  public getFileWriter(fileName: string, mimeType: string) {\r\n    const fakeWriter = FileManager.getFakeFileWriter(mimeType, (blob) => {\r\n      return this.saveFile(fileName, blob).catch(() => blob);\r\n    });\r\n\r\n    return Promise.resolve(fakeWriter);\r\n  }\r\n\r\n  public static toggleStorage(enabled: boolean) {\r\n    return Promise.all(this.STORAGES.map(storage => {\r\n      storage.useStorage = enabled;\r\n      \r\n      if(!enabled) {\r\n        return storage.deleteAll();\r\n      }\r\n    }));\r\n  }\r\n}\r\n\r\n//const cacheStorage = new CacheStorageController(); \r\n//MOUNT_CLASS_TO.cacheStorage = cacheStorage;\r\n//export default cacheStorage;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { TransitionSlider } from \"./transition\";\r\nimport { ScrollableX } from \"./scrollable\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport { FocusDirection } from \"../helpers/fastSmoothScroll\";\r\nimport findUpAsChild from \"../helpers/dom/findUpAsChild\";\r\nimport whichChild from \"../helpers/dom/whichChild\";\r\n\r\nexport function horizontalMenu(tabs: HTMLElement, content: HTMLElement, onClick?: (id: number, tabContent: HTMLDivElement, animate: boolean) => void | boolean, onTransitionEnd?: () => void, transitionTime = 250, scrollableX?: ScrollableX) {\r\n  const selectTab = TransitionSlider(content, tabs || content.dataset.animation === 'tabs' ? 'tabs' : 'navigation', transitionTime, onTransitionEnd);\r\n\r\n  if(tabs) {\r\n    const proxy = new Proxy(selectTab, {\r\n      apply: (target, that, args) => {\r\n        const id = +args[0];\r\n        const animate = args[1] !== undefined ? args[1] : true;\r\n  \r\n        const el = (tabs.querySelector(`[data-tab=\"${id}\"]`) || tabs.children[id]) as HTMLElement;\r\n        selectTarget(el, id, animate);\r\n      }\r\n    });\r\n\r\n    const selectTarget = (target: HTMLElement, id: number, animate = true) => {\r\n      const tabContent = content.children[id] as HTMLDivElement;\r\n\r\n      if(onClick) {\r\n        const canChange = onClick(id, tabContent, animate);\r\n        if(canChange !== undefined && !canChange) {\r\n          return;\r\n        }\r\n      }\r\n\r\n      if(scrollableX) {\r\n        scrollableX.scrollIntoViewNew(target.parentElement.children[id] as HTMLElement, 'center', undefined, undefined, animate ? undefined : FocusDirection.Static, transitionTime, 'x');\r\n      }\r\n\r\n      if(!rootScope.settings.animationsEnabled) {\r\n        animate = false;\r\n      }\r\n\r\n      const prevId = selectTab.prevId();\r\n      if(target.classList.contains('active') || id === prevId) {\r\n        return false;\r\n      }\r\n      \r\n      const prev = tabs.querySelector(tagName.toLowerCase() + '.active') as HTMLElement;\r\n\r\n      fastRaf(() => {\r\n        prev && prev.classList.remove('active');\r\n      });\r\n      \r\n      // stripe from ZINCHUK\r\n      if(useStripe && prevId !== -1 && animate) {\r\n        fastRaf(() => {\r\n          const indicator = target.querySelector('i')!;\r\n          const currentIndicator = target.parentElement.children[prevId].querySelector('i')!;\r\n    \r\n          currentIndicator.classList.remove('animate');\r\n          indicator.classList.remove('animate');\r\n    \r\n          // We move and resize our indicator so it repeats the position and size of the previous one.\r\n          const shiftLeft = currentIndicator.parentElement.parentElement.offsetLeft - indicator.parentElement.parentElement.offsetLeft;\r\n          const scaleFactor = currentIndicator.clientWidth / indicator.clientWidth;\r\n          indicator.style.transform = `translate3d(${shiftLeft}px, 0, 0) scale3d(${scaleFactor}, 1, 1)`;\r\n  \r\n          //console.log(`translate3d(${shiftLeft}px, 0, 0) scale3d(${scaleFactor}, 1, 1)`);\r\n    \r\n          requestAnimationFrame(() => {\r\n            // Now we remove the transform to let it animate to its own position and size.\r\n            indicator.classList.add('animate');\r\n            indicator.style.transform = 'none';\r\n          });\r\n        });\r\n      }\r\n      // stripe END\r\n\r\n      fastRaf(() => {\r\n        target.classList.add('active');\r\n      });\r\n      \r\n      selectTab(id, animate);\r\n    };\r\n\r\n    const useStripe = !tabs.classList.contains('no-stripe');\r\n\r\n    //const tagName = tabs.classList.contains('menu-horizontal-div') ? 'BUTTON' : 'LI';\r\n    const tagName = tabs.firstElementChild.tagName;\r\n    tabs.addEventListener('click', function(e) {\r\n      let target = e.target as HTMLElement;\r\n      \r\n      target = findUpAsChild(target, tabs);\r\n      \r\n      //console.log('tabs click:', target);\r\n      \r\n      if(!target) return false;\r\n\r\n      let id: number;\r\n      if(target.dataset.tab) {\r\n        id = +target.dataset.tab;\r\n        if(id === -1) {\r\n          return false;\r\n        }\r\n      } else {\r\n        id = whichChild(target);\r\n      }\r\n\r\n      selectTarget(target, id);\r\n    });\r\n\r\n    return proxy;\r\n  }\r\n  \r\n  return selectTab;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { CancellablePromise, deferredPromise } from \"../helpers/cancellablePromise\";\r\nimport { dispatchHeavyAnimationEvent } from \"../hooks/useHeavyAnimationCheck\";\r\nimport whichChild from \"../helpers/dom/whichChild\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport { isSafari } from \"../helpers/userAgent\";\r\n\r\nfunction slideNavigation(tabContent: HTMLElement, prevTabContent: HTMLElement, toRight: boolean) {\r\n  const width = prevTabContent.getBoundingClientRect().width;\r\n  const elements = [tabContent, prevTabContent];\r\n  if(toRight) elements.reverse();\r\n  elements[0].style.filter = `brightness(80%)`;\r\n  elements[0].style.transform = `translate3d(${-width * .25}px, 0, 0)`;\r\n  elements[1].style.transform = `translate3d(${width}px, 0, 0)`;\r\n  \r\n  tabContent.classList.add('active');\r\n  void tabContent.offsetWidth; // reflow\r\n\r\n  tabContent.style.transform = '';\r\n  tabContent.style.filter = '';\r\n\r\n  return () => {\r\n    prevTabContent.style.transform = prevTabContent.style.filter = '';\r\n  };\r\n}\r\n\r\nfunction slideTabs(tabContent: HTMLElement, prevTabContent: HTMLElement, toRight: boolean) {\r\n  // Jolly Cobra's // Workaround for scrollable content flickering during animation.\r\n  const scrollableContainer = findUpClassName(tabContent, 'scrollable-y');\r\n  if(scrollableContainer && scrollableContainer.style.overflowY !== 'hidden') {\r\n    // const scrollBarWidth = scrollableContainer.offsetWidth - scrollableContainer.clientWidth;\r\n    scrollableContainer.style.overflowY = 'hidden';\r\n    // scrollableContainer.style.paddingRight = `${scrollBarWidth}px`;\r\n    // this.container.classList.add('sliding');\r\n  }\r\n\r\n  //window.requestAnimationFrame(() => {\r\n    const width = prevTabContent.getBoundingClientRect().width;\r\n    /* tabContent.style.setProperty('--width', width + 'px');\r\n    prevTabContent.style.setProperty('--width', width + 'px');\r\n\r\n    tabContent.classList.add('active'); */\r\n    //void tabContent.offsetWidth; // reflow\r\n    const elements = [tabContent, prevTabContent];\r\n    if(toRight) elements.reverse();\r\n    elements[0].style.transform = `translate3d(${-width}px, 0, 0)`;\r\n    elements[1].style.transform = `translate3d(${width}px, 0, 0)`;\r\n  \r\n    tabContent.classList.add('active');\r\n    void tabContent.offsetWidth; // reflow\r\n  \r\n    tabContent.style.transform = '';\r\n  //});\r\n  \r\n  return () => {\r\n    prevTabContent.style.transform = '';\r\n\r\n    if(scrollableContainer) {\r\n      // Jolly Cobra's // Workaround for scrollable content flickering during animation.\r\n      if(isSafari) { // ! safari doesn't respect sticky header, so it flicks when overflow is changing\r\n        scrollableContainer.style.display = 'none';\r\n      }\r\n\r\n      scrollableContainer.style.overflowY = '';\r\n\r\n      if(isSafari) {\r\n        void scrollableContainer.offsetLeft; // reflow\r\n        scrollableContainer.style.display = '';\r\n      }\r\n\r\n      // scrollableContainer.style.paddingRight = '0';\r\n      // this.container.classList.remove('sliding');\r\n    }\r\n  };\r\n}\r\n\r\nexport const TransitionSlider = (content: HTMLElement, type: 'tabs' | 'navigation' | 'zoom-fade' | 'slide-fade' | 'none'/*  | 'counter' */, transitionTime: number, onTransitionEnd?: (id: number) => void, isHeavy = true) => {\r\n  let animationFunction: TransitionFunction = null;\r\n\r\n  switch(type) {\r\n    case 'tabs':\r\n      animationFunction = slideTabs;\r\n      break;\r\n    case 'navigation':\r\n      animationFunction = slideNavigation;\r\n      break;\r\n    /* default:\r\n      break; */\r\n  }\r\n\r\n  content.dataset.animation = type;\r\n  \r\n  return Transition(content, animationFunction, transitionTime, onTransitionEnd, isHeavy);\r\n};\r\n\r\ntype TransitionFunction = (tabContent: HTMLElement, prevTabContent: HTMLElement, toRight: boolean) => void | (() => void);\r\n\r\nconst Transition = (content: HTMLElement, animationFunction: TransitionFunction, transitionTime: number, onTransitionEnd?: (id: number) => void, isHeavy = true) => {\r\n  const onTransitionEndCallbacks: Map<HTMLElement, Function> = new Map();\r\n  let animationDeferred: CancellablePromise<void>;\r\n  let animationStarted = 0;\r\n  let from: HTMLElement = null;\r\n\r\n  // TODO: check for transition type (transform, etc) using by animationFunction\r\n  content.addEventListener(animationFunction ? 'transitionend' : 'animationend', (e) => {\r\n    if((e.target as HTMLElement).parentElement !== content) {\r\n      return;\r\n    }\r\n    \r\n    //console.log('Transition: transitionend', /* content, */ e, selectTab.prevId, performance.now() - animationStarted);\r\n\r\n    const callback = onTransitionEndCallbacks.get(e.target as HTMLElement);\r\n    if(callback) callback();\r\n\r\n    if(e.target !== from) {\r\n      return;\r\n    }\r\n\r\n    if(!animationDeferred && isHeavy) return;\r\n\r\n    if(animationDeferred) {\r\n      animationDeferred.resolve();\r\n      animationDeferred = undefined;\r\n    }\r\n\r\n    if(onTransitionEnd) {\r\n      onTransitionEnd(selectTab.prevId());\r\n    }\r\n\r\n    content.classList.remove('animating', 'backwards', 'disable-hover');\r\n  });\r\n\r\n  function selectTab(id: number | HTMLElement, animate = true) {\r\n    const self = selectTab;\r\n\r\n    if(id instanceof HTMLElement) {\r\n      id = whichChild(id);\r\n    }\r\n    \r\n    const prevId = self.prevId();\r\n    if(id === prevId) return false;\r\n\r\n    //console.log('selectTab id:', id);\r\n\r\n    const _from = from;\r\n    const to = content.children[id] as HTMLElement;\r\n\r\n    if(!rootScope.settings.animationsEnabled || prevId === -1) {\r\n      animate = false;\r\n    }\r\n\r\n    if(!animate) {\r\n      if(_from) _from.classList.remove('active', 'to', 'from');  \r\n      if(to) {\r\n        to.classList.remove('to', 'from');\r\n        to.classList.add('active');\r\n      }\r\n\r\n      content.classList.remove('animating', 'backwards', 'disable-hover');\r\n\r\n      from = to;\r\n\r\n      if(onTransitionEnd) onTransitionEnd(id);\r\n      return;\r\n    }\r\n\r\n    if(from) {\r\n      from.classList.remove('to');\r\n      from.classList.add('from');\r\n    }\r\n\r\n    content.classList.add('animating', 'disable-hover');\r\n    const toRight = prevId < id;\r\n    content.classList.toggle('backwards', !toRight);\r\n\r\n    let onTransitionEndCallback: ReturnType<TransitionFunction>;\r\n    if(!to) {\r\n      //prevTabContent.classList.remove('active');\r\n    } else {\r\n      if(animationFunction) {\r\n        onTransitionEndCallback = animationFunction(to, from, toRight);\r\n      } else {\r\n        to.classList.add('active');\r\n      }\r\n\r\n      to.classList.remove('from');\r\n      to.classList.add('to');\r\n    }\r\n    \r\n    if(to) {\r\n      onTransitionEndCallbacks.set(to, () => {\r\n        to.classList.remove('to');\r\n        onTransitionEndCallbacks.delete(to);\r\n      });\r\n    }\r\n\r\n    if(_from/*  && false */) {\r\n      const callback = () => {\r\n        _from.classList.remove('active', 'from');\r\n\r\n        if(onTransitionEndCallback) {\r\n          onTransitionEndCallback();\r\n        }\r\n\r\n        onTransitionEndCallbacks.delete(_from);\r\n      };\r\n\r\n      if(to) {\r\n        onTransitionEndCallbacks.set(_from, callback);\r\n      } else {\r\n        const timeout = window.setTimeout(callback, transitionTime);\r\n        onTransitionEndCallbacks.set(_from, () => {\r\n          clearTimeout(timeout);\r\n        });\r\n      }\r\n\r\n      if(isHeavy) {\r\n        if(!animationDeferred) {\r\n          animationDeferred = deferredPromise<void>();\r\n          animationStarted = performance.now();\r\n        }\r\n  \r\n        dispatchHeavyAnimationEvent(animationDeferred, transitionTime * 2);\r\n      }\r\n    }\r\n    \r\n    from = to;\r\n  }\r\n\r\n  //selectTab.prevId = -1;\r\n  selectTab.prevId = () => from ? whichChild(from) : -1;\r\n  \r\n  return selectTab;\r\n};\r\n\r\nexport default Transition;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { pause } from \"./schedulers\";\r\nimport { isAppleMobile } from \"./userAgent\";\r\n\r\nexport function preloadVideo(url: string): Promise<HTMLVideoElement> {\r\n  return new Promise((resolve, reject) => {\r\n    const video = document.createElement('video');\r\n    video.volume = 0;\r\n    video.onloadedmetadata = () => resolve(video);\r\n    video.onerror = reject;\r\n    video.src = url;\r\n  });\r\n}\r\n\r\nexport function createPosterFromVideo(video: HTMLVideoElement): Promise<Blob> {\r\n  return new Promise((resolve, reject) => {\r\n    video.onseeked = () => {\r\n      const canvas = document.createElement('canvas');\r\n      canvas.width = Math.min(1280, video.videoWidth);\r\n      canvas.height = Math.min(720, video.videoHeight);\r\n      const ctx = canvas.getContext('2d')!;\r\n      ctx.drawImage(video, 0, 0);\r\n      canvas.toBlob(blob => {\r\n        resolve(blob);\r\n      }, 'image/jpeg', 1);\r\n    };\r\n\r\n    video.onerror = reject;\r\n    video.currentTime = Math.min(video.duration, 1);\r\n  });\r\n}\r\n\r\nexport async function createPosterForVideo(url: string): Promise<Blob | undefined> {\r\n  const video = await preloadVideo(url);\r\n\r\n  return Promise.race([\r\n    pause(2000) as Promise<undefined>,\r\n    createPosterFromVideo(video),\r\n  ]);\r\n}\r\n\r\nexport function onVideoLoad(video: HTMLVideoElement) {\r\n  return new Promise<void>((resolve) => {\r\n    if(video.readyState >= video.HAVE_METADATA) {\r\n      resolve();\r\n      return;\r\n    }\r\n\r\n    video.addEventListener(isAppleMobile ? 'loadeddata' : 'canplay', () => resolve(), {once: true});\r\n  });\r\n}\r\n\r\nexport async function getFilesFromEvent(e: ClipboardEvent | DragEvent, onlyTypes = false): Promise<any[]> {\r\n  const files: any[] = [];\r\n\r\n  const scanFiles = async(entry: any, item: DataTransferItem) => {\r\n    if(entry.isDirectory) {\r\n      const directoryReader = entry.createReader();\r\n      await new Promise<void>((resolve, reject) => {\r\n        directoryReader.readEntries(async(entries: any) => {\r\n          for(const entry of entries) {\r\n            await scanFiles(entry, item);\r\n          }\r\n\r\n          resolve();\r\n        });\r\n      });\r\n    } else if(entry) {\r\n      if(onlyTypes) {\r\n        files.push(entry.type);\r\n      } else {\r\n        const itemFile = item.getAsFile(); // * Safari can't handle entry.file with pasting\r\n        const file = entry instanceof File ? \r\n          entry : \r\n          (\r\n            entry instanceof DataTransferItem ? \r\n              entry.getAsFile() : \r\n              await new Promise((resolve, reject) => entry.file(resolve, (err: any) => resolve(itemFile)))\r\n          );\r\n\r\n        /* if(!onlyTypes) {\r\n          console.log('getFilesFromEvent: got file', item, file);\r\n        } */\r\n\r\n        if(!file) return;\r\n        files.push(file);\r\n      }\r\n    }\r\n  };\r\n\r\n  if(e instanceof DragEvent && e.dataTransfer.files && !e.dataTransfer.items) {\r\n    for(let i = 0; i < e.dataTransfer.files.length; i++) {\r\n      const file = e.dataTransfer.files[i];\r\n      files.push(onlyTypes ? file.type : file);\r\n    }\r\n  } else {\r\n    // @ts-ignore\r\n    const items = (e.dataTransfer || e.clipboardData || e.originalEvent.clipboardData).items;\r\n\r\n    const promises: Promise<any>[] = [];\r\n    for(let i = 0; i < items.length; ++i) {\r\n      const item: DataTransferItem = items[i];\r\n      if(item.kind === 'file') {\r\n        const entry = (onlyTypes ? item : item.webkitGetAsEntry()) || item.getAsFile();\r\n        promises.push(scanFiles(entry, item));\r\n      }\r\n    }\r\n    \r\n    await Promise.all(promises);\r\n  }\r\n\r\n  /* if(!onlyTypes) {\r\n    console.log('getFilesFromEvent: got files:', e, files);\r\n  } */\r\n  \r\n  return files;\r\n}\r\n\r\nexport function requestFile(accept?: string) {\r\n  const input = document.createElement('input');\r\n  input.type = 'file';\r\n  input.style.display = 'none';\r\n\r\n  if(accept) {\r\n    input.accept = accept;\r\n  }\r\n\r\n  document.body.append(input);\r\n\r\n  const promise = new Promise<File>((resolve, reject) => {\r\n    input.addEventListener('change', (e: any) => {\r\n      const file: File = e.target.files[0];\r\n      if(!file) {\r\n        reject('NO_FILE_SELECTED');\r\n        return;\r\n      }\r\n  \r\n      resolve(file);\r\n    }, {once: true});\r\n  }).finally(() => {\r\n    input.remove();\r\n  });\r\n\r\n  input.click();\r\n\r\n  return promise;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// * Jolly Cobra's animation.ts\r\n\r\nimport { fastRaf } from './schedulers';\r\nimport { CancellablePromise, deferredPromise } from './cancellablePromise';\r\n\r\ninterface AnimationInstance {\r\n  isCancelled: boolean;\r\n  deferred: CancellablePromise<void>\r\n}\r\n\r\ntype AnimationInstanceKey = any;\r\nconst instances: Map<AnimationInstanceKey, AnimationInstance> = new Map();\r\n\r\nexport function createAnimationInstance(key: AnimationInstanceKey) {\r\n  cancelAnimationByKey(key);\r\n\r\n  const instance: AnimationInstance = {\r\n    isCancelled: false, \r\n    deferred: deferredPromise<void>()\r\n  };\r\n\r\n  instances.set(key, instance);\r\n  instance.deferred.then(() => {\r\n    instances.delete(key);\r\n  });\r\n\r\n  return instance;\r\n}\r\n\r\nexport function getAnimationInstance(key: AnimationInstanceKey) {\r\n  return instances.get(key);\r\n}\r\n\r\nexport function cancelAnimationByKey(key: AnimationInstanceKey) {\r\n  const instance = getAnimationInstance(key);\r\n  if(instance) {\r\n    instance.isCancelled = true;\r\n    instance.deferred.resolve();\r\n  }\r\n}\r\n\r\nexport function animateSingle(tick: Function, key: AnimationInstanceKey, instance?: AnimationInstance) {\r\n  if(!instance) {\r\n    instance = createAnimationInstance(key);\r\n  }\r\n\r\n  fastRaf(() => {\r\n    if(instance.isCancelled) {\r\n      return;\r\n    }\r\n    \r\n    if(tick()) {\r\n      animateSingle(tick, key, instance);\r\n    } else {\r\n      instance.deferred.resolve();\r\n    }\r\n  });\r\n\r\n  return instance.deferred;\r\n}\r\n\r\nexport function animate(tick: Function) {\r\n  fastRaf(() => {\r\n    if(tick()) {\r\n      animate(tick);\r\n    }\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\n\r\n/**\r\n * Descend sorted storage\r\n */\r\n\r\ntype ItemType = number;\r\n\r\nexport enum SliceEnd {\r\n  None = 0,\r\n  Top = 1,\r\n  Bottom = 2,\r\n  Both = SliceEnd.Top | SliceEnd.Bottom\r\n};\r\n\r\nexport interface Slice extends Array<ItemType> {\r\n  //slicedArray: SlicedArray;\r\n  end: SliceEnd;\r\n\r\n  isEnd: (side: SliceEnd) => boolean;\r\n  setEnd: (side: SliceEnd) => void;\r\n  unsetEnd: (side: SliceEnd) => void;\r\n\r\n  slice: (from?: number, to?: number) => Slice;\r\n  splice: (start: number, deleteCount: number, ...items: ItemType[]) => Slice;\r\n}\r\n\r\nexport interface SliceConstructor {\r\n  new(...items: ItemType[]): Slice;\r\n}\r\n\r\n// TODO: Clear empty arrays after deleting items\r\nexport default class SlicedArray {\r\n  private slices: Slice[]/*  = [[7,6,5],[4,3,2],[1,0,-1]] */;\r\n  private sliceConstructor: SliceConstructor;\r\n  \r\n  constructor() {\r\n    // @ts-ignore\r\n    this.sliceConstructor = SlicedArray.getSliceConstructor(this);\r\n\r\n    const first = this.constructSlice();\r\n    //first.setEnd(SliceEnd.Bottom);\r\n    this.slices = [first];\r\n  }\r\n\r\n  private static getSliceConstructor(slicedArray: SlicedArray) {\r\n    return class Slice extends Array<ItemType> implements Slice {\r\n      //slicedArray: SlicedArray;\r\n      end: SliceEnd = SliceEnd.None;\r\n  \r\n      /* constructor(...items: ItemType[]) {\r\n        super(...items);\r\n        //this.slicedArray = slicedArray;\r\n      } */\r\n  \r\n      isEnd(side: SliceEnd): boolean {\r\n        if((this.end & side) === side) {\r\n          return true;\r\n        }/*  else if(!this.slicedArray) {\r\n          return false;\r\n        } */\r\n  \r\n        let isEnd = false;\r\n        if(side === SliceEnd.Top) {\r\n          const slice = slicedArray.last;\r\n          isEnd = slice.end & side ? this.includes(slice[slice.length - 1])/*  || !slice.length */ : false;\r\n        } else if(side === SliceEnd.Bottom) {\r\n          const slice = slicedArray.first;\r\n          isEnd = slice.end & side ? this.includes(slice[0])/*  || !slice.length */ : false;\r\n        } else if(side === SliceEnd.Both) {\r\n          return this.isEnd(SliceEnd.Top) && this.isEnd(SliceEnd.Bottom);\r\n        }\r\n\r\n        if(isEnd) {\r\n          this.setEnd(side);\r\n        }\r\n  \r\n        return isEnd;\r\n      }\r\n  \r\n      setEnd(side: SliceEnd) {\r\n        this.end |= side;\r\n      }\r\n\r\n      unsetEnd(side: SliceEnd) {\r\n        this.end ^= side;\r\n      }\r\n\r\n      splice(start: number, deleteCount: number, ...items: ItemType[]) {\r\n        const ret = super.splice(start, deleteCount, ...items);\r\n\r\n        if(!this.length) {\r\n          const slices = slicedArray.slices as number[][];\r\n          const idx = slices.indexOf(this);\r\n          if(idx !== -1) {\r\n            if(slices.length === 1) { // left empty slice without ends\r\n              this.unsetEnd(SliceEnd.Both);\r\n            } else { // delete this slice\r\n              slices.splice(idx, 1);\r\n            }\r\n          }\r\n        }\r\n\r\n        return ret;\r\n      }\r\n    }\r\n  }\r\n\r\n  public constructSlice(...items: ItemType[]) {\r\n    //const slice = new Slice(this, ...items);\r\n    // can't pass items directly to constructor because first argument is length\r\n    const slice = new this.sliceConstructor(items.length);\r\n    for(let i = 0, length = items.length; i < length; ++i) {\r\n      slice[i] = items[i];\r\n    }\r\n    return slice;\r\n    \r\n    // ! code below will slow execution in 15 times\r\n    /* const self = this;\r\n    const p: Slice = new Proxy(slice, {\r\n      get: function(target, name: any) {\r\n        if(name === 'constructor') {\r\n          const p = new Proxy(Slice, {\r\n            construct: (target, args) => {\r\n              return self.constructSlice(...args);\r\n            }\r\n          });\r\n\r\n          return p;\r\n        }\r\n\r\n        return target[name];\r\n      }\r\n    });\r\n\r\n    return p; */\r\n\r\n    /*\r\n    var p = slicedArray.constructSlice();\r\n    p.length = 100000;\r\n    p.fill(255);\r\n\r\n    var a = new Array(100000);\r\n    a.fill(255);\r\n\r\n    var b = 0;\r\n    var perf = performance.now();\r\n    for(var i = 0; i < p.length; ++i) {\r\n        b += p[i];\r\n    }\r\n\r\n    console.log('perf 1', performance.now() - perf);\r\n\r\n    b = 0;\r\n    perf = performance.now();\r\n    for(var i = 0; i < a.length; ++i) {\r\n        b += a[i];\r\n    }\r\n\r\n    console.log('perf 2', performance.now() - perf);\r\n    */\r\n  }\r\n\r\n  public insertSlice(slice: ItemType[], flatten = true) {\r\n    if(!slice.length) {\r\n      return;\r\n    }\r\n\r\n    const first = this.slices[0];\r\n    if(!first.length) {\r\n      first.push(...slice);\r\n      return first;\r\n    }\r\n\r\n    const lowerBound = slice[slice.length - 1];\r\n    const upperBound = slice[0];\r\n\r\n    let foundSlice: Slice, lowerIndex = -1, upperIndex = -1, foundSliceIndex = 0;\r\n    for(; foundSliceIndex < this.slices.length; ++foundSliceIndex) {\r\n      foundSlice = this.slices[foundSliceIndex];\r\n      lowerIndex = foundSlice.indexOf(lowerBound);\r\n      upperIndex = foundSlice.indexOf(upperBound);\r\n      \r\n      if(upperIndex !== -1 && -1 !== lowerIndex) {\r\n        break;\r\n      } else if(upperIndex !== -1 || -1 !== lowerIndex) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    if(upperIndex !== -1 && -1 !== lowerIndex) {\r\n\r\n    } else if(upperIndex !== -1) {  // ([1, 2, 3] | [1, 2, 3, 4, 5]) -> [1, 2, 3, 4, 5]\r\n      const sliced = slice.slice(foundSlice.length - upperIndex);\r\n      foundSlice.push(...sliced);\r\n    } else if(lowerIndex !== -1) {  // ([1, 2, 3] | [-1, 0, 1]) -> [-1, 0, 1, 2, 3]\r\n      const sliced = slice.slice(0, slice.length - lowerIndex - 1);\r\n      foundSlice.unshift(...sliced);\r\n    } else {\r\n      let insertIndex = 0;\r\n      for(const length = this.slices.length; insertIndex < length; ++insertIndex) { // * maybe should iterate from the end, could be faster ?\r\n        const s = this.slices[insertIndex];\r\n        if(slice[0] > s[0]) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      this.slices.splice(insertIndex, 0, this.constructSlice(...slice));\r\n      foundSliceIndex = insertIndex;\r\n    }\r\n\r\n    if(flatten) {\r\n      return this.flatten(foundSliceIndex);\r\n    }\r\n  }\r\n\r\n  private flatten(foundSliceIndex: number) {\r\n    if(this.slices.length >= 2) {\r\n      for(let i = 0, length = this.slices.length; i < (length - 1); ++i) {\r\n        const prevSlice = this.slices[i];\r\n        const nextSlice = this.slices[i + 1];\r\n  \r\n        const upperIndex = prevSlice.indexOf(nextSlice[0]);\r\n        if(upperIndex !== -1) {\r\n          prevSlice.setEnd(nextSlice.end);\r\n          this.slices.splice(i + 1, 1);\r\n\r\n          if(i < foundSliceIndex) {\r\n            --foundSliceIndex;\r\n          }\r\n\r\n          --length; // respect array bounds\r\n          --i;      // repeat from the same place\r\n  \r\n          this.insertSlice(nextSlice, false);\r\n        }\r\n      }\r\n    }\r\n\r\n    return this.slices[foundSliceIndex];\r\n  }\r\n\r\n  // * \r\n  \r\n  get first() {\r\n    return this.slices[0];\r\n  }\r\n  \r\n  get last() {\r\n    return this.slices[this.slices.length - 1];\r\n  }\r\n\r\n  get slice() {\r\n    return this.first;\r\n  }\r\n\r\n  get length() {\r\n    return this.slice.length;\r\n  }\r\n\r\n  public findSlice(item: ItemType) {\r\n    for(let i = 0, length = this.slices.length; i < length; ++i) {\r\n      const slice = this.slices[i];\r\n      const index = slice.indexOf(item);\r\n      if(index !== -1) {\r\n        return {slice, index};\r\n      }\r\n    }\r\n    \r\n    return undefined;\r\n  }\r\n\r\n  public findSliceOffset(maxId: number) {\r\n    let slice: Slice;\r\n    for(let i = 0; i < this.slices.length; ++i) {\r\n      let offset = 0;\r\n      slice = this.slices[i];\r\n      if(slice.length < 2) {\r\n        continue;\r\n      }\r\n      \r\n      for(; offset < slice.length; offset++) {\r\n        if(maxId >= slice[offset]) {\r\n          /* if(!offset) { // because can't find 3 in [[5,4], [2,1]]\r\n            return undefined;\r\n          } */\r\n\r\n          return {\r\n            slice, \r\n            offset: maxId === slice[offset] ? offset : offset - 1\r\n          };\r\n        }\r\n      }\r\n    }\r\n\r\n    if(slice && slice.isEnd(SliceEnd.Top)) {\r\n      return {\r\n        slice,\r\n        offset: slice.length\r\n      };\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  // * https://core.telegram.org/api/offsets\r\n  public sliceMe(offsetId: number, add_offset: number, limit: number) {\r\n    let slice = this.slice;\r\n    let offset = 0;\r\n    let sliceOffset = 0;\r\n\r\n    if(offsetId) {\r\n      const pos = this.findSliceOffset(offsetId);\r\n      if(!pos) {\r\n        return undefined;\r\n      }\r\n\r\n      slice = pos.slice;\r\n      offset = sliceOffset = pos.offset;\r\n\r\n      if(slice.includes(offsetId)) {\r\n        sliceOffset += 1;\r\n      }\r\n\r\n      /* if(slice.includes(offsetId) && add_offset < 0) {\r\n        add_offset += 1;\r\n      } */\r\n    }\r\n\r\n    let sliceStart = Math.max(sliceOffset + add_offset, 0);\r\n    let sliceEnd = sliceOffset + add_offset + limit;\r\n    //const fixHalfBackLimit = add_offset && !(limit / add_offset % 2) && (sliceEnd % 2) ? 1 : 0;\r\n    //sliceEnd += fixHalfBackLimit;\r\n\r\n    const sliced = slice.slice(sliceStart, sliceEnd) as Slice;\r\n\r\n    const topWasMeantToLoad = add_offset < 0 ? limit + add_offset : limit;\r\n    const bottomWasMeantToLoad = Math.abs(add_offset);\r\n\r\n    // can use 'slice' here to check because if it's end, then 'sliced' is out of 'slice'\r\n    // useful when there is only 1 message in chat on its reopening\r\n    const topFulfilled = (slice.length - sliceOffset) >= topWasMeantToLoad || (slice.isEnd(SliceEnd.Top) ? (sliced.setEnd(SliceEnd.Top), true) : false);\r\n    const bottomFulfilled = (sliceOffset - bottomWasMeantToLoad) >= 0 || (slice.isEnd(SliceEnd.Bottom) ? (sliced.setEnd(SliceEnd.Bottom), true) : false);\r\n\r\n    //console.log('sliceMe', topFulfilled, bottomFulfilled);\r\n\r\n    return {\r\n      slice: sliced, \r\n      offsetIdOffset: offset,\r\n      fulfilled: SliceEnd.None | (topFulfilled && bottomFulfilled ? SliceEnd.Both : ((topFulfilled ? SliceEnd.Top : SliceEnd.None) | (bottomFulfilled ? SliceEnd.Bottom : SliceEnd.None)))\r\n    };\r\n  }\r\n\r\n  public unshift(...items: ItemType[]) {\r\n    let slice = this.first;\r\n    if(!slice.length) {\r\n      slice.setEnd(SliceEnd.Bottom);\r\n    } else if(!slice.isEnd(SliceEnd.Bottom)) {\r\n      slice = this.constructSlice();\r\n      slice.setEnd(SliceEnd.Bottom);\r\n      this.slices.unshift(slice);\r\n    }\r\n\r\n    slice.unshift(...items);\r\n  }\r\n\r\n  public push(...items: ItemType[]) {\r\n    let slice = this.last;\r\n    if(!slice.length) {\r\n      slice.setEnd(SliceEnd.Top);\r\n    } else if(!slice.isEnd(SliceEnd.Top)) {\r\n      slice = this.constructSlice();\r\n      slice.setEnd(SliceEnd.Top);\r\n      this.slices.push(slice);\r\n    }\r\n\r\n    slice.push(...items);\r\n  }\r\n\r\n  public delete(item: ItemType) {\r\n    const found = this.findSlice(item);\r\n    if(found) {\r\n      found.slice.splice(found.index, 1);\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.SlicedArray = SlicedArray);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function findUpAsChild(el: any, parent: any) {\r\n  if(el.parentElement === parent) return el;\r\n  \r\n  while(el.parentElement) {\r\n    el = el.parentElement;\r\n    if(el.parentElement === parent) {\r\n      return el;\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { copy } from \"../../helpers/object\";\r\nimport { InputMedia, MessageEntity } from \"../../layer\";\r\nimport { logger, LogTypes } from \"../logger\";\r\nimport apiManager from \"../mtproto/mtprotoworker\";\r\nimport { RichTextProcessor } from \"../richtextprocessor\";\r\nimport rootScope from \"../rootScope\";\r\nimport apiUpdatesManager from \"./apiUpdatesManager\";\r\nimport appMessagesManager from './appMessagesManager';\r\nimport appPeersManager from './appPeersManager';\r\nimport appUsersManager from \"./appUsersManager\";\r\n\r\nexport type PollAnswer = {\r\n  _: 'pollAnswer',\r\n  text: string,\r\n  option: Uint8Array\r\n};\r\n\r\nexport type PollAnswerVoters = {\r\n  _: 'pollAnswerVoters',\r\n  flags: number,\r\n  option: Uint8Array,\r\n  voters: number,\r\n\r\n  pFlags: Partial<{\r\n    chosen: true,\r\n    correct: true\r\n  }>\r\n};\r\n\r\nexport type PollResult = {\r\n  _: 'pollAnswerVoters',\r\n  flags: number,\r\n  option: Uint8Array,\r\n  voters: number,\r\n\r\n  pFlags?: Partial<{chosen: true, correct: true}>\r\n};\r\n\r\nexport type PollResults = {\r\n  _: 'pollResults',\r\n  flags: number,\r\n  results?: Array<PollResult>,\r\n  total_voters?: number,\r\n  recent_voters?: number[],\r\n  solution?: string,\r\n  solution_entities?: any[],\r\n\r\n  pFlags: Partial<{\r\n    min: true\r\n  }>,\r\n};\r\n\r\nexport type Poll = {\r\n  _: 'poll',\r\n  question: string,\r\n  id: string,\r\n  answers: Array<PollAnswer>,\r\n  close_period?: number,\r\n  close_date?: number\r\n\r\n  pFlags?: Partial<{\r\n    closed: true,\r\n    public_voters: true,\r\n    multiple_choice: true,\r\n    quiz: true\r\n  }>,\r\n  rQuestion?: string,\r\n  rReply?: string,\r\n  chosenIndexes?: number[]\r\n};\r\n\r\nexport class AppPollsManager {\r\n  public polls: {[id: string]: Poll} = {};\r\n  public results: {[id: string]: PollResults} = {};\r\n\r\n  private log = logger('POLLS', LogTypes.Error);\r\n\r\n  constructor() {\r\n    rootScope.addMultipleEventsListeners({\r\n      updateMessagePoll: (update) => {\r\n        this.log('updateMessagePoll:', update);\r\n\r\n        let poll: Poll = update.poll || this.polls[update.poll_id];\r\n        if(!poll) {\r\n          return;\r\n        }\r\n\r\n        poll = this.savePoll(poll, update.results as any);\r\n        rootScope.dispatchEvent('poll_update', {poll, results: update.results as any});\r\n      }\r\n    });\r\n  }\r\n\r\n  public savePoll(poll: Poll, results: PollResults) {\r\n    const id = poll.id;\r\n    if(this.polls[id]) {\r\n      poll = Object.assign(this.polls[id], poll);\r\n      this.saveResults(poll, results);\r\n      return poll;\r\n    }\r\n\r\n    this.polls[id] = poll;\r\n\r\n    poll.rQuestion = RichTextProcessor.wrapEmojiText(poll.question);\r\n    poll.rReply = RichTextProcessor.wrapEmojiText('📊') + ' ' + (poll.rQuestion || 'poll');\r\n    poll.chosenIndexes = [];\r\n    this.saveResults(poll, results);\r\n    return poll;\r\n  }\r\n\r\n  public saveResults(poll: Poll, results: PollResults) {\r\n    if(this.results[poll.id]) {\r\n      results = Object.assign(this.results[poll.id], results);\r\n    } else {\r\n      this.results[poll.id] = results;\r\n    }\r\n\r\n    if(!results.pFlags.min) { // ! https://core.telegram.org/constructor/pollResults - min\r\n      poll.chosenIndexes.length = 0;\r\n      if(results?.results?.length) {\r\n        results.results.forEach((answer, idx) => {\r\n          if(answer.pFlags?.chosen) {\r\n            poll.chosenIndexes.push(idx);\r\n          }\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  public getPoll(pollId: string): {poll: Poll, results: PollResults} {\r\n    return {\r\n      poll: this.polls[pollId], \r\n      results: this.results[pollId]\r\n    };\r\n  }\r\n\r\n  public getInputMediaPoll(poll: Poll, correctAnswers?: Uint8Array[], solution?: string, solutionEntities?: MessageEntity[]): InputMedia.inputMediaPoll {\r\n    if(solution) {\r\n      if(!solutionEntities) {\r\n        solutionEntities = [];\r\n      }\r\n\r\n      solution = RichTextProcessor.parseMarkdown(solution, solutionEntities);\r\n    } else {\r\n      solution = undefined; // can be string here\r\n    }\r\n\r\n    return {\r\n      _: 'inputMediaPoll',\r\n      poll,\r\n      correct_answers: correctAnswers,\r\n      solution,\r\n      solution_entities: solution ? solutionEntities : undefined\r\n    };\r\n  }\r\n\r\n  public sendVote(message: any, optionIds: number[]): Promise<void> {\r\n    const poll: Poll = message.media.poll;\r\n\r\n    const options: Uint8Array[] = optionIds.map(index => {\r\n      return poll.answers[index].option;\r\n    });\r\n    \r\n    const messageId = message.mid;\r\n    const peerId = message.peerId;\r\n    const inputPeer = appPeersManager.getInputPeerById(peerId);\r\n\r\n    if(message.pFlags.is_outgoing) {\r\n      return appMessagesManager.invokeAfterMessageIsSent(messageId, 'sendVote', (message) => {\r\n        this.log('invoke sendVote callback');\r\n        return this.sendVote(message, optionIds);\r\n      });\r\n    }\r\n\r\n    return apiManager.invokeApi('messages.sendVote', {\r\n      peer: inputPeer,\r\n      msg_id: appMessagesManager.getServerMessageId(message.mid),\r\n      options\r\n    }).then(updates => {\r\n      this.log('sendVote updates:', updates);\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n    });\r\n  }\r\n\r\n  public getResults(message: any) {\r\n    const inputPeer = appPeersManager.getInputPeerById(message.peerId);\r\n\r\n    return apiManager.invokeApi('messages.getPollResults', {\r\n      peer: inputPeer,\r\n      msg_id: appMessagesManager.getServerMessageId(message.mid)\r\n    }).then(updates => {\r\n      apiUpdatesManager.processUpdateMessage(updates);\r\n      this.log('getResults updates:', updates);\r\n    });\r\n  }\r\n\r\n  public getVotes(message: any, option?: Uint8Array, offset?: string, limit = 20) {\r\n    return apiManager.invokeApi('messages.getPollVotes', {\r\n      peer: appPeersManager.getInputPeerById(message.peerId),\r\n      id: appMessagesManager.getServerMessageId(message.mid),\r\n      option,\r\n      offset,\r\n      limit\r\n    }).then((votesList) => {\r\n      this.log('getPollVotes messages:', votesList);\r\n\r\n      appUsersManager.saveApiUsers(votesList.users);\r\n\r\n      return votesList;\r\n    });\r\n  }\r\n\r\n  public stopPoll(message: any) {\r\n    const poll: Poll = message.media.poll;\r\n    \r\n    if(poll.pFlags.closed) return Promise.resolve();\r\n\r\n    const newPoll = copy(poll);\r\n    newPoll.pFlags.closed = true;\r\n    return appMessagesManager.editMessage(message, undefined, {\r\n      newMedia: this.getInputMediaPoll(newPoll)\r\n    }).then(() => {\r\n      //console.log('stopped poll');\r\n    }, err => {\r\n      this.log.error('stopPoll error:', err);\r\n    });\r\n  }\r\n}\r\n\r\nconst appPollsManager = new AppPollsManager();\r\nMOUNT_CLASS_TO.appPollsManager = appPollsManager;\r\nexport default appPollsManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { CancellablePromise, deferredPromise } from \"./cancellablePromise\";\r\nimport { getHeavyAnimationPromise } from \"../hooks/useHeavyAnimationCheck\";\r\nimport { fastRaf } from \"./schedulers\";\r\n\r\ntype HeavyQueue<T> = {\r\n  items: any[], \r\n  process: (...args: any[]) => T,\r\n  context: any,\r\n  promise?: CancellablePromise<ReturnType<HeavyQueue<T>['process']>[]>\r\n};\r\nconst heavyQueue: HeavyQueue<any>[] = [];\r\nlet processingQueue = false;\r\n\r\nexport default function addHeavyTask<T>(queue: HeavyQueue<T>, method: 'push' | 'unshift' = 'push') {\r\n  if(!queue.items.length) {\r\n    return Promise.resolve([]);\r\n  }\r\n  \r\n  queue.promise = deferredPromise<T[]>();\r\n  heavyQueue[method](queue);\r\n  processHeavyQueue();\r\n\r\n  return queue.promise;\r\n}\r\n\r\nfunction processHeavyQueue() {\r\n  if(!processingQueue) {\r\n    const queue = heavyQueue.shift();\r\n    timedChunk(queue).finally(() => {\r\n      processingQueue = false;\r\n      if(heavyQueue.length) {\r\n        processHeavyQueue();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nfunction timedChunk<T>(queue: HeavyQueue<T>) {\r\n  if(!queue.items.length) {\r\n    queue.promise.resolve([]);\r\n    return Promise.resolve([]);\r\n  }\r\n\r\n  const todo = queue.items.slice();\r\n  const results: T[] = [];\r\n\r\n  return new Promise<T[]>((resolve, reject) => {\r\n    const f = async() => {\r\n      const start = performance.now();\r\n\r\n      do {\r\n        await getHeavyAnimationPromise();\r\n        const possiblePromise = queue.process.apply(queue.context, todo.shift());\r\n        let realResult: T;\r\n        if(possiblePromise instanceof Promise) {\r\n          try {\r\n            realResult = await possiblePromise;\r\n          } catch(err) {\r\n            reject(err);\r\n            return;\r\n          }\r\n        } else {\r\n          realResult = possiblePromise;\r\n        }\r\n\r\n        results.push(realResult);\r\n      } while(todo.length > 0 && (performance.now() - start) < 6);\r\n\r\n      if(todo.length > 0) {\r\n        fastRaf(f);\r\n        //setTimeout(f, 25);\r\n      } else {\r\n        resolve(results);\r\n      }\r\n    };\r\n\r\n    fastRaf(f);\r\n    //setTimeout(f, 25);\r\n  }).then(queue.promise.resolve, queue.promise.reject);\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type fastBlur from '../vendor/fastBlur';\r\nimport addHeavyTask from './heavyQueue';\r\n\r\nconst RADIUS = 2;\r\nconst ITERATIONS = 2;\r\n\r\nconst isFilterAvailable = 'filter' in (document.createElement('canvas').getContext('2d') || {});\r\nlet requireBlurPromise: Promise<any>;\r\nlet fastBlurFunc: typeof fastBlur;\r\nif(!isFilterAvailable) {\r\n  requireBlurPromise = import('../vendor/fastBlur').then(m => {\r\n    fastBlurFunc = m.default;\r\n  });\r\n} else {\r\n  requireBlurPromise = Promise.resolve();\r\n}\r\n\r\nfunction processBlurNext(img: HTMLImageElement, radius: number, iterations: number) {\r\n  return new Promise<string>((resolve) => {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = img.width;\r\n    canvas.height = img.height;\r\n    \r\n    const ctx = canvas.getContext('2d', {alpha: false});\r\n    if(isFilterAvailable) {\r\n      ctx.filter = `blur(${radius}px)`;\r\n      ctx.drawImage(img, -radius * 2, -radius * 2, canvas.width + radius * 4, canvas.height + radius * 4);\r\n    } else {\r\n      ctx.drawImage(img, 0, 0);\r\n      fastBlurFunc(ctx, 0, 0, canvas.width, canvas.height, radius, iterations);\r\n    }\r\n    \r\n    resolve(canvas.toDataURL());\r\n    /* if(DEBUG) {\r\n      console.log(`[blur] end, radius: ${radius}, iterations: ${iterations}, time: ${performance.now() - perf}`);\r\n    } */\r\n\r\n    /* canvas.toBlob(blob => {\r\n      resolve(URL.createObjectURL(blob));\r\n      \r\n      if(DEBUG) {\r\n        console.log(`[blur] end, radius: ${radius}, iterations: ${iterations}, time: ${performance.now() - perf}`);\r\n      }\r\n    }); */\r\n  });\r\n}\r\n\r\nconst blurPromises: Map<string, Promise<string>> = new Map();\r\nconst CACHE_SIZE = 1000;\r\n\r\nexport default function blur(dataUri: string, radius: number = RADIUS, iterations: number = ITERATIONS) {\r\n  if(!dataUri) {\r\n    console.error('no dataUri for blur', dataUri);\r\n    return Promise.resolve(dataUri);\r\n  }\r\n\r\n  if(blurPromises.size > CACHE_SIZE) {\r\n    blurPromises.clear();\r\n  }\r\n  \r\n  if(blurPromises.has(dataUri)) return blurPromises.get(dataUri);\r\n  const promise = new Promise<string>((resolve) => {\r\n    //return resolve(dataUri);\r\n    requireBlurPromise.then(() => {\r\n      const img = new Image();\r\n      img.onload = () => {\r\n        if(isFilterAvailable) {\r\n          processBlurNext(img, radius, iterations).then(resolve);\r\n        } else {\r\n          addHeavyTask({\r\n            items: [[img, radius, iterations]],\r\n            context: null,\r\n            process: processBlurNext\r\n          }, 'unshift').then(results => {\r\n            resolve(results[0]);\r\n          });\r\n        }\r\n      };\r\n      img.src = dataUri;\r\n\r\n      /* addHeavyTask({\r\n        items: [[dataUri, radius, iterations]],\r\n        context: null,\r\n        process: processBlur\r\n      }, 'unshift').then(results => {\r\n        resolve(results[0]);\r\n      }); */\r\n    });\r\n  });\r\n\r\n  blurPromises.set(dataUri, promise);\r\n\r\n  return promise;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../rootScope\";\r\nimport appPeersManager from \"./appPeersManager\";\r\nimport appMessagesManager from \"./appMessagesManager\";\r\nimport apiUpdatesManager from \"./apiUpdatesManager\";\r\nimport RichTextProcessor from \"../richtextprocessor\";\r\nimport serverTimeManager from \"../mtproto/serverTimeManager\";\r\nimport { MessageEntity, DraftMessage, MessagesSaveDraft } from \"../../layer\";\r\nimport apiManager from \"../mtproto/mtprotoworker\";\r\nimport { tsNow } from \"../../helpers/date\";\r\nimport { deepEqual } from \"../../helpers/object\";\r\nimport { isObject } from \"../mtproto/bin_utils\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport stateStorage from \"../stateStorage\";\r\n\r\nexport type MyDraftMessage = DraftMessage.draftMessage;\r\n\r\nexport class AppDraftsManager {\r\n  private drafts: {[peerIdAndThreadId: string]: MyDraftMessage} = {};\r\n  private getAllDraftPromise: Promise<void> = null;\r\n\r\n  constructor() {\r\n    stateStorage.get('drafts').then(drafts => {\r\n      this.drafts = drafts || {};\r\n    });\r\n\r\n    rootScope.addMultipleEventsListeners({\r\n      updateDraftMessage: (update) => {\r\n        const peerID = appPeersManager.getPeerId(update.peer);\r\n        this.saveDraft(peerID, (update as any).threadId, update.draft, {notify: true});\r\n      }\r\n    });\r\n  }\r\n\r\n  private getKey(peerId: number, threadId?: number) {\r\n    return '' + peerId + (threadId ? '_' + threadId : '');\r\n  }\r\n\r\n  public getDraft(peerId: number, threadId?: number) {\r\n    return this.drafts[this.getKey(peerId, threadId)];\r\n  }\r\n\r\n  public addMissedDialogs() {\r\n    return this.getAllDrafts().then(() => {\r\n      for(const key in this.drafts) {\r\n        if(key.indexOf('_') !== -1) { // exclude threads\r\n          continue;\r\n        }\r\n\r\n        const peerId = +key;\r\n        const dialog = appMessagesManager.getDialogOnly(peerId);\r\n        if(!dialog) {\r\n          appMessagesManager.reloadConversation(peerId);\r\n          /* const dialog = appMessagesManager.generateDialog(peerId);\r\n          dialog.draft = this.drafts[key];\r\n          appMessagesManager.saveConversation(dialog);\r\n          appMessagesManager.newDialogsToHandle[peerId] = dialog;\r\n          appMessagesManager.scheduleHandleNewDialogs(); */\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public getAllDrafts() {\r\n    return this.getAllDraftPromise || (this.getAllDraftPromise = new Promise((resolve) => {\r\n      apiManager.invokeApi('messages.getAllDrafts').then((updates) => {\r\n        const p = apiUpdatesManager.updatesState.syncLoading || Promise.resolve();\r\n        p.then(() => {\r\n          apiUpdatesManager.processUpdateMessage(updates);\r\n        });\r\n        \r\n        resolve();\r\n      });\r\n    }));\r\n  }\r\n\r\n  public saveDraft(peerId: number, threadId: number, apiDraft: DraftMessage, options: Partial<{\r\n    notify: boolean\r\n  }> = {}) {\r\n    const draft = this.processApiDraft(apiDraft);\r\n\r\n    const key = this.getKey(peerId, threadId);\r\n    if(draft) {\r\n      this.drafts[key] = draft;\r\n    } else {\r\n      delete this.drafts[key];\r\n    }\r\n\r\n    stateStorage.set({\r\n      drafts: this.drafts\r\n    });\r\n\r\n    if(options.notify) {\r\n      // console.warn(dT(), 'save draft', peerId, apiDraft, options)\r\n      rootScope.dispatchEvent('draft_updated', {\r\n        peerId,\r\n        threadId,\r\n        draft\r\n      });\r\n    }\r\n\r\n    return draft;\r\n  }\r\n\r\n  public draftsAreEqual(draft1: DraftMessage, draft2: DraftMessage) {\r\n    if(typeof(draft1) !== typeof(draft2)) {\r\n      return false;\r\n    }\r\n\r\n    if(!isObject(draft1)) {\r\n      return true;\r\n    }\r\n\r\n    if(draft1._ !== draft2._) {\r\n      return false;\r\n    }\r\n  \r\n    if(draft1._ === 'draftMessage' && draft2._ === draft1._) {\r\n      if(draft1.reply_to_msg_id !== draft2.reply_to_msg_id) {\r\n        return false;\r\n      }\r\n  \r\n      if(!deepEqual(draft1.entities, draft2.entities)) {\r\n        return false;\r\n      }\r\n  \r\n      if(draft1.message !== draft2.message) {\r\n        return false;\r\n      }\r\n  \r\n      if(draft1.pFlags.no_webpage !== draft2.pFlags.no_webpage) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public isEmptyDraft(draft: DraftMessage) {\r\n    if(!draft || draft._ === 'draftMessageEmpty') {\r\n      return true;\r\n    }\r\n    \r\n    if(draft.reply_to_msg_id > 0) {\r\n      return false;\r\n    }\r\n    \r\n    if(!draft.message.length) {\r\n      return true;\r\n    }\r\n    \r\n    return false;\r\n  }\r\n\r\n  public processApiDraft(draft: DraftMessage): MyDraftMessage {\r\n    if(!draft || draft._ !== 'draftMessage') {\r\n      return undefined;\r\n    }\r\n\r\n    const myEntities = RichTextProcessor.parseEntities(draft.message);\r\n    const apiEntities = draft.entities || [];\r\n    const totalEntities = RichTextProcessor.mergeEntities(apiEntities.slice(), myEntities); // ! only in this order, otherwise bold and emoji formatting won't work\r\n\r\n    draft.rMessage = RichTextProcessor.wrapDraftText(draft.message, {entities: totalEntities});\r\n    //draft.rReply = appMessagesManager.getRichReplyText(draft);\r\n    if(draft.reply_to_msg_id) {\r\n      draft.reply_to_msg_id = appMessagesManager.generateMessageId(draft.reply_to_msg_id);\r\n    }\r\n\r\n    return draft;\r\n  }\r\n\r\n  public async syncDraft(peerId: number, threadId: number, localDraft?: MyDraftMessage, saveOnServer = true) {\r\n    // console.warn(dT(), 'sync draft', peerID)\r\n    const serverDraft = this.getDraft(peerId, threadId);\r\n    if(this.draftsAreEqual(serverDraft, localDraft)) {\r\n      // console.warn(dT(), 'equal drafts', localDraft, serverDraft)\r\n      return true;\r\n    }\r\n\r\n    // console.warn(dT(), 'changed draft', localDraft, serverDraft)\r\n    let params: MessagesSaveDraft = {\r\n      peer: appPeersManager.getInputPeerById(peerId),\r\n      message: ''\r\n    };\r\n\r\n    let draftObj: DraftMessage;\r\n    if(this.isEmptyDraft(localDraft)) {\r\n      draftObj = {_: 'draftMessageEmpty'};\r\n    } else {\r\n      let message = localDraft.message;\r\n      let entities: MessageEntity[] = localDraft.entities;\r\n\r\n      if(localDraft.reply_to_msg_id) {\r\n        params.reply_to_msg_id = appMessagesManager.getServerMessageId(localDraft.reply_to_msg_id);\r\n      }\r\n\r\n      if(entities?.length) {\r\n        params.entities = appMessagesManager.getInputEntities(entities);\r\n      }\r\n\r\n      if(localDraft.pFlags.no_webpage) {\r\n        params.no_webpage = localDraft.pFlags.no_webpage;\r\n      }\r\n\r\n      params.message = message;\r\n    }\r\n\r\n    const saveLocalDraft = draftObj || localDraft;\r\n    saveLocalDraft.date = tsNow(true) + serverTimeManager.serverTimeOffset;\r\n\r\n    this.saveDraft(peerId, threadId, saveLocalDraft, {notify: true});\r\n\r\n    if(saveOnServer && !threadId) {\r\n      return apiManager.invokeApi('messages.saveDraft', params);\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n\r\nconst appDraftsManager = new AppDraftsManager();\r\nMOUNT_CLASS_TO.appDraftsManager = appDraftsManager;\r\nexport default appDraftsManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// Thanks to https://stackoverflow.com/a/49349813\r\nimport { clamp } from \"../helpers/number\";\r\n\r\n/**\r\n * Attibute modifier to create middle ellipsis\r\n * When the attribute value is left blank the ellipsis will be in the middle\r\n * When positive the attribute value will be used as a percentage\r\n * When negative the attribute value will be used as character index counted from the end\r\n * @example\r\n *   <div data-middle-ellipsis>A Javascript solution to middle ellipsis</div>\r\n *   <div data-middle-ellipsis=\"20\">A Javascript solution to middle ellipsis</div>\r\n *   <div data-middle-ellipsis=\"-3\">A Javascript solution to middle ellipsis</div>\r\n */\r\nconst ellipsis = '…';\r\nconst map: Map<HTMLElement, {\r\n  text: string,\r\n  textLength: number,\r\n  from: number,\r\n  multiplier: number,\r\n  font: string,\r\n  textWidth: number,\r\n  elementWidth: number\r\n}> = new Map();\r\n\r\nconst testQueue: Set<HTMLElement> = new Set();\r\nexport const fontFamily = 'Roboto, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Oxygen-Sans, Ubuntu, Cantarell, \"Helvetica Neue\", sans-serif';\r\nconst fontSize = '16px';\r\nlet timeoutId: number;\r\n\r\nconst setTestQueue = () => {\r\n  cancelAnimationFrame(timeoutId);\r\n  timeoutId = window.requestAnimationFrame(testQueueElements);\r\n};\r\n\r\nconst testQueueElements = () => {\r\n  testQueue.forEach(testElement);\r\n  testQueue.clear();\r\n};\r\n\r\nwindow.addEventListener('resize', () => {\r\n  for(const [key] of map) {\r\n    testQueue.add(key);\r\n  }\r\n  \r\n  setTestQueue();\r\n}, {capture: true, passive: true});\r\n\r\nconst testElement = (element: HTMLElement) => {\r\n  //const perf = performance.now();\r\n  // do not recalculate variables a second time\r\n  let mapped = map.get(element);\r\n  const firstTime = !mapped;\r\n\r\n  let {text, textLength, from, multiplier, font, textWidth, elementWidth} = mapped || {};\r\n  //console.log('[MEE] testElement got mapped', mapped);\r\n\r\n  if(firstTime) {\r\n    text = element.textContent;\r\n    textLength = text.length;\r\n    from = /* parseFloat(element.getAttribute(attributeName)) ||  */50;\r\n    multiplier = from > 0 && from / 100;\r\n\r\n    //const perf = performance.now();\r\n    font = `${element.dataset.fontWeight || 400} ${fontSize} ${fontFamily}`;\r\n    /* const computedStyle = window.getComputedStyle(elm, null);\r\n    font = `${computedStyle.getPropertyValue('font-weight')} ${computedStyle.getPropertyValue('font-size')} ${computedStyle.getPropertyValue('font-family')}`; */\r\n    //console.log('testMiddleEllipsis get computed style:', performance.now() - perf, font);\r\n\r\n    textWidth = getTextWidth(text, font);\r\n    //const perf = performance.now();\r\n    elementWidth = element.getBoundingClientRect().width;\r\n    //console.log('testMiddleEllipsis get offsetWidth:', performance.now() - perf, font);\r\n    mapped = {text, textLength, from, multiplier, font, textWidth, elementWidth};\r\n    map.set(element, mapped);\r\n\r\n    //console.log('[MEE] testElement map set', element);\r\n  }\r\n  \r\n  const newElementWidth = element.getBoundingClientRect().width;\r\n  const widthChanged = firstTime || elementWidth !== newElementWidth;\r\n  !firstTime && widthChanged && (mapped.elementWidth = elementWidth = newElementWidth);\r\n  \r\n  if(widthChanged) {\r\n    if(textWidth > elementWidth) {\r\n      element.setAttribute('title', text);\r\n      let smallerText = text;\r\n      let smallerWidth = elementWidth;\r\n      while(smallerText.length > 3) {\r\n        let smallerTextLength = smallerText.length;\r\n        const half = multiplier &&\r\n          clamp(multiplier * smallerTextLength << 0, 1, smallerTextLength - 2) ||\r\n          Math.max(smallerTextLength + from - 1, 1);\r\n        const half1 = smallerText.substr(0, half).replace(/\\s*$/,'');\r\n        const half2 = smallerText.substr(half + 1).replace(/^\\s*/,'');\r\n        smallerText = half1 + half2;\r\n        smallerWidth = getTextWidth(smallerText + ellipsis, font);\r\n        if(smallerWidth < elementWidth) {\r\n          element.textContent = half1 + ellipsis + half2;\r\n          break;\r\n        }\r\n      }\r\n\r\n      // * set new width after cutting text\r\n      mapped.elementWidth = element.getBoundingClientRect().width;\r\n      //mapped.textWidth = smallerWidth;\r\n    } else {\r\n      element.removeAttribute('title');\r\n    }\r\n  }\r\n\r\n  //console.log('testMiddleEllipsis for element:', elm, performance.now() - perf);\r\n};\r\n\r\nlet context: CanvasRenderingContext2D;\r\n/**\r\n * Get the text width\r\n * @param {string} text\r\n * @param {string} font\r\n */\r\nfunction getTextWidth(text: string, font: string) {\r\n  //const perf = performance.now();\r\n  if(!context) {\r\n    const canvas = document.createElement('canvas');\r\n    context = canvas.getContext('2d');\r\n    context.font = font;\r\n  }\r\n\r\n  //context.font = font;\r\n  const metrics = context.measureText(text);\r\n  //console.log('getTextWidth perf:', performance.now() - perf);\r\n  return metrics.width;\r\n  //return Math.round(metrics.width);\r\n}\r\n\r\nexport class MiddleEllipsisElement extends HTMLElement {\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  connectedCallback() {\r\n    //console.log('[MEE]: connectedCallback before', map.has(this), testQueue.has(this), map.size, this.textContent, map);\r\n\r\n    map.set(this, null);\r\n    testQueue.add(this);\r\n    setTestQueue();\r\n    //testElement(this);\r\n\r\n    //console.log('[MEE]: connectedCallback after', map.has(this), map.size, testQueue.has(this), testQueue.size);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    const deleted = map.delete(this);\r\n    //console.log('[MEE]: disconnectedCallback', deleted, map.has(this), map.size, this.textContent, map);\r\n  }\r\n}\r\n\r\ncustomElements.define(\"middle-ellipsis-element\", MiddleEllipsisElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport sequentialDom from \"../../helpers/sequentialDom\";\r\nimport { UserProfilePhoto, ChatPhoto, InputFileLocation } from \"../../layer\";\r\nimport RichTextProcessor from \"../richtextprocessor\";\r\nimport rootScope from \"../rootScope\";\r\nimport appDownloadManager from \"./appDownloadManager\";\r\nimport appPeersManager from \"./appPeersManager\";\r\nimport appPhotosManager from \"./appPhotosManager\";\r\nimport appUsersManager from \"./appUsersManager\";\r\n\r\ntype PeerPhotoSize = 'photo_small' | 'photo_big';\r\n\r\nexport class AppAvatarsManager {\r\n  private savedAvatarURLs: {\r\n    [peerId: number]: {\r\n      [size in PeerPhotoSize]?: string | Promise<string>\r\n    }\r\n  } = {};\r\n  \r\n  public removeFromAvatarsCache(peerId: number) {\r\n    if(this.savedAvatarURLs[peerId]) {\r\n      delete this.savedAvatarURLs[peerId];\r\n    }\r\n  }\r\n\r\n  public loadAvatar(peerId: number, photo: UserProfilePhoto.userProfilePhoto | ChatPhoto.chatPhoto, size: PeerPhotoSize) {\r\n    const inputPeer = appPeersManager.getInputPeerById(peerId);\r\n\r\n    let cached = false;\r\n    let getAvatarPromise: Promise<string>;\r\n    let saved = this.savedAvatarURLs[peerId];\r\n    if(!saved || !saved[size]) {\r\n      if(!saved) {\r\n        saved = this.savedAvatarURLs[peerId] = {};\r\n      }\r\n\r\n      //console.warn('will invoke downloadSmallFile:', peerId);\r\n      const peerPhotoFileLocation: InputFileLocation.inputPeerPhotoFileLocation = {\r\n        _: 'inputPeerPhotoFileLocation', \r\n        pFlags: {},\r\n        peer: inputPeer, \r\n        photo_id: photo.photo_id\r\n      };\r\n\r\n      if(size === 'photo_big') {\r\n        peerPhotoFileLocation.pFlags.big = true;\r\n      }\r\n\r\n      const downloadOptions = {dcId: photo.dc_id, location: peerPhotoFileLocation};\r\n\r\n      /* let str: string;\r\n      const time = Date.now();\r\n      if(peerId === 0) {\r\n        str = `download avatar ${peerId}`;\r\n      } */\r\n\r\n      const promise = appDownloadManager.download(downloadOptions);\r\n      getAvatarPromise = saved[size] = promise.then(blob => {\r\n        return saved[size] = URL.createObjectURL(blob);\r\n\r\n        /* if(str) {\r\n          console.log(str, Date.now() / 1000, Date.now() - time);\r\n        } */\r\n      });\r\n    } else if(typeof(saved[size]) !== 'string') {\r\n      getAvatarPromise = saved[size] as Promise<any>;\r\n    } else {\r\n      getAvatarPromise = Promise.resolve(saved[size]);\r\n      cached = true;\r\n    }\r\n\r\n    return {cached, loadPromise: getAvatarPromise};\r\n  }\r\n\r\n  public putAvatar(div: HTMLElement, peerId: number, photo: UserProfilePhoto.userProfilePhoto | ChatPhoto.chatPhoto, size: PeerPhotoSize, img = new Image(), onlyThumb = false) {\r\n    let {cached, loadPromise} = this.loadAvatar(peerId, photo, size);\r\n\r\n    let renderThumbPromise: Promise<void>;\r\n    let callback: () => void;\r\n    if(cached) {\r\n      // смотри в misc.ts: renderImageFromUrl\r\n      callback = () => {\r\n        replaceContent(div, img);\r\n        div.dataset.color = '';\r\n      };\r\n    } else {\r\n      const animate = rootScope.settings.animationsEnabled;\r\n      if(animate) {\r\n        img.classList.add('fade-in');\r\n      }\r\n\r\n      let thumbImage: HTMLImageElement;\r\n      if(photo.stripped_thumb) {\r\n        thumbImage = new Image();\r\n        div.classList.add('avatar-relative');\r\n        thumbImage.classList.add('avatar-photo', 'avatar-photo-thumbnail');\r\n        img.classList.add('avatar-photo');\r\n        const url = appPhotosManager.getPreviewURLFromBytes(photo.stripped_thumb);\r\n        renderThumbPromise = renderImageFromUrl(thumbImage, url).then(() => {\r\n          replaceContent(div, thumbImage);\r\n        });\r\n      }\r\n\r\n      callback = () => {\r\n        if(photo.stripped_thumb) {\r\n          div.append(img);\r\n        } else {\r\n          replaceContent(div, img);\r\n        }\r\n\r\n        setTimeout(() => {\r\n          if(div.childElementCount) {\r\n            sequentialDom.mutateElement(img, () => {\r\n              div.dataset.color = '';\r\n              \r\n              if(animate) {\r\n                img.classList.remove('fade-in');\r\n              }\r\n\r\n              if(thumbImage) {\r\n                thumbImage.remove();\r\n              }\r\n            });\r\n          }\r\n        }, animate ? 200 : 0);\r\n      };\r\n    }\r\n\r\n    const renderPromise = loadPromise\r\n    .then((url) => renderImageFromUrl(img, url/* , false */))\r\n    .then(() => callback());\r\n\r\n    return {cached, loadPromise: renderThumbPromise || renderPromise};\r\n  }\r\n\r\n  // peerId === peerId || title\r\n  public putPhoto(div: HTMLElement, peerId: number, isDialog = false, title = '', onlyThumb = false) {\r\n    const photo = appPeersManager.getPeerPhoto(peerId);\r\n\r\n    const size: PeerPhotoSize = 'photo_small';\r\n    const avatarAvailable = !!photo;\r\n    const avatarRendered = div.firstElementChild && !(div.firstElementChild as HTMLElement).classList.contains('emoji');\r\n    \r\n    const myId = rootScope.myId;\r\n\r\n    //console.log('loadDialogPhoto location:', location, inputPeer);\r\n    if(peerId === myId && isDialog) {\r\n      div.innerText = '';\r\n      div.dataset.color = '';\r\n      div.classList.add('tgico-saved');\r\n      div.classList.remove('tgico-deletedaccount');\r\n      return;\r\n    }\r\n\r\n    if(peerId > 0) {\r\n      const user = appUsersManager.getUser(peerId);\r\n      if(user && user.pFlags && user.pFlags.deleted) {\r\n        div.innerText = '';\r\n        div.dataset.color = appPeersManager.getPeerColorById(peerId);\r\n        div.classList.add('tgico-deletedaccount');\r\n        div.classList.remove('tgico-saved');\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(!avatarAvailable || !avatarRendered || !this.savedAvatarURLs[peerId]) {\r\n      let color = '';\r\n      if(peerId && (peerId !== myId || !isDialog)) {\r\n        color = appPeersManager.getPeerColorById(peerId);\r\n      }\r\n      \r\n      div.innerText = '';\r\n      div.classList.remove('tgico-saved', 'tgico-deletedaccount');\r\n      div.dataset.color = color;\r\n\r\n      let abbr: string;\r\n      if(!title) {\r\n        const peer = appPeersManager.getPeer(peerId);\r\n        abbr = peer.initials ?? '';\r\n      } else {\r\n        abbr = RichTextProcessor.getAbbreviation(title);\r\n      }\r\n\r\n      div.innerHTML = abbr;\r\n      //return Promise.resolve(true);\r\n    }\r\n\r\n    if(avatarAvailable/*  && false */) {\r\n      return this.putAvatar(div, peerId, photo, size, undefined, onlyThumb);\r\n    }\r\n  }\r\n}\r\n\r\nconst appAvatarsManager = new AppAvatarsManager();\r\nexport default appAvatarsManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport { isSafari } from \"../helpers/userAgent\";\r\nimport { logger, LogTypes } from \"./logger\";\r\n\r\ntype Result = {\r\n  bytes: Uint8Array, \r\n  waveform?: Uint8Array\r\n};\r\n\r\ntype Task = {\r\n  pages: Uint8Array,\r\n  withWaveform: boolean,\r\n  waveform?: Uint8Array,\r\n  callback: {resolve: (result: Result) => void, reject: (err: any) => void},\r\n  timeout: number\r\n};\r\n\r\nexport class OpusDecodeController {\r\n  private worker: Worker;\r\n  private wavWorker : Worker;\r\n  private sampleRate = 48000;\r\n  private tasks: Array<Task> = [];\r\n  private keepAlive = false;\r\n  private isPlaySupportedResult: boolean;\r\n  private log = logger('OPUS', LogTypes.Error);\r\n\r\n  public isPlaySupported() {\r\n    if(this.isPlaySupportedResult !== undefined) return this.isPlaySupportedResult;\r\n\r\n    const audio = document.createElement('audio');\r\n    return this.isPlaySupportedResult = !!(audio.canPlayType && audio.canPlayType('audio/ogg;').replace(/no/, ''))/*  && false */;\r\n  }\r\n\r\n  public loadWavWorker() {\r\n    if(this.wavWorker) return;\r\n\r\n    this.wavWorker = new Worker('waveWorker.min.js');\r\n    this.wavWorker.addEventListener('message', (e) => {\r\n      const data = e.data;\r\n\r\n      this.log('[WAV] got message:', data);\r\n      if(data && data.page) {\r\n        const bytes = data.page;\r\n        this.onTaskEnd(this.tasks.shift(), bytes);\r\n      }\r\n    });\r\n  }\r\n\r\n  public loadWorker() {\r\n    if(this.worker) return;\r\n\r\n    this.worker = new Worker('decoderWorker.min.js');\r\n    this.worker.addEventListener('message', (e) => {\r\n      const data = e.data;\r\n      \r\n      this.log('[DECODER] got message', data);\r\n      if(data.type === 'done') {\r\n        //this.log('[DECODER] send done to wav');\r\n        this.wavWorker.postMessage({command: 'done'});\r\n\r\n        if(data.waveform) {\r\n          this.tasks[0].waveform = data.waveform;\r\n        }\r\n      } else { // e.data contains decoded buffers as float32 values\r\n        //this.log('[DECODER] send encode to wav');\r\n        this.wavWorker.postMessage({\r\n          command: 'encode',\r\n          buffers: e.data\r\n        }, isSafari ? undefined : data.map((typedArray: Uint8Array) => typedArray.buffer));\r\n      }\r\n    });\r\n  }\r\n\r\n  public setKeepAlive(keepAlive: boolean) {\r\n    this.keepAlive = keepAlive;\r\n    if(this.keepAlive) {\r\n      this.loadWorker();\r\n      this.loadWavWorker();\r\n    } else if(!this.tasks.length) {\r\n      this.terminateWorkers();\r\n    }\r\n  }\r\n\r\n  public onTaskEnd(task: Task, result?: Uint8Array) {\r\n    if(!result) {\r\n      task.callback.reject('timeout');\r\n    } else {\r\n      clearTimeout(task.timeout);\r\n      task.callback.resolve({bytes: result, waveform: task.waveform});\r\n    }\r\n\r\n    if(this.tasks.length) {\r\n      this.executeNewTask(this.tasks[0]);\r\n    }\r\n\r\n    this.terminateWorkers();\r\n  }\r\n\r\n  public terminateWorkers(kill = false) {\r\n    if((this.keepAlive || this.tasks.length) && !kill) return;\r\n\r\n    if(this.worker) {\r\n      this.worker.terminate();\r\n      this.worker = null;\r\n    }\r\n    \r\n    if(this.wavWorker) {\r\n      this.wavWorker.terminate();\r\n      this.wavWorker = null;\r\n    }\r\n  }\r\n\r\n  public executeNewTask(task: Task) {\r\n    this.worker.postMessage({ \r\n      command: 'init',\r\n      decoderSampleRate: this.sampleRate,\r\n      outputBufferSampleRate: this.sampleRate\r\n    });\r\n\r\n    this.wavWorker.postMessage({ \r\n      command: 'init',\r\n      wavBitDepth: 16,\r\n      wavSampleRate: this.sampleRate\r\n    });\r\n\r\n    //console.log('sending command to worker:', task);\r\n    //setTimeout(() => {\r\n      this.log('[DECODER] send decode');\r\n      this.worker.postMessage({\r\n        command: 'decode',\r\n        pages: task.pages,\r\n        waveform: task.withWaveform\r\n      }, isSafari ? undefined : [task.pages.buffer]);\r\n    //}, 1e3);\r\n\r\n    task.timeout = window.setTimeout(() => {\r\n      this.log.error('decode timeout'/* , task */);\r\n\r\n      this.terminateWorkers(true);\r\n      if(this.tasks.length) {\r\n        this.loadWorker();\r\n        this.loadWavWorker();\r\n      }\r\n\r\n      this.onTaskEnd(this.tasks.shift());\r\n    }, 10e3);\r\n  }\r\n\r\n  public pushDecodeTask(pages: Uint8Array, withWaveform: boolean) {\r\n    return new Promise<Result>((resolve, reject) => {\r\n      const task = {\r\n        pages,\r\n        withWaveform,\r\n        callback: {resolve, reject},\r\n        timeout: 0\r\n      };\r\n\r\n      this.loadWorker();\r\n      this.loadWavWorker();\r\n\r\n      if(this.tasks.push(task) === 1) {\r\n        this.executeNewTask(task);\r\n      }\r\n    });\r\n  }\r\n\r\n  public async decode(typedArray: Uint8Array, withWaveform = false) {\r\n    return this.pushDecodeTask(typedArray, withWaveform).then(result => {\r\n      const dataBlob = new Blob([result.bytes], {type: \"audio/wav\"});\r\n      return {url: URL.createObjectURL(dataBlob), waveform: result.waveform};\r\n    });\r\n  }\r\n}\r\n\r\nconst opusDecodeController = new OpusDecodeController();\r\nMOUNT_CLASS_TO.opusDecodeController = opusDecodeController;\r\nexport default opusDecodeController;","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport appPhotosManager from \"./appPhotosManager\";\r\nimport appDocsManager from \"./appDocsManager\";\r\nimport { RichTextProcessor } from \"../richtextprocessor\";\r\nimport { ReferenceContext } from \"../mtproto/referenceDatabase\";\r\nimport rootScope from \"../rootScope\";\r\nimport { safeReplaceObject } from \"../../helpers/object\";\r\nimport { limitSymbols } from \"../../helpers/string\";\r\n\r\nexport class AppWebPagesManager {\r\n  private webpages: any = {};\r\n  private pendingWebPages: {\r\n    [webPageId: string]: {\r\n      [mid: string]: true\r\n    }\r\n  } = {};\r\n  \r\n  constructor() {\r\n    rootScope.addMultipleEventsListeners({\r\n      updateWebPage: (update) => {\r\n        this.saveWebPage(update.webpage);\r\n      }\r\n    });\r\n  }\r\n  \r\n  public saveWebPage(apiWebPage: any, mid?: number, mediaContext?: ReferenceContext) {\r\n    if(apiWebPage.photo && apiWebPage.photo._ === 'photo') {\r\n      //appPhotosManager.savePhoto(apiWebPage.photo, mediaContext);\r\n      apiWebPage.photo = appPhotosManager.savePhoto(apiWebPage.photo, mediaContext);\r\n    } else {\r\n      delete apiWebPage.photo;\r\n    }\r\n\r\n    if(apiWebPage.document && apiWebPage.document._ === 'document') {\r\n      apiWebPage.document = appDocsManager.saveDoc(apiWebPage.document, mediaContext); // warning 11.04.2020\r\n    } else {\r\n      if(apiWebPage.type === 'document') {\r\n        delete apiWebPage.type;\r\n      }\r\n\r\n      delete apiWebPage.document;\r\n    }\r\n    \r\n    const siteName = apiWebPage.site_name;\r\n    let shortTitle = apiWebPage.title || apiWebPage.author || siteName || '';\r\n    if(siteName && shortTitle === siteName) {\r\n      delete apiWebPage.site_name;\r\n    }\r\n\r\n    shortTitle = limitSymbols(shortTitle, 80, 100);\r\n\r\n    apiWebPage.rTitle = RichTextProcessor.wrapRichText(shortTitle, {noLinks: true, noLinebreaks: true});\r\n    let contextHashtag = '';\r\n    if(siteName === 'GitHub') {\r\n      const matches = apiWebPage.url.match(/(https?:\\/\\/github\\.com\\/[^\\/]+\\/[^\\/]+)/);\r\n      if(matches) {\r\n        contextHashtag = matches[0] + '/issues/{1}';\r\n      }\r\n    }\r\n\r\n    // delete apiWebPage.description\r\n    const shortDescriptionText = limitSymbols(apiWebPage.description || '', 150, 180);\r\n    apiWebPage.rDescription = RichTextProcessor.wrapRichText(shortDescriptionText, {\r\n      contextSite: siteName || 'external',\r\n      contextHashtag: contextHashtag\r\n    });\r\n    \r\n    if(apiWebPage.type !== 'photo' &&\r\n      apiWebPage.type !== 'video' &&\r\n      apiWebPage.type !== 'gif' &&\r\n      apiWebPage.type !== 'document' &&\r\n      !apiWebPage.description &&\r\n      apiWebPage.photo) {\r\n      apiWebPage.type = 'photo';\r\n    }\r\n    \r\n    if(mid) {\r\n      if(this.pendingWebPages[apiWebPage.id] === undefined) {\r\n        this.pendingWebPages[apiWebPage.id] = {};\r\n      }\r\n\r\n      this.pendingWebPages[apiWebPage.id][mid] = true;\r\n    }\r\n    \r\n    if(this.webpages[apiWebPage.id] === undefined) {\r\n      this.webpages[apiWebPage.id] = apiWebPage;\r\n    } else {\r\n      safeReplaceObject(this.webpages[apiWebPage.id], apiWebPage);\r\n    }\r\n    \r\n    if(!mid && this.pendingWebPages[apiWebPage.id] !== undefined) {\r\n      const msgs: number[] = [];\r\n      for(const msgId in this.pendingWebPages[apiWebPage.id]) {\r\n        msgs.push(+msgId);\r\n      }\r\n\r\n      rootScope.dispatchEvent('webpage_updated', {\r\n        id: apiWebPage.id,\r\n        msgs\r\n      });\r\n    }\r\n\r\n    return apiWebPage;\r\n  }\r\n\r\n  public deleteWebPageFromPending(webPage: any, mid: number) {\r\n    const id = webPage.id;\r\n    if(this.pendingWebPages[id] && this.pendingWebPages[id][mid]) {\r\n      delete this.pendingWebPages[id][mid];\r\n\r\n      if(!Object.keys(this.pendingWebPages[id]).length) {\r\n        delete this.pendingWebPages[id];\r\n      }\r\n    }\r\n  }\r\n\r\n  public getWebPage(id: string) {\r\n    return this.webpages[id];\r\n  }\r\n}\r\n\r\nexport default new AppWebPagesManager();\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function htmlToDocumentFragment(html: string) {\r\n  var template = document.createElement('template');\r\n  html = html.trim(); // Never return a text node of whitespace as the result\r\n  template.innerHTML = html;\r\n  return template.content;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nfunction resizeableImage(originalImage: HTMLImageElement, canvas?: HTMLCanvasElement) {\r\n  let cropComponent: HTMLDivElement, \r\n    container: HTMLDivElement, \r\n    cropImage: HTMLImageElement, \r\n    event_state: Partial<{  \r\n      mouse_x: number,   \r\n      mouse_y: number,   \r\n      container_width: number,  \r\n      container_height: number,  \r\n      container_left: number,  \r\n      container_top: number\r\n    }> = {}, \r\n    keyZoomValue = 4.0, \r\n    MINWIDTH = 50, \r\n    MINHEIGHT = 50, \r\n    CROPWIDTH = 200, \r\n    CROPHEIGHT = 200, \r\n    cropLeft = 0, \r\n    cropTop = 0, \r\n    cropWidth = 0, \r\n    cropHeight = 0,\r\n    scaledRatio = 0;\r\n  \r\n  if(originalImage.complete) init();\r\n  else originalImage.onload = init;\r\n  \r\n  function removeHandlers() {\r\n    container.removeEventListener('mousedown', startMoving);\r\n    container.removeEventListener('touchstart', startMoving);\r\n    container.removeEventListener('wheel', resizing);\r\n    \r\n    document.removeEventListener('mouseup', endMoving);\r\n    document.removeEventListener('touchend', endMoving);\r\n    document.removeEventListener('mousemove', moving);\r\n    document.removeEventListener('touchmove', moving);\r\n    document.removeEventListener('keypress', keyHandler);\r\n\r\n    cropComponent.remove();\r\n    container.remove();\r\n    cropImage.remove();\r\n  }\r\n  \r\n  function addHandlers() {\r\n    container.addEventListener('mousedown', startMoving, false);\r\n    container.addEventListener('touchstart', startMoving, false);\r\n    container.addEventListener('wheel', resizing, false);\r\n    \r\n    document.addEventListener('keypress', keyHandler, false);\r\n    //document.querySelector('.btn-crop').addEventListener('click', openCropCanvasImg);\r\n  }\r\n  \r\n  function init() {\r\n    originalImage.classList.add('crop-blur');\r\n    originalImage.draggable = false;\r\n    \r\n    cropImage = new Image();\r\n    cropImage.src = originalImage.src;\r\n    cropImage.draggable = false;\r\n    cropImage.classList.add('crop-overlay-image');\r\n    \r\n    if(!canvas) {\r\n      canvas = document.createElement('canvas');\r\n    }\r\n    \r\n    cropComponent = document.createElement('div');\r\n    cropComponent.classList.add('crop-component');\r\n    \r\n    container = document.createElement('div');\r\n    container.classList.add('crop-overlay');\r\n    \r\n    const overlayColor = document.createElement('div');\r\n    overlayColor.classList.add('crop-overlay-color');\r\n    \r\n    cropComponent.appendChild(container);\r\n    const wrapper = originalImage.parentNode as HTMLElement;\r\n    wrapper.appendChild(cropComponent);\r\n    cropComponent.appendChild(cropImage);\r\n    cropComponent.appendChild(originalImage);\r\n    cropComponent.appendChild(overlayColor);\r\n    container.appendChild(cropImage);\r\n\r\n    cropImage.style.maxWidth = originalImage.width + 'px';\r\n\r\n    scaledRatio = originalImage.naturalWidth / originalImage.offsetWidth;\r\n    \r\n    const left = originalImage.offsetWidth / 2 - CROPWIDTH / 2;\r\n    const top = originalImage.offsetHeight / 2 - CROPHEIGHT / 2;\r\n    \r\n    updateCropSize(CROPWIDTH, CROPHEIGHT);\r\n    updateCropImage(left, top);\r\n    updateContainer(left, top);\r\n    addHandlers();\r\n    //crop();\r\n  }\r\n  \r\n  function updateCropSize(width: number, height: number) {\r\n    cropWidth = width * scaledRatio;\r\n    cropHeight = height * scaledRatio;\r\n\r\n    container.style.width = width + 'px';\r\n    container.style.height = height + 'px';\r\n  }\r\n  \r\n  function updateCropImage(left: number, top: number) {\r\n    cropTop = top * scaledRatio;\r\n    cropLeft = left * scaledRatio;\r\n\r\n    cropImage.style.top = -top + 'px';\r\n    cropImage.style.left = -left + 'px';\r\n  }\r\n  \r\n  function updateContainer(left: number, top: number) {\r\n    container.style.top = top + 'px';\r\n    container.style.left = left + 'px';\r\n  }\r\n  \r\n  // Save the initial event details and container state\r\n  function saveEventState(e: any) {\r\n    event_state.container_width = container.offsetWidth;\r\n    event_state.container_height = container.offsetHeight;\r\n    \r\n    event_state.container_left = container.offsetLeft;\r\n    event_state.container_top = container.offsetTop;\r\n    \r\n    event_state.mouse_x = (e.clientX || e.pageX || e.touches && e.touches[0].clientX) + window.scrollX;\r\n    event_state.mouse_y = (e.clientY || e.pageY || e.touches && e.touches[0].clientY) + window.scrollY;\r\n  }\r\n  \r\n  function imgZoom(zoom: number) {\r\n    zoom = zoom * Math.PI * 2\r\n    let newWidth = Math.floor(container.clientWidth + zoom), \r\n      newHeight = Math.floor(container.clientHeight + zoom), \r\n      w = cropImage.clientWidth, \r\n      h = cropImage.clientHeight, \r\n      left: number, \r\n      top: number, \r\n      right: number, \r\n      bottom: number;\r\n    \r\n    if(newWidth < MINWIDTH) {\r\n      return;\r\n    } else if(newWidth > w) {\r\n      return;\r\n    }\r\n    \r\n    left = container.offsetLeft - (zoom / 2);\r\n    top = container.offsetTop - (zoom / 2);\r\n    right = left + newWidth;\r\n    bottom = top + newHeight;\r\n    \r\n    if(left < 0) left = 0;\r\n    if(top < 0) top = 0;\r\n\r\n    if(right > w) return;\r\n    if(bottom > h) return;\r\n\r\n    updateCropSize(newWidth, newWidth);\r\n    updateCropImage(left, top);\r\n    updateContainer(left, top);\r\n    //crop();\r\n  }\r\n  \r\n  function keyHandler(e: KeyboardEvent) {\r\n    e.preventDefault();\r\n    \r\n    switch (String.fromCharCode(e.charCode)) {\r\n      case '+' :\r\n      imgZoom(keyZoomValue);\r\n      break;\r\n      case '-' :\r\n      imgZoom(-keyZoomValue);\r\n      break;\r\n    }\r\n  }\r\n  \r\n  function resizing(e: any) {\r\n    e.preventDefault();\r\n    imgZoom(e.deltaY > 0 ? 1 : -1);\r\n  }\r\n  \r\n  function startMoving(e: MouseEvent | TouchEvent) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    \r\n    saveEventState(e);\r\n    \r\n    document.addEventListener('mousemove', moving);\r\n    document.addEventListener('touchmove', moving);\r\n    document.addEventListener('mouseup', endMoving);\r\n    document.addEventListener('touchend', endMoving);\r\n  }\r\n  \r\n  function endMoving(e: MouseEvent | TouchEvent) {\r\n    e.preventDefault();\r\n    \r\n    document.removeEventListener('mouseup', endMoving);\r\n    document.removeEventListener('touchend', endMoving);\r\n    document.removeEventListener('mousemove', moving);\r\n    document.removeEventListener('touchmove', moving);\r\n  }\r\n  \r\n  function moving(e: any) {\r\n    let currentTouch = {x: 0, y: 0}, \r\n      left: number, \r\n      top: number, \r\n      w: number, \r\n      h: number;\r\n    \r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    \r\n    currentTouch.x = e.pageX || e.touches && e.touches[0].pageX;\r\n    currentTouch.y = e.pageY || e.touches && e.touches[0].pageY;\r\n    \r\n    left = currentTouch.x - (event_state.mouse_x - event_state.container_left);\r\n    top = currentTouch.y - (event_state.mouse_y - event_state.container_top);\r\n    w = container.offsetWidth;\r\n    h = container.offsetHeight;\r\n    \r\n    if(left < 0) left = 0;\r\n    else if(left > cropImage.offsetWidth - w) left = cropImage.offsetWidth - w;\r\n\r\n    if(top < 0) top = 0;\r\n    else if(top > cropImage.offsetHeight - h) top = cropImage.offsetHeight - h;\r\n    \r\n    updateCropImage(left, top);\r\n    updateContainer(left, top);\r\n    //crop();\r\n  }\r\n\r\n  function crop() {\r\n    canvas.width = cropWidth;\r\n    canvas.height = cropHeight;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    ctx.drawImage(originalImage,\r\n      cropLeft, cropTop,\r\n      cropWidth, cropHeight,\r\n      0, 0,\r\n      cropWidth, cropHeight\r\n    );\r\n  }\r\n  \r\n  return {crop, removeHandlers};\r\n}\r\n\r\nexport default resizeableImage;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport resizeableImage from \"../../lib/cropper\";\r\nimport PopupElement from \".\";\r\nimport { ripple } from \"../ripple\";\r\nimport { _i18n } from \"../../lib/langPack\";\r\n\r\nexport default class PopupAvatar extends PopupElement {\r\n  private cropContainer: HTMLElement;\r\n  private input: HTMLInputElement;\r\n  private btnSubmit: HTMLElement;\r\n  private h6: HTMLElement;\r\n\r\n  private image = new Image();\r\n\r\n  private canvas: HTMLCanvasElement;\r\n  private blob: Blob;\r\n  private cropper = {\r\n    crop: () => {},\r\n    removeHandlers: () => {}\r\n  };\r\n\r\n  private onCrop: (upload: () => ReturnType<typeof appDownloadManager.upload>) => void;\r\n\r\n  constructor() {\r\n    super('popup-avatar', null, {closable: true});\r\n\r\n    this.h6 = document.createElement('h6');\r\n    _i18n(this.h6, 'Popup.Avatar.Title');\r\n\r\n    this.btnClose.classList.remove('btn-icon');\r\n\r\n    this.header.append(this.h6);\r\n\r\n    this.cropContainer = document.createElement('div');\r\n    this.cropContainer.classList.add('crop');\r\n    this.cropContainer.append(this.image);\r\n\r\n    this.input = document.createElement('input');\r\n    this.input.type = 'file';\r\n    this.input.style.display = 'none';\r\n    this.input.addEventListener('change', (e: any) => {\r\n      const file = e.target.files[0];\r\n      if(!file) {\r\n        return;\r\n      }\r\n  \r\n      const reader = new FileReader();\r\n      reader.onload = (e) => {\r\n        const contents = e.target.result as string;\r\n        \r\n        this.image = new Image();\r\n        this.cropContainer.append(this.image);\r\n        this.image.src = contents;\r\n  \r\n        this.image.onload = () => {\r\n          /* let {w, h} = calcImageInBox(this.image.naturalWidth, this.image.naturalHeight, 460, 554);\r\n          cropContainer.style.width = w + 'px';\r\n          cropContainer.style.height = h + 'px'; */\r\n          this.show();\r\n  \r\n          this.cropper = resizeableImage(this.image, this.canvas);\r\n          this.input.value = '';\r\n        };\r\n      };\r\n  \r\n      reader.readAsDataURL(file);\r\n    }, false);\r\n\r\n    this.btnSubmit = document.createElement('button');\r\n    this.btnSubmit.className = 'btn-primary btn-color-primary btn-circle btn-crop btn-icon tgico-check z-depth-1';\r\n    ripple(this.btnSubmit);\r\n    this.btnSubmit.addEventListener('click', () => {\r\n      this.cropper.crop();\r\n      this.btnClose.click();\r\n\r\n      this.canvas.toBlob(blob => {\r\n        this.blob = blob; // save blob to send after reg\r\n        this.darkenCanvas();\r\n        this.resolve();\r\n      }, 'image/jpeg', 1);\r\n    });\r\n\r\n    this.container.append(this.cropContainer, this.btnSubmit, this.input);\r\n\r\n    this.onCloseAfterTimeout = () => {\r\n      this.cropper.removeHandlers();\r\n      if(this.image) {\r\n        this.image.remove();\r\n      }\r\n    };\r\n  }\r\n\r\n  private resolve() {\r\n    this.onCrop(() => {\r\n      return appDownloadManager.upload(this.blob);\r\n    });\r\n  }\r\n\r\n  public open(postCanvas: HTMLCanvasElement, onCrop: PopupAvatar['onCrop']) {\r\n    this.canvas = postCanvas;\r\n    this.onCrop = onCrop;\r\n\r\n    this.input.click();\r\n  }\r\n\r\n  public darkenCanvas() {\r\n    let ctx = this.canvas.getContext('2d');\r\n    ctx.fillStyle = \"rgba(0, 0, 0, 0.3)\";\r\n    ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n  }\r\n}\r\n","'use strict'\r\n//@flow\r\n\r\n/** * * * * * * * * * *\r\n * Big Integer Library *\r\n * Created 2000        *\r\n * Leemon Baird        *\r\n * www.leemon.com      *\r\n * * * * * * * * * * * */\r\n\r\n////////////////////////////////////////////////////////////////////////////////////////\r\n// These functions are designed to avoid frequent dynamic memory allocation in the inner loop.\r\n// For most functions, if it needs a BigInt as a local variable it will actually use\r\n// a global, and will only allocate to it only when it's not the right size.  This ensures\r\n// that when a function is called repeatedly with same-sized parameters, it only allocates\r\n// memory on the first call.\r\n//\r\n// Note that for cryptographic purposes, the calls to Math.random() must\r\n// be replaced with calls to a better pseudorandom number generator.\r\n//\r\n// In the following, \"bigInt\" means a bigInt with at least one leading zero element,\r\n// and \"integer\" means a nonnegative integer less than radix.  In some cases, integer\r\n// can be negative.  Negative bigInts are 2s complement.\r\n//\r\n// The following functions do not modify their inputs.\r\n// Those returning a bigInt, string, or Array will dynamically allocate memory for that value.\r\n// Those returning a boolean will return the integer 0 (false) or 1 (true).\r\n// Those returning boolean or int will not allocate memory except possibly on the first\r\n// time they're called with a given parameter size.\r\n//\r\n// bigInt  add(x,y)               //return (x+y) for bigInts x and y.\r\n// bigInt  addInt(x,n)            //return (x+n) where x is a bigInt and n is an integer.\r\n// string  bigInt2str(x,base)     //return a string form of bigInt x in a given base, with 2 <= base <= 95\r\n// int     bitSize(x)             //return how many bits long the bigInt x is, not counting leading zeros\r\n// bigInt  dup(x)                 //return a copy of bigInt x\r\n// boolean equals(x,y)            //is the bigInt x equal to the bigint y?\r\n// boolean equalsInt(x,y)         //is bigint x equal to integer y?\r\n// bigInt  expand(x,n)            //return a copy of x with at least n elements, adding leading zeros if needed\r\n// Array   findPrimes(n)          //return array of all primes less than integer n\r\n// bigInt  GCD(x,y)               //return greatest common divisor of bigInts x and y (each with same number of elements).\r\n// boolean greater(x,y)           //is x>y?  (x and y are nonnegative bigInts)\r\n// boolean greaterShift(x,y,shift)//is (x <<(shift*bpe)) > y?\r\n// bigInt  int2bigInt(t,n,m)      //return a bigInt equal to integer t, with at least n bits and m array elements\r\n// bigInt  inverseMod(x,n)        //return (x**(-1) mod n) for bigInts x and n.  If no inverse exists, it returns null\r\n// int     inverseModInt(x,n)     //return x**(-1) mod n, for integers x and n.  Return 0 if there is no inverse\r\n// boolean isZero(x)              //is the bigInt x equal to zero?\r\n// boolean millerRabin(x,b)       //does one round of Miller-Rabin base integer b say that bigInt x is possibly prime? (b is bigInt, 1<b<x)\r\n// boolean millerRabinInt(x,b)    //does one round of Miller-Rabin base integer b say that bigInt x is possibly prime? (b is int,    1<b<x)\r\n// bigInt  mod(x,n)               //return a new bigInt equal to (x mod n) for bigInts x and n.\r\n// int     modInt(x,n)            //return x mod n for bigInt x and integer n.\r\n// bigInt  mult(x,y)              //return x*y for bigInts x and y. This is faster when y<x.\r\n// bigInt  multMod(x,y,n)         //return (x*y mod n) for bigInts x,y,n.  For greater speed, let y<x.\r\n// boolean negative(x)            //is bigInt x negative?\r\n// bigInt  powMod(x,y,n)          //return (x**y mod n) where x,y,n are bigInts and ** is exponentiation.  0**0=1. Faster for odd n.\r\n// bigInt  randBigInt(n,s)        //return an n-bit random BigInt (n>=1).  If s=1, then the most significant of those n bits is set to 1.\r\n// bigInt  randTruePrime(k)       //return a new, random, k-bit, true prime bigInt using Maurer's algorithm.\r\n// bigInt  randProbPrime(k)       //return a new, random, k-bit, probable prime bigInt (probability it's composite less than 2^-80).\r\n// bigInt  str2bigInt(s,b,n,m)    //return a bigInt for number represented in string s in base b with at least n bits and m array elements\r\n// bigInt  sub(x,y)               //return (x-y) for bigInts x and y.  Negative answers will be 2s complement\r\n// bigInt  trim(x,k)              //return a copy of x with exactly k leading zero elements\r\n//\r\n//\r\n// The following functions each have a non-underscored version, which most users should call instead.\r\n// These functions each write to a single parameter, and the caller is responsible for ensuring the array\r\n// passed in is large enough to hold the result.\r\n//\r\n// void    addInt_(x,n)          //do x=x+n where x is a bigInt and n is an integer\r\n// void    add_(x,y)             //do x=x+y for bigInts x and y\r\n// void    copy_(x,y)            //do x=y on bigInts x and y\r\n// void    copyInt_(x,n)         //do x=n on bigInt x and integer n\r\n// void    GCD_(x,y)             //set x to the greatest common divisor of bigInts x and y, (y is destroyed).  (This never overflows its array).\r\n// boolean inverseMod_(x,n)      //do x=x**(-1) mod n, for bigInts x and n. Returns 1 (0) if inverse does (doesn't) exist\r\n// void    mod_(x,n)             //do x=x mod n for bigInts x and n. (This never overflows its array).\r\n// void    mult_(x,y)            //do x=x*y for bigInts x and y.\r\n// void    multMod_(x,y,n)       //do x=x*y  mod n for bigInts x,y,n.\r\n// void    powMod_(x,y,n)        //do x=x**y mod n, where x,y,n are bigInts (n is odd) and ** is exponentiation.  0**0=1.\r\n// void    randBigInt_(b,n,s)    //do b = an n-bit random BigInt. if s=1, then nth bit (most significant bit) is set to 1. n>=1.\r\n// void    randTruePrime_(ans,k) //do ans = a random k-bit true random prime (not just probable prime) with 1 in the msb.\r\n// void    sub_(x,y)             //do x=x-y for bigInts x and y. Negative answers will be 2s complement.\r\n//\r\n// The following functions do NOT have a non-underscored version.\r\n// They each write a bigInt result to one or more parameters.  The caller is responsible for\r\n// ensuring the arrays passed in are large enough to hold the results.\r\n//\r\n// void addShift_(x,y,ys)       //do x=x+(y<<(ys*bpe))\r\n// void carry_(x)               //do carries and borrows so each element of the bigInt x fits in bpe bits.\r\n// void divide_(x,y,q,r)        //divide x by y giving quotient q and remainder r\r\n// int  divInt_(x,n)            //do x=floor(x/n) for bigInt x and integer n, and return the remainder. (This never overflows its array).\r\n// void eGCD_(x,y,d,a,b)        //sets a,b,d to positive bigInts such that d = GCD_(x,y) = a*x-b*y\r\n// void halve_(x)               //do x=floor(|x|/2)*sgn(x) for bigInt x in 2's complement.  (This never overflows its array).\r\n// void leftShift_(x,n)         //left shift bigInt x by n bits.  n<bpe.\r\n// void linComb_(x,y,a,b)       //do x=a*x+b*y for bigInts x and y and integers a and b\r\n// void linCombShift_(x,y,b,ys) //do x=x+b*(y<<(ys*bpe)) for bigInts x and y, and integers b and ys\r\n// void mont_(x,y,n,np)         //Montgomery multiplication (see comments where the function is defined)\r\n// void multInt_(x,n)           //do x=x*n where x is a bigInt and n is an integer.\r\n// void rightShift_(x,n)        //right shift bigInt x by n bits.  0 <= n < bpe. (This never overflows its array).\r\n// void squareMod_(x,n)         //do x=x*x  mod n for bigInts x,n\r\n// void subShift_(x,y,ys)       //do x=x-(y<<(ys*bpe)). Negative answers will be 2s complement.\r\n//\r\n// The following functions are based on algorithms from the _Handbook of Applied Cryptography_\r\n//    powMod_()           = algorithm 14.94, Montgomery exponentiation\r\n//    eGCD_,inverseMod_() = algorithm 14.61, Binary extended GCD_\r\n//    GCD_()              = algorothm 14.57, Lehmer's algorithm\r\n//    mont_()             = algorithm 14.36, Montgomery multiplication\r\n//    divide_()           = algorithm 14.20  Multiple-precision division\r\n//    squareMod_()        = algorithm 14.16  Multiple-precision squaring\r\n//    randTruePrime_()    = algorithm  4.62, Maurer's algorithm\r\n//    millerRabin()       = algorithm  4.24, Miller-Rabin algorithm\r\n//\r\n// Profiling shows:\r\n//     randTruePrime_() spends:\r\n//         10% of its time in calls to powMod_()\r\n//         85% of its time in calls to millerRabin()\r\n//     millerRabin() spends:\r\n//         99% of its time in calls to powMod_()   (always with a base of 2)\r\n//     powMod_() spends:\r\n//         94% of its time in calls to mont_()  (almost always with x==y)\r\n//\r\n// This suggests there are several ways to speed up this library slightly:\r\n//     - convert powMod_ to use a Montgomery form of k-ary window (or maybe a Montgomery form of sliding window)\r\n//         -- this should especially focus on being fast when raising 2 to a power mod n\r\n//     - convert randTruePrime_() to use a minimum r of 1/3 instead of 1/2 with the appropriate change to the test\r\n//     - tune the parameters in randTruePrime_(), including c, m, and recLimit\r\n//     - speed up the single loop in mont_() that takes 95% of the runtime, perhaps by reducing checking\r\n//       within the loop when all the parameters are the same length.\r\n//\r\n// There are several ideas that look like they wouldn't help much at all:\r\n//     - replacing trial division in randTruePrime_() with a sieve (that speeds up something taking almost no time anyway)\r\n//     - increase bpe from 15 to 30 (that would help if we had a 32*32->64 multiplier, but not with JavaScript's 32*32->32)\r\n//     - speeding up mont_(x,y,n,np) when x==y by doing a non-modular, non-Montgomery square\r\n//       followed by a Montgomery reduction.  The intermediate answer will be twice as long as x, so that\r\n//       method would be slower.  This is unfortunate because the code currently spends almost all of its time\r\n//       doing mont_(x,x,...), both for randTruePrime_() and powMod_().  A faster method for Montgomery squaring\r\n//       would have a large impact on the speed of randTruePrime_() and powMod_().  HAC has a couple of poorly-worded\r\n//       sentences that seem to imply it's faster to do a non-modular square followed by a single\r\n//       Montgomery reduction, but that's obviously wrong.\r\n////////////////////////////////////////////////////////////////////////////////////////\r\n\r\nexport type Bool = 1 | 0\r\n\r\n//globals\r\nexport var bpe = 0 //bits stored per array element\r\nvar mask = 0 //AND this with an array element to chop it down to bpe bits\r\nvar radix = mask + 1 //equals 2^bpe.  A single 1 bit to the left of the last bit of mask.\r\n\r\n//the digits for converting to different bases\r\nvar digitsStr =\r\n  '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_=!@#$%^&*()[]{}|;:,.<>/?`~ \\\\\\'\"+-'\r\n\r\n//initialize the global variables\r\n\r\n//bpe=number of bits in the mantissa on this platform\r\nfor (bpe = 0; 1 << (bpe + 1) > 1 << bpe; bpe++);\r\nbpe >>= 1 //bpe=number of bits in one element of the array representing the bigInt\r\nmask = (1 << bpe) - 1 //AND the mask with an integer to get its bpe least significant bits\r\nradix = mask + 1 //2^bpe.  a single 1 bit to the left of the first bit of mask\r\nexport var one = int2bigInt(1, 1, 1) //constant used in powMod_()\r\nexport var zero = int2bigInt(0, 1, 1)\r\n\r\n//the following global variables are scratchpad memory to\r\n//reduce dynamic memory allocation in the inner loop\r\nvar t: number[] | number = new Array(0)\r\nvar ss = t //used in mult_()\r\nvar s0 = t //used in multMod_(), squareMod_()\r\n// var s1=t;    //used in powMod_(), multMod_(), squareMod_()\r\n// var s2=t;    //used in powMod_(), multMod_()\r\nvar s3 = t //used in powMod_()\r\nvar s4 = t,\r\n    s5 = t //used in mod_()\r\nvar s6 = t //used in bigInt2str()\r\nvar s7 = t //used in powMod_()\r\nvar T = t //used in GCD_()\r\nvar sa = t //used in mont_()\r\nvar mr_x1 = t,\r\n    mr_r = t,\r\n    mr_a = t, //used in millerRabin()\r\n    eg_v = t,\r\n    eg_u = t,\r\n    eg_A = t,\r\n    eg_B = t,\r\n    eg_C = t,\r\n    eg_D = t, //used in eGCD_(), inverseMod_()\r\n    //, md_q1=t, md_q2=t, md_q3=t, md_r=t, md_r1=t, md_r2=t, md_tt=t, //used in mod_()\r\n\r\n    primes = t,\r\n    pows = t,\r\n    s_i = t,\r\n    s_i2 = t,\r\n    s_R = t,\r\n    s_rm = t,\r\n    s_q = t,\r\n    s_n1 = t,\r\n    s_a = t,\r\n    s_r2 = t,\r\n    s_n = t,\r\n    s_b = t,\r\n    s_d = t,\r\n    s_x1 = t,\r\n    s_x2 = t,\r\n    s_aa = t, //used in randTruePrime_()\r\n    rpprb = t //used in randProbPrimeRounds() (which also uses \"primes\")\r\n\r\n////////////////////////////////////////////////////////////////////////////////////////\r\n\r\nvar k, buff\r\n\r\n/**\r\n * return array of all primes less than integer n\r\n *\r\n * @param {number} n\r\n * @returns {number[]}\r\n */\r\nexport function findPrimes(n: number): number[] {\r\n  var i, s, p, ans\r\n  s = new Array(n)\r\n  for (i = 0; i < n; i++) s[i] = 0\r\n  s[0] = 2\r\n  p = 0 //first p elements of s are primes, the rest are a sieve\r\n  for (; s[p] < n; ) {\r\n    //s[p] is the pth prime\r\n    for (\r\n      i = s[p] * s[p];\r\n      i < n;\r\n      i += s[p] //mark multiples of s[p]\r\n    )\r\n      s[i] = 1\r\n    p++\r\n    s[p] = s[p - 1] + 1\r\n    for (; s[p] < n && s[s[p]]; s[p]++); //find next prime (where s[p]==0)\r\n  }\r\n  ans = new Array(p)\r\n  for (i = 0; i < p; i++) ans[i] = s[i]\r\n  return ans\r\n}\r\n\r\n/**\r\n * does a single round of Miller-Rabin base b consider x to be a possible prime?\r\n *\r\n * x is a bigInt, and b is an integer, with b<x\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} b\r\n * @returns {(0 | 1)}\r\n */\r\nexport function millerRabinInt(x: number[], b: number): Bool {\r\n  if (mr_x1.length !== x.length) {\r\n    mr_x1 = dup(x)\r\n    mr_r = dup(x)\r\n    mr_a = dup(x)\r\n  }\r\n\r\n  copyInt_(mr_a, b)\r\n  return millerRabin(x, mr_a)\r\n}\r\n\r\n/**\r\n * does a single round of Miller-Rabin base b consider x to be a possible prime?\r\n *\r\n * x and b are bigInts with b<x\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} b\r\n * @returns {(0 | 1)}\r\n */\r\nexport function millerRabin(x: number[], b: number[]): Bool {\r\n  var i, j, k, s\r\n\r\n  if (mr_x1.length !== x.length) {\r\n    mr_x1 = dup(x)\r\n    mr_r = dup(x)\r\n    mr_a = dup(x)\r\n  }\r\n\r\n  copy_(mr_a, b)\r\n  copy_(mr_r, x)\r\n  copy_(mr_x1, x)\r\n\r\n  addInt_(mr_r, -1)\r\n  addInt_(mr_x1, -1)\r\n\r\n  //s=the highest power of two that divides mr_r\r\n  k = 0\r\n  for (i = 0; i < mr_r.length; i++)\r\n    for (j = 1; j < mask; j <<= 1)\r\n      if (x[i] & j) {\r\n        s = k < mr_r.length + bpe ? k : 0\r\n        i = mr_r.length\r\n        j = mask\r\n      } else k++\r\n\r\n  if (s) rightShift_(mr_r, s)\r\n\r\n  powMod_(mr_a, mr_r, x)\r\n\r\n  if (!equalsInt(mr_a, 1) && !equals(mr_a, mr_x1)) {\r\n    j = 1\r\n    //$off\r\n    while (j <= s - 1 && !equals(mr_a, mr_x1)) {\r\n      squareMod_(mr_a, x)\r\n      if (equalsInt(mr_a, 1)) {\r\n        return 0\r\n      }\r\n      j++\r\n    }\r\n    if (!equals(mr_a, mr_x1)) {\r\n      return 0\r\n    }\r\n  }\r\n  return 1\r\n}\r\n\r\n/**\r\n * returns how many bits long the bigInt is, not counting leading zeros.\r\n *\r\n * @param {number[]} x\r\n * @returns {number}\r\n */\r\nexport function bitSize(x: number[]): number {\r\n  var j, z, w\r\n  for (j = x.length - 1; x[j] == 0 && j > 0; j--);\r\n  for (z = 0, w = x[j]; w; w >>= 1, z++);\r\n  z += bpe * j\r\n  return z\r\n}\r\n\r\n/**\r\n * return a copy of x with at least n elements, adding leading zeros if needed\r\n *\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {number[]}\r\n */\r\nexport function expand(x: number[], n: number): number[] {\r\n  var ans = int2bigInt(0, (x.length > n ? x.length : n) * bpe, 0)\r\n  copy_(ans, x)\r\n  return ans\r\n}\r\n\r\n/**\r\n * return a k-bit true random prime using Maurer's algorithm.\r\n *\r\n * @export\r\n * @param {number} k\r\n * @returns {number[]}\r\n */\r\nexport function randTruePrime(k: number): number[] {\r\n  var ans = int2bigInt(0, k, 0)\r\n  randTruePrime_(ans, k)\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * return a k-bit random probable prime with probability of error < 2^-80\r\n *\r\n * @export\r\n * @param {number} k\r\n * @returns {number[]}\r\n */\r\nexport function randProbPrime(k: number): number[] {\r\n  if (k >= 600) return randProbPrimeRounds(k, 2) //numbers from HAC table 4.3\r\n  if (k >= 550) return randProbPrimeRounds(k, 4)\r\n  if (k >= 500) return randProbPrimeRounds(k, 5)\r\n  if (k >= 400) return randProbPrimeRounds(k, 6)\r\n  if (k >= 350) return randProbPrimeRounds(k, 7)\r\n  if (k >= 300) return randProbPrimeRounds(k, 9)\r\n  if (k >= 250) return randProbPrimeRounds(k, 12) //numbers from HAC table 4.4\r\n  if (k >= 200) return randProbPrimeRounds(k, 15)\r\n  if (k >= 150) return randProbPrimeRounds(k, 18)\r\n  if (k >= 100) return randProbPrimeRounds(k, 27)\r\n  return randProbPrimeRounds(k, 40) //number from HAC remark 4.26 (only an estimate)\r\n}\r\n\r\n/**\r\n * return a k-bit probable random prime using n rounds of Miller Rabin\r\n * (after trial division with small primes)\r\n *\r\n * @export\r\n * @param {number} k\r\n * @param {number} n\r\n * @returns {number[]}\r\n */\r\nexport function randProbPrimeRounds(k: number, n: number): number[] {\r\n  var ans, i, divisible, B\r\n  B = 30000 //B is largest prime to use in trial division\r\n  ans = int2bigInt(0, k, 0)\r\n\r\n  //optimization: try larger and smaller B to find the best limit.\r\n\r\n  if (primes.length === 0) primes = findPrimes(30000) //check for divisibility by primes <=30000\r\n\r\n  if (rpprb.length !== ans.length) rpprb = dup(ans)\r\n\r\n  for (;;) {\r\n    //keep trying random values for ans until one appears to be prime\r\n    //optimization: pick a random number times L=2*3*5*...*p, plus a\r\n    //   random element of the list of all numbers in [0,L) not divisible by any prime up to p.\r\n    //   This can reduce the amount of random number generation.\r\n\r\n    randBigInt_(ans, k, 0) //ans = a random odd number to check\r\n    ans[0] |= 1\r\n    divisible = 0\r\n\r\n    //check ans for divisibility by small primes up to B\r\n    for (i = 0; i < primes.length && primes[i] <= B; i++)\r\n      if (modInt(ans, primes[i]) === 0 && !equalsInt(ans, primes[i])) {\r\n        divisible = 1\r\n        break\r\n      }\r\n\r\n    //optimization: change millerRabin so the base can be bigger than the number being checked, then eliminate the while here.\r\n\r\n    //do n rounds of Miller Rabin, with random bases less than ans\r\n    for (i = 0; i < n && !divisible; i++) {\r\n      randBigInt_(rpprb, k, 0)\r\n      while (\r\n        !greater(ans, rpprb) //pick a random rpprb that's < ans\r\n      )\r\n        randBigInt_(rpprb, k, 0)\r\n      if (!millerRabin(ans, rpprb)) divisible = 1\r\n    }\r\n\r\n    if (!divisible) return ans\r\n  }\r\n  /*::\r\n  declare var never: empty\r\n  return never\r\n  */\r\n}\r\n\r\n/**\r\n * return a new bigInt equal to (x mod n) for bigInts x and n.\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} n\r\n * @returns {number[]}\r\n */\r\nexport function mod(x: number[], n: number[]): number[] {\r\n  var ans = dup(x)\r\n  mod_(ans, n)\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * return (x+n) where x is a bigInt and n is an integer.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {number[]}\r\n */\r\nexport function addInt(x: number[], n: number): number[] {\r\n  var ans = expand(x, x.length + 1)\r\n  addInt_(ans, n)\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * return x*y for bigInts x and y. This is faster when y<x.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @returns {number[]}\r\n */\r\nexport function mult(x: number[], y: number[]): number[] {\r\n  var ans = expand(x, x.length + y.length)\r\n  mult_(ans, y)\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * return (x**y mod n) where x,y,n are bigInts and ** is exponentiation.\r\n *\r\n * 0**0=1.\r\n *\r\n * Faster for odd n.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number[]} n\r\n * @returns {number[]}\r\n */\r\nexport function powMod(x: number[], y: number[], n: number[]): number[] {\r\n  var ans = expand(x, n.length)\r\n  powMod_(\r\n    //this should work without the trim, but doesn't\r\n    ans,\r\n    trim(y, 2),\r\n    trim(n, 2),\r\n  )\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * Simple pow with no optimizations (in 40x times slower than jsbn's pow)\r\n * @param x bigInt\r\n * @param e\r\n */\r\nexport function pow(x: number[], e: number) {\r\n  let ans = dup(x);\r\n  e -= 1;\r\n  for(let i = 0; i < e; ++i) {\r\n    ans = mult(ans, x);\r\n  }\r\n  return trim(ans, 1);\r\n}\r\n\r\n/**\r\n * return (x-y) for bigInts x and y\r\n *\r\n * Negative answers will be 2s complement\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @returns {number[]}\r\n */\r\nexport function sub(x: number[], y: number[]): number[] {\r\n  var ans = expand(x, x.length > y.length ? x.length + 1 : y.length + 1)\r\n  sub_(ans, y)\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * return (x+y) for bigInts x and y\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @returns {number[]}\r\n */\r\nexport function add(x: number[], y: number[]): number[] {\r\n  var ans = expand(x, x.length > y.length ? x.length + 1 : y.length + 1)\r\n  add_(ans, y)\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * return (x**(-1) mod n) for bigInts x and n.\r\n *\r\n * If no inverse exists, it returns null\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} n\r\n * @returns {(number[] | null)}\r\n */\r\nexport function inverseMod(x: number[], n: number[]): number[] | null {\r\n  var ans = expand(x, n.length)\r\n  var s = inverseMod_(ans, n)\r\n  return s ? trim(ans, 1) : null\r\n}\r\n\r\n/**\r\n * return (x*y mod n) for bigInts x,y,n.\r\n *\r\n * For greater speed, let y<x.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number[]} n\r\n * @returns {number[]}\r\n */\r\nexport function multMod(x: number[], y: number[], n: number[]): number[] {\r\n  var ans = expand(x, n.length)\r\n  multMod_(ans, y, n)\r\n  return trim(ans, 1)\r\n}\r\n\r\n/**\r\n * generate a k-bit true random prime using Maurer's algorithm, and put it into ans.\r\n *\r\n * The bigInt ans must be large enough to hold it.\r\n *\r\n * @export\r\n * @param {number[]} ans\r\n * @param {number} k\r\n * @return {void}\r\n */\r\nexport function randTruePrime_(ans: number[], k: number): void {\r\n  var c, m, pm, dd, j, r, B, divisible, z, zz, recSize\r\n  var w\r\n  if (primes.length == 0) primes = findPrimes(30000) //check for divisibility by primes <=30000\r\n\r\n  if (pows.length == 0) {\r\n    pows = new Array(512)\r\n    for (j = 0; j < 512; j++) {\r\n      pows[j] = Math.pow(2, j / 511 - 1)\r\n    }\r\n  }\r\n\r\n  //c and m should be tuned for a particular machine and value of k, to maximize speed\r\n  c = 0.1 //c=0.1 in HAC\r\n  m = 20 //generate this k-bit number by first recursively generating a number that has between k/2 and k-m bits\r\n  var recLimit = 20 //stop recursion when k <=recLimit.  Must have recLimit >= 2\r\n\r\n  if (s_i2.length != ans.length) {\r\n    s_i2 = dup(ans)\r\n    s_R = dup(ans)\r\n    s_n1 = dup(ans)\r\n    s_r2 = dup(ans)\r\n    s_d = dup(ans)\r\n    s_x1 = dup(ans) //TODO Seems like a bug in eslint, reports as unused\r\n    s_x2 = dup(ans)\r\n    s_b = dup(ans)\r\n    s_n = dup(ans)\r\n    s_i = dup(ans)\r\n    s_rm = dup(ans)\r\n    s_q = dup(ans)\r\n    s_a = dup(ans)\r\n    s_aa = dup(ans)\r\n  }\r\n\r\n  if (k <= recLimit) {\r\n    //generate small random primes by trial division up to its square root\r\n    pm = (1 << ((k + 2) >> 1)) - 1 //pm is binary number with all ones, just over sqrt(2^k)\r\n    copyInt_(ans, 0)\r\n    for (dd = 1; dd; ) {\r\n      dd = 0\r\n      ans[0] = 1 | (1 << (k - 1)) | Math.floor(Math.random() * (1 << k)) //random, k-bit, odd integer, with msb 1\r\n      for (j = 1; j < primes.length && (primes[j] & pm) == primes[j]; j++) {\r\n        //trial division by all primes 3...sqrt(2^k)\r\n        if (0 == ans[0] % primes[j]) {\r\n          dd = 1\r\n          break\r\n        }\r\n      }\r\n    }\r\n    carry_(ans)\r\n    return\r\n  }\r\n\r\n  B = c * k * k //try small primes up to B (or all the primes[] array if the largest is less than B).\r\n  if (k > 2 * m)\r\n    //generate this k-bit number by first recursively generating a number that has between k/2 and k-m bits\r\n    for (r = 1; k - k * r <= m; ) r = pows[Math.floor(Math.random() * 512)] //r=Math.pow(2,Math.random()-1);\r\n  else r = 0.5\r\n\r\n  //simulation suggests the more complex algorithm using r=.333 is only slightly faster.\r\n\r\n  recSize = Math.floor(r * k) + 1\r\n\r\n  randTruePrime_(s_q, recSize)\r\n  copyInt_(s_i2, 0)\r\n  s_i2[Math.floor((k - 2) / bpe)] |= 1 << ((k - 2) % bpe) //s_i2=2^(k-2)\r\n  divide_(s_i2, s_q, s_i, s_rm) //s_i=floor((2^(k-1))/(2q))\r\n\r\n  z = bitSize(s_i)\r\n\r\n  for (;;) {\r\n    for (;;) {\r\n      //generate z-bit numbers until one falls in the range [0,s_i-1]\r\n      randBigInt_(s_R, z, 0)\r\n      if (greater(s_i, s_R)) break\r\n    } //now s_R is in the range [0,s_i-1]\r\n    addInt_(s_R, 1) //now s_R is in the range [1,s_i]\r\n    add_(s_R, s_i) //now s_R is in the range [s_i+1,2*s_i]\r\n\r\n    copy_(s_n, s_q)\r\n    mult_(s_n, s_R)\r\n    multInt_(s_n, 2)\r\n    addInt_(s_n, 1) //s_n=2*s_R*s_q+1\r\n\r\n    copy_(s_r2, s_R)\r\n    multInt_(s_r2, 2) //s_r2=2*s_R\r\n\r\n    //check s_n for divisibility by small primes up to B\r\n    for (divisible = 0, j = 0; j < primes.length && primes[j] < B; j++)\r\n      if (modInt(s_n, primes[j]) == 0 && !equalsInt(s_n, primes[j])) {\r\n        divisible = 1\r\n        break\r\n      }\r\n\r\n    if (!divisible)\r\n      if (!millerRabinInt(s_n, 2))\r\n        //if it passes small primes check, then try a single Miller-Rabin base 2\r\n        //this line represents 75% of the total runtime for randTruePrime_\r\n        divisible = 1\r\n\r\n    if (!divisible) {\r\n      //if it passes that test, continue checking s_n\r\n      addInt_(s_n, -3)\r\n      for (j = s_n.length - 1; s_n[j] == 0 && j > 0; j--); //strip leading zeros\r\n      for (zz = 0, w = s_n[j]; w; w >>= 1, zz++);\r\n      zz += bpe * j //zz=number of bits in s_n, ignoring leading zeros\r\n      for (;;) {\r\n        //generate z-bit numbers until one falls in the range [0,s_n-1]\r\n        randBigInt_(s_a, zz, 0)\r\n        if (greater(s_n, s_a)) break\r\n      } //now s_a is in the range [0,s_n-1]\r\n      addInt_(s_n, 3) //now s_a is in the range [0,s_n-4]\r\n      addInt_(s_a, 2) //now s_a is in the range [2,s_n-2]\r\n      copy_(s_b, s_a)\r\n      copy_(s_n1, s_n)\r\n      addInt_(s_n1, -1)\r\n      powMod_(s_b, s_n1, s_n) //s_b=s_a^(s_n-1) modulo s_n\r\n      addInt_(s_b, -1)\r\n      if (isZero(s_b)) {\r\n        copy_(s_b, s_a)\r\n        powMod_(s_b, s_r2, s_n)\r\n        addInt_(s_b, -1)\r\n        copy_(s_aa, s_n)\r\n        copy_(s_d, s_b)\r\n        GCD_(s_d, s_n) //if s_b and s_n are relatively prime, then s_n is a prime\r\n        if (equalsInt(s_d, 1)) {\r\n          copy_(ans, s_aa)\r\n          return //if we've made it this far, then s_n is absolutely guaranteed to be prime\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Return an n-bit random BigInt (n>=1).  If s=1, then the most significant of those n bits is set to 1.\r\n *\r\n * @export\r\n * @param {number} n\r\n * @param {number} s\r\n * @returns {number[]}\r\n */\r\nexport function randBigInt(n: number, s: number): number[] {\r\n  var a, b\r\n  a = Math.floor((n - 1) / bpe) + 2 //# array elements to hold the BigInt with a leading 0 element\r\n  b = int2bigInt(0, 0, a)\r\n  randBigInt_(b, n, s)\r\n  return b\r\n}\r\n\r\n/**\r\n * Set b to an n-bit random BigInt.  If s=1, then the most significant of those n bits is set to 1.\r\n *\r\n * Array b must be big enough to hold the result. Must have n>=1\r\n *\r\n * @export\r\n * @param {number[]} b\r\n * @param {number} n\r\n * @param {number} s\r\n * @return {void}\r\n */\r\nexport function randBigInt_(b: number[], n: number, s: number): void {\r\n  var i, a\r\n  for (i = 0; i < b.length; i++) b[i] = 0\r\n  a = Math.floor((n - 1) / bpe) + 1 //# array elements to hold the BigInt\r\n  for (i = 0; i < a; i++) {\r\n    b[i] = Math.floor(Math.random() * (1 << (bpe - 1)))\r\n  }\r\n  b[a - 1] &= (2 << ((n - 1) % bpe)) - 1\r\n  if (s == 1) b[a - 1] |= 1 << ((n - 1) % bpe)\r\n}\r\n\r\n/**\r\n * Return the greatest common divisor of bigInts x and y (each with same number of elements).\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @returns {number[]}\r\n */\r\nexport function GCD(x: number[], y: number[]): number[] {\r\n  var xc, yc\r\n  xc = dup(x)\r\n  yc = dup(y)\r\n  GCD_(xc, yc)\r\n  return xc\r\n}\r\n\r\n/**\r\n * set x to the greatest common divisor of bigInts x and y (each with same number of elements).\r\n *\r\n * y is destroyed.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n */\r\nexport function GCD_(x: number[], y: number[]): void {\r\n  var i: number, xp: number, yp: number, A: number, B, C: number, D: number, q, sing\r\n  var qp\r\n  if (T.length !== x.length) T = dup(x)\r\n\r\n  sing = 1\r\n  while (sing) {\r\n    //while y has nonzero elements other than y[0]\r\n    sing = 0\r\n    for (\r\n      i = 1;\r\n      i < y.length;\r\n      i++ //check if y has nonzero elements other than 0\r\n    )\r\n      if (y[i]) {\r\n        sing = 1\r\n        break\r\n      }\r\n    if (!sing) break //quit when y all zero elements except possibly y[0]\r\n\r\n    for (i = x.length; !x[i] && i >= 0; i--); //find most significant element of x\r\n    xp = x[i]\r\n    yp = y[i]\r\n    A = 1\r\n    B = 0\r\n    C = 0\r\n    D = 1\r\n    while (yp + C && yp + D) {\r\n      q = Math.floor((xp + A) / (yp + C))\r\n      qp = Math.floor((xp + B) / (yp + D))\r\n      if (q != qp) break\r\n      t = A - q * C\r\n      A = C\r\n      C = t //  do (A,B,xp, C,D,yp) = (C,D,yp, A,B,xp) - q*(0,0,0, C,D,yp)\r\n      t = B - q * D\r\n      B = D\r\n      D = t\r\n      t = xp - q * yp\r\n      xp = yp\r\n      yp = t\r\n    }\r\n    if (B) {\r\n      copy_(T, x)\r\n      linComb_(x, y, A, B) //x=A*x+B*y\r\n      linComb_(y, T, D, C) //y=D*y+C*T\r\n    } else {\r\n      mod_(x, y)\r\n      copy_(T, x)\r\n      copy_(x, y)\r\n      copy_(y, T)\r\n    }\r\n  }\r\n  if (y[0] === 0) return\r\n  t = modInt(x, y[0])\r\n  copyInt_(x, y[0])\r\n  y[0] = t\r\n  while (y[0]) {\r\n    x[0] %= y[0]\r\n    t = x[0]\r\n    x[0] = y[0]\r\n    y[0] = t\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x**(-1) mod n, for bigInts x and n.\r\n *\r\n * If no inverse exists, it sets x to zero and returns 0, else it returns 1.\r\n * The x array must be at least as large as the n array.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} n\r\n * @returns {(0 | 1)}\r\n */\r\nexport function inverseMod_(x: number[], n: number[]): Bool {\r\n  var k = 1 + 2 * Math.max(x.length, n.length)\r\n\r\n  if (!(x[0] & 1) && !(n[0] & 1)) {\r\n    //if both inputs are even, then inverse doesn't exist\r\n    copyInt_(x, 0)\r\n    return 0\r\n  }\r\n\r\n  if (eg_u.length != k) {\r\n    eg_u = new Array(k)\r\n    eg_v = new Array(k)\r\n    eg_A = new Array(k)\r\n    eg_B = new Array(k)\r\n    eg_C = new Array(k)\r\n    eg_D = new Array(k)\r\n  }\r\n\r\n  copy_(eg_u, x)\r\n  copy_(eg_v, n)\r\n  copyInt_(eg_A, 1)\r\n  copyInt_(eg_B, 0)\r\n  copyInt_(eg_C, 0)\r\n  copyInt_(eg_D, 1)\r\n  for (;;) {\r\n    while (!(eg_u[0] & 1)) {\r\n      //while eg_u is even\r\n      halve_(eg_u)\r\n      if (!(eg_A[0] & 1) && !(eg_B[0] & 1)) {\r\n        //if eg_A==eg_B==0 mod 2\r\n        halve_(eg_A)\r\n        halve_(eg_B)\r\n      } else {\r\n        add_(eg_A, n)\r\n        halve_(eg_A)\r\n        sub_(eg_B, x)\r\n        halve_(eg_B)\r\n      }\r\n    }\r\n\r\n    while (!(eg_v[0] & 1)) {\r\n      //while eg_v is even\r\n      halve_(eg_v)\r\n      if (!(eg_C[0] & 1) && !(eg_D[0] & 1)) {\r\n        //if eg_C==eg_D==0 mod 2\r\n        halve_(eg_C)\r\n        halve_(eg_D)\r\n      } else {\r\n        add_(eg_C, n)\r\n        halve_(eg_C)\r\n        sub_(eg_D, x)\r\n        halve_(eg_D)\r\n      }\r\n    }\r\n\r\n    if (!greater(eg_v, eg_u)) {\r\n      //eg_v <= eg_u\r\n      sub_(eg_u, eg_v)\r\n      sub_(eg_A, eg_C)\r\n      sub_(eg_B, eg_D)\r\n    } else {\r\n      //eg_v > eg_u\r\n      sub_(eg_v, eg_u)\r\n      sub_(eg_C, eg_A)\r\n      sub_(eg_D, eg_B)\r\n    }\r\n\r\n    if (equalsInt(eg_u, 0)) {\r\n      while (\r\n        negative(eg_C) //make sure answer is nonnegative\r\n      )\r\n        add_(eg_C, n)\r\n      copy_(x, eg_C)\r\n\r\n      if (!equalsInt(eg_v, 1)) {\r\n        //if GCD_(x,n)!=1, then there is no inverse\r\n        copyInt_(x, 0)\r\n        return 0\r\n      }\r\n      return 1\r\n    }\r\n  }\r\n  /*::\r\n  declare var never: empty\r\n  return never\r\n  */\r\n}\r\n\r\n/**\r\n * return x**(-1) mod n, for integers x and n.\r\n *\r\n * Return 0 if there is no inverse\r\n *\r\n * @param {number} x\r\n * @param {number} n\r\n * @returns {number}\r\n */\r\nexport function inverseModInt(x: number, n: number): number {\r\n  var a = 1,\r\n      b = 0,\r\n      t\r\n  for (;;) {\r\n    if (x === 1) return a\r\n    if (x === 0) return 0\r\n    b -= a * Math.floor(n / x)\r\n    //$off\r\n    n %= x\r\n\r\n    if (n === 1) return b //to avoid negatives, change this b to n-b, and each -= to +=\r\n    if (n === 0) return 0\r\n    a -= b * Math.floor(x / n)\r\n    //$off\r\n    x %= n\r\n  }\r\n  /*::\r\n  declare var never: empty\r\n  return never\r\n  */\r\n}\r\n\r\n//this deprecated function is for backward compatibility only.\r\nfunction inverseModInt_(x: number, n: number) {\r\n  return inverseModInt(x, n)\r\n}\r\n\r\n/**\r\n * Given positive bigInts x and y, change the bigints v, a, and b to positive bigInts such that:\r\n *\r\n *      v = GCD_(x,y) = a*x-b*y\r\n *\r\n * The bigInts v, a, b, must have exactly as many elements as the larger of x and y.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number[]} v\r\n * @param {number[]} a\r\n * @param {number[]} b\r\n * @return {void}\r\n */\r\nexport function eGCD_(\r\n  x: number[],\r\n  y: number[],\r\n  v: number[],\r\n  a: number[],\r\n  b: number[],\r\n): void {\r\n  var g = 0\r\n  var k = Math.max(x.length, y.length)\r\n  if (eg_u.length != k) {\r\n    eg_u = new Array(k)\r\n    eg_A = new Array(k)\r\n    eg_B = new Array(k)\r\n    eg_C = new Array(k)\r\n    eg_D = new Array(k)\r\n  }\r\n  while (!(x[0] & 1) && !(y[0] & 1)) {\r\n    //while x and y both even\r\n    halve_(x)\r\n    halve_(y)\r\n    g++\r\n  }\r\n  copy_(eg_u, x)\r\n  copy_(v, y)\r\n  copyInt_(eg_A, 1)\r\n  copyInt_(eg_B, 0)\r\n  copyInt_(eg_C, 0)\r\n  copyInt_(eg_D, 1)\r\n  for (;;) {\r\n    while (!(eg_u[0] & 1)) {\r\n      //while u is even\r\n      halve_(eg_u)\r\n      if (!(eg_A[0] & 1) && !(eg_B[0] & 1)) {\r\n        //if A==B==0 mod 2\r\n        halve_(eg_A)\r\n        halve_(eg_B)\r\n      } else {\r\n        add_(eg_A, y)\r\n        halve_(eg_A)\r\n        sub_(eg_B, x)\r\n        halve_(eg_B)\r\n      }\r\n    }\r\n\r\n    while (!(v[0] & 1)) {\r\n      //while v is even\r\n      halve_(v)\r\n      if (!(eg_C[0] & 1) && !(eg_D[0] & 1)) {\r\n        //if C==D==0 mod 2\r\n        halve_(eg_C)\r\n        halve_(eg_D)\r\n      } else {\r\n        add_(eg_C, y)\r\n        halve_(eg_C)\r\n        sub_(eg_D, x)\r\n        halve_(eg_D)\r\n      }\r\n    }\r\n\r\n    if (!greater(v, eg_u)) {\r\n      //v<=u\r\n      sub_(eg_u, v)\r\n      sub_(eg_A, eg_C)\r\n      sub_(eg_B, eg_D)\r\n    } else {\r\n      //v>u\r\n      sub_(v, eg_u)\r\n      sub_(eg_C, eg_A)\r\n      sub_(eg_D, eg_B)\r\n    }\r\n    if (equalsInt(eg_u, 0)) {\r\n      while (negative(eg_C)) {\r\n        //make sure a (C) is nonnegative\r\n        add_(eg_C, y)\r\n        sub_(eg_D, x)\r\n      }\r\n      multInt_(eg_D, -1) ///make sure b (D) is nonnegative\r\n      copy_(a, eg_C)\r\n      copy_(b, eg_D)\r\n      leftShift_(v, g)\r\n      return\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * is bigInt x negative?\r\n *\r\n * @param {number[]} x\r\n * @returns {(1 | 0)}\r\n */\r\nexport function negative(x: number[]) {\r\n  //TODO Flow Bool type inference\r\n  return (x[x.length - 1] >> (bpe - 1)) & 1\r\n}\r\n\r\n/**\r\n * is (x << (shift*bpe)) > y?\r\n *\r\n * x and y are nonnegative bigInts\r\n * shift is a nonnegative integer\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number} shift\r\n * @returns {(1 | 0)}\r\n */\r\nexport function greaterShift(x: number[], y: number[], shift: number): Bool {\r\n  var i,\r\n      kx = x.length,\r\n      ky = y.length\r\n  k = kx + shift < ky ? kx + shift : ky\r\n  for (i = ky - 1 - shift; i < kx && i >= 0; i++) if (x[i] > 0) return 1 //if there are nonzeros in x to the left of the first column of y, then x is bigger\r\n  for (i = kx - 1 + shift; i < ky; i++) if (y[i] > 0) return 0 //if there are nonzeros in y to the left of the first column of x, then x is not bigger\r\n  for (i = k - 1; i >= shift; i--)\r\n    if (x[i - shift] > y[i]) return 1\r\n    else if (x[i - shift] < y[i]) return 0\r\n  return 0\r\n}\r\n\r\n/**\r\n * is x > y?\r\n *\r\n * x and y both nonnegative\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @returns {(1 | 0)}\r\n */\r\nexport function greater(x: number[], y: number[]): Bool {\r\n  var i\r\n  var k = x.length < y.length ? x.length : y.length\r\n\r\n  for (i = x.length; i < y.length; i++) if (y[i]) return 0 //y has more digits\r\n\r\n  for (i = y.length; i < x.length; i++) if (x[i]) return 1 //x has more digits\r\n\r\n  for (i = k - 1; i >= 0; i--)\r\n    if (x[i] > y[i]) return 1\r\n    else if (x[i] < y[i]) return 0\r\n  return 0\r\n}\r\n\r\n/**\r\n * divide x by y giving quotient q and remainder r.\r\n *\r\n *     q = floor(x/y)\r\n *     r = x mod y\r\n *\r\n * All 4 are bigints.\r\n *\r\n * * x must have at least one leading zero element.\r\n * * y must be nonzero.\r\n * * q and r must be arrays that are exactly the same length as x. (Or q can have more).\r\n * * Must have x.length >= y.length >= 2.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number[]} q\r\n * @param {number[]} r\r\n * @return {void}\r\n */\r\nexport function divide_(\r\n  x: number[],\r\n  y: number[],\r\n  q: number[],\r\n  r: number[],\r\n): void {\r\n  var kx, ky\r\n  var i, j, y1, y2, c, a, b\r\n  copy_(r, x)\r\n  for (ky = y.length; y[ky - 1] === 0; ky--); //ky is number of elements in y, not including leading zeros\r\n\r\n  //normalize: ensure the most significant element of y has its highest bit set\r\n  b = y[ky - 1]\r\n  for (a = 0; b; a++) b >>= 1\r\n  a = bpe - a //a is how many bits to shift so that the high order bit of y is leftmost in its array element\r\n  leftShift_(y, a) //multiply both by 1<<a now, then divide both by that at the end\r\n  leftShift_(r, a)\r\n\r\n  //Rob Visser discovered a bug: the following line was originally just before the normalization.\r\n  for (kx = r.length; r[kx - 1] === 0 && kx > ky; kx--); //kx is number of elements in normalized x, not including leading zeros\r\n\r\n  copyInt_(q, 0) // q=0\r\n  while (!greaterShift(y, r, kx - ky)) {\r\n    // while (leftShift_(y,kx-ky) <= r) {\r\n    subShift_(r, y, kx - ky) //   r=r-leftShift_(y,kx-ky)\r\n    q[kx - ky]++ //   q[kx-ky]++;\r\n  } // }\r\n\r\n  for (i = kx - 1; i >= ky; i--) {\r\n    if (r[i] == y[ky - 1]) q[i - ky] = mask\r\n    else q[i - ky] = Math.floor((r[i] * radix + r[i - 1]) / y[ky - 1])\r\n\r\n    //The following for(;;) loop is equivalent to the commented while loop,\r\n    //except that the uncommented version avoids overflow.\r\n    //The commented loop comes from HAC, which assumes r[-1]==y[-1]==0\r\n    //  while (q[i-ky]*(y[ky-1]*radix+y[ky-2]) > r[i]*radix*radix+r[i-1]*radix+r[i-2])\r\n    //    q[i-ky]--;\r\n    for (;;) {\r\n      y2 = (ky > 1 ? y[ky - 2] : 0) * q[i - ky]\r\n      c = y2 >> bpe\r\n      y2 = y2 & mask\r\n      y1 = c + q[i - ky] * y[ky - 1]\r\n      c = y1 >> bpe\r\n      y1 = y1 & mask\r\n\r\n      if (\r\n        c == r[i]\r\n          ? y1 == r[i - 1] ? y2 > (i > 1 ? r[i - 2] : 0) : y1 > r[i - 1]\r\n          : c > r[i]\r\n      )\r\n        q[i - ky]--\r\n      else break\r\n    }\r\n\r\n    linCombShift_(r, y, -q[i - ky], i - ky) //r=r-q[i-ky]*leftShift_(y,i-ky)\r\n    if (negative(r)) {\r\n      addShift_(r, y, i - ky) //r=r+leftShift_(y,i-ky)\r\n      q[i - ky]--\r\n    }\r\n  }\r\n\r\n  rightShift_(y, a) //undo the normalization step\r\n  rightShift_(r, a) //undo the normalization step\r\n}\r\n\r\n/**\r\n * do carries and borrows so each element of the bigInt x fits in bpe bits.\r\n *\r\n * @param {number[]} x\r\n */\r\nexport function carry_(x: number[]): void {\r\n  var i, k, c, b\r\n  k = x.length\r\n  c = 0\r\n  for (i = 0; i < k; i++) {\r\n    c += x[i]\r\n    b = 0\r\n    if (c < 0) {\r\n      b = -(c >> bpe)\r\n      c += b * radix\r\n    }\r\n    x[i] = c & mask\r\n    c = (c >> bpe) - b\r\n  }\r\n}\r\n\r\n/**\r\n * return x mod n for bigInt x and integer n.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {number}\r\n */\r\nexport function modInt(x: number[], n: number): number {\r\n  var i,\r\n      c = 0\r\n  for (i = x.length - 1; i >= 0; i--) c = (c * radix + x[i]) % n\r\n  return c\r\n}\r\n\r\n/**\r\n * convert the integer t into a bigInt with at least the given number of bits.\r\n * the returned array stores the bigInt in bpe-bit chunks, little endian (buff[0] is least significant word)\r\n * Pad the array with leading zeros so that it has at least minSize elements.\r\n *\r\n * There will always be at least one leading 0 element.\r\n *\r\n * @export\r\n * @param {number} t\r\n * @param {number} bits\r\n * @param {number} minSize\r\n * @returns {number[]}\r\n */\r\nexport function int2bigInt(t: number, bits: number, minSize: number): number[] {\r\n  var i, k\r\n  k = Math.ceil(bits / bpe) + 1\r\n  k = minSize > k ? minSize : k\r\n  var buff = new Array(k)\r\n  copyInt_(buff, t)\r\n  return buff\r\n}\r\n\r\n/**\r\n * return the bigInt given a string representation in a given base.\r\n * Pad the array with leading zeros so that it has at least minSize elements.\r\n * If base=-1, then it reads in a space-separated list of array elements in decimal.\r\n *\r\n * The array will always have at least one leading zero, unless base=-1.\r\n *\r\n * @export\r\n * @param {string} s\r\n * @param {number} base\r\n * @param {number} [minSize]\r\n * @returns {number[]}\r\n */\r\nexport function str2bigInt(\r\n  s: string,\r\n  base: number,\r\n  minSize?: number,\r\n): number[] {\r\n  var d, i, x, y, kk\r\n  var k = s.length\r\n  if (base === -1) {\r\n    //comma-separated list of array elements in decimal\r\n    x = new Array(0)\r\n    for (;;) {\r\n      y = new Array(x.length + 1)\r\n      for (i = 0; i < x.length; i++) y[i + 1] = x[i]\r\n      y[0] = parseInt(s, 10) //TODO PERF Should we replace that with ~~ (not not)? https://jsperf.com/number-vs-parseint-vs-plus/7\r\n      x = y\r\n      d = s.indexOf(',', 0)\r\n      if (d < 1) break\r\n      //$off\r\n      s = s.substring(d + 1)\r\n      if (s.length == 0) break\r\n    }\r\n    //$off\r\n    if (x.length < minSize) {\r\n      //$off\r\n      y = new Array(minSize)\r\n      copy_(y, x)\r\n      return y\r\n    }\r\n    return x\r\n  }\r\n\r\n  x = int2bigInt(0, base * k, 0)\r\n  for (i = 0; i < k; i++) {\r\n    d = digitsStr.indexOf(s.substring(i, i + 1), 0)\r\n    if (base <= 36 && d >= 36)\r\n      //convert lowercase to uppercase if base<=36\r\n      d -= 26\r\n    if (d >= base || d < 0) {\r\n      //stop at first illegal character\r\n      break\r\n    }\r\n    multInt_(x, base)\r\n    addInt_(x, d)\r\n  }\r\n\r\n  for (k = x.length; k > 0 && !x[k - 1]; k--); //strip off leading zeros\r\n  //$off\r\n  k = minSize > k + 1 ? minSize : k + 1\r\n  //$off\r\n  y = new Array(k)\r\n  //$off\r\n  kk = k < x.length ? k : x.length\r\n  //$off\r\n  for (i = 0; i < kk; i++) y[i] = x[i]\r\n  //$off\r\n  for (; i < k; i++) y[i] = 0\r\n  return y\r\n}\r\n\r\n//return the bigInt given a string representation in a given base.\r\n//Pad the array with leading zeros so that it has at least minSize elements.\r\n//If base=-1, then it reads in a space-separated list of array elements in decimal.\r\n//The array will always have at least one leading zero, unless base=-1.\r\n// function str2bigInt(s,b,minSize) {\r\n//   var d, i, j, base, str, x, y, kk;\r\n//   if (typeof b === 'string') {\r\n//           base = b.length;\r\n//           str = b;\r\n//   } else {\r\n//           base = b;\r\n//           str = digitsStr;\r\n//   }\r\n//   var k=s.length;\r\n//   if (base==-1) { //comma-separated list of array elements in decimal\r\n//       x=new Array(0);\r\n//       for (;;) {\r\n//           y=new Array(x.length+1);\r\n//           for (i=0;i<x.length;i++)\r\n//               y[i+1]=x[i];\r\n//           y[0]=parseInt(s,10);\r\n//           x=y;\r\n//           d=s.indexOf(',',0);\r\n//           if (d<1)\r\n//               break;\r\n//           s=s.substring(d+1);\r\n//           if (s.length==0)\r\n//               break;\r\n//       }\r\n//       if (x.length<minSize) {\r\n//           y=new Array(minSize);\r\n//           copy_(y,x);\r\n//           return y;\r\n//       }\r\n//       return x;\r\n//   }\r\n\r\n//   x=int2bigInt(0,base*k,0);\r\n// for (i=0;i<k;i++) {\r\n//   d=str.indexOf(s.substring(i,i+1),0);\r\n//   if (base<=36 && d>=36) { //convert lowercase to uppercase if base<=36\r\n//       d-=26;\r\n//   }\r\n//   if (d>=base || d<0) {   //ignore illegal characters\r\n//   continue;\r\n//       }\r\n//       multInt_(x,base);\r\n//       addInt_(x,d);\r\n//   }\r\n\r\n//   for (k=x.length;k>0 && !x[k-1];k--); //strip off leading zeros\r\n//   k=minSize>k+1 ? minSize : k+1;\r\n//   y=new Array(k);\r\n//   kk=k<x.length ? k : x.length;\r\n//   for (i=0;i<kk;i++)\r\n//       y[i]=x[i];\r\n//   for (;i<k;i++)\r\n//       y[i]=0;\r\n//   return y;\r\n// }\r\n\r\n/**\r\n * is bigint x equal to integer y?\r\n *\r\n * y must have less than bpe bits\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} y\r\n * @returns {(1 | 0)}\r\n */\r\nexport function equalsInt(x: number[], y: number): Bool {\r\n  var i\r\n  if (x[0] != y) return 0\r\n  for (i = 1; i < x.length; i++) if (x[i]) return 0\r\n  return 1\r\n}\r\n\r\n/**\r\n * are bigints x and y equal?\r\n *\r\n * this works even if x and y are different lengths and have arbitrarily many leading zeros\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @returns {(1 | 0)}\r\n */\r\nexport function equals(x: number[], y: number[]): Bool {\r\n  var i\r\n  var k = x.length < y.length ? x.length : y.length\r\n  for (i = 0; i < k; i++) if (x[i] !== y[i]) return 0\r\n  if (x.length > y.length) {\r\n    for (; i < x.length; i++) if (x[i]) return 0\r\n  } else {\r\n    for (; i < y.length; i++) if (y[i]) return 0\r\n  }\r\n  return 1\r\n}\r\n\r\n/**\r\n * is the bigInt x equal to zero?\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @returns {(1 | 0)}\r\n */\r\nexport function isZero(x: number[]): Bool {\r\n  var i\r\n  for (i = 0; i < x.length; i++) if (x[i]) return 0\r\n  return 1\r\n}\r\n\r\n/**\r\n * Convert a bigInt into a string in a given base, from base 2 up to base 95.\r\n *\r\n * Base -1 prints the contents of the array representing the number.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} base\r\n * @returns {string}\r\n */\r\nexport function bigInt2str(x: number[], base: number): string {\r\n  var i,\r\n      t,\r\n      s = ''\r\n\r\n  if (s6.length !== x.length) s6 = dup(x)\r\n  else copy_(s6, x)\r\n\r\n  if (base === -1) {\r\n    //return the list of array contents\r\n    for (i = x.length - 1; i > 0; i--) s += x[i] + ','\r\n    s += x[0]\r\n  } else {\r\n    //return it in the given base\r\n    while (!isZero(s6)) {\r\n      t = divInt_(s6, base) //t=s6 % base; s6=floor(s6/base);\r\n      s = digitsStr.substring(t, t + 1) + s\r\n    }\r\n  }\r\n  if (s.length === 0) s = '0'\r\n  return s\r\n}\r\n\r\n/**\r\n * Convert a bigInt into bytes\r\n * @param x bigInt\r\n * @param littleEndian byte order by default\r\n */\r\nexport function bigInt2bytes(x: number[], littleEndian = true) {\r\n  if(s6.length !== x.length) s6 = dup(x);\r\n  else copy_(s6, x);\r\n\r\n  const out: number[] = [];\r\n\r\n  //console.log('bigInt2bytes');\r\n  while(!isZero(s6)) {\r\n    t = divInt_(s6, 256); //t=s6 % base; s6=floor(s6/base);\r\n    out.push(t);\r\n    //console.log('bigInt2bytes', t);\r\n  }\r\n\r\n  if(littleEndian) {\r\n    out.reverse();\r\n  }\r\n\r\n  //console.log('bigInt2bytes', out);\r\n\r\n  return out;\r\n}\r\n\r\n/**\r\n * Compare two bigInts and return -1 if x is less, 0 if equals, 1 if greater\r\n * @param x bigInt\r\n * @param y bigInt\r\n */\r\nexport function cmp(x: number[], y: number[]) {\r\n  return greater(x, y) ? 1 : (equals(x, y) ? 0 : -1);\r\n}\r\n\r\n/* Object.assign(self, {\r\n  cmp,\r\n  str2bigInt,\r\n  int2bigInt,\r\n  bigInt2str,\r\n  one,\r\n  divide_,\r\n  divInt_,\r\n  dup,\r\n  negative\r\n}); */\r\n\r\n/**\r\n * Returns a duplicate of bigInt x\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @returns {number[]}\r\n */\r\nexport function dup(x: number[]): number[] {\r\n  var i\r\n  buff = Array(x.length)\r\n  copy_(buff, x)\r\n  return buff\r\n}\r\n\r\n/**\r\n * do x=y on bigInts x and y.\r\n *\r\n * x must be an array at least as big as y (not counting the leading zeros in y).\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @returns {void}\r\n */\r\nexport function copy_(x: number[], y: number[]): void {\r\n  var i\r\n  var k = x.length < y.length ? x.length : y.length\r\n  for (i = 0; i < k; i++) x[i] = y[i]\r\n  for (i = k; i < x.length; i++) x[i] = 0\r\n}\r\n\r\n/**\r\n * do x=y on bigInt x and integer y.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {void}\r\n */\r\nexport function copyInt_(x: number[], n: number): void {\r\n  var i, c\r\n  var len = x.length //TODO .length in for loop have perfomance costs. Bench this\r\n  for (c = n, i = 0; i < len; i++) {\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x+n where x is a bigInt and n is an integer.\r\n *\r\n * x must be large enough to hold the result.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {void}\r\n */\r\nexport function addInt_(x: number[], n: number): void {\r\n  var i, k, c, b\r\n  x[0] += n\r\n  k = x.length\r\n  c = 0\r\n  for (i = 0; i < k; i++) {\r\n    c += x[i]\r\n    b = 0\r\n    if (c < 0) {\r\n      b = -(c >> bpe)\r\n      c += b * radix\r\n    }\r\n    x[i] = c & mask\r\n    c = (c >> bpe) - b\r\n    if (!c) return //stop carrying as soon as the carry is zero\r\n  }\r\n}\r\n\r\n/**\r\n * right shift bigInt x by n bits.\r\n *\r\n *     0 <= n < bpe.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} n\r\n */\r\nexport function rightShift_(x: number[], n: number): void {\r\n  var i\r\n  var k = Math.floor(n / bpe)\r\n  if (k) {\r\n    for (\r\n      i = 0;\r\n      i < x.length - k;\r\n      i++ //right shift x by k elements\r\n    )\r\n      x[i] = x[i + k]\r\n    for (; i < x.length; i++) x[i] = 0\r\n    //$off\r\n    n %= bpe\r\n  }\r\n  for (i = 0; i < x.length - 1; i++) {\r\n    x[i] = mask & ((x[i + 1] << (bpe - n)) | (x[i] >> n))\r\n  }\r\n  x[i] >>= n\r\n}\r\n\r\n/**\r\n * do x=floor(|x|/2)*sgn(x) for bigInt x in 2's complement\r\n *\r\n * @param {number[]} x\r\n * @returns {void}\r\n */\r\nexport function halve_(x: number[]): void {\r\n  var i\r\n  for (i = 0; i < x.length - 1; i++) {\r\n    x[i] = mask & ((x[i + 1] << (bpe - 1)) | (x[i] >> 1))\r\n  }\r\n  x[i] = (x[i] >> 1) | (x[i] & (radix >> 1)) //most significant bit stays the same\r\n}\r\n\r\n/**\r\n * left shift bigInt x by n bits\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {void}\r\n */\r\nexport function leftShift_(x: number[], n: number): void {\r\n  var i\r\n  var k = Math.floor(n / bpe)\r\n  if (k) {\r\n    for (\r\n      i = x.length;\r\n      i >= k;\r\n      i-- //left shift x by k elements\r\n    )\r\n      x[i] = x[i - k]\r\n    for (; i >= 0; i--) x[i] = 0\r\n    //$off\r\n    n %= bpe\r\n  }\r\n  if (!n) return\r\n  for (i = x.length - 1; i > 0; i--) {\r\n    x[i] = mask & ((x[i] << n) | (x[i - 1] >> (bpe - n)))\r\n  }\r\n  x[i] = mask & (x[i] << n)\r\n}\r\n\r\n/**\r\n * do x=x*n where x is a bigInt and n is an integer.\r\n *\r\n * x must be large enough to hold the result.\r\n *\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {void}\r\n */\r\nexport function multInt_(x: number[], n: number): void {\r\n  var i, k, c, b\r\n  if (!n) return\r\n  k = x.length\r\n  c = 0\r\n  for (i = 0; i < k; i++) {\r\n    c += x[i] * n\r\n    b = 0\r\n    if (c < 0) {\r\n      b = -(c >> bpe)\r\n      c += b * radix\r\n    }\r\n    x[i] = c & mask\r\n    c = (c >> bpe) - b\r\n  }\r\n}\r\n\r\n/**\r\n * do x=floor(x/n) for bigInt x and integer n, and return the remainder\r\n *\r\n * @param {number[]} x\r\n * @param {number} n\r\n * @returns {number} remainder\r\n */\r\nexport function divInt_(x: number[], n: number): number {\r\n  var i,\r\n      r = 0,\r\n      s\r\n  for (i = x.length - 1; i >= 0; i--) {\r\n    s = r * radix + x[i]\r\n    x[i] = Math.floor(s / n)\r\n    r = s % n\r\n  }\r\n  return r\r\n}\r\n\r\n/**\r\n * do the linear combination x=a*x+b*y for bigInts x and y, and integers a and b.\r\n *\r\n * x must be large enough to hold the answer.\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number} a\r\n * @param {number} b\r\n * @returns {void}\r\n */\r\nexport function linComb_(x: number[], y: number[], a: number, b: number): void {\r\n  var i, c, k, kk\r\n  k = x.length < y.length ? x.length : y.length\r\n  kk = x.length\r\n  for (c = 0, i = 0; i < k; i++) {\r\n    c += a * x[i] + b * y[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n  for (i = k; i < kk; i++) {\r\n    c += a * x[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n}\r\n\r\n/**\r\n * do the linear combination x=a*x+b*(y<<(ys*bpe)) for bigInts x and y, and integers a, b and ys.\r\n *\r\n * x must be large enough to hold the answer.\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number} b\r\n * @param {number} ys\r\n * @returns {void}\r\n */\r\nexport function linCombShift_(\r\n  x: number[],\r\n  y: number[],\r\n  b: number,\r\n  ys: number,\r\n): void {\r\n  var i, c, k, kk\r\n  k = x.length < ys + y.length ? x.length : ys + y.length\r\n  kk = x.length\r\n  for (c = 0, i = ys; i < k; i++) {\r\n    c += x[i] + b * y[i - ys]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n  for (i = k; c && i < kk; i++) {\r\n    c += x[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x+(y<<(ys*bpe)) for bigInts x and y, and integer ys.\r\n *\r\n * x must be large enough to hold the answer.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number} ys\r\n * @return {void}\r\n */\r\nexport function addShift_(x: number[], y: number[], ys: number): void {\r\n  var i, c, k, kk\r\n  k = x.length < ys + y.length ? x.length : ys + y.length\r\n  kk = x.length\r\n  for (c = 0, i = ys; i < k; i++) {\r\n    c += x[i] + y[i - ys]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n  for (i = k; c && i < kk; i++) {\r\n    c += x[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x-(y<<(ys*bpe)) for bigInts x and y, and integer ys\r\n *\r\n * x must be large enough to hold the answer\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number} ys\r\n * @return {void}\r\n */\r\nexport function subShift_(x: number[], y: number[], ys: number): void {\r\n  var i, c, k, kk\r\n  k = x.length < ys + y.length ? x.length : ys + y.length\r\n  kk = x.length\r\n  for (c = 0, i = ys; i < k; i++) {\r\n    c += x[i] - y[i - ys]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n  for (i = k; c && i < kk; i++) {\r\n    c += x[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x-y for bigInts x and y\r\n *\r\n * x must be large enough to hold the answer\r\n *\r\n * negative answers will be 2s complement\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @return {void}\r\n */\r\nexport function sub_(x: number[], y: number[]): void {\r\n  var i, c, k, kk\r\n  k = x.length < y.length ? x.length : y.length\r\n  for (c = 0, i = 0; i < k; i++) {\r\n    c += x[i] - y[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n  for (i = k; c && i < x.length; i++) {\r\n    c += x[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x+y for bigInts x and y\r\n *\r\n * x must be large enough to hold the answer\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @return {void}\r\n */\r\nexport function add_(x: number[], y: number[]): void {\r\n  var i, c, k, kk\r\n  k = x.length < y.length ? x.length : y.length\r\n  for (c = 0, i = 0; i < k; i++) {\r\n    c += x[i] + y[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n  for (i = k; c && i < x.length; i++) {\r\n    c += x[i]\r\n    x[i] = c & mask\r\n    c >>= bpe\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x*y for bigInts x and y.\r\n *\r\n * This is faster when y<x.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @return {void}\r\n */\r\nexport function mult_(x: number[], y: number[]): void {\r\n  var i\r\n  if (ss.length != 2 * x.length) ss = new Array(2 * x.length)\r\n  copyInt_(ss, 0)\r\n  for (i = 0; i < y.length; i++) if (y[i]) linCombShift_(ss, x, y[i], i) //ss=1*ss+y[i]*(x<<(i*bpe))\r\n  copy_(x, ss)\r\n}\r\n\r\n/**\r\n * do x=x mod n for bigInts x and n\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} n\r\n * @return {void}\r\n */\r\nexport function mod_(x: number[], n: number[]): void {\r\n  if (s4.length !== x.length) s4 = dup(x)\r\n  else copy_(s4, x)\r\n  if (s5.length !== x.length) s5 = dup(x)\r\n  divide_(s4, n, s5, x) //x = remainder of s4 / n\r\n}\r\n\r\n/**\r\n * do x=x*y mod n for bigInts x,y,n.\r\n *\r\n * for greater speed, let y<x.\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number[]} n\r\n * @return {void}\r\n */\r\nexport function multMod_(x: number[], y: number[], n: number[]): void {\r\n  var i\r\n  if (s0.length != 2 * x.length) s0 = new Array(2 * x.length)\r\n  copyInt_(s0, 0)\r\n  for (i = 0; i < y.length; i++) if (y[i]) linCombShift_(s0, x, y[i], i) //s0=1*s0+y[i]*(x<<(i*bpe))\r\n  mod_(s0, n)\r\n  copy_(x, s0)\r\n}\r\n\r\n/**\r\n * do x=x*x mod n for bigInts x,n.\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} n\r\n * @return {void}\r\n */\r\nexport function squareMod_(x: number[], n: number[]): void {\r\n  var i, j, d, c, kx, kn, k\r\n  for (kx = x.length; kx > 0 && !x[kx - 1]; kx--); //ignore leading zeros in x\r\n  k = kx > n.length ? 2 * kx : 2 * n.length //k=# elements in the product, which is twice the elements in the larger of x and n\r\n  if (s0.length != k) s0 = new Array(k)\r\n  copyInt_(s0, 0)\r\n  for (i = 0; i < kx; i++) {\r\n    c = s0[2 * i] + x[i] * x[i]\r\n    s0[2 * i] = c & mask\r\n    c >>= bpe\r\n    for (j = i + 1; j < kx; j++) {\r\n      c = s0[i + j] + 2 * x[i] * x[j] + c\r\n      s0[i + j] = c & mask\r\n      c >>= bpe\r\n    }\r\n    s0[i + kx] = c\r\n  }\r\n  mod_(s0, n)\r\n  copy_(x, s0)\r\n}\r\n\r\n/**\r\n * return x with exactly k leading zero elements\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number} k\r\n * @returns {number[]}\r\n */\r\nexport function trim(x: number[], k: number): number[] {\r\n  var i, y\r\n  for (i = x.length; i > 0 && !x[i - 1]; i--);\r\n  y = new Array(i + k)\r\n  copy_(y, x)\r\n  return y\r\n}\r\n\r\n/**\r\n * do `x=x**y mod n`, where x,y,n are bigInts and `**` is exponentiation.  `0**0=1`.\r\n *\r\n * this is faster when n is odd.\r\n *\r\n * x usually needs to have as many elements as n.\r\n *\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number[]} n\r\n * @return {void}\r\n */\r\nexport function powMod_(x: number[], y: number[], n: number[]): void {\r\n  var k1, k2, kn, np\r\n  if (s7.length != n.length) s7 = dup(n)\r\n\r\n  //for even modulus, use a simple square-and-multiply algorithm,\r\n  //rather than using the more complex Montgomery algorithm.\r\n  if ((n[0] & 1) == 0) {\r\n    copy_(s7, x)\r\n    copyInt_(x, 1)\r\n    while (!equalsInt(y, 0)) {\r\n      if (y[0] & 1) multMod_(x, s7, n)\r\n      divInt_(y, 2)\r\n      squareMod_(s7, n)\r\n    }\r\n    return\r\n  }\r\n\r\n  //calculate np from n for the Montgomery multiplications\r\n  copyInt_(s7, 0)\r\n  for (kn = n.length; kn > 0 && !n[kn - 1]; kn--);\r\n  np = radix - inverseModInt(modInt(n, radix), radix)\r\n  s7[kn] = 1\r\n  multMod_(x, s7, n) // x = x * 2**(kn*bp) mod n\r\n\r\n  if (s3.length != x.length) s3 = dup(x)\r\n  else copy_(s3, x)\r\n  //$off\r\n  // @ts-ignore\r\n  for (k1 = y.length - 1; (k1 > 0) & !y[k1]; k1--); //k1=first nonzero element of y\r\n  if (y[k1] == 0) {\r\n    //anything to the 0th power is 1\r\n    copyInt_(x, 1)\r\n    return\r\n  }\r\n  for (k2 = 1 << (bpe - 1); k2 && !(y[k1] & k2); k2 >>= 1); //k2=position of first 1 bit in y[k1]\r\n  for (;;) {\r\n    if (!(k2 >>= 1)) {\r\n      //look at next bit of y\r\n      k1--\r\n      if (k1 < 0) {\r\n        mont_(x, one, n, np)\r\n        return\r\n      }\r\n      k2 = 1 << (bpe - 1)\r\n    }\r\n    mont_(x, x, n, np)\r\n\r\n    if (k2 & y[k1])\r\n      //if next bit is a 1\r\n      mont_(x, s3, n, np)\r\n  }\r\n}\r\n\r\n/**\r\n * do x=x*y*Ri mod n for bigInts x,y,n,\r\n * where Ri = 2**(-kn*bpe) mod n, and kn is the\r\n * number of elements in the n array, not\r\n * counting leading zeros.\r\n *\r\n * x array must have at least as many elemnts as the n array\r\n * It's OK if x and y are the same variable.\r\n *\r\n * must have:\r\n *  * x,y < n\r\n *  * n is odd\r\n *  * np = -(n^(-1)) mod radix\r\n *\r\n * @export\r\n * @param {number[]} x\r\n * @param {number[]} y\r\n * @param {number[]} n\r\n * @param {number} np\r\n * @return {void}\r\n */\r\nexport function mont_(x: number[], y: number[], n: number[], np: number): void {\r\n  var i, j, c, ui, t, ks\r\n  var kn = n.length\r\n  var ky = y.length\r\n\r\n  if (sa.length != kn) sa = new Array(kn)\r\n\r\n  copyInt_(sa, 0)\r\n\r\n  for (; kn > 0 && n[kn - 1] == 0; kn--); //ignore leading zeros of n\r\n  for (; ky > 0 && y[ky - 1] == 0; ky--); //ignore leading zeros of y\r\n  ks = sa.length - 1 //sa will never have more than this many nonzero elements.\r\n\r\n  //the following loop consumes 95% of the runtime for randTruePrime_() and powMod_() for large numbers\r\n  for (i = 0; i < kn; i++) {\r\n    t = sa[0] + x[i] * y[0]\r\n    ui = ((t & mask) * np) & mask //the inner \"& mask\" was needed on Safari (but not MSIE) at one time\r\n    c = (t + ui * n[0]) >> bpe\r\n    t = x[i]\r\n\r\n    //do sa=(sa+x[i]*y+ui*n)/b   where b=2**bpe.  Loop is unrolled 5-fold for speed\r\n    j = 1\r\n    for (; j < ky - 4; ) {\r\n      c += sa[j] + ui * n[j] + t * y[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j] + t * y[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j] + t * y[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j] + t * y[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j] + t * y[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n    }\r\n    for (; j < ky; ) {\r\n      c += sa[j] + ui * n[j] + t * y[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n    }\r\n    for (; j < kn - 4; ) {\r\n      c += sa[j] + ui * n[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n      c += sa[j] + ui * n[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n    }\r\n    for (; j < kn; ) {\r\n      c += sa[j] + ui * n[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n    }\r\n    for (; j < ks; ) {\r\n      c += sa[j]\r\n      sa[j - 1] = c & mask\r\n      c >>= bpe\r\n      j++\r\n    }\r\n    sa[j - 1] = c & mask\r\n  }\r\n\r\n  if (!greater(n, sa)) sub_(sa, n)\r\n  copy_(x, sa)\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { bufferConcats } from '../../helpers/bytes';\r\nimport { add_, bigInt2str, cmp, leftShift_, str2bigInt } from '../../vendor/leemon';\r\nimport { nextRandomInt } from '../../helpers/random';\r\n\r\n                       \r\n             \r\n                                                 \r\n\r\n                                                                           \r\n                                                                                 \r\n                                                                                             \r\n                                               \r\n                                                                          \r\n                                                              \r\n                \r\n \r\n          \r\n\r\nexport function isObject(object: any) {\r\n  return typeof(object) === 'object' && object !== null;\r\n}\r\n\r\n/* export function bigint(num: number) {\r\n  return new BigInteger(num.toString(16), 16);\r\n} */\r\n\r\n/* export function bigStringInt(strNum: string) {\r\n  return new BigInteger(strNum, 10);\r\n} */\r\n\r\n/* export function base64ToBlob(base64str: string, mimeType: string) {\r\n  var sliceSize = 1024;\r\n  var byteCharacters = atob(base64str);\r\n  var bytesLength = byteCharacters.length;\r\n  var slicesCount = Math.ceil(bytesLength / sliceSize);\r\n  var byteArrays = new Array(slicesCount);\r\n\r\n  for(var sliceIndex = 0; sliceIndex < slicesCount; ++sliceIndex) {\r\n    var begin = sliceIndex * sliceSize;\r\n    var end = Math.min(begin + sliceSize, bytesLength);\r\n\r\n    var bytes = new Array(end - begin);\r\n    for(var offset = begin, i = 0; offset < end; ++i, ++offset) {\r\n      bytes[i] = byteCharacters[offset].charCodeAt(0);\r\n    }\r\n    byteArrays[sliceIndex] = new Uint8Array(bytes);\r\n  }\r\n\r\n  return blobConstruct(byteArrays, mimeType);\r\n}\r\n\r\nexport function dataUrlToBlob(url: string) {\r\n  // var name = 'b64blob ' + url.length\r\n  // console.time(name)\r\n  var urlParts = url.split(',');\r\n  var base64str = urlParts[1];\r\n  var mimeType = urlParts[0].split(':')[1].split(';')[0];\r\n  var blob = base64ToBlob(base64str, mimeType);\r\n  // console.timeEnd(name)\r\n  return blob;\r\n} */\r\n\r\n/* export function bytesFromBigInt(bigInt: BigInteger, len?: number) {\r\n  var bytes = bigInt.toByteArray();\r\n\r\n  if(len && bytes.length < len) {\r\n    var padding = [];\r\n    for(var i = 0, needPadding = len - bytes.length; i < needPadding; i++) {\r\n      padding[i] = 0;\r\n    }\r\n    if(bytes instanceof ArrayBuffer) {\r\n      bytes = bufferConcat(padding, bytes);\r\n    } else {\r\n      bytes = padding.concat(bytes);\r\n    }\r\n  } else {\r\n    while (!bytes[0] && (!len || bytes.length > len)) {\r\n      bytes = bytes.slice(1);\r\n    }\r\n  }\r\n\r\n  return bytes;\r\n} */\r\n\r\nexport function longFromInts(high: number, low: number): string {\r\n  //let perf = performance.now();\r\n  //let str = bigint(high).shiftLeft(32).add(bigint(low)).toString(10);\r\n  //console.log('longFromInts jsbn', performance.now() - perf);\r\n  \r\n  //perf = performance.now();\r\n  const bigInt = str2bigInt(high.toString(16), 16, 32);//int2bigInt(high, 64, 64);\r\n  //console.log('longFromInts construct high', bigint(high).toString(10), bigInt2str(bigInt, 10));\r\n  leftShift_(bigInt, 32);\r\n  //console.log('longFromInts shiftLeft', bigint(high).shiftLeft(32).toString(10), bigInt2str(bigInt, 10));\r\n  add_(bigInt, str2bigInt(low.toString(16), 16, 32));\r\n  const _str = bigInt2str(bigInt, 10);\r\n\r\n  //console.log('longFromInts leemon', performance.now() - perf);\r\n\r\n  //console.log('longFromInts', high, low, str, _str, str === _str);\r\n\r\n  return _str;\r\n}\r\n\r\nexport function sortLongsArray(arr: string[]) {\r\n  return arr.map(long => {\r\n    return str2bigInt(long, 10);\r\n  }).sort((a, b) => {\r\n    return cmp(a, b);\r\n  }).map(bigInt => {\r\n    return bigInt2str(bigInt, 10);\r\n  });\r\n}\r\n\r\nexport function addPadding(bytes: any, blockSize: number = 16, zeroes?: boolean, full = false, prepend = false) {\r\n  let len = bytes.byteLength || bytes.length;\r\n  let needPadding = blockSize - (len % blockSize);\r\n  if(needPadding > 0 && (needPadding < blockSize || full)) {\r\n    ////console.log('addPadding()', len, blockSize, needPadding);\r\n    let padding = new Array(needPadding);\r\n    if(zeroes) {\r\n      for(let i = 0; i < needPadding; i++) {\r\n        padding[i] = 0;\r\n      }\r\n    } else {\r\n      for(let i = 0; i < padding.length; ++i) {\r\n        padding[i] = nextRandomInt(255);\r\n      }\r\n    }\r\n\r\n    if(bytes instanceof ArrayBuffer) {\r\n      bytes = (prepend ? bufferConcats(padding, bytes) : bufferConcats(bytes, padding)).buffer;\r\n    } else if(bytes instanceof Uint8Array) {\r\n      bytes = prepend ? bufferConcats(padding, bytes) : bufferConcats(bytes, padding);\r\n    } else {\r\n      bytes = prepend ? padding.concat(bytes) : bytes.concat(padding);\r\n    }\r\n  }\r\n\r\n  return bytes;\r\n}\r\n"],"sourceRoot":""}