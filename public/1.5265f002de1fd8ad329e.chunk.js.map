{"version":3,"sources":["webpack:///./src/lib/appManagers/appRuntimeManager.ts","webpack:///./src/lib/webp/webp.worker.ts","webpack:///./src/lib/webp/webpWorkerController.ts","webpack:///./src/lib/mtproto/singleInstance.ts","webpack:///./src/lib/langPack.ts","webpack:///./src/lib/mtproto/webPushApiManager.ts","webpack:///./src/lib/mtproto/mtproto.worker.ts","webpack:///./src/lib/mtproto/transports/websocket.ts","webpack:///./src/lib/mtproto/mtprotoworker.ts","webpack:///./src/lib/crypto/crypto_methods.ts","webpack:///./src/helpers/random.ts","webpack:///./src/helpers/string.ts","webpack:///./src/helpers/bytes.ts"],"names":["appRuntimeManager","location","reload","e","window","close","focus","Worker_fn","Worker","webpWorkerController","convertPromises","this","worker","addEventListener","payload","data","fileName","indexOf","promise","bytes","resolve","reject","postMessage","init","undefined","isWebpSupportedCache","document","createElement","toDataURL","startsWith","hasOwnProperty","convertPromise","type","singleInstance","log","clearInstance","masterInstance","deactivated","warn","delete","deactivateInstance","deactivateTimeout","idle","dispatchEvent","checkInstance","isIDLE","time","Date","now","newInstance","id","instanceID","get","then","curInstance","set","xt_instance","startAll","initial","clearTimeout","stopAll","setTimeout","started","reset","setInterval","documentElement","langPack","I18n","pluralRules","cacheLangPackPromise","loadLocalLangPack","defaultCode","langPackCode","lastRequestedLangCode","Promise","all","lang","langSign","strings","formatLocalStrings","default","saveLangPack","_","from_version","lang_code","version","local","loadLangPack","langCode","requestedServerLanguage","invokeApiCacheable","lang_pack","polyfillPromise","pushTo","i","v","push","key","value","getLangPack","_langPack","__langPack","___langPack","forEach","l","concat","string","appVersion","langPackVersion","applyLangPack","Intl","PluralRules","err","console","error","split","clear","Array","from","querySelectorAll","element","instance","weakMap","update","superFormatter","input","args","indexHolder","out","lastIndex","replace","match","p1","p2","p3","offset","slice","b","append","length","format","plain","str","select","regExp","Map","getCacheLangPack","finally","getStrings","invokeApi","keys","_Intl","Object","assign","WeakMap","IntlElementBase","options","property","classList","add","IntlElement","textContent","formatted","dataset","IntlDateElement","dateTimeFormat","DateTimeFormat","date","i18n","i18n_","_i18n","join","elements","useLast","arr","delimiterKey","WebPushApiManager","isAvailable","isPushEnabled","localNotificationsAvailable","settings","isFirefox","navigator","userAgent","toLowerCase","userVisibleOnly","subscribe","serviceWorker","ready","reg","pushManager","subscription","pushSubscriptionNotify","catch","Notification","permission","isAliveNotify","baseUrl","href","ACTIONS_LANG_MAP","push_action_mute1d","push_action_settings","push_message_nopreview","action","task","localNotifications","controller","isAliveTO","getSubscription","setUpServiceWorkerChannel","unsubscribe","successful","newSettings","addServiceWorkerTaskListener","event","subscriptionObj","toJSON","endpoint","p256dh","auth","tokenType","tokenValue","JSON","stringify","webPushApiManager","dcId","url","logSuffix","super","debug","handleOpen","handleError","handleClose","removeListeners","handleMessage","byteLength","send","body","ws","logTypes","Error","Log","Debug","logger","connect","removeEventListener","WebSocket","binaryType","apiManagerProxy","performTaskWorker","buffer","salt","iterations","keyBytes","ivBytes","encryptedBytes","publicKey","x","y","m","toString","password","state","isNew","afterMessageIdTemp","taskId","awaiting","pending","updatesProcessor","hashes","apiPromisesSingle","apiPromisesCacheable","isSWRegistered","sockets","taskListeners","taskListenersSW","onWorkerMessage","callback","progress","rootScope","finalizeTask","result","start","registerServiceWorker","addTaskListener","toggleStorage","sessionStorage","forceUnsubscribe","socketTask","socket","onOpen","onClose","onMessage","storageTask","res","language","performTaskWorkerVoid","forceReconnectTimeout","registerWorker","register","scope","registration","installing","waiting","active","onServiceWorkerFail","releasePending","bind","isWebpSupported","name","onWorkerFirstMessage","once","deferred","taskName","params","method","o","prepareTempMessageId","messageId","queryJSON","cached","hash","includes","q","cache","item","override","fulfilled","timeout","cacheSeconds","timestamp","verify","queueId","userAuth","dcID","dc_id","enabled","nextRandomInt","maxValue","Math","floor","random","randomLong","limitSymbols","limitFrom","trim","escapeRegExp","encodeEntities","charCodeAt","splitStringByLength","maxLength","lastSliceStartIndex","arrayIndex","cut","end","part","_arrayIndex","index","partLength","convertInputKeyToKey","inputKey","convertKeyToInputKey","toUpperCase","capitalizeFirstLetter","charAt","bytesToHex","bytesFromHex","hexString","len","parseInt","substr","bytesToBase64","mod3","nLen","nUint24","nIdx","String","fromCharCode","uint6ToBase64","nUint6","bytesCmp","bytes1","bytes2","convertToArrayBuffer","ArrayBuffer","BYTES_PER_ELEMENT","Uint8Array","bufferConcats","tmp","lastLength"],"mappings":"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","file":"1.5265f002de1fd8ad329e.chunk.js","sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nexport class AppRuntimeManager {\r\n  public reload() {\r\n    try {\r\n      location.reload();\r\n    } catch(e) {};\r\n\r\n    // if(window.chrome && chrome.runtime && chrome.runtime.reload) {\r\n    //   chrome.runtime.reload();\r\n    // }\r\n  }\r\n\r\n  public close() {\r\n    try {\r\n      window.close();\r\n    } catch(e) {}\r\n  }\r\n\r\n  /**\r\n   * Better to call from event\r\n   */\r\n  public focus() {\r\n    // // @ts-ignore\r\n    // if(window.navigator.mozApps && document.hidden) {\r\n    //   // Get app instance and launch it to bring app to foreground\r\n    //   // @ts-ignore\r\n    //   window.navigator.mozApps.getSelf().onsuccess = function() {\r\n    //     this.result.launch();\r\n    //   };\r\n    // } else {\r\n    //   // @ts-ignore\r\n    //   if(window.chrome && chrome.app && chrome.app.window) {\r\n    //     // @ts-ignore\r\n    //     chrome.app.window.current().focus();\r\n    //   }\r\n\r\n      window.focus();\r\n    // }\r\n  }\r\n}\r\n\r\nconst appRuntimeManager = new AppRuntimeManager();\r\nexport default appRuntimeManager;\r\n","export default function Worker_fn() {\n  return new Worker(__webpack_public_path__ + \"webp.worker.eafb4e17dc09d5858dc8.bundle.worker.js\");\n}\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport WebpWorker from 'worker-loader!./webp.worker';\r\nimport { MOUNT_CLASS_TO } from '../../config/debug';\r\nimport { CancellablePromise, deferredPromise } from '../../helpers/cancellablePromise';\r\nimport apiManagerProxy from '../mtproto/mtprotoworker';\r\n\r\nexport type WebpConvertTask = {\r\n  type: 'convertWebp', \r\n  payload: {\r\n    fileName: string, \r\n    bytes: Uint8Array\r\n  }\r\n};\r\n\r\nexport class WebpWorkerController {\r\n  private worker: Worker;\r\n  private convertPromises: {[fileName: string]: CancellablePromise<Uint8Array>} = {};\r\n  private isWebpSupportedCache: boolean;\r\n  \r\n  init() {\r\n    this.worker = new WebpWorker();\r\n    this.worker.addEventListener('message', (e) => {\r\n      const payload = (e.data as WebpConvertTask).payload;\r\n\r\n      if(payload.fileName.indexOf('main-') === 0) {\r\n        const promise = this.convertPromises[payload.fileName];\r\n        if(promise) {\r\n          payload.bytes ? promise.resolve(payload.bytes) : promise.reject();\r\n          delete this.convertPromises[payload.fileName];\r\n        }\r\n      } else {\r\n        apiManagerProxy.postMessage(e.data);\r\n      }\r\n    });\r\n  }\r\n\r\n  postMessage(data: WebpConvertTask) {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.worker.postMessage(data);\r\n  }\r\n\r\n  isWebpSupported() {\r\n    if(this.isWebpSupportedCache === undefined) {\r\n      this.isWebpSupportedCache = document.createElement('canvas').toDataURL('image/webp').startsWith('data:image/webp');\r\n    }\r\n\r\n    return this.isWebpSupportedCache;\r\n  }\r\n\r\n  convert(fileName: string, bytes: Uint8Array) {\r\n    fileName = 'main-' + fileName;\r\n\r\n    if(this.convertPromises.hasOwnProperty(fileName)) {\r\n      return this.convertPromises[fileName];\r\n    }\r\n    \r\n    const convertPromise = deferredPromise<Uint8Array>();\r\n\r\n    this.postMessage({type: 'convertWebp', payload: {fileName, bytes}});\r\n\r\n    return this.convertPromises[fileName] = convertPromise;\r\n  }\r\n}\r\n\r\nconst webpWorkerController = new WebpWorkerController();\r\nMOUNT_CLASS_TO.webpWorkerController = webpWorkerController;\r\nexport default webpWorkerController;","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { nextRandomInt } from \"../../helpers/random\";\r\nimport { logger } from \"../logger\";\r\nimport rootScope from \"../rootScope\";\r\nimport sessionStorage from \"../sessionStorage\";\r\nimport apiManager from \"./mtprotoworker\";\r\n\r\nexport type AppInstance = {\r\n  id: number,\r\n  idle: boolean,\r\n  time: number\r\n};\r\n\r\nconst CHECK_INSTANCE_INTERVAL = 5000; \r\nconst DEACTIVATE_TIMEOUT = 30000;\r\nconst MULTIPLE_TABS_THRESHOLD = 20000;\r\n\r\nexport class SingleInstance {\r\n  private instanceID: number;\r\n  private started: boolean;\r\n  private masterInstance: boolean;\r\n  private deactivateTimeout: number;\r\n  private deactivated: boolean;\r\n  private initial: boolean;\r\n  private log = logger('INSTANCE');\r\n\r\n  public start() {\r\n    if(!this.started/*  && !Config.Navigator.mobile && !Config.Modes.packed */) {\r\n      this.started = true;\r\n\r\n      this.reset();\r\n      //IdleManager.start();\r\n\r\n      rootScope.addEventListener('idle', this.checkInstance);\r\n      setInterval(this.checkInstance, CHECK_INSTANCE_INTERVAL);\r\n      this.checkInstance();\r\n\r\n      try {\r\n        document.documentElement.addEventListener('beforeunload', this.clearInstance);\r\n      } catch(e) {}\r\n    }\r\n  }\r\n\r\n  public reset() {\r\n    this.instanceID = nextRandomInt(0xFFFFFFFF);\r\n    this.masterInstance = false;\r\n    if(this.deactivateTimeout) clearTimeout(this.deactivateTimeout);\r\n    this.deactivateTimeout = 0;\r\n    this.deactivated = false;\r\n    this.initial = false;\r\n  }\r\n\r\n  public clearInstance = () => {\r\n    if(this.masterInstance && !this.deactivated) {\r\n      this.log.warn('clear master instance');\r\n      sessionStorage.delete('xt_instance');\r\n    }\r\n  };\r\n\r\n  public activateInstance() {\r\n    if(this.deactivated) {\r\n      this.reset();\r\n      this.checkInstance(false);\r\n      rootScope.dispatchEvent('instance_activated');\r\n    }\r\n  }\r\n\r\n  public deactivateInstance = () => {\r\n    if(this.masterInstance || this.deactivated) {\r\n      return false;\r\n    }\r\n\r\n    this.log('deactivate');\r\n    this.deactivateTimeout = 0;\r\n    this.deactivated = true;\r\n    this.clearInstance();\r\n    //$modalStack.dismissAll();\r\n\r\n    //document.title = _('inactive_tab_title_raw')\r\n\r\n    rootScope.idle.deactivated = true;\r\n    rootScope.dispatchEvent('instance_deactivated');\r\n  };\r\n\r\n  public checkInstance = (idle = rootScope.idle && rootScope.idle.isIDLE) => {\r\n    if(this.deactivated) {\r\n      return false;\r\n    }\r\n    \r\n    const time = Date.now();\r\n    const newInstance: AppInstance = {\r\n      id: this.instanceID, \r\n      idle, \r\n      time\r\n    };\r\n\r\n    sessionStorage.get('xt_instance', false).then((curInstance: AppInstance) => {\r\n      // this.log('check instance', newInstance, curInstance)\r\n      if(!idle ||\r\n          !curInstance ||\r\n          curInstance.id === this.instanceID ||\r\n          curInstance.time < (time - MULTIPLE_TABS_THRESHOLD)) {\r\n        sessionStorage.set({xt_instance: newInstance});\r\n\r\n        if(!this.masterInstance) {\r\n          apiManager.startAll();\r\n          if(!this.initial) {\r\n            this.initial = true;\r\n          } else {\r\n            this.log.warn('now master instance', newInstance);\r\n          }\r\n\r\n          this.masterInstance = true;\r\n        }\r\n\r\n        if(this.deactivateTimeout) {\r\n          clearTimeout(this.deactivateTimeout);\r\n          this.deactivateTimeout = 0;\r\n        }\r\n      } else {\r\n        if(this.masterInstance) {\r\n          apiManager.stopAll();\r\n          this.log.warn('now idle instance', newInstance);\r\n          if(!this.deactivateTimeout) {\r\n            this.deactivateTimeout = window.setTimeout(this.deactivateInstance, DEACTIVATE_TIMEOUT);\r\n          }\r\n\r\n          this.masterInstance = false;\r\n        }\r\n      }\r\n    });\r\n  };\r\n}\r\n\r\nconst singleInstance = new SingleInstance();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.singleInstance = singleInstance);\r\nexport default singleInstance;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport DEBUG, { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport { safeAssign } from \"../helpers/object\";\r\nimport { capitalizeFirstLetter } from \"../helpers/string\";\r\nimport type lang from \"../lang\";\r\nimport type langSign from \"../langSign\";\r\nimport { LangPackDifference, LangPackString } from \"../layer\";\r\nimport apiManager from \"./mtproto/mtprotoworker\";\r\nimport stateStorage from \"./stateStorage\";\r\nimport App from \"../config/app\";\r\nimport rootScope from \"./rootScope\";\r\n\r\nexport const langPack: {[actionType: string]: LangPackKey} = {\r\n  \"messageActionChatCreate\": \"ActionCreateGroup\",\r\n\t\"messageActionChatEditTitle\": \"ActionChangedTitle\",\r\n\t\"messageActionChatEditPhoto\": \"ActionChangedPhoto\",\r\n\t\"messageActionChatEditVideo\": \"ActionChangedVideo\",\r\n\t\"messageActionChatDeletePhoto\": \"ActionRemovedPhoto\",\r\n\t\"messageActionChatReturn\": \"ActionAddUserSelf\",\r\n\t\"messageActionChatReturnYou\": \"ActionAddUserSelfYou\",\r\n\t\"messageActionChatJoined\": \"ActionAddUserSelfMega\",\r\n\t\"messageActionChatJoinedYou\": \"ChannelMegaJoined\",\r\n  \"messageActionChatAddUser\": \"ActionAddUser\",\r\n  \"messageActionChatAddUsers\": \"ActionAddUser\",\r\n\t\"messageActionChatLeave\": \"ActionLeftUser\",\r\n\t\"messageActionChatLeaveYou\": \"YouLeft\",\r\n\t\"messageActionChatDeleteUser\": \"ActionKickUser\",\r\n\t\"messageActionChatJoinedByLink\": \"ActionInviteUser\",\r\n  \"messageActionPinMessage\": \"ActionPinnedNoText\",\r\n  \"messageActionContactSignUp\": \"Chat.Service.PeerJoinedTelegram\",\r\n\t\"messageActionChannelCreate\": \"ActionCreateChannel\",\r\n\t\"messageActionChannelEditTitle\": \"Chat.Service.Channel.UpdatedTitle\",\r\n\t\"messageActionChannelEditPhoto\": \"Chat.Service.Channel.UpdatedPhoto\",\r\n\t\"messageActionChannelEditVideo\": \"Chat.Service.Channel.UpdatedVideo\",\r\n  \"messageActionChannelDeletePhoto\": \"Chat.Service.Channel.RemovedPhoto\",\r\n  \"messageActionHistoryClear\": \"HistoryCleared\",\r\n\r\n  \"messageActionChannelMigrateFrom\": \"ActionMigrateFromGroup\",\r\n\r\n  \"messageActionPhoneCall.in_ok\": \"ChatList.Service.Call.incoming\",\r\n\t\"messageActionPhoneCall.out_ok\": \"ChatList.Service.Call.outgoing\",\r\n\t\"messageActionPhoneCall.in_missed\": \"ChatList.Service.Call.Missed\",\r\n\t\"messageActionPhoneCall.out_missed\": \"ChatList.Service.Call.Cancelled\",\r\n\r\n\t\"messageActionGroupCall.started\": \"ActionGroupCallJustStarted\",\r\n\t\"messageActionGroupCall.started_by\": \"ActionGroupCallStarted\",\r\n\t\"messageActionGroupCall.started_byYou\": \"ActionGroupCallStartedByYou\",\r\n\t\"messageActionGroupCall.ended_by\": \"Chat.Service.VoiceChatFinished\",\r\n\t\"messageActionGroupCall.ended_byYou\": \"Chat.Service.VoiceChatFinishedYou\",\r\n\r\n\t\"messageActionBotAllowed\": \"Chat.Service.BotPermissionAllowed\"\r\n};\r\n\r\nexport type LangPackKey = /* string |  */keyof typeof lang | keyof typeof langSign;\r\n\r\nnamespace I18n {\r\n\texport const strings: Map<LangPackKey, LangPackString> = new Map();\r\n\tlet pluralRules: Intl.PluralRules;\r\n\r\n\tlet cacheLangPackPromise: Promise<LangPackDifference>;\r\n\texport let lastRequestedLangCode: string;\r\n\texport let requestedServerLanguage = false;\r\n\texport function getCacheLangPack(): Promise<LangPackDifference> {\r\n\t\tif(cacheLangPackPromise) return cacheLangPackPromise;\r\n\t\treturn cacheLangPackPromise = Promise.all([\r\n\t\t\tstateStorage.get('langPack') as Promise<LangPackDifference>,\r\n\t\t\tpolyfillPromise\r\n\t\t]).then(([langPack]) => {\r\n\t\t\tif(!langPack/*  || true */) {\r\n\t\t\t\treturn loadLocalLangPack();\r\n\t\t\t} else if(DEBUG && false) {\r\n\t\t\t\treturn getLangPack(langPack.lang_code);\r\n\t\t\t}/*  else if(langPack.appVersion !== App.langPackVersion) {\r\n\t\t\t\treturn getLangPack(langPack.lang_code);\r\n\t\t\t} */\r\n\t\t\t\r\n\t\t\tif(!lastRequestedLangCode) {\r\n\t\t\t\tlastRequestedLangCode = langPack.lang_code;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tapplyLangPack(langPack);\r\n\t\t\treturn langPack;\r\n\t\t}).finally(() => {\r\n\t\t\tcacheLangPackPromise = undefined;\r\n\t\t});\r\n\t}\r\n\r\n\texport function loadLocalLangPack() {\r\n\t\tconst defaultCode = App.langPackCode;\r\n\t\tlastRequestedLangCode = defaultCode;\r\n\t\treturn Promise.all([\r\n\t\t\timport('../lang'),\r\n\t\t\timport('../langSign')\r\n\t\t]).then(([lang, langSign]) => {\r\n\t\t\tconst strings: LangPackString[] = [];\r\n\t\t\tformatLocalStrings(lang.default, strings);\r\n\t\t\tformatLocalStrings(langSign.default, strings);\r\n\r\n\t\t\tconst langPack: LangPackDifference = {\r\n\t\t\t\t_: 'langPackDifference',\r\n\t\t\t\tfrom_version: 0,\r\n\t\t\t\tlang_code: defaultCode,\r\n\t\t\t\tstrings,\r\n\t\t\t\tversion: 0,\r\n\t\t\t\tlocal: true\r\n\t\t\t};\r\n\t\t\treturn saveLangPack(langPack);\r\n\t\t});\r\n\t}\r\n\r\n\texport function loadLangPack(langCode: string) {\r\n\t\trequestedServerLanguage = true;\r\n\t\treturn Promise.all([\r\n\t\t\tapiManager.invokeApiCacheable('langpack.getLangPack', {\r\n\t\t\t\tlang_code: langCode,\r\n\t\t\t\tlang_pack: App.langPack\r\n\t\t\t}),\r\n\t\t\tapiManager.invokeApiCacheable('langpack.getLangPack', {\r\n\t\t\t\tlang_code: langCode,\r\n\t\t\t\tlang_pack: 'android'\r\n\t\t\t}),\r\n\t\t\timport('../lang'),\r\n\t\t\timport('../langSign'),\r\n\t\t\tpolyfillPromise\r\n\t\t]);\r\n\t}\r\n\r\n\texport function getStrings(langCode: string, strings: string[]) {\r\n\t\treturn apiManager.invokeApi('langpack.getStrings', {\r\n\t\t\tlang_pack: App.langPack,\r\n\t\t\tlang_code: langCode,\r\n\t\t\tkeys: strings\r\n\t\t});\r\n\t}\r\n\r\n\texport function formatLocalStrings(strings: any, pushTo: LangPackString[] = []) {\r\n\t\tfor(const i in strings) {\r\n\t\t\t// @ts-ignore\r\n\t\t\tconst v = strings[i];\r\n\t\t\tif(typeof(v) === 'string') {\r\n\t\t\t\tpushTo.push({\r\n\t\t\t\t\t_: 'langPackString',\r\n\t\t\t\t\tkey: i,\r\n\t\t\t\t\tvalue: v\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tpushTo.push({\r\n\t\t\t\t\t_: 'langPackStringPluralized',\r\n\t\t\t\t\tkey: i,\r\n\t\t\t\t\t...v\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn pushTo;\r\n\t}\r\n\r\n\texport function getLangPack(langCode: string) {\r\n\t\tlastRequestedLangCode = langCode;\r\n\t\treturn loadLangPack(langCode).then(([langPack, _langPack, __langPack, ___langPack, _]) => {\r\n\t\t\tlet strings: LangPackString[] = [];\r\n\r\n\t\t\t[__langPack, ___langPack].forEach(l => {\r\n\t\t\t\tformatLocalStrings(l.default as any, strings);\r\n\t\t\t});\r\n\r\n\t\t\tstrings = strings.concat(langPack.strings);\r\n\r\n\t\t\tfor(const string of _langPack.strings) {\r\n\t\t\t\tstrings.push(string);\r\n\t\t\t}\r\n\r\n\t\t\tlangPack.strings = strings;\r\n\t\t\treturn saveLangPack(langPack);\r\n\t\t});\r\n\t}\r\n\r\n\texport function saveLangPack(langPack: LangPackDifference) {\r\n\t\tlangPack.appVersion = App.langPackVersion;\r\n\r\n\t\treturn stateStorage.set({langPack}).then(() => {\r\n\t\t\tapplyLangPack(langPack);\r\n\t\t\treturn langPack;\r\n\t\t});\r\n\t}\r\n\r\n\texport const polyfillPromise = (function checkIfPolyfillNeeded() {\r\n\t\tif(typeof(Intl) !== 'undefined' && typeof(Intl.PluralRules) !== 'undefined'/*  && false */) {\r\n\t\t\treturn Promise.resolve();\r\n\t\t} else {\r\n\t\t\treturn import('./pluralPolyfill').then((_Intl) => {\r\n\t\t\t\t(window as any).Intl = Object.assign(typeof(Intl) !== 'undefined' ? Intl : {}, _Intl.default);\r\n\t\t\t});\r\n\t\t}\r\n\t})();\r\n\t\r\n\texport function applyLangPack(langPack: LangPackDifference) {\r\n\t\tif(langPack.lang_code !== lastRequestedLangCode) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tpluralRules = new Intl.PluralRules(langPack.lang_code);\r\n\t\t} catch(err) {\r\n\t\t\tconsole.error('pluralRules error', err);\r\n\t\t\tpluralRules = new Intl.PluralRules(langPack.lang_code.split('-', 1)[0]);\r\n\t\t}\r\n\r\n\t\tstrings.clear();\r\n\r\n\t\tfor(const string of langPack.strings) {\r\n\t\t\tstrings.set(string.key as LangPackKey, string);\r\n\t\t}\r\n\r\n\t\trootScope.dispatchEvent('language_change', langPack.lang_code);\r\n\r\n\t\tconst elements = Array.from(document.querySelectorAll(`.i18n`)) as HTMLElement[];\r\n\t\telements.forEach(element => {\r\n\t\t\tconst instance = weakMap.get(element);\r\n\r\n\t\t\tif(instance) {\r\n\t\t\t\tinstance.update();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\texport function superFormatter(input: string, args?: any[], indexHolder = {i: 0}) {\r\n\t\tlet out: (string | HTMLElement)[] = [];\r\n\t\tconst regExp = /(\\*\\*)(.+?)\\1|(\\n)|un\\d|%\\d\\$.|%./g;\r\n\r\n\t\tlet lastIndex = 0;\r\n\t\tinput.replace(regExp, (match, p1: any, p2: any, p3: any, offset: number, string: string) => {\r\n\t\t\t//console.table({match, p1, p2, offset, string});\r\n\r\n\t\t\tout.push(string.slice(lastIndex, offset));\r\n\r\n\t\t\tif(p1) {\r\n\t\t\t\t//offset += p1.length;\r\n\t\t\t\tswitch(p1) {\r\n\t\t\t\t\tcase '**': {\r\n\t\t\t\t\t\tconst b = document.createElement('b');\r\n\t\t\t\t\t\tb.append(...superFormatter(p2, args, indexHolder));\r\n\t\t\t\t\t\tout.push(b);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else if(p3) {\r\n\t\t\t\tout.push(document.createElement('br'));\r\n\t\t\t} else if(args) {\r\n\t\t\t\tout.push(args[indexHolder.i++]);\r\n\t\t\t}\r\n\r\n\t\t\tlastIndex = offset + match.length;\r\n\t\t\treturn '';\r\n\t\t});\r\n\t\r\n\t\tif(lastIndex !== input.length) {\r\n\t\t\tout.push(input.slice(lastIndex));\r\n\t\t}\r\n\r\n\t\treturn out;\r\n\t}\r\n\t\r\n\texport function format(key: LangPackKey, plain: true, args?: any[]): string;\r\n\texport function format(key: LangPackKey, plain?: false, args?: any[]): (string | HTMLElement)[];\r\n\texport function format(key: LangPackKey, plain = false, args?: any[]): (string | HTMLElement)[] | string {\r\n\t\tconst str = strings.get(key);\r\n\t\tlet input: string;\r\n\t\tif(str) {\r\n\t\t\tif(str._ === 'langPackStringPluralized' && args?.length) {\r\n\t\t\t\tlet v = args[0] as number | string;\r\n\t\t\t\tif(typeof(v) === 'string') v = +v.replace(/\\D/g, '');\r\n\t\t\t\tconst s = pluralRules.select(v);\r\n\t\t\t\t// @ts-ignore\r\n\t\t\t\tinput = str[s + '_value'] || str['other_value'];\r\n\t\t\t} else if(str._ === 'langPackString') {\r\n\t\t\t\tinput = str.value;\r\n\t\t\t} else {\r\n\t\t\t\t//input = '[' + key + ']';\r\n\t\t\t\tinput = key;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t//input = '[' + key + ']';\r\n\t\t\tinput = key;\r\n\t\t}\r\n\t\t\r\n\t\tif(plain) {\r\n\t\t\tif(args?.length) {\r\n\t\t\t\tconst regExp = /un\\d|%\\d\\$.|%./g;\r\n\t\t\t\tlet i = 0;\r\n\t\t\t\tinput = input.replace(regExp, (match, offset, string) => {\r\n\t\t\t\t\treturn '' + args[i++];\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\treturn input;\r\n\t\t} else {\r\n\t\t\treturn superFormatter(input, args);\r\n\t\t}\r\n\t}\r\n\r\n\texport const weakMap: WeakMap<HTMLElement, IntlElementBase<IntlElementBaseOptions>> = new WeakMap();\r\n\r\n\texport type IntlElementBaseOptions = {\r\n\t\telement?: HTMLElement,\r\n\t\tproperty?: /* 'innerText' |  */'innerHTML' | 'placeholder',\r\n\t};\r\n\r\n\tabstract class IntlElementBase<Options extends IntlElementBaseOptions> {\r\n\t\tpublic element: IntlElementBaseOptions['element'];\r\n\t\tpublic property: IntlElementBaseOptions['property'] = 'innerHTML';\r\n\t\r\n\t\tconstructor(options: Options) {\r\n\t\t\tthis.element = options.element || document.createElement('span');\r\n\t\t\tthis.element.classList.add('i18n');\r\n\t\t\t\r\n\t\t\tthis.update(options);\r\n\t\t\tweakMap.set(this.element, this);\r\n\t\t}\r\n\r\n\t\tabstract update(options?: Options): void;\r\n\t}\r\n\r\n\texport type IntlElementOptions = IntlElementBaseOptions & {\r\n\t\tkey: LangPackKey,\r\n\t\targs?: any[]\r\n\t};\r\n\texport class IntlElement extends IntlElementBase<IntlElementOptions> {\r\n\t\tpublic key: IntlElementOptions['key'];\r\n\t\tpublic args: IntlElementOptions['args'];\r\n\r\n\t\tpublic update(options?: IntlElementOptions) {\r\n\t\t\tsafeAssign(this, options);\r\n\t\r\n\t\t\tif(this.property === 'innerHTML') {\r\n\t\t\t\tthis.element.textContent = '';\r\n\t\t\t\tthis.element.append(...format(this.key, false, this.args));\r\n\t\t\t} else {\r\n\t\t\t\t// @ts-ignore\r\n\t\t\t\tconst v = this.element[this.property];\r\n\t\t\t\tconst formatted = format(this.key, true, this.args);\r\n\r\n\t\t\t\t// * hasOwnProperty won't work here\r\n\t\t\t\tif(v === undefined) this.element.dataset[this.property] = formatted;\r\n\t\t\t\telse (this.element as HTMLInputElement)[this.property] = formatted;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\texport type IntlDateElementOptions = IntlElementBaseOptions & {\r\n\t\tdate: Date,\r\n\t\toptions: Intl.DateTimeFormatOptions\r\n\t};\r\n\texport class IntlDateElement extends IntlElementBase<IntlDateElementOptions> {\r\n\t\tpublic date: IntlDateElementOptions['date'];\r\n\t\tpublic options: IntlDateElementOptions['options'];\r\n\r\n\t\tpublic update(options?: IntlDateElementOptions) {\r\n\t\t\tsafeAssign(this, options);\r\n\t\r\n\t\t\t//var options = { month: 'long', day: 'numeric' };\r\n\t\t\t\r\n\t\t\t// * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/Locale/hourCycle#adding_an_hour_cycle_via_the_locale_string\r\n\t\t\tconst dateTimeFormat = new Intl.DateTimeFormat(lastRequestedLangCode + '-u-hc-h23', this.options);\r\n\t\t\t\r\n\t\t\t(this.element as any)[this.property] = capitalizeFirstLetter(dateTimeFormat.format(this.date));\r\n\t\t}\r\n\t}\r\n\r\n\texport function i18n(key: LangPackKey, args?: any[]) {\r\n\t\treturn new IntlElement({key, args}).element;\r\n\t}\r\n\t\r\n\texport function i18n_(options: IntlElementOptions) {\r\n\t\treturn new IntlElement(options).element;\r\n\t}\r\n\r\n\texport function _i18n(element: HTMLElement, key: LangPackKey, args?: any[], property?: IntlElementOptions['property']) {\r\n\t\treturn new IntlElement({element, key, args, property}).element;\r\n\t}\r\n}\r\n\r\nexport {I18n};\r\nexport default I18n;\r\n\r\nconst i18n = I18n.i18n;\r\nexport {i18n};\r\n\r\nconst i18n_ = I18n.i18n_;\r\nexport {i18n_};\r\n\r\nconst _i18n = I18n._i18n;\r\nexport {_i18n};\r\n\r\nexport function join(elements: HTMLElement[], useLast = true) {\r\n\tconst arr: HTMLElement[] = elements.slice(0, 1);\r\n  for(let i = 1; i < elements.length; ++i) {\r\n    const isLast = (elements.length - 1) === i;\r\n    const delimiterKey: LangPackKey = isLast && useLast ? 'WordDelimiterLast' : 'WordDelimiter';\r\n    arr.push(i18n(delimiterKey));\r\n    arr.push(elements[i]);\r\n  }\r\n\r\n\treturn arr;\r\n}\r\n\r\nMOUNT_CLASS_TO.I18n = I18n;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport type { NotificationSettings } from \"../appManagers/appNotificationsManager\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { copy } from \"../../helpers/object\";\r\nimport { logger } from \"../logger\";\r\nimport rootScope from \"../rootScope\";\r\nimport { ServiceWorkerNotificationsClearTask, ServiceWorkerPingTask, ServiceWorkerPushClickTask } from \"../serviceWorker/index.service\";\r\nimport apiManager from \"./mtprotoworker\";\r\nimport I18n, { LangPackKey } from \"../langPack\";\r\nimport { isMobile } from \"../../helpers/userAgent\";\r\nimport appRuntimeManager from \"../appManagers/appRuntimeManager\";\r\n\r\nexport type PushSubscriptionNotifyType = 'init' | 'subscribe' | 'unsubscribe';\r\nexport type PushSubscriptionNotifyEvent = `push_${PushSubscriptionNotifyType}`;\r\n\r\nexport type PushSubscriptionNotify = {\r\n  tokenType: number,\r\n  tokenValue: string\r\n};\r\n\r\nexport class WebPushApiManager {\r\n  public isAvailable = true;\r\n  private isPushEnabled = false;\r\n  private localNotificationsAvailable = true;\r\n  private started = false;\r\n  private settings: NotificationSettings & {baseUrl?: string} = {} as any;\r\n  private isAliveTO: any;\r\n  private isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\r\n  private userVisibleOnly = this.isFirefox ? false : true;\r\n  private log = logger('PM');\r\n\r\n  constructor() {\r\n    if(!('PushManager' in window) ||\r\n      !('Notification' in window) ||\r\n      !('serviceWorker' in navigator)) {\r\n      this.log.warn('Push messaging is not supported.');\r\n      this.isAvailable = false;\r\n      this.localNotificationsAvailable = false;\r\n    }\r\n\r\n    if(this.isAvailable && Notification.permission === 'denied') {\r\n      this.log.warn('The user has blocked notifications.');\r\n    }\r\n  }\r\n\r\n  public start() {\r\n    if(!this.started) {\r\n      this.started = true;\r\n      this.getSubscription();\r\n      this.setUpServiceWorkerChannel();\r\n    }\r\n  }\r\n\r\n  public setLocalNotificationsDisabled() {\r\n    this.localNotificationsAvailable = false;\r\n  }\r\n\r\n  public getSubscription() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.getSubscription().then((subscription) => {\r\n        this.isPushEnabled = !!subscription;\r\n        this.pushSubscriptionNotify('init', subscription);\r\n      }).catch((err) => {\r\n        this.log.error('Error during getSubscription()', err);\r\n      });\r\n    });\r\n  }\r\n\r\n  public subscribe = () => {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.subscribe({userVisibleOnly: this.userVisibleOnly}).then((subscription) => {\r\n        // The subscription was successful\r\n        this.isPushEnabled = true;\r\n        this.pushSubscriptionNotify('subscribe', subscription);\r\n      }).catch((e) => {\r\n        if(Notification.permission === 'denied') {\r\n          this.log('Permission for Notifications was denied');\r\n        } else {\r\n          this.log('Unable to subscribe to push.', e);\r\n          if(!this.userVisibleOnly) {\r\n            this.userVisibleOnly = true;\r\n            setTimeout(this.subscribe, 0);\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  public unsubscribe() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n    \r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.getSubscription().then((subscription) => {\r\n        this.isPushEnabled = false;\r\n\r\n        if(subscription) {\r\n          this.pushSubscriptionNotify('unsubscribe', subscription);\r\n\r\n          setTimeout(() => {\r\n            subscription.unsubscribe().then((successful) => {\r\n              this.isPushEnabled = false;\r\n            }).catch((e) => {\r\n              this.log.error('Unsubscription error: ', e);\r\n            });\r\n          }, 3000);\r\n        }\r\n      }).catch((e) => {\r\n        this.log.error('Error thrown while unsubscribing from ' +\r\n          'push messaging.', e);\r\n      });\r\n    });\r\n  }\r\n\r\n  public forceUnsubscribe() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.getSubscription().then((subscription) => {\r\n        this.log.warn('force unsubscribe', subscription);\r\n        if(subscription) {\r\n          subscription.unsubscribe().then((successful) => {\r\n            this.log.warn('force unsubscribe successful', successful);\r\n            this.isPushEnabled = false;\r\n          }).catch((e) => {\r\n            this.log.error('Unsubscription error: ', e);\r\n          });\r\n        }\r\n      }).catch((e) => {\r\n        this.log.error('Error thrown while unsubscribing from ' +\r\n          'push messaging.', e);\r\n      });\r\n    });\r\n  }\r\n\r\n  public isAliveNotify = () => {\r\n    if(!this.isAvailable || rootScope.idle && rootScope.idle.deactivated) {\r\n      return;\r\n    }\r\n\r\n    this.settings.baseUrl = (location.href || '').replace(/#.*$/, '') + '#/im';\r\n\r\n    const lang: ServiceWorkerPingTask['payload']['lang'] = {} as any;\r\n    const ACTIONS_LANG_MAP: Record<keyof ServiceWorkerPingTask['payload']['lang'], LangPackKey> = {\r\n      push_action_mute1d: isMobile ? 'PushNotification.Action.Mute1d.Mobile' : 'PushNotification.Action.Mute1d',\r\n      push_action_settings: isMobile ? 'PushNotification.Action.Settings.Mobile' : 'PushNotification.Action.Settings',\r\n      push_message_nopreview: 'PushNotification.Message.NoPreview'\r\n    };\r\n\r\n    for(const action in ACTIONS_LANG_MAP) {\r\n      lang[action as keyof typeof ACTIONS_LANG_MAP] = I18n.format(ACTIONS_LANG_MAP[action as keyof typeof ACTIONS_LANG_MAP], true);\r\n    }\r\n\r\n    const task: ServiceWorkerPingTask = {\r\n      type: 'ping',\r\n      payload: {\r\n        localNotifications: this.localNotificationsAvailable,\r\n        lang: lang,\r\n        settings: this.settings\r\n      }\r\n    };\r\n\r\n    if(navigator.serviceWorker.controller) {\r\n      navigator.serviceWorker.controller.postMessage(task);\r\n    }\r\n\r\n    this.isAliveTO = setTimeout(this.isAliveNotify, 10000);\r\n  }\r\n\r\n  public setSettings(newSettings: WebPushApiManager['settings']) {\r\n    this.settings = copy(newSettings);\r\n    clearTimeout(this.isAliveTO);\r\n    this.isAliveNotify();\r\n  }\r\n\r\n  public hidePushNotifications() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    if(navigator.serviceWorker.controller) {\r\n      const task: ServiceWorkerNotificationsClearTask = {type: 'notifications_clear'};\r\n      navigator.serviceWorker.controller.postMessage(task);\r\n    }\r\n  }\r\n\r\n  public setUpServiceWorkerChannel() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    apiManager.addServiceWorkerTaskListener('push_click', (task: ServiceWorkerPushClickTask) => {\r\n      if(rootScope.idle && rootScope.idle.deactivated) {\r\n        appRuntimeManager.reload();\r\n        return;\r\n      }\r\n\r\n      rootScope.dispatchEvent('push_notification_click', task.payload);\r\n    });\r\n\r\n    navigator.serviceWorker.ready.then(this.isAliveNotify);\r\n  }\r\n\r\n  public pushSubscriptionNotify(event: PushSubscriptionNotifyType, subscription?: PushSubscription) {\r\n    if(subscription) {\r\n      const subscriptionObj: PushSubscriptionJSON = subscription.toJSON();\r\n      if(!subscriptionObj ||\r\n        !subscriptionObj.endpoint ||\r\n        !subscriptionObj.keys ||\r\n        !subscriptionObj.keys.p256dh ||\r\n        !subscriptionObj.keys.auth) {\r\n        this.log.warn('Invalid push subscription', subscriptionObj);\r\n        this.unsubscribe();\r\n        this.isAvailable = false;\r\n        this.pushSubscriptionNotify(event);\r\n        return;\r\n      }\r\n      \r\n      this.log.warn('Push', event, subscriptionObj);\r\n      rootScope.dispatchEvent(('push_' + event) as PushSubscriptionNotifyEvent, {\r\n        tokenType: 10,\r\n        tokenValue: JSON.stringify(subscriptionObj)\r\n      });\r\n    } else {\r\n      this.log.warn('Push', event, false);\r\n      rootScope.dispatchEvent(('push_' + event) as PushSubscriptionNotifyEvent, false as any);\r\n    }\r\n  }\r\n}\r\n\r\nconst webPushApiManager = new WebPushApiManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.webPushApiManager = webPushApiManager);\r\nexport default webPushApiManager;\r\n","export default function Worker_fn() {\n  return new Worker(__webpack_public_path__ + \"mtproto.worker.e50efc498c4e422f28a0.bundle.worker.js\");\n}\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { logger, LogTypes } from '../../logger';\r\nimport Modes from '../../../config/modes';\r\nimport EventListenerBase from '../../../helpers/eventListenerBase';\r\nimport { MTConnection } from './transport';\r\n\r\nexport default class Socket extends EventListenerBase<{\r\n  open: () => void,\r\n  message: (buffer: ArrayBuffer) => any,\r\n  close: () => void,\r\n}> implements MTConnection {\r\n  private ws: WebSocket;\r\n  private log: ReturnType<typeof logger>;\r\n  private debug = Modes.debug && false;\r\n\r\n  constructor(protected dcId: number, protected url: string, logSuffix: string) {\r\n    super();\r\n\r\n    let logTypes = LogTypes.Error | LogTypes.Log;\r\n    if(this.debug) logTypes |= LogTypes.Debug;\r\n    this.log = logger(`WS-${dcId}` + logSuffix, logTypes);\r\n    this.log('constructor');\r\n    this.connect();\r\n\r\n    return this;\r\n  }\r\n\r\n  private removeListeners() {\r\n    if(!this.ws) {\r\n      return;\r\n    }\r\n\r\n    this.ws.removeEventListener('open', this.handleOpen);\r\n    this.ws.removeEventListener('close', this.handleClose);\r\n    this.ws.removeEventListener('error', this.handleError);\r\n    this.ws.removeEventListener('message', this.handleMessage);\r\n    this.ws = undefined;\r\n  }\r\n  \r\n  private connect() {\r\n    this.ws = new WebSocket(this.url, 'binary');\r\n    this.ws.binaryType = 'arraybuffer';\r\n    this.ws.addEventListener('open', this.handleOpen);\r\n    this.ws.addEventListener('close', this.handleClose);\r\n    this.ws.addEventListener('error', this.handleError);\r\n    this.ws.addEventListener('message', this.handleMessage);\r\n  }\r\n\r\n  public close() {\r\n    if(!this.ws) {\r\n      return;\r\n    }\r\n\r\n    this.log('close execution');\r\n\r\n    try {\r\n      this.ws.close();\r\n    } catch(err) {\r\n\r\n    }\r\n    this.handleClose();\r\n  }\r\n  \r\n  private handleOpen = () => {\r\n    this.log('opened');\r\n\r\n    this.debug && this.log.debug('sending init packet');\r\n    this.dispatchEvent('open');\r\n  };\r\n\r\n  private handleError = (e: Event) => {\r\n    this.log.error('handleError', e);\r\n    this.close();\r\n  };\r\n\r\n  private handleClose = () => {\r\n    this.log('closed'/* , event, this.pending, this.ws.bufferedAmount */);\r\n\r\n    this.removeListeners();\r\n    this.dispatchEvent('close');\r\n  };\r\n\r\n  private handleMessage = (event: MessageEvent) => {\r\n    this.debug && this.log.debug('<-', 'handleMessage', /* event,  */event.data.byteLength);\r\n\r\n    this.dispatchEvent('message', event.data as ArrayBuffer);\r\n  };\r\n\r\n  public send = (body: Uint8Array) => {\r\n    this.debug && this.log.debug('-> body length to send:', body.length);\r\n\r\n    this.ws.send(body);\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { LocalStorageProxyTask, LocalStorageProxyTaskResponse } from '../localStorage';\r\n//import type { LocalStorageProxyDeleteTask, LocalStorageProxySetTask } from '../storage';\r\nimport type { InvokeApiOptions } from '../../types';\r\nimport type { MethodDeclMap } from '../../layer';\r\nimport MTProtoWorker from 'worker-loader!./mtproto.worker';\r\n//import './mtproto.worker';\r\nimport { isObject } from '../../helpers/object';\r\nimport CryptoWorkerMethods from '../crypto/crypto_methods';\r\nimport { logger } from '../logger';\r\nimport rootScope from '../rootScope';\r\nimport webpWorkerController from '../webp/webpWorkerController';\r\nimport type { DownloadOptions } from './apiFileManager';\r\nimport type { ServiceWorkerTask } from '../serviceWorker/index.service';\r\nimport { UserAuth } from './mtproto_config';\r\nimport type { MTMessage } from './networker';\r\nimport DEBUG, { MOUNT_CLASS_TO } from '../../config/debug';\r\nimport Socket from './transports/websocket';\r\nimport singleInstance from './singleInstance';\r\nimport sessionStorage from '../sessionStorage';\r\nimport webPushApiManager from './webPushApiManager';\r\nimport AppStorage from '../storage';\r\nimport appRuntimeManager from '../appManagers/appRuntimeManager';\r\nimport { SocketProxyTask } from './transports/socketProxied';\r\n\r\ntype Task = {\r\n  taskId: number,\r\n  task: string,\r\n  args: any[]\r\n};\r\n\r\ntype HashResult = {\r\n  hash: number,\r\n  result: any\r\n};\r\n\r\ntype HashOptions = {\r\n  [queryJSON: string]: HashResult\r\n};\r\n\r\nexport class ApiManagerProxy extends CryptoWorkerMethods {\r\n  public worker: /* Window */Worker;\r\n  public postMessage: (...args: any[]) => void;\r\n  private afterMessageIdTemp = 0;\r\n\r\n  private taskId = 0;\r\n  private awaiting: {\r\n    [id: number]: {\r\n      resolve: any,\r\n      reject: any,\r\n      taskName: string\r\n    }\r\n  } = {} as any;\r\n  private pending: Array<Task> = [];\r\n\r\n  public updatesProcessor: (obj: any) => void = null;\r\n\r\n  private log = logger('API-PROXY');\r\n\r\n  private hashes: {[method: string]: HashOptions} = {};\r\n\r\n  private apiPromisesSingle: {\r\n    [q: string]: Promise<any>\r\n  } = {};\r\n  private apiPromisesCacheable: {\r\n    [method: string]: {\r\n      [queryJSON: string]: {\r\n        timestamp: number,\r\n        promise: Promise<any>,\r\n        fulfilled: boolean,\r\n        timeout?: number,\r\n        params: any\r\n      }\r\n    }\r\n  } = {};\r\n\r\n  private isSWRegistered = true;\r\n\r\n  private debug = DEBUG /* && false */;\r\n\r\n  private sockets: Map<number, Socket> = new Map();\r\n\r\n  private taskListeners: {[taskType: string]: (task: any) => void} = {};\r\n  private taskListenersSW: {[taskType: string]: (task: any) => void} = {};\r\n\r\n  public onServiceWorkerFail: () => void;\r\n\r\n  constructor() {\r\n    super();\r\n    this.log('constructor');\r\n\r\n    singleInstance.start();\r\n\r\n    this.registerServiceWorker();\r\n\r\n    this.addTaskListener('clear', () => {\r\n      Promise.all([\r\n        AppStorage.toggleStorage(false), \r\n        sessionStorage.clear(),\r\n        webPushApiManager.forceUnsubscribe()\r\n      ]).finally(() => {\r\n        appRuntimeManager.reload();\r\n      });\r\n    });\r\n\r\n    this.addTaskListener('connectionStatusChange', (task: any) => {\r\n      rootScope.dispatchEvent('connection_status_change', task.payload);\r\n    });\r\n\r\n    this.addTaskListener('convertWebp', (task) => {\r\n      webpWorkerController.postMessage(task);\r\n    });\r\n\r\n    this.addTaskListener('socketProxy', (task: SocketProxyTask) => {\r\n      const socketTask = task.payload;\r\n      const id = socketTask.id;\r\n      //console.log('socketProxy', socketTask, id);\r\n\r\n      if(socketTask.type === 'send') {\r\n        const socket = this.sockets.get(id);\r\n        socket.send(socketTask.payload);\r\n      } else if(socketTask.type === 'close') { // will remove from map in onClose\r\n        const socket = this.sockets.get(id);\r\n        socket.close();\r\n      } else if(socketTask.type === 'setup') {\r\n        const socket = new Socket(socketTask.payload.dcId, socketTask.payload.url, socketTask.payload.logSuffix);\r\n        \r\n        const onOpen = () => {\r\n          //console.log('socketProxy onOpen');\r\n          this.postMessage({\r\n            type: 'socketProxy', \r\n            payload: {\r\n              type: 'open',\r\n              id\r\n            }\r\n          });\r\n        };\r\n        const onClose = () => {\r\n          this.postMessage({\r\n            type: 'socketProxy', \r\n            payload: {\r\n              type: 'close',\r\n              id\r\n            }\r\n          });\r\n\r\n          socket.removeEventListener('open', onOpen);\r\n          socket.removeEventListener('close', onClose);\r\n          socket.removeEventListener('message', onMessage);\r\n          this.sockets.delete(id);\r\n        };\r\n        const onMessage = (buffer: ArrayBuffer) => {\r\n          this.postMessage({\r\n            type: 'socketProxy', \r\n            payload: {\r\n              type: 'message',\r\n              id,\r\n              payload: buffer\r\n            }\r\n          });\r\n        };\r\n\r\n        socket.addEventListener('open', onOpen);\r\n        socket.addEventListener('close', onClose);\r\n        socket.addEventListener('message', onMessage);\r\n        this.sockets.set(id, socket);\r\n      }\r\n    });\r\n\r\n    this.addTaskListener('localStorageProxy', (task: LocalStorageProxyTask) => {\r\n      const storageTask = task.payload;\r\n      // @ts-ignore\r\n      sessionStorage[storageTask.type](...storageTask.args).then(res => {\r\n        this.postMessage({\r\n          type: 'localStorageProxy',\r\n          id: task.id,\r\n          payload: res\r\n        } as LocalStorageProxyTaskResponse);\r\n      });\r\n    });\r\n\r\n    rootScope.addEventListener('language_change', (language) => {\r\n      this.performTaskWorkerVoid('setLanguage', language);\r\n    });\r\n\r\n    window.addEventListener('online', (event) => {\r\n      this.forceReconnectTimeout();\r\n    });\r\n\r\n                       \r\n    this.registerWorker();\r\n              \r\n  }\r\n\r\n  public isServiceWorkerOnline() {\r\n    return this.isSWRegistered;\r\n  }\r\n\r\n  private registerServiceWorker() {\r\n    if(!('serviceWorker' in navigator)) return;\r\n    \r\n    const worker = navigator.serviceWorker;\r\n    worker.register('./sw.js', {scope: './'}).then(registration => {\r\n      this.log('SW registered', registration);\r\n      this.isSWRegistered = true;\r\n\r\n      const sw = registration.installing || registration.waiting || registration.active;\r\n      sw.addEventListener('statechange', (e) => {\r\n        this.log('SW statechange', e);\r\n      });\r\n\r\n                        \r\n                                                                                                                     \r\n                                            \r\n                \r\n    }, (err) => {\r\n      this.isSWRegistered = false;\r\n      this.log.error('SW registration failed!', err);\r\n\r\n      if(this.onServiceWorkerFail) {\r\n        this.onServiceWorkerFail();\r\n      }\r\n    });\r\n\r\n    worker.addEventListener('controllerchange', () => {\r\n      this.log.warn('controllerchange');\r\n      this.releasePending();\r\n\r\n      worker.controller.addEventListener('error', (e) => {\r\n        this.log.error('controller error:', e);\r\n      });\r\n    });\r\n\r\n                      \r\n                                                             \r\n             \r\n    worker.addEventListener('message', (e) => {\r\n      const task: ServiceWorkerTask = e.data;\r\n      if(!isObject(task)) {\r\n        return;\r\n      }\r\n\r\n      const callback = this.taskListenersSW[task.type];\r\n      if(callback) {\r\n        callback(task);\r\n      }\r\n    });\r\n\r\n    this.addServiceWorkerTaskListener('requestFilePart', (task) => {\r\n      this.postMessage(task);\r\n    });\r\n              \r\n\r\n    worker.addEventListener('messageerror', (e) => {\r\n      this.log.error('SW messageerror:', e);\r\n    });\r\n  }\r\n\r\n  private onWorkerFirstMessage(worker: any) {\r\n    if(!this.worker) {\r\n      this.worker = worker;\r\n      this.log('set webWorker');\r\n\r\n      this.postMessage = this.worker.postMessage.bind(this.worker);\r\n\r\n      const isWebpSupported = webpWorkerController.isWebpSupported();\r\n      this.log('WebP supported:', isWebpSupported);\r\n      this.postMessage({type: 'webpSupport', payload: isWebpSupported});\r\n      this.postMessage({type: 'userAgent', payload: navigator.userAgent});\r\n\r\n      this.releasePending();\r\n    }\r\n  }\r\n\r\n  public addTaskListener(name: keyof ApiManagerProxy['taskListeners'], callback: ApiManagerProxy['taskListeners'][typeof name]) {\r\n    this.taskListeners[name] = callback;\r\n  }\r\n\r\n  public addServiceWorkerTaskListener(name: keyof ApiManagerProxy['taskListenersSW'], callback: ApiManagerProxy['taskListenersSW'][typeof name]) {\r\n    this.taskListenersSW[name] = callback;\r\n  }\r\n\r\n  private onWorkerMessage = (e: MessageEvent) => {\r\n    //this.log('got message from worker:', e.data);\r\n\r\n    const task = e.data;\r\n\r\n    if(!isObject(task)) {\r\n      return;\r\n    }\r\n\r\n    const callback = this.taskListeners[task.type];\r\n    if(callback) {\r\n      callback(task);\r\n      return;\r\n    }\r\n\r\n    if(task.update) {\r\n      if(this.updatesProcessor) {\r\n        this.updatesProcessor(task.update);\r\n      }\r\n    } else if(task.progress) {\r\n      rootScope.dispatchEvent('download_progress', task.progress);\r\n    } else if(task.hasOwnProperty('result') || task.hasOwnProperty('error')) {\r\n      this.finalizeTask(task.taskId, task.result, task.error);\r\n    }\r\n  };\r\n\r\n                     \r\n  private registerWorker() {\r\n    //return;\r\n\r\n    const worker = new MTProtoWorker();\r\n    //const worker = window;\r\n    worker.addEventListener('message', this.onWorkerFirstMessage.bind(this, worker), {once: true});\r\n    worker.addEventListener('message', this.onWorkerMessage);\r\n\r\n    worker.addEventListener('error', (err) => {\r\n      this.log.error('WORKER ERROR', err);\r\n    });\r\n  }\r\n            \r\n\r\n  private finalizeTask(taskId: number, result: any, error: any) {\r\n    const deferred = this.awaiting[taskId];\r\n    if(deferred !== undefined) {\r\n      this.debug && this.log.debug('done', deferred.taskName, result, error);\r\n      error ? deferred.reject(error) : deferred.resolve(result);\r\n      delete this.awaiting[taskId];\r\n    }\r\n  }\r\n\r\n  public performTaskWorkerVoid(task: string, ...args: any[]) {\r\n    const params = {\r\n      task,\r\n      taskId: this.taskId,\r\n      args\r\n    };\r\n\r\n    this.pending.push(params);\r\n    this.releasePending();\r\n\r\n    this.taskId++;\r\n  }\r\n\r\n  public performTaskWorker<T>(task: string, ...args: any[]) {\r\n    this.debug && this.log.debug('start', task, args);\r\n\r\n    return new Promise<T>((resolve, reject) => {\r\n      this.awaiting[this.taskId] = {resolve, reject, taskName: task};\r\n      this.performTaskWorkerVoid(task, ...args);\r\n    });\r\n  }\r\n\r\n  private releasePending() {\r\n    //return;\r\n\r\n    if(this.postMessage) {\r\n      this.debug && this.log.debug('releasing tasks, length:', this.pending.length);\r\n      this.pending.forEach(pending => {\r\n        this.postMessage(pending);\r\n      });\r\n      \r\n      this.debug && this.log.debug('released tasks');\r\n      this.pending.length = 0;\r\n    }\r\n  }\r\n\r\n  public setUpdatesProcessor(callback: (obj: any) => void) {\r\n    this.updatesProcessor = callback;\r\n  }\r\n\r\n  public invokeApi<T extends keyof MethodDeclMap>(method: T, params: MethodDeclMap[T]['req'] = {}, options: InvokeApiOptions = {}): Promise<MethodDeclMap[T]['res']> {\r\n    //console.log('will invokeApi:', method, params, options);\r\n    return this.performTaskWorker('invokeApi', method, params, options);\r\n  }\r\n\r\n  public invokeApiAfter<T extends keyof MethodDeclMap>(method: T, params: MethodDeclMap[T]['req'] = {}, options: InvokeApiOptions = {}): Promise<MethodDeclMap[T]['res']> {\r\n    let o = options;\r\n    o.prepareTempMessageId = '' + ++this.afterMessageIdTemp;\r\n    \r\n    o = {...options};\r\n    (options as MTMessage).messageId = o.prepareTempMessageId;\r\n\r\n    //console.log('will invokeApi:', method, params, options);\r\n    return this.invokeApi(method, params, o);\r\n  }\r\n\r\n  public invokeApiHashable<T extends keyof MethodDeclMap>(method: T, params: Omit<MethodDeclMap[T]['req'], 'hash'> = {} as any, options: InvokeApiOptions = {}): Promise<MethodDeclMap[T]['res']> {\r\n    //console.log('will invokeApi:', method, params, options);\r\n\r\n    const queryJSON = JSON.stringify(params);\r\n    let cached: HashResult;\r\n    if(this.hashes[method]) {\r\n      cached = this.hashes[method][queryJSON];\r\n      if(cached) {\r\n        (params as any).hash = cached.hash;\r\n      }\r\n    }\r\n\r\n    return this.invokeApi(method, params, options).then((result: any) => {\r\n      if(result._.includes('NotModified')) {\r\n        this.debug && this.log.warn('NotModified saved!', method, queryJSON);\r\n        return cached.result;\r\n      }\r\n      \r\n      if(result.hash/*  || result.messages */) {\r\n        const hash = result.hash/*  || this.computeHash(result.messages) */;\r\n        \r\n        if(!this.hashes[method]) this.hashes[method] = {};\r\n        this.hashes[method][queryJSON] = {\r\n          hash,\r\n          result\r\n        };\r\n      }\r\n\r\n      return result;\r\n    });\r\n  }\r\n\r\n  public invokeApiSingle<T extends keyof MethodDeclMap>(method: T, params: MethodDeclMap[T]['req'] = {} as any, options: InvokeApiOptions = {}): Promise<MethodDeclMap[T]['res']> {\r\n    const q = method + '-' + JSON.stringify(params);\r\n    if(this.apiPromisesSingle[q]) {\r\n      return this.apiPromisesSingle[q];\r\n    }\r\n\r\n    return this.apiPromisesSingle[q] = this.invokeApi(method, params, options).finally(() => {\r\n      delete this.apiPromisesSingle[q];\r\n    });\r\n  }\r\n\r\n  public invokeApiCacheable<T extends keyof MethodDeclMap>(method: T, params: MethodDeclMap[T]['req'] = {} as any, options: InvokeApiOptions & Partial<{cacheSeconds: number, override: boolean}> = {}): Promise<MethodDeclMap[T]['res']> {\r\n    const cache = this.apiPromisesCacheable[method] ?? (this.apiPromisesCacheable[method] = {});\r\n    const queryJSON = JSON.stringify(params);\r\n    const item = cache[queryJSON];\r\n    if(item && (!options.override || !item.fulfilled)) {\r\n      return item.promise;\r\n    }\r\n\r\n    if(options.override) {\r\n      if(item && item.timeout) {\r\n        clearTimeout(item.timeout);\r\n        delete item.timeout;\r\n      }\r\n\r\n      delete options.override;\r\n    }\r\n\r\n    let timeout: number;\r\n    if(options.cacheSeconds) {\r\n      timeout = window.setTimeout(() => {\r\n        delete cache[queryJSON];\r\n      }, options.cacheSeconds * 1000);\r\n      delete options.cacheSeconds;\r\n    }\r\n\r\n    const promise = this.invokeApi(method, params, options);\r\n\r\n    cache[queryJSON] = {\r\n      timestamp: Date.now(),\r\n      fulfilled: false,\r\n      timeout,\r\n      promise,\r\n      params\r\n    };\r\n\r\n    return promise;\r\n  }\r\n\r\n  public clearCache<T extends keyof MethodDeclMap>(method: T, verify: (params: MethodDeclMap[T]['req']) => boolean) {\r\n    const cache = this.apiPromisesCacheable[method];\r\n    if(cache) {\r\n      for(const queryJSON in cache) {\r\n        const item = cache[queryJSON];\r\n        if(verify(item.params)) {\r\n          if(item.timeout) {\r\n            clearTimeout(item.timeout);\r\n          }\r\n\r\n          delete cache[queryJSON];\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /* private computeHash(smth: any[]) {\r\n    smth = smth.slice().sort((a, b) => a.id - b.id);\r\n    //return smth.reduce((hash, v) => (((hash * 0x4F25) & 0x7FFFFFFF) + v.id) & 0x7FFFFFFF, 0);\r\n    return smth.reduce((hash, v) => ((hash * 20261) + 0x80000000 + v.id) % 0x80000000, 0);\r\n  } */\r\n\r\n  public setBaseDcId(dcId: number) {\r\n    return this.performTaskWorker('setBaseDcId', dcId);\r\n  }\r\n\r\n  public setQueueId(queueId: number) {\r\n    return this.performTaskWorker('setQueueId', queueId);\r\n  }\r\n\r\n  public setUserAuth(userAuth: UserAuth | number) {\r\n    if(typeof(userAuth) === 'number') {\r\n      userAuth = {dcID: 0, date: Date.now() / 1000 | 0, id: userAuth};\r\n    }\r\n    \r\n    rootScope.dispatchEvent('user_auth', userAuth);\r\n    return this.performTaskWorker('setUserAuth', userAuth);\r\n  }\r\n\r\n  public getNetworker(dc_id: number, options?: InvokeApiOptions) {\r\n    return this.performTaskWorker('getNetworker', dc_id, options);\r\n  }\r\n\r\n  public logOut(): Promise<void> {\r\n    // AppStorage.toggleStorage(false);\r\n    return this.performTaskWorker('logOut');\r\n  }\r\n\r\n  public cancelDownload(fileName: string) {\r\n    return this.performTaskWorker('cancelDownload', fileName);\r\n  }\r\n\r\n  public downloadFile(options: DownloadOptions) {\r\n    return this.performTaskWorker('downloadFile', options);\r\n  }\r\n\r\n  public uploadFile(options: {file: Blob | File, fileName: string}) {\r\n    return this.performTaskWorker('uploadFile', options);\r\n  }\r\n\r\n  public toggleStorage(enabled: boolean) {\r\n    return this.performTaskWorkerVoid('toggleStorage', enabled);\r\n  }\r\n\r\n  public stopAll() {\r\n    return this.performTaskWorkerVoid('stopAll');\r\n  }\r\n\r\n  public startAll() {\r\n    return this.performTaskWorkerVoid('startAll');\r\n  }\r\n\r\n  public forceReconnectTimeout() {\r\n    this.postMessage({type: 'online'});\r\n  }\r\n\r\n  public forceReconnect() {\r\n    this.postMessage({type: 'forceReconnect'});\r\n  }\r\n}\r\n\r\nconst apiManagerProxy = new ApiManagerProxy();\r\nMOUNT_CLASS_TO.apiManagerProxy = apiManagerProxy;\r\nexport default apiManagerProxy;\r\n","import { convertToArrayBuffer } from \"../../helpers/bytes\";\r\nimport type { InputCheckPasswordSRP } from \"../../layer\";\r\nimport { aesEncryptSync, aesDecryptSync, sha256HashSync, sha1HashSync, bytesModPow } from \"./crypto_utils\";\r\n\r\nexport default abstract class CryptoWorkerMethods {\r\n  abstract performTaskWorker<T>(task: string, ...args: any[]): Promise<T>;\r\n\r\n  public sha1Hash(bytes: Parameters<typeof sha1HashSync>[0]): Promise<Uint8Array> {\r\n    return this.performTaskWorker<Uint8Array>('sha1-hash', bytes);\r\n  }\r\n\r\n  public sha256Hash(bytes: Parameters<typeof sha256HashSync>[0]) {\r\n    return this.performTaskWorker<number[]>('sha256-hash', bytes);\r\n  }\r\n\r\n  public pbkdf2(buffer: Uint8Array, salt: Uint8Array, iterations: number) {\r\n    return this.performTaskWorker<ArrayBuffer>('pbkdf2', buffer, salt, iterations);\r\n  }\r\n\r\n  public aesEncrypt(bytes: Parameters<typeof aesEncryptSync>[0], \r\n    keyBytes: Parameters<typeof aesEncryptSync>[1], \r\n    ivBytes: Parameters<typeof aesEncryptSync>[2]) {\r\n    return this.performTaskWorker<ReturnType<typeof aesEncryptSync>>('aes-encrypt', convertToArrayBuffer(bytes), \r\n      convertToArrayBuffer(keyBytes), convertToArrayBuffer(ivBytes));\r\n  }\r\n\r\n  public aesDecrypt(encryptedBytes: Parameters<typeof aesDecryptSync>[0], \r\n    keyBytes: Parameters<typeof aesDecryptSync>[1], \r\n    ivBytes: Parameters<typeof aesDecryptSync>[2]): Promise<ArrayBuffer> {\r\n    return this.performTaskWorker<ArrayBuffer>('aes-decrypt', \r\n      encryptedBytes, keyBytes, ivBytes)\r\n      .then(bytes => convertToArrayBuffer(bytes));\r\n  }\r\n\r\n  public rsaEncrypt(publicKey: {modulus: string, exponent: string}, bytes: any): Promise<number[]> {\r\n    return this.performTaskWorker<number[]>('rsa-encrypt', publicKey, bytes);\r\n  }\r\n\r\n  public factorize(bytes: Uint8Array) {\r\n    return this.performTaskWorker<[number[], number[], number]>('factorize', [...bytes]);\r\n  }\r\n\r\n  public modPow(x: Parameters<typeof bytesModPow>[0], y: Parameters<typeof bytesModPow>[1], m: Parameters<typeof bytesModPow>[2]) {\r\n    return this.performTaskWorker<ReturnType<typeof bytesModPow>>('mod-pow', x, y, m);\r\n  }\r\n\r\n  public gzipUncompress<T>(bytes: ArrayBuffer, toString?: boolean) {\r\n    return this.performTaskWorker<T>('gzipUncompress', bytes, toString);\r\n  }\r\n\r\n  public computeSRP(password: string, state: any, isNew = false): Promise<InputCheckPasswordSRP> {\r\n    return this.performTaskWorker('computeSRP', password, state, isNew);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport function nextRandomInt(maxValue: number) {\r\n  return Math.floor(Math.random() * maxValue);\r\n}\r\n\r\nexport function randomLong() {\r\n  return '' + nextRandomInt(0xFFFFFFFF) + nextRandomInt(0xFFFFFF);\r\n  //return '' + parseInt(nextRandomInt(0xFFFFFFFF).toString(16) + nextRandomInt(0xFFFFFFFF).toString(16), 16);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n/* export function stringMiddleOverflow(str: string, maxLength: number) {\r\n  return str.length > maxLength ? str.slice(0, maxLength / 2 | 0) + '...' + str.slice(-Math.round(maxLength / 2)) : str; \r\n} */\r\n\r\nexport function limitSymbols(str: string, length: number, limitFrom = length + 10) {\r\n  str = str.trim();\r\n  if(str.length > limitFrom) {\r\n    str = str.slice(0, length)/* .replace(/\\s*$/, '') */ + '...';\r\n  }\r\n\r\n  return str;\r\n}\r\n\r\n// credits to https://github.com/sindresorhus/escape-string-regexp/blob/master/index.js\r\nexport function escapeRegExp(str: string) {\r\n  return str\r\n    .replace(/[|\\\\{}()[\\]^$+*?.]/g, '\\\\$&')\r\n    .replace(/-/g, '\\\\x2d');\r\n}\r\n\r\nexport function encodeEntities(value: string) {\r\n  return value.replace(/&/g, '&amp;').replace(/[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]/g, (value) => {\r\n    var hi = value.charCodeAt(0);\r\n    var low = value.charCodeAt(1);\r\n    return '&#' + (((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000) + ';';\r\n  }).replace(/([^\\#-~| |!])/g, (value) => { // non-alphanumeric\r\n    return '&#' + value.charCodeAt(0) + ';';\r\n  }).replace(/</g, '&lt;').replace(/>/g, '&gt;');\r\n}\r\n\r\nexport function splitStringByLength(str: string, maxLength: number) {\r\n  if(str.length < maxLength) return [str];\r\n  let length = 0, lastSliceStartIndex = 0, arrayIndex = 0;\r\n  const delimiter = ' ';//'\\n';\r\n  const out: string[] = [];\r\n\r\n  const cut = (end?: number) => {\r\n    let part = str.slice(lastSliceStartIndex, end);\r\n    const _arrayIndex = arrayIndex++;\r\n    if(part.length > maxLength) {\r\n      let overflowPart = part.slice(maxLength);\r\n      const splitted = splitStringByLength(overflowPart, maxLength);\r\n      splitted.forEach(part => {\r\n        out[arrayIndex++] = part;\r\n      });\r\n\r\n      part = part.slice(0, maxLength);\r\n    }\r\n\r\n    lastSliceStartIndex = end;\r\n    length = 0;\r\n    out[_arrayIndex] = (out[_arrayIndex] || '') + part;\r\n  };\r\n\r\n  let lastIndex = 0;\r\n  do {\r\n    let index = str.indexOf(delimiter, lastIndex);\r\n    if(index === -1) {\r\n      if(lastIndex !== (str.length - 1)) {\r\n        cut();\r\n      }\r\n\r\n      break;\r\n    }\r\n\r\n    index += delimiter.length;\r\n\r\n    const partLength = index - lastIndex;\r\n    if((length + partLength) > maxLength) {\r\n      cut(length);\r\n    }\r\n    \r\n    lastIndex = index;\r\n    length += partLength;\r\n  } while(true);\r\n\r\n  return out;\r\n}\r\n\r\n// https://stackoverflow.com/a/14824756\r\n/* export const checkRTL = (s: string) => {           \r\n  const ltrChars  = 'A-Za-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02B8\\u0300-\\u0590\\u0800-\\u1FFF'+'\\u2C00-\\uFB1C\\uFDFE-\\uFE6F\\uFEFD-\\uFFFF',\r\n    rtlChars      = '\\u0591-\\u07FF\\uFB1D-\\uFDFD\\uFE70-\\uFEFC',\r\n    rtlDirCheck   = new RegExp('^[^'+ltrChars+']*['+rtlChars+']');\r\n\r\n  return rtlDirCheck.test(s);\r\n}; */\r\n\r\n//(window as any).checkRTL = checkRTL;\r\n\r\nexport function convertInputKeyToKey(inputKey: string) {\r\n  const str = inputKey.replace('input', '');\r\n  return (str[0].toLowerCase() + str.slice(1)) as string;\r\n}\r\n\r\nexport function convertKeyToInputKey(key: string) {\r\n  key = key[0].toUpperCase() + key.slice(1);\r\n  key = 'input' + key;\r\n  return key;\r\n}\r\n\r\nexport function capitalizeFirstLetter(string: string) {\r\n  return string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nexport function bytesToHex(bytes: ArrayLike<number>) {\r\n  bytes = bytes || [];\r\n  let arr: string[] = [];\r\n  for(let i = 0; i < bytes.length; ++i) {\r\n    arr.push((bytes[i] < 16 ? '0' : '') + (bytes[i] || 0).toString(16));\r\n  }\r\n  return arr.join('');\r\n}\r\n\r\nexport function bytesFromHex(hexString: string) {\r\n  const len = hexString.length;\r\n  let start = 0;\r\n  let bytes: number[] = [];\r\n\r\n  if(len % 2) { // read 0x581 as 0x0581\r\n    bytes.push(parseInt(hexString.charAt(0), 16));\r\n    ++start;\r\n  }\r\n\r\n  for(let i = start; i < len; i += 2) {\r\n    bytes.push(parseInt(hexString.substr(i, 2), 16));\r\n  }\r\n\r\n  return bytes;\r\n}\r\n\r\nexport function bytesToBase64(bytes: number[] | Uint8Array) {\r\n  let mod3: number;\r\n  let result = '';\r\n\r\n  for(let nLen = bytes.length, nUint24 = 0, nIdx = 0; nIdx < nLen; ++nIdx) {\r\n    mod3 = nIdx % 3;\r\n    nUint24 |= bytes[nIdx] << (16 >>> mod3 & 24);\r\n    if(mod3 === 2 || nLen - nIdx === 1) {\r\n      result += String.fromCharCode(\r\n        uint6ToBase64(nUint24 >>> 18 & 63),\r\n        uint6ToBase64(nUint24 >>> 12 & 63),\r\n        uint6ToBase64(nUint24 >>> 6 & 63),\r\n        uint6ToBase64(nUint24 & 63)\r\n      );\r\n      nUint24 = 0;\r\n    }\r\n  }\r\n\r\n  return result.replace(/A(?=A$|$)/g, '=');\r\n}\r\n\r\nexport function uint6ToBase64(nUint6: number) {\r\n  return nUint6 < 26\r\n    ? nUint6 + 65\r\n    : nUint6 < 52\r\n      ? nUint6 + 71\r\n      : nUint6 < 62\r\n        ? nUint6 - 4\r\n        : nUint6 === 62\r\n          ? 43\r\n          : nUint6 === 63\r\n            ? 47\r\n            : 65\r\n}\r\n\r\nexport function bytesCmp(bytes1: number[] | Uint8Array, bytes2: number[] | Uint8Array) {\r\n  const len = bytes1.length;\r\n  if(len !== bytes2.length) {\r\n    return false;\r\n  }\r\n\r\n  for(let i = 0; i < len; ++i) {\r\n    if(bytes1[i] !== bytes2[i]) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\nexport function bytesXor(bytes1: number[] | Uint8Array, bytes2: number[] | Uint8Array) {\r\n  const len = bytes1.length;\r\n  const bytes: number[] = [];\r\n\r\n  for(let i = 0; i < len; ++i) {\r\n    bytes[i] = bytes1[i] ^ bytes2[i];\r\n  }\r\n\r\n  return bytes;\r\n}\r\n\r\nexport function bytesToArrayBuffer(b: number[]) {\r\n  return (new Uint8Array(b)).buffer;\r\n}\r\n\r\nexport function convertToArrayBuffer(bytes: any | ArrayBuffer | Uint8Array) {\r\n  // Be careful with converting subarrays!!\r\n  if(bytes instanceof ArrayBuffer) {\r\n    return bytes;\r\n  }\r\n  if(bytes.buffer !== undefined &&\r\n    bytes.buffer.byteLength === bytes.length * bytes.BYTES_PER_ELEMENT) {\r\n    return bytes.buffer;\r\n  }\r\n  return bytesToArrayBuffer(bytes);\r\n}\r\n\r\nexport function convertToUint8Array(bytes: Uint8Array | ArrayBuffer | number[] | string): Uint8Array {\r\n  if((bytes as Uint8Array).buffer !== undefined) {\r\n    return bytes as Uint8Array;\r\n  } else if(typeof(bytes) === 'string') {\r\n    return new TextEncoder().encode(bytes);\r\n  }\r\n\r\n  return new Uint8Array(bytes);\r\n}\r\n\r\nexport function bytesFromArrayBuffer(buffer: ArrayBuffer) {\r\n  const len = buffer.byteLength;\r\n  const byteView = new Uint8Array(buffer);\r\n  const bytes: number[] = [];\r\n\r\n  for(let i = 0; i < len; ++i) {\r\n    bytes[i] = byteView[i];\r\n  }\r\n\r\n  return bytes;\r\n}\r\n\r\nexport function bufferConcat(buffer1: any, buffer2: any) {\r\n  const l1 = buffer1.byteLength || buffer1.length;\r\n  const l2 = buffer2.byteLength || buffer2.length;\r\n  const tmp = new Uint8Array(l1 + l2);\r\n  tmp.set(buffer1 instanceof ArrayBuffer ? new Uint8Array(buffer1) : buffer1, 0);\r\n  tmp.set(buffer2 instanceof ArrayBuffer ? new Uint8Array(buffer2) : buffer2, l1);\r\n\r\n  return tmp.buffer;\r\n}\r\n\r\nexport function bufferConcats(...args: any[]) {\r\n  let length = 0;\r\n  args.forEach(b => length += b.byteLength || b.length);\r\n\r\n  const tmp = new Uint8Array(length);\r\n  \r\n  let lastLength = 0;\r\n  args.forEach(b => {\r\n    tmp.set(b instanceof ArrayBuffer ? new Uint8Array(b) : b, lastLength);\r\n    lastLength += b.byteLength || b.length;\r\n  });\r\n\r\n  return tmp/* .buffer */;\r\n}\r\n\r\nexport function bytesFromWordss(input: Uint32Array) {\r\n  const o: number[] = [];\r\n  for(let i = 0, length = input.length * 4; i < length; ++i) {\r\n    o.push((input[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff);\r\n  }\r\n\r\n  return o;\r\n}\r\n\r\nexport function bytesToWordss(input: ArrayBuffer | Uint8Array) {\r\n  let bytes: Uint8Array;\r\n  if(input instanceof ArrayBuffer) bytes = new Uint8Array(input);\r\n  else bytes = input;\r\n\r\n  const words: number[] = [];\r\n  for(let i = 0, len = bytes.length; i < len; ++i) {\r\n    words[i >>> 2] |= bytes[i] << (24 - (i % 4) * 8);\r\n  }\r\n\r\n  return new Uint32Array(words);\r\n}\r\n\r\n// * https://stackoverflow.com/a/52827031\r\n/* export const isBigEndian = (() => {\r\n  const array = new Uint8Array(4);\r\n  const view = new Uint32Array(array.buffer);\r\n  return !((view[0] = 1) & array[0]);\r\n})(); */\r\n"],"sourceRoot":""}