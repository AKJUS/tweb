import{B as W,I as ie,r as se}from"./button-4c3a6727.js";import{g as ne,L as oe,A as K,m as ae}from"./wrapEmojiText-ac39e253.js";import{J as U,M as re,c as q,a6 as le,g as X,z,X as ce,a as he,Z as M,E as de,K as H,d as Y,F as ue,i as N}from"./index-c453b254.js";import{a as w,c as pe}from"./page-4613e559.js";import{S as fe}from"./scrollable-baf2e32a.js";function me(t){return U&&t instanceof TouchEvent&&t.touches[0].clientX<30}class ve{constructor(){if(this.onPopState=e=>{const i=window.location.hash,s=e.state;if(this.debug&&this.log("popstate",e,this.isPossibleSwipe,i),i!==this.currentHash)if(this.debug&&this.log.warn(`hash changed, new=${i}, current=${this.currentHash}, overridden=${this.overriddenHash}`),s===this.id&&this.overriddenHash&&this.overriddenHash!==i)this.overrideHash(this.overriddenHash);else if(s&&!this.overriddenHash&&i)this.overrideHash();else{this.currentHash=i,this.onHashChange&&this.onHashChange();return}if(s!==this.id&&(this.pushState(),!this.navigations.length))return;const o=this.navigations.pop();if(!o){this.pushState();return}this.manual=!this.isPossibleSwipe,this.handleItem(o,this.navigations.length)},this.onKeyDown=e=>{const i=this.navigations[this.navigations.length-1];i&&e.key==="Escape"&&(!i.onEscape||i.onEscape())&&(q(e),this.back(i.type))},this.onTouchStart=e=>{e.touches.length>1||(this.debug&&this.log("touchstart"),me(e)&&(this.isPossibleSwipe=!0,window.addEventListener("touchend",()=>{setTimeout(()=>{this.isPossibleSwipe=!1},100)},{passive:!0,once:!0})))},this.navigations=[],this.id=Date.now(),this.manual=!1,this.log=le("NC"),this.debug=!0,this.currentHash=window.location.hash,this.overriddenHash="",this.isPossibleSwipe=!1,window.addEventListener("popstate",this.onPopState),window.addEventListener("keydown",this.onKeyDown,{capture:!0,passive:!1}),U){const e={passive:!0};window.addEventListener("touchstart",this.onTouchStart,e)}history.scrollRestoration="manual",this.pushState()}overrideHash(e=""){e&&e[0]!=="#"?e="#"+e:e==="#"&&(e=""),this.currentHash!==e&&(this.overriddenHash=this.currentHash=e,this.replaceState(),this.pushState())}handleItem(e,i=this.navigations.indexOf(e)){const s=e.onPop(this.manual?void 0:!1);this.debug&&this.log("popstate, navigation:",e,this.navigations),s===!1?this.spliceItems(Math.min(this.navigations.length,i),0,e):e.noBlurOnPop||X(),this.manual=!1}findItemByType(e){for(let i=this.navigations.length-1;i>=0;--i){const s=this.navigations[i];if(s.type===e)return{item:s,index:i}}}back(e){if(e){const i=this.findItemByType(e);if(i){this.backByItem(i.item,i.index);return}}history.back()}backByItem(e,i=this.navigations.indexOf(e)){i!==-1&&(this.manual=!0,this.navigations.splice(i,1),this.handleItem(e,i))}onItemAdded(e){this.debug&&this.log("onItemAdded",e,this.navigations),e.noHistory||this.pushState()}pushItem(e){this.navigations.push(e),this.onItemAdded(e)}unshiftItem(e){this.navigations.unshift(e),this.onItemAdded(e)}spliceItems(e,i,...s){this.navigations.splice(e,i,...s),s.forEach(o=>{this.onItemAdded(o)})}pushState(){this.debug&&this.log("push"),this.manual=!1,history.pushState(this.id,"")}replaceState(){this.debug&&this.log.warn("replace");const e=location.origin+location.pathname+location.search+this.overriddenHash;history.replaceState(this.id,"",e)}removeItem(e){e&&z(this.navigations,e)}removeByType(e,i=!1){for(let s=this.navigations.length-1;s>=0&&!(this.navigations[s].type===e&&(this.navigations.splice(s,1),i));--s);}}const L=new ve;re.appNavigationController=L;function ge(t){if(t.key==="Enter"&&!ce&&!t.isComposing){if(he.settings.sendShortcut==="enter")return t.shiftKey||t.ctrlKey||t.metaKey?void 0:!0;{const e=M?t.metaKey:t.ctrlKey;if(t.shiftKey||(M?t.ctrlKey:t.metaKey))return;if(e)return!0}}return!1}function He(t){t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}function Ae(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()}function be(t,e,i){const s=i?i.add(t):t.addEventListener.bind(t);"webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange".split(" ").forEach(o=>{s(o,e,!1)})}function Z(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function Oe(){return!!Z()}const ye=(t,e={})=>{const i=t?.split(" ");return W("btn-icon"+(i?.length>1?" "+i.slice(1).join(" "):""),{icon:i?.[0]||void 0,...e})},A=document.body;let b=A;const $=()=>{b=Z()||A,O.reAppend()};be(A,$);const v=class extends de{constructor(t,e={}){if(super(!1),this.element=document.createElement("div"),this.container=document.createElement("div"),this.header=document.createElement("div"),this.title=document.createElement("div"),this.element.classList.add("popup"),this.element.className="popup"+(t?" "+t:""),this.container.classList.add("popup-container","z-depth-1"),H.isDarkOverlayActive&&this.element.classList.add("night"),this.header.classList.add("popup-header"),e.title&&(this.title.classList.add("popup-title"),typeof e.title=="string"?Y(this.title,e.title):typeof e.title!="boolean"&&this.title.append(e.title),this.header.append(this.title)),this.isConfirmationNeededOnClose=e.isConfirmationNeededOnClose,this.middlewareHelper=ne(),this.listenerSetter=new oe,this.managers=v.MANAGERS,this.confirmShortcutIsSendShortcut=e.confirmShortcutIsSendShortcut,e.closable&&(this.btnClose=ye("",{noRipple:!0}),this.btnClose.classList.add("popup-close"),this.header.prepend(this.btnClose),e.onBackClick?(this.btnCloseAnimatedIcon=document.createElement("div"),this.btnCloseAnimatedIcon.classList.add("animated-close-icon"),this.btnClose.append(this.btnCloseAnimatedIcon)):this.btnClose.append(ie("close")),w(this.btnClose,()=>{e.onBackClick&&this.btnCloseAnimatedIcon.classList.contains("state-back")?(this.btnClose.classList.remove("state-back"),e.onBackClick()):this.hide()},{listenerSetter:this.listenerSetter})),this.withoutOverlay=e.withoutOverlay,this.withoutOverlay&&this.element.classList.add("no-overlay"),e.overlayClosable&&w(this.element,o=>{ue(o.target,"popup-container")||this.hide()},{listenerSetter:this.listenerSetter}),e.withConfirm&&(this.btnConfirm=document.createElement("button"),this.btnConfirm.classList.add("btn-primary","btn-color-primary"),e.withConfirm!==!0&&this.btnConfirm.append(N(e.withConfirm)),this.header.append(this.btnConfirm)),this.container.append(this.header),e.body&&(this.body=document.createElement("div"),this.body.classList.add("popup-body"),this.container.append(this.body)),e.scrollable){const o=this.scrollable=new fe(this.body);this.attachScrollableListeners(),this.body||this.header.after(o.container)}e.footer&&(this.footer=document.createElement("div"),this.footer.classList.add("popup-footer"),(this.body||this.container).append(this.footer));let i=this.btnConfirm;const s=this.buttons=e.buttons;if(s?.length){const o=this.buttonsEl=document.createElement("div");o.classList.add("popup-buttons");const y=s.map(r=>{const l=document.createElement("button");return l.className="btn"+(r.isDanger?" danger":" primary"),r.noRipple||se(l),r.text?l.append(r.text):r.langKey&&l.append(N(r.langKey,r.langArgs)),w(l,()=>{r.callback?.(),this.hide()},{listenerSetter:this.listenerSetter,once:!0}),r.element=l});if(!i&&s.length===2){const r=s.find(l=>!l.isCancel);r&&(i=r.element)}s.length>=3&&o.classList.add("is-vertical-layout"),o.append(...y),this.container.append(o)}this.btnConfirmOnEnter=i,this.element.append(this.container),v.POPUPS.push(this)}attachScrollableListeners(t){return this.scrollable.attachBorderListeners(t)}onContentUpdate(){this.scrollable&&this.scrollable.onAdditionalScroll()}show(){this.navigationItem={type:"popup",onPop:()=>{if(this.isConfirmationNeededOnClose){const t=this.isConfirmationNeededOnClose();if(t)return Promise.resolve(t).then(()=>{this.destroy()}),!1}return this.destroy()}},L.pushItem(this.navigationItem),X(),b.append(this.element),this.element.offsetWidth,this.element.classList.add("active"),this.onContentUpdate(),this.withoutOverlay||(H.isOverlayActive=!0,K.checkAnimations2(!0)),setTimeout(()=>{this.element.classList.contains("active")&&this.listenerSetter.add(document.body)("keydown",t=>{!this.btnConfirmOnEnter||this.btnConfirmOnEnter.disabled||v.POPUPS[v.POPUPS.length-1]!==this||(this.confirmShortcutIsSendShortcut?ge(t):t.key==="Enter")&&(pe(this.btnConfirmOnEnter),q(t))})},0)}hide(){this.destroyed||!this.navigationItem||L.backByItem(this.navigationItem)}forceHide(){return this.destroy()}destroy(){this.destroyed||(this.destroyed=!0,this.dispatchEvent("close"),this.element.classList.add("hiding"),this.element.classList.remove("active"),this.listenerSetter.removeAll(),this.middlewareHelper.destroy(),this.withoutOverlay||(H.isOverlayActive=!1),L.removeItem(this.navigationItem),this.navigationItem=void 0,z(v.POPUPS,this),$(),setTimeout(()=>{this.element.remove(),this.dispatchEvent("closeAfterTimeout"),this.cleanup(),this.scrollable?.destroy(),this.withoutOverlay||K.checkAnimations2(!1)},250))}static reAppend(){this.POPUPS.forEach(t=>{const{element:e,container:i}=t,s=e.parentElement;s&&s!==b&&b!==i&&b.append(e)})}static getPopups(t){return this.POPUPS.filter(e=>e instanceof t)}static createPopup(t,...e){return new t(...e)}};let O=v;O.POPUPS=[];const Fe=t=>(t.find(i=>i.isCancel)||t.push({langKey:"Cancel",isCancel:!0}),t);function Ce(t,e){let i,s,o,y=0,r=0,l=0,C=0,g=0;const F=4,d={},j=50,x=200,T=200;t.complete?B():t.onload=B;function G(){s.removeEventListener("mousedown",E),s.removeEventListener("touchstart",E),s.removeEventListener("wheel",D),document.removeEventListener("mouseup",p),document.removeEventListener("touchend",p),document.removeEventListener("mousemove",f),document.removeEventListener("touchmove",f),document.removeEventListener("keypress",R),i.remove(),s.remove(),o.remove()}function J(){s.addEventListener("mousedown",E,!1),s.addEventListener("touchstart",E,!1),s.addEventListener("wheel",D,!1),document.addEventListener("keypress",R,!1)}function B(){t.classList.add("crop-blur"),t.draggable=!1,o=new Image,o.src=t.src,o.draggable=!1,o.classList.add("crop-overlay-image"),e||(e=document.createElement("canvas")),i=document.createElement("div"),i.classList.add("crop-component"),s=document.createElement("div"),s.classList.add("crop-overlay");const n=document.createElement("div");n.classList.add("crop-overlay-color"),i.appendChild(s),t.parentNode.appendChild(i),i.appendChild(o),i.appendChild(t),i.appendChild(n),s.appendChild(o),o.style.maxWidth=t.width+"px",g=t.naturalWidth/t.offsetWidth;const h=t.offsetWidth/2-x/2,c=t.offsetHeight/2-T/2;_(x,T),P(h,c),k(h,c),J()}function _(n,a){l=n*g,C=a*g,s.style.width=n+"px",s.style.height=a+"px"}function P(n,a){r=a*g,y=n*g,o.style.top=-a+"px",o.style.left=-n+"px"}function k(n,a){s.style.top=a+"px",s.style.left=n+"px"}function V(n){d.container_width=s.offsetWidth,d.container_height=s.offsetHeight,d.container_left=s.offsetLeft,d.container_top=s.offsetTop,d.mouse_x=(n.clientX||n.pageX||n.touches&&n.touches[0].clientX)+window.scrollX,d.mouse_y=(n.clientY||n.pageY||n.touches&&n.touches[0].clientY)+window.scrollY}function I(n){n=n*Math.PI*2;const a=Math.floor(s.clientWidth+n),h=Math.floor(s.clientHeight+n),c=o.clientWidth,S=o.clientHeight;let u,m;if(a<j)return;if(a>c)return;u=s.offsetLeft-n/2,m=s.offsetTop-n/2;const ee=u+a,te=m+h;u<0&&(u=0),m<0&&(m=0),!(ee>c)&&(te>S||(_(a,a),P(u,m),k(u,m)))}function R(n){switch(n.preventDefault(),String.fromCharCode(n.charCode)){case"+":I(F);break;case"-":I(-F);break}}function D(n){n.preventDefault(),I(n.deltaY>0?1:-1)}function E(n){n.preventDefault(),n.stopPropagation(),V(n),document.addEventListener("mousemove",f),document.addEventListener("touchmove",f),document.addEventListener("mouseup",p),document.addEventListener("touchend",p)}function p(n){n.preventDefault(),document.removeEventListener("mouseup",p),document.removeEventListener("touchend",p),document.removeEventListener("mousemove",f),document.removeEventListener("touchmove",f)}function f(n){const a={x:0,y:0};n.preventDefault(),n.stopPropagation(),a.x=n.pageX||n.touches&&n.touches[0].pageX,a.y=n.pageY||n.touches&&n.touches[0].pageY;let h=a.x-(d.mouse_x-d.container_left),c=a.y-(d.mouse_y-d.container_top);const S=s.offsetWidth,u=s.offsetHeight;h<0?h=0:h>o.offsetWidth-S&&(h=o.offsetWidth-S),c<0?c=0:c>o.offsetHeight-u&&(c=o.offsetHeight-u),P(h,c),k(h,c)}function Q(){e.width=l,e.height=C,e.getContext("2d").drawImage(t,y,r,l,C,0,0,l,C)}return{crop:Q,removeHandlers:G}}function Ee(t,e){return new Promise(i=>{const s=new FileReader;s.addEventListener("loadend",o=>{i(o.target.result)}),s[e](t)})}function Se(t){return Ee(t,"readAsDataURL")}class xe extends O{constructor(e={}){super("popup-avatar",{closable:!0}),this.image=new Image,this.cropper={crop:()=>{},removeHandlers:()=>{}},this.h6=document.createElement("h6"),Y(this.h6,"Popup.Avatar.Title"),this.btnClose.classList.remove("btn-icon"),this.header.append(this.h6),this.cropContainer=document.createElement("div"),this.cropContainer.classList.add("crop"),this.cropContainer.append(this.image),e.isForum&&this.cropContainer.classList.add("is-forum"),this.input=document.createElement("input"),this.input.type="file",this.input.style.display="none",this.listenerSetter.add(this.input)("change",i=>{const s=i.target.files[0];s&&Se(s).then(o=>{this.image=new Image,this.cropContainer.append(this.image),this.image.src=o,this.image.onload=()=>{this.show(),this.cropper=Ce(this.image,this.canvas),this.input.value=""}})},!1),this.btnConfirm=W("btn-primary btn-color-primary btn-circle btn-crop btn-icon z-depth-1",{noRipple:!0,icon:"check"}),w(this.btnConfirm,()=>{this.cropper.crop(),this.hide(),this.canvas.toBlob(i=>{this.blob=i,this.darkenCanvas(),this.resolve()},"image/jpeg",1)},{listenerSetter:this.listenerSetter}),this.container.append(this.cropContainer,this.btnConfirm,this.input),this.addEventListener("closeAfterTimeout",()=>{this.cropper.removeHandlers(),this.image&&this.image.remove()})}resolve(){this.onCrop(()=>ae.upload(this.blob))}open(e,i){this.canvas=e,this.onCrop=i,this.input.click()}darkenCanvas(){const e=this.canvas.getContext("2d");e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(0,0,this.canvas.width,this.canvas.height)}}export{ye as B,O as P,xe as a,Fe as b,L as c,be as d,Oe as e,Ae as f,Se as g,ge as h,me as i,He as r};
//# sourceMappingURL=avatar-4c4a0605.js.map
